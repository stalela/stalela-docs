{"config":{"lang":["en"],"separator":"[\\s\\-]+","pipeline":["stopWordFilter"],"fields":{"title":{"boost":1000.0},"text":{"boost":1.0},"tags":{"boost":1000000.0}}},"docs":[{"location":"","title":"Stalela Platform","text":"<p>The Stalela Platform is a unified fintech infrastructure for moving money and issuing fiscally compliant invoices across sub-Saharan African markets. It comprises two decoupled product pillars and a shared foundation.</p>"},{"location":"#platform-architecture","title":"Platform Architecture","text":"<pre><code>flowchart TD\n    subgraph Foundation[\"Shared Foundation\"]\n        ID[\"Identity Registry\"]\n        EB[\"Event Bus\"]\n        OBS[\"Observability (OTel)\"]\n        AI[\"AI Layer\"]\n    end\n\n    subgraph PAY[\"Payments Nucleus\"]\n        CTS[\"Canonical Transfer Service\"]\n        GL[\"GL Ledger (Double-Entry)\"]\n        RAILS[\"Rail Gateways\\n(MoMo, EFT, RTGS, Card, Crypto)\"]\n        RECON[\"Reconciliation\"]\n    end\n\n    subgraph FIS[\"Fiscal Platform\"]\n        INV[\"Invoice API\"]\n        TAX[\"Tax Engine (Jurisdiction-Configured)\"]\n        CSS[\"Cloud Signing Service (HSM)\"]\n        FL[\"Fiscal Ledger (Hash-Chained)\"]\n        SYNC[\"Tax Authority Sync Agent\"]\n    end\n\n    CTS --&gt; GL\n    CTS --&gt; RAILS\n    GL --&gt; RECON\n    INV --&gt; TAX\n    TAX --&gt; CSS\n    CSS --&gt; FL\n    FL --&gt; SYNC\n\n    Foundation --- PAY\n    Foundation --- FIS</code></pre>"},{"location":"#two-pillars","title":"Two Pillars","text":"Pillar Purpose Core Abstraction Documentation Payments Nucleus Move money across rails \u2014 mobile money, card, crypto, EFT, RTGS <code>CanonicalTransfer</code> Payments Nucleus \u2192 Fiscal Platform Create sealed, fiscally compliant invoices across jurisdictions <code>CanonicalInvoice</code> Fiscal Platform \u2192 <p>The pillars are decoupled by design \u2014 no shared databases, no synchronous RPC between them. They connect through opaque references (<code>endUserRef</code>) and async events on the Event Bus.</p>"},{"location":"#quick-navigation","title":"Quick Navigation","text":"Section What's Inside Foundation Shared concepts \u2014 glossary, canonical payloads, multi-tenant model, mobile money, AI capabilities Payments Nucleus CTS, rail gateways, GL ledger, reconciliation, compliance, operator console Fiscal Platform Invoice API, tax engine, cloud signing (HSM), fiscal ledger, authority sync, POS Integration How the two pillars interact \u2014 payment on invoice, merchant identity, end-to-end sequences Jurisdictions Country profiles \u2014 tax groups, client classifications, currencies, authority integration Infrastructure Deployment architectures \u2014 Free Stack (Supabase + Vercel + Alibaba, $0\u2013$20/mo) and AWS Blueprint Sprints Sprint planning and epic tracking Templates ADR, component, sequence, and state diagram templates"},{"location":"missing_items/","title":"Missing Items for Southern Africa Context","text":"<p>This document tracks gaps to make the Stalela nucleus production-ready for South Africa (ZA) and Zimbabwe (ZW). Each entry lists a short description, suggested docs location, and status.</p>"},{"location":"missing_items/#regulatory-and-reporting","title":"Regulatory and Reporting","text":"<ul> <li>FICA onboarding tiers and risk-based limits (ZA)</li> <li>Description: Define KYC tiers, allowable limits/velocities, and enforcement hooks in CTS/compliance.</li> <li>Suggested docs: <code>docs/20-specs/risk-limits.md</code></li> <li> <p>Status: Completed (see <code>20-specs/risk-limits.md</code>)</p> </li> <li> <p>POPIA data handling and cross-border transfers</p> </li> <li>Description: Clarify data localization, lawful basis, and cross-border transfer clauses; align with retention policy.</li> <li>Suggested docs: <code>docs/40-ops/security.md</code> (POPIA section) and <code>docs/20-specs/data-retention-pii.md</code> (expanded)</li> <li> <p>Status: Completed (sections added)</p> </li> <li> <p>SARB exchange control (BoP reporting)</p> </li> <li>Description: Event fields, submission schedules, and BoP file/API formats for authorized dealer reporting.</li> <li>Suggested docs: <code>docs/20-specs/regulatory-reporting.md</code></li> <li> <p>Status: Completed (see <code>20-specs/regulatory-reporting.md</code>)</p> </li> <li> <p>goAML STR/CTR integrations (SA FIC, ZW FIU)</p> </li> <li>Description: Schemas, batching, thresholds, and ops runbook for suspicious/cash threshold reporting.</li> <li>Suggested docs: <code>docs/20-specs/regulatory-reporting.md</code>, <code>docs/40-ops/regulatory.md</code></li> <li> <p>Status: Completed (spec + ops runbook added)</p> </li> <li> <p>Licensing posture and scheme participation (PASA/System Operator)</p> </li> <li>Description: Document required licenses/partners and operational controls per role.</li> <li>Suggested docs: <code>docs/40-ops/security.md</code> (Licensing &amp; Scheme Participation)</li> <li>Status: Completed (section added)</li> </ul>"},{"location":"missing_items/#rails-coverage-and-interop","title":"Rails Coverage and Interop","text":"<ul> <li>Mobile money rails beyond EcoCash (MTN MoMo, Airtel Money, Telecash/OneMoney; ZA wallets)</li> <li>Description: Gateway docs with STK/USSD prompts, callbacks, reason codes, limits.</li> <li>Suggested docs: <code>docs/10-components/rail-gateway-mtn-momo.md</code>, <code>rail-gateway-airtel-momo.md</code>, <code>rail-gateway-ecocash.md</code></li> <li> <p>Status: Completed (docs added)</p> </li> <li> <p>PayShap (instant proxy payments)</p> </li> <li>Description: Proxy types, resolution flow, timeouts, dispute/return semantics.</li> <li>Suggested docs: <code>docs/10-components/rail-gateway-payshap.md</code></li> <li> <p>Status: Completed (doc added)</p> </li> <li> <p>BankservAfrica EFT (batch)</p> </li> <li>Description: File layouts, cutoffs, settlement windows, exception handling.</li> <li>Suggested docs: <code>docs/10-components/rail-gateway-eft.md</code></li> <li> <p>Status: Completed (doc added; DebiCheck section added)</p> </li> <li> <p>ZIPIT and RTGS nuances (ZW)</p> </li> <li>Description: Message formats, settlement timing, reason codes.</li> <li>Suggested docs: <code>docs/10-components/rail-gateway-zimswitch.md</code> (expand) and <code>rail-gateway-rtgs.md</code></li> <li>Status: Partially completed (RTGS doc added; ZIPIT mapping to expand in Zimswitch)</li> </ul>"},{"location":"missing_items/#reconciliation-and-file-formats","title":"Reconciliation and File Formats","text":"<ul> <li>Bankserv EFT/PayShap/ZIPIT/RTGS file specs</li> <li>Description: Record layouts, matching keys, cutoffs, T+N timelines.</li> <li>Suggested docs: <code>docs/20-specs/external-integrations.md</code> (expand) and <code>docs/10-components/reconciliation-returns.md</code> (expand)</li> <li> <p>Status: Completed (sections/pointers added)</p> </li> <li> <p>Reason code mapping for mobile money and PayShap</p> </li> <li>Description: Standardized return/dispute taxonomy and mapping tables.</li> <li>Suggested docs: <code>docs/20-specs/error-codes.md</code> (expand with rail maps)</li> <li>Status: Completed (section added)</li> </ul>"},{"location":"missing_items/#fx-and-cross-border","title":"FX and Cross-Border","text":"<ul> <li>Rate sources and quote policy (USD/ZAR/ZWL)</li> <li>Description: Approved quote sources (RBZ auction vs market), TTL, provenance; audit requirements.</li> <li>Suggested docs: <code>docs/20-specs/fx-policy.md</code></li> <li> <p>Status: Completed (spec added)</p> </li> <li> <p>Nostro/Vostro flows and exchange-control tags</p> </li> <li>Description: Ledger accounts, event fields (e.g., <code>exchangeControlRef</code>), hedging hooks, corridor limits.</li> <li>Suggested docs: <code>docs/10-components/ledger-service.md</code> (expand), <code>docs/20-specs/events.md</code> (add fields)</li> <li>Status: Completed (ledger and events expanded)</li> </ul>"},{"location":"missing_items/#kyc-identity-fraud","title":"KYC, Identity, Fraud","text":"<ul> <li>Tiered limits and velocity controls by KYC level</li> <li>Description: Policy matrix and enforcement points in CTS/compliance.</li> <li>Suggested docs: <code>docs/20-specs/risk-limits.md</code></li> <li> <p>Status: Completed (see <code>20-specs/risk-limits.md</code>)</p> </li> <li> <p>SIM-swap signals, AVS (ZA), bank account name-matching</p> </li> <li>Description: Risk inputs and integration contracts.</li> <li>Suggested docs: <code>docs/20-specs/external-integrations.md</code> (expand)</li> <li> <p>Status: Completed (expanded)</p> </li> <li> <p>PEPs/adverse media local sources</p> </li> <li>Description: Additional list sources and ingest SLAs.</li> <li>Suggested docs: <code>docs/10-components/compliance-screening.md</code> (expand)</li> <li> <p>Status: Completed (expanded)</p> </li> <li> <p>DebiCheck mandates (if pull payments)</p> </li> <li>Description: Mandate lifecycle, consent storage, return flows.</li> <li>Suggested docs: <code>docs/10-components/rail-gateway-eft.md</code> (DebiCheck section)</li> <li>Status: Completed (section added)</li> </ul>"},{"location":"missing_items/#tax-and-fees","title":"Tax and Fees","text":"<ul> <li>VAT handling (ZA 15%) and ZW tax nuances</li> <li>Description: Fee lines with tax codes, invoicing artifacts, ledger posting examples.</li> <li>Suggested docs: <code>docs/20-specs/tax-vat.md</code>, <code>docs/10-components/ledger-service.md</code> (expand)</li> <li> <p>Status: Completed (spec added; ledger note added)</p> </li> <li> <p>Per-rail surcharges and partner fee netting</p> </li> <li>Description: Posting patterns and reconciliation treatment.</li> <li>Suggested docs: <code>docs/20-specs/posting-rules.md</code> (expand)</li> <li>Status: Completed (posting rules expanded)</li> </ul>"},{"location":"missing_items/#operational-realities","title":"Operational Realities","text":"<ul> <li>ZA/ZW holiday calendars in Platform/Base</li> <li>Description: Ship canonical calendars and banking-day rules (Africa/Johannesburg, Harare).</li> <li>Suggested docs: <code>docs/10-components/platform-base.md</code> (expand)</li> <li> <p>Status: Completed (note added)</p> </li> <li> <p>Load-shedding resilience</p> </li> <li>Description: Backoff policies, offline retries, idempotent replay runbooks.</li> <li>Suggested docs: <code>docs/40-ops/runbooks.md</code> (expand), <code>docs/40-ops/observability.md</code> (alerts)</li> <li> <p>Status: Completed (sections added)</p> </li> <li> <p>Localization (en/af/zu/xh/st/tn) for Operator Console</p> </li> <li>Description: i18n strategy and scope of translations.</li> <li>Suggested docs: <code>docs/10-components/operator-console.md</code> (expand)</li> <li> <p>Status: Completed (section added)</p> </li> <li> <p>SLA adjustments for telco variability</p> </li> <li>Description: Timeouts, retry budgets for USSD/STK flows.</li> <li>Suggested docs: <code>docs/40-ops/observability.md</code> (expand SLOs)</li> <li>Status: Completed (notes added)</li> </ul>"},{"location":"missing_items/#security-and-privacy","title":"Security and Privacy","text":"<ul> <li>PCI scope guidance for in-region deployments</li> <li>Description: Tokenization vendors, containment patterns, SAQ posture.</li> <li>Suggested docs: <code>docs/40-ops/security.md</code> (expand)</li> <li> <p>Status: Completed (PCI SAQ guidance added)</p> </li> <li> <p>POPIA DSAR runbooks</p> </li> <li>Description: Data subject access/erasure flows with legal hold exceptions.</li> <li>Suggested docs: <code>docs/40-ops/runbooks.md</code> -&gt; add DSAR section</li> <li>Status: Completed (runbook added)</li> </ul>"},{"location":"missing_items/#documentation-and-repo-stubs","title":"Documentation and Repo Stubs","text":"<ul> <li>New gateway component docs (EcoCash, MTN MoMo, Airtel, PayShap, EFT)</li> <li>Description: Create skeleton pages using <code>TEMPLATE-component.md</code>.</li> <li>Suggested docs: <code>docs/10-components/rail-gateway-*.md</code></li> <li> <p>Status: Completed (docs added)</p> </li> <li> <p>Regulatory reporting service</p> </li> <li>Description: Service doc for goAML/BoP adapters and schedules.</li> <li>Suggested docs: <code>docs/10-components/regulatory-reporting.md</code></li> <li> <p>Status: Completed (doc added)</p> </li> <li> <p>Specs additions (regulatory, risk limits, FX, VAT, alias directory)</p> </li> <li>Description: Author new spec pages and link from Overview/Specs index.</li> <li>Suggested docs: <code>docs/20-specs/*.md</code> (as listed above)</li> <li> <p>Status: Completed (risk-limits, regulatory-reporting, fx-policy, tax-vat, events updated)</p> </li> <li> <p>Ops additions (regulatory, telco resilience)</p> </li> <li>Description: Runbooks and procedures for reporting and telco constraints.</li> <li>Suggested docs: <code>docs/40-ops/regulatory.md</code>, <code>docs/40-ops/telco-resilience.md</code></li> <li>Status: Completed (regulatory ops added; telco notes in observability/runbooks)</li> </ul>"},{"location":"missing_items/#event-and-data-model-tweaks","title":"Event and Data Model Tweaks","text":"<ul> <li>Add envelope fields: <code>kycTier</code>, <code>riskScore</code>, <code>exchangeControlRef</code>, <code>taxCode</code>, <code>proxyType</code></li> <li>Description: Optional fields in relevant <code>transfers.*</code> events with versioning guidance.</li> <li>Suggested docs: <code>docs/20-specs/events.md</code> (expand)</li> <li> <p>Status: Completed (events updated)</p> </li> <li> <p>Directory data for ZA/ZW</p> </li> <li>Description: Bank codes (ZA), PayShap proxy rules, ZW BIN/member mappings, settlement calendars.</li> <li>Suggested docs: <code>docs/10-components/directory-routing.md</code> (expand)</li> <li>Status: Completed (directory expanded)</li> </ul>"},{"location":"missing_items/#diagrams-to-add","title":"Diagrams to Add","text":"<ul> <li>PayShap sequence/state</li> <li>Description: Proxy resolution, submit, settle, returns.</li> <li>Suggested docs: <code>docs/30-diagrams/sequence-submit-payshap.mmd</code>, <code>state-payshap.mmd</code></li> <li> <p>Status: Completed (sequence added)</p> </li> <li> <p>EFT batch sequence</p> </li> <li>Description: File submit -&gt; settlement -&gt; exceptions.</li> <li>Suggested docs: <code>docs/30-diagrams/sequence-eft-batch.mmd</code></li> <li> <p>Status: Completed (sequence added)</p> </li> <li> <p>EcoCash STK prompt</p> </li> <li>Description: R2P prompt/accept/settle/return timeline.</li> <li>Suggested docs: <code>docs/30-diagrams/sequence-stk-ecocash.mmd</code></li> <li> <p>Status: Completed (sequence added)</p> </li> <li> <p>BoP reporting pipeline</p> </li> <li>Description: Event -&gt; aggregation -&gt; submission -&gt; ack/retry.</li> <li>Suggested docs: <code>docs/30-diagrams/sequence-bop-reporting.mmd</code></li> <li>Status: Completed (sequence added)</li> </ul> <p>Last updated: 2025-08-27</p>"},{"location":"sprint-001/","title":"Sprint 001 \u2014 Foundation &amp; Free-Stack Bootstrap","text":"<p>Dates: 2026-03-03 \u2192 2026-03-14 (2 weeks) Team: 2 devs (Sprint Master / System Design + Developer) Stack: Free Stack \u2014 Supabase \u00b7 Vercel \u00b7 Alibaba KMS \u00b7 Resend \u00b7 GitHub Actions Focus: Bootstrap the monorepo, provision free-stack infrastructure, deliver the first end-to-end slice from both pillars (Payments Nucleus + Fiscal Platform).</p>"},{"location":"sprint-001/#goals-sprint-outcome","title":"\ud83c\udfaf Goals (Sprint Outcome)","text":"<ol> <li>Monorepo scaffold (<code>stalela/</code>) deployed on Vercel with Turborepo.</li> <li>Supabase project provisioned with schemas for <code>payments</code>, <code>ledger</code>, <code>fiscal</code>, <code>tax</code>, <code>signing</code>, <code>auth</code>.</li> <li>Alibaba Cloud KMS key created (RSA-2048 or EC_P256) for fiscal signing.</li> <li>CI/CD green \u2014 lint, type-check, test, preview deploy on every PR.</li> <li>Payments slice: <code>POST /api/transfers</code> \u2192 outbox \u2192 DB Webhook \u2192 mock rail callback \u2192 ledger posting.</li> <li>Fiscal slice: <code>POST /api/invoices</code> \u2192 tax engine \u2192 Alibaba KMS sign \u2192 fiscal ledger (hash-chained).</li> <li>Specs &amp; contracts finalized for both pillars (event envelope, canonical payloads, posting rules).</li> </ol>"},{"location":"sprint-001/#scope-stories","title":"\ud83d\uddc2 Scope (Stories)","text":""},{"location":"sprint-001/#1-monorepo-infra-setup","title":"1. Monorepo &amp; Infra Setup","text":"# Story Owner 1.1 Scaffold Turborepo monorepo (<code>apps/api</code>, <code>apps/console</code>, <code>packages/db</code>, <code>packages/domain</code>, <code>packages/signing</code>, <code>packages/email</code>, <code>packages/config</code>) Sprint Master 1.2 Create Supabase project; enable extensions (<code>pg_cron</code>, <code>pg_net</code>, <code>pgcrypto</code>); create schemas (<code>payments</code>, <code>ledger</code>, <code>fiscal</code>, <code>tax</code>, <code>signing</code>, <code>sync</code>, <code>compliance</code>, <code>directory</code>, <code>recon</code>, <code>rails</code>) Sprint Master 1.3 Provision Alibaba Cloud KMS key (RSA-2048); create <code>packages/signing</code> wrapper with <code>sign()</code> and <code>verify()</code> Developer 1.4 Configure Supabase Auth (email + API key strategy); set up RLS policies for <code>tenant_id</code> isolation Sprint Master 1.5 Wire Vercel project to monorepo; configure <code>apps/api</code> for Serverless Functions Developer 1.6 Configure Resend for transactional email; create <code>packages/email</code> wrapper Developer"},{"location":"sprint-001/#2-cicd-pipeline","title":"2. CI/CD Pipeline","text":"# Story Owner 2.1 GitHub Actions workflow: lint \u2192 type-check \u2192 unit tests \u2192 Vercel preview deploy Sprint Master 2.2 Supabase migration workflow: <code>supabase db push</code> on merge to <code>main</code> Sprint Master 2.3 Contract validation step (golden fixtures for transfer + invoice payloads) Developer"},{"location":"sprint-001/#3-specs-contracts","title":"3. Specs &amp; Contracts","text":"# Story Owner 3.1 Finalize event envelope v1 (<code>events.md</code>) with <code>\"v\": 1</code> field Sprint Master 3.2 Canonical Transfer API contract (<code>POST /api/transfers</code>, <code>GET /api/transfers/:id</code>) Sprint Master 3.3 Canonical Invoice API contract (<code>POST /api/invoices</code>, <code>GET /api/invoices/:id</code>) Sprint Master 3.4 Posting rules for transfers (<code>posting-rules.md</code>) linked into ledger service Developer 3.5 ADR: Outbox pattern on Supabase (PAY-ADR-0001 update for DB Webhooks) Sprint Master 3.6 ADR: Alibaba KMS as signing provider (FIS-ADR-0007) Developer"},{"location":"sprint-001/#4-payments-nucleus-first-slice","title":"4. Payments Nucleus \u2014 First Slice","text":"# Story Owner 4.1 <code>POST /api/transfers</code>: validate, normalize, INSERT into <code>payments.transfers</code> + <code>payments.outbox</code> (single tx) Developer 4.2 <code>GET /api/transfers/:id</code>: return transfer state + event timeline Developer 4.3 Supabase Database Webhook on <code>payments.outbox</code> INSERT \u2192 mock rail gateway endpoint Sprint Master 4.4 Mock EcoCash rail callback \u2192 UPDATE <code>payments.transfer_events</code> Developer 4.5 Ledger trigger: on <code>transfer_events</code> state change \u2192 INSERT <code>ledger.journal_entries</code> (double-entry) Sprint Master 4.6 <code>GET /api/balances</code>: return account balances from <code>ledger.balances</code> view Developer"},{"location":"sprint-001/#5-fiscal-platform-first-slice","title":"5. Fiscal Platform \u2014 First Slice","text":"# Story Owner 5.1 <code>POST /api/invoices</code>: validate canonical payload, run jurisdiction tax engine (DRC TG01-TG14) Developer 5.2 Monotonic counter: <code>fiscal.fiscal_counters</code> with <code>pg_advisory_xact_lock</code> + <code>nextval()</code> per outlet Sprint Master 5.3 Alibaba KMS signing pipeline: serialize \u2192 digest \u2192 <code>kms:Sign</code> \u2192 base64 signature Developer 5.4 Hash-chained fiscal ledger: INSERT into <code>fiscal.fiscal_ledger</code> with <code>prev_hash</code> Sprint Master 5.5 Return sealed response (fiscal_number, auth_code, timestamp, qr_payload, fiscal_authority_id) Developer 5.6 <code>GET /api/invoices/:id</code>: return sealed invoice with security elements Developer"},{"location":"sprint-001/#definition-of-done","title":"\u2705 Definition of Done","text":"Criterion Verification Monorepo builds <code>turbo build</code> passes; Vercel preview deploys Supabase schemas <code>supabase db push</code> succeeds; RLS policies tested CI/CD green All workflows pass on <code>main</code> Payments E2E <code>curl POST /api/transfers</code> \u2192 webhook fires \u2192 ledger entry visible Fiscal E2E <code>curl POST /api/invoices</code> \u2192 KMS signs \u2192 fiscal ledger entry with <code>prev_hash</code> Specs published Event envelope, transfer API, invoice API contracts in docs site Signing Alibaba KMS <code>sign()</code> + <code>verify()</code> round-trip passes in integration test"},{"location":"sprint-001/#out-of-scope","title":"\ud83d\udea7 Out of Scope","text":"<ul> <li>Real rail integrations (EcoCash, M-Pesa, OPPWA) \u2014 Sprint 002</li> <li>Operator Console / Web Dashboard UI \u2014 Sprint 002</li> <li>Tax Authority Sync (DGI) \u2014 Sprint 003</li> <li>Reconciliation service \u2014 Sprint 003</li> <li>WhatsApp Bot / NL Invoice API \u2014 Sprint 004</li> <li>Fiscal Extension (offline signing) \u2014 Sprint 004</li> </ul>"},{"location":"sprint-001/#risks-mitigation","title":"\ud83d\udd2e Risks &amp; Mitigation","text":"Risk Mitigation Alibaba KMS region latency Test from Vercel edge; add 500 ms timeout + retry Supabase free-tier limits Monitor via dashboard; 500 MB DB is ample for pilot Spec churn Freeze contracts after ADR sign-off in week 1 pg_cron 2-slot limit Multiplex via <code>cron_tasks</code> table (designed in free-stack doc) Dev environment parity Use Supabase CLI local dev (<code>supabase start</code>) for offline development"},{"location":"sprint-001/#metrics","title":"\ud83d\udcca Metrics","text":"Metric Target Stories completed \u2265 18 of 21 CI pass rate on <code>main</code> 100% E2E transfer latency &lt; 500 ms (local Supabase) E2E invoice signing latency &lt; 1 s (including KMS round-trip) Test coverage (domain logic) \u2265 80%"},{"location":"sprint-001/#ownership","title":"\ud83d\udc65 Ownership","text":"Role Scope Sprint Master / System Design Infra setup, Supabase schemas, DB Webhooks, ledger triggers, CI/CD, specs, ADRs Developer API routes (transfers + invoices), KMS wrapper, rail mock, tax engine, contract fixtures"},{"location":"sprint-001/#sprint-002-preview","title":"\ud83d\udcdd Sprint 002 Preview","text":"<ul> <li>Real rail integration: EcoCash gateway (STK push + callback)</li> <li>Operator Console MVP: Next.js dashboard with Supabase Auth + Realtime</li> <li>Compliance screening: Sanctions list + pre-transfer check middleware</li> <li>Directory &amp; Routing: Alias-to-rail lookups</li> <li>Web Dashboard MVP: Fiscal invoice management + outlet admin</li> <li>JS &amp; Python SDK: Typed client libraries with offline queue</li> </ul>"},{"location":"sprint-001/#sprint-roadmap-4-sprints-to-pilot","title":"\ud83d\udcc5 Sprint Roadmap (4 Sprints to Pilot)","text":"<pre><code>gantt\n    title Stalela \u2014 Sprint Roadmap to Pilot\n    dateFormat YYYY-MM-DD\n    axisFormat %b %d\n\n    section Foundation\n    Sprint 001 \u2014 Bootstrap     :s1, 2026-03-03, 14d\n\n    section Core Services\n    Sprint 002 \u2014 Core          :s2, after s1, 14d\n\n    section Integration\n    Sprint 003 \u2014 Integration   :s3, after s2, 14d\n\n    section Pilot\n    Sprint 004 \u2014 Pilot Launch  :s4, after s3, 14d</code></pre> Sprint Focus Payments Nucleus Fiscal Platform 001 Foundation CTS + Ledger + mock rail Signing + Tax Engine + Fiscal Ledger 002 Core Services EcoCash GW + Compliance + Directory Dashboard + SDK + Reports 003 Integration Reconciliation + Operator Console Authority Sync + Verification Portal 004 Pilot Launch Multi-rail (M-Pesa, OPPWA) + AI Agents WhatsApp Bot + NL API + Fiscal Extension"},{"location":"00-foundation/","title":"Stalela Platform \u2014 Foundation","text":"<p>This section contains shared concepts, vocabulary, and cross-cutting capabilities that span both product pillars of the Stalela Platform.</p>"},{"location":"00-foundation/#two-pillars-one-platform","title":"Two Pillars, One Platform","text":"<p>Stalela is built as two complementary product pillars that share a common foundation:</p> Pillar Purpose Core abstraction Payments Nucleus Move money across rails (mobile money, card, crypto, EFT, RTGS) <code>CanonicalTransfer</code> \u2014 a single API for all payment intents Fiscal Platform Create, sign, and sync fiscally compliant invoices across jurisdictions <code>CanonicalInvoice</code> \u2014 a sealed, HSM-signed fiscal event <p>The two pillars are decoupled by design. A transfer can exist without an invoice, and an invoice can exist without a transfer. When they do interact \u2014 for example, a POS sale that triggers a mobile money payment \u2014 the integration is event-driven and asynchronous.</p>"},{"location":"00-foundation/#whats-in-this-section","title":"What's in this section","text":"Page What it covers Glossary Merged vocabulary from both pillars, with disambiguation for overloaded terms Canonical Payloads Side-by-side comparison of <code>CanonicalTransfer</code> and <code>CanonicalInvoice</code> schemas Mobile Money Airtel, MTN MoMo, M-Pesa, Orange Money \u2014 rail settlement vs. invoice payment instrument Multi-Tenant Model How <code>tenantId</code>, <code>merchant_tin</code>, and <code>outlet_id</code> map across both pillars AI Capabilities Smart Rail Selector, NL invoice creation, tax classification \u2014 unified AI layer"},{"location":"00-foundation/#design-principles-shared","title":"Design Principles (shared)","text":"<p>Both pillars follow the same engineering principles:</p> <ol> <li>Canonical payloads \u2014 every domain object has a deterministic, contract-first schema. Payloads are versioned and reproducible.</li> <li>Event-driven \u2014 state changes emit events to a bus. Consumers are decoupled from producers. Exactly-once semantics via transactional outbox.</li> <li>Offline-first \u2014 clients queue work locally (IndexedDB, SQLite, outbox) and reconcile when connectivity returns.</li> <li>Append-only \u2014 neither ledger (GL or fiscal) allows deletion. Corrections are new events.</li> <li>Multi-tenant \u2014 every request is scoped to a tenant/merchant. Data isolation is enforced at every layer.</li> <li>AI-assisted, human-authoritative \u2014 AI agents suggest, classify, and monitor. Humans (and HSMs) make final decisions.</li> <li>Observability by default \u2014 structured logs (PII-redacted), distributed traces (<code>traceparent</code>), Prometheus metrics, alerting on DLQ depth and latency SLOs.</li> </ol>"},{"location":"00-foundation/ai-capabilities/","title":"AI Capabilities","text":"<p>The Stalela Platform embeds AI across both product pillars. This page provides a unified view of all AI capabilities, their ownership, shared infrastructure, and phased rollout.</p>"},{"location":"00-foundation/ai-capabilities/#design-principles-shared","title":"Design Principles (Shared)","text":"<ol> <li>AI assists, humans (and HSMs) decide. AI agents suggest, classify, and monitor. The Cloud Signing Service remains the sole fiscal authority; the CTS deterministic orchestration pipeline has final say on routing.</li> <li>Human-in-the-loop by default. AI suggestions are presented for review before becoming fiscal events or routing overrides. Confidence thresholds gate auto-approval.</li> <li>Multilingual-first. NLP models support French (primary), Lingala, Swahili, Tshiluba, and English. Payment agents are language-agnostic (structured JSON only).</li> <li>Privacy-preserving. Training data stays within the Stalela cloud boundary. No cross-tenant training. Models are fine-tuned per merchant or on anonymized aggregate data.</li> <li>Observable. Every AI suggestion, confidence score, and human override is logged with <code>ai_suggestion_id</code>, <code>model_version</code>, and <code>accepted: true/false</code>. OpenTelemetry traces span agent calls.</li> </ol>"},{"location":"00-foundation/ai-capabilities/#capability-map","title":"Capability Map","text":"<pre><code>flowchart TD\n    subgraph \"Payments Nucleus Agents\"\n        SRS[\"Smart Rail Selector\"]\n        DRC[\"Dynamic Risk Classifier\"]\n        RHM[\"Rail Health Monitor\"]\n        OC[\"Orchestration Copilot\"]\n    end\n\n    subgraph \"Fiscal Platform AI\"\n        NLP[\"NL Invoice Parser\"]\n        TAX[\"Tax Auto-Classifier\"]\n        ANOM[\"Anomaly Detection\"]\n        PRED[\"Predictive Analytics\"]\n        OCR[\"OCR &amp; Document Scan\"]\n        SEARCH[\"Smart Search\"]\n        COMPLY[\"Compliance Monitor\"]\n    end\n\n    subgraph \"Shared Infrastructure\"\n        OBS[\"OpenTelemetry + Audit Trail\"]\n        TRAIN[\"Model Training Pipeline\"]\n        FEAT[\"Feature Flag Service\"]\n    end\n\n    SRS --&gt; OBS\n    DRC --&gt; OBS\n    NLP --&gt; OBS\n    TAX --&gt; OBS\n    ANOM --&gt; OBS\n    TRAIN --&gt; NLP\n    TRAIN --&gt; TAX\n    TRAIN --&gt; DRC\n    FEAT --&gt; SRS\n    FEAT --&gt; DRC</code></pre>"},{"location":"00-foundation/ai-capabilities/#payments-nucleus-agents","title":"Payments Nucleus Agents","text":"<p>These agents are documented in full at Orchestration AI Agents. Summary:</p> Agent Purpose Invocation Phase Smart Rail Selector Rank available rails against policy weights and runtime health. Optimizes for cost, reliability, or speed. Synchronous \u2014 CTS orchestration pipeline, pre-Directory Sprint 1+ Dynamic Risk Classifier Assign adaptive compliance tiers based on payer/payee metadata, device signals, and historical incidents. Synchronous \u2014 CTS compliance step Sprint 2+ Rail Health Monitor Track infrastructure health per rail (latency, failure rate, uptime). Emits <code>rail.flagged.degraded</code> when thresholds are breached. Continuous streaming microservice on Event Bus Sprint 1+ Orchestration Copilot Human-friendly explanations of routing decisions, diagnostics, and remediation guidance. On-demand via CLI (<code>stalela ctl orchestration explain</code>) or Operator Console Sprint 3+ <p>Fallback pattern: If an agent call times out or errors, CTS reverts to deterministic Directory routing rules. <code>orchestration.fallback.used</code> is recorded with reason codes.</p>"},{"location":"00-foundation/ai-capabilities/#fiscal-platform-ai","title":"Fiscal Platform AI","text":"<p>These capabilities are documented in full at AI &amp; NL Capabilities. Summary:</p> Capability Purpose Input Phase NL Invoice Parser Create sealed invoices from natural language (French, Lingala, Swahili, Tshiluba). WhatsApp, Chat, REST API, Voice Phase 2 (text) / Phase 4 (voice) Tax Auto-Classifier Suggest jurisdiction-appropriate tax group from item description or HS code. Item text, optional HS code, jurisdiction Phase 2 Anomaly Detection Monitor Fiscal Ledger for numbering gaps, velocity spikes, void/refund anomalies, and tax group distribution shifts. Fiscal Ledger events Phase 2 (rules) / Phase 4 (ML) Predictive Analytics Tax liability forecast, revenue projection, seasonal demand, compliance risk scoring. Historical fiscal data Phase 4 OCR &amp; Document Digitization Ingest paper invoices as structured data for record-keeping or purchase ledger entry. Camera photo, scanned PDF Phase 4 Smart Search &amp; Insights Natural language queries over fiscal data (\"Total TVA pour ciment en Q3 2026\"). Free-text search bar Phase 4 Compliance Monitor NLP-based detection of regulatory changes (new arr\u00eat\u00e9s, rate changes, exemption updates). DGI website, official gazette Phase 4"},{"location":"00-foundation/ai-capabilities/#cross-pillar-interactions","title":"Cross-Pillar Interactions","text":"<p>The AI layers of each pillar are decoupled \u2014 they do not call each other directly. Where their outputs relate:</p> Scenario Payments Agent Fiscal AI Integration Point Invoice-then-pay Smart Rail Selector picks optimal rail NL Invoice Parser creates the invoice POS/client calls CTS after fiscal sealing; <code>endUserRef</code> = <code>fiscal_number</code> Risk + Compliance Dynamic Risk Classifier assigns risk tier to transfer Anomaly Detection flags suspicious invoice patterns Both publish to Event Bus; Operator Console shows correlated alerts per merchant Health monitoring Rail Health Monitor flags degraded mobile money rail \u2014 POS can warn cashier before attempting mobile money collection"},{"location":"00-foundation/ai-capabilities/#model-hosting-infrastructure","title":"Model Hosting &amp; Infrastructure","text":"Component Technology Pillar Latency Target Smart Rail Selector Policy-weighted scoring + optional ML re-ranking Payments &lt; 200 ms Dynamic Risk Classifier Gradient-boosted classifier on entity features Payments &lt; 300 ms NL Invoice Parser Fine-tuned multilingual LLM (mT5 / Mistral) + RAG Fiscal &lt; 2 s Tax Auto-Classifier Gradient-boosted classifier + embedding similarity Fiscal &lt; 500 ms Anomaly Detection Isolation Forest + rule engine Fiscal Near-real-time (streaming) Predictive Analytics Prophet / ARIMA time-series Fiscal Batch (&lt; 30 s per forecast) Smart Search Text-to-SQL (CodeLlama / StarCoder) Fiscal &lt; 1 s <p>All models run on dedicated compute within the Stalela cloud boundary. No customer data is sent to third-party providers unless the merchant opts in with a DPA.</p>"},{"location":"00-foundation/ai-capabilities/#api-surface","title":"API Surface","text":""},{"location":"00-foundation/ai-capabilities/#payments-nucleus","title":"Payments Nucleus","text":"<p>Agents are invoked internally by the CTS pipeline. The Orchestration Copilot is accessible via:</p> <pre><code>stalela ctl orchestration explain --transfer-id=tr_789\n</code></pre>"},{"location":"00-foundation/ai-capabilities/#fiscal-platform","title":"Fiscal Platform","text":"Endpoint Method Description Phase <code>/api/v1/invoices/natural</code> POST Create invoice from NL text Phase 2 <code>/api/v1/tax/classify</code> POST Classify items into jurisdiction tax groups Phase 2 <code>/api/v1/analytics/anomalies</code> GET List detected anomalies Phase 2 <code>/api/v1/analytics/forecast</code> GET Retrieve predictive forecasts Phase 4 <code>/api/v1/ocr/scan</code> POST Upload document for OCR extraction Phase 4 <code>/api/v1/search/query</code> POST Natural language search over fiscal data Phase 4 <p>All endpoints inherit the same authentication (Bearer token), rate limiting, and tenant isolation as the core APIs.</p>"},{"location":"00-foundation/canonical-payloads/","title":"Canonical Payloads","text":"<p>Both pillars of the Stalela Platform use a contract-first, deterministic payload as their core abstraction. The two schemas serve entirely different domains and are never merged \u2014 their separation is the architectural guarantee of decoupling.</p>"},{"location":"00-foundation/canonical-payloads/#side-by-side-comparison","title":"Side-by-Side Comparison","text":"Aspect Canonical Transfer (Payments) Canonical Invoice (Fiscal) Purpose Move money between accounts across rails Create a sealed, fiscally compliant invoice Submitted to Canonical Transfer Service (CTS) Cloud Signing Service (HSM) via Invoicing API Result Transfer lifecycle (INITIATED \u2192 SETTLED) Sealed invoice with fiscal number + signature Identity scope <code>tenantId</code> <code>merchant_tin</code> + <code>outlet_id</code> + <code>jurisdiction</code> Idempotency <code>idempotencyKey</code> (36h TTL) Fiscal number (monotonic, never reused) Offline behavior Outbox + DLQ retry IndexedDB queue \u2192 flush on reconnect Append-only GL Ledger postings (double-entry) Hash-chained Fiscal Ledger (prev-hash linked) Deletion Never \u2014 corrections via return/reversal events Never \u2014 corrections via credit note fiscal events"},{"location":"00-foundation/canonical-payloads/#canonical-transfer-schema-payments-nucleus","title":"Canonical Transfer Schema (Payments Nucleus)","text":"<pre><code>{\n  \"tenantId\": \"tenant_abc\",\n  \"idempotencyKey\": \"uuid-v4\",\n  \"intent\": \"PUSH\",\n  \"amount\": { \"value\": \"100.00\", \"currency\": \"USD\" },\n  \"sourceCurrency\": \"USD\",\n  \"targetCurrency\": \"ZAR\",\n  \"fxStrategy\": \"AT_SOURCE\",\n  \"payer\": {\n    \"accountId\": \"acc_sender\",\n    \"name\": \"Sender Corp\",\n    \"institutionId\": \"inst_001\"\n  },\n  \"payee\": {\n    \"accountId\": \"acc_receiver\",\n    \"name\": \"Receiver Ltd\",\n    \"institutionId\": \"inst_002\"\n  },\n  \"railHints\": [\"payshap\", \"eft\"],\n  \"feeModel\": \"SENDER_PAYS\",\n  \"endUserRef\": \"INV-2026-001\",\n  \"externalRef\": \"erp-ref-123\",\n  \"metadata\": {},\n  \"traceparent\": \"00-trace-id-span-id-01\"\n}\n</code></pre> <p>Intents: <code>AUTH</code> | <code>CAPTURE</code> | <code>PUSH</code> | <code>PULL</code></p> <p>Lifecycle: <code>INITIATED \u2192 SUBMITTED \u2192 ACCEPTED \u2192 SETTLED \u2192 (RETURNED | FAILED)</code></p>"},{"location":"00-foundation/canonical-payloads/#canonical-invoice-schema-fiscal-platform","title":"Canonical Invoice Schema (Fiscal Platform)","text":"<p>The invoice schema is jurisdiction-aware. The <code>jurisdiction</code> field (ISO 3166-1 alpha-2) determines which tax groups, client classifications, invoice types, and rounding rules apply. The example below shows a DRC (<code>CD</code>) invoice:</p> <pre><code>{\n  \"jurisdiction\": \"CD\",\n  \"merchant_tin\": \"NIF-123456\",\n  \"outlet_id\": \"outlet-kinshasa-01\",\n  \"pos_terminal_id\": \"term-001\",\n  \"cashier_id\": \"cashier-jean\",\n  \"invoice_type\": \"sale\",\n  \"timestamp\": \"2026-02-23T14:30:00Z\",\n  \"client\": {\n    \"name\": \"Acme SARL\",\n    \"tin\": \"NIF-789012\",\n    \"classification\": \"company\"\n  },\n  \"items\": [\n    {\n      \"description\": \"Office supplies\",\n      \"quantity\": 10,\n      \"unit_price\": \"5.00\",\n      \"tax_group\": \"TG01\",\n      \"total\": \"50.00\"\n    }\n  ],\n  \"tax_groups\": [\n    { \"code\": \"TG01\", \"base\": \"50.00\", \"rate\": \"0.16\", \"amount\": \"8.00\" }\n  ],\n  \"totals\": {\n    \"subtotal\": \"50.00\",\n    \"tax\": \"8.00\",\n    \"total\": \"58.00\"\n  },\n  \"payments\": [\n    { \"method\": \"mobile_money\", \"provider\": \"airtel_money\", \"amount\": \"58.00\", \"currency\": \"CDF\" }\n  ]\n}\n</code></pre> <p>Jurisdiction-specific fields</p> <p>The <code>tax_group</code> codes (e.g., <code>TG01</code>), <code>classification</code> values, <code>invoice_type</code> options, and <code>currency</code> are all defined by the active jurisdiction's country profile. The schema structure is universal; the allowed values are jurisdiction-specific.</p> <p>Invoice types: <code>sale</code> | <code>advance</code> | <code>credit_note</code> | <code>export</code> | <code>export_credit</code></p> <p>Sealed response adds: <code>fiscal_number</code>, <code>auth_code</code>, <code>signature</code>, <code>qr_payload</code>, <code>prev_hash</code>, <code>device_id</code></p>"},{"location":"00-foundation/canonical-payloads/#how-they-interact","title":"How They Interact","text":"<p>When a POS sale triggers both a fiscal event and a payment:</p> <pre><code>sequenceDiagram\n    participant POS as POS Terminal\n    participant FP as Fiscal Platform\n    participant CTS as Canonical Transfer Service\n    participant Rail as Rail Gateway\n\n    POS-&gt;&gt;FP: POST /api/v1/invoices (canonical invoice)\n    FP--&gt;&gt;POS: Sealed invoice (fiscal_number, auth_code)\n    POS-&gt;&gt;CTS: POST /transfers (canonical transfer, endUserRef=fiscal_number)\n    CTS-&gt;&gt;Rail: Submit payment (mobile money)\n    Rail--&gt;&gt;CTS: SETTLED\n    CTS--&gt;&gt;POS: Transfer settled</code></pre> <p>The key decoupling: the invoice is sealed before the payment is initiated. The fiscal event does not depend on payment success, and the payment does not depend on the invoice being sealed. The <code>endUserRef</code> field on the transfer links back to the <code>fiscal_number</code> for reconciliation, but neither system blocks on the other.</p> <p>See Integration: Invoice-then-Pay Sequence for the full flow.</p>"},{"location":"00-foundation/glossary/","title":"Glossary","text":"<p>Merged vocabulary for the Stalela Platform. Terms that carry different meanings across the Payments Nucleus and Fiscal Platform are marked with disambiguation notes.</p>"},{"location":"00-foundation/glossary/#a","title":"A","text":"Term Definition ACH Automated Clearing House \u2014 batch payment network for bank-to-bank transfers. ADR Architecture Decision Record \u2014 documents a significant design choice, its context, and rationale. Auth Code (Fiscal) Cryptographic authentication code generated by the Cloud Signing Service (HSM) for each sealed invoice. Not to be confused with a payment authorization code. Authorization (Payments) A hold placed on funds before capture. Part of the AUTH/CAPTURE intent pattern in the CTS."},{"location":"00-foundation/glossary/#b","title":"B","text":"Term Definition BAI2 Bank Administration Institute format for bank statement files, used in reconciliation. BIN Bank Identification Number \u2014 first 6\u20138 digits of a card number identifying the issuing institution."},{"location":"00-foundation/glossary/#c","title":"C","text":"Term Definition Canonical Invoice (Fiscal) The deterministic JSON payload submitted to the Cloud Signing Service for fiscal sealing. Fields: <code>merchant_tin</code>, <code>outlet_id</code>, <code>pos_terminal_id</code>, <code>jurisdiction</code>, <code>cashier_id</code>, <code>client</code>, <code>tax_groups</code>, <code>totals</code>, <code>payments</code>. Canonical Transfer (Payments) The deterministic JSON payload submitted to the CTS for payment processing. Fields: <code>tenantId</code>, <code>intent</code>, <code>amount</code>, <code>payer</code>, <code>payee</code>, <code>railHints</code>, <code>feeModel</code>. CTS Canonical Transfer Service \u2014 the front-door API and orchestrator for all payment intents in the Payments Nucleus. Client Classification (Fiscal) Jurisdiction-mandated buyer category on each invoice. DRC defines: individual, company, commercial individual, professional, embassy. Other jurisdictions define their own. See Jurisdictions. Compliance Overloaded term \u2014 see disambiguation below. Counter (Fiscal) Monotonic, non-resettable sequence number assigned per outlet by the Monotonic Counter Manager. <p>Disambiguation: Compliance</p> <ul> <li>Payments Nucleus: Entity screening against sanctions watchlists (OFAC, UN, EU, SA FIC) before a transfer is submitted to a rail.</li> <li>Fiscal Platform: Adherence to jurisdiction-specific tax law \u2014 tax groups, invoice types, fiscal device registration, and authority sync requirements. See Jurisdictions.</li> </ul>"},{"location":"00-foundation/glossary/#d","title":"D","text":"Term Definition DEF Dispositif \u00c9lectronique Fiscal \u2014 the DRC's fiscal memory device (USB hardware, Phase 3). DRC-specific. DGI Direction G\u00e9n\u00e9rale des Imp\u00f4ts \u2014 DRC tax authority. See DRC Country Profile. DLQ Dead Letter Queue \u2014 failed events that could not be processed after retries. Double-Entry (Payments) Every money movement records equal debits and credits in the GL Ledger. Directory Service (Payments) Institutions, BINs, settlement cutoffs, fee windows, and routing tables."},{"location":"00-foundation/glossary/#ef","title":"E\u2013F","text":"Term Definition Event Bus SNS+SQS pub/sub backbone for exactly-once event delivery (transactional outbox pattern). Event Envelope Standardized wrapper around every domain event: <code>eventId</code>, <code>type</code>, <code>timestamp</code>, <code>tenantId</code>, <code>payload</code>, <code>traceparent</code>. Fiscal Extension (Fiscal) Semi-trusted browser extension holding a Delegated Credential for offline signing. Fiscal Ledger (Fiscal) Append-only, hash-chained log of sealed invoices. Not a GL \u2014 it is a tamper-evident audit trail. Fiscal Number (Fiscal) Strictly monotonic invoice identifier assigned by the Cloud Signing Service or USB device. FX Strategy (Payments) How currency conversion is handled: <code>AT_SOURCE</code>, <code>AT_DESTINATION</code>, <code>PRE_FUNDED</code>."},{"location":"00-foundation/glossary/#gi","title":"G\u2013I","text":"Term Definition GL Ledger (Payments) General Ledger with double-entry postings, balances, and chart of accounts. Distinct from Fiscal Ledger. HSM Hardware Security Module \u2014 the trusted root for cryptographic signing in the Cloud Signing Service. Idempotency Key Client-supplied key ensuring that retried requests produce the same result. Used in both CTS and Invoicing API. Invoice Type (Fiscal) Jurisdiction-defined invoice categories. DRC defines: sale, advance, credit note, export, export credit. Other jurisdictions may define different types. <p>Disambiguation: Ledger</p> <ul> <li>GL Ledger (Payments Nucleus): Financial double-entry accounting system tracking balances across accounts. Supports posting rules, chart of accounts, closing-the-books.</li> <li>Fiscal Ledger (Fiscal Platform): Hash-chained, append-only audit log of sealed invoices. No debit/credit semantics \u2014 each entry is a signed fiscal event with a <code>prev_hash</code> pointer.</li> </ul>"},{"location":"00-foundation/glossary/#mo","title":"M\u2013O","text":"Term Definition MCF / e-MCF (Fiscal, DRC) DGI upload protocol for fiscal data synchronization. Endpoint, auth, and schema are unresolved blockers. DRC-specific \u2014 other jurisdictions use different authority sync protocols. See Authority Sync. Mobile Money Payment rail (Payments Nucleus) and payment instrument on invoices (Fiscal Platform). See Mobile Money. Monotonic Counter Manager (Fiscal) Service ensuring strictly increasing fiscal numbers per outlet under multi-terminal concurrency. Operator Console (Payments) Human UI for managing returns, recon exceptions, compliance flags, and rail health."},{"location":"00-foundation/glossary/#pr","title":"P\u2013R","text":"Term Definition Posting Rules (Payments) Event \u2192 debit/credit account mappings in the GL Ledger. Rail (Payments) A payment network: Zimswitch, OPPWA, USDC/Algorand, EFT, RTGS, PayShap, or mobile money. Rail Gateway (Payments) Per-rail adapter that translates CTS commands into rail-native protocol calls. Reconciliation (Payments) Nightly statement ingest + matching against posted transfers. Unmatched items \u2192 exception queue. Report Generator (Fiscal) Produces Z (shift), X (periodic), A (audit) reports from the Fiscal Ledger."},{"location":"00-foundation/glossary/#st","title":"S\u2013T","text":"Term Definition Security Elements (Fiscal) The set of fields minted by the HSM: fiscal number, fiscal authority ID, auth code, trusted timestamp, QR payload. SFE Syst\u00e8me de Facturation d'Entreprise \u2014 DRC technical specification for compliant billing systems. DRC-specific. Sync Agent (Fiscal) Service that queues and retries uploads of sealed invoices to the jurisdiction's tax authority. See Authority Sync. Tax Authority The government agency responsible for tax collection and fiscal compliance in a given jurisdiction. DRC: DGI, Kenya: KRA, Rwanda: RRA, etc. Tax Engine (Fiscal) Loads the active jurisdiction's tax group manifest, applies classification rules and rounding, and attaches computed totals to each invoice. See Tax Engine. TIN Taxpayer Identification Number \u2014 internationally recognized identifier for a business entity. DRC calls this NIF (Num\u00e9ro d'Identification Fiscale). Stored as <code>merchant_tin</code> in the canonical invoice. Tenant (Payments) Top-level isolation scope in CTS. Maps to <code>merchant_tin</code> + <code>outlet_id</code> in the Fiscal Platform. See Multi-Tenant Model. Transfer (Payments) A single money-movement intent processed by the CTS. Lifecycle: INITIATED \u2192 SUBMITTED \u2192 ACCEPTED \u2192 SETTLED."},{"location":"00-foundation/glossary/#vz","title":"V\u2013Z","text":"Term Definition Verifiable Credential (VC) (Fiscal) Short-lived credential issued to a Fiscal Extension for delegated offline signing. Z Report (Fiscal) End-of-shift fiscal summary generated from the Fiscal Ledger, signed by the HSM or USB device."},{"location":"00-foundation/mobile-money/","title":"Mobile Money","text":"<p>Mobile money is present in both pillars of the Stalela Platform, but at different layers. This page clarifies the distinction.</p>"},{"location":"00-foundation/mobile-money/#two-layers-one-payment-method","title":"Two Layers, One Payment Method","text":"<pre><code>flowchart TB\n    subgraph Fiscal[\"Fiscal Platform (invoice layer)\"]\n        INV[\"Invoice records payment method:&lt;br/&gt;mobile_money / airtel_money / 58.00 CDF\"]\n    end\n\n    subgraph Payments[\"Payments Nucleus (settlement layer)\"]\n        CTS[\"CTS orchestrates transfer\"]\n        GW[\"Rail Gateway: Airtel MoMo\"]\n        GW --&gt;|STK Push| TELCO[\"Airtel Money API\"]\n    end\n\n    INV -.-&gt;|optional: trigger settlement| CTS\n    CTS --&gt; GW</code></pre> Layer What happens When Fiscal Platform Records <code>mobile_money</code> as the payment instrument on a sealed invoice. No money moves \u2014 this is fiscal metadata. Always (every invoice with a mobile money payment) Payments Nucleus Orchestrates actual money movement: initiates STK Push, tracks lifecycle (INITIATED \u2192 SETTLED), posts to GL Ledger. When the merchant wants Stalela to settle the payment (not just record it)"},{"location":"00-foundation/mobile-money/#supported-providers","title":"Supported Providers","text":"Provider Payments Nucleus Rail Fiscal Platform Instrument Markets Airtel Money <code>rail-gateway-airtel-momo</code> <code>airtel_money</code> DRC, ZW MTN MoMo <code>rail-gateway-mtn-momo</code> <code>mtn_momo</code> DRC M-Pesa (Vodacom) <code>rail-gateway-mpesa</code> (planned) <code>mpesa</code> DRC Orange Money <code>rail-gateway-orange</code> (planned) <code>orange_money</code> DRC EcoCash <code>rail-gateway-ecocash</code> <code>ecocash</code> ZW"},{"location":"00-foundation/mobile-money/#integration-pattern","title":"Integration Pattern","text":"<p>When a POS sale uses mobile money, the two layers interact:</p> <ol> <li>POS builds a canonical invoice with <code>payments: [{ method: \"mobile_money\", provider: \"airtel_money\", amount: \"58.00\", currency: \"CDF\" }]</code></li> <li>Fiscal Platform seals the invoice \u2192 returns fiscal number + auth code</li> <li>POS (optionally) calls <code>POST /transfers</code> on the CTS with <code>endUserRef</code> = fiscal number, <code>railHints: [\"airtel_momo\"]</code></li> <li>CTS routes to the Airtel MoMo rail gateway \u2192 STK Push to customer's phone</li> <li>Customer approves \u2192 rail confirms SETTLED \u2192 CTS emits <code>transfer.settled</code> event</li> <li>POS updates the invoice record with the payment confirmation reference</li> </ol> <p>Step 3 is optional. Many DRC merchants accept mobile money payments out-of-band (customer pays directly from their phone app) and the POS simply records the transaction reference on the invoice. The CTS integration is for merchants who want Stalela to initiate and track the payment.</p>"},{"location":"00-foundation/mobile-money/#usd-cdf-dual-currency","title":"USD / CDF Dual Currency","text":"<p>DRC businesses routinely price in USD and accept payment in CDF at the daily exchange rate. Both pillars handle this:</p> <ul> <li>Fiscal Platform: The invoice records <code>totals</code> in the transaction currency (USD) and the <code>payments</code> array records the actual amount tendered in CDF. The tax engine computes tax in the invoicing currency.</li> <li>Payments Nucleus: The CTS supports <code>sourceCurrency</code> / <code>targetCurrency</code> with <code>fxStrategy</code> to handle cross-currency settlement.</li> </ul> <p>Split payments (part USD cash, part CDF mobile money) are a Phase 1 requirement for the Fiscal Platform and are supported natively in the <code>payments</code> array.</p>"},{"location":"00-foundation/multi-tenant-model/","title":"Multi-Tenant Model","text":"<p>Both pillars of the Stalela Platform enforce strict tenant isolation. This page explains how identity scoping works across the Payments Nucleus and Fiscal Platform, and how the two map together.</p>"},{"location":"00-foundation/multi-tenant-model/#identity-hierarchy","title":"Identity Hierarchy","text":"<pre><code>flowchart TD\n    T[\"Stalela Account (tenantId)\"] --&gt; M[\"Merchant (merchant_tin)\"]\n    M --&gt; O1[\"Outlet 1 (outlet_id)\"]\n    M --&gt; O2[\"Outlet 2 (outlet_id)\"]\n    O1 --&gt; T1[\"POS Terminal 1 (pos_terminal_id)\"]\n    O1 --&gt; T2[\"POS Terminal 2 (pos_terminal_id)\"]\n    O1 --&gt; C1[\"Cashier A (cashier_id)\"]\n    O1 --&gt; C2[\"Cashier B (cashier_id)\"]</code></pre>"},{"location":"00-foundation/multi-tenant-model/#mapping-across-pillars","title":"Mapping Across Pillars","text":"Payments Nucleus Fiscal Platform Notes <code>tenantId</code> <code>merchant_tin</code> 1:1 binding created during merchant onboarding (not scoped) <code>outlet_id</code> Payments Nucleus operates at tenant level; fiscal numbering needs outlet-level scoping (not scoped) <code>pos_terminal_id</code> CTS doesn't need terminal-level identity; fiscal audit trails do (not scoped) <code>cashier_id</code> Same \u2014 fiscal only <code>endUserRef</code> <code>fiscal_number</code> Cross-reference link: a transfer can carry the fiscal number of the invoice it settles"},{"location":"00-foundation/multi-tenant-model/#how-the-binding-works","title":"How the Binding Works","text":"<p>When a merchant signs up for the Stalela Platform:</p> <ol> <li>Account creation \u2192 a <code>tenantId</code> is minted in the Payments Nucleus and a <code>merchant_tin</code> is registered in the Fiscal Platform.</li> <li>Outlet registration \u2192 each physical location gets an <code>outlet_id</code> in the Fiscal Platform. The Payments Nucleus doesn't require outlet-level scoping, but the <code>outlet_id</code> can be passed as <code>metadata</code> on transfers for reconciliation.</li> <li>API keys \u2192 each API key is scoped to both a <code>tenantId</code> (Payments) and a <code>merchant_tin</code> + <code>outlet_id</code> (Fiscal). A single Bearer token authenticates to both pillars.</li> </ol>"},{"location":"00-foundation/multi-tenant-model/#request-headers","title":"Request Headers","text":"Header Payments Nucleus Fiscal Platform <code>Authorization: Bearer &lt;token&gt;</code> Required Required <code>X-Stalela-Tenant-ID</code> Required (derived from token) <code>X-Stalela-Merchant-ID</code> (optional, metadata) Required <code>X-Stalela-Outlet-ID</code> (optional, metadata) Required <code>X-Stalela-User-ID</code> (optional, audit trail) (optional, audit trail) <code>X-Stalela-Source</code> (optional: dashboard, sdk, pos) (optional: dashboard, api, sdk, pos)"},{"location":"00-foundation/multi-tenant-model/#data-isolation-guarantees","title":"Data Isolation Guarantees","text":"<ul> <li>Payments Nucleus: All CTS queries, GL Ledger postings, reconciliation matches, and compliance screenings are filtered by <code>tenantId</code>. No cross-tenant data leakage.</li> <li>Fiscal Platform: All fiscal numbers, ledger entries, reports, and tax authority sync bundles are scoped to <code>merchant_tin</code> + <code>outlet_id</code>. The Monotonic Counter Manager enforces per-outlet serialization.</li> <li>Cross-pillar: The <code>endUserRef</code> on a transfer may reference a <code>fiscal_number</code> from the Fiscal Platform, but the CTS treats it as opaque metadata \u2014 it never queries the Fiscal Ledger directly.</li> </ul>"},{"location":"00-overview/","title":"Stalela Documentation","text":"<p>Welcome to the Stalela Docs \u2014 the single source of truth for how the Stalela payments nucleus is designed, built, and operated.</p>"},{"location":"00-overview/#what-this-provides","title":"\ud83c\udf0d What this provides?","text":"<p>Stalela provides a payments nucleus for the Southern Africa \u2194 global corridor. It provides:</p> <ul> <li>Unified API for payments, payouts, and transfers.</li> <li>Ledger for strict double-entry accounting and balance tracking.</li> <li>Router that connects to multiple rails (USDC on Avax/Algorand, Zimswitch/OPPWA, mobile money, EFT).</li> <li>Compliance and reconciliation as first-class components, not afterthoughts.</li> </ul> <p>Think of it as the boring but unbreakable center of our payment universe.</p>"},{"location":"00-overview/#whats-in-this-documentation","title":"\ud83e\udde9 What\u2019s in this Documentation?","text":"<p>This docs repo is organized into clear layers:</p>"},{"location":"00-overview/#1-overview-you-are-here","title":"1. Overview (you are here)","text":"<ul> <li><code>index.md</code> \u2192 This page: big-picture introduction, how to use the docs.</li> <li><code>nucleus.md</code> \u2192 Detailed description of the Stalela nucleus (all components together).</li> <li><code>glossary.md</code> \u2192 Domain terms (rails, ledger, reconciliation, returns, etc.).</li> <li><code>architecture-decisions/</code> \u2192 ADRs (Architecture Decision Records) documenting why we made key choices.</li> </ul>"},{"location":"00-overview/#2-components","title":"2. Components","text":"<p>Each nucleus component has its own page: - Canonical Transfer Service (CTS) - Rail Gateways (Zimswitch, OPPWA, USDC/Algorand) - Ledger Service - Compliance Screening - Directory &amp; Routing - Reconciliation &amp; Returns - Event Bus + Outbox - Platform/Base - Operator Console</p> <p>Each page explains Purpose \u2192 Responsibilities \u2192 Interfaces \u2192 Data \u2192 Diagrams \u2192 Failure Modes \u2192 Ops.</p>"},{"location":"00-overview/#3-specs","title":"3. Specs","text":"<ul> <li>Event envelope &amp; catalog</li> <li>Canonical Transfer API schema (<code>POST /transfers</code>)</li> <li>Posting rules (event \u2192 debit/credit accounts)</li> <li>Data retention &amp; PII handling</li> </ul>"},{"location":"00-overview/#4-diagrams","title":"4. Diagrams","text":"<ul> <li>Component diagram of the nucleus</li> <li>Transfer lifecycle state machine</li> <li>Sequence diagrams for common flows (e.g. USDC payment, OPPWA return, reconciliation match)</li> </ul>"},{"location":"00-overview/#5-ops","title":"5. Ops","text":"<ul> <li>Runbooks (returns, reconciliation triage, compliance freeze/unfreeze)</li> <li>Observability (metrics, dashboards, logs, SLOs)</li> <li>Security (secrets, IAM, PII redaction)</li> </ul>"},{"location":"00-overview/#6-templates","title":"6. Templates","text":"<p>Reusable templates for: - New component docs - Sequence diagrams - State diagrams - ADRs</p>"},{"location":"00-overview/#how-to-read-this-repo","title":"\ud83d\udcd6 How to Read this Repo","text":"<ul> <li>If you\u2019re an engineer \u2192 dive into <code>10-components/</code> and <code>20-specs/</code>.  </li> <li>If you\u2019re an operator \u2192 check <code>40-ops/runbooks.md</code>.  </li> <li>If you\u2019re reviewing a design decision \u2192 see <code>00-overview/architecture-decisions/</code>.</li> </ul>"},{"location":"00-overview/#diagram-standards","title":"\ud83d\udcd0 Diagram Standards","text":"<p>We use Mermaid diagrams in Markdown. GitHub renders them directly; you can also export with <code>@mermaid-js/mermaid-cli</code>.</p> <ul> <li>Component diagrams \u2192 boxes + arrows (what services exist, how they talk).  </li> <li>State diagrams \u2192 transfer lifecycle (INITIATED \u2192 SETTLED \u2192 RETURNED).  </li> <li>Sequence diagrams \u2192 end-to-end message flows (client \u2192 CTS \u2192 rail gateway \u2192 ledger).  </li> </ul> <p>Example:</p> <p>```mermaid flowchart LR   Client --&gt; CTS[Canonical Transfer Service]   CTS --&gt; GW[Rail Gateway]   GW --&gt; EB[(Event Bus)]   EB --&gt; L[Ledger]</p>"},{"location":"00-overview/dev-workflow/","title":"Development Workflow","text":"<p>This document sets conventions for how we develop, review, and deploy Stalela nucleus code.</p>"},{"location":"00-overview/dev-workflow/#branching","title":"\ud83d\udd00 Branching","text":"<ul> <li>Main branch = always deployable.</li> <li>Feature branches \u2192 PR \u2192 merge to main (require review).</li> <li>Hotfix branches allowed only with approval.</li> </ul>"},{"location":"00-overview/dev-workflow/#code-reviews","title":"\ud83d\udcdd Code Reviews","text":"<ul> <li>Minimum 1 reviewer for all PRs.</li> <li>Use ADRs for architectural changes.</li> <li>Must include tests for all new code.</li> </ul>"},{"location":"00-overview/dev-workflow/#testing-levels","title":"\u2705 Testing Levels","text":"<ul> <li>Unit tests with golden fixtures (esp. rail adapters).</li> <li>Integration tests with mocks/stubs.</li> <li>End-to-end tests with sandbox rails (EcoCash, OPPWA, USDC).</li> </ul>"},{"location":"00-overview/dev-workflow/#cicd","title":"\ud83c\udfd7 CI/CD","text":"<ul> <li>GitHub Actions pipeline:</li> <li>Build \u2192 Lint \u2192 Test \u2192 Dockerize \u2192 Deploy (staging).</li> <li>Staging deploys automatically.</li> <li>Production deploys require approval.</li> </ul>"},{"location":"00-overview/dev-workflow/#docs-adrs","title":"\ud83d\udccc Docs &amp; ADRs","text":"<ul> <li>Every new service/component must include a <code>docs/10-components/&lt;name&gt;.md</code>.</li> <li>Significant design changes must log an ADR under <code>00-overview/architecture-decisions/</code>.</li> </ul>"},{"location":"00-overview/dev-workflow/#secrets-security","title":"\ud83d\udd10 Secrets &amp; Security","text":"<ul> <li>No secrets in repo.</li> <li>All secrets via Vault or AWS SSM.</li> </ul>"},{"location":"00-overview/glossary/","title":"Glossary","text":"<p>Shared domain language for Stalela. Sources include our design docs and Moov.io\u2019s terms-dictionary. This file should be the first stop for new contributors.</p>"},{"location":"00-overview/glossary/#a","title":"A","text":"<p>ACH Automated Clearing House. Batch-based payment network in the U.S. Not directly used in Stalela, but referenced via Moov patterns.</p> <p>Account A ledger entity that holds balances and records postings. Types include: User, Merchant, Liquidity, Fees, FX, Settlement.</p> <p>AI Routing AI-enhanced orchestration capability that ranks and selects rails in real time using policy weights, historical performance, cost, and risk context.</p> <p>ADR (Architecture Decision Record) Lightweight doc capturing a key architectural choice, its context, decision, and consequences.</p> <p>Authorization (AUTH) A request to place a hold on funds. In Stalela, represented in the canonical transfer intent.</p>"},{"location":"00-overview/glossary/#b","title":"B","text":"<p>BAI2 Bank Administration Institute format for statement files. Used by Moov and referenced as a model for Stalela\u2019s reconciliation exports.</p> <p>Balance The net amount for an account at a given time, derived from postings.</p> <p>BIN (Bank Identification Number) The first digits of a card number, identifying the issuer. Stored in the Directory service.</p> <p>Bus (Event Bus) Pub/sub system (SNS+SQS in dev) delivering domain events between services.</p>"},{"location":"00-overview/glossary/#c","title":"C","text":"<p>Canonical Transfer Service (CTS) Front-door API and orchestrator for transfers in Stalela. Ensures idempotency, normalization, compliance, and routing.</p> <p>Chargeback / Return Reversal of a prior settlement, with reason codes. Modeled as state transitions in CTS and reversal postings in the Ledger.</p> <p>Compliance Screening Process of checking payer/payee against watchlists (OFAC, UN, EU, SA FIC). Implemented as a local fast index.</p> <p>Cutoff Time of day after which payments are queued for next business day. Defined in Directory service.</p>"},{"location":"00-overview/glossary/#d","title":"D","text":"<p>Directory Service Component maintaining authoritative data on institutions, BINs, fees, and settlement windows.</p> <p>Double-entry Accounting principle: every debit has an equal credit. Enforced in Stalela Ledger.</p> <p>DLQ (Dead Letter Queue) Queue for events that failed processing and need operator intervention.</p>"},{"location":"00-overview/glossary/#e","title":"E","text":"<p>Event Immutable record emitted by a service (e.g., <code>transfers.settled</code>). Structured by the event envelope spec.</p> <p>Event Envelope Standard wrapper for all events: <code>{ eventId, type, occurredAt, transferId, tenantId, payload }</code>.</p> <p>External Reference Rail- or partner-provided identifier (e.g., auth code, transaction ref). Stored in transfers table.</p>"},{"location":"00-overview/glossary/#f","title":"F","text":"<p>FBO (For Benefit Of) Banking account structure where a custodian holds funds for multiple end-users. Modeled in Ledger accounts.</p> <p>Fixture (Golden Test) Sample payload used in tests to ensure round-trip parsing and validation stability.</p>"},{"location":"00-overview/glossary/#g","title":"G","text":"<p>Gateway Adapter for a payment rail (Zimswitch, OPPWA, USDC/Algorand). Translates canonical transfers into rail-specific requests.</p> <p>GL (General Ledger) The book of record. Stalela Ledger service maintains the general ledger.</p> <p>Glossary This file. Shared terms and definitions.</p>"},{"location":"00-overview/glossary/#i","title":"I","text":"<p>Idempotency Ensuring a request (e.g., <code>POST /transfers</code>) can be safely retried without duplication.</p> <p>ISO 8583 International standard for card payment messages. Zimswitch uses this; Stalela validates payloads via strict schemas.</p> <p>ISO 20022 XML/JSON standard for financial messaging. Referenced for future-proofing rails.</p>"},{"location":"00-overview/glossary/#l","title":"L","text":"<p>Ledger The authoritative record of postings, balances, and statements. Event-driven, double-entry, append-only.</p> <p>Lifecycle (Transfer) State machine: INITIATED \u2192 SUBMITTED \u2192 ACCEPTED \u2192 SETTLED \u2192 (RETURNED | FAILED).</p> <p>Liquidity Account Special ledger account representing pooled liquidity held for customer settlements.</p>"},{"location":"00-overview/glossary/#o","title":"O","text":"<p>Observability The ability to measure, trace, and debug system behavior via metrics, logs, and tracing.</p> <p>OFAC Office of Foreign Assets Control. U.S. sanctions list. Indexed locally alongside UN/EU/SA lists.</p> <p>Operator Console Internal UI for handling returns, recon exceptions, and compliance flags.</p>"},{"location":"00-overview/glossary/#p","title":"P","text":"<p>PII (Personally Identifiable Information) Sensitive data (names, IDs, PANs). Must be encrypted, redacted in logs, and retained per policy.</p> <p>Posting Atomic debit/credit entry in the ledger. Immutable, append-only.</p> <p>Posting Rules Mapping from transfer events to specific ledger postings (accounts, amounts, memos).</p>"},{"location":"00-overview/glossary/#r","title":"R","text":"<p>Rail A payment network (e.g., Zimswitch, OPPWA, Algorand/USDC).</p> <p>Risk Agents AI services embedded in CTS orchestration that evaluate fraud and identity signals to assign compliance tiers and trigger adaptive controls.</p> <p>Reconciliation Process of matching partner statements or on-chain events with internal transfers. Runs nightly.</p> <p>Return Negative state transition; undo of a prior settlement with reason codes.</p>"},{"location":"00-overview/glossary/#s","title":"S","text":"<p>Settlement Final movement of funds on a rail. In Stalela, confirmed by events and reconciled against statements.</p> <p>Specs Repo Dedicated repo holding event schemas, API definitions, and fixtures (<code>storo-specs</code>). Source of truth for contracts.</p> <p>State Diagram Visual representation of lifecycle states and transitions (Mermaid).</p>"},{"location":"00-overview/glossary/#t","title":"T","text":"<p>Tenant Isolated namespace for a customer/institution using Stalela. All transfers are scoped by tenantId.</p> <p>Trace ID Identifier used for distributed tracing across services.</p> <p>Transfer Core unit of money movement in Stalela, defined by canonical schema (payer, payee, amount, rail, intent, etc.).</p>"},{"location":"00-overview/glossary/#w","title":"W","text":"<p>Watchlist Sanctions/risk list (OFAC, UN, EU, SA FIC). Ingested and indexed locally for compliance screening.</p> <p>This glossary evolves with the system. Always update it alongside specs and ADRs.</p>"},{"location":"00-overview/nfrs/","title":"Non-Functional Requirements (NFRs)","text":"<p>This document captures the performance, availability, security, and compliance targets for the Stalela nucleus.</p>"},{"location":"00-overview/nfrs/#availability","title":"\ud83c\udfaf Availability","text":"<ul> <li>Target uptime: 99.9% minimum (3-nines) during MVP.</li> <li>Long-term target: 99.99% for core services (Canonical Transfer Service, Ledger, Event Bus).</li> </ul>"},{"location":"00-overview/nfrs/#performance","title":"\u26a1 Performance","text":"<ul> <li>API latency (P99):</li> <li>POST /transfers: \u2264 250 ms (excluding external rail).</li> <li>Balance queries: \u2264 100 ms.</li> <li>Event bus publish lag (P99): \u2264 1 s.</li> <li>Ledger posting confirmation: \u2264 1 s after settlement.</li> </ul>"},{"location":"00-overview/nfrs/#throughput","title":"\ud83d\udcca Throughput","text":"<ul> <li>MVP scale: 50 TPS sustained.</li> <li>Scale target (2 years): 500 TPS sustained.</li> </ul>"},{"location":"00-overview/nfrs/#security","title":"\ud83d\udd10 Security","text":"<ul> <li>Mutual TLS between services.</li> <li>Tenant API keys or JWT for client APIs.</li> <li>PII encrypted at rest, redacted in logs.</li> <li>Secrets rotation: 90 days.</li> </ul>"},{"location":"00-overview/nfrs/#compliance","title":"\ud83e\uddfe Compliance","text":"<ul> <li>Audit logs immutable and retained 7 years.</li> <li>Data residency: all primary storage in-region (SA/ZW).</li> <li>Screening latency: \u2264 500 ms pre-submit.</li> </ul>"},{"location":"00-overview/nfrs/#notes","title":"\ud83d\udccc Notes","text":"<p>This document will evolve with load tests, audits, and regulatory requirements.</p>"},{"location":"00-overview/nucleus/","title":"Stalela Nucleus","text":"<p>The Stalela nucleus is the boring, strict, event-driven core of the platform. It orchestrates all money movement across rails (USDC/Algorand, Zimswitch/OPPWA, EFT, mobile money) while enforcing compliance, ledger discipline, and reconciliation.</p>"},{"location":"00-overview/nucleus/#purpose","title":"\ud83c\udfaf Purpose","text":"<p>The nucleus exists to: - Provide a single canonical model for all transfers. - Keep rail-specific logic isolated in gateways. - Guarantee double-entry correctness via the ledger. - Ensure compliance and reconciliation are first-class, not bolted on. - Emit domain events so every change is observable and auditable.  </p>"},{"location":"00-overview/nucleus/#components-at-a-glance","title":"\ud83e\udde9 Components at a Glance","text":"<ul> <li>Canonical Transfer Service (CTS) \u2192 orchestrates transfer lifecycle, idempotency, emits events.  </li> <li>Rail Gateways \u2192 adapters for each rail, strict spec validation, submit &amp; emit rail outcomes.  </li> <li>Ledger Service \u2192 double-entry postings, balances, statements.  </li> <li>Compliance Screening \u2192 fast local allow/deny; pre-submit &amp; delta re-screens.  </li> <li>Directory &amp; Routing \u2192 institutions, BINs, fees, settlement windows.  </li> <li>Reconciliation &amp; Returns \u2192 ingest statements, match transfers, manage returns/exceptions.  </li> <li>Event Bus + Outbox \u2192 exactly-once event delivery; glue between services.  </li> <li>Platform/Base \u2192 shared utilities (admin, time, IDs, error handling, migrations).  </li> <li>Operator Console \u2192 human control surface for exceptions, flags, returns.  </li> </ul>"},{"location":"00-overview/nucleus/#component-diagram","title":"\ud83c\udfd7\ufe0f Component Diagram","text":"<pre><code>flowchart LR\n  subgraph Client/Partners\n    A[Client Apps / Merchants / WhatsApp Bot]\n  end\n\n  subgraph Core[\"Stalela Nucleus\"]\n    direction LR\n\n    subgraph API[\"Canonical Transfer Service (API)\"]\n      CTS[POST /transfers&lt;br/&gt;GET /transfers/:id&lt;br/&gt;Idempotency]\n    end\n\n    subgraph GW[\"Rail Gateways\"]\n      ZG[Zimswitch Gateway]\n      OG[OPPWA Gateway]\n      UG[USDC/Algorand Gateway]\n    end\n\n    subgraph L[\"Ledger Service\"]\n      LJ[Journal &amp; Postings]\n      LB[Balances &amp; Statements]\n    end\n\n    subgraph C[\"Compliance Screening\"]\n      CS[Local Watchlist Index&lt;br/&gt;/screen]\n    end\n\n    subgraph D[\"Directory &amp; Routing\"]\n      DR[Institutions/BINs&lt;br/&gt;Fees &amp; Windows]\n    end\n\n    subgraph R[\"Reconciliation &amp; Returns\"]\n      RC[Statement Ingest&lt;br/&gt;Unmatched Queue]\n    end\n\n    subgraph B[\"Event Bus + Outbox\"]\n      EB[(Topics: transfers.*, ledger.*, recon.*)]\n    end\n\n    subgraph O[\"Operator Console\"]\n      OC[Ops UI&lt;br/&gt;Returns/Recon/Flags]\n    end\n\n    subgraph PL[\"Platform/Base\"]\n      AD[/ /live /ready /metrics /version /]\n      TM[Banking Time &amp; Holidays]\n      IDG[ID/Tracing &amp; Errors]\n    end\n  end\n\n  A --&gt;|create intent| CTS\n  CTS --&gt;|pre-screen| CS\n  CS --&gt;|allow/deny| CTS\n  CTS --&gt;|route| D\n  D --&gt; CTS\n  CTS --&gt;|submit| ZG\n  CTS --&gt;|submit| OG\n  CTS --&gt;|submit| UG\n\n  ZG --&gt; EB\n  OG --&gt; EB\n  UG --&gt; EB\n\n  EB --&gt; CTS\n  EB --&gt; L\n  EB --&gt; R\n  EB --&gt; O\n\n  L &lt;--&gt; R\n  R --&gt;|nightly ingest| EB\n\n  OC --- O\n  PL --- CTS\n  PL --- GW\n  PL --- L\n  PL --- C\n  PL --- D\n  PL --- R</code></pre>"},{"location":"00-overview/nucleus/#ai-enhanced-orchestration-layer","title":"AI-Enhanced Orchestration Layer","text":"<p>The Nucleus architecture now includes a dynamic orchestration layer that leverages AI agents to optimize transaction flows in real time.</p> <p>This layer works alongside our existing Directory, Routing, and Compliance modules \u2014 not as replacements, but as intelligent decision advisors that enhance behavior based on transaction context, user risk, and infrastructure state.</p>"},{"location":"00-overview/nucleus/#capabilities-introduced","title":"Capabilities Introduced","text":"<ul> <li>Smart Rail Selector Agent \u2014 ranks and selects the optimal route across mobile money, bank, card, voucher, or crypto, based on historical performance, cost, latency, and user profile.</li> <li>Dynamic Risk Classifier \u2014 applies real-time fraud and identity risk scoring to determine appropriate compliance tiering.</li> <li>Rail Health Monitor Agent \u2014 observes system-wide metrics (e.g., failure rate, latency, uptime) and dynamically adjusts available routing paths.</li> <li>Orchestration Copilot \u2014 exposes orchestration decisions and performance to devs and operators via CLI or natural language assistant.</li> </ul>"},{"location":"00-overview/nucleus/#architectural-changes","title":"Architectural Changes","text":"<pre><code>flowchart LR\n    App[Client App] --&gt; CTS\n    CTS --&gt; AI_Route[Smart Rail Selector Agent]\n    AI_Route --&gt; Directory\n    Directory --&gt; Routing\n    Routing --&gt; Events\n    Events --&gt; Rail\n    Compliance --&gt; AI_Risk[Risk Classifier]\n    Events --&gt; AI_Health[Health Monitor]</code></pre> <p>Each AI agent is stateless, invoked via microservice or function call, and emits traceable events like:</p> <ul> <li><code>route.selected.via_ai</code></li> <li><code>risk.assessed.via_model</code></li> <li><code>rail.flagged.degraded</code></li> </ul>"},{"location":"00-overview/nucleus/#transfer-lifecycle-state-machine","title":"\ud83d\udd04 Transfer Lifecycle (State Machine)","text":"<pre><code>stateDiagram-v2\n  [*] --&gt; INITIATED\n  INITIATED --&gt; SUBMITTED: CTS submits.&lt;rail&gt;\n  SUBMITTED --&gt; ACCEPTED: rail reference received\n  ACCEPTED --&gt; SETTLED: funds final\n  ACCEPTED --&gt; RETURNED: return/chargeback code\n  SUBMITTED --&gt; FAILED: technical failure\n  SETTLED --&gt; [*]\n  RETURNED --&gt; [*]\n  FAILED --&gt; [*]</code></pre>"},{"location":"00-overview/nucleus/#event-model","title":"\ud83d\udce1 Event Model","text":"<p>The nucleus continues to emit canonical events for lifecycle transitions, ledger postings, and reconciliation outcomes. With the AI-enhanced orchestration layer, additional signals improve observability, feedback loops, and operator insight.</p>"},{"location":"00-overview/nucleus/#new-events","title":"New Events","text":"Event Name Payload Triggered By <code>route.selected.via_ai</code> {path, score, features used} Smart Rail Selector Agent <code>risk.tier.assigned</code> {user_id, risk_score, compliance_level} Dynamic Risk Classifier <code>rail.flagged.degraded</code> {rail_id, health_metrics, timestamp} Rail Health Monitor Agent <code>orchestration.fallback.used</code> {original_path, fallback_path, reason} CTS fallback handler <p>These events land on the existing bus and follow the same envelope structure and retention policies as the rest of the domain model. They provide downstream services and operators with the rationale behind AI-guided actions, enabling rapid tuning, auditing, and simulation.</p>"},{"location":"00-overview/nucleus/#contracts","title":"\ud83d\udcdc Contracts","text":""},{"location":"00-overview/nucleus/#event-envelope","title":"Event Envelope","text":"<pre><code>{\n  \"eventId\": \"uuid\",\n  \"type\": \"transfers.settled\",\n  \"occurredAt\": \"2025-08-26T10:15:01Z\",\n  \"transferId\": \"tr_12345\",\n  \"tenantId\": \"tn_67890\",\n  \"payload\": { \"amount\": { \"value\": 100, \"currency\": \"ZAR\" }, \"rail\": \"zimswitch\" }\n}\n</code></pre>"},{"location":"00-overview/nucleus/#canonical-transfer","title":"Canonical Transfer","text":"<pre><code>{\n  \"transferId\": \"tr_12345\",\n  \"tenantId\": \"tn_67890\",\n  \"payer\": { \"accountId\": \"acct_001\" },\n  \"payee\": { \"accountId\": \"acct_999\" },\n  \"amount\": { \"value\": 1000, \"currency\": \"USD\" },\n  \"rail\": \"usdc-algo\",\n  \"intent\": \"PUSH\",\n  \"externalRef\": \"ext_abc123\",\n  \"metadata\": { \"invoiceId\": \"inv_555\" },\n  \"state\": \"SUBMITTED\"\n}\n</code></pre>"},{"location":"00-overview/nucleus/#posting","title":"Posting","text":"<pre><code>{\n  \"postingId\": \"pst_001\",\n  \"transferId\": \"tr_12345\",\n  \"debitAccountId\": \"acct_001\",\n  \"creditAccountId\": \"acct_999\",\n  \"amount\": { \"value\": 1000, \"currency\": \"USD\" },\n  \"memo\": \"Payment settlement\",\n  \"occurredAt\": \"2025-08-26T10:15:01Z\"\n}\n</code></pre>"},{"location":"00-overview/nucleus/#non-negotiables","title":"\u2705 Non-Negotiables","text":"<ul> <li>Strict validation at rail gateways (no malformed messages pass).  </li> <li>Exactly-once events (via outbox + idempotent consumers).  </li> <li>Double-entry always balanced.  </li> <li>Compliance pre-screen mandatory before submission.  </li> <li>Reconciliation nightly, exceptions reviewed before books close.  </li> <li>Operator console required for human resolution.  </li> </ul>"},{"location":"00-overview/nucleus/#slos","title":"\ud83d\udcc8 SLOs","text":"<ul> <li>API latency (P99, <code>POST /transfers</code>): \u2264 250 ms (excluding rail response).  </li> <li>Event publish lag (P99): \u2264 1 s.  </li> <li>Ledger posting latency (P99): \u2264 1 s after <code>settled</code>.  </li> <li>Reconciliation match rate: \u2265 99.8% same day, 100% by T+1.  </li> <li>Idempotency collision rate: 0%.  </li> </ul> <p>Next step: See ../10-components/canonical-transfer-service.md for detailed pages on each service.</p>"},{"location":"00-overview/risks-open-questions/","title":"Risks &amp; Open Questions","text":"<p>This is a living list of risks and unknowns that need clarity.</p>"},{"location":"00-overview/risks-open-questions/#open-questions","title":"\u2753 Open Questions","text":"<ul> <li>Settlement liquidity ownership: who pre-funds? merchant vs Stalela vs bank?</li> <li>How to handle returns when rail semantics don\u2019t map 1:1?</li> <li>Which rails are priority for MVP (EcoCash, USDC, OPPWA)?</li> <li>Is PayShap integration required in Phase 1?</li> </ul>"},{"location":"00-overview/risks-open-questions/#risks","title":"\u26a0\ufe0f Risks","text":"<ul> <li>Regulatory approvals may delay go-live (cross-border, FIC).</li> <li>Rail instability: EcoCash APIs historically unreliable.</li> <li>Telco politics: MNOs may resist third-party integrations.</li> <li>Crypto volatility: reliance on USDC requires hedging &amp; liquidity planning.</li> <li>Fraud risk: high potential for SIM swaps and social engineering.</li> </ul>"},{"location":"00-overview/risks-open-questions/#mitigation-ideas","title":"\ud83d\udccc Mitigation Ideas","text":"<ul> <li>Start with rails we fully control (USDC).</li> <li>Build compliance and audit hooks early.</li> <li>Work with AfricaNenda/Mojaloop for regulatory credibility.</li> </ul>"},{"location":"00-overview/stalela-vs-mojaloop/","title":"Stalela Nucleus vs Mojaloop Hub - Visual Contrast","text":"<p>This note shows how Stalela is inspired by Mojaloop while keeping a modular, rail-agnostic nucleus. Two diagrams: 1) Component landscape comparison 2) Transaction flow (Request-to-Pay) mapped to each architecture</p>"},{"location":"00-overview/stalela-vs-mojaloop/#1-component-landscape","title":"1) Component Landscape","text":"<pre><code>flowchart LR\n  subgraph S[\"Stalela Nucleus (Modular, Rail-Agnostic)\"]\n    direction LR\n    S1[\"CTS (Canonical Transfer Service)\"]\n    S2[\"Rail Gateways (EcoCash/PayShap/OPPWA/USDC)\"]\n    S3[\"Ledger Service (Double-Entry)\"]\n    S4[\"Compliance (Screening/Lists)\"]\n    S5[\"Directory &amp; Routing (ALS/Fees/Windows)\"]\n    S6[\"Reconciliation &amp; Returns\"]\n    S7[\"Event Bus + Outbox\"]\n    S8[\"Operator Console\"]\n    S9[\"Platform/Base (Admin/Time/Errors/IDs)\"]\n  end\n\n  subgraph M[\"Mojaloop Hub (Switch + Scheme Services)\"]\n    direction LR\n    M1[\"Account Lookup Service (ALS / Discovery)\"]\n    M2[\"Quoting Service (FX / Fees Agreement)\"]\n    M3[\"Central Ledger (Clearing/Positions)\"]\n    M4[\"Settlement Module (RTGS/Net/Prefund)\"]\n    M5[\"Scheme Rules &amp; Auth (PKI, Signatures, Consent)\"]\n    M6[\"Fraud/Risk Hooks\"]\n    M7[\"FSPIOP API Gateway\"]\n    M8[\"ILP Coordinator (Conditions/Fulfillment)\"]\n  end\n\n  %% Stalela internals\n  S1 --&gt; S4\n  S1 --&gt; S5\n  S1 --&gt; S2\n  S2 --&gt; S7\n  S7 --&gt; S3\n  S7 --&gt; S6\n  S8 --- S7\n  S9 --- S1\n  S9 --- S2\n  S9 --- S3\n\n  %% Mojaloop internals\n  M7 --&gt; M1\n  M7 --&gt; M2\n  M7 --&gt; M8\n  M8 --&gt; M3\n  M3 --&gt; M4\n  M5 --- M7\n  M6 --- M7\n</code></pre> <p>Key differences - Stalela separates rail adapters (gateways) from the core; ledger is internal SoT. - Mojaloop is a shared switch: it offers discovery, quoting, clearing &amp; settlement to external DFSPs. - Both use directories (ALS), FX/fees agreement, security (PKI), and fraud hooks \u2014 but Stalela keeps them inside its nucleus; Mojaloop exposes them as scheme services.</p>"},{"location":"00-overview/stalela-vs-mojaloop/#2-request-to-pay-r2p-flow-side-by-side","title":"2) Request-to-Pay (R2P) Flow \u2014 Side-by-Side","text":"<pre><code>sequenceDiagram\n  autonumber\n  participant Client as Merchant App / POS\n  participant Stalela as Stalela CTS\n  participant Dir as Directory (ALS)\n  participant GW as Rail Gateway (e.g., EcoCash/PayShap/USDC)\n  participant Ledger as Ledger Service\n\n  Note over Client,Ledger: Stalela \u2014 Rail-agnostic nucleus\n\n  Client-&gt;&gt;Stalela: POST /transfers (payer alias, amount, rail)\n  Stalela-&gt;&gt;Dir: Resolve alias -&gt; provider/route\n  Dir--&gt;&gt;Stalela: Provider &amp; fees/windows\n  Stalela-&gt;&gt;GW: transfers.submitted.&lt;rail&gt;\n  GW--&gt;&gt;Stalela: transfers.accepted (prompt delivered / tx observed)\n  GW--&gt;&gt;Stalela: transfers.settled (funds final)\n  Stalela-&gt;&gt;Ledger: Postings (Dr/Cr + fees/FX)\n  Ledger--&gt;&gt;Stalela: Balances updated\n  Stalela--&gt;&gt;Client: 200 OK (state: SETTLED)</code></pre> <pre><code>sequenceDiagram\n  autonumber\n  participant PayerApp as Payer DFSP App\n  participant Hub as Mojaloop Hub (FSPIOP)\n  participant ALS as Account Lookup (Discovery)\n  participant Quote as Quoting (FX/Fees)\n  participant ILP as ILP/Transfer Orchestrator\n  participant PayeeApp as Payee DFSP App\n  participant Settle as Settlement/RTGS\n\n  Note over PayerApp,Settle: Mojaloop \u2014 Shared scheme with DFSPs\n\n  PayerApp-&gt;&gt;Hub: POST /parties (discover payee alias)\n  Hub-&gt;&gt;ALS: Lookup alias -&gt; DFSP\n  ALS--&gt;&gt;Hub: Payee DFSP\n  Hub-&gt;&gt;PayeeApp: GET /quotes?amount,currency\n  PayeeApp--&gt;&gt;Hub: Quote (amountIn/Out, fees, FX, ILP condition)\n  Hub--&gt;&gt;PayerApp: Quote (approve?)\n  PayerApp-&gt;&gt;Hub: POST /transfers (attach ILP condition)\n  Hub-&gt;&gt;ILP: Coordinate conditional transfer\n  ILP-&gt;&gt;PayeeApp: Fulfill if terms met\n  PayeeApp--&gt;&gt;Hub: Transfer success\n  Hub-&gt;&gt;Settle: (Net/Gross) settlement instruction\n  Hub--&gt;&gt;PayerApp: Transfer completed</code></pre> <p>Interpretation - Stalela treats R2P as an internal orchestration; gateways perform the last-mile prompt/observe/settle. - Mojaloop formalizes Discovery -&gt; Quote -&gt; Transfer across multiple DFSPs, with ILP ensuring atomicity and a separate settlement layer.</p>"},{"location":"00-overview/stalela-vs-mojaloop/#when-to-use-which-ideas","title":"When to use which ideas","text":"<ul> <li>Use Stalela\u2019s modular gateways when you must integrate diverse rails (EcoCash, PayShap, OPPWA, USDC) and keep a single internal ledger of record.  </li> <li>Use Mojaloop patterns (FSPIOP, ILP, ISO 20022 mapping, scheme rules) to standardize cross-institution flows and future-proof for regional interop.</li> </ul> <p>Draft v1 \u2014 for internal architecture review.</p>"},{"location":"00-overview/architecture-decisions/ADR-0001-events-outbox/","title":"ADR-0001: Outbox Pattern Mandatory","text":"<p>Status: Accepted Date: 2025-08-26</p>"},{"location":"00-overview/architecture-decisions/ADR-0001-events-outbox/#context","title":"Context","text":"<p>Stalela is an event-driven system. Each service must emit domain events when its state changes (e.g., <code>transfers.submitted</code>, <code>ledger.balance.updated</code>). We need to guarantee exactly-once delivery of these events despite crashes, retries, or network failures.</p> <p>Na\u00efve approaches (publishing to the bus inside app logic) risk double-emits, message loss, or divergence between DB state and events.</p>"},{"location":"00-overview/architecture-decisions/ADR-0001-events-outbox/#decision","title":"Decision","text":"<p>Every service must implement the Outbox pattern:</p> <ul> <li>State change + outbox row are persisted in the same database transaction.  </li> <li>A background dispatcher process reads the outbox table and publishes events to the bus (SNS/SQS).  </li> <li>Consumers are idempotent (dedupe by <code>eventId</code> and <code>transferId+state</code>).  </li> <li>Failed publishes are retried with exponential backoff.  </li> <li>DLQ (dead-letter queue) captures poison events.  </li> </ul>"},{"location":"00-overview/architecture-decisions/ADR-0001-events-outbox/#consequences","title":"Consequences","text":"<ul> <li>Strong delivery semantics: events are published exactly once if possible, at least once otherwise, never zero.  </li> <li>Event consumers may see duplicates, so idempotency is required.  </li> <li>Storage overhead: each service maintains its own outbox table.  </li> <li>Operationally: requires monitoring dispatch lag, DLQ size, and retries.  </li> </ul>"},{"location":"00-overview/architecture-decisions/ADR-0001-events-outbox/#alternatives-considered","title":"Alternatives Considered","text":"<ul> <li>Two-phase commit with DB + broker \u2192 rejected (complex, brittle).  </li> <li>\"Best effort\" publish outside txn \u2192 rejected (event loss possible).  </li> </ul> <p>Next Steps: - Scaffold outbox table schema in <code>platform-base</code>. - Provide Go lib for services to use out-of-the-box (insert, dispatch, metrics).  </p>"},{"location":"00-overview/architecture-decisions/ADR-0002-double-entry-ledger/","title":"ADR-0002: Ledger is Double-Entry and Append-Only","text":"<p>Status: Accepted Date: 2025-08-26</p>"},{"location":"00-overview/architecture-decisions/ADR-0002-double-entry-ledger/#context","title":"Context","text":"<p>Stalela must provide an authoritative record of money movement across rails. Financial correctness requires:</p> <ul> <li>Balances that always reconcile.  </li> <li>Auditability of every change.  </li> <li>Ability to reverse but never delete.  </li> </ul>"},{"location":"00-overview/architecture-decisions/ADR-0002-double-entry-ledger/#decision","title":"Decision","text":"<p>The Ledger Service is a strict double-entry, append-only system:</p> <ul> <li>Every posting is a pair: debit one account, credit another, amounts equal.  </li> <li>Postings are immutable. Reversals are represented as new entries.  </li> <li>Balances are derived from postings (materialized views are allowed).  </li> <li>Accounts include User, Merchant, Liquidity, Fees, FX, Settlement, Reserves.  </li> <li>Ledger consumes events (accepted, settled, returned) and applies posting rules.  </li> </ul>"},{"location":"00-overview/architecture-decisions/ADR-0002-double-entry-ledger/#consequences","title":"Consequences","text":"<ul> <li>Strong audit trail. No hidden state.  </li> <li>Easy reconciliation with external statements.  </li> <li>Slightly more complex reversal flows (explicit contra postings).  </li> <li>Storage grows unbounded (mitigated with archiving, partitioning).  </li> </ul>"},{"location":"00-overview/architecture-decisions/ADR-0002-double-entry-ledger/#alternatives-considered","title":"Alternatives Considered","text":"<ul> <li>Single-entry balances updated in place \u2192 rejected (non-auditable, error-prone).  </li> <li>Event-sourcing without explicit double-entry \u2192 rejected (money truth must be explicit).  </li> </ul> <p>Next Steps: - Define posting rules in <code>20-specs/posting-rules.md</code>. - Provide Go lib for posting validation (debits == credits).  </p>"},{"location":"00-overview/architecture-decisions/ADR-0003-contracts-first/","title":"ADR-0003: Contracts-First via storo-specs Repo","text":"<p>Status: Accepted Date: 2025-08-26</p>"},{"location":"00-overview/architecture-decisions/ADR-0003-contracts-first/#context","title":"Context","text":"<p>Multiple services (CTS, gateways, ledger, compliance) need to interoperate. To avoid coupling and drift, we must define shared contracts (events, APIs) in a single source of truth.</p> <p>Moov\u2019s practice and our nucleus design both point to contract-first development.  </p>"},{"location":"00-overview/architecture-decisions/ADR-0003-contracts-first/#decision","title":"Decision","text":"<p>We establish a dedicated repo: storo-specs. It will contain:</p> <ul> <li>Event Schemas (JSON Schema) for all domain events.  </li> <li>API Definitions (OpenAPI/Swagger) for HTTP APIs (e.g., CTS).  </li> <li>Golden Fixtures (JSON) for canonical test cases.  </li> <li>Codegen scripts to publish:  </li> <li>Go structs/validators \u2192 <code>github.com/storo/specs-go</code> </li> <li>TS types/clients \u2192 <code>@storo/specs</code> (npm)</li> </ul> <p>Services must pin to tagged releases of <code>storo-specs</code> and validate at CI.  </p>"},{"location":"00-overview/architecture-decisions/ADR-0003-contracts-first/#consequences","title":"Consequences","text":"<ul> <li>Ensures consistency: all services emit/consume the same event shapes.  </li> <li>Enables language-agnostic clients (Go + TS at minimum).  </li> <li>Introduces one more repo to manage.  </li> <li>Requires discipline around versioning and compatibility (semver).  </li> </ul>"},{"location":"00-overview/architecture-decisions/ADR-0003-contracts-first/#alternatives-considered","title":"Alternatives Considered","text":"<ul> <li>Duplicating schemas in each repo \u2192 rejected (guaranteed drift).  </li> <li>Informal \u201cREADME spec\u201d \u2192 rejected (non-machine-verifiable).  </li> </ul> <p>Next Steps: - Scaffold <code>storo-specs</code> with <code>events/</code>, <code>api/</code>, <code>fixtures/</code>. - Add CI to validate schemas + generate Go/TS packages. - Update service templates to import from <code>storo-specs</code>.  </p>"},{"location":"10-components/canonical-transfer-service/","title":"Canonical transfer service","text":""},{"location":"10-components/canonical-transfer-service/#canonical-transfer-service-cts-system-design-document","title":"Canonical Transfer Service (CTS) \u2014 System Design Document","text":"<p>The Canonical Transfer Service (CTS) is the front door and conductor of Stalela. It provides a single API for creating and managing transfers, normalizes requests into a canonical format, enforces idempotency, screens entities, routes transfers, and emits domain events.</p>"},{"location":"10-components/canonical-transfer-service/#1-introduction","title":"1. Introduction","text":"<ul> <li>Purpose: Define an actionable, auditable, and operable System Design for CTS.</li> <li>Scope: CTS handles submission and tracking of transfers; it does not execute rail-specific protocols directly, compute ledger postings, or perform KYC\u2014those are delegated to Gateways, Ledger, and Compliance.</li> <li>Audience: Backend engineers, SRE/Platform, Security/Compliance, Product.</li> </ul>"},{"location":"10-components/canonical-transfer-service/#2-background-context","title":"2. Background &amp; Context","text":"<ul> <li>Multi-tenant, regulated data, event-driven architecture with transactional outbox and eventual consistency for downstream consumers.</li> <li>CTS upstream: clients/integrators. Downstream: Compliance, Directory &amp; Routing, Rail Gateways, Ledger (via events), Observability stack.</li> </ul> <p>Mermaid Context (C4 Level 1) <pre><code>graph TD\n  subgraph Clients\n    A[Client Apps / Integrators]\n  end\n\n  subgraph Stalela Core\n    B[CTS API]\n    C[Compliance Service]\n    D[Directory &amp; Routing]\n    E[Rail Gateways]\n    F[Ledger Service]\n    G[(OLTP DB)]\n    H[[Event Bus]]\n    I[[Observability: Metrics/Logs/Tracing]]\n  end\n\n  A -- HTTPS sync --&gt; B\n  B -- screen sync --&gt; C\n  B -- route sync --&gt; D\n  B -- persist sync --&gt; G\n  B -- events async --&gt; H\n  H -- accepted/settled async --&gt; B\n  H -- postings async --&gt; F\n  B -- telemetry --&gt; I</code></pre></p> <p>Assumptions/Constraints - Eventual consistency for downstream consumers; synchronous path returns latest known state. - Per-tenant authentication and authorization. - Exactly-once event publishing via transactional outbox. - PII encrypted at rest; PII exclusion in logs.</p>"},{"location":"10-components/canonical-transfer-service/#3-functional-requirements","title":"3. Functional Requirements","text":"<ul> <li>Accept API requests: <code>POST /transfers</code>, <code>GET /transfers</code>, <code>GET /transfers/:id</code>.</li> <li>Deduplicate via idempotency key + request body hash.</li> <li>Validate and normalize into canonical schema.</li> <li>Pre-screen entities with Compliance.</li> <li>Route via Directory &amp; Routing.</li> <li>Persist transfers and lifecycle state.</li> <li>Emit events: <code>transfers.initiated</code>, <code>transfers.submitted.&lt;rail&gt;</code> and consume <code>accepted/settled/returned/failed</code>.</li> </ul> <p>API contracts (summary)</p> Method Path Required Headers Success Notes POST /transfers Authorization, Idempotency-Key, X-Canonical-Version 201 with resource or 200 on idempotent replay Request validated against canonical model GET /transfers/:id Authorization 200 Returns transfer details + timeline <p>Canonical Request (excerpt) <pre><code>{\n  \"tenantId\": \"tnt_123\",\n  \"intent\": \"PUSH\",\n  \"amount\": { \"value\": \"100.00\", \"currency\": \"USD\" },\n  \"sourceCurrency\": \"USD\",\n  \"targetCurrency\": \"USD\",\n  \"fxStrategy\": \"NOT_APPLICABLE\",\n  \"payer\": { \"type\": \"WALLET\", \"id\": \"payer-abc\" },\n  \"payee\": { \"type\": \"BANK\", \"id\": \"payee-xyz\" },\n  \"railHints\": [\"usdc-algo\"],\n  \"feeModel\": \"STORO_STANDARD\",\n  \"endUserRef\": \"end-user-55\",\n  \"externalRef\": \"client-789\",\n  \"metadata\": { \"purpose\": \"invoice-42\" },\n  \"traceparent\": \"00-4bf92f3577b34da6a3ce929d0e0e4736-00f067aa0ba902b7-00\"\n}\n</code></pre></p>"},{"location":"10-components/canonical-transfer-service/#4-non-functional-requirements","title":"4. Non-Functional Requirements","text":"<p>Prod targets</p> Category Target Notes Performance Total p99 \u2264 2.5s; ingress\u2192screen (\u2264800ms), screen\u2192route (\u2264400ms), route\u2192submit (\u22641.5s) Timeouts enforced per integration Availability 99.95% monthly SLO; error budget 21.6m/mo Excludes third-party outages beyond retry budget Throughput Baseline 200 TPS; burst 1,000 TPS (5 min) HPA + queue smoothing Scalability Horizontal scale by stateless API; partition by tenantId/transferId Stickiness not required Security &amp; Privacy OAuth2 client-cred or HMAC per tenant; TLS 1.2+; PII encrypted at rest Logs redact PII Reliability Idempotency (36h TTL); transactional outbox with retries; DLQ Exactly-once publish semantics Compliance/Audit Immutable events; correlation IDs; retention \u2265 7 years (configurable) WORM storage optional <p>Pilot targets (20 merchants, 100 tx/merchant/day \u2248 2k/day)</p> Category Target Notes Performance p95 \u2264 2.5s at \u2264 10 TPS burst Serverless/Lambda timeouts sized accordingly Availability 99.9% monthly SLO Single-region acceptable for pilot Throughput \u2248 0.023 TPS avg (2k/day); bursts \u2264 10 TPS Sized for lunchtime peaks"},{"location":"10-components/canonical-transfer-service/#5-architecture-design","title":"5. Architecture &amp; Design","text":"<p>5.1 Container (C4 Level 2) <pre><code>graph TD\n  subgraph CTS\n    API[API Layer / Web]\n    CMD[Command Orchestrator]\n    NORM[Canonical Normalizer]\n    COMP[Compliance Adapter]\n    ROUTE[Routing Adapter]\n    SUB[Submission Publisher]\n    STATE[State Manager]\n    OUTBOX[Outbox Worker]\n    READ[Read Model / Projections]\n    DB[(OLTP DB)]\n  end\n\n  BUS[[Event Bus]]\n  OBS[[Metrics/Logs/Tracing]]\n  GW[Rail Gateways]\n  CMP[Compliance]\n  DIR[Directory &amp; Routing]\n\n  API --&gt; CMD\n  CMD --&gt; NORM\n  CMD --&gt; COMP\n  CMD --&gt; ROUTE\n  CMD --&gt; STATE\n  STATE --&gt; DB\n  SUB --&gt; OUTBOX\n  OUTBOX --&gt; BUS\n  BUS --&gt; STATE\n  API --&gt; READ\n  READ --&gt; DB\n\n  COMP --- CMP\n  ROUTE --- DIR\n  SUB --- GW\n\n  API -. telemetry .-&gt; OBS\n  OUTBOX -. telemetry .-&gt; OBS</code></pre></p> <p>Sync vs Async and Backpressure - Sync: API\u2192Compliance, API\u2192Directory, DB writes. - Async: Outbox\u2192Event Bus\u2192Gateways; inbound events\u2192STATE. - Backpressure: rate limiting at API, bounded outbox worker concurrency, consumer lag alerts.</p> <p>Amount precision and rounding - Store monetary values as <code>NUMERIC(20,8)</code>; define per-currency scale (e.g., USD scale=2). - Rounding mode: bankers rounding (round half to even) when converting to rail decimals. - Validate min/max per currency; reject out-of-range with 400.</p> <p>End-user considerations (double/triple entry) - Each merchant transfer often involves an end user (payer). Model end-user references (<code>endUserRef</code>) in the canonical payload where applicable. - For accounting that affects multiple ledgers (merchant wallet, end-user wallet, fees/taxes), ensure events carry sufficient references to support downstream double/triple-entry postings in the Ledger service. - CTS remains canon/orchestrator and does not compute postings, but must not drop identifiers necessary for downstream accounting integrity.</p> <p>5.2 Component (C4 Level 3) \u2014 Inside CTS <pre><code>graph TD\n  subgraph API Layer\n    R[Request Validation]\n    I[Idempotency Middleware]\n    Q[Rate Limiter]\n  end\n  subgraph Orchestration\n    SAGA[Command Orchestrator Saga]\n    MAP[Canonical Model Normalizer]\n  end\n  subgraph Integrations\n    CBA[Compliance Client CB/Retry]\n    DRC[Directory Client Cache]\n    PUB[Submission Publisher]\n  end\n  subgraph Persistence\n    SM[State Machine]\n    OB[Outbox Table]\n    RM[Read Projections]\n  end\n\n  Q --&gt; I --&gt; R --&gt; SAGA --&gt; MAP\n  SAGA --&gt; CBA\n  SAGA --&gt; DRC\n  SAGA --&gt; SM\n  SM --&gt; OB\n  PUB --&gt; OB\n  RM --&gt; SM\n</code></pre></p> <p>5.3 Sequence Diagrams</p> <p>Happy Path (USDC) \u2014 non-blocking settlement <pre><code>sequenceDiagram\n  autonumber\n  participant Client\n  participant API as CTS/API\n  participant Cmp as Compliance\n  participant Dir as Directory\n  participant DB as CTS/DB\n  participant OB as OutboxWorker\n  participant Bus as EventBus\n  participant GW as Gateway(USDC)\n\n  Client-&gt;&gt;API: POST /transfers {Idempotency-Key, Authorization}\n  API-&gt;&gt;API: validate + canonicalize (hash, X-Canonical-Version)\n  API-&gt;&gt;Cmp: screen(payer,payee) [timeout 800ms, 2x retry]\n  Cmp--&gt;&gt;API: allow\n  API-&gt;&gt;Dir: route(intent, payee) [timeout 400ms]\n  Dir--&gt;&gt;API: rail=usdc, endpoint\n  API-&gt;&gt;DB: begin tx\n  DB--&gt;&gt;API: insert transfer(state=SUBMITTED)\n  DB--&gt;&gt;API: insert outbox(event=submitted.usdc)\n  API--&gt;&gt;DB: commit\n  API--&gt;&gt;Client: 201 Location:/transfers/:id {transferId, state: SUBMITTED, requestId}\n  OB-&gt;&gt;Bus: publish events.transfers.submitted.usdc (exp backoff)\n  Bus--&gt;&gt;GW: deliver\n  GW--&gt;&gt;Bus: events.transfers.accepted\n  Bus--&gt;&gt;API: accepted \u2192 update state\n  GW--&gt;&gt;Bus: events.transfers.settled\n  Bus--&gt;&gt;API: settled \u2192 update projections\n</code></pre></p> <p>Duplicate Submission <pre><code>sequenceDiagram\n  participant Client\n  participant API as CTS/API\n  participant DB as CTS/DB\n  Client-&gt;&gt;API: POST /transfers {Idempotency-Key}\n  API-&gt;&gt;DB: lookup (tenantId, Idempotency-Key, bodyHash)\n  alt match\n    DB--&gt;&gt;API: existing transferId (same hash)\n    API--&gt;&gt;Client: 200 existing resource (etag/version)\n  else conflict\n    DB--&gt;&gt;API: key exists with different hash\n    API--&gt;&gt;Client: 409 IdempotencyConflict { priorTransferId, priorBodyHash }\n  end</code></pre></p> <p>Compliance Deny <pre><code>sequenceDiagram\n  participant Client\n  participant API as CTS/API\n  participant Cmp as Compliance\n  Client-&gt;&gt;API: POST /transfers\n  API-&gt;&gt;Cmp: screen\n  Cmp--&gt;&gt;API: deny(reasonCode)\n  API--&gt;&gt;Client: 422 EntityDenied {reasonCode, requestId}</code></pre></p> <p>Routing Unavailable <pre><code>sequenceDiagram\n  participant Client\n  participant API as CTS/API\n  participant Dir as Directory\n  Client-&gt;&gt;API: POST /transfers\n  API-&gt;&gt;Dir: route\n  note over API,Dir: timeout 400ms, no fallback\n  API--&gt;&gt;Client: 502 RoutingUnavailable {retryAfter: 5s}</code></pre></p> <ul> <li>When Directory reports a closed settlement window (e.g., EFT cutoff), propagate <code>retryAfter</code> aligned with the next open window. Clients must back off until that timestamp; CTS logs the incident for analytics.</li> </ul> <p>Outbox Retry &amp; DLQ <pre><code>sequenceDiagram\n  participant OB as OutboxWorker\n  participant Bus as EventBus\n  OB-&gt;&gt;Bus: publish\n  alt failure\n    OB-&gt;&gt;OB: attempts++ backoff(1s\u21925s\u219230s\u21922m\u219210m\u21921h\u21922h\u21924h\u21928h\u219216h)\n  else success\n    OB-&gt;&gt;OB: mark SENT\n  end\n  note over OB: DLQ after N=10 attempts (poison)</code></pre></p> <p>5.4 State Machine <pre><code>stateDiagram-v2\n  [*] --&gt; INITIATED\n  INITIATED --&gt; SUBMITTED: route ok + persisted\n  SUBMITTED --&gt; ACCEPTED: events.transfers.accepted\n  ACCEPTED --&gt; SETTLED: events.transfers.settled\n  ACCEPTED --&gt; RETURNED: events.transfers.returned\n  SUBMITTED --&gt; FAILED: submission failed (non-retryable)\n  INITIATED --&gt; FAILED: validation/compliance deny\n  SETTLED --&gt; [*]\n  RETURNED --&gt; [*]\n  FAILED --&gt; [*]</code></pre></p> <p>5.5 Data Flow <pre><code>flowchart LR\n  Ingress[HTTP Ingress] --&gt; Validate[Validate/Normalize]\n  Validate --&gt; Persist[Persist Write Model]\n  Persist --&gt; Outbox[Write Outbox]\n  Outbox --&gt; Bus[Event Bus]\n  Bus --&gt; Proj[Read Model Projections]\n Proj --&gt; API[List &amp; Detail Reads]</code></pre></p> <p>Read-model list semantics - Backed by a denormalized <code>transfer_summaries</code> projection populated from lifecycle events and command writes. - Cursor pagination uses <code>(tenantId, createdAt DESC, transferId)</code> encoded inside <code>pageToken</code> to avoid skipping rows during concurrent inserts. - Filters: <code>state[]</code>, <code>intent[]</code>, <code>rail[]</code>, <code>fxStrategy[]</code>, <code>createdAtFrom/To</code>, <code>updatedAtFrom/To</code>, <code>externalRef</code>, <code>endUserRef</code>; default window capped to 90 days of hot storage. - Response omits encrypted payer/payee blobs; only stable references (<code>payerRef</code>, <code>payeeRef</code>) and operational metadata are exposed. - Consistency: eventual\u2014projections catch up within seconds; POST/GET-by-id remain the authoritative source immediately after writes. - Authorization and throttling enforced per-tenant; list endpoint has stricter rate limits to protect OLTP workloads.</p> <p>5.6 Deployment View <pre><code>graph TD\n  subgraph k8s-cluster\n    apiPod[cts-api Deployment]\n    obPod[cts-outbox Worker]\n    sidecar[otel sidecar]\n  end\n  hpa[HPA policy: target 70% CPU/qps]\n  db[(Primary/Replica OLTP DB)]\n  topics[[SNS FIFO Topic: events.transfers.fifo]]\n  secrets[[Secrets Manager]]\n  envoy[[Envoy/Ingress]]\n\n  envoy --&gt; apiPod\n  apiPod --&gt; db\n  obPod --&gt; db\n  apiPod --&gt; topics\n  obPod --&gt; topics\n  apiPod --&gt; sidecar\n  obPod --&gt; sidecar\n  apiPod --&gt; secrets\n  obPod --&gt; secrets\n  hpa -.-&gt; apiPod\n  hpa -.-&gt; obPod\n</code></pre></p> <p>5.7 Key Design Topics (ADR-style)</p> Topic Decision Alternatives Rationale Consequences Idempotency <code>Idempotency-Key</code> + SHA256(normalized body) unique per tenant; TTL 36h Key-only; body-only Prevents divergent bodies on same key; aligns with retention window Store hash; shard hot tenants Outbox Pattern Same-DB transactional outbox; ordered per <code>transferId</code>; backoff 1s\u21925s\u219230s\u21922m\u219210m\u21921h\u21922h\u21924h\u21928h\u219216h; DLQ at 10 Dedicated streaming bus (Kafka) Simpler atomicity; avoids dual-write Worker lag can grow \u2192 monitor/autoscale Routing AI-assisted dynamic policies + cache TTL 5m; negative cache 45s; deterministic fallback library Longer TTL Real-time optimization with safe degradation paths Requires continuous model evaluation Multitenancy Row-level scope by <code>tenantId</code>; per-tenant quotas; per-tenant secrets DB schemas per tenant Simpler ops; shared pool Strong tenancy guard required Schema Evolution Canonical SemVer; <code>X-Canonical-Version</code>; events <code>envelope.v</code> (BACKWARD) Ad-hoc Predictable upgrades Maintain registry and migrations Consistency Non-blocking settlement; POST 201/200 with <code>state=SUBMITTED</code> + Location Synchronous settlement Lower latency; simpler SLAs Clients must poll/subscribe Concurrency (OCC) <code>transfers.version</code> BIGINT; <code>WHERE transferId AND version</code>; bump version Pessimistic locks Avoids locks; suits serverless 409s/retries on conflicts Observability W3C traceparent; metrics by <code>tenantId</code>,<code>rail</code>,<code>state</code>; PII-safe logs None Traceability and SLOs Watch label cardinality Backpressure Token-bucket per tenant; bounded workers; circuit breakers Unlimited Protects core systems Graceful shedding under load Error Taxonomy 4xx (validation/deny), 409 (idempotency/OCC), 429 (rate limits), 5xx (internal/502 routing) Loose mapping Clear client behavior Easier debugging and SLAs"},{"location":"10-components/canonical-transfer-service/#intelligent-orchestration-engine","title":"Intelligent Orchestration Engine","text":"<p>Stalela CTS now supports programmable orchestration logic that can dynamically evaluate, score, and select optimal payment rails based on:</p> <ul> <li>Settlement speed</li> <li>Total transaction cost (incl. FX, intermediary fees)</li> <li>Identity compliance score</li> <li>Rail health status</li> <li>User preferences and behavioral context</li> </ul> <p>This decisioning is powered by embedded AI agents, which operate as pluggable functions in the orchestration pipeline.</p>"},{"location":"10-components/canonical-transfer-service/#integration-model","title":"Integration Model","text":"<pre><code>flowchart TD\n    Intent[Payment Intent] --&gt; CTS\n    CTS --&gt; AI_Route\n    AI_Route --&gt; Directory\n    Directory --&gt; Routing\n    Routing --&gt; Transfer</code></pre>"},{"location":"10-components/canonical-transfer-service/#routing-policies","title":"Routing Policies","text":"<p>CTS now accepts dynamic policy input with weights for tradeoffs:</p> <pre><code>{\n  \"policy\": {\n    \"optimize_for\": \"speed\",\n    \"fallbacks\": [\"cost\", \"reliability\"],\n    \"compliance_tier\": \"auto\",\n    \"preferred_methods\": [\"mobile_money\", \"voucher\"],\n    \"excluded_rails\": [\"card\"]\n  }\n}\n</code></pre> <p>These policies are interpreted by the orchestration engine to determine the best route for a given payment context.</p>"},{"location":"10-components/canonical-transfer-service/#ai-agent-insights","title":"\ud83d\udcca AI Agent Insights","text":"<p>Each transfer can now expose why a rail was chosen, which path was tried, and fallback behavior:</p> <pre><code>{\n  \"transfer_id\": \"abc123\",\n  \"selected_path\": \"MoMo \u2192 Voucher\",\n  \"score\": 87.2,\n  \"reason\": \"Cheapest + acceptable speed under fallback policy\",\n  \"fallback_used\": true\n}\n</code></pre> <p>This data is accessible via the Orchestration Analytics API.</p>"},{"location":"10-components/canonical-transfer-service/#backwards-compatibility","title":"\u2699\ufe0f Backwards Compatibility","text":"<p>The orchestration engine is backwards-compatible with static configurations.</p> <p>If no dynamic policy is provided, the routing logic falls back to static Directory rules with preset fallbacks.</p>"},{"location":"10-components/canonical-transfer-service/#6-data-model","title":"6. Data Model","text":"<p>Tables</p>"},{"location":"10-components/canonical-transfer-service/#transfers","title":"Transfers","text":"Column Type Nullable Notes transferId UUID no PK tenantId TEXT no partition key payer JSONB no PII encrypted-at-rest payee JSONB no PII encrypted-at-rest amount_value NUMERIC(20,8) no amount_currency CHAR(3) no ISO-4217 or pseudo source_currency CHAR(3) yes defaults to amount currency target_currency CHAR(3) yes set for FX conversions fx_strategy TEXT yes NOT_APPLICABLE | QUOTE_AT_SUBMIT | PASS_THROUGH rail TEXT no e.g., usdc, zimswitch intent TEXT no AUTH externalRef TEXT yes client reference feeModel TEXT yes tariff applied to calculate fees endUserRef TEXT yes downstream end-user correlation state TEXT no INITIATED createdAt TIMESTAMP WITH TZ no updatedAt TIMESTAMP WITH TZ no version BIGINT no optimistic locking counter (default 0) <p>Indexes/Constraints - PK: <code>(transferId)</code> - IDX: <code>(tenantId, createdAt)</code> - Unique: <code>(tenantId, externalRef)</code> nullable unique</p>"},{"location":"10-components/canonical-transfer-service/#transfer-events","title":"Transfer Events","text":"Column Type Nullable Notes eventId UUID no PK transferId UUID no FK \u2192 transfers type TEXT no initiated/submitted/accepted/... payload JSONB no envelope v=1 occurredAt TIMESTAMP WITH TZ no event time <p>Indexes - PK: <code>(eventId)</code> - IDX: <code>(transferId, occurredAt)</code> - Unique: <code>(transferId, type)</code> for lifecycle uniqueness</p>"},{"location":"10-components/canonical-transfer-service/#transfer-summaries-read-model","title":"Transfer Summaries (Read Model)","text":"Column Type Nullable Notes tenantId TEXT no partition key transferId UUID no PK with tenant state TEXT no latest lifecycle state intent TEXT no AUTH|CAPTURE|PUSH|PULL rail TEXT no routed rail amount_value NUMERIC(20,8) no denormalized from transfer amount_currency CHAR(3) no source_currency CHAR(3) yes target_currency CHAR(3) yes fx_strategy TEXT yes externalRef TEXT yes endUserRef TEXT yes payerRef TEXT yes stable reference only payeeRef TEXT yes stable reference only version BIGINT no mirrors write model version createdAt TIMESTAMP WITH TZ no for cursor pagination updatedAt TIMESTAMP WITH TZ no latestEventType TEXT yes audit of final lifecycle event latestEventAt TIMESTAMP WITH TZ yes <p>Indexes - PK: <code>(tenantId, transferId)</code> - IDX: <code>(tenantId, createdAt DESC, transferId)</code> for cursor pagination - IDX: <code>(tenantId, state, createdAt DESC, transferId)</code> for backlog filtering - IDX: <code>(tenantId, externalRef)</code> partial on non-null</p>"},{"location":"10-components/canonical-transfer-service/#outbox-transfers","title":"Outbox Transfers","text":"Column Type Nullable Notes id UUID no PK eventType TEXT no e.g., transfers.submitted.usdc payload JSONB no event data state TEXT no PENDING attempts INT no default 0 lastError TEXT yes latest error createdAt TIMESTAMP WITH TZ no updatedAt TIMESTAMP WITH TZ no <p>Indexes - IDX: <code>(state, createdAt)</code> - IDX: <code>(eventType)</code></p>"},{"location":"10-components/canonical-transfer-service/#idempotency","title":"Idempotency","text":"Column Type Nullable Notes tenantId TEXT no idempotencyKey TEXT no bodyHash CHAR(64) no sha256 transferId UUID no createdAt TIMESTAMP WITH TZ no TTL policy \u2265 36h <p>Indexes - Unique: <code>(tenantId, idempotencyKey, bodyHash)</code></p>"},{"location":"10-components/canonical-transfer-service/#routing-cache-optional","title":"Routing Cache (optional)","text":"Column Type Nullable Notes key TEXT no hashed routing tuple value JSONB no route details expiresAt TIMESTAMP WITH TZ no ttl <p>Sample Rows (illustrative) <pre><code>{\n  \"transfers\": [\n    {\"transferId\":\"a1b2\",\"tenantId\":\"t1\",\"amount_value\":\"100.00\",\"amount_currency\":\"USD\",\"rail\":\"usdc\",\"intent\":\"PUSH\",\"state\":\"SUBMITTED\"}\n  ],\n  \"outbox_transfers\": [\n    {\"id\":\"o1\",\"eventType\":\"transfers.submitted.usdc\",\"state\":\"PENDING\",\"attempts\":0}\n  ]\n}\n</code></pre></p> <p>Retention - <code>idempotency</code>: TTL 36h (GC job) - <code>transfer_events</code>: hot in OLTP 90 days; archive to object store thereafter - <code>outbox_transfers</code>: keep SENT 7 days; FAILED until resolved</p> <p>Indexes and constraints (additions)</p> <ul> <li> <p>Idempotency <pre><code>CREATE UNIQUE INDEX ux_idempotency\n  ON idempotency(tenantId, idempotencyKey, bodyHash);\n-- Optional partial unique within 36h window\nCREATE UNIQUE INDEX ux_idempotency_window\n  ON idempotency(tenantId, idempotencyKey, bodyHash)\n  WHERE createdAt &gt; now() - interval '36 hours';\n</code></pre></p> </li> <li> <p>ExternalRef <pre><code>CREATE UNIQUE INDEX ux_transfers_externalref\n  ON transfers(tenantId, externalRef)\n  WHERE externalRef IS NOT NULL;\n\n-- Optionally include intent to reduce collisions\nCREATE UNIQUE INDEX ux_transfers_externalref_intent\n  ON transfers(tenantId, intent, externalRef)\n  WHERE externalRef IS NOT NULL;\n</code></pre></p> </li> <li> <p>Events uniqueness <pre><code>CREATE UNIQUE INDEX ux_events_lifecycle\n  ON transfer_events(transferId, type);\n-- If a rail can emit multiple of the same type\nCREATE UNIQUE INDEX ux_events_seq\n  ON transfer_events(transferId, type, seq);\n</code></pre></p> </li> <li> <p>Optimistic locking <pre><code>-- Column already defined: version BIGINT NOT NULL DEFAULT 0\n-- Guarded update example\nUPDATE transfers\nSET state = $1, version = version + 1, updatedAt = now()\nWHERE transferId = $2 AND version = $3;\n</code></pre> Behavior: return 409/Retry on no-row-updated for external callers; internal workers retry with jitter/backoff.</p> </li> </ul>"},{"location":"10-components/canonical-transfer-service/#7-interfaces-contracts","title":"7. Interfaces &amp; Contracts","text":"<p>HTTP APIs</p> <p>POST /transfers <pre><code>POST /transfers HTTP/1.1\nAuthorization: Bearer &lt;token&gt;\nIdempotency-Key: 6f1e2...\nX-Canonical-Version: 1\nContent-Type: application/json\n</code></pre> Request <pre><code>{\n  \"tenantId\":\"t1\",\n  \"intent\":\"PUSH\",\n  \"amount\":{\"value\":\"100.00\",\"currency\":\"USD\"},\n  \"payer\":{\"type\":\"WALLET\",\"id\":\"payer-1\"},\n  \"payee\":{\"type\":\"WALLET\",\"id\":\"payee-9\"},\n  \"externalRef\":\"inv-42\"\n}\n</code></pre> Responses <pre><code>// 201 Created (first time)\n{\"transferId\":\"a1b2\",\"state\":\"SUBMITTED\",\"rail\":\"usdc\"}\n</code></pre> <pre><code>// 200 OK (duplicate)\n{\"transferId\":\"a1b2\",\"state\":\"SUBMITTED\",\"rail\":\"usdc\"}\n</code></pre> <pre><code>// 409 IdempotencyConflict (same key, different body)\n{\"code\":\"IdempotencyConflict\",\"priorTransferId\":\"a1b2\",\"priorBodyHash\":\"sha256:...\"}\n</code></pre> Errors <pre><code>// 422 EntityDenied\n{\"code\":\"EntityDenied\",\"reason\":\"watchlist_hit\",\"requestId\":\"r-123\"}\n</code></pre> <pre><code>// 502 RoutingUnavailable\n{\"code\":\"RoutingUnavailable\",\"retryAfter\":\"5s\"}\n</code></pre></p> <p>Decision tree (POST /transfers)</p> <ol> <li>Validate request (schema, authZ)</li> <li>On failure: 400/401/403</li> <li>Idempotency lookup</li> <li>Key+hash match: 200 (return existing resource)</li> <li>Key exists, hash differs: 409 IdempotencyConflict</li> <li>Compliance screening</li> <li>Deny: 422 EntityDenied</li> <li>Routing</li> <li>Timeout/5xx: 502 RoutingUnavailable</li> <li>Persist write model + outbox (single DB tx)</li> <li>Success: 201 Created with <code>Location: /transfers/:id</code> and <code>state=SUBMITTED</code></li> <li>Concurrency (optimistic lock)</li> <li>External mutating APIs: 409 Conflict</li> <li>Internal workers: retry with jitter/backoff</li> </ol> <p>GET /transfers/:id <pre><code>GET /transfers/a1b2 HTTP/1.1\nAuthorization: Bearer &lt;token&gt;\n</code></pre> Response <pre><code>{\n  \"transferId\":\"a1b2\",\n  \"state\":\"SETTLED\",\n  \"timeline\":[\n    {\"type\":\"initiated\",\"at\":\"2025-01-01T10:00:00Z\"},\n    {\"type\":\"submitted.usdc\",\"at\":\"2025-01-01T10:00:01Z\"},\n    {\"type\":\"accepted\",\"at\":\"2025-01-01T10:00:02Z\"},\n    {\"type\":\"settled\",\"at\":\"2025-01-01T10:03:00Z\"}\n  ]\n}\n</code></pre></p> <p>Event Contracts <pre><code>{\n  \"envelope\": {\n    \"v\": 1,\n    \"eventId\": \"uuid\",\n    \"occurredAt\": \"ts\",\n    \"tenantId\": \"t1\",\n    \"transferId\": \"a1b2\",\n    \"type\": \"transfers.submitted.usdc\",\n    \"traceparent\": \"00-...\"\n  },\n  \"payload\": { \"amount\": {\"value\":\"100.00\",\"currency\":\"USD\"}, \"payer\": {\"id\":\"...\"}, \"payee\": {\"id\":\"...\"} }\n}\n</code></pre> Canonicalization and body hash</p> <p>Algorithm (v1): - Normalize JSON per canonical schema version. - Trim strings; lowercase ISO currency codes; normalize country/phone formats. - Sort object keys lexicographically; arrays kept in submitted order unless schema defines ordering. - Amounts: parse to decimal, scale to currency decimals (see Amount precision), serialize as string. - Serialize with no insignificant whitespace. - Compute <code>bodyHash = sha256(serialized)</code> and store with idempotency record.</p> <p>Sample vector: <pre><code>// input\n{\"amount\":{\"value\":\"100.0\",\"currency\":\"usd\"},\"payer\":{\"id\":\" A \"}}\n// normalized\n{\"amount\":{\"value\":\"100.00\",\"currency\":\"USD\"},\"payer\":{\"id\":\"A\"}}\n// sha256\n\"b0b6...\"\n</code></pre> Topics - <code>events.transfers.initiated</code> - <code>events.transfers.submitted.&lt;rail&gt;</code> (e.g., <code>events.transfers.submitted.usdc</code>) - Inbound: <code>events.transfers.accepted|settled|returned|failed</code></p> <p>Ordering and dedupe - For SNS/SQS FIFO: <code>MessageGroupId = transferId</code> to guarantee per-transfer ordering; <code>MessageDeduplicationId = eventId</code>. - Consumers must dedupe by <code>eventId</code> and <code>(transferId,type)</code> to handle retries/replays.</p> <p>Timeouts/SLAs | Integration | Timeout | Retry | SLA | |---|---|---|---| | Compliance | 800ms | 2 with jitter | 99.9% | | Directory | 400ms | 1 with jitter | 99.9% | | Gateway Publish | async | backoff 1s..1h | N/A |</p> <p>Tenant isolation &amp; quotas - Per-tenant token-bucket rate limits (defaults: 50 rps burst, 5 rps sustained for pilot). - Authorization scopes restrict access to <code>tenantId</code>; all queries filter by <code>tenantId</code>. - Quota override process via config store with change audit.</p> <p>Threat model (mini) - IDOR on GET <code>/transfers/:id</code> \u2192 enforce tenant scope; verify <code>tenantId</code> ownership per row. - Replay with stolen <code>Idempotency-Key</code> \u2192 pair key with bodyHash and TTL; require Authorization; optionally sign requests (HMAC). - Message tampering on bus \u2192 server-side signing/envelope checksum; least-privilege topics; DLQ visibility restricted.</p> <p>PII strategy - Events carry <code>payer_ref</code>/<code>payee_ref</code> only; PII stored in encrypted columns/tables (KMS key rotation annually). - POPIA/GDPR: support erasure by tombstoning PII fields while preserving event integrity (refs remain).</p> <p>Schema registry &amp; compatibility - Event envelope and payloads registered in Schema Registry; policy BACKWARD for events. - Breaking-change process: bump <code>envelope.v</code>, dual-publish during migration window, communicate to consumers.</p> <p>Replay &amp; re-drive - Controlled replay from outbox or archived events; idempotent updates ensured by <code>(transferId,type)</code> uniqueness. - Time-boxed replays with audit log entries for who/when/why. - Requires dual approval (engineering + compliance/ops) before marking events for re-drive; store signed reason alongside the <code>SENT</code> transition.</p>"},{"location":"10-components/canonical-transfer-service/#8-operational-considerations","title":"8. Operational Considerations","text":"<ul> <li>Deployment: Blue/Green or Canary via ingress weights; feature flags for risky paths.</li> <li>Config: Environment + central config store; secret rotation via Secrets Manager.</li> <li>Runbooks (expanded)</li> <li>High Latency: check <code>compliance_client_latency_p95</code>, <code>directory_client_latency_p95</code>, DB CPU/IO, thread pools.</li> <li>Stuck SUBMITTED: inspect outbox lag, worker health, DLQ; reprocess by id.</li> <li>Idempotency Collisions: audit client keys, compare bodyHash mismatches.</li> <li>Alerts</li> <li><code>rate(cts_outbox_failures_total[5m]) / rate(cts_outbox_attempts_total[5m]) &gt; 0.001 for 5m</code></li> <li><code>histogram_quantile(0.95, sum(rate(http_server_duration_seconds_bucket{route=\"/transfers\"}[5m])) by (le)) &gt; 1.5</code></li> <li><code>cts_consumer_lag{topic=\"events.transfers.*\"} &gt; 5000 for 10m</code></li> <li><code>rate(http_5xx_total[5m]) &gt; 0.01</code></li> <li>SLO burn alerts: 2% budget burn over 1h, 5% over 6h for availability/latency SLOs</li> <li>Capacity</li> <li>Scale API by QPS and p95 latency; scale workers by outbox depth and publish rate; 1 partition per expected 50 TPS.</li> </ul> <p>Migrations - Tooling: Flyway or Liquibase. - Zero-downtime: expand (add nullable columns/indexes) \u2192 dual-write if needed \u2192 backfill \u2192 contract. - Rollback: feature-flag writes; maintain backward compatible reads; revert via migrations down.</p> <p>Runbooks (deepening) - Poison message: locate <code>eventId</code>, inspect <code>lastError</code>, retry N with backoff, if still failing park to DLQ and open ticket; optional manual mark-SENT with dual approval and signed reason attached to the record. - Hot tenant: reduce tenant-specific rate limit, shard outbox processing by <code>tenantId</code>, notify tenant of temporary caps.</p>"},{"location":"10-components/canonical-transfer-service/#9-testing-strategy","title":"9. Testing Strategy","text":"<ul> <li>Unit: canonical normalizer (trimming, casing, currency scale table), bodyHash calculator vectors, idempotency repository, error mapper, routing cache TTL math.</li> <li>Contract: Pact for Compliance <code>/screen</code> and Directory <code>/route</code> clients; JSON Schema validation on emitted events (<code>canonical.transfer.v1</code>).</li> <li>Integration: Testcontainers Postgres 15 + LocalStack SNS/SQS FIFO; fake Compliance/Directory services with latency/deny toggles; verify outbox backoff ladder + DLQ placement after 10 attempts.</li> <li>E2E:</li> <li>Happy path USDC submit \u2192 gateway ack \u2192 settlement event.</li> <li>Duplicate submission returns <code>200</code> replay.</li> <li>Idempotency conflict (same key, different hash) \u2192 <code>409</code>.</li> <li>Compliance deny \u2192 <code>422</code> with reason.</li> <li>Directory window closed \u2192 <code>502</code> with accurate <code>retryAfter</code>.</li> <li>Outbox DLQ + dual-approval re-drive flow.</li> <li>Chaos: inject DB failover, SNS publish failure (&gt;3 attempts), Directory latency spikes; assert no unscreened submit escapes.</li> <li>Load: 200 TPS synthetic traffic (90% POST, 10% GET) with 1% duplicates; target POST p95 &lt; 1.5s and zero lost events.</li> </ul>"},{"location":"10-components/canonical-transfer-service/#10-risks-trade-offs-and-open-questions","title":"10. Risks, Trade-offs, and Open Questions","text":"<ul> <li>Outbox saturation \u2192 publish lag; mitigate via autoscale and partitioning.</li> <li>Routing flaps \u2192 increased 5xx; mitigate with negative caching and backoff.</li> <li>Tenant spikes \u2192 noisy neighbor; enforce per-tenant rate limits.</li> <li>Schema drift \u2192 consumer breakage; enforce versioning and schema registry.</li> </ul> <p>Open questions and decisions are summarized at the end.</p>"},{"location":"10-components/canonical-transfer-service/#11-appendix","title":"11. Appendix","text":"<ul> <li>Glossary: CTS (Canonical Transfer Service), OLTP, DLQ, SAGA, RPO/RTO.</li> <li>References: <code>docs/00-overview/architecture-decisions/ADR-0001-events-outbox.md</code>, <code>docs/20-specs/api-canonical-transfer.md</code>, <code>docs/30-diagrams/lifecycle-state.md</code>.</li> </ul>"},{"location":"10-components/canonical-transfer-service/#12-pilot-requirements-aws-serverless-option","title":"12. Pilot Requirements &amp; AWS Serverless Option","text":"<p>Pilot scope and sizing (20 merchants) - Volume: 100 transfers/merchant/day \u2192 ~2,000 transfers/day (avg ~0.023 TPS), anticipate bursts during business hours (assume 5\u201310 TPS peaks for 10\u201330 minutes). - Reliability: \u2265 99% transfers reach terminal state with complete event trail. - Latency: p95 \u2264 2.5s end-to-end for submit; p99 \u2264 4s under burst. - Cost: minimize infra cost; prefer pay-per-use; keep auditability and outbox guarantees.</p> <p>Derived sizing (pilot) - Outbound events/transfer: ~3\u20134 typical \u2192 \u2264 8,000 events/day. - Storage growth (pilot): Transfers \u2264 2k rows/day, Events \u2264 8k rows/day; negligible for 90-day hot retention. - Network: &lt;&lt; 1 Mbps steady; minimal.</p> <p>Serverless deployment (AWS) \u2014 Pilot option <pre><code>graph TD\n  Client[Clients/POS] --&gt; APIGW[API Gateway]\n  APIGW --&gt; LAPI[Lambda: CTS API]\n\n  subgraph \"Data Store (choose one)\"\n    RDS[\"RDS Proxy \u2192 Aurora Serverless v2 (PostgreSQL)\"]\n    DDB[\"DynamoDB Tables\"]\n  end\n\n  LAPI --&gt;|Option A| RDS\n  LAPI --&gt;|Option B| DDB\n\n  subgraph \"Outbox + Events\"\n    SQS[\"SQS Outbox Queue\"]\n    DDBS[\"DynamoDB Streams\"]\n    LPUB[\"Lambda: Outbox Publisher\"]\n    EBus[\"SNS FIFO Topic events.transfers\"]\n    SQSC1[\"SQS FIFO Consumer (Gateway)\"]\n    SQSC2[\"SQS FIFO Consumer (Ledger)\"]\n  end\n\n  RDS --&gt; SQS\n  DDB --&gt; DDBS\n  DDBS --&gt; LPUB\n  LPUB --&gt; EBus\n  EBus --&gt; SQSC1\n  EBus --&gt; SQSC2\n  SQSC1 --&gt; RDS\n  SQSC2 --&gt; DDB\n\n  subgraph \"Ops\"\n    SM[\"Secrets Manager\"]\n    CW[\"CloudWatch Logs/Metrics/Alarms\"]\n    XR[\"X-Ray Tracing\"]\n  end\n\n  LAPI -.-&gt; SM\n  LAPI -.-&gt; CW\n  LAPI -.-&gt; XR\n  LPUB -.-&gt; CW\n  LCONS -.-&gt; CW\n</code></pre></p> <p>Data store options and recommendation</p> Option Infra How it maps to SDD Pros Cons Pilot recommendation A. Aurora Serverless v2 + RDS Proxy API Gateway + Lambda + RDS Proxy + Aurora Pg Keeps OLTP DB and transactional outbox exactly as designed (same-DB tx). Minimal code changes; strong ACID; SQL familiarity; easy path to prod scale. Aurora min ACU cost even when idle; Lambda needs RDS Proxy to avoid connection storms. Selected for pilot. B. DynamoDB + Streams + EventBridge API Gateway + Lambda + DynamoDB Use conditional writes for idempotency; store transfer and event items; publish via Streams\u2192Lambda; dedupe at consumers. Pay-per-use; very low cost at 1k tx/day; scales automatically; no connections. Outbox shifts to at-least-once via Streams; must implement idempotent publisher and consumer dedupe; relational queries harder. Viable low-cost alternative if we accept at-least-once with dedupe and keep schema simple. C. EC2 or Lightsail + Postgres Nginx + app on EC2/Lightsail + Postgres Traditional deployment; identical semantics to SDD. Simple mental model; predictable performance; cheapest if always-on and tiny. Ops overhead (patching, scaling); less elastic; need HA for SLOs. Acceptable for a throwaway pilot; less aligned with serverless strategy. <p>Notes on Option B (DynamoDB) - Idempotency: <code>PutItem</code> with <code>ConditionExpression attribute_not_exists(pk)</code> using <code>(tenantId, idempotencyKey, bodyHash)</code> item; TTL attribute for GC. - Transfers/events: single-table design with <code>PK=TRANSFER#&lt;transferId&gt;</code>, <code>SK=STATE#...</code> and <code>SK=EVENT#...</code>; <code>transfer_events</code> uniqueness via <code>ConditionExpression</code> on <code>(transferId,type)</code>. - Outbox: write event items; use DynamoDB Streams to trigger publisher Lambda; publisher writes to EventBridge; consumers dedupe by <code>eventId</code> and <code>(transferId,type)</code>. - Read model: <code>GET /transfers/:id</code> via <code>Query PK=TRANSFER#...</code> ordered by <code>SK</code>.</p> <p>Cost posture (directional, not a quote) - Requests/day ~2k \u2192 API Gateway/Lambda costs are negligible; DynamoDB RU/WU minimal at pilot scale; Aurora Serverless has a small baseline cost due to min ACUs; EC2/Lightsail cheapest if always-on but adds ops overhead.</p> <p>Recommendation for pilot - Selected: Option A (Aurora Serverless v2 + RDS Proxy). Keep the SDD\u2019s OLTP schema and transactional outbox as-is. - Option B remains a fallback if costs require further reduction; keep abstraction boundaries to allow future swap.</p> <p>Pilot deployment (selected Option A) <pre><code>flowchart LR\n  Client --&gt; APIGW[API Gateway]\n  APIGW --&gt; LAPI[Lambda CTS API]\n  LAPI --&gt; RDS[(Aurora Serverless v2 via RDS Proxy)]\n  LAPI --&gt; CW[CloudWatch/X-Ray]\n  subgraph Outbox\n    LWORK[Lambda Outbox Worker]\n    EBus[EventBridge events.transfers.*]\n  end\n  RDS &lt;-- poll PENDING --&gt; LWORK\n  LWORK --&gt; EBus</code></pre></p> <p>Pilot configuration (Option A) - Aurora Serverless v2 PostgreSQL 15; min ACU 0.5\u20131, max ACU 4; Multi-AZ on. - RDS Proxy for Lambda connections; IAM auth or Secrets Manager rotation (90 days). - Outbox Worker Lambda: runs on a 15\u201330s schedule; batch size 500; exponential backoff; idempotent publish to EventBridge (partition key <code>transferId</code>). - VPC: Lambdas in private subnets with NAT; security groups restrict DB access. - Observability: CloudWatch metrics/logs, X-Ray traces; alarms per SLOs. - Migrations: Flyway/Liquibase executed via CI job before deploy.</p>"},{"location":"10-components/canonical-transfer-service/#authoritative-input-spec","title":"Authoritative Input Spec","text":"<p>As provided. Preserved verbatim for traceability.</p> <pre><code>[BEGIN INPUT SPEC]\n# Canonical Transfer Service (CTS)\n\nThe **Canonical Transfer Service (CTS)** is the **front door and conductor** of Stalela.  \nIt provides a single API for creating and managing transfers, normalizes requests into a canonical format, enforces idempotency, screens entities, routes transfers, and emits domain events.\n\n---\n\n## \ud83c\udfaf Purpose\n\n- Provide a **unified API** for all transfers (payments, payouts, pushes, pulls).  \n- Normalize requests into a **canonical model** independent of rail quirks.  \n- Act as the **orchestrator** for transfer lifecycle events.  \n- Enforce **idempotency** across client submissions.  \n- Ensure **compliance screening** before any transfer reaches a rail.  \n- Emit **domain events** (`transfers.*`) so all state changes are visible and auditable.  \n\n---\n\n## \ud83d\udee0 Responsibilities\n\n- **Accept API requests** (`POST /transfers`, `GET /transfers/:id`).  \n- **Deduplicate** requests using idempotency keys and hashes.  \n- **Validate and normalize** inputs into the canonical transfer schema.  \n- **Pre-screen** payer and payee using the Compliance service.  \n- **Route** transfers through the Directory &amp; Routing service.  \n- **Emit events** (`initiated`, `submitted.&lt;rail&gt;`) via the outbox.  \n- **Track lifecycle state** for each transfer.  \n\n---\n\n## \ud83d\udd0c Interfaces\n\n### API Endpoints\n- `POST /transfers`  \n  - Create a new transfer.  \n  - Requires `Idempotency-Key` header.  \n  - Body: canonical transfer schema.  \n\n- `GET /transfers/:id`  \n  - Fetch transfer details including timeline of events.  \n\n&gt; See Specs: [../20-specs/api-canonical-transfer.md](../20-specs/api-canonical-transfer.md)\n\n### Event Topics\n- Emits (envelope `v=1`):\n  - `transfers.initiated`\n  - `transfers.submitted.&lt;rail&gt;`\n- Consumes:\n  - `transfers.accepted`\n  - `transfers.settled`\n  - `transfers.returned`\n  - `transfers.failed`\n\n---\n\n### Admin Endpoints (via Platform/Base)\n- `GET /live`, `GET /ready`, `GET /metrics`, `GET /version` provided by Platform/Base and adopted by CTS.\n\n\n## \ud83d\uddc4 Data Model\n\n**Table: `transfers`**  \n- `transferId` (PK)  \n- `tenantId`  \n- `payer`, `payee` (JSON)  \n- `amount { value, currency }`  \n- `rail`  \n- `intent` (AUTH | CAPTURE | PUSH | PULL)  \n- `externalRef`  \n- `state` (INITIATED, SUBMITTED, \u2026)  \n- `createdAt`, `updatedAt`  \n\n**Table: `transfer_events`**  \n- `eventId`  \n- `transferId` (FK)  \n- `type`  \n- `payload` (JSON)  \n- `occurredAt`  \n\n**Table: `outbox_transfers`**  \n- Standard outbox pattern for exactly-once event publishing.  \n  - Columns: `id`, `eventType`, `payload`, `state` (PENDING|SENT|FAILED), `createdAt`, `attempts`, `lastError?`\n\n---\n\n## \ud83d\udcd0 Diagram\n\n### Sequence: Happy Path (USDC transfer)\n\n```mermaid\nsequenceDiagram\n  participant Client\n  participant CTS as Canonical Transfer Service\n  participant CS as Compliance\n  participant DR as Directory\n  participant GW as Rail Gateway (USDC)\n\n  Client-&gt;&gt;CTS: POST /transfers (idempotency-key)\n  CTS-&gt;&gt;CTS: Deduplicate &amp; normalize\n  CTS-&gt;&gt;CS: Pre-screen payer/payee\n  CS--&gt;&gt;CTS: Allow\n  CTS-&gt;&gt;DR: Lookup route\n  DR--&gt;&gt;CTS: Rail endpoint\n  CTS-&gt;&gt;CTS: Persist transfer, state=SUBMITTED\n  CTS-&gt;&gt;GW: Event transfers.submitted.usdc\n  GW--&gt;&gt;CTS: Event transfers.accepted\n  GW--&gt;&gt;CTS: Event transfers.settled\n  CTS-&gt;&gt;Client: 200 OK { state: SETTLED }\n</code></pre>"},{"location":"10-components/canonical-transfer-service/#state-machine","title":"\ud83d\udd04 State Machine","text":"<p>See transfer lifecycle diagram: ../30-diagrams/lifecycle-state.md</p>"},{"location":"10-components/canonical-transfer-service/#failure-modes-retries","title":"\ud83d\udea8 Failure Modes &amp; Retries","text":"<ul> <li>Duplicate submission \u2192 return existing transfer (idempotent).  </li> <li>Compliance = deny \u2192 return 422 EntityDenied.  </li> <li>Directory lookup fails \u2192 return 502 RoutingUnavailable.  </li> <li>Rail submission fails \u2192 state = FAILED, event emitted.  </li> <li>Outbox publish failure \u2192 retry with exponential backoff.  </li> <li>Consumers must dedupe by <code>eventId</code> (and <code>(transferId,type)</code> uniqueness for lifecycle).  </li> </ul>"},{"location":"10-components/canonical-transfer-service/#observability","title":"\ud83d\udcca Observability","text":"<p>Metrics - API latency (p95, p99). - Idempotency collision rate. - Compliance check latency. - Transfers by state (submitted, settled, returned).  </p> <p>Logs - Structured JSON with transferId, tenantId, eventId.  </p> <p>Tracing - Propagate request IDs through to gateways and ledger.  </p>"},{"location":"10-components/canonical-transfer-service/#security","title":"\ud83d\udd10 Security","text":"<ul> <li>API authentication with tenant-level keys/tokens.  </li> <li>All PII (payer/payee) encrypted at rest.  </li> <li>Access to transfer data restricted by tenant scope.  </li> <li>Logs redact sensitive fields (names, IDs, PANs).  </li> </ul>"},{"location":"10-components/canonical-transfer-service/#runbooks","title":"\ud83d\udcd8 Runbooks","text":"<ul> <li>If API latency spikes \u2192 check compliance and directory service dependencies.  </li> <li>If transfers stuck in SUBMITTED \u2192 inspect gateway outbox and retry queue.  </li> <li>If idempotency collisions increase \u2192 confirm client integration is using stable Idempotency-Key.  </li> <li>If compliance service is unreachable \u2192 all submissions should fail-safe (no unscreened transfers). [END INPUT SPEC] ```</li> </ul>"},{"location":"10-components/canonical-transfer-service/#open-questions-next-decisions","title":"Open Questions &amp; Next Decisions","text":"<ul> <li>[ ] Finalize SNS/SQS FIFO IaC and naming conventions for pilot.</li> <li>[ ] Confirm Compliance sign-off on retention durations (events/logs).</li> <li>[ ] Define per-currency min/max and fee fields for all pilot currencies.</li> <li>[ ] Approve tenant default quotas and the override approval process.</li> <li>[ ] Validate canonicalization test vectors with integrators.</li> <li>[ ] Decide archive format and encryption for long-term event storage.</li> <li>[ ] Confirm Directory <code>route.updated</code> event shape and cache key.</li> <li>[ ] Choose replay authorization workflow and audit approvals.</li> <li>[ ] Set trace sampling defaults per environment (dev/stage/prod).</li> </ul>"},{"location":"10-components/canonical-transfer-service/#next-iteration-plan-2-weeks","title":"Next Iteration Plan (2 weeks)","text":"<ul> <li>Week 1</li> <li>Engineers: A (API/Idempotency), B (Outbox/Worker), C (Integrations)</li> <li>Tasks: Scaffold service; implement POST/GET; idempotency table; outbox write; basic publish; compliance+directory clients with timeouts; metrics+tracing.</li> <li>Exit criteria: POST happy path to mock services; events visible on test topic; p95 &lt; 500ms without external calls.</li> <li>Week 2</li> <li>Engineers: A (State/Projections), B (DLQ/Backoff), C (Load/Chaos)</li> <li>Tasks: State updates from inbound events; projections for GET; backoff+DLQ; rate limiting; alert rules; load tests at 200 TPS; chaos tests.</li> <li>Exit criteria: All sequences pass in CI; alerts in place; docs updated; demo end-to-end flow.</li> </ul>"},{"location":"10-components/canonical-transfer-service/#decisions-ready-to-adopt","title":"Decisions (ready to adopt)","text":"<p>1) Canonical schema ownership &amp; versioning cadence - Decision: Platform/Architecture owns the canonical schema; changes via Schema Working Group. - Versioning: SemVer on canonical model; header <code>X-Canonical-Version</code> and <code>envelope.v</code>. - Cadence: Minor every 2 weeks as needed; Major with quarterly planning. - Mechanics: JSON Schema in <code>schemas/canonical-transfer/v{n}</code>; RFC + contract tests.</p> <p>2) Per-tenant quotas &amp; default limits - Decision: Token-bucket per tenant at API gateway + app layer. - Defaults: Write 2 TPS sustained (burst 20 for 60s); Read 10 TPS sustained (burst 50 for 60s); Daily cap 10k transfers/tenant. - Behavior: 429 with Retry-After when exhausted; emit <code>quota.exceeded</code>.</p> <p>3) DB technology &amp; JSONB usage - Decision: Aurora PostgreSQL v2 with JSONB for payer/payee and envelopes; relational columns for hot filters. - Indexes: <code>(tenantId, createdAt)</code>, PK <code>(transferId)</code>, partial unique <code>(tenantId, idempotencyKey, bodyHash)</code> for 36h window; GIN only when needed.</p> <p>4) Event bus &amp; partition strategy - Decision: SNS FIFO with SQS FIFO subscribers; <code>MessageGroupId=transferId</code>, <code>MessageDeduplicationId=eventId</code>.</p> <p>5) Envelope schema registry &amp; tooling - Decision: Git-based JSON Schema registry under <code>schemas/</code> with CI validation.</p> <p>6) Settlement sync response policy - Decision: Never return SETTLED synchronously; first response 201/200 with <code>state=SUBMITTED</code>.</p> <p>7) DLQ storage &amp; triage workflow - Decision: Outbox publisher DLQ \u2192 SQS standard (14 days); consumer DLQs per SQS FIFO; re-drive Lambda with idempotency.</p> <p>8) Retention durations (pending Compliance) - Defaults: Events 7y (WORM after 90d), Transfers 2y hot then Glacier Deep Archive, Idempotency 36h, Logs 30d, Metrics 15m.</p> <p>9) Directory cache invalidation hooks - Decision: Directory publishes <code>directory.route.updated</code>; CTS invalidates/pre-warms cache.</p> <p>10) Trace sampling rate &amp; PII redaction - Decision: Head-based sampling (10% default; 100% for 5xx or p95 breaches); PII allowlist in logs/traces.</p>"},{"location":"10-components/canonical-transfer-service/#implementation-map-whowhatwhen","title":"Implementation map (who/what/when)","text":"Item Owner Artifacts Exit Criteria Schema governance Platform Lead ADR-001, <code>schemas/canonical-transfer/</code> CI rejects non-compliant events; schema published Quotas &amp; limits API Eng gateway config + middleware 429s with Retry-After; per-tenant metrics Aurora Pg + JSONB DB Eng ADR-003, migrations Tables + indexes live; RDS Proxy wired; load test passes SNS/SQS FIFO bus Platform Eng ADR-004, IaC Topic + queues live; ordering verified JSON schema registry App Eng ADR-005, CI rules All events validated in CI + prod (shadow) Async-only settlement App Eng ADR-006, API docs POST always returns SUBMITTED DLQ &amp; re-drive SRE ADR-007, runbooks, Lambda Re-drive tool works; alarms wired Retention policy Compliance + SRE ADR-008, lifecycle rules Glacier policies in place; PII separation verified Route invalidation Directory + App Eng ADR-009 Cache flushes on update event; TTLs enforced Tracing + redaction SRE ADR-010, log filters 10% sampling, error boost, PII allowlist verified"},{"location":"10-components/compliance-screening/","title":"Compliance Screening Service","text":"<p>The Compliance Screening Service protects Stalela by screening entities (payer, payee) against sanctions and risk lists before transfers are submitted to rails. It ensures fast, local allow/deny decisions and continuous re-screening as lists update.</p>"},{"location":"10-components/compliance-screening/#purpose","title":"\ud83c\udfaf Purpose","text":"<ul> <li>Enforce pre-submit screening of entities against sanctions lists.  </li> <li>Perform delta re-screens when lists update.  </li> <li>Cache results for performance.  </li> <li>Emit entity flagged events for operator review.  </li> <li>Provide a simple, auditable <code>/screen</code> API.</li> </ul>"},{"location":"10-components/compliance-screening/#responsibilities","title":"\ud83d\udee0 Responsibilities","text":"<ul> <li>Ingest official sanctions/watchlists (OFAC, UN, EU, SA FIC).  </li> <li>Normalize and index names, aliases, DOBs, countries.  </li> <li>Provide low-latency API for CTS screening.  </li> <li>Emit alerts when existing entities match new list entries.  </li> <li>Store results with versioned list references for audit.</li> </ul> <p>Local sources: SA PEPs/adverse media (vendor feeds), ZW FIU advisories; define update SLAs and checksum validation.</p>"},{"location":"10-components/compliance-screening/#interfaces","title":"\ud83d\udd0c Interfaces","text":""},{"location":"10-components/compliance-screening/#http","title":"HTTP","text":"<ul> <li><code>POST /screen</code></li> <li>body: <code>{ name, dob?, country?, idNumber? }</code></li> <li>returns: <code>{ action: allow|deny, score, matches[], listVersion }</code></li> </ul>"},{"location":"10-components/compliance-screening/#events-emit","title":"Events (emit)","text":"<ul> <li><code>compliance.entity.flagged</code></li> <li><code>{ entityId, transferId?, score, listVersion, matches[] }</code></li> </ul>"},{"location":"10-components/compliance-screening/#admin","title":"Admin","text":"<ul> <li><code>GET /live</code>, <code>GET /ready</code>, <code>GET /metrics</code>, <code>GET /version</code></li> </ul>"},{"location":"10-components/compliance-screening/#data-model","title":"\ud83d\uddc4 Data Model","text":"<ul> <li><code>lists_raw</code> (source files)  </li> <li><code>lists_index</code> (normalized searchable index)  </li> <li><code>entity_screenings</code> (entityId, transferId, result, listVersion, createdAt)  </li> <li><code>outbox_compliance</code> </li> </ul>"},{"location":"10-components/compliance-screening/#sequence","title":"\ud83d\udcd0 Sequence","text":"<pre><code>sequenceDiagram\n  participant CTS\n  participant CS as Compliance Service\n  participant LIST as Sanctions Lists\n\n  CTS-&gt;&gt;CS: POST /screen (payer, payee)\n  CS-&gt;&gt;LIST: query local index\n  LIST--&gt;&gt;CS: result { score, matches }\n  CS--&gt;&gt;CTS: { action: allow }</code></pre>"},{"location":"10-components/compliance-screening/#failure-modes","title":"\ud83d\udea8 Failure Modes","text":"<ul> <li>List download failed \u2192 keep prior index, raise alert.  </li> <li>Timeout \u2192 CTS fails safe (deny).  </li> <li>False positive \u2192 escalate via Operator Console.  </li> <li>Stale index \u2192 emit compliance.service.stale event.</li> </ul>"},{"location":"10-components/compliance-screening/#observability","title":"\ud83d\udcca Observability","text":"<ul> <li>Metrics: screening latency, match rate, stale index age.  </li> <li>Logs: structured with entityId, listVersion.  </li> <li>Alerts on stale index &gt; 24h.</li> </ul>"},{"location":"10-components/compliance-screening/#security","title":"\ud83d\udd10 Security","text":"<ul> <li>Encrypt raw list data at rest.  </li> <li>PII redaction in logs.  </li> <li>Access control to screening API by internal services only.</li> </ul>"},{"location":"10-components/compliance-screening/#runbooks","title":"\ud83e\udded Runbooks","text":"<ul> <li>New list version failed ingest \u2192 re-run job manually, validate checksums.  </li> <li>High false positives \u2192 adjust fuzzy matching thresholds, add alias list.  </li> <li>Operator override \u2192 freeze/unfreeze entity in Operator Console.</li> </ul>"},{"location":"10-components/directory-routing/","title":"Directory &amp; Routing Service","text":"<p>The Directory &amp; Routing Service is Stalela\u2019s authoritative source of rails metadata. It ensures transfers are routed deterministically to the correct rail endpoints, institutions, and fee structures.</p>"},{"location":"10-components/directory-routing/#purpose","title":"\ud83c\udfaf Purpose","text":"<ul> <li>Maintain authoritative directory of institutions, BINs, fees, settlement windows.  </li> <li>Provide fast lookups for CTS routing decisions.  </li> <li>Refresh data periodically from external sources.  </li> <li>Support effective-dated changes (versioning).</li> </ul>"},{"location":"10-components/directory-routing/#responsibilities","title":"\ud83d\udee0 Responsibilities","text":"<ul> <li>Store and expose institution metadata.  </li> <li>Expose routing lookups (<code>/routes?bin=...</code>) for CTS.  </li> <li>Apply per-rail/per-tenant fees and cutoffs.  </li> <li>Circuit-breaker fallback to cached versions.  </li> <li>Version data for audit and rollback.  </li> <li>Maintain ZA bank codes and PayShap proxy rules (cell/email/id) for resolution.  </li> <li>Publish settlement calendars (ZA/ZW) and cutoffs for consumers.</li> </ul>"},{"location":"10-components/directory-routing/#interfaces","title":"\ud83d\udd0c Interfaces","text":""},{"location":"10-components/directory-routing/#http","title":"HTTP","text":"<ul> <li><code>GET /routes?bin|memberId|rail=...</code>   \u2192 <code>{ endpoint, fees, settlementWindow, constraints }</code></li> </ul> <p>Examples:</p> <p><code>GET /routes?bin=438742</code> <pre><code>{\n  \"endpoint\": \"https://api.processor.example/payments\",\n  \"fees\": { \"type\": \"percentage\", \"value\": 0.02 },\n  \"settlementWindow\": { \"cutoff\": \"16:30\", \"timezone\": \"Africa/Johannesburg\" },\n  \"constraints\": { \"currencies\": [\"ZAR\",\"USD\"], \"limitsMinor\": { \"max\": 10000000 } }\n}\n</code></pre></p> <ul> <li> <p><code>GET /institutions/:id</code>   \u2192 <code>{ id, name, rail, endpoint, fees, windows }</code></p> </li> <li> <p><code>GET /calendars/:region</code>   \u2192 <code>{ region: \"ZA\"|\"ZW\", holidays: [...], timezone }</code></p> </li> </ul> <p>Example: <pre><code>{\n  \"region\": \"ZA\",\n  \"timezone\": \"Africa/Johannesburg\",\n  \"holidays\": [\"2025-01-01\",\"2025-03-21\",\"2025-04-18\"]\n}\n</code></pre></p>"},{"location":"10-components/directory-routing/#events-emit","title":"Events (emit)","text":"<ul> <li><code>directory.version.updated</code> </li> <li><code>{ versionId, effectiveFrom, source, checksum }</code></li> </ul> <p>Example: <pre><code>{\n  \"eventId\": \"018f3e00-2222-7f00-b1e3-7a7f5d3b9b10\",\n  \"type\": \"directory.version.updated\",\n  \"v\": 1,\n  \"occurredAt\": \"2025-08-27T08:00:00Z\",\n  \"tenantId\": \"system\",\n  \"payload\": {\n    \"versionId\": \"dir_v2025-08-27_01\",\n    \"effectiveFrom\": \"2025-08-27T09:00:00+02:00\",\n    \"source\": \"bank-codes+fees-portal\",\n    \"checksum\": \"sha256:abcd...\"\n  }\n}\n</code></pre></p>"},{"location":"10-components/directory-routing/#admin-time-via-platformbase","title":"Admin &amp; Time (via Platform/Base)","text":"<ul> <li>Admin: <code>GET /live</code>, <code>GET /ready</code>, <code>GET /metrics</code>, <code>GET /version</code>.</li> <li>Time helpers: banking-day logic and cutoffs use Platform/Base calendars (<code>Africa/Johannesburg</code>, <code>Africa/Harare</code>).</li> </ul>"},{"location":"10-components/directory-routing/#data-model","title":"\ud83d\uddc4 Data Model","text":"<ul> <li><code>institutions</code> (id, name, rail, endpoint, status)  </li> <li><code>bins</code> (bin, institutionId, effectiveFrom/to)  </li> <li><code>fees</code> (tenantId, rail, feeType, value, effectiveFrom/to)  </li> <li><code>windows</code> (rail, cutoffTimes, timezone)  </li> <li><code>bank_codes</code> (ZA code, institutionId)  </li> <li><code>proxy_rules</code> (type, constraints, effectiveFrom/to)  </li> <li><code>calendars</code> (region, date, description)  </li> <li><code>directory_versions</code> </li> <li><code>outbox_directory</code> </li> </ul>"},{"location":"10-components/directory-routing/#sequence","title":"\ud83d\udcd0 Sequence","text":"<pre><code>sequenceDiagram\n  participant CTS\n  participant DR as Directory\n  participant EXT as External Source\n\n  CTS-&gt;&gt;DR: GET /routes?bin=438742\n  DR-&gt;&gt;DR: lookup BIN \u2192 institution \u2192 endpoint\n  DR--&gt;&gt;CTS: { endpoint, fees, window }\n  DR-&gt;&gt;EXT: scheduled refresh (daily)\n  EXT--&gt;&gt;DR: new version\n  DR--&gt;&gt;CTS: directory.version.updated</code></pre>"},{"location":"10-components/directory-routing/#failure-modes","title":"\ud83d\udea8 Failure Modes","text":"<ul> <li>Unknown BIN \u2192 return error <code>ROUTE_NOT_FOUND</code>.  </li> <li>Source unavailable \u2192 keep prior version, alert ops.  </li> <li>Fee mismatch \u2192 reconciliation alerts via Operator Console.</li> </ul>"},{"location":"10-components/directory-routing/#observability","title":"\ud83d\udcca Observability","text":"<ul> <li>Metrics: lookup latency, cache hit rate, version age.  </li> <li>Logs: institutionId, versionId.  </li> <li>Alerts: stale version &gt; SLA.</li> </ul>"},{"location":"10-components/directory-routing/#security","title":"\ud83d\udd10 Security","text":"<ul> <li>Access control: only CTS and gateways query directory.  </li> <li>Version artifacts signed and checksummed.</li> </ul>"},{"location":"10-components/directory-routing/#runbooks","title":"\ud83e\udded Runbooks","text":"<ul> <li>Stale directory \u2192 re-run refresh job.  </li> <li>Incorrect fee \u2192 override with effectiveFrom and patch ADR.  </li> <li>BIN not routing \u2192 add mapping, redeploy version.</li> </ul>"},{"location":"10-components/event-bus-outbox/","title":"Event Bus &amp; Outbox \u2014 How It Works (Exactly)","text":"<p>Target stack: Aurora PostgreSQL + RDS Proxy + SNS FIFO + SQS FIFO (Option A)</p>"},{"location":"10-components/event-bus-outbox/#the-contract","title":"The contract","text":"<ul> <li>Exactly-once at the producer boundary via a transactional outbox (state and event row committed together).</li> <li>At-least-once across the bus: consumers must be idempotent and dedupe (<code>eventId</code>, optionally domain keys).</li> </ul>"},{"location":"10-components/event-bus-outbox/#components-roles","title":"Components &amp; Roles","text":"<pre><code>flowchart LR\n  subgraph \"Producer Service (e.g., CTS)\"\n    A[\"Write Model / DB\"]\n    O[(\"Outbox Table\")]\n    D[\"Dispatcher Worker\"]\n  end\n\n  subgraph \"Bus (SNS FIFO + SQS FIFO)\"\n    T[[\"Topic: events.transfers (SNS FIFO)\"]]\n    Q1[[\"Queue: gateway.usdc (SQS FIFO)\"]]\n    Q2[[\"Queue: ledger.postings (SQS FIFO)\"]]\n    Q3[[\"Queue: projections.timeline (SQS FIFO)\"]]\n  end\n\n  subgraph \"Consumers\"\n    G[\"Gateway (USDC)\"]\n    L[\"Ledger Service\"]\n    P[\"Projection / Read Model\"]\n    I[(\"Inbox Table for Dedupe\")]\n  end\n\n  A --&gt; O\n  D --&gt; T\n  T --&gt; Q1 --&gt; G\n  T --&gt; Q2 --&gt; L\n  T --&gt; Q3 --&gt; P --&gt; I\n</code></pre>"},{"location":"10-components/event-bus-outbox/#happy-path-sequence","title":"Happy Path Sequence","text":"<pre><code>sequenceDiagram\n  autonumber\n  participant S as \"Producer (CTS/API)\"\n  participant DB as \"Aurora (state + outbox)\"\n  participant W as \"Dispatcher\"\n  participant SNS as \"SNS FIFO Topic\"\n  participant QG as \"SQS FIFO (gateway.usdc)\"\n  participant GW as \"Consumer (Gateway USDC)\"\n\n  S-&gt;&gt;DB: BEGIN \u2192 insert transfer + outbox(event=submitted.usdc) \u2192 COMMIT\n  Note over S,DB: State and event are now durable together\n  W-&gt;&gt;DB: select PENDING rows (FOR UPDATE SKIP LOCKED)\n  W-&gt;&gt;SNS: publish(event) {GroupId=transferId, DedupId=eventId}\n  W-&gt;&gt;DB: mark outbox row = SENT\n  SNS--&gt;&gt;QG: deliver copy\n  QG-&gt;&gt;GW: receive message\n  GW-&gt;&gt;GW: idempotency check (inbox by eventId)\n  GW-&gt;&gt;Rail: submit on USDC (side-effect)\n  GW--&gt;&gt;QG: delete/ack message\n  GW-&gt;&gt;SNS: emit events.transfers.accepted / settled (as producer)\n</code></pre> <p>Arrow semantics</p> <ul> <li>Solid arrows = synchronous calls (DB, publish, ack).</li> <li>Events flow via SNS/SQS FIFO; ordering per transfer enforced with <code>MessageGroupId = transferId</code>.</li> </ul>"},{"location":"10-components/event-bus-outbox/#data-shapes","title":"Data Shapes","text":""},{"location":"10-components/event-bus-outbox/#event-envelope","title":"Event envelope","text":"<pre><code>{\n  \"envelope\": {\n    \"v\": 1,\n    \"eventId\": \"uuid\",\n    \"occurredAt\": \"2025-08-26T10:15:01Z\",\n    \"tenantId\": \"tnt_123\",\n    \"traceparent\": \"00-...\",\n    \"type\": \"events.transfers.submitted.usdc\"\n  },\n  \"key\": { \"transferId\": \"tr_123\" },\n  \"payload\": {\n    \"amount\": {\"value\":\"100.00\",\"currency\":\"USD\"},\n    \"payer\": {\"type\":\"WALLET\",\"id\":\"payer-abc\"},\n    \"payee\": {\"type\":\"WALLET\",\"id\":\"0x...\"}\n  }\n}\n</code></pre> <p>Bus mapping: <code>MessageGroupId = key.transferId</code>, <code>MessageDeduplicationId = envelope.eventId</code>.</p>"},{"location":"10-components/event-bus-outbox/#outbox-table-producer-db","title":"Outbox table (producer DB)","text":"id eventType payload (JSONB) state attempts lastError next_attempt createdAt updatedAt uuid <code>events.transfers.submitted.usdc</code> <code>{envelope,key,payload}</code> PENDING/SENT/FAILED int text ts ts ts"},{"location":"10-components/event-bus-outbox/#inbox-table-consumer-db-optional","title":"Inbox table (consumer DB) \u2014 optional","text":"eventId (PK) processedAt uuid ts"},{"location":"10-components/event-bus-outbox/#failure-retry-semantics","title":"Failure &amp; Retry Semantics","text":""},{"location":"10-components/event-bus-outbox/#producerdispatcher","title":"Producer/Dispatcher","text":"<pre><code>sequenceDiagram\n  autonumber\n  participant W as \"Dispatcher\"\n  participant DB as \"Outbox\"\n  participant SNS as \"SNS\"\n\n  W-&gt;&gt;DB: fetch PENDING (batch)\n  W-&gt;&gt;SNS: publish\n  alt publish error\n    W-&gt;&gt;DB: attempts++ , state=PENDING , next_attempt = now + backoff\n  else attempts &gt;= RETRY_MAX\n    W-&gt;&gt;DB: state=FAILED , lastError\n  end\n</code></pre>"},{"location":"10-components/event-bus-outbox/#consumer","title":"Consumer","text":"<pre><code>flowchart LR\n  M[\"Message from SQS FIFO\"] --&gt; C{\"Seen before? (inbox by eventId)\"}\n  C -- \"Yes\" --&gt; A[\"Ack/Delete\"]\n  C -- \"No\" --&gt; H[\"Handle side-effect\"]\n  H --&gt; R{\"Success?\"}\n  R -- \"Yes\" --&gt; I[\"Insert inbox row\"] --&gt; A\n  R -- \"No\" --&gt; E[\"Throw / do not ack; SQS retries \u2192 DLQ\"]\n</code></pre>"},{"location":"10-components/event-bus-outbox/#exactly-once-boundary-responsibilities","title":"Exactly-once boundary &amp; responsibilities","text":"<ul> <li>Producer: guarantees each event is published once or fails visible (SENT/FAILED). No duplicates marked SENT.</li> <li>Bus: may deliver duplicates or retries (at-least-once).</li> <li>Consumer: must be idempotent; dedupe via inbox table (or idempotent upsert by domain key).</li> </ul>"},{"location":"10-components/event-bus-outbox/#how-other-components-use-it","title":"How other components use it","text":"<ol> <li>CTS \u2192 Gateway(USDC): Gateway subscribes to <code>gateway.usdc</code> queue, dedupes, submits to AVAX, then emits <code>accepted/settled</code>.</li> <li>Gateway \u2192 CTS: CTS inbound consumer updates transfer state and timeline.</li> <li>CTS \u2192 Ledger: Ledger subscribes; posts journal entries idempotently by <code>(transferId,type)</code>.</li> <li>CTS \u2192 Projections: updates read models for dashboards/webhooks.</li> <li>Directory \u2192 CTS: publishes <code>directory.route.updated</code>; CTS invalidates route cache.</li> </ol>"},{"location":"10-components/event-bus-outbox/#operational-defaults-adopt-now","title":"Operational defaults (adopt now)","text":"<ul> <li>Dispatcher: batch=50, concurrency=10; backoff: <code>1s,5s,30s,2m,10m,1h</code>; RETRY_MAX=10.</li> <li>SQS visibility timeout: \u2265 2\u00d7 handler p99.</li> <li>Alarms: <code>event_outbox_backlog</code>, <code>event_publish_lag_seconds</code>, <code>dead_letter_count</code>, <code>event_consumer_lag_seconds</code>.</li> </ul>"},{"location":"10-components/event-bus-outbox/#wire-test-localcloud-sanity-checks","title":"Wire Test (local/cloud sanity checks)","text":""},{"location":"10-components/event-bus-outbox/#1-sql-outbox-schema-seed","title":"1) SQL \u2014 Outbox schema &amp; seed","text":"<pre><code>CREATE TABLE IF NOT EXISTS outbox (\n  id uuid PRIMARY KEY,\n  eventType text NOT NULL,\n  payload jsonb NOT NULL,\n  state text NOT NULL DEFAULT 'PENDING',\n  attempts int NOT NULL DEFAULT 0,\n  lastError text,\n  next_attempt timestamptz NOT NULL DEFAULT now(),\n  createdAt timestamptz NOT NULL DEFAULT now(),\n  updatedAt timestamptz NOT NULL DEFAULT now()\n);\n\n-- Insert a fake submitted.usdc event\nINSERT INTO outbox (id, eventType, payload)\nVALUES (\n  gen_random_uuid(),\n  'events.transfers.submitted.usdc',\n  jsonb_build_object(\n    'envelope', jsonb_build_object('v',1,'eventId', gen_random_uuid()::text, 'occurredAt', now(), 'tenantId','tnt_demo','type','events.transfers.submitted.usdc'),\n    'key', jsonb_build_object('transferId','tr_test_123'),\n    'payload', jsonb_build_object('amount', jsonb_build_object('value','10.00','currency','USD'))\n  )\n);\n</code></pre>"},{"location":"10-components/event-bus-outbox/#2-aws-cli-bus-quick-setup-example","title":"2) AWS CLI \u2014 Bus quick setup (example)","text":"<pre><code># Create SNS FIFO topic\naws sns create-topic --name events.transfers.fifo --attributes FifoTopic=true,ContentBasedDeduplication=false\n\n# Create SQS FIFO queue for gateway\naws sqs create-queue --queue-name gateway.usdc.fifo \\\n  --attributes FifoQueue=true,ContentBasedDeduplication=false,VisibilityTimeout=60\n\n# Subscribe queue to topic\naws sns subscribe --topic-arn &lt;SNS_ARN&gt; --protocol sqs --notification-endpoint &lt;SQS_ARN&gt;\n\n# Allow SNS to publish to SQS (set queue policy accordingly)\n</code></pre>"},{"location":"10-components/event-bus-outbox/#3-dispatcher-mock-python","title":"3) Dispatcher mock (Python)","text":"<pre><code>import os, json, time, uuid, psycopg2, boto3\n\nSNS_ARN = os.environ['SNS_ARN']\nconn = psycopg2.connect(os.environ['PG_DSN'])\nsns = boto3.client('sns', region_name=os.environ.get('AWS_REGION','us-east-1'))\n\nBACKOFF = [1,5,30,120,600,3600]\n\nwhile True:\n    with conn, conn.cursor() as cur:\n        cur.execute(\"\"\"\n          SELECT id, payload\\n          FROM outbox\\n          WHERE state='PENDING' AND next_attempt &lt;= now()\\n          ORDER BY createdAt\\n          FOR UPDATE SKIP LOCKED\\n          LIMIT 50\n        \"\"\")\n        rows = cur.fetchall()\n        for oid, payload in rows:\n            env = payload['envelope']\n            key = payload['key']\n            try:\n                sns.publish(\n                  TopicArn=SNS_ARN,\n                  Message=json.dumps(payload),\n                  MessageGroupId=key['transferId'],\n                  MessageDeduplicationId=env['eventId']\n                )\n                cur.execute(\"UPDATE outbox SET state='SENT', attempts=attempts+1, updatedAt=now() WHERE id=%s\", (oid,))\n            except Exception as e:\n                cur.execute(\"\"\"\n                  UPDATE outbox\n                     SET attempts=attempts+1,\n                         lastError=%s,\n                         next_attempt=now() + make_interval(secs =&gt; %s),\n                         updatedAt=now(),\n                         state = CASE WHEN attempts &gt;= 10 THEN 'FAILED' ELSE 'PENDING' END\n                   WHERE id=%s\n                \"\"\", (str(e), BACKOFF[min(len(BACKOFF)-1, 0)], oid))\n    time.sleep(1)\n</code></pre>"},{"location":"10-components/event-bus-outbox/#4-consumer-mock-python","title":"4) Consumer mock (Python)","text":"<pre><code>import os, json, boto3, datetime\n\nsqs = boto3.client('sqs', region_name=os.environ.get('AWS_REGION','us-east-1'))\nQUEUE_URL = os.environ['QUEUE_URL']\n\nwhile True:\n    resp = sqs.receive_message(QueueUrl=QUEUE_URL, MaxNumberOfMessages=1, WaitTimeSeconds=10)\n    for m in resp.get('Messages', []):\n        body = json.loads(m['Body'])\n        payload = json.loads(body.get('Message', '{}'))\n        evt = payload.get('envelope', {})\n        print('Got event', evt.get('type'), evt.get('eventId'), datetime.datetime.utcnow().isoformat())\n        # TODO: dedupe check by eventId in inbox table\n        sqs.delete_message(QueueUrl=QUEUE_URL, ReceiptHandle=m['ReceiptHandle'])\n</code></pre> <p>These mocks are for wiring/visibility; production code should use a proper worker framework, metrics, and inbox dedupe.</p>"},{"location":"10-components/event-bus-outbox/#runbooks-condensed","title":"Runbooks (condensed)","text":"<ul> <li>Outbox backlog rising \u2192 check dispatcher logs; SNS/SQS publish errors; scale workers; review DLQ.</li> <li>Consumer lag rising \u2192 scale consumers; increase visibility timeout; profile handler.</li> <li>Duplicate effects \u2192 ensure inbox/dedupe; verify <code>MessageGroupId</code>/<code>DeduplicationId</code> mapping.</li> <li>FAILED outbox rows \u2192 fix cause; re-drive by <code>eventId</code> using admin tool.</li> </ul>"},{"location":"10-components/event-bus-outbox/#security-pii","title":"Security &amp; PII","text":"<ul> <li>Events contain IDs, not PII. Outbox payloads are encrypted at rest.</li> <li>IAM: producer can publish to the topic; consumers can read only their queues.</li> </ul>"},{"location":"10-components/ledger-service/","title":"Ledger Service","text":"<p>The Ledger Service is Stalela\u2019s book of record. It maintains double\u2011entry journals, computes balances, exposes statements, and guarantees that every money movement is represented by a balanced set of postings. If it isn\u2019t posted here, it didn\u2019t happen.</p>"},{"location":"10-components/ledger-service/#purpose","title":"\ud83c\udfaf Purpose","text":"<ul> <li>Enforce double\u2011entry accounting for all transfers across rails.  </li> <li>Provide authoritative balances and auditable journals.  </li> <li>Support authorization \u2192 capture \u2192 reversal/return lifecycles.  </li> <li>Handle multi\u2011currency with explicit FX conversion and P&amp;L.  </li> <li>Export partner statements (BAI2\u2011like) and support reconciliation.</li> </ul>"},{"location":"10-components/ledger-service/#responsibilities","title":"\ud83d\udee0 Responsibilities","text":"<ul> <li>Consume domain events and apply posting rules:</li> <li><code>transfers.accepted</code> (hold / memo postings where applicable)</li> <li><code>transfers.settled</code> (final postings)</li> <li><code>transfers.returned</code> (reversal postings)</li> <li>Maintain derived balances (by account, currency).  </li> <li>Emit <code>ledger.balance.updated</code> and <code>ledger.posting.created</code>.  </li> <li>Provide read APIs: balances, journals, statements.  </li> <li>Guard rails: append\u2011only journals; reversals via new entries only.</li> </ul>"},{"location":"10-components/ledger-service/#interfaces","title":"\ud83d\udd0c Interfaces","text":""},{"location":"10-components/ledger-service/#events-consume-envelope-v1","title":"Events (consume; envelope <code>v=1</code>)","text":"<ul> <li><code>transfers.accepted</code></li> <li><code>transfers.settled</code></li> <li><code>transfers.returned</code></li> </ul> <p>Dedupe per Events spec: see ../20-specs/events.md (consumer idempotency by <code>eventId</code>, lifecycle uniqueness for <code>(transferId,type)</code>).</p>"},{"location":"10-components/ledger-service/#events-emit-envelope-v1","title":"Events (emit; envelope <code>v=1</code>)","text":"<ul> <li><code>ledger.posting.created</code></li> <li><code>ledger.balance.updated</code></li> </ul>"},{"location":"10-components/ledger-service/#http-readonly","title":"HTTP (read\u2011only)","text":"<ul> <li><code>GET /balances?accountId=...&amp;currency=...</code></li> <li><code>GET /journal?transferId=...</code> or <code>?accountId=...&amp;from=...&amp;to=...</code></li> <li><code>GET /statements?accountId=...&amp;from=...&amp;to=...&amp;format=bai2|json</code></li> </ul>"},{"location":"10-components/ledger-service/#admin-via-platformbase","title":"Admin (via Platform/Base)","text":"<ul> <li><code>GET /live</code>, <code>GET /ready</code>, <code>GET /metrics</code>, <code>GET /version</code> provided by Platform/Base and adopted by Ledger.</li> </ul> <p>Write access is event\u2011driven only. Manual adjustments are rare and must go through the Operator Console using explicit adjustment events with approvals/audit.</p>"},{"location":"10-components/ledger-service/#data-model","title":"\ud83d\uddc4 Data Model","text":"<p>tables - <code>accounts</code>   - <code>accountId</code> (pk), <code>type</code> (USER|MERCHANT|LIQUIDITY|FEES|FX|SETTLEMENT|RESERVE|NOSTRO|VOSTRO), <code>tenantId?</code>, <code>currency?</code> (nullable if multi\u2011currency), <code>status</code>, <code>createdAt</code> - <code>journals</code> (immutable)   - <code>journalId</code> (pk), <code>transferId</code>, <code>eventType</code>, <code>occurredAt</code>, <code>memo</code>, <code>exchangeControlRef?</code> - <code>postings</code> (append\u2011only)   - <code>postingId</code> (pk), <code>journalId</code> (fk), <code>debitAccountId</code>, <code>creditAccountId</code>, <code>amountMinor</code>, <code>currency</code>, <code>memo</code> - <code>balances</code> (materialized)   - <code>accountId</code>, <code>currency</code>, <code>balanceMinor</code>, <code>asOf</code> - <code>outbox_ledger</code> \u2013 for emitted events</p> <p>blobs (encrypted) - optional statement snapshots; export artifacts</p>"},{"location":"10-components/ledger-service/#posting-rules-canonical","title":"\ud83e\uddee Posting Rules (canonical)","text":"<p>See: ../20-specs/posting-rules.md</p> <p>All amounts are in minor units (e.g., cents). Examples assume a customer pays a merchant 100.00 with a 1.00 fee.</p>"},{"location":"10-components/ledger-service/#1-accepted-authorization-hold-rails-that-support-authcapture","title":"1) Accepted (authorization / hold) \u2014 rails that support AUTH/CAPTURE","text":"<p>Create memo/hold journal (off\u2011balance or flagged): - Debit: <code>USER_AUTH_HOLD</code> (memo) \u2014 10000 - Credit: <code>LIQUIDITY_AUTH_PENDING</code> (memo) \u2014 10000</p> <p>If the rail has no auth concept (e.g., USDC push), no accepted postings are created.</p>"},{"location":"10-components/ledger-service/#2-settled-final-funds-move","title":"2) Settled (final funds move)","text":"<p>Core settlement postings: - Debit: <code>USER</code> \u2014 10000 - Credit: <code>MERCHANT</code> \u2014 9900 - Credit: <code>FEES</code> \u2014 100   (Stalela take rate)</p> <p>If FX occurs (payer USD \u2192 merchant ZAR), split legs: - Debit: <code>USER</code> \u2014 10000 USD - Credit: <code>LIQUIDITY</code> \u2014 10000 USD - Debit: <code>LIQUIDITY</code> \u2014 180000 ZAR - Credit: <code>MERCHANT</code> \u2014 180000 ZAR - Credit/Debit: <code>FX_PNL</code> \u2014 difference from quoted vs realized</p> <p>Cross\u2011border flows may include legs to/from <code>NOSTRO</code>/<code>VOSTRO</code> accounts to reflect settlement with external banks.</p>"},{"location":"10-components/ledger-service/#vat-on-fees-za","title":"VAT on Fees (ZA)","text":"<ul> <li>When fees are vatable, split into <code>FEES_NET</code> and <code>FEES_VAT</code> credits as per <code>20-specs/tax-vat.md</code>.</li> </ul>"},{"location":"10-components/ledger-service/#3-returned-chargeback-reverse-prior-settled","title":"3) Returned / Chargeback (reverse prior settled)","text":"<p>Post the exact contra of the settlement set, preserving original currency: - Debit: <code>MERCHANT</code> \u2014 9900 - Debit: <code>FEES</code> \u2014 100   (or use <code>FEES_REVERSAL</code> to separate) - Credit: <code>USER</code> \u2014 10000</p> <p>For partial returns, amounts reflect the returned portion; keep link to original journal via <code>relatedJournalId</code> (in <code>journals.memo</code>).</p>"},{"location":"10-components/ledger-service/#4-fees-surcharges","title":"4) Fees &amp; Surcharges","text":"<ul> <li>Percentage fees applied at settlement time as separate credit to <code>FEES</code> account.  </li> <li>Per\u2011rail surcharges (e.g., OPPWA) post to <code>FEES_PARTNER</code> account and are netted in reconciliation.</li> </ul>"},{"location":"10-components/ledger-service/#5-rounding","title":"5) Rounding","text":"<ul> <li>Use banker\u2019s rounding when converting decimals \u2192 minor units.  </li> <li>Any rounding residual posts to <code>FX_PNL_ROUNDING</code> (must be near\u2011zero).</li> </ul>"},{"location":"10-components/ledger-service/#diagrams","title":"\ud83d\udcd0 Diagrams","text":""},{"location":"10-components/ledger-service/#event-posting-pipeline","title":"Event \u2192 Posting pipeline","text":"<pre><code>flowchart LR\n  EV[transfers.* event] --&gt; PR[Posting Rules]\n  PR --&gt; JR[Create Journal]\n  JR --&gt; PT[Append Postings (balanced)]\n  PT --&gt; BL[Update Balances]\n  PT --&gt; OE[Emit ledger.posting.created]\n  BL --&gt; BE[Emit ledger.balance.updated]</code></pre>"},{"location":"10-components/ledger-service/#settlement-example-no-fx","title":"Settlement example (no FX)","text":"<pre><code>sequenceDiagram\n  participant GW as Rail Gateway\n  participant L as Ledger\n  participant S as Balance Store\n\n  GW--&gt;&gt;L: transfers.settled {amount=10000, fee=100}\n  L-&gt;&gt;L: create journal J1\n  L-&gt;&gt;L: postings: D USER 10000 / C MERCHANT 9900 / C FEES 100\n  L-&gt;&gt;S: update balances (USER-, MERCHANT+, FEES+)\n  L--&gt;&gt;GW: ledger.posting.created (J1)</code></pre>"},{"location":"10-components/ledger-service/#invariants","title":"\ud83e\uddf1 Invariants","text":"<ul> <li>Balanced: sum(debits) == sum(credits) per journal.  </li> <li>Append\u2011only: no deletes; corrections via new journals.  </li> <li>Idempotent: journal key = hash(<code>transferId</code>,<code>eventType</code>,<code>sequence</code>); duplicates ignored.  </li> <li>Temporal: <code>occurredAt</code> from event; do not rewrite history.</li> </ul> <p>Consumer idempotency: dedupe inbound events by <code>eventId</code>, and enforce lifecycle uniqueness <code>(transferId,eventType)</code> to avoid double-posting.</p>"},{"location":"10-components/ledger-service/#failure-modes-retries","title":"\ud83d\udea8 Failure Modes &amp; Retries","text":"<ul> <li>Duplicate event \u2192 ignored via idempotency key.  </li> <li>Currency mismatch (account vs posting) \u2192 reject and raise operator alert.  </li> <li>Negative balance constraints (if configured) \u2192 block posting and raise exception.  </li> <li>Outbox publish failure \u2192 retry with backoff; no partial commits (journal + outbox in same txn).</li> </ul>"},{"location":"10-components/ledger-service/#observability","title":"\ud83d\udcca Observability","text":"<ul> <li>Metrics: <code>journals/sec</code>, <code>postings/sec</code>, balance update latency, idempotency drop rate.  </li> <li>Gauges: outstanding reversal backlog, FX_PNL daily total.  </li> <li>Logs: structured with <code>transferId</code>, <code>journalId</code>, <code>accountId</code>, <code>currency</code>.  </li> <li>Traces: span across event reception \u2192 journal write \u2192 outbox publish.</li> </ul>"},{"location":"10-components/ledger-service/#security","title":"\ud83d\udd10 Security","text":"<ul> <li>Least privilege DB role; append\u2011only constraints at the schema level if possible.  </li> <li>PII: account metadata stored outside postings; journals contain IDs only.  </li> <li>Statement exports signed + timestamped; encrypt artifacts at rest.  </li> <li>Admin endpoints behind service mesh authN/Z; metrics unauthenticated readiness only.</li> </ul>"},{"location":"10-components/ledger-service/#config","title":"\u2699\ufe0f Config","text":"<ul> <li><code>LEDGER_BASE_CURRENCY</code> (reporting), supported currencies.  </li> <li><code>NEGATIVE_BALANCE_POLICY</code> (ALLOW|BLOCK|WARN).  </li> <li><code>FX_QUOTE_SOURCE</code> (provider, TTL).  </li> <li><code>STATEMENT_FORMATS</code> (bai2,json), <code>STATEMENT_TIMEZONE</code>.  </li> <li><code>IDEMPOTENCY_SALT</code> for journal keys.</li> </ul>"},{"location":"10-components/ledger-service/#runbooks","title":"\ud83d\udcd8 Runbooks","text":"<ul> <li>Balances off vs partner \u2192 run T+0/T+1 reconciliation; inspect unmatched queue; verify posting rules version.  </li> <li>FX_PNL spikes \u2192 check quote source latency; ensure correct pair &amp; decimals.  </li> <li>Reversal backlog \u2192 confirm returns events being emitted; investigate gateway DLQs.  </li> <li>Throughput degradation \u2192 check DB contention on <code>balances</code>; consider batched/materialized updates.</li> </ul>"},{"location":"10-components/ledger-service/#slos","title":"\ud83d\udccf SLOs","text":"<ul> <li>Posting latency (P99) \u2264 1s after <code>transfers.settled</code>.  </li> <li>Idempotency duplicate acceptance rate \u2264 0.1%.  </li> <li>Balance read latency (P99) \u2264 200 ms.  </li> <li>Statement generation \u2264 60 s for 100k postings.</li> </ul>"},{"location":"10-components/ledger-service/#test-matrix-essentials","title":"\ud83e\uddea Test Matrix (essentials)","text":"<ul> <li>Round\u2011trip: accepted \u2192 settled \u2192 returned (full &amp; partial).  </li> <li>Multi\u2011currency settlement with FX &amp; rounding residuals.  </li> <li>Idempotency under concurrent duplicates.  </li> <li>Negative balance policy enforcement.  </li> <li>Statement export byte\u2011for\u2011byte determinism for a fixed fixture.</li> </ul>"},{"location":"10-components/ledger-service/#example-journal-posting-payloads","title":"Example: Journal &amp; Posting payloads","text":"<p>Journal (emitted event payload) <pre><code>{\n  \"journalId\": \"jrnl_01HZX...\",\n  \"transferId\": \"tr_01HZY...\",\n  \"eventType\": \"transfers.settled\",\n  \"occurredAt\": \"2025-08-26T10:15:01Z\",\n  \"memo\": \"settlement zimswitch batch 8341\",\n  \"exchangeControlRef\": \"ec_ABC123\"\n}\n</code></pre></p> <p>Posting (emitted event payload) <pre><code>{\n  \"postingId\": \"pst_01HZ...\",\n  \"journalId\": \"jrnl_01HZX...\",\n  \"debitAccountId\": \"acct_user_123\",\n  \"creditAccountId\": \"acct_merchant_987\",\n  \"amountMinor\": 9900,\n  \"currency\": \"ZAR\",\n  \"memo\": \"net to merchant\"\n}\n</code></pre></p> <p>Bottom line: The Ledger turns messy rail realities into deterministic, balanced, auditable facts. Everything else in Stalela depends on this discipline.</p>"},{"location":"10-components/operator-console/","title":"Operator Console","text":"<p>The Operator Console is the human-facing interface for resolving exceptions, monitoring transfers, and acting on compliance/reconciliation workflows.</p>"},{"location":"10-components/operator-console/#purpose","title":"\ud83c\udfaf Purpose","text":"<ul> <li>Provide operators with clear visibility into transfer timelines.  </li> <li>Enable manual intervention for returns, unmatched items, compliance flags.  </li> <li>Reduce need for engineers to access production systems.  </li> </ul>"},{"location":"10-components/operator-console/#responsibilities","title":"\ud83d\udee0 Responsibilities","text":"<ul> <li>Display transfer timelines (events, postings).  </li> <li>Show queues: returns, reconciliation exceptions, compliance hits.  </li> <li>Allow manual resolution: assign unmatched, trigger return, freeze/unfreeze entity.  </li> <li>Surface system health and metrics dashboards.  </li> </ul>"},{"location":"10-components/operator-console/#interfaces","title":"\ud83d\udd0c Interfaces","text":"<ul> <li>Web UI (internal only, authenticated via SSO).  </li> <li>Reads from CTS, Ledger, Compliance, Recon.  </li> <li>Writes via APIs only (never direct DB):  </li> <li><code>POST /returns</code> </li> <li><code>POST /entity/freeze</code> </li> <li><code>POST /entity/unfreeze</code> </li> </ul>"},{"location":"10-components/operator-console/#sequence","title":"\ud83d\udcd0 Sequence","text":"<pre><code>sequenceDiagram\n  participant O as Operator\n  participant OC as Operator Console\n  participant CTS\n  participant Recon\n  participant Compliance\n\n  O-&gt;&gt;OC: view unmatched\n  OC-&gt;&gt;Recon: GET /exceptions\n  O-&gt;&gt;OC: resolve exception\n  OC-&gt;&gt;CTS: POST /returns {transferId, reason}\n  CTS--&gt;&gt;OC: transfers.returned event</code></pre>"},{"location":"10-components/operator-console/#localization-i18n","title":"\ud83c\udf0d Localization (i18n)","text":"<ul> <li>Supported languages: English (en), Afrikaans (af), Zulu (zu), Xhosa (xh), Sotho (st), Tswana (tn).  </li> <li>Strategy: externalized message catalog with keys; locale switch per user.  </li> <li>PII: ensure translations do not expose sensitive data; placeholders only.  </li> </ul>"},{"location":"10-components/operator-console/#failure-modes","title":"\ud83d\udea8 Failure Modes","text":"<ul> <li>Stale data \u2192 refresh from APIs, not cached snapshots.  </li> <li>Unauthorized access \u2192 enforce SSO + RBAC.  </li> <li>Operator error \u2192 require 4-eyes approval for destructive actions (returns, freezes).  </li> </ul>"},{"location":"10-components/operator-console/#observability","title":"\ud83d\udcca Observability","text":"<ul> <li>Audit log of every operator action (immutable).  </li> <li>Metrics: queue sizes, resolution times.  </li> <li>Alerts: backlog &gt; SLA.</li> </ul>"},{"location":"10-components/operator-console/#security","title":"\ud83d\udd10 Security","text":"<ul> <li>SSO + role-based access (OPS, COMPLIANCE, ADMIN).  </li> <li>Audit trail mandatory.  </li> <li>PII redacted where not necessary.  </li> </ul>"},{"location":"10-components/operator-console/#runbooks","title":"\ud83e\udded Runbooks","text":"<ul> <li>Recon backlog \u2192 assign extra operators.  </li> <li>False compliance flag \u2192 unfreeze with reason, record override.  </li> <li>Frequent operator overrides \u2192 escalate rule/threshold tuning.</li> </ul>"},{"location":"10-components/orchestration-ai-agents/","title":"Orchestration AI Agents","text":"<p>The AI orchestration layer augments Canonical Transfer Service (CTS) decisioning with stateless, observable agents. Each agent evaluates a specific dimension\u2014route performance, risk posture, or platform health\u2014and publishes structured events that loop back into CTS, Directory, and Compliance flows.</p>"},{"location":"10-components/orchestration-ai-agents/#agent-overview","title":"Agent Overview","text":"Agent Primary Goal Inputs Outputs Invocation Path Smart Rail Selector Rank available rails against policy weights and runtime health Transfer intent, policy weights, rail metrics Ranked rail list, selected rail, scoring metadata CTS orchestration pipeline prior to Directory call Dynamic Risk Classifier Assign adaptive compliance tiers Payer/payee metadata, device signals, historical incidents Risk tier, confidence, contributing features CTS compliance step (pre-screen and re-evaluate on state changes) Rail Health Monitor Track infrastructure health and flag degraded rails Events, rail telemetry (latency, failure rate, uptime), incident feed Health state, recommended throttles, events (<code>rail.flagged.degraded</code>) Continuous streaming microservice subscribed to Event Bus Orchestration Copilot Provide human-friendly explanations and diagnostics Agent event history, policy configuration, observability data Natural language summaries, CLI responses, remediation guidance On-demand via CLI (<code>stalela ctl orchestration explain</code>) or chat assistant"},{"location":"10-components/orchestration-ai-agents/#sample-payloads-integration-points","title":"Sample Payloads &amp; Integration Points","text":""},{"location":"10-components/orchestration-ai-agents/#smart-rail-selector","title":"Smart Rail Selector","text":"<pre><code>{\n  \"transfer_id\": \"tr_789\",\n  \"intent\": \"PUSH\",\n  \"policy\": {\n    \"optimize_for\": \"cost\",\n    \"fallbacks\": [\"reliability\", \"speed\"],\n    \"preferred_methods\": [\"mobile_money\", \"voucher\"],\n    \"excluded_rails\": [\"card\"]\n  },\n  \"candidates\": [\n    { \"rail\": \"mobile_money\", \"latency_ms\": 480, \"fx_spread_bps\": 15, \"failure_rate\": 0.4 },\n    { \"rail\": \"voucher\", \"latency_ms\": 210, \"fx_spread_bps\": 35, \"failure_rate\": 0.8 },\n    { \"rail\": \"usdc\", \"latency_ms\": 90, \"fx_spread_bps\": 55, \"failure_rate\": 0.2 }\n  ]\n}\n</code></pre> <p>Response fragment published via <code>route.selected.via_ai</code>:</p> <pre><code>{\n  \"selected_path\": [\"mobile_money\", \"voucher\"],\n  \"score\": 0.872,\n  \"features_used\": [\"latency_ms\", \"fx_spread_bps\", \"policy.optimize_for\"],\n  \"explanations\": [\n    \"mobile_money minimizes spread under cost-first policy\",\n    \"voucher provides resilience under reliability fallback\"\n  ]\n}\n</code></pre>"},{"location":"10-components/orchestration-ai-agents/#dynamic-risk-classifier","title":"Dynamic Risk Classifier","text":"<pre><code>{\n  \"transfer_id\": \"tr_789\",\n  \"tenant_id\": \"tn_55\",\n  \"entities\": {\n    \"payer\": { \"type\": \"WALLET\", \"country\": \"ZA\", \"device_fingerprint\": \"abc\" },\n    \"payee\": { \"type\": \"BANK\", \"country\": \"NG\", \"kyc_level\": \"basic\" }\n  },\n  \"behavioral_signals\": { \"lifetime_volume\": 12000, \"chargeback_rate\": 0.01 }\n}\n</code></pre> <p>Produces <code>risk.tier.assigned</code> with payload:</p> <pre><code>{\n  \"user_id\": \"payer-abc\",\n  \"risk_score\": 0.34,\n  \"compliance_level\": \"tier_2\",\n  \"features\": [\"country_pair\", \"behavioral.chargeback_rate\"]\n}\n</code></pre>"},{"location":"10-components/orchestration-ai-agents/#rail-health-monitor","title":"Rail Health Monitor","text":"<p>Subscribed to <code>events.transfers.*</code> plus telemetry topics. Emits <code>rail.flagged.degraded</code> when thresholds are breached:</p> <pre><code>{\n  \"rail_id\": \"zimswitch\",\n  \"health_metrics\": {\n    \"rolling_failure_rate\": 0.12,\n    \"p99_latency_ms\": 2150,\n    \"uptime_5m\": 0.89\n  },\n  \"timestamp\": \"2025-09-04T15:22:11Z\",\n  \"recommended_action\": \"deprioritize\",\n  \"confidence\": 0.82\n}\n</code></pre>"},{"location":"10-components/orchestration-ai-agents/#deployment-model","title":"Deployment Model","text":"<ul> <li>Packaging: Each agent is packaged as a lightweight container or serverless function with gRPC and REST shims.</li> <li>Invocation: CTS invokes Smart Rail Selector and Dynamic Risk Classifier synchronously within orchestration. Rail Health Monitor runs continuously, while Orchestration Copilot is invoked on demand.</li> <li>Observability: OpenTelemetry traces span CTS and agent calls. Structured logs include <code>trace_id</code>, <code>transfer_id</code>, and <code>policy_id</code> for joinability.</li> <li>Configuration: Policies stored in the Directory/Config service are versioned; agents consume updates via feature flag streams.</li> </ul>"},{"location":"10-components/orchestration-ai-agents/#testing-simulation","title":"Testing &amp; Simulation","text":"<ul> <li>Offline evaluation: Replay historical transfers through the agents with <code>stalela simulate orchestration --from &lt;date&gt;</code> to measure precision/recall of routing decisions.</li> <li>A/B experiments: Toggle agent policies per tenant via feature flags; compare success metrics in Looker dashboards backed by <code>route.selected.via_ai</code> events.</li> <li>Contract tests: JSON schema fixtures for agent inputs/outputs live in <code>storo-specs/orchestration</code>. CTS CI enforces schema drift detection.</li> <li>Chaos drills: Use <code>stalela chaos rail --target=&lt;rail&gt;</code> to inject latency/failure and verify Rail Health Monitor suppresses degraded paths.</li> </ul>"},{"location":"10-components/orchestration-ai-agents/#fallback-observability-patterns","title":"Fallback &amp; Observability Patterns","text":"<ul> <li>Graceful degradation: If an agent call times out or errors, CTS reverts to deterministic Directory routing rules and records <code>orchestration.fallback.used</code> with reason codes.</li> <li>Audit trails: All agent outputs persist in the orchestration event stream, allowing red-team review and compliance audits.</li> <li>Operator workflows: Orchestration Copilot summarizes agent contributions in the Operator Console and CLI, aiding rapid incident response.</li> <li>Model lifecycle: Retraining jobs publish <code>model.version.changed</code> events; deployments require canary windows with heightened alerting on rail success rate.</li> </ul>"},{"location":"10-components/platform-base/","title":"Platform/Base Library","text":"<p>The Platform/Base Library provides shared utilities for all Stalela services, ensuring consistency in health checks, IDs, error handling, time logic, and migrations.</p>"},{"location":"10-components/platform-base/#purpose","title":"\ud83c\udfaf Purpose","text":"<ul> <li>Provide common admin endpoints for all services.  </li> <li>Standardize time, IDs, errors across the stack.  </li> <li>Support embedded migrations/configs.  </li> <li>Simplify observability and operational tooling.</li> </ul>"},{"location":"10-components/platform-base/#responsibilities","title":"\ud83d\udee0 Responsibilities","text":"<ul> <li>Expose <code>GET /live</code>, <code>GET /ready</code>, <code>GET /metrics</code>, <code>GET /version</code>.  </li> <li>Provide banking-aware time utilities (cutoffs, holidays).  </li> <li>Standardize error handling (ErrorList, ParseError).  </li> <li>Offer ID generation and request tracing.  </li> <li>Embed DB migrations in service binaries.  </li> </ul> <p>Ship canonical holiday calendars for ZA/ZW and banking-day helpers (<code>Africa/Johannesburg</code>, <code>Africa/Harare</code>).</p>"},{"location":"10-components/platform-base/#contracts","title":"\ud83d\udcd1 Contracts","text":""},{"location":"10-components/platform-base/#admin-endpoints-all-services-adopt-via-platformbase","title":"Admin Endpoints (all services adopt via Platform/Base)","text":"<ul> <li><code>GET /live</code> \u2192 200 when process is up (no dependencies checked)</li> <li><code>GET /ready</code> \u2192 200 when dependencies are healthy (DB/bus); 503 otherwise</li> <li><code>GET /metrics</code> \u2192 Prometheus text format (counters, histograms, gauges)</li> <li><code>GET /version</code> \u2192 JSON</li> </ul> <pre><code>{\n  \"service\": \"storo-cts\",\n  \"version\": \"v1.2.3\",\n  \"gitSha\": \"abcd1234\",\n  \"buildDate\": \"2025-08-27T10:00:00Z\"\n}\n</code></pre> <p>Recommendation: bind admin server to a separate port and restrict exposure to service mesh / localhost.</p>"},{"location":"10-components/platform-base/#time-calendars","title":"\ud83d\udd52 Time &amp; Calendars","text":"<ul> <li>Regions/timezones supported out-of-the-box:</li> <li>ZA \u2192 <code>Africa/Johannesburg</code></li> <li>ZW \u2192 <code>Africa/Harare</code></li> <li>Helpers:</li> <li><code>Now()</code> \u2192 time in configured business TZ</li> <li><code>IsBankingDay(date)</code></li> <li><code>NextBankingDay(from)</code> / <code>PrevBankingDay(from)</code></li> <li><code>CutoffAt(date, rail)</code> \u2192 next effective cutoff from Directory config</li> <li>Calendars: ships canonical ZA/ZW holiday sets; Directory publishes effective calendars consumed by services.</li> </ul>"},{"location":"10-components/platform-base/#errors-ids","title":"\ud83e\uddf0 Errors &amp; IDs","text":"<ul> <li>Error taxonomy aligns with <code>docs/20-specs/error-codes.md</code>.</li> <li>Error helpers: <code>ErrorList</code>, <code>ParseError</code>, consistent fields: <code>{ code, message, details?, traceId? }</code>.</li> <li>IDs:</li> <li><code>ID()</code> \u2192 sortable unique IDs (UUIDv7-style) for entities/events</li> <li>Correlation: propagate W3C <code>traceparent</code> and include <code>traceId</code> in logs/errors</li> </ul>"},{"location":"10-components/platform-base/#migrations-embedded","title":"\ud83d\uddc3\ufe0f Migrations (embedded)","text":"<p>Embed schema migrations into service binaries and run on startup (opt-in flag).</p> <pre><code>import (\n  \"embed\"\n  base \"github.com/storo/platform-base\"\n)\n\n//go:embed migrations/*.sql\nvar migrationsFS embed.FS\n\nfunc main() {\n  db := mustOpenDB()\n  if err := base.Migrate(db, migrationsFS); err != nil { panic(err) }\n  // start admin server, app, consumers...\n}\n</code></pre> <p>Migration file naming: <code>0001_init.sql</code>, <code>0002_add_outbox.sql</code> (idempotent, forward-only). Rollback is handled via new forward migrations.</p>"},{"location":"10-components/platform-base/#interfaces","title":"\ud83d\udd0c Interfaces","text":"<ul> <li>Imported as library into all services.  </li> <li>Provides helpers for admin, time, error, IDs, migrations.  </li> </ul>"},{"location":"10-components/platform-base/#example","title":"\ud83d\udcd0 Example","text":"<pre><code>// Health server\nadmin := base.NewAdminServer(\":8081\")\nadmin.AddLivenessCheck(\"db\", db.Ping)\nadmin.Start()\n\n// Time utils\nt := base.Now()\nif t.IsBankingDay() { ... }\n</code></pre>"},{"location":"10-components/platform-base/#modules","title":"\ud83d\uddc4 Modules","text":"<ul> <li>Admin \u2192 liveness, readiness, metrics, version.  </li> <li>Time \u2192 banking days, holidays, cutoffs.  </li> <li>Errors \u2192 ErrorList, ParseError.  </li> <li>IDs \u2192 ID(), correlation IDs.  </li> <li>Migrations \u2192 embedded FS for DB schema upgrades.  </li> </ul>"},{"location":"10-components/platform-base/#observability","title":"\ud83d\udcca Observability","text":"<ul> <li>Uniform <code>/metrics</code> for Prometheus.  </li> <li>Structured error/logging helpers.  </li> <li>Request tracing correlation.  </li> </ul>"},{"location":"10-components/platform-base/#security","title":"\ud83d\udd10 Security","text":"<ul> <li>Admin endpoints on localhost or service mesh only.  </li> <li>No sensitive data in metrics/logs.  </li> </ul>"},{"location":"10-components/platform-base/#runbooks","title":"\ud83e\udded Runbooks","text":"<ul> <li>/live fails \u2192 service not running; check logs.  </li> <li>Migration failed \u2192 rollback DB version, re-run migration.  </li> <li>Clock drift \u2192 verify NTP sync; banking-day logic depends on accurate time.</li> </ul>"},{"location":"10-components/rail-gateway-airtel-momo/","title":"Rail Gateway \u2014 Airtel Money (Mobile Money)","text":"<p>Purpose Adapt canonical transfers to Airtel Money; strict schema validation; webhook handling; events.</p>"},{"location":"10-components/rail-gateway-airtel-momo/#responsibilities","title":"Responsibilities","text":"<ul> <li>Consume <code>transfers.submitted.airtelmomo</code>.</li> <li>Initiate payment and handle callbacks.</li> </ul>"},{"location":"10-components/rail-gateway-airtel-momo/#interfaces","title":"Interfaces","text":"<ul> <li>HTTP: <code>POST /webhooks/airtelmomo</code></li> <li>Events (envelope <code>v=1</code>): as per canonical <code>transfers.*</code></li> </ul>"},{"location":"10-components/rail-gateway-airtel-momo/#data-rules","title":"Data &amp; Rules","text":"<ul> <li><code>airtelmomo_ops</code>; MSISDN/currency validation; idempotency keying.</li> </ul>"},{"location":"10-components/rail-gateway-airtel-momo/#failure-modes","title":"Failure Modes","text":"<ul> <li>Callback gaps \u2192 poll; DLQ on parse/verify failure.</li> </ul>"},{"location":"10-components/rail-gateway-airtel-momo/#observability-security","title":"Observability &amp; Security","text":"<ul> <li>Prompt success rate; signature verify; PII redaction.</li> </ul> <p>See also: Rail Gateway \u2014 Template and Reason Code mappings in ../20-specs/error-codes.md</p>"},{"location":"10-components/rail-gateway-ecocash/","title":"Rail Gateway \u2014 EcoCash (Mobile Money, ZW)","text":"<p>Purpose Adapt canonical transfers to EcoCash mobile money flows (STK/USSD prompts), handle callbacks/statement ingest, and emit domain events.</p>"},{"location":"10-components/rail-gateway-ecocash/#responsibilities","title":"Responsibilities","text":"<ul> <li>Subscribe to <code>transfers.submitted.ecocash</code> (PUSH primary).</li> <li>Trigger STK/USSD prompt, poll status, handle async callbacks.</li> <li>Map reason/return codes; emit <code>accepted/settled/returned/failed</code>.</li> <li>Persist artifacts (redacted) for audit/recon.</li> </ul>"},{"location":"10-components/rail-gateway-ecocash/#interfaces","title":"Interfaces","text":""},{"location":"10-components/rail-gateway-ecocash/#inputs","title":"Inputs","text":"<ul> <li>Events: <code>transfers.submitted.ecocash</code></li> <li>HTTP: <code>POST /webhooks/ecocash</code> (signature verify)</li> </ul>"},{"location":"10-components/rail-gateway-ecocash/#outputs","title":"Outputs","text":"<ul> <li>Events (envelope <code>v=1</code>): <code>transfers.accepted</code>, <code>transfers.settled</code>, <code>transfers.returned</code>, <code>transfers.failed</code></li> </ul>"},{"location":"10-components/rail-gateway-ecocash/#data-model","title":"Data Model","text":"<ul> <li><code>ecocash_ops</code> (transferId, msisdn, amountMinor, currency, opRef, status, reasonCode?)</li> <li><code>outbox_gateway</code>, blobs for requests/responses</li> </ul>"},{"location":"10-components/rail-gateway-ecocash/#algorithms-rules","title":"Algorithms / Rules","text":"<ul> <li>STK prompt initiation; timeout &amp; retry windows.</li> <li>Idempotency: <code>{tenantId}:{transferId}</code> as partner reference.</li> <li>Strict MSISDN validation and currency allowlist.</li> </ul>"},{"location":"10-components/rail-gateway-ecocash/#diagrams","title":"Diagrams","text":"<pre><code>sequenceDiagram\n  participant CTS\n  participant GW as EcoCash GW\n  participant MNO as EcoCash\n  CTS-&gt;&gt;GW: transfers.submitted.ecocash\n  GW-&gt;&gt;MNO: STK prompt\n  MNO--&gt;&gt;GW: accepted {opRef}\n  GW--&gt;&gt;CTS: transfers.accepted\n  MNO--&gt;&gt;GW: settled/return {reason}\n  GW--&gt;&gt;CTS: transfers.settled / transfers.returned</code></pre>"},{"location":"10-components/rail-gateway-ecocash/#failure-modes-retries","title":"Failure Modes &amp; Retries","text":"<ul> <li>Prompt not delivered \u2192 retry/backoff, operator alert after N.</li> <li>Decline/timeout \u2192 <code>failed</code>/<code>returned</code> with mapped reason.</li> </ul>"},{"location":"10-components/rail-gateway-ecocash/#observability","title":"Observability","text":"<ul> <li>Metrics: prompt latency/success, returns rate.</li> </ul>"},{"location":"10-components/rail-gateway-ecocash/#security","title":"Security","text":"<ul> <li>Webhook signature verification; PII redaction.</li> </ul>"},{"location":"10-components/rail-gateway-ecocash/#runbooks","title":"Runbooks","text":"<ul> <li>Replay webhook; quarantine poison messages; contact MNO if outage persists.</li> </ul> <p>See also: Rail Gateway \u2014 Template and Reason Code mappings in ../20-specs/error-codes.md</p>"},{"location":"10-components/rail-gateway-eft/","title":"Rail Gateway \u2014 EFT (BankservAfrica Batch)","text":"<p>Purpose Manage batch submissions and returns for EFT, aligning with Bankserv file formats and cutoffs.</p>"},{"location":"10-components/rail-gateway-eft/#responsibilities","title":"Responsibilities","text":"<ul> <li>Produce batch files; submit to partner; ingest settlement/return files.</li> <li>Emit <code>accepted/settled/returned/failed</code> events accordingly.</li> </ul>"},{"location":"10-components/rail-gateway-eft/#interfaces","title":"Interfaces","text":"<ul> <li>Files: batch submission, settlement, returns.</li> <li>Events (envelope <code>v=1</code>): <code>transfers.*</code></li> </ul>"},{"location":"10-components/rail-gateway-eft/#data-model","title":"Data Model","text":"<ul> <li><code>eft_batches</code>, <code>eft_lines</code>, artifacts for file copies.</li> </ul>"},{"location":"10-components/rail-gateway-eft/#rules","title":"Rules","text":"<ul> <li>Cutoffs, windows, file validation (record counts, checksums).</li> </ul>"},{"location":"10-components/rail-gateway-eft/#debicheck-mandates-za","title":"DebiCheck Mandates (ZA)","text":"<ul> <li>Mandate lifecycle: create \u2192 amend \u2192 cancel; store mandate reference and consent metadata.</li> <li>Pull payments: verify active mandate before submission; include mandateRef in payload.</li> <li>Returns: map mandate-related reason codes to <code>transfers.returned</code> with details.</li> </ul>"},{"location":"10-components/rail-gateway-eft/#failure-modes","title":"Failure Modes","text":"<ul> <li>File reject; late returns; mismatched totals \u2192 recon exception.</li> </ul>"},{"location":"10-components/rail-gateway-eft/#observability-security","title":"Observability &amp; Security","text":"<ul> <li>Metrics: batch success rate; PII minimal in files; encryption at rest.</li> </ul>"},{"location":"10-components/rail-gateway-mtn-momo/","title":"Rail Gateway \u2014 MTN MoMo (Mobile Money)","text":"<p>Purpose Translate canonical transfers to MTN MoMo APIs (P2P/P2M), enforce validation, process webhooks, and emit events.</p>"},{"location":"10-components/rail-gateway-mtn-momo/#responsibilities","title":"Responsibilities","text":"<ul> <li>Consume <code>transfers.submitted.mtnmomo</code>.</li> <li>Initiate payment request (PUSH), handle consent/approval callbacks.</li> <li>Emit lifecycle events; persist artifacts.</li> </ul>"},{"location":"10-components/rail-gateway-mtn-momo/#interfaces","title":"Interfaces","text":""},{"location":"10-components/rail-gateway-mtn-momo/#inputs","title":"Inputs","text":"<ul> <li>Events: <code>transfers.submitted.mtnmomo</code></li> <li>HTTP: <code>POST /webhooks/mtnmomo</code></li> </ul>"},{"location":"10-components/rail-gateway-mtn-momo/#outputs","title":"Outputs","text":"<ul> <li>Events (envelope <code>v=1</code>): <code>transfers.accepted</code>, <code>transfers.settled</code>, <code>transfers.returned</code>, <code>transfers.failed</code></li> </ul>"},{"location":"10-components/rail-gateway-mtn-momo/#data-model","title":"Data Model","text":"<ul> <li><code>mtnmomo_ops</code> (...)</li> </ul>"},{"location":"10-components/rail-gateway-mtn-momo/#rules","title":"Rules","text":"<ul> <li>MSISDN format validation; currency allowlist.</li> <li>Idempotency via partner reference.</li> </ul>"},{"location":"10-components/rail-gateway-mtn-momo/#failure-modes-retries","title":"Failure Modes &amp; Retries","text":"<ul> <li>202/accepted without finalization \u2192 poll until terminal.</li> </ul>"},{"location":"10-components/rail-gateway-mtn-momo/#observability-security","title":"Observability &amp; Security","text":"<ul> <li>Metrics, DLQ; webhook signature verify, redaction.</li> </ul> <p>See also: Rail Gateway \u2014 Template and Reason Code mappings in ../20-specs/error-codes.md</p>"},{"location":"10-components/rail-gateway-oppwa/","title":"Rail Gateway \u2014 OPPWA (Card / Tokenized Payments)","text":"<p>The OPPWA Gateway adapts Stalela canonical transfers to OPPWA (Open Payment Platform) APIs used by acquirers/processors (e.g., for Zimswitch card-present/tokenized flows). It validates payloads, transforms to OPPWA request formats, handles webhooks, and emits domain events.</p>"},{"location":"10-components/rail-gateway-oppwa/#purpose","title":"\ud83c\udfaf Purpose","text":"<ul> <li>Translate canonical transfers into OPPWA REST calls (payments, preauth/capture, refunds).</li> <li>Enforce strict validation of amounts, currencies, tokens/PAN surrogates, and 3DS/SDK data.</li> <li>Handle sync responses and async webhooks to finalize state.</li> <li>Emit accepted/settled/returned/failed events with mapped reason codes.</li> <li>Persist raw requests/responses (redacted) for audit and reconciliation.</li> </ul>"},{"location":"10-components/rail-gateway-oppwa/#responsibilities","title":"\ud83d\udee0 Responsibilities","text":"<ul> <li>Subscribe to <code>transfers.submitted.oppwa</code>.</li> <li>Map intents:</li> <li><code>AUTH</code> \u2192 OPPWA <code>preauthorization</code></li> <li><code>CAPTURE</code> \u2192 OPPWA <code>capture</code></li> <li><code>PUSH/PULL</code> (rare for cards) \u2192 treated as <code>debit</code>/<code>credit</code> where supported</li> <li>Build requests using merchant credentials / entity routing.</li> <li>Receive webhooks (<code>/webhooks/oppwa</code>) and correlate to transfers.</li> <li>Emit events and store artifacts; support retries and idempotency keys.</li> </ul>"},{"location":"10-components/rail-gateway-oppwa/#interfaces","title":"\ud83d\udd0c Interfaces","text":""},{"location":"10-components/rail-gateway-oppwa/#events-consume","title":"Events (consume)","text":"<ul> <li><code>transfers.submitted.oppwa</code></li> <li><code>{ transferId, tenantId, amount, currency, payer, payee, intent, metadata{ token, threeDS, merchantRef } }</code></li> </ul>"},{"location":"10-components/rail-gateway-oppwa/#events-emit-envelope-v1","title":"Events (emit; envelope <code>v=1</code>)","text":"<ul> <li><code>transfers.accepted</code> \u2192 <code>{ transferId, rail:\"oppwa\", opRef, resultCode }</code></li> <li><code>transfers.settled</code> \u2192 <code>{ transferId, rail:\"oppwa\", opRef, captured:true, settlementDate? }</code></li> <li><code>transfers.returned</code> \u2192 <code>{ transferId, rail:\"oppwa\", opRef, reasonCode }</code></li> <li><code>transfers.failed</code> \u2192 <code>{ transferId, rail:\"oppwa\", reason, details }</code></li> </ul>"},{"location":"10-components/rail-gateway-oppwa/#http","title":"HTTP","text":"<ul> <li><code>POST /webhooks/oppwa</code> (verify signature, parse, correlate)</li> <li>Admin: <code>GET /live</code>, <code>GET /ready</code>, <code>GET /metrics</code>, <code>GET /version</code></li> </ul>"},{"location":"10-components/rail-gateway-oppwa/#data-model","title":"\ud83d\uddc4 Data Model","text":"<ul> <li>table: <code>oppwa_ops</code></li> <li><code>id</code> (pk), <code>transferId</code>, <code>tenantId</code></li> <li><code>merchantId</code>, <code>entityId</code> (per-tenant/route), <code>opRef</code></li> <li><code>intent</code> (AUTH|CAPTURE|REFUND), <code>amountMinor</code>, <code>currency</code></li> <li><code>status</code> (INIT|ACCEPTED|CAPTURED|RETURNED|FAILED)</li> <li><code>resultCode</code>, <code>reasonCode</code>, <code>riskScore</code> (nullable)</li> <li><code>createdAt</code>, <code>updatedAt</code></li> <li>table: <code>outbox_gateway</code> \u2013 for events</li> <li>blob: redacted request/response JSON snapshots (encrypted), webhook payloads</li> </ul>"},{"location":"10-components/rail-gateway-oppwa/#transform-validation","title":"\ud83d\udd01 Transform &amp; Validation","text":"<ul> <li>Currency/amount \u2192 use minor units; reject &gt; 2 dp amounts for fiat.</li> <li>Tokenization \u2192 require network token / OPPWA token; never store PAN.</li> <li>3DS \u2192 include 3DS server results when present; pass-through fields via metadata.</li> <li>Idempotency \u2192 set OPPWA idempotency keys using <code>{tenantId}:{transferId}</code>.</li> <li>Reason mapping \u2192 maintain mapping table from OPPWA result/return codes \u2192 Stalela <code>reason</code> enums.</li> <li>Auth/Capture split \u2192 only capture after explicit command or webhook indicating capture.</li> </ul>"},{"location":"10-components/rail-gateway-oppwa/#sequence-auth-capture","title":"\ud83d\udcd0 Sequence (Auth \u2192 Capture)","text":"<pre><code>sequenceDiagram\n  participant CTS as Canonical Transfer Service\n  participant GW as OPPWA Gateway\n  participant OPP as OPPWA API\n  participant WH as Webhook Receiver\n\n  CTS-&gt;&gt;GW: transfers.submitted.oppwa (intent=AUTH)\n  GW-&gt;&gt;OPP: POST /payments (preauthorization)\n  OPP--&gt;&gt;GW: 200 result { opRef, resultCode }\n  GW--&gt;&gt;CTS: transfers.accepted { opRef }\n  WH--&gt;&gt;GW: webhook { opRef, captured }\n  GW--&gt;&gt;CTS: transfers.settled { opRef }</code></pre>"},{"location":"10-components/rail-gateway-oppwa/#failure-modes","title":"\ud83d\udea8 Failure Modes","text":"<ul> <li>DoS/429 from OPPWA \u2192 backoff + retry; escalate if sustained</li> <li>Invalid token / expired \u2192 <code>transfers.failed{reason:\"TOKEN_INVALID\"}</code></li> <li>Chargeback/return \u2192 emit <code>transfers.returned</code> with reason mapping</li> <li>Signature mismatch on webhook \u2192 reject + alert</li> <li>Currency not supported for merchant entity \u2192 fail fast</li> </ul>"},{"location":"10-components/rail-gateway-oppwa/#observability","title":"\ud83d\udcca Observability","text":"<ul> <li>Metrics: request latency, success rate by intent, webhook processing lag</li> <li>Error buckets by <code>resultCode</code> / <code>reasonCode</code></li> <li>DLQ depth for failed webhooks / submissions</li> </ul>"},{"location":"10-components/rail-gateway-oppwa/#security","title":"\ud83d\udd10 Security","text":"<ul> <li>Verify webhook signatures; rotate secrets</li> <li>Redact PAN-like fields aggressively; tokenize everything</li> <li>Encrypt blobs at rest; least-privileged access to merchant credentials</li> <li>PCI scope: keep CTS and Ledger out of PAN scope; gateway isolates card data</li> </ul>"},{"location":"10-components/rail-gateway-oppwa/#config","title":"\u2699\ufe0f Config","text":"<ul> <li><code>OPPWA_BASE_URL</code>, per-tenant <code>ENTITY_ID</code>, <code>MERCHANT_ID</code>, <code>API_KEY</code></li> <li><code>WEBHOOK_SECRET</code>, <code>IDEMPOTENCY_PREFIX</code></li> <li><code>TIMEOUT_MS</code>, <code>RETRY_MAX</code>, <code>BACKOFF</code></li> <li><code>REASON_CODE_MAP</code> (versioned), <code>CURRENCY_ALLOWLIST</code></li> </ul>"},{"location":"10-components/rail-gateway-oppwa/#runbooks","title":"\ud83e\udded Runbooks","text":"<ul> <li>High 401/403 rates: check API key rotation, entity mapping</li> <li>Webhook gaps: verify public endpoint, firewall, signature; replay from OPPWA portal if available</li> <li>Frequent declines: inspect 3DS setup and tokenization source; check risk engine outcomes</li> </ul> <p>See also: Rail Gateway \u2014 Template and Reason Code mappings in ../20-specs/error-codes.md</p>"},{"location":"10-components/rail-gateway-payshap/","title":"Rail Gateway \u2014 PayShap (ZA Instant Proxy Payments)","text":"<p>Purpose Integrate proxy-based instant payments (PayShap), handling proxy resolution, submission, and returns.</p>"},{"location":"10-components/rail-gateway-payshap/#responsibilities","title":"Responsibilities","text":"<ul> <li>Consume <code>transfers.submitted.payshap</code>.</li> <li>Resolve proxy (cell/email/ID) \u2192 account; submit payment; handle timeouts/returns.</li> </ul>"},{"location":"10-components/rail-gateway-payshap/#interfaces","title":"Interfaces","text":""},{"location":"10-components/rail-gateway-payshap/#inputs","title":"Inputs","text":"<ul> <li>Events: <code>transfers.submitted.payshap</code></li> <li>HTTP: <code>POST /webhooks/payshap</code></li> </ul>"},{"location":"10-components/rail-gateway-payshap/#outputs","title":"Outputs","text":"<ul> <li>Events (envelope <code>v=1</code>): <code>transfers.accepted</code>, <code>transfers.settled</code>, <code>transfers.returned</code>, <code>transfers.failed</code></li> </ul>"},{"location":"10-components/rail-gateway-payshap/#data-model","title":"Data Model","text":"<ul> <li><code>payshap_ops</code> (proxyType, proxyValue, resolvedAccount, opRef, status, reasonCode)</li> </ul>"},{"location":"10-components/rail-gateway-payshap/#rules","title":"Rules","text":"<ul> <li>Proxy validation and supported types; cutoff/timeouts per scheme.</li> <li>Reason code mapping.</li> </ul>"},{"location":"10-components/rail-gateway-payshap/#failure-modes","title":"Failure Modes","text":"<ul> <li>Resolution failure; submission timeout; duplicate notifications.</li> </ul>"},{"location":"10-components/rail-gateway-payshap/#observability-security","title":"Observability &amp; Security","text":"<ul> <li>Metrics: resolution latency, success; webhook signature; PII redaction.</li> </ul> <p>See also: Rail Gateway \u2014 Template and Reason Code mappings in ../20-specs/error-codes.md</p>"},{"location":"10-components/rail-gateway-rtgs/","title":"Rail Gateway \u2014 RTGS (High-Value)","text":"<p>Purpose Handle high-value, real-time gross settlement submissions and acknowledgments.</p>"},{"location":"10-components/rail-gateway-rtgs/#responsibilities","title":"Responsibilities","text":"<ul> <li>Consume <code>transfers.submitted.rtgs</code>.</li> <li>Submit payment via partner/bank API; handle acknowledgments and settlement confirmations.</li> </ul>"},{"location":"10-components/rail-gateway-rtgs/#interfaces","title":"Interfaces","text":"<ul> <li>Events (envelope <code>v=1</code>): <code>transfers.*</code></li> <li>Files/API: as per partner specifications.</li> </ul>"},{"location":"10-components/rail-gateway-rtgs/#data-model","title":"Data Model","text":"<ul> <li><code>rtgs_ops</code> (transferId, amount, currency, opRef, status)</li> </ul>"},{"location":"10-components/rail-gateway-rtgs/#rules","title":"Rules","text":"<ul> <li>High-value thresholds; cutoff windows; stronger idempotency.</li> </ul>"},{"location":"10-components/rail-gateway-rtgs/#failure-modes","title":"Failure Modes","text":"<ul> <li>Queueing at partner; manual operator intervention paths.</li> </ul>"},{"location":"10-components/rail-gateway-rtgs/#observability-security","title":"Observability &amp; Security","text":"<ul> <li>Metrics: ack/settle latency; strong auth; PII minimization.</li> </ul> <p>See also: Rail Gateway \u2014 Template and Reason Code mappings in ../20-specs/error-codes.md</p>"},{"location":"10-components/rail-gateway-template/","title":"Rail Gateway \u2014 Template","text":"<p>Use this template when creating a new rail gateway component doc.</p>"},{"location":"10-components/rail-gateway-template/#purpose","title":"Purpose","text":"<p>Adapt canonical transfers to the rail; strict schema validation; webhooks/file ingest; emit events.</p>"},{"location":"10-components/rail-gateway-template/#responsibilities","title":"Responsibilities","text":"<ul> <li>Consume <code>transfers.submitted.&lt;rail&gt;</code>.</li> <li>Initiate/submit payment and handle callbacks/files.</li> <li>Map reason/return codes; emit <code>accepted/settled/returned/failed</code>.</li> <li>Persist artifacts (redacted) for audit/recon; use outbox for events.</li> </ul>"},{"location":"10-components/rail-gateway-template/#interfaces","title":"Interfaces","text":""},{"location":"10-components/rail-gateway-template/#inputs","title":"Inputs","text":"<ul> <li>Events: <code>transfers.submitted.&lt;rail&gt;</code></li> <li>HTTP/Webhooks or Files as per rail</li> </ul>"},{"location":"10-components/rail-gateway-template/#outputs","title":"Outputs","text":"<ul> <li>Events (envelope <code>v=1</code>): <code>transfers.accepted</code>, <code>transfers.settled</code>, <code>transfers.returned</code>, <code>transfers.failed</code></li> </ul>"},{"location":"10-components/rail-gateway-template/#data-model","title":"Data Model","text":"<ul> <li><code>&lt;rail&gt;_ops</code> (transferId, tenantId, opRef, amountMinor, currency, status, reasonCode?)</li> <li><code>outbox_gateway</code>, encrypted blobs for requests/responses</li> </ul>"},{"location":"10-components/rail-gateway-template/#transform-validation","title":"Transform &amp; Validation","text":"<ul> <li>Strict validation of identifiers, amounts, currencies.</li> <li>Idempotency: <code>{tenantId}:{transferId}</code> partner reference.</li> <li>Reason mapping \u2192 Stalela enums (see <code>docs/20-specs/error-codes.md</code>).</li> </ul>"},{"location":"10-components/rail-gateway-template/#diagrams-example","title":"Diagrams (example)","text":"<pre><code>sequenceDiagram\n  participant CTS\n  participant GW as &lt;Rail&gt; GW\n  participant RAIL as &lt;Rail&gt;\n  CTS-&gt;&gt;GW: transfers.submitted.&lt;rail&gt;\n  GW-&gt;&gt;RAIL: submit\n  RAIL--&gt;&gt;GW: accepted {opRef}\n  GW--&gt;&gt;CTS: transfers.accepted\n  RAIL--&gt;&gt;GW: settled/return {reason}\n  GW--&gt;&gt;CTS: transfers.settled / transfers.returned</code></pre>"},{"location":"10-components/rail-gateway-template/#failure-modes-retries","title":"Failure Modes &amp; Retries","text":"<ul> <li>Submission failure \u2192 backoff/retry; DLQ for poison payloads.</li> <li>Timeout \u2192 emit <code>failed</code> or <code>returned</code> per scheme rules.</li> </ul>"},{"location":"10-components/rail-gateway-template/#observability-security","title":"Observability &amp; Security","text":"<ul> <li>Metrics: submit/settle latency, returns rate; DLQ depth.</li> <li>Webhook signature verification / PII redaction.</li> </ul>"},{"location":"10-components/rail-gateway-usdc-algo/","title":"Rail Gateway \u2014 USDC on Algorand","text":"<p>The USDC/Algorand Gateway adapts Stalela\u2019s canonical transfers to on-chain USDC movements on the Algorand network. It validates requests, constructs transactions, submits to the network (via Algod/Indexer/provider), listens for confirmations, and emits domain events.</p>"},{"location":"10-components/rail-gateway-usdc-algo/#purpose","title":"\ud83c\udfaf Purpose","text":"<ul> <li>Translate canonical transfers into Algorand transactions (ASA transfers).</li> <li>Provide strict validation (asset, amounts, addresses, fees).</li> <li>Handle submission and confirmation with retries and reorg safety.</li> <li>Emit transfers.accepted / transfers.settled / transfers.failed as reality unfolds.</li> <li>Persist raw tx metadata for audit and reconciliation.</li> </ul>"},{"location":"10-components/rail-gateway-usdc-algo/#responsibilities","title":"\ud83d\udee0 Responsibilities","text":"<ul> <li>Subscribe to <code>transfers.submitted.usdc</code> events.</li> <li>Validate: payer/payee accounts, ASA ID (USDC), decimals, amount, memo fields, network params.</li> <li>Construct and sign transactions (online hot wallet or external signer/HSM).</li> <li>Submit to network; poll or subscribe for confirmations (N blocks).</li> <li>Emit outcome events and persist artifacts (txid, round, fees).</li> <li>Surface health (<code>/live</code>, <code>/ready</code>), metrics, version via Platform/Base.</li> </ul>"},{"location":"10-components/rail-gateway-usdc-algo/#interfaces","title":"\ud83d\udd0c Interfaces","text":""},{"location":"10-components/rail-gateway-usdc-algo/#events-consume","title":"Events (consume)","text":"<ul> <li><code>transfers.submitted.usdc</code></li> <li>payload: <code>{ transferId, tenantId, amount{value,currency}, payer, payee, intent: \"PUSH\"|\"PULL\"|\"CAPTURE\"|\"AUTH\", metadata{} }</code></li> </ul>"},{"location":"10-components/rail-gateway-usdc-algo/#events-emit-envelope-v1","title":"Events (emit; envelope <code>v=1</code>)","text":"<ul> <li><code>transfers.accepted</code> \u2192 <code>{ transferId, rail:\"usdc-algo\", txId, suggestedRound }</code></li> <li><code>transfers.settled</code> \u2192 <code>{ transferId, rail:\"usdc-algo\", txId, confirmedRound, feeMicroAlgos }</code></li> <li><code>transfers.failed</code> \u2192 <code>{ transferId, rail:\"usdc-algo\", reason, details }</code></li> </ul>"},{"location":"10-components/rail-gateway-usdc-algo/#http-admin","title":"HTTP (admin)","text":"<ul> <li><code>GET /live</code>, <code>GET /ready</code>, <code>GET /metrics</code>, <code>GET /version</code></li> </ul>"},{"location":"10-components/rail-gateway-usdc-algo/#data-model","title":"\ud83d\uddc4 Data Model","text":"<ul> <li>table: <code>usdc_algo_tx</code></li> <li><code>id</code> (pk), <code>transferId</code>, <code>tenantId</code></li> <li><code>txId</code>, <code>firstValid</code>, <code>lastValid</code>, <code>confirmedRound</code></li> <li><code>payerAddr</code>, <code>payeeAddr</code>, <code>amountBaseUnits</code> (int)</li> <li><code>feeMicroAlgos</code>, <code>note</code> (base64), <code>network</code> (mainnet/testnet)</li> <li><code>status</code> (PENDING|CONFIRMED|FAILED), <code>error</code> (nullable)</li> <li><code>createdAt</code>, <code>updatedAt</code></li> <li>table: <code>outbox_gateway</code> \u2013 standard outbox for event publishing</li> </ul> <p>Raw payloads (signed txn, provider receipts) should be stored encrypted in blob storage with references here.</p>"},{"location":"10-components/rail-gateway-usdc-algo/#transform-validation","title":"\ud83d\udd01 Transform &amp; Validation","text":"<ul> <li>Currency must be <code>USD</code> with USDC ASA mapped to <code>assetId</code> (config).</li> <li>Decimals: Convert from canonical decimal to base units (10^decimals).</li> <li>Addresses: Bech32/base32 Algorand addresses; ensure payer has opted-in to ASA.</li> <li>Fees: Enforce min fee; allow overpay for fast confirm (config).</li> <li>Auth/Capture: On-chain AUTH is simulated via escrow account or timelocked pattern (optional, roadmap). Default intent is PUSH.</li> <li>Memo/Note: Encode limited metadata in <code>note</code> (&lt;= 1 KB best practice). Do not put PII in chain notes.</li> </ul>"},{"location":"10-components/rail-gateway-usdc-algo/#sequence-happy-path","title":"\ud83d\udcd0 Sequence (Happy Path)","text":"<pre><code>sequenceDiagram\n  participant CTS as Canonical Transfer Service\n  participant GW as USDC/Algorand Gateway\n  participant ALG as Algorand Network\n\n  CTS-&gt;&gt;GW: transfers.submitted.usdc\n  GW-&gt;&gt;GW: validate + build txn\n  GW-&gt;&gt;ALG: submit signed txn\n  ALG--&gt;&gt;GW: tx accepted (txId)\n  GW--&gt;&gt;CTS: transfers.accepted {txId}\n  ALG--&gt;&gt;GW: confirmed at round N\n  GW--&gt;&gt;CTS: transfers.settled {txId, round}</code></pre>"},{"location":"10-components/rail-gateway-usdc-algo/#failure-modes","title":"\ud83d\udea8 Failure Modes","text":"<ul> <li>Invalid account / not opted-in \u2192 <code>transfers.failed{reason:\"NOT_OPTED_IN\"}</code></li> <li>Insufficient balance / fee \u2192 <code>...{\"INSUFFICIENT_FUNDS\"}</code></li> <li>RPC/provider timeout \u2192 retry with backoff; surface <code>accepted</code> only after tx is seen</li> <li>Chain reorg / orphan (rare on Algorand) \u2192 re-check finality window, re-emit <code>failed</code> if dropped</li> <li>Signer/HSM unavailable \u2192 circuit break, keep events in DLQ</li> </ul>"},{"location":"10-components/rail-gateway-usdc-algo/#observability","title":"\ud83d\udcca Observability","text":"<ul> <li>Metrics: submit latency, confirmation latency, success rate, DLQ size, provider error codes</li> <li>Logs: txId, transferId, address short-hash, round; no PII</li> <li>Traces: propagate <code>x-request-id</code> / <code>trace-id</code> from CTS</li> </ul>"},{"location":"10-components/rail-gateway-usdc-algo/#security","title":"\ud83d\udd10 Security","text":"<ul> <li>Keys in HSM or isolated signer; never log material</li> <li>Principle of least privilege on provider API keys</li> <li>Encrypt raw signed txn artifacts at rest</li> <li>Feature flag to disable on-chain <code>note</code></li> </ul>"},{"location":"10-components/rail-gateway-usdc-algo/#config","title":"\u2699\ufe0f Config","text":"<ul> <li><code>ALGOD_URL</code>, <code>ALGOD_TOKEN</code>, <code>INDEXER_URL</code></li> <li><code>USDC_ASSET_ID</code>, <code>DECIMALS</code></li> <li><code>CONFIRMATIONS</code> (blocks), <code>SUBMIT_RETRY_MAX</code></li> <li><code>SIGNER_ENDPOINT</code> (optional), <code>NETWORK</code></li> </ul>"},{"location":"10-components/rail-gateway-usdc-algo/#runbooks","title":"\ud83e\udded Runbooks","text":"<ul> <li>Stuck in PENDING: check provider status; if mempool full, rebroadcast; verify fee</li> <li>Frequent INSUFFICIENT_FUNDS: inspect payer funding policy; enable preflight balance check</li> <li>High confirmation latency: increase fee or confirmation window temporarily</li> <li>Signer down: fail closed; drain DLQ after recovery</li> </ul> <p>See also: Rail Gateway \u2014 Template and Reason Code mappings in ../20-specs/error-codes.md</p>"},{"location":"10-components/rail-gateway-zimswitch/","title":"Rail Gateway \u2014 Zimswitch (Card / ISO 8583 via OPPWA)","text":"<p>The Zimswitch Gateway adapts Stalela canonical transfers to Zimswitch-connected acquiring via OPPWA/ISO 8583 semantics. It validates messages, transforms to processor requests, handles callbacks/settlement files, and emits domain events.</p> <p>Note: Some Zimswitch integrations front with OPPWA JSON APIs while the underlying network uses ISO 8583. We model both: primary REST submission with strict ISO field discipline in validation and mapping.</p>"},{"location":"10-components/rail-gateway-zimswitch/#purpose","title":"\ud83c\udfaf Purpose","text":"<ul> <li>Translate canonical transfers to Zimswitch/OPPWA requests with ISO-grade validation.</li> <li>Support card-present (tap-on-phone, online) and card-not-present (tokenized) flows where permitted.</li> <li>Handle accept/settle/return lifecycle + reconciliation with daily settlement files.</li> <li>Emit domain events with mapped reason codes and retain artifacts for audit.</li> </ul>"},{"location":"10-components/rail-gateway-zimswitch/#responsibilities","title":"\ud83d\udee0 Responsibilities","text":"<ul> <li>Subscribe to <code>transfers.submitted.zimswitch</code>.</li> <li>Validate BIN/member routing via Directory &amp; Routing.</li> <li>Construct request: amount, currency (ZWL/ZAR/USD), merchant data, token/PAN surrogate, terminal capabilities.</li> <li>Submit to processor; handle synchronous result and async callbacks.</li> <li>Ingest settlement files (daily) for reconciliation and late returns.</li> <li>Emit <code>accepted/settled/returned/failed</code> and store payloads (redacted).</li> </ul>"},{"location":"10-components/rail-gateway-zimswitch/#interfaces","title":"\ud83d\udd0c Interfaces","text":""},{"location":"10-components/rail-gateway-zimswitch/#events-consume","title":"Events (consume)","text":"<ul> <li><code>transfers.submitted.zimswitch</code></li> <li><code>{ transferId, tenantId, amount, currency, payer, payee, intent, metadata{ token|panRef, emv, terminal, merchantRef } }</code></li> </ul>"},{"location":"10-components/rail-gateway-zimswitch/#events-emit-envelope-v1","title":"Events (emit; envelope <code>v=1</code>)","text":"<ul> <li><code>transfers.accepted</code> \u2192 <code>{ transferId, rail:\"zimswitch\", acqRef, authCode }</code></li> <li><code>transfers.settled</code> \u2192 <code>{ transferId, rail:\"zimswitch\", settlementDate, batchId? }</code></li> <li><code>transfers.returned</code> \u2192 <code>{ transferId, rail:\"zimswitch\", reasonCode }</code></li> <li><code>transfers.failed</code> \u2192 <code>{ transferId, rail:\"zimswitch\", reason, details }</code></li> </ul>"},{"location":"10-components/rail-gateway-zimswitch/#http","title":"HTTP","text":"<ul> <li><code>POST /webhooks/zimswitch</code> (if using REST front-end)</li> <li>Admin: <code>GET /live</code>, <code>GET /ready</code>, <code>GET /metrics</code>, <code>GET /version</code></li> </ul>"},{"location":"10-components/rail-gateway-zimswitch/#files-reconciliation","title":"Files / Reconciliation","text":"<ul> <li>Consume settlement/return files delivered by processor; normalize to <code>StatementLine</code> and emit <code>recon.statement.ingested</code></li> </ul>"},{"location":"10-components/rail-gateway-zimswitch/#data-model","title":"\ud83d\uddc4 Data Model","text":"<ul> <li>table: <code>zimswitch_ops</code></li> <li><code>id</code> (pk), <code>transferId</code>, <code>tenantId</code>, <code>acquirerId</code>, <code>merchantId</code>, <code>terminalId</code></li> <li><code>acqRef</code>, <code>authCode</code>, <code>panBin</code>, <code>amountMinor</code>, <code>currency</code></li> <li><code>status</code> (INIT|ACCEPTED|CAPTURED|SETTLED|RETURNED|FAILED)</li> <li><code>isoFields</code> (json redacted), <code>resultCode</code>, <code>reasonCode</code></li> <li><code>createdAt</code>, <code>updatedAt</code></li> <li>table: <code>outbox_gateway</code></li> <li>blob: request/response artifacts, settlement files (encrypted)</li> </ul>"},{"location":"10-components/rail-gateway-zimswitch/#transform-validation","title":"\ud83d\udd01 Transform &amp; Validation","text":"<ul> <li>BIN routing via Directory: ensure card BIN is allowed and mapped to correct acquirer.</li> <li>Currency rules per merchant/acquirer (ZWL/ZAR/USD); enforce decimal places.</li> <li>ISO fields discipline:</li> <li>F2 PAN \u2192 token/surrogate only (never store PAN)</li> <li>F3 Processing Code \u2192 map from intent (00 purchase, 20 refund, etc.)</li> <li>F4 Amount \u2192 minor units</li> <li>F22 POS Entry Mode (tap-on-phone vs ecom), F25 POS Condition Code</li> <li>F55 EMV data when present</li> <li>3DS/CVM: pass-through checks; reject inconsistent combinations.</li> <li>Idempotency: include <code>{tenantId}:{transferId}</code> in merchant reference; de-dupe repeats.</li> </ul>"},{"location":"10-components/rail-gateway-zimswitch/#sequence-tap-on-phone-purchase","title":"\ud83d\udcd0 Sequence (Tap-on-Phone Purchase)","text":"<pre><code>sequenceDiagram\n  participant CTS as Canonical Transfer Service\n  participant GW as Zimswitch Gateway\n  participant PROC as Processor/OPPWA\n  participant RECON as Reconciliation\n\n  CTS-&gt;&gt;GW: transfers.submitted.zimswitch\n  GW-&gt;&gt;GW: validate + build request (ISO fields)\n  GW-&gt;&gt;PROC: submit payment\n  PROC--&gt;&gt;GW: auth approved { acqRef, authCode }\n  GW--&gt;&gt;CTS: transfers.accepted\n  RECON--&gt;&gt;GW: daily settlement file\n  GW--&gt;&gt;CTS: transfers.settled { settlementDate, batchId }</code></pre>"},{"location":"10-components/rail-gateway-zimswitch/#failure-modes","title":"\ud83d\udea8 Failure Modes","text":"<ul> <li>BIN not allowed / unknown member \u2192 fail fast (routing)</li> <li>Decline \u2192 emit <code>transfers.failed</code> with mapped reason</li> <li>Chargeback/return (T+N) \u2192 from settlement files/webhooks \u2192 emit <code>transfers.returned</code></li> <li>Webhook signature mismatch \u2192 reject and alert</li> <li>File ingest failure \u2192 pause recon pipeline; reprocess from last checkpoint</li> </ul>"},{"location":"10-components/rail-gateway-zimswitch/#observability","title":"\ud83d\udcca Observability","text":"<ul> <li>Metrics: approval rate, latency, returns rate, recon match %</li> <li>Error buckets by ISO result/return codes</li> <li>DLQ sizes for webhooks and file ingests</li> </ul>"},{"location":"10-components/rail-gateway-zimswitch/#security","title":"\ud83d\udd10 Security","text":"<ul> <li>PCI containment in gateway; no PAN or full track data persisted</li> <li>Tokenization only; redact EMV tags except whitelisted fields</li> <li>Encrypt artifacts and settlement files at rest</li> <li>Rotate webhook/file-transfer credentials regularly</li> </ul>"},{"location":"10-components/rail-gateway-zimswitch/#config","title":"\u2699\ufe0f Config","text":"<ul> <li>Processor endpoints, per-merchant credentials</li> <li><code>WEBHOOK_SECRET</code>, <code>FILE_PULL_SCHEDULE</code></li> <li><code>CURRENCY_ALLOWLIST</code>, <code>BIN_ALLOWLIST</code></li> <li><code>REASON_CODE_MAP</code>, <code>ISO_FIELD_WHITELIST</code></li> </ul>"},{"location":"10-components/rail-gateway-zimswitch/#runbooks","title":"\ud83e\udded Runbooks","text":"<ul> <li>Approval rate drop: check acquirer status, BIN routing config, risk engine flags</li> <li>Recon mismatches: inspect mapping keys (acqRef, authCode, amount/date window)</li> <li>Return spike: analyze reason codes; notify CTS to throttle high-risk merchants</li> </ul> <p>See also: Rail Gateway \u2014 Template and Reason Code mappings in ../20-specs/error-codes.md</p>"},{"location":"10-components/reconciliation-returns/","title":"Reconciliation &amp; Returns Service","text":"<p>The Reconciliation &amp; Returns Service ensures Stalela\u2019s books stay aligned with rail statements and handles disputes/returns as first-class flows.</p>"},{"location":"10-components/reconciliation-returns/#purpose","title":"\ud83c\udfaf Purpose","text":"<ul> <li>Ingest statements/settlement files from rails.  </li> <li>Match against canonical transfers.  </li> <li>Emit settlement or return events.  </li> <li>Queue unmatched items for operator review.  </li> <li>Model returns/disputes as state transitions.</li> </ul>"},{"location":"10-components/reconciliation-returns/#responsibilities","title":"\ud83d\udee0 Responsibilities","text":"<ul> <li>Scheduled pull/ingest of rail statements (files, APIs, on-chain events).  </li> <li>Normalize to internal <code>StatementLine</code> model.  </li> <li>Match to existing transfers (composite keys).  </li> <li>Emit <code>transfers.settled</code> (late confirm) or <code>transfers.returned</code>.  </li> <li>Push unmatched \u2192 exception queue for Operator Console.  </li> <li>Support manual raise of returns.</li> </ul>"},{"location":"10-components/reconciliation-returns/#interfaces","title":"\ud83d\udd0c Interfaces","text":""},{"location":"10-components/reconciliation-returns/#events-consume","title":"Events (consume)","text":"<ul> <li><code>recon.statement.ingested</code></li> </ul>"},{"location":"10-components/reconciliation-returns/#events-emit","title":"Events (emit)","text":"<ul> <li><code>transfers.settled</code> </li> <li><code>transfers.returned</code> </li> <li><code>recon.exception.opened</code> </li> </ul>"},{"location":"10-components/reconciliation-returns/#http","title":"HTTP","text":"<ul> <li><code>POST /returns</code> (manual raise)  </li> <li>Admin: <code>GET /live</code>, <code>GET /ready</code>, <code>GET /metrics</code>, <code>GET /version</code></li> </ul>"},{"location":"10-components/reconciliation-returns/#data-model","title":"\ud83d\uddc4 Data Model","text":"<ul> <li><code>statements</code> (rail, fileId, source, importedAt)  </li> <li><code>statement_lines</code> (id, statementId, externalRef, amount, currency, date, type, reason?)  </li> <li>Matching keys (per rail) typically include: <code>{ externalRef | (acqRef,authCode) | txId } + amount + date window</code>.  </li> <li><code>matches</code> (lineId, transferId, matchedAt)  </li> <li><code>exceptions</code> (id, lineId, status, resolvedAt, operatorId?)  </li> <li><code>outbox_recon</code> </li> </ul>"},{"location":"10-components/reconciliation-returns/#file-specifications-per-rail","title":"\ud83d\udcc4 File Specifications (per rail)","text":"<ul> <li>EFT (Bankserv): settlement and return record layouts, cutoffs, T+N windows.</li> <li>PayShap: real-time exceptions/returns mapping to <code>StatementLine</code>.</li> <li>ZIPIT/RTGS: daily statements and chargeback reason codes.</li> </ul>"},{"location":"10-components/reconciliation-returns/#sequence","title":"\ud83d\udcd0 Sequence","text":"<pre><code>sequenceDiagram\n  participant R as Reconciliation\n  participant Rail as Rail Source\n  participant CTS\n  participant L as Ledger\n\n  Rail--&gt;&gt;R: daily statement file\n  R-&gt;&gt;R: normalize lines\n  R--&gt;&gt;CTS: transfers.settled (if not yet settled)\n  R--&gt;&gt;CTS: transfers.returned (if return/chargeback)\n  R--&gt;&gt;CTS: recon.exception.opened (if unmatched)\n  CTS-&gt;&gt;L: post reversals / settlements\n  Note over CTS,L: Ledger applies Posting Rules to reverse prior settled entries</code></pre>"},{"location":"10-components/reconciliation-returns/#failure-modes","title":"\ud83d\udea8 Failure Modes","text":"<ul> <li>File ingest failed \u2192 pause, retry, operator alert.  </li> <li>Hash mismatch \u2192 reject, re-request file.  </li> <li>High unmatched rate \u2192 escalate ops, inspect Directory/CTS config.  </li> </ul>"},{"location":"10-components/reconciliation-returns/#observability","title":"\ud83d\udcca Observability","text":"<ul> <li>Metrics: match rate, unmatched backlog, return rates.  </li> <li>Logs: structured with transferId, lineId, fileId.  </li> </ul>"},{"location":"10-components/reconciliation-returns/#security","title":"\ud83d\udd10 Security","text":"<ul> <li>Encrypt raw statement files.  </li> <li>Least privilege on file source credentials.  </li> </ul>"},{"location":"10-components/reconciliation-returns/#runbooks","title":"\ud83e\udded Runbooks","text":"<ul> <li>Unmatched backlog \u2192 operator assigns manually.  </li> <li>High return rate \u2192 throttle merchant, investigate risk.  </li> <li>File delivery gap \u2192 contact partner, reconcile manually.  </li> </ul>"},{"location":"10-components/regulatory-reporting/","title":"Regulatory Reporting Service","text":"<p>Purpose Prepare and submit statutory reports (BoP, goAML) for ZA/ZW; manage schedules, receipts, and retries.</p>"},{"location":"10-components/regulatory-reporting/#responsibilities","title":"Responsibilities","text":"<ul> <li>Aggregate required data from events/services.  </li> <li>Build BoP files/API payloads and goAML STR/CTR submissions.  </li> <li>Manage submission windows, retries, and DLQs.  </li> <li>Store immutable receipts and audit logs.</li> </ul>"},{"location":"10-components/regulatory-reporting/#interfaces","title":"Interfaces","text":""},{"location":"10-components/regulatory-reporting/#inputs","title":"Inputs","text":"<ul> <li>Events: <code>transfers.*</code> (as needed), ledger postings (read-only API).  </li> <li>Internal reads: CTS/Ledger/Compliance summaries.</li> </ul>"},{"location":"10-components/regulatory-reporting/#outputs","title":"Outputs","text":"<ul> <li>Files/APIs: BoP to SARB authorized dealer; goAML to FIC/FIU.  </li> <li>Events: <code>reg.submission.created</code>, <code>reg.submission.acknowledged</code>, <code>reg.submission.failed</code>.</li> </ul>"},{"location":"10-components/regulatory-reporting/#data-model","title":"Data Model","text":"<ul> <li><code>reg_submissions</code> (id, type, scope, payloadRef, status, submittedAt, receiptRef).  </li> <li><code>outbox_reg</code> for event emission.  </li> <li>Artifacts: encrypted payloads and receipts.</li> </ul>"},{"location":"10-components/regulatory-reporting/#runbooks","title":"Runbooks","text":"<ul> <li>Submission failure: retry with backoff; escalate per contact matrix.  </li> <li>Corrections: T+1 resubmission referencing prior filing.  </li> </ul>"},{"location":"10-components/regulatory-reporting/#security","title":"Security","text":"<ul> <li>Least privilege to source systems; encrypt at rest; PII minimization in artifacts.  </li> <li>Access controlled endpoints for manual replay.</li> </ul>"},{"location":"10-components/woocommerce/","title":"WooCommerce \u2194\ufe0f Stalela CTS Plugin (USDC Example)","text":"<p>This document describes a production\u2011ready WooCommerce plugin that connects a merchant\u2019s store to Stalela\u2019s Canonical Transfer Service (CTS) to accept USDC (AVAX) payments. It covers integration flows, mapping, idempotency, and operational concerns with Mermaid diagrams.</p>"},{"location":"10-components/woocommerce/#1-objectives","title":"1) Objectives","text":"<ul> <li>Let WooCommerce merchants accept USDC at checkout using Stalela CTS.</li> <li>Keep the storefront UX native (Woo buttons, order notes, refunds) while offloading payment orchestration to CTS.</li> <li>Ensure idempotency, observability, and clear failure handling.</li> </ul>"},{"location":"10-components/woocommerce/#2-highlevel-architecture","title":"2) High\u2011Level Architecture","text":"<pre><code>flowchart LR\n  subgraph Shopper\n    U[Customer Browser]\n  end\n\n  subgraph Woo[Merchant WooCommerce]\n    WC[WooCore + Orders]\n    P[Stalela Payment Gateway Plugin]\n    WH[Woo REST Webhooks]\n  end\n\n  subgraph Stalela\n    API[CTS API]\n    BUS[events.transfers.*]\n    GW[USDC Gateway]\n  end\n\n  U --&gt;|\"Checkout: Place Order\"| WC\n  WC --&gt; P\n  P --&gt;|\"POST /transfers (Idempotency-Key)\"| API\n  API --&gt;|\"events.transfers.submitted.usdc\"| BUS\n  BUS --&gt; GW\n  GW --&gt;|\"accepted/settled\"| BUS\n  BUS --&gt;|\"webhook callback\"| WH\n  WH --&gt;|\"update order meta/status\"| WC\n</code></pre>"},{"location":"10-components/woocommerce/#3-checkout-sequence-happy-path-nonblocking-settlement","title":"3) Checkout Sequence (Happy Path, non\u2011blocking settlement)","text":"<pre><code>sequenceDiagram\n  autonumber\n  participant U as Shopper\n  participant WC as WooCommerce\n  participant P as Stalela Plugin\n  participant API as CTS/API\n  participant BUS as EventBus\n  participant GW as Gateway(USDC)\n  participant WH as Woo Webhook Endpoint\n\n  U-&gt;&gt;WC: Place order (payment method = Stalela USDC)\n  WC-&gt;&gt;P: on_payment_process(order)\n  Note over P: Build canonical request + Idempotency-Key\n  P-&gt;&gt;API: POST /transfers {Idempotency-Key}\n  API--&gt;&gt;P: 201 {transferId, state: SUBMITTED}\n  P-&gt;&gt;WC: mark order as \"on-hold\" (awaiting crypto payment)\n  API-&gt;&gt;BUS: emit transfers.submitted.usdc (async)\n  BUS-&gt;&gt;GW: deliver submitted.usdc\n  GW-&gt;&gt;BUS: events.transfers.accepted\n  BUS-&gt;&gt;WH: POST /wc/storo/webhook {accepted}\n  WH-&gt;&gt;WC: add order note \"Payment accepted\"\n  GW-&gt;&gt;BUS: events.transfers.settled\n  BUS-&gt;&gt;WH: POST /wc/storo/webhook {settled}\n  WH-&gt;&gt;WC: set status \"processing\" (or \"completed\")\n  WH--&gt;&gt;U: Thank\u2011you page reflects paid</code></pre> <p>Key points</p> <ul> <li>The plugin returns the shopper immediately after CTS persists &amp; returns <code>SUBMITTED</code>.</li> <li>Order remains On\u2011Hold until <code>accepted</code>/<code>settled</code> webhook updates it.</li> </ul>"},{"location":"10-components/woocommerce/#4-data-mapping-woo-cts","title":"4) Data Mapping (Woo \u2194\ufe0f CTS)","text":"Woo Source CTS Target Notes <code>order_id</code> <code>externalRef</code> Stable reference from Woo to CTS <code>order_total</code> <code>amount.value</code> / <code>amount.currency</code> Currency can be <code>USD</code> for USDC 1:1; FX rules configurable <code>billing_email</code>/<code>user_id</code> <code>payer</code> PII encrypted server\u2011side; plugin sends IDs, not PII, when possible Merchant USDC dest (wallet/tenant) <code>payee</code> Provisioned during plugin onboarding <code>Idempotency-Key</code> Header + <code>bodyHash</code> e.g., <code>woocommerce:&lt;storeId&gt;:order:&lt;orderId&gt;</code> <code>payment_method_title</code> <code>metadata.gateway</code> e.g., <code>storo-usdc</code> <p>Canonical request (example)</p> <pre><code>{\n  \"tenantId\": \"tnt_demo\",\n  \"intent\": \"PUSH\",\n  \"amount\": { \"value\": \"49.99\", \"currency\": \"USD\" },\n  \"payer\": { \"type\": \"WALLET\", \"id\": \"shopper-123\" },\n  \"payee\": { \"type\": \"WALLET\", \"provider\": \"USDC_AVAX\", \"id\": \"0xMERCHANT...\" },\n  \"externalRef\": \"woo_100045\",\n  \"metadata\": { \"platform\": \"woocommerce\", \"plugin_version\": \"1.0.0\" }\n}\n</code></pre>"},{"location":"10-components/woocommerce/#5-plugin-components","title":"5) Plugin Components","text":"<pre><code>graph TD\n  subgraph Plugin\n    H[\"Settings UI (Admin)\"]\n    G[\"Gateway Class (WC_Payment_Gateway)\"]\n    C[\"Client (CTS SDK)\"]\n    W[\"Webhook Controller\"]\n    I[\"Idempotency Service\"]\n    L[\"Logger/Telemetry\"]\n  end\n  H --&gt; G\n  G --&gt; I\n  G --&gt; C\n  W --&gt; G\n  G --&gt; L\n  W --&gt; L\n</code></pre> <p>Responsibilities</p> <ul> <li>Settings UI: API keys, merchant wallet, network (AVAX), test mode, webhook secret.</li> <li>Gateway Class: Implements <code>process_payment</code>, order status transitions, thank\u2011you handling.</li> <li>CTS Client: Retries, timeouts, schema version header, <code>Idempotency-Key</code>.</li> <li>Webhook Controller: Verifies signature; updates order status on <code>accepted</code>/<code>settled</code>/<code>returned</code>/<code>failed</code>.</li> <li>Idempotency Service: Stable key generation + replay safety on Woo retries.</li> <li>Logger: Structured logs with <code>order_id</code>, <code>transferId</code>, <code>tenantId</code> (no PII fields).</li> </ul>"},{"location":"10-components/woocommerce/#6-order-state-machine-woo-cts","title":"6) Order State Machine (Woo + CTS)","text":"<pre><code>stateDiagram-v2\n  [*] --&gt; PENDING\n  PENDING --&gt; ON_HOLD: CTS POST 201 (SUBMITTED)\n  ON_HOLD --&gt; PROCESSING: webhook accepted/settled\n  PROCESSING --&gt; COMPLETED: fulfillment done\n  ON_HOLD --&gt; FAILED: webhook failed/returned\n  PENDING --&gt; FAILED: validation/compliance deny\n  COMPLETED --&gt; [*]\n  FAILED --&gt; [*]</code></pre> <p>Notes</p> <ul> <li>If <code>accepted</code> arrives first, move to Processing, then to Completed on <code>settled</code>.</li> <li>If <code>returned/failed</code>, move to Failed and expose reason in order notes.</li> </ul>"},{"location":"10-components/woocommerce/#7-webhook-contract-from-stalela-woo","title":"7) Webhook Contract (from Stalela \u2192 Woo)","text":"<p>Endpoint: <code>POST https://merchant.store/wc/storo/webhook</code></p> <p>Headers: <code>X-Stalela-Signature</code>, <code>X-Stalela-Timestamp</code>, <code>X-Request-Id</code></p> <p>Body (accepted)</p> <pre><code>{\n  \"type\": \"events.transfers.accepted\",\n  \"transferId\": \"tr_123\",\n  \"externalRef\": \"woo_100045\",\n  \"occurredAt\": \"2025-08-28T12:34:56Z\",\n  \"envelope\": {\"v\":1},\n  \"metadata\": {\"rail\":\"usdc\"}\n}\n</code></pre> <p>Body (settled) is identical with <code>type = events.transfers.settled</code>.</p> <p>Webhook handler behavior</p> <ol> <li>Verify signature \u2192 401 if invalid.</li> <li>Lookup <code>order_id</code> via <code>externalRef</code>.</li> <li>Idempotent update of order status; add note with timestamp + <code>transferId</code>.</li> </ol>"},{"location":"10-components/woocommerce/#8-usdc-flow-rails-specifics","title":"8) USDC Flow (rails specifics)","text":"<pre><code>flowchart LR\n  P[Plugin] --&gt; API[CTS]\n  API --&gt; OUTBOX[Outbox]\n  OUTBOX --&gt; BUS[events.transfers.submitted.usdc]\n  BUS --&gt; GW[USDC Gateway]\n  GW --&gt;|submit tx on AVAX| CHAIN[(AVAX C-Chain)]\n  CHAIN --&gt; GW\n  GW --&gt; BUS\n  BUS --&gt; WH[Woo Webhook]</code></pre> <ul> <li>Gateway uses a relayer to handle gas; merchant receives USDC on their AVAX address.</li> <li>CTS does not block Woo checkout waiting for settlement.</li> </ul>"},{"location":"10-components/woocommerce/#9-errors-retries","title":"9) Errors &amp; Retries","text":"Situation Source Plugin Behavior Compliance deny CTS sync response 422 Fail payment; order \u2192 Failed; show friendly error Routing unavailable CTS 502 Keep order Pending; show retry button; exponential backoff client\u2011side Webhook missed Network issue Admin action: \u201cRe\u2011deliver last 24h\u201d button; plugin can poll <code>GET /transfers/:id</code> as fallback Duplicate checkout Shopper retries Same Idempotency\u2011Key \u2192 plugin handles 200/201 idempotently"},{"location":"10-components/woocommerce/#10-configuration-onboarding","title":"10) Configuration &amp; Onboarding","text":"<ul> <li>API Keys: Tenant\u2011scoped key from Stalela Console.</li> <li>Merchant Wallet (USDC): Provided during onboarding; validated against network.</li> <li>Webhook Secret: Rotate via plugin UI; validate on each callback.</li> <li>Test Mode: Sandboxed CTS tenant &amp; USDC test network.</li> </ul>"},{"location":"10-components/woocommerce/#11-observability","title":"11) Observability","text":"<ul> <li>Order Notes include transfer lifecycle markers.</li> <li>Admin Dashboard Widget: last 50 events, settlement latency p95, failure counts.</li> <li>Logging: Structured (order_id, transferId, tenantId, type). No PII.</li> </ul>"},{"location":"10-components/woocommerce/#12-example-admin-runbook","title":"12) Example Admin Runbook","text":"<ol> <li>Order stuck On\u2011Hold &gt; 10 min \u2192 check webhook delivery logs.</li> <li>If missing, press Re\u2011deliver in Stalela Console or poll <code>GET /transfers/:id</code>.</li> <li>If <code>returned/failed</code>, contact customer; optionally retry new payment method.</li> </ol>"},{"location":"10-components/woocommerce/#13-security","title":"13) Security","text":"<ul> <li>HMAC\u2011signed webhooks; 5\u2011minute timestamp window.</li> <li>Least\u2011privilege API key; rotate every 90 days.</li> <li>PII never stored in plugin; only references &amp; IDs.</li> </ul>"},{"location":"10-components/woocommerce/#14-future-enhancements","title":"14) Future Enhancements","text":"<ul> <li>Refunds: Map Woo refunds \u2192 <code>transfers.pull</code> or reversal flow.</li> <li>Partial Payments: Split shipments \u2192 multiple transferIds.</li> <li>Multi\u2011rail fallback: If USDC unavailable, offer Zimswitch card or M\u2011Pesa.</li> </ul>"},{"location":"10-mvp/","title":"\ud83d\udce6 Stalela MVP \u2013 Pilot with 20 Merchants","text":""},{"location":"10-mvp/#goal","title":"\ud83c\udfaf Goal","text":"<p>Demonstrate the end-to-end viability of Stalela\u2019s Canonical Transfer Service (CTS) and POS/payment ecosystem in a controlled pilot with 20 merchants. The MVP validates:</p> <ul> <li>Unified transfer orchestration (CTS front-door)</li> <li>USDC-based merchant acceptance (POS / wallet QR)</li> <li>Compliance + routing flows in production conditions</li> <li>Idempotency, event publishing, and state tracking</li> <li>Merchant onboarding, cash-out, and reporting</li> </ul>"},{"location":"10-mvp/#scope","title":"\ud83d\udd11 Scope","text":"<ul> <li> <p>In scope:</p> </li> <li> <p>CTS API (create &amp; fetch transfers)</p> </li> <li>Compliance screening before submission</li> <li>Directory &amp; Routing service integration</li> <li>POS App (Android, QR/NFC) for 20 merchants</li> <li>Merchant Dashboard (basic web + WhatsApp notif)</li> <li>Off-ramp partner (Encryptus/FiveWest) for cash-out</li> <li> <p>Event streaming (<code>transfers.*</code>) into observability</p> </li> <li> <p>Out of scope (future):</p> </li> <li> <p>Card issuance (Visa/Mastercard rails)</p> </li> <li>Advanced inventory module</li> <li>Credit lines/float management</li> </ul>"},{"location":"10-mvp/#architecture-mvp-slice","title":"\ud83c\udfd7 Architecture (MVP slice)","text":"<ul> <li>Clients: Merchant POS app (Sunmi/PAX devices) + Merchant Dashboard</li> <li> <p>Core: Canonical Transfer Service (CTS)</p> </li> <li> <p>Deduplication + normalization</p> </li> <li>Pre-screening (Compliance)</li> <li>Routing (Directory)</li> <li>Outbox pattern for event publishing</li> <li>Rails: USDC over AVAX chain (custodial wallets, relayer)</li> <li>Partners: Encryptus API for fiat cash-out</li> <li>Observability: metrics (latency, transfer states), logs, tracing</li> </ul> <pre><code>flowchart LR\n    POS[Merchant POS/QR] --&gt; |POST /transfers| CTS\n    Dashboard --&gt; |API| CTS\n    CTS --&gt; |Screen| Compliance\n    CTS --&gt; |Route| Directory\n    CTS --&gt; |Emit events| Outbox --&gt; EventBus\n    CTS --&gt; |Submit USDC tx| AVAX\n    AVAX --&gt; |Confirm| CTS\n    CTS --&gt; |Cash-out| OffRamp[Encryptus/FiveWest]\n    EventBus --&gt; Observability</code></pre>"},{"location":"10-mvp/#merchant-pilot-experience","title":"\ud83d\udcf2 Merchant Pilot Experience","text":"<ul> <li>20 merchants onboarded with custodial USDC wallets.</li> <li>Accept customer payments via QR or NFC.</li> <li>Merchant app shows real-time settlement state (<code>INITIATED \u2192 SUBMITTED \u2192 SETTLED</code>).</li> <li> <p>Option to:</p> </li> <li> <p>Retain USDC for restocking with suppliers.</p> </li> <li>Cash out to ZAR via off-ramp (real-time, small fees).</li> </ul>"},{"location":"10-mvp/#data-model-mvp","title":"\ud83d\uddc4 Data Model (MVP)","text":"<ul> <li><code>transfers</code>, <code>transfer_events</code>, <code>outbox_transfers</code> tables as per CTS design.</li> <li>Merchant registry: <code>{merchantId, walletAddr, POS_deviceId, tenantId}</code>.</li> <li>Off-ramp logs: <code>{merchantId, transferId, fiatAmount, provider}</code>.</li> </ul>"},{"location":"10-mvp/#kpis-for-pilot","title":"\ud83d\udcca KPIs for Pilot","text":"<ul> <li>Throughput: \u2265 100 transfers/day across 20 merchants.</li> <li>Latency: p95 &lt; 2.5s from POS \u2192 state=SUBMITTED.</li> <li>Reliability: \u2265 99% transfers reach SETTLED or FAILED with event trail.</li> <li>Merchant NPS: qualitative feedback on usability, cash-out, reporting.</li> </ul>"},{"location":"10-mvp/#runbook-pilot-specific","title":"\ud83d\udcd8 Runbook (Pilot-Specific)","text":"<ul> <li>If POS device fails \u2192 replace via spare pool (20% buffer).</li> <li>If compliance service down \u2192 fail-safe: reject submissions.</li> <li>If AVAX relayer gas issues \u2192 auto-fund hot wallet from treasury.</li> <li>If off-ramp unavailable \u2192 queue cash-outs, notify merchants.</li> </ul>"},{"location":"10-mvp/#next-steps-after-pilot","title":"\ud83d\ude80 Next Steps after Pilot","text":"<ol> <li>Expand to 100 merchants.</li> <li>Add card issuance (USDC debit card).</li> <li>Layer inventory/B2B module.</li> <li>Explore credit line + float minimization strategy.</li> </ol>"},{"location":"10-payments-nucleus/adr/PAY-ADR-0001-events-outbox/","title":"ADR-0001: Outbox Pattern Mandatory","text":"<p>Status: Accepted Date: 2025-08-26</p>"},{"location":"10-payments-nucleus/adr/PAY-ADR-0001-events-outbox/#context","title":"Context","text":"<p>Stalela is an event-driven system. Each service must emit domain events when its state changes (e.g., <code>transfers.submitted</code>, <code>ledger.balance.updated</code>). We need to guarantee exactly-once delivery of these events despite crashes, retries, or network failures.</p> <p>Na\u00efve approaches (publishing to the bus inside app logic) risk double-emits, message loss, or divergence between DB state and events.</p>"},{"location":"10-payments-nucleus/adr/PAY-ADR-0001-events-outbox/#decision","title":"Decision","text":"<p>Every service must implement the Outbox pattern:</p> <ul> <li>State change + outbox row are persisted in the same database transaction.  </li> <li>A background dispatcher process reads the outbox table and publishes events to the bus (SNS/SQS).  </li> <li>Consumers are idempotent (dedupe by <code>eventId</code> and <code>transferId+state</code>).  </li> <li>Failed publishes are retried with exponential backoff.  </li> <li>DLQ (dead-letter queue) captures poison events.  </li> </ul>"},{"location":"10-payments-nucleus/adr/PAY-ADR-0001-events-outbox/#consequences","title":"Consequences","text":"<ul> <li>Strong delivery semantics: events are published exactly once if possible, at least once otherwise, never zero.  </li> <li>Event consumers may see duplicates, so idempotency is required.  </li> <li>Storage overhead: each service maintains its own outbox table.  </li> <li>Operationally: requires monitoring dispatch lag, DLQ size, and retries.  </li> </ul>"},{"location":"10-payments-nucleus/adr/PAY-ADR-0001-events-outbox/#alternatives-considered","title":"Alternatives Considered","text":"<ul> <li>Two-phase commit with DB + broker \u2192 rejected (complex, brittle).  </li> <li>\"Best effort\" publish outside txn \u2192 rejected (event loss possible).  </li> </ul> <p>Next Steps: - Scaffold outbox table schema in <code>platform-base</code>. - Provide Go lib for services to use out-of-the-box (insert, dispatch, metrics).  </p>"},{"location":"10-payments-nucleus/adr/PAY-ADR-0002-double-entry-ledger/","title":"ADR-0002: Ledger is Double-Entry and Append-Only","text":"<p>Status: Accepted Date: 2025-08-26</p>"},{"location":"10-payments-nucleus/adr/PAY-ADR-0002-double-entry-ledger/#context","title":"Context","text":"<p>Stalela must provide an authoritative record of money movement across rails. Financial correctness requires:</p> <ul> <li>Balances that always reconcile.  </li> <li>Auditability of every change.  </li> <li>Ability to reverse but never delete.  </li> </ul>"},{"location":"10-payments-nucleus/adr/PAY-ADR-0002-double-entry-ledger/#decision","title":"Decision","text":"<p>The Ledger Service is a strict double-entry, append-only system:</p> <ul> <li>Every posting is a pair: debit one account, credit another, amounts equal.  </li> <li>Postings are immutable. Reversals are represented as new entries.  </li> <li>Balances are derived from postings (materialized views are allowed).  </li> <li>Accounts include User, Merchant, Liquidity, Fees, FX, Settlement, Reserves.  </li> <li>Ledger consumes events (accepted, settled, returned) and applies posting rules.  </li> </ul>"},{"location":"10-payments-nucleus/adr/PAY-ADR-0002-double-entry-ledger/#consequences","title":"Consequences","text":"<ul> <li>Strong audit trail. No hidden state.  </li> <li>Easy reconciliation with external statements.  </li> <li>Slightly more complex reversal flows (explicit contra postings).  </li> <li>Storage grows unbounded (mitigated with archiving, partitioning).  </li> </ul>"},{"location":"10-payments-nucleus/adr/PAY-ADR-0002-double-entry-ledger/#alternatives-considered","title":"Alternatives Considered","text":"<ul> <li>Single-entry balances updated in place \u2192 rejected (non-auditable, error-prone).  </li> <li>Event-sourcing without explicit double-entry \u2192 rejected (money truth must be explicit).  </li> </ul> <p>Next Steps: - Define posting rules in <code>20-specs/posting-rules.md</code>. - Provide Go lib for posting validation (debits == credits).  </p>"},{"location":"10-payments-nucleus/adr/PAY-ADR-0003-contracts-first/","title":"ADR-0003: Contracts-First via storo-specs Repo","text":"<p>Status: Accepted Date: 2025-08-26</p>"},{"location":"10-payments-nucleus/adr/PAY-ADR-0003-contracts-first/#context","title":"Context","text":"<p>Multiple services (CTS, gateways, ledger, compliance) need to interoperate. To avoid coupling and drift, we must define shared contracts (events, APIs) in a single source of truth.</p> <p>Moov\u2019s practice and our nucleus design both point to contract-first development.  </p>"},{"location":"10-payments-nucleus/adr/PAY-ADR-0003-contracts-first/#decision","title":"Decision","text":"<p>We establish a dedicated repo: storo-specs. It will contain:</p> <ul> <li>Event Schemas (JSON Schema) for all domain events.  </li> <li>API Definitions (OpenAPI/Swagger) for HTTP APIs (e.g., CTS).  </li> <li>Golden Fixtures (JSON) for canonical test cases.  </li> <li>Codegen scripts to publish:  </li> <li>Go structs/validators \u2192 <code>github.com/storo/specs-go</code> </li> <li>TS types/clients \u2192 <code>@storo/specs</code> (npm)</li> </ul> <p>Services must pin to tagged releases of <code>storo-specs</code> and validate at CI.  </p>"},{"location":"10-payments-nucleus/adr/PAY-ADR-0003-contracts-first/#consequences","title":"Consequences","text":"<ul> <li>Ensures consistency: all services emit/consume the same event shapes.  </li> <li>Enables language-agnostic clients (Go + TS at minimum).  </li> <li>Introduces one more repo to manage.  </li> <li>Requires discipline around versioning and compatibility (semver).  </li> </ul>"},{"location":"10-payments-nucleus/adr/PAY-ADR-0003-contracts-first/#alternatives-considered","title":"Alternatives Considered","text":"<ul> <li>Duplicating schemas in each repo \u2192 rejected (guaranteed drift).  </li> <li>Informal \u201cREADME spec\u201d \u2192 rejected (non-machine-verifiable).  </li> </ul> <p>Next Steps: - Scaffold <code>storo-specs</code> with <code>events/</code>, <code>api/</code>, <code>fixtures/</code>. - Add CI to validate schemas + generate Go/TS packages. - Update service templates to import from <code>storo-specs</code>.  </p>"},{"location":"10-payments-nucleus/components/canonical-transfer-service/","title":"Canonical transfer service","text":""},{"location":"10-payments-nucleus/components/canonical-transfer-service/#canonical-transfer-service-cts-system-design-document","title":"Canonical Transfer Service (CTS) \u2014 System Design Document","text":"<p>The Canonical Transfer Service (CTS) is the front door and conductor of Stalela. It provides a single API for creating and managing transfers, normalizes requests into a canonical format, enforces idempotency, screens entities, routes transfers, and emits domain events.</p>"},{"location":"10-payments-nucleus/components/canonical-transfer-service/#1-introduction","title":"1. Introduction","text":"<ul> <li>Purpose: Define an actionable, auditable, and operable System Design for CTS.</li> <li>Scope: CTS handles submission and tracking of transfers; it does not execute rail-specific protocols directly, compute ledger postings, or perform KYC\u2014those are delegated to Gateways, Ledger, and Compliance.</li> <li>Audience: Backend engineers, SRE/Platform, Security/Compliance, Product.</li> </ul>"},{"location":"10-payments-nucleus/components/canonical-transfer-service/#2-background-context","title":"2. Background &amp; Context","text":"<ul> <li>Multi-tenant, regulated data, event-driven architecture with transactional outbox and eventual consistency for downstream consumers.</li> <li>CTS upstream: clients/integrators. Downstream: Compliance, Directory &amp; Routing, Rail Gateways, Ledger (via events), Observability stack.</li> </ul> <p>Mermaid Context (C4 Level 1) <pre><code>graph TD\n  subgraph Clients\n    A[Client Apps / Integrators]\n  end\n\n  subgraph Stalela Core\n    B[CTS API]\n    C[Compliance Service]\n    D[Directory &amp; Routing]\n    E[Rail Gateways]\n    F[Ledger Service]\n    G[(OLTP DB)]\n    H[[Event Bus]]\n    I[[Observability: Metrics/Logs/Tracing]]\n  end\n\n  A -- HTTPS sync --&gt; B\n  B -- screen sync --&gt; C\n  B -- route sync --&gt; D\n  B -- persist sync --&gt; G\n  B -- events async --&gt; H\n  H -- accepted/settled async --&gt; B\n  H -- postings async --&gt; F\n  B -- telemetry --&gt; I</code></pre></p> <p>Assumptions/Constraints - Eventual consistency for downstream consumers; synchronous path returns latest known state. - Per-tenant authentication and authorization. - Exactly-once event publishing via transactional outbox. - PII encrypted at rest; PII exclusion in logs.</p>"},{"location":"10-payments-nucleus/components/canonical-transfer-service/#3-functional-requirements","title":"3. Functional Requirements","text":"<ul> <li>Accept API requests: <code>POST /transfers</code>, <code>GET /transfers</code>, <code>GET /transfers/:id</code>.</li> <li>Deduplicate via idempotency key + request body hash.</li> <li>Validate and normalize into canonical schema.</li> <li>Pre-screen entities with Compliance.</li> <li>Route via Directory &amp; Routing.</li> <li>Persist transfers and lifecycle state.</li> <li>Emit events: <code>transfers.initiated</code>, <code>transfers.submitted.&lt;rail&gt;</code> and consume <code>accepted/settled/returned/failed</code>.</li> </ul> <p>API contracts (summary)</p> Method Path Required Headers Success Notes POST /transfers Authorization, Idempotency-Key, X-Canonical-Version 201 with resource or 200 on idempotent replay Request validated against canonical model GET /transfers/:id Authorization 200 Returns transfer details + timeline <p>Canonical Request (excerpt) <pre><code>{\n  \"tenantId\": \"tnt_123\",\n  \"intent\": \"PUSH\",\n  \"amount\": { \"value\": \"100.00\", \"currency\": \"USD\" },\n  \"sourceCurrency\": \"USD\",\n  \"targetCurrency\": \"USD\",\n  \"fxStrategy\": \"NOT_APPLICABLE\",\n  \"payer\": { \"type\": \"WALLET\", \"id\": \"payer-abc\" },\n  \"payee\": { \"type\": \"BANK\", \"id\": \"payee-xyz\" },\n  \"railHints\": [\"usdc-algo\"],\n  \"feeModel\": \"STORO_STANDARD\",\n  \"endUserRef\": \"end-user-55\",\n  \"externalRef\": \"client-789\",\n  \"metadata\": { \"purpose\": \"invoice-42\" },\n  \"traceparent\": \"00-4bf92f3577b34da6a3ce929d0e0e4736-00f067aa0ba902b7-00\"\n}\n</code></pre></p>"},{"location":"10-payments-nucleus/components/canonical-transfer-service/#4-non-functional-requirements","title":"4. Non-Functional Requirements","text":"<p>Prod targets</p> Category Target Notes Performance Total p99 \u2264 2.5s; ingress\u2192screen (\u2264800ms), screen\u2192route (\u2264400ms), route\u2192submit (\u22641.5s) Timeouts enforced per integration Availability 99.95% monthly SLO; error budget 21.6m/mo Excludes third-party outages beyond retry budget Throughput Baseline 200 TPS; burst 1,000 TPS (5 min) HPA + queue smoothing Scalability Horizontal scale by stateless API; partition by tenantId/transferId Stickiness not required Security &amp; Privacy OAuth2 client-cred or HMAC per tenant; TLS 1.2+; PII encrypted at rest Logs redact PII Reliability Idempotency (36h TTL); transactional outbox with retries; DLQ Exactly-once publish semantics Compliance/Audit Immutable events; correlation IDs; retention \u2265 7 years (configurable) WORM storage optional <p>Pilot targets (20 merchants, 100 tx/merchant/day \u2248 2k/day)</p> Category Target Notes Performance p95 \u2264 2.5s at \u2264 10 TPS burst Serverless/Lambda timeouts sized accordingly Availability 99.9% monthly SLO Single-region acceptable for pilot Throughput \u2248 0.023 TPS avg (2k/day); bursts \u2264 10 TPS Sized for lunchtime peaks"},{"location":"10-payments-nucleus/components/canonical-transfer-service/#5-architecture-design","title":"5. Architecture &amp; Design","text":"<p>5.1 Container (C4 Level 2) <pre><code>graph TD\n  subgraph CTS\n    API[API Layer / Web]\n    CMD[Command Orchestrator]\n    NORM[Canonical Normalizer]\n    COMP[Compliance Adapter]\n    ROUTE[Routing Adapter]\n    SUB[Submission Publisher]\n    STATE[State Manager]\n    OUTBOX[Outbox Worker]\n    READ[Read Model / Projections]\n    DB[(OLTP DB)]\n  end\n\n  BUS[[Event Bus]]\n  OBS[[Metrics/Logs/Tracing]]\n  GW[Rail Gateways]\n  CMP[Compliance]\n  DIR[Directory &amp; Routing]\n\n  API --&gt; CMD\n  CMD --&gt; NORM\n  CMD --&gt; COMP\n  CMD --&gt; ROUTE\n  CMD --&gt; STATE\n  STATE --&gt; DB\n  SUB --&gt; OUTBOX\n  OUTBOX --&gt; BUS\n  BUS --&gt; STATE\n  API --&gt; READ\n  READ --&gt; DB\n\n  COMP --- CMP\n  ROUTE --- DIR\n  SUB --- GW\n\n  API -. telemetry .-&gt; OBS\n  OUTBOX -. telemetry .-&gt; OBS</code></pre></p> <p>Sync vs Async and Backpressure - Sync: API\u2192Compliance, API\u2192Directory, DB writes. - Async: Outbox\u2192Event Bus\u2192Gateways; inbound events\u2192STATE. - Backpressure: rate limiting at API, bounded outbox worker concurrency, consumer lag alerts.</p> <p>Amount precision and rounding - Store monetary values as <code>NUMERIC(20,8)</code>; define per-currency scale (e.g., USD scale=2). - Rounding mode: bankers rounding (round half to even) when converting to rail decimals. - Validate min/max per currency; reject out-of-range with 400.</p> <p>End-user considerations (double/triple entry) - Each merchant transfer often involves an end user (payer). Model end-user references (<code>endUserRef</code>) in the canonical payload where applicable. - For accounting that affects multiple ledgers (merchant wallet, end-user wallet, fees/taxes), ensure events carry sufficient references to support downstream double/triple-entry postings in the Ledger service. - CTS remains canon/orchestrator and does not compute postings, but must not drop identifiers necessary for downstream accounting integrity.</p> <p>5.2 Component (C4 Level 3) \u2014 Inside CTS <pre><code>graph TD\n  subgraph API Layer\n    R[Request Validation]\n    I[Idempotency Middleware]\n    Q[Rate Limiter]\n  end\n  subgraph Orchestration\n    SAGA[Command Orchestrator Saga]\n    MAP[Canonical Model Normalizer]\n  end\n  subgraph Integrations\n    CBA[Compliance Client CB/Retry]\n    DRC[Directory Client Cache]\n    PUB[Submission Publisher]\n  end\n  subgraph Persistence\n    SM[State Machine]\n    OB[Outbox Table]\n    RM[Read Projections]\n  end\n\n  Q --&gt; I --&gt; R --&gt; SAGA --&gt; MAP\n  SAGA --&gt; CBA\n  SAGA --&gt; DRC\n  SAGA --&gt; SM\n  SM --&gt; OB\n  PUB --&gt; OB\n  RM --&gt; SM\n</code></pre></p> <p>5.3 Sequence Diagrams</p> <p>Happy Path (USDC) \u2014 non-blocking settlement <pre><code>sequenceDiagram\n  autonumber\n  participant Client\n  participant API as CTS/API\n  participant Cmp as Compliance\n  participant Dir as Directory\n  participant DB as CTS/DB\n  participant OB as OutboxWorker\n  participant Bus as EventBus\n  participant GW as Gateway(USDC)\n\n  Client-&gt;&gt;API: POST /transfers {Idempotency-Key, Authorization}\n  API-&gt;&gt;API: validate + canonicalize (hash, X-Canonical-Version)\n  API-&gt;&gt;Cmp: screen(payer,payee) [timeout 800ms, 2x retry]\n  Cmp--&gt;&gt;API: allow\n  API-&gt;&gt;Dir: route(intent, payee) [timeout 400ms]\n  Dir--&gt;&gt;API: rail=usdc, endpoint\n  API-&gt;&gt;DB: begin tx\n  DB--&gt;&gt;API: insert transfer(state=SUBMITTED)\n  DB--&gt;&gt;API: insert outbox(event=submitted.usdc)\n  API--&gt;&gt;DB: commit\n  API--&gt;&gt;Client: 201 Location:/transfers/:id {transferId, state: SUBMITTED, requestId}\n  OB-&gt;&gt;Bus: publish events.transfers.submitted.usdc (exp backoff)\n  Bus--&gt;&gt;GW: deliver\n  GW--&gt;&gt;Bus: events.transfers.accepted\n  Bus--&gt;&gt;API: accepted \u2192 update state\n  GW--&gt;&gt;Bus: events.transfers.settled\n  Bus--&gt;&gt;API: settled \u2192 update projections\n</code></pre></p> <p>Duplicate Submission <pre><code>sequenceDiagram\n  participant Client\n  participant API as CTS/API\n  participant DB as CTS/DB\n  Client-&gt;&gt;API: POST /transfers {Idempotency-Key}\n  API-&gt;&gt;DB: lookup (tenantId, Idempotency-Key, bodyHash)\n  alt match\n    DB--&gt;&gt;API: existing transferId (same hash)\n    API--&gt;&gt;Client: 200 existing resource (etag/version)\n  else conflict\n    DB--&gt;&gt;API: key exists with different hash\n    API--&gt;&gt;Client: 409 IdempotencyConflict { priorTransferId, priorBodyHash }\n  end</code></pre></p> <p>Compliance Deny <pre><code>sequenceDiagram\n  participant Client\n  participant API as CTS/API\n  participant Cmp as Compliance\n  Client-&gt;&gt;API: POST /transfers\n  API-&gt;&gt;Cmp: screen\n  Cmp--&gt;&gt;API: deny(reasonCode)\n  API--&gt;&gt;Client: 422 EntityDenied {reasonCode, requestId}</code></pre></p> <p>Routing Unavailable <pre><code>sequenceDiagram\n  participant Client\n  participant API as CTS/API\n  participant Dir as Directory\n  Client-&gt;&gt;API: POST /transfers\n  API-&gt;&gt;Dir: route\n  note over API,Dir: timeout 400ms, no fallback\n  API--&gt;&gt;Client: 502 RoutingUnavailable {retryAfter: 5s}</code></pre></p> <ul> <li>When Directory reports a closed settlement window (e.g., EFT cutoff), propagate <code>retryAfter</code> aligned with the next open window. Clients must back off until that timestamp; CTS logs the incident for analytics.</li> </ul> <p>Outbox Retry &amp; DLQ <pre><code>sequenceDiagram\n  participant OB as OutboxWorker\n  participant Bus as EventBus\n  OB-&gt;&gt;Bus: publish\n  alt failure\n    OB-&gt;&gt;OB: attempts++ backoff(1s\u21925s\u219230s\u21922m\u219210m\u21921h\u21922h\u21924h\u21928h\u219216h)\n  else success\n    OB-&gt;&gt;OB: mark SENT\n  end\n  note over OB: DLQ after N=10 attempts (poison)</code></pre></p> <p>5.4 State Machine <pre><code>stateDiagram-v2\n  [*] --&gt; INITIATED\n  INITIATED --&gt; SUBMITTED: route ok + persisted\n  SUBMITTED --&gt; ACCEPTED: events.transfers.accepted\n  ACCEPTED --&gt; SETTLED: events.transfers.settled\n  ACCEPTED --&gt; RETURNED: events.transfers.returned\n  SUBMITTED --&gt; FAILED: submission failed (non-retryable)\n  INITIATED --&gt; FAILED: validation/compliance deny\n  SETTLED --&gt; [*]\n  RETURNED --&gt; [*]\n  FAILED --&gt; [*]</code></pre></p> <p>5.5 Data Flow <pre><code>flowchart LR\n  Ingress[HTTP Ingress] --&gt; Validate[Validate/Normalize]\n  Validate --&gt; Persist[Persist Write Model]\n  Persist --&gt; Outbox[Write Outbox]\n  Outbox --&gt; Bus[Event Bus]\n  Bus --&gt; Proj[Read Model Projections]\n Proj --&gt; API[List &amp; Detail Reads]</code></pre></p> <p>Read-model list semantics - Backed by a denormalized <code>transfer_summaries</code> projection populated from lifecycle events and command writes. - Cursor pagination uses <code>(tenantId, createdAt DESC, transferId)</code> encoded inside <code>pageToken</code> to avoid skipping rows during concurrent inserts. - Filters: <code>state[]</code>, <code>intent[]</code>, <code>rail[]</code>, <code>fxStrategy[]</code>, <code>createdAtFrom/To</code>, <code>updatedAtFrom/To</code>, <code>externalRef</code>, <code>endUserRef</code>; default window capped to 90 days of hot storage. - Response omits encrypted payer/payee blobs; only stable references (<code>payerRef</code>, <code>payeeRef</code>) and operational metadata are exposed. - Consistency: eventual\u2014projections catch up within seconds; POST/GET-by-id remain the authoritative source immediately after writes. - Authorization and throttling enforced per-tenant; list endpoint has stricter rate limits to protect OLTP workloads.</p> <p>5.6 Deployment View <pre><code>graph TD\n  subgraph k8s-cluster\n    apiPod[cts-api Deployment]\n    obPod[cts-outbox Worker]\n    sidecar[otel sidecar]\n  end\n  hpa[HPA policy: target 70% CPU/qps]\n  db[(Primary/Replica OLTP DB)]\n  topics[[SNS FIFO Topic: events.transfers.fifo]]\n  secrets[[Secrets Manager]]\n  envoy[[Envoy/Ingress]]\n\n  envoy --&gt; apiPod\n  apiPod --&gt; db\n  obPod --&gt; db\n  apiPod --&gt; topics\n  obPod --&gt; topics\n  apiPod --&gt; sidecar\n  obPod --&gt; sidecar\n  apiPod --&gt; secrets\n  obPod --&gt; secrets\n  hpa -.-&gt; apiPod\n  hpa -.-&gt; obPod\n</code></pre></p> <p>5.7 Key Design Topics (ADR-style)</p> Topic Decision Alternatives Rationale Consequences Idempotency <code>Idempotency-Key</code> + SHA256(normalized body) unique per tenant; TTL 36h Key-only; body-only Prevents divergent bodies on same key; aligns with retention window Store hash; shard hot tenants Outbox Pattern Same-DB transactional outbox; ordered per <code>transferId</code>; backoff 1s\u21925s\u219230s\u21922m\u219210m\u21921h\u21922h\u21924h\u21928h\u219216h; DLQ at 10 Dedicated streaming bus (Kafka) Simpler atomicity; avoids dual-write Worker lag can grow \u2192 monitor/autoscale Routing AI-assisted dynamic policies + cache TTL 5m; negative cache 45s; deterministic fallback library Longer TTL Real-time optimization with safe degradation paths Requires continuous model evaluation Multitenancy Row-level scope by <code>tenantId</code>; per-tenant quotas; per-tenant secrets DB schemas per tenant Simpler ops; shared pool Strong tenancy guard required Schema Evolution Canonical SemVer; <code>X-Canonical-Version</code>; events <code>envelope.v</code> (BACKWARD) Ad-hoc Predictable upgrades Maintain registry and migrations Consistency Non-blocking settlement; POST 201/200 with <code>state=SUBMITTED</code> + Location Synchronous settlement Lower latency; simpler SLAs Clients must poll/subscribe Concurrency (OCC) <code>transfers.version</code> BIGINT; <code>WHERE transferId AND version</code>; bump version Pessimistic locks Avoids locks; suits serverless 409s/retries on conflicts Observability W3C traceparent; metrics by <code>tenantId</code>,<code>rail</code>,<code>state</code>; PII-safe logs None Traceability and SLOs Watch label cardinality Backpressure Token-bucket per tenant; bounded workers; circuit breakers Unlimited Protects core systems Graceful shedding under load Error Taxonomy 4xx (validation/deny), 409 (idempotency/OCC), 429 (rate limits), 5xx (internal/502 routing) Loose mapping Clear client behavior Easier debugging and SLAs"},{"location":"10-payments-nucleus/components/canonical-transfer-service/#intelligent-orchestration-engine","title":"Intelligent Orchestration Engine","text":"<p>Stalela CTS now supports programmable orchestration logic that can dynamically evaluate, score, and select optimal payment rails based on:</p> <ul> <li>Settlement speed</li> <li>Total transaction cost (incl. FX, intermediary fees)</li> <li>Identity compliance score</li> <li>Rail health status</li> <li>User preferences and behavioral context</li> </ul> <p>This decisioning is powered by embedded AI agents, which operate as pluggable functions in the orchestration pipeline.</p>"},{"location":"10-payments-nucleus/components/canonical-transfer-service/#integration-model","title":"Integration Model","text":"<pre><code>flowchart TD\n    Intent[Payment Intent] --&gt; CTS\n    CTS --&gt; AI_Route\n    AI_Route --&gt; Directory\n    Directory --&gt; Routing\n    Routing --&gt; Transfer</code></pre>"},{"location":"10-payments-nucleus/components/canonical-transfer-service/#routing-policies","title":"Routing Policies","text":"<p>CTS now accepts dynamic policy input with weights for tradeoffs:</p> <pre><code>{\n  \"policy\": {\n    \"optimize_for\": \"speed\",\n    \"fallbacks\": [\"cost\", \"reliability\"],\n    \"compliance_tier\": \"auto\",\n    \"preferred_methods\": [\"mobile_money\", \"voucher\"],\n    \"excluded_rails\": [\"card\"]\n  }\n}\n</code></pre> <p>These policies are interpreted by the orchestration engine to determine the best route for a given payment context.</p>"},{"location":"10-payments-nucleus/components/canonical-transfer-service/#ai-agent-insights","title":"\ud83d\udcca AI Agent Insights","text":"<p>Each transfer can now expose why a rail was chosen, which path was tried, and fallback behavior:</p> <pre><code>{\n  \"transfer_id\": \"abc123\",\n  \"selected_path\": \"MoMo \u2192 Voucher\",\n  \"score\": 87.2,\n  \"reason\": \"Cheapest + acceptable speed under fallback policy\",\n  \"fallback_used\": true\n}\n</code></pre> <p>This data is accessible via the Orchestration Analytics API.</p>"},{"location":"10-payments-nucleus/components/canonical-transfer-service/#backwards-compatibility","title":"\u2699\ufe0f Backwards Compatibility","text":"<p>The orchestration engine is backwards-compatible with static configurations.</p> <p>If no dynamic policy is provided, the routing logic falls back to static Directory rules with preset fallbacks.</p>"},{"location":"10-payments-nucleus/components/canonical-transfer-service/#6-data-model","title":"6. Data Model","text":"<p>Tables</p>"},{"location":"10-payments-nucleus/components/canonical-transfer-service/#transfers","title":"Transfers","text":"Column Type Nullable Notes transferId UUID no PK tenantId TEXT no partition key payer JSONB no PII encrypted-at-rest payee JSONB no PII encrypted-at-rest amount_value NUMERIC(20,8) no amount_currency CHAR(3) no ISO-4217 or pseudo source_currency CHAR(3) yes defaults to amount currency target_currency CHAR(3) yes set for FX conversions fx_strategy TEXT yes NOT_APPLICABLE | QUOTE_AT_SUBMIT | PASS_THROUGH rail TEXT no e.g., usdc, zimswitch intent TEXT no AUTH externalRef TEXT yes client reference feeModel TEXT yes tariff applied to calculate fees endUserRef TEXT yes downstream end-user correlation state TEXT no INITIATED createdAt TIMESTAMP WITH TZ no updatedAt TIMESTAMP WITH TZ no version BIGINT no optimistic locking counter (default 0) <p>Indexes/Constraints - PK: <code>(transferId)</code> - IDX: <code>(tenantId, createdAt)</code> - Unique: <code>(tenantId, externalRef)</code> nullable unique</p>"},{"location":"10-payments-nucleus/components/canonical-transfer-service/#transfer-events","title":"Transfer Events","text":"Column Type Nullable Notes eventId UUID no PK transferId UUID no FK \u2192 transfers type TEXT no initiated/submitted/accepted/... payload JSONB no envelope v=1 occurredAt TIMESTAMP WITH TZ no event time <p>Indexes - PK: <code>(eventId)</code> - IDX: <code>(transferId, occurredAt)</code> - Unique: <code>(transferId, type)</code> for lifecycle uniqueness</p>"},{"location":"10-payments-nucleus/components/canonical-transfer-service/#transfer-summaries-read-model","title":"Transfer Summaries (Read Model)","text":"Column Type Nullable Notes tenantId TEXT no partition key transferId UUID no PK with tenant state TEXT no latest lifecycle state intent TEXT no AUTH|CAPTURE|PUSH|PULL rail TEXT no routed rail amount_value NUMERIC(20,8) no denormalized from transfer amount_currency CHAR(3) no source_currency CHAR(3) yes target_currency CHAR(3) yes fx_strategy TEXT yes externalRef TEXT yes endUserRef TEXT yes payerRef TEXT yes stable reference only payeeRef TEXT yes stable reference only version BIGINT no mirrors write model version createdAt TIMESTAMP WITH TZ no for cursor pagination updatedAt TIMESTAMP WITH TZ no latestEventType TEXT yes audit of final lifecycle event latestEventAt TIMESTAMP WITH TZ yes <p>Indexes - PK: <code>(tenantId, transferId)</code> - IDX: <code>(tenantId, createdAt DESC, transferId)</code> for cursor pagination - IDX: <code>(tenantId, state, createdAt DESC, transferId)</code> for backlog filtering - IDX: <code>(tenantId, externalRef)</code> partial on non-null</p>"},{"location":"10-payments-nucleus/components/canonical-transfer-service/#outbox-transfers","title":"Outbox Transfers","text":"Column Type Nullable Notes id UUID no PK eventType TEXT no e.g., transfers.submitted.usdc payload JSONB no event data state TEXT no PENDING attempts INT no default 0 lastError TEXT yes latest error createdAt TIMESTAMP WITH TZ no updatedAt TIMESTAMP WITH TZ no <p>Indexes - IDX: <code>(state, createdAt)</code> - IDX: <code>(eventType)</code></p>"},{"location":"10-payments-nucleus/components/canonical-transfer-service/#idempotency","title":"Idempotency","text":"Column Type Nullable Notes tenantId TEXT no idempotencyKey TEXT no bodyHash CHAR(64) no sha256 transferId UUID no createdAt TIMESTAMP WITH TZ no TTL policy \u2265 36h <p>Indexes - Unique: <code>(tenantId, idempotencyKey, bodyHash)</code></p>"},{"location":"10-payments-nucleus/components/canonical-transfer-service/#routing-cache-optional","title":"Routing Cache (optional)","text":"Column Type Nullable Notes key TEXT no hashed routing tuple value JSONB no route details expiresAt TIMESTAMP WITH TZ no ttl <p>Sample Rows (illustrative) <pre><code>{\n  \"transfers\": [\n    {\"transferId\":\"a1b2\",\"tenantId\":\"t1\",\"amount_value\":\"100.00\",\"amount_currency\":\"USD\",\"rail\":\"usdc\",\"intent\":\"PUSH\",\"state\":\"SUBMITTED\"}\n  ],\n  \"outbox_transfers\": [\n    {\"id\":\"o1\",\"eventType\":\"transfers.submitted.usdc\",\"state\":\"PENDING\",\"attempts\":0}\n  ]\n}\n</code></pre></p> <p>Retention - <code>idempotency</code>: TTL 36h (GC job) - <code>transfer_events</code>: hot in OLTP 90 days; archive to object store thereafter - <code>outbox_transfers</code>: keep SENT 7 days; FAILED until resolved</p> <p>Indexes and constraints (additions)</p> <ul> <li> <p>Idempotency <pre><code>CREATE UNIQUE INDEX ux_idempotency\n  ON idempotency(tenantId, idempotencyKey, bodyHash);\n-- Optional partial unique within 36h window\nCREATE UNIQUE INDEX ux_idempotency_window\n  ON idempotency(tenantId, idempotencyKey, bodyHash)\n  WHERE createdAt &gt; now() - interval '36 hours';\n</code></pre></p> </li> <li> <p>ExternalRef <pre><code>CREATE UNIQUE INDEX ux_transfers_externalref\n  ON transfers(tenantId, externalRef)\n  WHERE externalRef IS NOT NULL;\n\n-- Optionally include intent to reduce collisions\nCREATE UNIQUE INDEX ux_transfers_externalref_intent\n  ON transfers(tenantId, intent, externalRef)\n  WHERE externalRef IS NOT NULL;\n</code></pre></p> </li> <li> <p>Events uniqueness <pre><code>CREATE UNIQUE INDEX ux_events_lifecycle\n  ON transfer_events(transferId, type);\n-- If a rail can emit multiple of the same type\nCREATE UNIQUE INDEX ux_events_seq\n  ON transfer_events(transferId, type, seq);\n</code></pre></p> </li> <li> <p>Optimistic locking <pre><code>-- Column already defined: version BIGINT NOT NULL DEFAULT 0\n-- Guarded update example\nUPDATE transfers\nSET state = $1, version = version + 1, updatedAt = now()\nWHERE transferId = $2 AND version = $3;\n</code></pre> Behavior: return 409/Retry on no-row-updated for external callers; internal workers retry with jitter/backoff.</p> </li> </ul>"},{"location":"10-payments-nucleus/components/canonical-transfer-service/#7-interfaces-contracts","title":"7. Interfaces &amp; Contracts","text":"<p>HTTP APIs</p> <p>POST /transfers <pre><code>POST /transfers HTTP/1.1\nAuthorization: Bearer &lt;token&gt;\nIdempotency-Key: 6f1e2...\nX-Canonical-Version: 1\nContent-Type: application/json\n</code></pre> Request <pre><code>{\n  \"tenantId\":\"t1\",\n  \"intent\":\"PUSH\",\n  \"amount\":{\"value\":\"100.00\",\"currency\":\"USD\"},\n  \"payer\":{\"type\":\"WALLET\",\"id\":\"payer-1\"},\n  \"payee\":{\"type\":\"WALLET\",\"id\":\"payee-9\"},\n  \"externalRef\":\"inv-42\"\n}\n</code></pre> Responses <pre><code>// 201 Created (first time)\n{\"transferId\":\"a1b2\",\"state\":\"SUBMITTED\",\"rail\":\"usdc\"}\n</code></pre> <pre><code>// 200 OK (duplicate)\n{\"transferId\":\"a1b2\",\"state\":\"SUBMITTED\",\"rail\":\"usdc\"}\n</code></pre> <pre><code>// 409 IdempotencyConflict (same key, different body)\n{\"code\":\"IdempotencyConflict\",\"priorTransferId\":\"a1b2\",\"priorBodyHash\":\"sha256:...\"}\n</code></pre> Errors <pre><code>// 422 EntityDenied\n{\"code\":\"EntityDenied\",\"reason\":\"watchlist_hit\",\"requestId\":\"r-123\"}\n</code></pre> <pre><code>// 502 RoutingUnavailable\n{\"code\":\"RoutingUnavailable\",\"retryAfter\":\"5s\"}\n</code></pre></p> <p>Decision tree (POST /transfers)</p> <ol> <li>Validate request (schema, authZ)</li> <li>On failure: 400/401/403</li> <li>Idempotency lookup</li> <li>Key+hash match: 200 (return existing resource)</li> <li>Key exists, hash differs: 409 IdempotencyConflict</li> <li>Compliance screening</li> <li>Deny: 422 EntityDenied</li> <li>Routing</li> <li>Timeout/5xx: 502 RoutingUnavailable</li> <li>Persist write model + outbox (single DB tx)</li> <li>Success: 201 Created with <code>Location: /transfers/:id</code> and <code>state=SUBMITTED</code></li> <li>Concurrency (optimistic lock)</li> <li>External mutating APIs: 409 Conflict</li> <li>Internal workers: retry with jitter/backoff</li> </ol> <p>GET /transfers/:id <pre><code>GET /transfers/a1b2 HTTP/1.1\nAuthorization: Bearer &lt;token&gt;\n</code></pre> Response <pre><code>{\n  \"transferId\":\"a1b2\",\n  \"state\":\"SETTLED\",\n  \"timeline\":[\n    {\"type\":\"initiated\",\"at\":\"2025-01-01T10:00:00Z\"},\n    {\"type\":\"submitted.usdc\",\"at\":\"2025-01-01T10:00:01Z\"},\n    {\"type\":\"accepted\",\"at\":\"2025-01-01T10:00:02Z\"},\n    {\"type\":\"settled\",\"at\":\"2025-01-01T10:03:00Z\"}\n  ]\n}\n</code></pre></p> <p>Event Contracts <pre><code>{\n  \"envelope\": {\n    \"v\": 1,\n    \"eventId\": \"uuid\",\n    \"occurredAt\": \"ts\",\n    \"tenantId\": \"t1\",\n    \"transferId\": \"a1b2\",\n    \"type\": \"transfers.submitted.usdc\",\n    \"traceparent\": \"00-...\"\n  },\n  \"payload\": { \"amount\": {\"value\":\"100.00\",\"currency\":\"USD\"}, \"payer\": {\"id\":\"...\"}, \"payee\": {\"id\":\"...\"} }\n}\n</code></pre> Canonicalization and body hash</p> <p>Algorithm (v1): - Normalize JSON per canonical schema version. - Trim strings; lowercase ISO currency codes; normalize country/phone formats. - Sort object keys lexicographically; arrays kept in submitted order unless schema defines ordering. - Amounts: parse to decimal, scale to currency decimals (see Amount precision), serialize as string. - Serialize with no insignificant whitespace. - Compute <code>bodyHash = sha256(serialized)</code> and store with idempotency record.</p> <p>Sample vector: <pre><code>// input\n{\"amount\":{\"value\":\"100.0\",\"currency\":\"usd\"},\"payer\":{\"id\":\" A \"}}\n// normalized\n{\"amount\":{\"value\":\"100.00\",\"currency\":\"USD\"},\"payer\":{\"id\":\"A\"}}\n// sha256\n\"b0b6...\"\n</code></pre> Topics - <code>events.transfers.initiated</code> - <code>events.transfers.submitted.&lt;rail&gt;</code> (e.g., <code>events.transfers.submitted.usdc</code>) - Inbound: <code>events.transfers.accepted|settled|returned|failed</code></p> <p>Ordering and dedupe - For SNS/SQS FIFO: <code>MessageGroupId = transferId</code> to guarantee per-transfer ordering; <code>MessageDeduplicationId = eventId</code>. - Consumers must dedupe by <code>eventId</code> and <code>(transferId,type)</code> to handle retries/replays.</p> <p>Timeouts/SLAs | Integration | Timeout | Retry | SLA | |---|---|---|---| | Compliance | 800ms | 2 with jitter | 99.9% | | Directory | 400ms | 1 with jitter | 99.9% | | Gateway Publish | async | backoff 1s..1h | N/A |</p> <p>Tenant isolation &amp; quotas - Per-tenant token-bucket rate limits (defaults: 50 rps burst, 5 rps sustained for pilot). - Authorization scopes restrict access to <code>tenantId</code>; all queries filter by <code>tenantId</code>. - Quota override process via config store with change audit.</p> <p>Threat model (mini) - IDOR on GET <code>/transfers/:id</code> \u2192 enforce tenant scope; verify <code>tenantId</code> ownership per row. - Replay with stolen <code>Idempotency-Key</code> \u2192 pair key with bodyHash and TTL; require Authorization; optionally sign requests (HMAC). - Message tampering on bus \u2192 server-side signing/envelope checksum; least-privilege topics; DLQ visibility restricted.</p> <p>PII strategy - Events carry <code>payer_ref</code>/<code>payee_ref</code> only; PII stored in encrypted columns/tables (KMS key rotation annually). - POPIA/GDPR: support erasure by tombstoning PII fields while preserving event integrity (refs remain).</p> <p>Schema registry &amp; compatibility - Event envelope and payloads registered in Schema Registry; policy BACKWARD for events. - Breaking-change process: bump <code>envelope.v</code>, dual-publish during migration window, communicate to consumers.</p> <p>Replay &amp; re-drive - Controlled replay from outbox or archived events; idempotent updates ensured by <code>(transferId,type)</code> uniqueness. - Time-boxed replays with audit log entries for who/when/why. - Requires dual approval (engineering + compliance/ops) before marking events for re-drive; store signed reason alongside the <code>SENT</code> transition.</p>"},{"location":"10-payments-nucleus/components/canonical-transfer-service/#8-operational-considerations","title":"8. Operational Considerations","text":"<ul> <li>Deployment: Blue/Green or Canary via ingress weights; feature flags for risky paths.</li> <li>Config: Environment + central config store; secret rotation via Secrets Manager.</li> <li>Runbooks (expanded)</li> <li>High Latency: check <code>compliance_client_latency_p95</code>, <code>directory_client_latency_p95</code>, DB CPU/IO, thread pools.</li> <li>Stuck SUBMITTED: inspect outbox lag, worker health, DLQ; reprocess by id.</li> <li>Idempotency Collisions: audit client keys, compare bodyHash mismatches.</li> <li>Alerts</li> <li><code>rate(cts_outbox_failures_total[5m]) / rate(cts_outbox_attempts_total[5m]) &gt; 0.001 for 5m</code></li> <li><code>histogram_quantile(0.95, sum(rate(http_server_duration_seconds_bucket{route=\"/transfers\"}[5m])) by (le)) &gt; 1.5</code></li> <li><code>cts_consumer_lag{topic=\"events.transfers.*\"} &gt; 5000 for 10m</code></li> <li><code>rate(http_5xx_total[5m]) &gt; 0.01</code></li> <li>SLO burn alerts: 2% budget burn over 1h, 5% over 6h for availability/latency SLOs</li> <li>Capacity</li> <li>Scale API by QPS and p95 latency; scale workers by outbox depth and publish rate; 1 partition per expected 50 TPS.</li> </ul> <p>Migrations - Tooling: Flyway or Liquibase. - Zero-downtime: expand (add nullable columns/indexes) \u2192 dual-write if needed \u2192 backfill \u2192 contract. - Rollback: feature-flag writes; maintain backward compatible reads; revert via migrations down.</p> <p>Runbooks (deepening) - Poison message: locate <code>eventId</code>, inspect <code>lastError</code>, retry N with backoff, if still failing park to DLQ and open ticket; optional manual mark-SENT with dual approval and signed reason attached to the record. - Hot tenant: reduce tenant-specific rate limit, shard outbox processing by <code>tenantId</code>, notify tenant of temporary caps.</p>"},{"location":"10-payments-nucleus/components/canonical-transfer-service/#9-testing-strategy","title":"9. Testing Strategy","text":"<ul> <li>Unit: canonical normalizer (trimming, casing, currency scale table), bodyHash calculator vectors, idempotency repository, error mapper, routing cache TTL math.</li> <li>Contract: Pact for Compliance <code>/screen</code> and Directory <code>/route</code> clients; JSON Schema validation on emitted events (<code>canonical.transfer.v1</code>).</li> <li>Integration: Testcontainers Postgres 15 + LocalStack SNS/SQS FIFO; fake Compliance/Directory services with latency/deny toggles; verify outbox backoff ladder + DLQ placement after 10 attempts.</li> <li>E2E:</li> <li>Happy path USDC submit \u2192 gateway ack \u2192 settlement event.</li> <li>Duplicate submission returns <code>200</code> replay.</li> <li>Idempotency conflict (same key, different hash) \u2192 <code>409</code>.</li> <li>Compliance deny \u2192 <code>422</code> with reason.</li> <li>Directory window closed \u2192 <code>502</code> with accurate <code>retryAfter</code>.</li> <li>Outbox DLQ + dual-approval re-drive flow.</li> <li>Chaos: inject DB failover, SNS publish failure (&gt;3 attempts), Directory latency spikes; assert no unscreened submit escapes.</li> <li>Load: 200 TPS synthetic traffic (90% POST, 10% GET) with 1% duplicates; target POST p95 &lt; 1.5s and zero lost events.</li> </ul>"},{"location":"10-payments-nucleus/components/canonical-transfer-service/#10-risks-trade-offs-and-open-questions","title":"10. Risks, Trade-offs, and Open Questions","text":"<ul> <li>Outbox saturation \u2192 publish lag; mitigate via autoscale and partitioning.</li> <li>Routing flaps \u2192 increased 5xx; mitigate with negative caching and backoff.</li> <li>Tenant spikes \u2192 noisy neighbor; enforce per-tenant rate limits.</li> <li>Schema drift \u2192 consumer breakage; enforce versioning and schema registry.</li> </ul> <p>Open questions and decisions are summarized at the end.</p>"},{"location":"10-payments-nucleus/components/canonical-transfer-service/#11-appendix","title":"11. Appendix","text":"<ul> <li>Glossary: CTS (Canonical Transfer Service), OLTP, DLQ, SAGA, RPO/RTO.</li> <li>References: <code>docs/00-overview/architecture-decisions/ADR-0001-events-outbox.md</code>, <code>docs/20-specs/api-canonical-transfer.md</code>, <code>docs/30-diagrams/lifecycle-state.md</code>.</li> </ul>"},{"location":"10-payments-nucleus/components/canonical-transfer-service/#12-pilot-requirements-aws-serverless-option","title":"12. Pilot Requirements &amp; AWS Serverless Option","text":"<p>Pilot scope and sizing (20 merchants) - Volume: 100 transfers/merchant/day \u2192 ~2,000 transfers/day (avg ~0.023 TPS), anticipate bursts during business hours (assume 5\u201310 TPS peaks for 10\u201330 minutes). - Reliability: \u2265 99% transfers reach terminal state with complete event trail. - Latency: p95 \u2264 2.5s end-to-end for submit; p99 \u2264 4s under burst. - Cost: minimize infra cost; prefer pay-per-use; keep auditability and outbox guarantees.</p> <p>Derived sizing (pilot) - Outbound events/transfer: ~3\u20134 typical \u2192 \u2264 8,000 events/day. - Storage growth (pilot): Transfers \u2264 2k rows/day, Events \u2264 8k rows/day; negligible for 90-day hot retention. - Network: &lt;&lt; 1 Mbps steady; minimal.</p> <p>Serverless deployment (AWS) \u2014 Pilot option <pre><code>graph TD\n  Client[Clients/POS] --&gt; APIGW[API Gateway]\n  APIGW --&gt; LAPI[Lambda: CTS API]\n\n  subgraph \"Data Store (choose one)\"\n    RDS[\"RDS Proxy \u2192 Aurora Serverless v2 (PostgreSQL)\"]\n    DDB[\"DynamoDB Tables\"]\n  end\n\n  LAPI --&gt;|Option A| RDS\n  LAPI --&gt;|Option B| DDB\n\n  subgraph \"Outbox + Events\"\n    SQS[\"SQS Outbox Queue\"]\n    DDBS[\"DynamoDB Streams\"]\n    LPUB[\"Lambda: Outbox Publisher\"]\n    EBus[\"SNS FIFO Topic events.transfers\"]\n    SQSC1[\"SQS FIFO Consumer (Gateway)\"]\n    SQSC2[\"SQS FIFO Consumer (Ledger)\"]\n  end\n\n  RDS --&gt; SQS\n  DDB --&gt; DDBS\n  DDBS --&gt; LPUB\n  LPUB --&gt; EBus\n  EBus --&gt; SQSC1\n  EBus --&gt; SQSC2\n  SQSC1 --&gt; RDS\n  SQSC2 --&gt; DDB\n\n  subgraph \"Ops\"\n    SM[\"Secrets Manager\"]\n    CW[\"CloudWatch Logs/Metrics/Alarms\"]\n    XR[\"X-Ray Tracing\"]\n  end\n\n  LAPI -.-&gt; SM\n  LAPI -.-&gt; CW\n  LAPI -.-&gt; XR\n  LPUB -.-&gt; CW\n  LCONS -.-&gt; CW\n</code></pre></p> <p>Data store options and recommendation</p> Option Infra How it maps to SDD Pros Cons Pilot recommendation A. Aurora Serverless v2 + RDS Proxy API Gateway + Lambda + RDS Proxy + Aurora Pg Keeps OLTP DB and transactional outbox exactly as designed (same-DB tx). Minimal code changes; strong ACID; SQL familiarity; easy path to prod scale. Aurora min ACU cost even when idle; Lambda needs RDS Proxy to avoid connection storms. Selected for pilot. B. DynamoDB + Streams + EventBridge API Gateway + Lambda + DynamoDB Use conditional writes for idempotency; store transfer and event items; publish via Streams\u2192Lambda; dedupe at consumers. Pay-per-use; very low cost at 1k tx/day; scales automatically; no connections. Outbox shifts to at-least-once via Streams; must implement idempotent publisher and consumer dedupe; relational queries harder. Viable low-cost alternative if we accept at-least-once with dedupe and keep schema simple. C. EC2 or Lightsail + Postgres Nginx + app on EC2/Lightsail + Postgres Traditional deployment; identical semantics to SDD. Simple mental model; predictable performance; cheapest if always-on and tiny. Ops overhead (patching, scaling); less elastic; need HA for SLOs. Acceptable for a throwaway pilot; less aligned with serverless strategy. <p>Notes on Option B (DynamoDB) - Idempotency: <code>PutItem</code> with <code>ConditionExpression attribute_not_exists(pk)</code> using <code>(tenantId, idempotencyKey, bodyHash)</code> item; TTL attribute for GC. - Transfers/events: single-table design with <code>PK=TRANSFER#&lt;transferId&gt;</code>, <code>SK=STATE#...</code> and <code>SK=EVENT#...</code>; <code>transfer_events</code> uniqueness via <code>ConditionExpression</code> on <code>(transferId,type)</code>. - Outbox: write event items; use DynamoDB Streams to trigger publisher Lambda; publisher writes to EventBridge; consumers dedupe by <code>eventId</code> and <code>(transferId,type)</code>. - Read model: <code>GET /transfers/:id</code> via <code>Query PK=TRANSFER#...</code> ordered by <code>SK</code>.</p> <p>Cost posture (directional, not a quote) - Requests/day ~2k \u2192 API Gateway/Lambda costs are negligible; DynamoDB RU/WU minimal at pilot scale; Aurora Serverless has a small baseline cost due to min ACUs; EC2/Lightsail cheapest if always-on but adds ops overhead.</p> <p>Recommendation for pilot - Selected: Option A (Aurora Serverless v2 + RDS Proxy). Keep the SDD\u2019s OLTP schema and transactional outbox as-is. - Option B remains a fallback if costs require further reduction; keep abstraction boundaries to allow future swap.</p> <p>Pilot deployment (selected Option A) <pre><code>flowchart LR\n  Client --&gt; APIGW[API Gateway]\n  APIGW --&gt; LAPI[Lambda CTS API]\n  LAPI --&gt; RDS[(Aurora Serverless v2 via RDS Proxy)]\n  LAPI --&gt; CW[CloudWatch/X-Ray]\n  subgraph Outbox\n    LWORK[Lambda Outbox Worker]\n    EBus[EventBridge events.transfers.*]\n  end\n  RDS &lt;-- poll PENDING --&gt; LWORK\n  LWORK --&gt; EBus</code></pre></p> <p>Pilot configuration (Option A) - Aurora Serverless v2 PostgreSQL 15; min ACU 0.5\u20131, max ACU 4; Multi-AZ on. - RDS Proxy for Lambda connections; IAM auth or Secrets Manager rotation (90 days). - Outbox Worker Lambda: runs on a 15\u201330s schedule; batch size 500; exponential backoff; idempotent publish to EventBridge (partition key <code>transferId</code>). - VPC: Lambdas in private subnets with NAT; security groups restrict DB access. - Observability: CloudWatch metrics/logs, X-Ray traces; alarms per SLOs. - Migrations: Flyway/Liquibase executed via CI job before deploy.</p>"},{"location":"10-payments-nucleus/components/canonical-transfer-service/#authoritative-input-spec","title":"Authoritative Input Spec","text":"<p>As provided. Preserved verbatim for traceability.</p> <pre><code>[BEGIN INPUT SPEC]\n# Canonical Transfer Service (CTS)\n\nThe **Canonical Transfer Service (CTS)** is the **front door and conductor** of Stalela.  \nIt provides a single API for creating and managing transfers, normalizes requests into a canonical format, enforces idempotency, screens entities, routes transfers, and emits domain events.\n\n---\n\n## \ud83c\udfaf Purpose\n\n- Provide a **unified API** for all transfers (payments, payouts, pushes, pulls).  \n- Normalize requests into a **canonical model** independent of rail quirks.  \n- Act as the **orchestrator** for transfer lifecycle events.  \n- Enforce **idempotency** across client submissions.  \n- Ensure **compliance screening** before any transfer reaches a rail.  \n- Emit **domain events** (`transfers.*`) so all state changes are visible and auditable.  \n\n---\n\n## \ud83d\udee0 Responsibilities\n\n- **Accept API requests** (`POST /transfers`, `GET /transfers/:id`).  \n- **Deduplicate** requests using idempotency keys and hashes.  \n- **Validate and normalize** inputs into the canonical transfer schema.  \n- **Pre-screen** payer and payee using the Compliance service.  \n- **Route** transfers through the Directory &amp; Routing service.  \n- **Emit events** (`initiated`, `submitted.&lt;rail&gt;`) via the outbox.  \n- **Track lifecycle state** for each transfer.  \n\n---\n\n## \ud83d\udd0c Interfaces\n\n### API Endpoints\n- `POST /transfers`  \n  - Create a new transfer.  \n  - Requires `Idempotency-Key` header.  \n  - Body: canonical transfer schema.  \n\n- `GET /transfers/:id`  \n  - Fetch transfer details including timeline of events.  \n\n&gt; See Specs: [../specs/api-canonical-transfer.md](../specs/api-canonical-transfer.md)\n\n### Event Topics\n- Emits (envelope `v=1`):\n  - `transfers.initiated`\n  - `transfers.submitted.&lt;rail&gt;`\n- Consumes:\n  - `transfers.accepted`\n  - `transfers.settled`\n  - `transfers.returned`\n  - `transfers.failed`\n\n---\n\n### Admin Endpoints (via Platform/Base)\n- `GET /live`, `GET /ready`, `GET /metrics`, `GET /version` provided by Platform/Base and adopted by CTS.\n\n\n## \ud83d\uddc4 Data Model\n\n**Table: `transfers`**  \n- `transferId` (PK)  \n- `tenantId`  \n- `payer`, `payee` (JSON)  \n- `amount { value, currency }`  \n- `rail`  \n- `intent` (AUTH | CAPTURE | PUSH | PULL)  \n- `externalRef`  \n- `state` (INITIATED, SUBMITTED, \u2026)  \n- `createdAt`, `updatedAt`  \n\n**Table: `transfer_events`**  \n- `eventId`  \n- `transferId` (FK)  \n- `type`  \n- `payload` (JSON)  \n- `occurredAt`  \n\n**Table: `outbox_transfers`**  \n- Standard outbox pattern for exactly-once event publishing.  \n  - Columns: `id`, `eventType`, `payload`, `state` (PENDING|SENT|FAILED), `createdAt`, `attempts`, `lastError?`\n\n---\n\n## \ud83d\udcd0 Diagram\n\n### Sequence: Happy Path (USDC transfer)\n\n```mermaid\nsequenceDiagram\n  participant Client\n  participant CTS as Canonical Transfer Service\n  participant CS as Compliance\n  participant DR as Directory\n  participant GW as Rail Gateway (USDC)\n\n  Client-&gt;&gt;CTS: POST /transfers (idempotency-key)\n  CTS-&gt;&gt;CTS: Deduplicate &amp; normalize\n  CTS-&gt;&gt;CS: Pre-screen payer/payee\n  CS--&gt;&gt;CTS: Allow\n  CTS-&gt;&gt;DR: Lookup route\n  DR--&gt;&gt;CTS: Rail endpoint\n  CTS-&gt;&gt;CTS: Persist transfer, state=SUBMITTED\n  CTS-&gt;&gt;GW: Event transfers.submitted.usdc\n  GW--&gt;&gt;CTS: Event transfers.accepted\n  GW--&gt;&gt;CTS: Event transfers.settled\n  CTS-&gt;&gt;Client: 200 OK { state: SETTLED }\n</code></pre>"},{"location":"10-payments-nucleus/components/canonical-transfer-service/#state-machine","title":"\ud83d\udd04 State Machine","text":"<p>See transfer lifecycle diagram: ../diagrams/lifecycle-state.md</p>"},{"location":"10-payments-nucleus/components/canonical-transfer-service/#failure-modes-retries","title":"\ud83d\udea8 Failure Modes &amp; Retries","text":"<ul> <li>Duplicate submission \u2192 return existing transfer (idempotent).  </li> <li>Compliance = deny \u2192 return 422 EntityDenied.  </li> <li>Directory lookup fails \u2192 return 502 RoutingUnavailable.  </li> <li>Rail submission fails \u2192 state = FAILED, event emitted.  </li> <li>Outbox publish failure \u2192 retry with exponential backoff.  </li> <li>Consumers must dedupe by <code>eventId</code> (and <code>(transferId,type)</code> uniqueness for lifecycle).  </li> </ul>"},{"location":"10-payments-nucleus/components/canonical-transfer-service/#observability","title":"\ud83d\udcca Observability","text":"<p>Metrics - API latency (p95, p99). - Idempotency collision rate. - Compliance check latency. - Transfers by state (submitted, settled, returned).  </p> <p>Logs - Structured JSON with transferId, tenantId, eventId.  </p> <p>Tracing - Propagate request IDs through to gateways and ledger.  </p>"},{"location":"10-payments-nucleus/components/canonical-transfer-service/#security","title":"\ud83d\udd10 Security","text":"<ul> <li>API authentication with tenant-level keys/tokens.  </li> <li>All PII (payer/payee) encrypted at rest.  </li> <li>Access to transfer data restricted by tenant scope.  </li> <li>Logs redact sensitive fields (names, IDs, PANs).  </li> </ul>"},{"location":"10-payments-nucleus/components/canonical-transfer-service/#runbooks","title":"\ud83d\udcd8 Runbooks","text":"<ul> <li>If API latency spikes \u2192 check compliance and directory service dependencies.  </li> <li>If transfers stuck in SUBMITTED \u2192 inspect gateway outbox and retry queue.  </li> <li>If idempotency collisions increase \u2192 confirm client integration is using stable Idempotency-Key.  </li> <li>If compliance service is unreachable \u2192 all submissions should fail-safe (no unscreened transfers). [END INPUT SPEC] ```</li> </ul>"},{"location":"10-payments-nucleus/components/canonical-transfer-service/#open-questions-next-decisions","title":"Open Questions &amp; Next Decisions","text":"<ul> <li>[ ] Finalize SNS/SQS FIFO IaC and naming conventions for pilot.</li> <li>[ ] Confirm Compliance sign-off on retention durations (events/logs).</li> <li>[ ] Define per-currency min/max and fee fields for all pilot currencies.</li> <li>[ ] Approve tenant default quotas and the override approval process.</li> <li>[ ] Validate canonicalization test vectors with integrators.</li> <li>[ ] Decide archive format and encryption for long-term event storage.</li> <li>[ ] Confirm Directory <code>route.updated</code> event shape and cache key.</li> <li>[ ] Choose replay authorization workflow and audit approvals.</li> <li>[ ] Set trace sampling defaults per environment (dev/stage/prod).</li> </ul>"},{"location":"10-payments-nucleus/components/canonical-transfer-service/#next-iteration-plan-2-weeks","title":"Next Iteration Plan (2 weeks)","text":"<ul> <li>Week 1</li> <li>Engineers: A (API/Idempotency), B (Outbox/Worker), C (Integrations)</li> <li>Tasks: Scaffold service; implement POST/GET; idempotency table; outbox write; basic publish; compliance+directory clients with timeouts; metrics+tracing.</li> <li>Exit criteria: POST happy path to mock services; events visible on test topic; p95 &lt; 500ms without external calls.</li> <li>Week 2</li> <li>Engineers: A (State/Projections), B (DLQ/Backoff), C (Load/Chaos)</li> <li>Tasks: State updates from inbound events; projections for GET; backoff+DLQ; rate limiting; alert rules; load tests at 200 TPS; chaos tests.</li> <li>Exit criteria: All sequences pass in CI; alerts in place; docs updated; demo end-to-end flow.</li> </ul>"},{"location":"10-payments-nucleus/components/canonical-transfer-service/#decisions-ready-to-adopt","title":"Decisions (ready to adopt)","text":"<p>1) Canonical schema ownership &amp; versioning cadence - Decision: Platform/Architecture owns the canonical schema; changes via Schema Working Group. - Versioning: SemVer on canonical model; header <code>X-Canonical-Version</code> and <code>envelope.v</code>. - Cadence: Minor every 2 weeks as needed; Major with quarterly planning. - Mechanics: JSON Schema in <code>schemas/canonical-transfer/v{n}</code>; RFC + contract tests.</p> <p>2) Per-tenant quotas &amp; default limits - Decision: Token-bucket per tenant at API gateway + app layer. - Defaults: Write 2 TPS sustained (burst 20 for 60s); Read 10 TPS sustained (burst 50 for 60s); Daily cap 10k transfers/tenant. - Behavior: 429 with Retry-After when exhausted; emit <code>quota.exceeded</code>.</p> <p>3) DB technology &amp; JSONB usage - Decision: Aurora PostgreSQL v2 with JSONB for payer/payee and envelopes; relational columns for hot filters. - Indexes: <code>(tenantId, createdAt)</code>, PK <code>(transferId)</code>, partial unique <code>(tenantId, idempotencyKey, bodyHash)</code> for 36h window; GIN only when needed.</p> <p>4) Event bus &amp; partition strategy - Decision: SNS FIFO with SQS FIFO subscribers; <code>MessageGroupId=transferId</code>, <code>MessageDeduplicationId=eventId</code>.</p> <p>5) Envelope schema registry &amp; tooling - Decision: Git-based JSON Schema registry under <code>schemas/</code> with CI validation.</p> <p>6) Settlement sync response policy - Decision: Never return SETTLED synchronously; first response 201/200 with <code>state=SUBMITTED</code>.</p> <p>7) DLQ storage &amp; triage workflow - Decision: Outbox publisher DLQ \u2192 SQS standard (14 days); consumer DLQs per SQS FIFO; re-drive Lambda with idempotency.</p> <p>8) Retention durations (pending Compliance) - Defaults: Events 7y (WORM after 90d), Transfers 2y hot then Glacier Deep Archive, Idempotency 36h, Logs 30d, Metrics 15m.</p> <p>9) Directory cache invalidation hooks - Decision: Directory publishes <code>directory.route.updated</code>; CTS invalidates/pre-warms cache.</p> <p>10) Trace sampling rate &amp; PII redaction - Decision: Head-based sampling (10% default; 100% for 5xx or p95 breaches); PII allowlist in logs/traces.</p>"},{"location":"10-payments-nucleus/components/canonical-transfer-service/#implementation-map-whowhatwhen","title":"Implementation map (who/what/when)","text":"Item Owner Artifacts Exit Criteria Schema governance Platform Lead ADR-001, <code>schemas/canonical-transfer/</code> CI rejects non-compliant events; schema published Quotas &amp; limits API Eng gateway config + middleware 429s with Retry-After; per-tenant metrics Aurora Pg + JSONB DB Eng ADR-003, migrations Tables + indexes live; RDS Proxy wired; load test passes SNS/SQS FIFO bus Platform Eng ADR-004, IaC Topic + queues live; ordering verified JSON schema registry App Eng ADR-005, CI rules All events validated in CI + prod (shadow) Async-only settlement App Eng ADR-006, API docs POST always returns SUBMITTED DLQ &amp; re-drive SRE ADR-007, runbooks, Lambda Re-drive tool works; alarms wired Retention policy Compliance + SRE ADR-008, lifecycle rules Glacier policies in place; PII separation verified Route invalidation Directory + App Eng ADR-009 Cache flushes on update event; TTLs enforced Tracing + redaction SRE ADR-010, log filters 10% sampling, error boost, PII allowlist verified"},{"location":"10-payments-nucleus/components/compliance-screening/","title":"Compliance Screening Service","text":"<p>The Compliance Screening Service protects Stalela by screening entities (payer, payee) against sanctions and risk lists before transfers are submitted to rails. It ensures fast, local allow/deny decisions and continuous re-screening as lists update.</p>"},{"location":"10-payments-nucleus/components/compliance-screening/#purpose","title":"\ud83c\udfaf Purpose","text":"<ul> <li>Enforce pre-submit screening of entities against sanctions lists.  </li> <li>Perform delta re-screens when lists update.  </li> <li>Cache results for performance.  </li> <li>Emit entity flagged events for operator review.  </li> <li>Provide a simple, auditable <code>/screen</code> API.</li> </ul>"},{"location":"10-payments-nucleus/components/compliance-screening/#responsibilities","title":"\ud83d\udee0 Responsibilities","text":"<ul> <li>Ingest official sanctions/watchlists (OFAC, UN, EU, SA FIC).  </li> <li>Normalize and index names, aliases, DOBs, countries.  </li> <li>Provide low-latency API for CTS screening.  </li> <li>Emit alerts when existing entities match new list entries.  </li> <li>Store results with versioned list references for audit.</li> </ul> <p>Local sources: SA PEPs/adverse media (vendor feeds), ZW FIU advisories; define update SLAs and checksum validation.</p>"},{"location":"10-payments-nucleus/components/compliance-screening/#interfaces","title":"\ud83d\udd0c Interfaces","text":""},{"location":"10-payments-nucleus/components/compliance-screening/#http","title":"HTTP","text":"<ul> <li><code>POST /screen</code></li> <li>body: <code>{ name, dob?, country?, idNumber? }</code></li> <li>returns: <code>{ action: allow|deny, score, matches[], listVersion }</code></li> </ul>"},{"location":"10-payments-nucleus/components/compliance-screening/#events-emit","title":"Events (emit)","text":"<ul> <li><code>compliance.entity.flagged</code></li> <li><code>{ entityId, transferId?, score, listVersion, matches[] }</code></li> </ul>"},{"location":"10-payments-nucleus/components/compliance-screening/#admin","title":"Admin","text":"<ul> <li><code>GET /live</code>, <code>GET /ready</code>, <code>GET /metrics</code>, <code>GET /version</code></li> </ul>"},{"location":"10-payments-nucleus/components/compliance-screening/#data-model","title":"\ud83d\uddc4 Data Model","text":"<ul> <li><code>lists_raw</code> (source files)  </li> <li><code>lists_index</code> (normalized searchable index)  </li> <li><code>entity_screenings</code> (entityId, transferId, result, listVersion, createdAt)  </li> <li><code>outbox_compliance</code> </li> </ul>"},{"location":"10-payments-nucleus/components/compliance-screening/#sequence","title":"\ud83d\udcd0 Sequence","text":"<pre><code>sequenceDiagram\n  participant CTS\n  participant CS as Compliance Service\n  participant LIST as Sanctions Lists\n\n  CTS-&gt;&gt;CS: POST /screen (payer, payee)\n  CS-&gt;&gt;LIST: query local index\n  LIST--&gt;&gt;CS: result { score, matches }\n  CS--&gt;&gt;CTS: { action: allow }</code></pre>"},{"location":"10-payments-nucleus/components/compliance-screening/#failure-modes","title":"\ud83d\udea8 Failure Modes","text":"<ul> <li>List download failed \u2192 keep prior index, raise alert.  </li> <li>Timeout \u2192 CTS fails safe (deny).  </li> <li>False positive \u2192 escalate via Operator Console.  </li> <li>Stale index \u2192 emit compliance.service.stale event.</li> </ul>"},{"location":"10-payments-nucleus/components/compliance-screening/#observability","title":"\ud83d\udcca Observability","text":"<ul> <li>Metrics: screening latency, match rate, stale index age.  </li> <li>Logs: structured with entityId, listVersion.  </li> <li>Alerts on stale index &gt; 24h.</li> </ul>"},{"location":"10-payments-nucleus/components/compliance-screening/#security","title":"\ud83d\udd10 Security","text":"<ul> <li>Encrypt raw list data at rest.  </li> <li>PII redaction in logs.  </li> <li>Access control to screening API by internal services only.</li> </ul>"},{"location":"10-payments-nucleus/components/compliance-screening/#runbooks","title":"\ud83e\udded Runbooks","text":"<ul> <li>New list version failed ingest \u2192 re-run job manually, validate checksums.  </li> <li>High false positives \u2192 adjust fuzzy matching thresholds, add alias list.  </li> <li>Operator override \u2192 freeze/unfreeze entity in Operator Console.</li> </ul>"},{"location":"10-payments-nucleus/components/directory-routing/","title":"Directory &amp; Routing Service","text":"<p>The Directory &amp; Routing Service is Stalela\u2019s authoritative source of rails metadata. It ensures transfers are routed deterministically to the correct rail endpoints, institutions, and fee structures.</p>"},{"location":"10-payments-nucleus/components/directory-routing/#purpose","title":"\ud83c\udfaf Purpose","text":"<ul> <li>Maintain authoritative directory of institutions, BINs, fees, settlement windows.  </li> <li>Provide fast lookups for CTS routing decisions.  </li> <li>Refresh data periodically from external sources.  </li> <li>Support effective-dated changes (versioning).</li> </ul>"},{"location":"10-payments-nucleus/components/directory-routing/#responsibilities","title":"\ud83d\udee0 Responsibilities","text":"<ul> <li>Store and expose institution metadata.  </li> <li>Expose routing lookups (<code>/routes?bin=...</code>) for CTS.  </li> <li>Apply per-rail/per-tenant fees and cutoffs.  </li> <li>Circuit-breaker fallback to cached versions.  </li> <li>Version data for audit and rollback.  </li> <li>Maintain ZA bank codes and PayShap proxy rules (cell/email/id) for resolution.  </li> <li>Publish settlement calendars (ZA/ZW) and cutoffs for consumers.</li> </ul>"},{"location":"10-payments-nucleus/components/directory-routing/#interfaces","title":"\ud83d\udd0c Interfaces","text":""},{"location":"10-payments-nucleus/components/directory-routing/#http","title":"HTTP","text":"<ul> <li><code>GET /routes?bin|memberId|rail=...</code>   \u2192 <code>{ endpoint, fees, settlementWindow, constraints }</code></li> </ul> <p>Examples:</p> <p><code>GET /routes?bin=438742</code> <pre><code>{\n  \"endpoint\": \"https://api.processor.example/payments\",\n  \"fees\": { \"type\": \"percentage\", \"value\": 0.02 },\n  \"settlementWindow\": { \"cutoff\": \"16:30\", \"timezone\": \"Africa/Johannesburg\" },\n  \"constraints\": { \"currencies\": [\"ZAR\",\"USD\"], \"limitsMinor\": { \"max\": 10000000 } }\n}\n</code></pre></p> <ul> <li> <p><code>GET /institutions/:id</code>   \u2192 <code>{ id, name, rail, endpoint, fees, windows }</code></p> </li> <li> <p><code>GET /calendars/:region</code>   \u2192 <code>{ region: \"ZA\"|\"ZW\", holidays: [...], timezone }</code></p> </li> </ul> <p>Example: <pre><code>{\n  \"region\": \"ZA\",\n  \"timezone\": \"Africa/Johannesburg\",\n  \"holidays\": [\"2025-01-01\",\"2025-03-21\",\"2025-04-18\"]\n}\n</code></pre></p>"},{"location":"10-payments-nucleus/components/directory-routing/#events-emit","title":"Events (emit)","text":"<ul> <li><code>directory.version.updated</code> </li> <li><code>{ versionId, effectiveFrom, source, checksum }</code></li> </ul> <p>Example: <pre><code>{\n  \"eventId\": \"018f3e00-2222-7f00-b1e3-7a7f5d3b9b10\",\n  \"type\": \"directory.version.updated\",\n  \"v\": 1,\n  \"occurredAt\": \"2025-08-27T08:00:00Z\",\n  \"tenantId\": \"system\",\n  \"payload\": {\n    \"versionId\": \"dir_v2025-08-27_01\",\n    \"effectiveFrom\": \"2025-08-27T09:00:00+02:00\",\n    \"source\": \"bank-codes+fees-portal\",\n    \"checksum\": \"sha256:abcd...\"\n  }\n}\n</code></pre></p>"},{"location":"10-payments-nucleus/components/directory-routing/#admin-time-via-platformbase","title":"Admin &amp; Time (via Platform/Base)","text":"<ul> <li>Admin: <code>GET /live</code>, <code>GET /ready</code>, <code>GET /metrics</code>, <code>GET /version</code>.</li> <li>Time helpers: banking-day logic and cutoffs use Platform/Base calendars (<code>Africa/Johannesburg</code>, <code>Africa/Harare</code>).</li> </ul>"},{"location":"10-payments-nucleus/components/directory-routing/#data-model","title":"\ud83d\uddc4 Data Model","text":"<ul> <li><code>institutions</code> (id, name, rail, endpoint, status)  </li> <li><code>bins</code> (bin, institutionId, effectiveFrom/to)  </li> <li><code>fees</code> (tenantId, rail, feeType, value, effectiveFrom/to)  </li> <li><code>windows</code> (rail, cutoffTimes, timezone)  </li> <li><code>bank_codes</code> (ZA code, institutionId)  </li> <li><code>proxy_rules</code> (type, constraints, effectiveFrom/to)  </li> <li><code>calendars</code> (region, date, description)  </li> <li><code>directory_versions</code> </li> <li><code>outbox_directory</code> </li> </ul>"},{"location":"10-payments-nucleus/components/directory-routing/#sequence","title":"\ud83d\udcd0 Sequence","text":"<pre><code>sequenceDiagram\n  participant CTS\n  participant DR as Directory\n  participant EXT as External Source\n\n  CTS-&gt;&gt;DR: GET /routes?bin=438742\n  DR-&gt;&gt;DR: lookup BIN \u2192 institution \u2192 endpoint\n  DR--&gt;&gt;CTS: { endpoint, fees, window }\n  DR-&gt;&gt;EXT: scheduled refresh (daily)\n  EXT--&gt;&gt;DR: new version\n  DR--&gt;&gt;CTS: directory.version.updated</code></pre>"},{"location":"10-payments-nucleus/components/directory-routing/#failure-modes","title":"\ud83d\udea8 Failure Modes","text":"<ul> <li>Unknown BIN \u2192 return error <code>ROUTE_NOT_FOUND</code>.  </li> <li>Source unavailable \u2192 keep prior version, alert ops.  </li> <li>Fee mismatch \u2192 reconciliation alerts via Operator Console.</li> </ul>"},{"location":"10-payments-nucleus/components/directory-routing/#observability","title":"\ud83d\udcca Observability","text":"<ul> <li>Metrics: lookup latency, cache hit rate, version age.  </li> <li>Logs: institutionId, versionId.  </li> <li>Alerts: stale version &gt; SLA.</li> </ul>"},{"location":"10-payments-nucleus/components/directory-routing/#security","title":"\ud83d\udd10 Security","text":"<ul> <li>Access control: only CTS and gateways query directory.  </li> <li>Version artifacts signed and checksummed.</li> </ul>"},{"location":"10-payments-nucleus/components/directory-routing/#runbooks","title":"\ud83e\udded Runbooks","text":"<ul> <li>Stale directory \u2192 re-run refresh job.  </li> <li>Incorrect fee \u2192 override with effectiveFrom and patch ADR.  </li> <li>BIN not routing \u2192 add mapping, redeploy version.</li> </ul>"},{"location":"10-payments-nucleus/components/event-bus-outbox/","title":"Event Bus &amp; Outbox \u2014 How It Works (Exactly)","text":"<p>Target stack: Aurora PostgreSQL + RDS Proxy + SNS FIFO + SQS FIFO (Option A)</p>"},{"location":"10-payments-nucleus/components/event-bus-outbox/#the-contract","title":"The contract","text":"<ul> <li>Exactly-once at the producer boundary via a transactional outbox (state and event row committed together).</li> <li>At-least-once across the bus: consumers must be idempotent and dedupe (<code>eventId</code>, optionally domain keys).</li> </ul>"},{"location":"10-payments-nucleus/components/event-bus-outbox/#components-roles","title":"Components &amp; Roles","text":"<pre><code>flowchart LR\n  subgraph \"Producer Service (e.g., CTS)\"\n    A[\"Write Model / DB\"]\n    O[(\"Outbox Table\")]\n    D[\"Dispatcher Worker\"]\n  end\n\n  subgraph \"Bus (SNS FIFO + SQS FIFO)\"\n    T[[\"Topic: events.transfers (SNS FIFO)\"]]\n    Q1[[\"Queue: gateway.usdc (SQS FIFO)\"]]\n    Q2[[\"Queue: ledger.postings (SQS FIFO)\"]]\n    Q3[[\"Queue: projections.timeline (SQS FIFO)\"]]\n  end\n\n  subgraph \"Consumers\"\n    G[\"Gateway (USDC)\"]\n    L[\"Ledger Service\"]\n    P[\"Projection / Read Model\"]\n    I[(\"Inbox Table for Dedupe\")]\n  end\n\n  A --&gt; O\n  D --&gt; T\n  T --&gt; Q1 --&gt; G\n  T --&gt; Q2 --&gt; L\n  T --&gt; Q3 --&gt; P --&gt; I\n</code></pre>"},{"location":"10-payments-nucleus/components/event-bus-outbox/#happy-path-sequence","title":"Happy Path Sequence","text":"<pre><code>sequenceDiagram\n  autonumber\n  participant S as \"Producer (CTS/API)\"\n  participant DB as \"Aurora (state + outbox)\"\n  participant W as \"Dispatcher\"\n  participant SNS as \"SNS FIFO Topic\"\n  participant QG as \"SQS FIFO (gateway.usdc)\"\n  participant GW as \"Consumer (Gateway USDC)\"\n\n  S-&gt;&gt;DB: BEGIN \u2192 insert transfer + outbox(event=submitted.usdc) \u2192 COMMIT\n  Note over S,DB: State and event are now durable together\n  W-&gt;&gt;DB: select PENDING rows (FOR UPDATE SKIP LOCKED)\n  W-&gt;&gt;SNS: publish(event) {GroupId=transferId, DedupId=eventId}\n  W-&gt;&gt;DB: mark outbox row = SENT\n  SNS--&gt;&gt;QG: deliver copy\n  QG-&gt;&gt;GW: receive message\n  GW-&gt;&gt;GW: idempotency check (inbox by eventId)\n  GW-&gt;&gt;Rail: submit on USDC (side-effect)\n  GW--&gt;&gt;QG: delete/ack message\n  GW-&gt;&gt;SNS: emit events.transfers.accepted / settled (as producer)\n</code></pre> <p>Arrow semantics</p> <ul> <li>Solid arrows = synchronous calls (DB, publish, ack).</li> <li>Events flow via SNS/SQS FIFO; ordering per transfer enforced with <code>MessageGroupId = transferId</code>.</li> </ul>"},{"location":"10-payments-nucleus/components/event-bus-outbox/#data-shapes","title":"Data Shapes","text":""},{"location":"10-payments-nucleus/components/event-bus-outbox/#event-envelope","title":"Event envelope","text":"<pre><code>{\n  \"envelope\": {\n    \"v\": 1,\n    \"eventId\": \"uuid\",\n    \"occurredAt\": \"2025-08-26T10:15:01Z\",\n    \"tenantId\": \"tnt_123\",\n    \"traceparent\": \"00-...\",\n    \"type\": \"events.transfers.submitted.usdc\"\n  },\n  \"key\": { \"transferId\": \"tr_123\" },\n  \"payload\": {\n    \"amount\": {\"value\":\"100.00\",\"currency\":\"USD\"},\n    \"payer\": {\"type\":\"WALLET\",\"id\":\"payer-abc\"},\n    \"payee\": {\"type\":\"WALLET\",\"id\":\"0x...\"}\n  }\n}\n</code></pre> <p>Bus mapping: <code>MessageGroupId = key.transferId</code>, <code>MessageDeduplicationId = envelope.eventId</code>.</p>"},{"location":"10-payments-nucleus/components/event-bus-outbox/#outbox-table-producer-db","title":"Outbox table (producer DB)","text":"id eventType payload (JSONB) state attempts lastError next_attempt createdAt updatedAt uuid <code>events.transfers.submitted.usdc</code> <code>{envelope,key,payload}</code> PENDING/SENT/FAILED int text ts ts ts"},{"location":"10-payments-nucleus/components/event-bus-outbox/#inbox-table-consumer-db-optional","title":"Inbox table (consumer DB) \u2014 optional","text":"eventId (PK) processedAt uuid ts"},{"location":"10-payments-nucleus/components/event-bus-outbox/#failure-retry-semantics","title":"Failure &amp; Retry Semantics","text":""},{"location":"10-payments-nucleus/components/event-bus-outbox/#producerdispatcher","title":"Producer/Dispatcher","text":"<pre><code>sequenceDiagram\n  autonumber\n  participant W as \"Dispatcher\"\n  participant DB as \"Outbox\"\n  participant SNS as \"SNS\"\n\n  W-&gt;&gt;DB: fetch PENDING (batch)\n  W-&gt;&gt;SNS: publish\n  alt publish error\n    W-&gt;&gt;DB: attempts++ , state=PENDING , next_attempt = now + backoff\n  else attempts &gt;= RETRY_MAX\n    W-&gt;&gt;DB: state=FAILED , lastError\n  end\n</code></pre>"},{"location":"10-payments-nucleus/components/event-bus-outbox/#consumer","title":"Consumer","text":"<pre><code>flowchart LR\n  M[\"Message from SQS FIFO\"] --&gt; C{\"Seen before? (inbox by eventId)\"}\n  C -- \"Yes\" --&gt; A[\"Ack/Delete\"]\n  C -- \"No\" --&gt; H[\"Handle side-effect\"]\n  H --&gt; R{\"Success?\"}\n  R -- \"Yes\" --&gt; I[\"Insert inbox row\"] --&gt; A\n  R -- \"No\" --&gt; E[\"Throw / do not ack; SQS retries \u2192 DLQ\"]\n</code></pre>"},{"location":"10-payments-nucleus/components/event-bus-outbox/#exactly-once-boundary-responsibilities","title":"Exactly-once boundary &amp; responsibilities","text":"<ul> <li>Producer: guarantees each event is published once or fails visible (SENT/FAILED). No duplicates marked SENT.</li> <li>Bus: may deliver duplicates or retries (at-least-once).</li> <li>Consumer: must be idempotent; dedupe via inbox table (or idempotent upsert by domain key).</li> </ul>"},{"location":"10-payments-nucleus/components/event-bus-outbox/#how-other-components-use-it","title":"How other components use it","text":"<ol> <li>CTS \u2192 Gateway(USDC): Gateway subscribes to <code>gateway.usdc</code> queue, dedupes, submits to AVAX, then emits <code>accepted/settled</code>.</li> <li>Gateway \u2192 CTS: CTS inbound consumer updates transfer state and timeline.</li> <li>CTS \u2192 Ledger: Ledger subscribes; posts journal entries idempotently by <code>(transferId,type)</code>.</li> <li>CTS \u2192 Projections: updates read models for dashboards/webhooks.</li> <li>Directory \u2192 CTS: publishes <code>directory.route.updated</code>; CTS invalidates route cache.</li> </ol>"},{"location":"10-payments-nucleus/components/event-bus-outbox/#operational-defaults-adopt-now","title":"Operational defaults (adopt now)","text":"<ul> <li>Dispatcher: batch=50, concurrency=10; backoff: <code>1s,5s,30s,2m,10m,1h</code>; RETRY_MAX=10.</li> <li>SQS visibility timeout: \u2265 2\u00d7 handler p99.</li> <li>Alarms: <code>event_outbox_backlog</code>, <code>event_publish_lag_seconds</code>, <code>dead_letter_count</code>, <code>event_consumer_lag_seconds</code>.</li> </ul>"},{"location":"10-payments-nucleus/components/event-bus-outbox/#wire-test-localcloud-sanity-checks","title":"Wire Test (local/cloud sanity checks)","text":""},{"location":"10-payments-nucleus/components/event-bus-outbox/#1-sql-outbox-schema-seed","title":"1) SQL \u2014 Outbox schema &amp; seed","text":"<pre><code>CREATE TABLE IF NOT EXISTS outbox (\n  id uuid PRIMARY KEY,\n  eventType text NOT NULL,\n  payload jsonb NOT NULL,\n  state text NOT NULL DEFAULT 'PENDING',\n  attempts int NOT NULL DEFAULT 0,\n  lastError text,\n  next_attempt timestamptz NOT NULL DEFAULT now(),\n  createdAt timestamptz NOT NULL DEFAULT now(),\n  updatedAt timestamptz NOT NULL DEFAULT now()\n);\n\n-- Insert a fake submitted.usdc event\nINSERT INTO outbox (id, eventType, payload)\nVALUES (\n  gen_random_uuid(),\n  'events.transfers.submitted.usdc',\n  jsonb_build_object(\n    'envelope', jsonb_build_object('v',1,'eventId', gen_random_uuid()::text, 'occurredAt', now(), 'tenantId','tnt_demo','type','events.transfers.submitted.usdc'),\n    'key', jsonb_build_object('transferId','tr_test_123'),\n    'payload', jsonb_build_object('amount', jsonb_build_object('value','10.00','currency','USD'))\n  )\n);\n</code></pre>"},{"location":"10-payments-nucleus/components/event-bus-outbox/#2-aws-cli-bus-quick-setup-example","title":"2) AWS CLI \u2014 Bus quick setup (example)","text":"<pre><code># Create SNS FIFO topic\naws sns create-topic --name events.transfers.fifo --attributes FifoTopic=true,ContentBasedDeduplication=false\n\n# Create SQS FIFO queue for gateway\naws sqs create-queue --queue-name gateway.usdc.fifo \\\n  --attributes FifoQueue=true,ContentBasedDeduplication=false,VisibilityTimeout=60\n\n# Subscribe queue to topic\naws sns subscribe --topic-arn &lt;SNS_ARN&gt; --protocol sqs --notification-endpoint &lt;SQS_ARN&gt;\n\n# Allow SNS to publish to SQS (set queue policy accordingly)\n</code></pre>"},{"location":"10-payments-nucleus/components/event-bus-outbox/#3-dispatcher-mock-python","title":"3) Dispatcher mock (Python)","text":"<pre><code>import os, json, time, uuid, psycopg2, boto3\n\nSNS_ARN = os.environ['SNS_ARN']\nconn = psycopg2.connect(os.environ['PG_DSN'])\nsns = boto3.client('sns', region_name=os.environ.get('AWS_REGION','us-east-1'))\n\nBACKOFF = [1,5,30,120,600,3600]\n\nwhile True:\n    with conn, conn.cursor() as cur:\n        cur.execute(\"\"\"\n          SELECT id, payload\\n          FROM outbox\\n          WHERE state='PENDING' AND next_attempt &lt;= now()\\n          ORDER BY createdAt\\n          FOR UPDATE SKIP LOCKED\\n          LIMIT 50\n        \"\"\")\n        rows = cur.fetchall()\n        for oid, payload in rows:\n            env = payload['envelope']\n            key = payload['key']\n            try:\n                sns.publish(\n                  TopicArn=SNS_ARN,\n                  Message=json.dumps(payload),\n                  MessageGroupId=key['transferId'],\n                  MessageDeduplicationId=env['eventId']\n                )\n                cur.execute(\"UPDATE outbox SET state='SENT', attempts=attempts+1, updatedAt=now() WHERE id=%s\", (oid,))\n            except Exception as e:\n                cur.execute(\"\"\"\n                  UPDATE outbox\n                     SET attempts=attempts+1,\n                         lastError=%s,\n                         next_attempt=now() + make_interval(secs =&gt; %s),\n                         updatedAt=now(),\n                         state = CASE WHEN attempts &gt;= 10 THEN 'FAILED' ELSE 'PENDING' END\n                   WHERE id=%s\n                \"\"\", (str(e), BACKOFF[min(len(BACKOFF)-1, 0)], oid))\n    time.sleep(1)\n</code></pre>"},{"location":"10-payments-nucleus/components/event-bus-outbox/#4-consumer-mock-python","title":"4) Consumer mock (Python)","text":"<pre><code>import os, json, boto3, datetime\n\nsqs = boto3.client('sqs', region_name=os.environ.get('AWS_REGION','us-east-1'))\nQUEUE_URL = os.environ['QUEUE_URL']\n\nwhile True:\n    resp = sqs.receive_message(QueueUrl=QUEUE_URL, MaxNumberOfMessages=1, WaitTimeSeconds=10)\n    for m in resp.get('Messages', []):\n        body = json.loads(m['Body'])\n        payload = json.loads(body.get('Message', '{}'))\n        evt = payload.get('envelope', {})\n        print('Got event', evt.get('type'), evt.get('eventId'), datetime.datetime.utcnow().isoformat())\n        # TODO: dedupe check by eventId in inbox table\n        sqs.delete_message(QueueUrl=QUEUE_URL, ReceiptHandle=m['ReceiptHandle'])\n</code></pre> <p>These mocks are for wiring/visibility; production code should use a proper worker framework, metrics, and inbox dedupe.</p>"},{"location":"10-payments-nucleus/components/event-bus-outbox/#runbooks-condensed","title":"Runbooks (condensed)","text":"<ul> <li>Outbox backlog rising \u2192 check dispatcher logs; SNS/SQS publish errors; scale workers; review DLQ.</li> <li>Consumer lag rising \u2192 scale consumers; increase visibility timeout; profile handler.</li> <li>Duplicate effects \u2192 ensure inbox/dedupe; verify <code>MessageGroupId</code>/<code>DeduplicationId</code> mapping.</li> <li>FAILED outbox rows \u2192 fix cause; re-drive by <code>eventId</code> using admin tool.</li> </ul>"},{"location":"10-payments-nucleus/components/event-bus-outbox/#security-pii","title":"Security &amp; PII","text":"<ul> <li>Events contain IDs, not PII. Outbox payloads are encrypted at rest.</li> <li>IAM: producer can publish to the topic; consumers can read only their queues.</li> </ul>"},{"location":"10-payments-nucleus/components/ledger-service/","title":"Ledger Service","text":"<p>The Ledger Service is Stalela\u2019s book of record. It maintains double\u2011entry journals, computes balances, exposes statements, and guarantees that every money movement is represented by a balanced set of postings. If it isn\u2019t posted here, it didn\u2019t happen.</p>"},{"location":"10-payments-nucleus/components/ledger-service/#purpose","title":"\ud83c\udfaf Purpose","text":"<ul> <li>Enforce double\u2011entry accounting for all transfers across rails.  </li> <li>Provide authoritative balances and auditable journals.  </li> <li>Support authorization \u2192 capture \u2192 reversal/return lifecycles.  </li> <li>Handle multi\u2011currency with explicit FX conversion and P&amp;L.  </li> <li>Export partner statements (BAI2\u2011like) and support reconciliation.</li> </ul>"},{"location":"10-payments-nucleus/components/ledger-service/#responsibilities","title":"\ud83d\udee0 Responsibilities","text":"<ul> <li>Consume domain events and apply posting rules:</li> <li><code>transfers.accepted</code> (hold / memo postings where applicable)</li> <li><code>transfers.settled</code> (final postings)</li> <li><code>transfers.returned</code> (reversal postings)</li> <li>Maintain derived balances (by account, currency).  </li> <li>Emit <code>ledger.balance.updated</code> and <code>ledger.posting.created</code>.  </li> <li>Provide read APIs: balances, journals, statements.  </li> <li>Guard rails: append\u2011only journals; reversals via new entries only.</li> </ul>"},{"location":"10-payments-nucleus/components/ledger-service/#interfaces","title":"\ud83d\udd0c Interfaces","text":""},{"location":"10-payments-nucleus/components/ledger-service/#events-consume-envelope-v1","title":"Events (consume; envelope <code>v=1</code>)","text":"<ul> <li><code>transfers.accepted</code></li> <li><code>transfers.settled</code></li> <li><code>transfers.returned</code></li> </ul> <p>Dedupe per Events spec: see ../specs/events.md (consumer idempotency by <code>eventId</code>, lifecycle uniqueness for <code>(transferId,type)</code>).</p>"},{"location":"10-payments-nucleus/components/ledger-service/#events-emit-envelope-v1","title":"Events (emit; envelope <code>v=1</code>)","text":"<ul> <li><code>ledger.posting.created</code></li> <li><code>ledger.balance.updated</code></li> </ul>"},{"location":"10-payments-nucleus/components/ledger-service/#http-readonly","title":"HTTP (read\u2011only)","text":"<ul> <li><code>GET /balances?accountId=...&amp;currency=...</code></li> <li><code>GET /journal?transferId=...</code> or <code>?accountId=...&amp;from=...&amp;to=...</code></li> <li><code>GET /statements?accountId=...&amp;from=...&amp;to=...&amp;format=bai2|json</code></li> </ul>"},{"location":"10-payments-nucleus/components/ledger-service/#admin-via-platformbase","title":"Admin (via Platform/Base)","text":"<ul> <li><code>GET /live</code>, <code>GET /ready</code>, <code>GET /metrics</code>, <code>GET /version</code> provided by Platform/Base and adopted by Ledger.</li> </ul> <p>Write access is event\u2011driven only. Manual adjustments are rare and must go through the Operator Console using explicit adjustment events with approvals/audit.</p>"},{"location":"10-payments-nucleus/components/ledger-service/#data-model","title":"\ud83d\uddc4 Data Model","text":"<p>tables - <code>accounts</code>   - <code>accountId</code> (pk), <code>type</code> (USER|MERCHANT|LIQUIDITY|FEES|FX|SETTLEMENT|RESERVE|NOSTRO|VOSTRO), <code>tenantId?</code>, <code>currency?</code> (nullable if multi\u2011currency), <code>status</code>, <code>createdAt</code> - <code>journals</code> (immutable)   - <code>journalId</code> (pk), <code>transferId</code>, <code>eventType</code>, <code>occurredAt</code>, <code>memo</code>, <code>exchangeControlRef?</code> - <code>postings</code> (append\u2011only)   - <code>postingId</code> (pk), <code>journalId</code> (fk), <code>debitAccountId</code>, <code>creditAccountId</code>, <code>amountMinor</code>, <code>currency</code>, <code>memo</code> - <code>balances</code> (materialized)   - <code>accountId</code>, <code>currency</code>, <code>balanceMinor</code>, <code>asOf</code> - <code>outbox_ledger</code> \u2013 for emitted events</p> <p>blobs (encrypted) - optional statement snapshots; export artifacts</p>"},{"location":"10-payments-nucleus/components/ledger-service/#posting-rules-canonical","title":"\ud83e\uddee Posting Rules (canonical)","text":"<p>See: ../specs/posting-rules.md</p> <p>All amounts are in minor units (e.g., cents). Examples assume a customer pays a merchant 100.00 with a 1.00 fee.</p>"},{"location":"10-payments-nucleus/components/ledger-service/#1-accepted-authorization-hold-rails-that-support-authcapture","title":"1) Accepted (authorization / hold) \u2014 rails that support AUTH/CAPTURE","text":"<p>Create memo/hold journal (off\u2011balance or flagged): - Debit: <code>USER_AUTH_HOLD</code> (memo) \u2014 10000 - Credit: <code>LIQUIDITY_AUTH_PENDING</code> (memo) \u2014 10000</p> <p>If the rail has no auth concept (e.g., USDC push), no accepted postings are created.</p>"},{"location":"10-payments-nucleus/components/ledger-service/#2-settled-final-funds-move","title":"2) Settled (final funds move)","text":"<p>Core settlement postings: - Debit: <code>USER</code> \u2014 10000 - Credit: <code>MERCHANT</code> \u2014 9900 - Credit: <code>FEES</code> \u2014 100   (Stalela take rate)</p> <p>If FX occurs (payer USD \u2192 merchant ZAR), split legs: - Debit: <code>USER</code> \u2014 10000 USD - Credit: <code>LIQUIDITY</code> \u2014 10000 USD - Debit: <code>LIQUIDITY</code> \u2014 180000 ZAR - Credit: <code>MERCHANT</code> \u2014 180000 ZAR - Credit/Debit: <code>FX_PNL</code> \u2014 difference from quoted vs realized</p> <p>Cross\u2011border flows may include legs to/from <code>NOSTRO</code>/<code>VOSTRO</code> accounts to reflect settlement with external banks.</p>"},{"location":"10-payments-nucleus/components/ledger-service/#vat-on-fees-za","title":"VAT on Fees (ZA)","text":"<ul> <li>When fees are vatable, split into <code>FEES_NET</code> and <code>FEES_VAT</code> credits as per <code>20-specs/tax-vat.md</code>.</li> </ul>"},{"location":"10-payments-nucleus/components/ledger-service/#3-returned-chargeback-reverse-prior-settled","title":"3) Returned / Chargeback (reverse prior settled)","text":"<p>Post the exact contra of the settlement set, preserving original currency: - Debit: <code>MERCHANT</code> \u2014 9900 - Debit: <code>FEES</code> \u2014 100   (or use <code>FEES_REVERSAL</code> to separate) - Credit: <code>USER</code> \u2014 10000</p> <p>For partial returns, amounts reflect the returned portion; keep link to original journal via <code>relatedJournalId</code> (in <code>journals.memo</code>).</p>"},{"location":"10-payments-nucleus/components/ledger-service/#4-fees-surcharges","title":"4) Fees &amp; Surcharges","text":"<ul> <li>Percentage fees applied at settlement time as separate credit to <code>FEES</code> account.  </li> <li>Per\u2011rail surcharges (e.g., OPPWA) post to <code>FEES_PARTNER</code> account and are netted in reconciliation.</li> </ul>"},{"location":"10-payments-nucleus/components/ledger-service/#5-rounding","title":"5) Rounding","text":"<ul> <li>Use banker\u2019s rounding when converting decimals \u2192 minor units.  </li> <li>Any rounding residual posts to <code>FX_PNL_ROUNDING</code> (must be near\u2011zero).</li> </ul>"},{"location":"10-payments-nucleus/components/ledger-service/#diagrams","title":"\ud83d\udcd0 Diagrams","text":""},{"location":"10-payments-nucleus/components/ledger-service/#event-posting-pipeline","title":"Event \u2192 Posting pipeline","text":"<pre><code>flowchart LR\n  EV[transfers.* event] --&gt; PR[Posting Rules]\n  PR --&gt; JR[Create Journal]\n  JR --&gt; PT[Append Postings (balanced)]\n  PT --&gt; BL[Update Balances]\n  PT --&gt; OE[Emit ledger.posting.created]\n  BL --&gt; BE[Emit ledger.balance.updated]</code></pre>"},{"location":"10-payments-nucleus/components/ledger-service/#settlement-example-no-fx","title":"Settlement example (no FX)","text":"<pre><code>sequenceDiagram\n  participant GW as Rail Gateway\n  participant L as Ledger\n  participant S as Balance Store\n\n  GW--&gt;&gt;L: transfers.settled {amount=10000, fee=100}\n  L-&gt;&gt;L: create journal J1\n  L-&gt;&gt;L: postings: D USER 10000 / C MERCHANT 9900 / C FEES 100\n  L-&gt;&gt;S: update balances (USER-, MERCHANT+, FEES+)\n  L--&gt;&gt;GW: ledger.posting.created (J1)</code></pre>"},{"location":"10-payments-nucleus/components/ledger-service/#invariants","title":"\ud83e\uddf1 Invariants","text":"<ul> <li>Balanced: sum(debits) == sum(credits) per journal.  </li> <li>Append\u2011only: no deletes; corrections via new journals.  </li> <li>Idempotent: journal key = hash(<code>transferId</code>,<code>eventType</code>,<code>sequence</code>); duplicates ignored.  </li> <li>Temporal: <code>occurredAt</code> from event; do not rewrite history.</li> </ul> <p>Consumer idempotency: dedupe inbound events by <code>eventId</code>, and enforce lifecycle uniqueness <code>(transferId,eventType)</code> to avoid double-posting.</p>"},{"location":"10-payments-nucleus/components/ledger-service/#failure-modes-retries","title":"\ud83d\udea8 Failure Modes &amp; Retries","text":"<ul> <li>Duplicate event \u2192 ignored via idempotency key.  </li> <li>Currency mismatch (account vs posting) \u2192 reject and raise operator alert.  </li> <li>Negative balance constraints (if configured) \u2192 block posting and raise exception.  </li> <li>Outbox publish failure \u2192 retry with backoff; no partial commits (journal + outbox in same txn).</li> </ul>"},{"location":"10-payments-nucleus/components/ledger-service/#observability","title":"\ud83d\udcca Observability","text":"<ul> <li>Metrics: <code>journals/sec</code>, <code>postings/sec</code>, balance update latency, idempotency drop rate.  </li> <li>Gauges: outstanding reversal backlog, FX_PNL daily total.  </li> <li>Logs: structured with <code>transferId</code>, <code>journalId</code>, <code>accountId</code>, <code>currency</code>.  </li> <li>Traces: span across event reception \u2192 journal write \u2192 outbox publish.</li> </ul>"},{"location":"10-payments-nucleus/components/ledger-service/#security","title":"\ud83d\udd10 Security","text":"<ul> <li>Least privilege DB role; append\u2011only constraints at the schema level if possible.  </li> <li>PII: account metadata stored outside postings; journals contain IDs only.  </li> <li>Statement exports signed + timestamped; encrypt artifacts at rest.  </li> <li>Admin endpoints behind service mesh authN/Z; metrics unauthenticated readiness only.</li> </ul>"},{"location":"10-payments-nucleus/components/ledger-service/#config","title":"\u2699\ufe0f Config","text":"<ul> <li><code>LEDGER_BASE_CURRENCY</code> (reporting), supported currencies.  </li> <li><code>NEGATIVE_BALANCE_POLICY</code> (ALLOW|BLOCK|WARN).  </li> <li><code>FX_QUOTE_SOURCE</code> (provider, TTL).  </li> <li><code>STATEMENT_FORMATS</code> (bai2,json), <code>STATEMENT_TIMEZONE</code>.  </li> <li><code>IDEMPOTENCY_SALT</code> for journal keys.</li> </ul>"},{"location":"10-payments-nucleus/components/ledger-service/#runbooks","title":"\ud83d\udcd8 Runbooks","text":"<ul> <li>Balances off vs partner \u2192 run T+0/T+1 reconciliation; inspect unmatched queue; verify posting rules version.  </li> <li>FX_PNL spikes \u2192 check quote source latency; ensure correct pair &amp; decimals.  </li> <li>Reversal backlog \u2192 confirm returns events being emitted; investigate gateway DLQs.  </li> <li>Throughput degradation \u2192 check DB contention on <code>balances</code>; consider batched/materialized updates.</li> </ul>"},{"location":"10-payments-nucleus/components/ledger-service/#slos","title":"\ud83d\udccf SLOs","text":"<ul> <li>Posting latency (P99) \u2264 1s after <code>transfers.settled</code>.  </li> <li>Idempotency duplicate acceptance rate \u2264 0.1%.  </li> <li>Balance read latency (P99) \u2264 200 ms.  </li> <li>Statement generation \u2264 60 s for 100k postings.</li> </ul>"},{"location":"10-payments-nucleus/components/ledger-service/#test-matrix-essentials","title":"\ud83e\uddea Test Matrix (essentials)","text":"<ul> <li>Round\u2011trip: accepted \u2192 settled \u2192 returned (full &amp; partial).  </li> <li>Multi\u2011currency settlement with FX &amp; rounding residuals.  </li> <li>Idempotency under concurrent duplicates.  </li> <li>Negative balance policy enforcement.  </li> <li>Statement export byte\u2011for\u2011byte determinism for a fixed fixture.</li> </ul>"},{"location":"10-payments-nucleus/components/ledger-service/#example-journal-posting-payloads","title":"Example: Journal &amp; Posting payloads","text":"<p>Journal (emitted event payload) <pre><code>{\n  \"journalId\": \"jrnl_01HZX...\",\n  \"transferId\": \"tr_01HZY...\",\n  \"eventType\": \"transfers.settled\",\n  \"occurredAt\": \"2025-08-26T10:15:01Z\",\n  \"memo\": \"settlement zimswitch batch 8341\",\n  \"exchangeControlRef\": \"ec_ABC123\"\n}\n</code></pre></p> <p>Posting (emitted event payload) <pre><code>{\n  \"postingId\": \"pst_01HZ...\",\n  \"journalId\": \"jrnl_01HZX...\",\n  \"debitAccountId\": \"acct_user_123\",\n  \"creditAccountId\": \"acct_merchant_987\",\n  \"amountMinor\": 9900,\n  \"currency\": \"ZAR\",\n  \"memo\": \"net to merchant\"\n}\n</code></pre></p> <p>Bottom line: The Ledger turns messy rail realities into deterministic, balanced, auditable facts. Everything else in Stalela depends on this discipline.</p>"},{"location":"10-payments-nucleus/components/operator-console/","title":"Operator Console","text":"<p>The Operator Console is the human-facing interface for resolving exceptions, monitoring transfers, and acting on compliance/reconciliation workflows.</p>"},{"location":"10-payments-nucleus/components/operator-console/#purpose","title":"\ud83c\udfaf Purpose","text":"<ul> <li>Provide operators with clear visibility into transfer timelines.  </li> <li>Enable manual intervention for returns, unmatched items, compliance flags.  </li> <li>Reduce need for engineers to access production systems.  </li> </ul>"},{"location":"10-payments-nucleus/components/operator-console/#responsibilities","title":"\ud83d\udee0 Responsibilities","text":"<ul> <li>Display transfer timelines (events, postings).  </li> <li>Show queues: returns, reconciliation exceptions, compliance hits.  </li> <li>Allow manual resolution: assign unmatched, trigger return, freeze/unfreeze entity.  </li> <li>Surface system health and metrics dashboards.  </li> </ul>"},{"location":"10-payments-nucleus/components/operator-console/#interfaces","title":"\ud83d\udd0c Interfaces","text":"<ul> <li>Web UI (internal only, authenticated via SSO).  </li> <li>Reads from CTS, Ledger, Compliance, Recon.  </li> <li>Writes via APIs only (never direct DB):  </li> <li><code>POST /returns</code> </li> <li><code>POST /entity/freeze</code> </li> <li><code>POST /entity/unfreeze</code> </li> </ul>"},{"location":"10-payments-nucleus/components/operator-console/#sequence","title":"\ud83d\udcd0 Sequence","text":"<pre><code>sequenceDiagram\n  participant O as Operator\n  participant OC as Operator Console\n  participant CTS\n  participant Recon\n  participant Compliance\n\n  O-&gt;&gt;OC: view unmatched\n  OC-&gt;&gt;Recon: GET /exceptions\n  O-&gt;&gt;OC: resolve exception\n  OC-&gt;&gt;CTS: POST /returns {transferId, reason}\n  CTS--&gt;&gt;OC: transfers.returned event</code></pre>"},{"location":"10-payments-nucleus/components/operator-console/#localization-i18n","title":"\ud83c\udf0d Localization (i18n)","text":"<ul> <li>Supported languages: English (en), Afrikaans (af), Zulu (zu), Xhosa (xh), Sotho (st), Tswana (tn).  </li> <li>Strategy: externalized message catalog with keys; locale switch per user.  </li> <li>PII: ensure translations do not expose sensitive data; placeholders only.  </li> </ul>"},{"location":"10-payments-nucleus/components/operator-console/#failure-modes","title":"\ud83d\udea8 Failure Modes","text":"<ul> <li>Stale data \u2192 refresh from APIs, not cached snapshots.  </li> <li>Unauthorized access \u2192 enforce SSO + RBAC.  </li> <li>Operator error \u2192 require 4-eyes approval for destructive actions (returns, freezes).  </li> </ul>"},{"location":"10-payments-nucleus/components/operator-console/#observability","title":"\ud83d\udcca Observability","text":"<ul> <li>Audit log of every operator action (immutable).  </li> <li>Metrics: queue sizes, resolution times.  </li> <li>Alerts: backlog &gt; SLA.</li> </ul>"},{"location":"10-payments-nucleus/components/operator-console/#security","title":"\ud83d\udd10 Security","text":"<ul> <li>SSO + role-based access (OPS, COMPLIANCE, ADMIN).  </li> <li>Audit trail mandatory.  </li> <li>PII redacted where not necessary.  </li> </ul>"},{"location":"10-payments-nucleus/components/operator-console/#runbooks","title":"\ud83e\udded Runbooks","text":"<ul> <li>Recon backlog \u2192 assign extra operators.  </li> <li>False compliance flag \u2192 unfreeze with reason, record override.  </li> <li>Frequent operator overrides \u2192 escalate rule/threshold tuning.</li> </ul>"},{"location":"10-payments-nucleus/components/orchestration-ai-agents/","title":"Orchestration AI Agents","text":"<p>The AI orchestration layer augments Canonical Transfer Service (CTS) decisioning with stateless, observable agents. Each agent evaluates a specific dimension\u2014route performance, risk posture, or platform health\u2014and publishes structured events that loop back into CTS, Directory, and Compliance flows.</p>"},{"location":"10-payments-nucleus/components/orchestration-ai-agents/#agent-overview","title":"Agent Overview","text":"Agent Primary Goal Inputs Outputs Invocation Path Smart Rail Selector Rank available rails against policy weights and runtime health Transfer intent, policy weights, rail metrics Ranked rail list, selected rail, scoring metadata CTS orchestration pipeline prior to Directory call Dynamic Risk Classifier Assign adaptive compliance tiers Payer/payee metadata, device signals, historical incidents Risk tier, confidence, contributing features CTS compliance step (pre-screen and re-evaluate on state changes) Rail Health Monitor Track infrastructure health and flag degraded rails Events, rail telemetry (latency, failure rate, uptime), incident feed Health state, recommended throttles, events (<code>rail.flagged.degraded</code>) Continuous streaming microservice subscribed to Event Bus Orchestration Copilot Provide human-friendly explanations and diagnostics Agent event history, policy configuration, observability data Natural language summaries, CLI responses, remediation guidance On-demand via CLI (<code>stalela ctl orchestration explain</code>) or chat assistant"},{"location":"10-payments-nucleus/components/orchestration-ai-agents/#sample-payloads-integration-points","title":"Sample Payloads &amp; Integration Points","text":""},{"location":"10-payments-nucleus/components/orchestration-ai-agents/#smart-rail-selector","title":"Smart Rail Selector","text":"<pre><code>{\n  \"transfer_id\": \"tr_789\",\n  \"intent\": \"PUSH\",\n  \"policy\": {\n    \"optimize_for\": \"cost\",\n    \"fallbacks\": [\"reliability\", \"speed\"],\n    \"preferred_methods\": [\"mobile_money\", \"voucher\"],\n    \"excluded_rails\": [\"card\"]\n  },\n  \"candidates\": [\n    { \"rail\": \"mobile_money\", \"latency_ms\": 480, \"fx_spread_bps\": 15, \"failure_rate\": 0.4 },\n    { \"rail\": \"voucher\", \"latency_ms\": 210, \"fx_spread_bps\": 35, \"failure_rate\": 0.8 },\n    { \"rail\": \"usdc\", \"latency_ms\": 90, \"fx_spread_bps\": 55, \"failure_rate\": 0.2 }\n  ]\n}\n</code></pre> <p>Response fragment published via <code>route.selected.via_ai</code>:</p> <pre><code>{\n  \"selected_path\": [\"mobile_money\", \"voucher\"],\n  \"score\": 0.872,\n  \"features_used\": [\"latency_ms\", \"fx_spread_bps\", \"policy.optimize_for\"],\n  \"explanations\": [\n    \"mobile_money minimizes spread under cost-first policy\",\n    \"voucher provides resilience under reliability fallback\"\n  ]\n}\n</code></pre>"},{"location":"10-payments-nucleus/components/orchestration-ai-agents/#dynamic-risk-classifier","title":"Dynamic Risk Classifier","text":"<pre><code>{\n  \"transfer_id\": \"tr_789\",\n  \"tenant_id\": \"tn_55\",\n  \"entities\": {\n    \"payer\": { \"type\": \"WALLET\", \"country\": \"ZA\", \"device_fingerprint\": \"abc\" },\n    \"payee\": { \"type\": \"BANK\", \"country\": \"NG\", \"kyc_level\": \"basic\" }\n  },\n  \"behavioral_signals\": { \"lifetime_volume\": 12000, \"chargeback_rate\": 0.01 }\n}\n</code></pre> <p>Produces <code>risk.tier.assigned</code> with payload:</p> <pre><code>{\n  \"user_id\": \"payer-abc\",\n  \"risk_score\": 0.34,\n  \"compliance_level\": \"tier_2\",\n  \"features\": [\"country_pair\", \"behavioral.chargeback_rate\"]\n}\n</code></pre>"},{"location":"10-payments-nucleus/components/orchestration-ai-agents/#rail-health-monitor","title":"Rail Health Monitor","text":"<p>Subscribed to <code>events.transfers.*</code> plus telemetry topics. Emits <code>rail.flagged.degraded</code> when thresholds are breached:</p> <pre><code>{\n  \"rail_id\": \"zimswitch\",\n  \"health_metrics\": {\n    \"rolling_failure_rate\": 0.12,\n    \"p99_latency_ms\": 2150,\n    \"uptime_5m\": 0.89\n  },\n  \"timestamp\": \"2025-09-04T15:22:11Z\",\n  \"recommended_action\": \"deprioritize\",\n  \"confidence\": 0.82\n}\n</code></pre>"},{"location":"10-payments-nucleus/components/orchestration-ai-agents/#deployment-model","title":"Deployment Model","text":"<ul> <li>Packaging: Each agent is packaged as a lightweight container or serverless function with gRPC and REST shims.</li> <li>Invocation: CTS invokes Smart Rail Selector and Dynamic Risk Classifier synchronously within orchestration. Rail Health Monitor runs continuously, while Orchestration Copilot is invoked on demand.</li> <li>Observability: OpenTelemetry traces span CTS and agent calls. Structured logs include <code>trace_id</code>, <code>transfer_id</code>, and <code>policy_id</code> for joinability.</li> <li>Configuration: Policies stored in the Directory/Config service are versioned; agents consume updates via feature flag streams.</li> </ul>"},{"location":"10-payments-nucleus/components/orchestration-ai-agents/#testing-simulation","title":"Testing &amp; Simulation","text":"<ul> <li>Offline evaluation: Replay historical transfers through the agents with <code>stalela simulate orchestration --from &lt;date&gt;</code> to measure precision/recall of routing decisions.</li> <li>A/B experiments: Toggle agent policies per tenant via feature flags; compare success metrics in Looker dashboards backed by <code>route.selected.via_ai</code> events.</li> <li>Contract tests: JSON schema fixtures for agent inputs/outputs live in <code>storo-specs/orchestration</code>. CTS CI enforces schema drift detection.</li> <li>Chaos drills: Use <code>stalela chaos rail --target=&lt;rail&gt;</code> to inject latency/failure and verify Rail Health Monitor suppresses degraded paths.</li> </ul>"},{"location":"10-payments-nucleus/components/orchestration-ai-agents/#fallback-observability-patterns","title":"Fallback &amp; Observability Patterns","text":"<ul> <li>Graceful degradation: If an agent call times out or errors, CTS reverts to deterministic Directory routing rules and records <code>orchestration.fallback.used</code> with reason codes.</li> <li>Audit trails: All agent outputs persist in the orchestration event stream, allowing red-team review and compliance audits.</li> <li>Operator workflows: Orchestration Copilot summarizes agent contributions in the Operator Console and CLI, aiding rapid incident response.</li> <li>Model lifecycle: Retraining jobs publish <code>model.version.changed</code> events; deployments require canary windows with heightened alerting on rail success rate.</li> </ul>"},{"location":"10-payments-nucleus/components/platform-base/","title":"Platform/Base Library","text":"<p>The Platform/Base Library provides shared utilities for all Stalela services, ensuring consistency in health checks, IDs, error handling, time logic, and migrations.</p>"},{"location":"10-payments-nucleus/components/platform-base/#purpose","title":"\ud83c\udfaf Purpose","text":"<ul> <li>Provide common admin endpoints for all services.  </li> <li>Standardize time, IDs, errors across the stack.  </li> <li>Support embedded migrations/configs.  </li> <li>Simplify observability and operational tooling.</li> </ul>"},{"location":"10-payments-nucleus/components/platform-base/#responsibilities","title":"\ud83d\udee0 Responsibilities","text":"<ul> <li>Expose <code>GET /live</code>, <code>GET /ready</code>, <code>GET /metrics</code>, <code>GET /version</code>.  </li> <li>Provide banking-aware time utilities (cutoffs, holidays).  </li> <li>Standardize error handling (ErrorList, ParseError).  </li> <li>Offer ID generation and request tracing.  </li> <li>Embed DB migrations in service binaries.  </li> </ul> <p>Ship canonical holiday calendars for ZA/ZW and banking-day helpers (<code>Africa/Johannesburg</code>, <code>Africa/Harare</code>).</p>"},{"location":"10-payments-nucleus/components/platform-base/#contracts","title":"\ud83d\udcd1 Contracts","text":""},{"location":"10-payments-nucleus/components/platform-base/#admin-endpoints-all-services-adopt-via-platformbase","title":"Admin Endpoints (all services adopt via Platform/Base)","text":"<ul> <li><code>GET /live</code> \u2192 200 when process is up (no dependencies checked)</li> <li><code>GET /ready</code> \u2192 200 when dependencies are healthy (DB/bus); 503 otherwise</li> <li><code>GET /metrics</code> \u2192 Prometheus text format (counters, histograms, gauges)</li> <li><code>GET /version</code> \u2192 JSON</li> </ul> <pre><code>{\n  \"service\": \"storo-cts\",\n  \"version\": \"v1.2.3\",\n  \"gitSha\": \"abcd1234\",\n  \"buildDate\": \"2025-08-27T10:00:00Z\"\n}\n</code></pre> <p>Recommendation: bind admin server to a separate port and restrict exposure to service mesh / localhost.</p>"},{"location":"10-payments-nucleus/components/platform-base/#time-calendars","title":"\ud83d\udd52 Time &amp; Calendars","text":"<ul> <li>Regions/timezones supported out-of-the-box:</li> <li>ZA \u2192 <code>Africa/Johannesburg</code></li> <li>ZW \u2192 <code>Africa/Harare</code></li> <li>Helpers:</li> <li><code>Now()</code> \u2192 time in configured business TZ</li> <li><code>IsBankingDay(date)</code></li> <li><code>NextBankingDay(from)</code> / <code>PrevBankingDay(from)</code></li> <li><code>CutoffAt(date, rail)</code> \u2192 next effective cutoff from Directory config</li> <li>Calendars: ships canonical ZA/ZW holiday sets; Directory publishes effective calendars consumed by services.</li> </ul>"},{"location":"10-payments-nucleus/components/platform-base/#errors-ids","title":"\ud83e\uddf0 Errors &amp; IDs","text":"<ul> <li>Error taxonomy aligns with <code>docs/20-specs/error-codes.md</code>.</li> <li>Error helpers: <code>ErrorList</code>, <code>ParseError</code>, consistent fields: <code>{ code, message, details?, traceId? }</code>.</li> <li>IDs:</li> <li><code>ID()</code> \u2192 sortable unique IDs (UUIDv7-style) for entities/events</li> <li>Correlation: propagate W3C <code>traceparent</code> and include <code>traceId</code> in logs/errors</li> </ul>"},{"location":"10-payments-nucleus/components/platform-base/#migrations-embedded","title":"\ud83d\uddc3\ufe0f Migrations (embedded)","text":"<p>Embed schema migrations into service binaries and run on startup (opt-in flag).</p> <pre><code>import (\n  \"embed\"\n  base \"github.com/storo/platform-base\"\n)\n\n//go:embed migrations/*.sql\nvar migrationsFS embed.FS\n\nfunc main() {\n  db := mustOpenDB()\n  if err := base.Migrate(db, migrationsFS); err != nil { panic(err) }\n  // start admin server, app, consumers...\n}\n</code></pre> <p>Migration file naming: <code>0001_init.sql</code>, <code>0002_add_outbox.sql</code> (idempotent, forward-only). Rollback is handled via new forward migrations.</p>"},{"location":"10-payments-nucleus/components/platform-base/#interfaces","title":"\ud83d\udd0c Interfaces","text":"<ul> <li>Imported as library into all services.  </li> <li>Provides helpers for admin, time, error, IDs, migrations.  </li> </ul>"},{"location":"10-payments-nucleus/components/platform-base/#example","title":"\ud83d\udcd0 Example","text":"<pre><code>// Health server\nadmin := base.NewAdminServer(\":8081\")\nadmin.AddLivenessCheck(\"db\", db.Ping)\nadmin.Start()\n\n// Time utils\nt := base.Now()\nif t.IsBankingDay() { ... }\n</code></pre>"},{"location":"10-payments-nucleus/components/platform-base/#modules","title":"\ud83d\uddc4 Modules","text":"<ul> <li>Admin \u2192 liveness, readiness, metrics, version.  </li> <li>Time \u2192 banking days, holidays, cutoffs.  </li> <li>Errors \u2192 ErrorList, ParseError.  </li> <li>IDs \u2192 ID(), correlation IDs.  </li> <li>Migrations \u2192 embedded FS for DB schema upgrades.  </li> </ul>"},{"location":"10-payments-nucleus/components/platform-base/#observability","title":"\ud83d\udcca Observability","text":"<ul> <li>Uniform <code>/metrics</code> for Prometheus.  </li> <li>Structured error/logging helpers.  </li> <li>Request tracing correlation.  </li> </ul>"},{"location":"10-payments-nucleus/components/platform-base/#security","title":"\ud83d\udd10 Security","text":"<ul> <li>Admin endpoints on localhost or service mesh only.  </li> <li>No sensitive data in metrics/logs.  </li> </ul>"},{"location":"10-payments-nucleus/components/platform-base/#runbooks","title":"\ud83e\udded Runbooks","text":"<ul> <li>/live fails \u2192 service not running; check logs.  </li> <li>Migration failed \u2192 rollback DB version, re-run migration.  </li> <li>Clock drift \u2192 verify NTP sync; banking-day logic depends on accurate time.</li> </ul>"},{"location":"10-payments-nucleus/components/rail-gateway-airtel-momo/","title":"Rail Gateway \u2014 Airtel Money (Mobile Money)","text":"<p>Purpose Adapt canonical transfers to Airtel Money; strict schema validation; webhook handling; events.</p>"},{"location":"10-payments-nucleus/components/rail-gateway-airtel-momo/#responsibilities","title":"Responsibilities","text":"<ul> <li>Consume <code>transfers.submitted.airtelmomo</code>.</li> <li>Initiate payment and handle callbacks.</li> </ul>"},{"location":"10-payments-nucleus/components/rail-gateway-airtel-momo/#interfaces","title":"Interfaces","text":"<ul> <li>HTTP: <code>POST /webhooks/airtelmomo</code></li> <li>Events (envelope <code>v=1</code>): as per canonical <code>transfers.*</code></li> </ul>"},{"location":"10-payments-nucleus/components/rail-gateway-airtel-momo/#data-rules","title":"Data &amp; Rules","text":"<ul> <li><code>airtelmomo_ops</code>; MSISDN/currency validation; idempotency keying.</li> </ul>"},{"location":"10-payments-nucleus/components/rail-gateway-airtel-momo/#failure-modes","title":"Failure Modes","text":"<ul> <li>Callback gaps \u2192 poll; DLQ on parse/verify failure.</li> </ul>"},{"location":"10-payments-nucleus/components/rail-gateway-airtel-momo/#observability-security","title":"Observability &amp; Security","text":"<ul> <li>Prompt success rate; signature verify; PII redaction.</li> </ul> <p>See also: Rail Gateway \u2014 Template and Reason Code mappings in ../specs/error-codes.md</p>"},{"location":"10-payments-nucleus/components/rail-gateway-ecocash/","title":"Rail Gateway \u2014 EcoCash (Mobile Money, ZW)","text":"<p>Purpose Adapt canonical transfers to EcoCash mobile money flows (STK/USSD prompts), handle callbacks/statement ingest, and emit domain events.</p>"},{"location":"10-payments-nucleus/components/rail-gateway-ecocash/#responsibilities","title":"Responsibilities","text":"<ul> <li>Subscribe to <code>transfers.submitted.ecocash</code> (PUSH primary).</li> <li>Trigger STK/USSD prompt, poll status, handle async callbacks.</li> <li>Map reason/return codes; emit <code>accepted/settled/returned/failed</code>.</li> <li>Persist artifacts (redacted) for audit/recon.</li> </ul>"},{"location":"10-payments-nucleus/components/rail-gateway-ecocash/#interfaces","title":"Interfaces","text":""},{"location":"10-payments-nucleus/components/rail-gateway-ecocash/#inputs","title":"Inputs","text":"<ul> <li>Events: <code>transfers.submitted.ecocash</code></li> <li>HTTP: <code>POST /webhooks/ecocash</code> (signature verify)</li> </ul>"},{"location":"10-payments-nucleus/components/rail-gateway-ecocash/#outputs","title":"Outputs","text":"<ul> <li>Events (envelope <code>v=1</code>): <code>transfers.accepted</code>, <code>transfers.settled</code>, <code>transfers.returned</code>, <code>transfers.failed</code></li> </ul>"},{"location":"10-payments-nucleus/components/rail-gateway-ecocash/#data-model","title":"Data Model","text":"<ul> <li><code>ecocash_ops</code> (transferId, msisdn, amountMinor, currency, opRef, status, reasonCode?)</li> <li><code>outbox_gateway</code>, blobs for requests/responses</li> </ul>"},{"location":"10-payments-nucleus/components/rail-gateway-ecocash/#algorithms-rules","title":"Algorithms / Rules","text":"<ul> <li>STK prompt initiation; timeout &amp; retry windows.</li> <li>Idempotency: <code>{tenantId}:{transferId}</code> as partner reference.</li> <li>Strict MSISDN validation and currency allowlist.</li> </ul>"},{"location":"10-payments-nucleus/components/rail-gateway-ecocash/#diagrams","title":"Diagrams","text":"<pre><code>sequenceDiagram\n  participant CTS\n  participant GW as EcoCash GW\n  participant MNO as EcoCash\n  CTS-&gt;&gt;GW: transfers.submitted.ecocash\n  GW-&gt;&gt;MNO: STK prompt\n  MNO--&gt;&gt;GW: accepted {opRef}\n  GW--&gt;&gt;CTS: transfers.accepted\n  MNO--&gt;&gt;GW: settled/return {reason}\n  GW--&gt;&gt;CTS: transfers.settled / transfers.returned</code></pre>"},{"location":"10-payments-nucleus/components/rail-gateway-ecocash/#failure-modes-retries","title":"Failure Modes &amp; Retries","text":"<ul> <li>Prompt not delivered \u2192 retry/backoff, operator alert after N.</li> <li>Decline/timeout \u2192 <code>failed</code>/<code>returned</code> with mapped reason.</li> </ul>"},{"location":"10-payments-nucleus/components/rail-gateway-ecocash/#observability","title":"Observability","text":"<ul> <li>Metrics: prompt latency/success, returns rate.</li> </ul>"},{"location":"10-payments-nucleus/components/rail-gateway-ecocash/#security","title":"Security","text":"<ul> <li>Webhook signature verification; PII redaction.</li> </ul>"},{"location":"10-payments-nucleus/components/rail-gateway-ecocash/#runbooks","title":"Runbooks","text":"<ul> <li>Replay webhook; quarantine poison messages; contact MNO if outage persists.</li> </ul> <p>See also: Rail Gateway \u2014 Template and Reason Code mappings in ../specs/error-codes.md</p>"},{"location":"10-payments-nucleus/components/rail-gateway-eft/","title":"Rail Gateway \u2014 EFT (BankservAfrica Batch)","text":"<p>Purpose Manage batch submissions and returns for EFT, aligning with Bankserv file formats and cutoffs.</p>"},{"location":"10-payments-nucleus/components/rail-gateway-eft/#responsibilities","title":"Responsibilities","text":"<ul> <li>Produce batch files; submit to partner; ingest settlement/return files.</li> <li>Emit <code>accepted/settled/returned/failed</code> events accordingly.</li> </ul>"},{"location":"10-payments-nucleus/components/rail-gateway-eft/#interfaces","title":"Interfaces","text":"<ul> <li>Files: batch submission, settlement, returns.</li> <li>Events (envelope <code>v=1</code>): <code>transfers.*</code></li> </ul>"},{"location":"10-payments-nucleus/components/rail-gateway-eft/#data-model","title":"Data Model","text":"<ul> <li><code>eft_batches</code>, <code>eft_lines</code>, artifacts for file copies.</li> </ul>"},{"location":"10-payments-nucleus/components/rail-gateway-eft/#rules","title":"Rules","text":"<ul> <li>Cutoffs, windows, file validation (record counts, checksums).</li> </ul>"},{"location":"10-payments-nucleus/components/rail-gateway-eft/#debicheck-mandates-za","title":"DebiCheck Mandates (ZA)","text":"<ul> <li>Mandate lifecycle: create \u2192 amend \u2192 cancel; store mandate reference and consent metadata.</li> <li>Pull payments: verify active mandate before submission; include mandateRef in payload.</li> <li>Returns: map mandate-related reason codes to <code>transfers.returned</code> with details.</li> </ul>"},{"location":"10-payments-nucleus/components/rail-gateway-eft/#failure-modes","title":"Failure Modes","text":"<ul> <li>File reject; late returns; mismatched totals \u2192 recon exception.</li> </ul>"},{"location":"10-payments-nucleus/components/rail-gateway-eft/#observability-security","title":"Observability &amp; Security","text":"<ul> <li>Metrics: batch success rate; PII minimal in files; encryption at rest.</li> </ul>"},{"location":"10-payments-nucleus/components/rail-gateway-mtn-momo/","title":"Rail Gateway \u2014 MTN MoMo (Mobile Money)","text":"<p>Purpose Translate canonical transfers to MTN MoMo APIs (P2P/P2M), enforce validation, process webhooks, and emit events.</p>"},{"location":"10-payments-nucleus/components/rail-gateway-mtn-momo/#responsibilities","title":"Responsibilities","text":"<ul> <li>Consume <code>transfers.submitted.mtnmomo</code>.</li> <li>Initiate payment request (PUSH), handle consent/approval callbacks.</li> <li>Emit lifecycle events; persist artifacts.</li> </ul>"},{"location":"10-payments-nucleus/components/rail-gateway-mtn-momo/#interfaces","title":"Interfaces","text":""},{"location":"10-payments-nucleus/components/rail-gateway-mtn-momo/#inputs","title":"Inputs","text":"<ul> <li>Events: <code>transfers.submitted.mtnmomo</code></li> <li>HTTP: <code>POST /webhooks/mtnmomo</code></li> </ul>"},{"location":"10-payments-nucleus/components/rail-gateway-mtn-momo/#outputs","title":"Outputs","text":"<ul> <li>Events (envelope <code>v=1</code>): <code>transfers.accepted</code>, <code>transfers.settled</code>, <code>transfers.returned</code>, <code>transfers.failed</code></li> </ul>"},{"location":"10-payments-nucleus/components/rail-gateway-mtn-momo/#data-model","title":"Data Model","text":"<ul> <li><code>mtnmomo_ops</code> (...)</li> </ul>"},{"location":"10-payments-nucleus/components/rail-gateway-mtn-momo/#rules","title":"Rules","text":"<ul> <li>MSISDN format validation; currency allowlist.</li> <li>Idempotency via partner reference.</li> </ul>"},{"location":"10-payments-nucleus/components/rail-gateway-mtn-momo/#failure-modes-retries","title":"Failure Modes &amp; Retries","text":"<ul> <li>202/accepted without finalization \u2192 poll until terminal.</li> </ul>"},{"location":"10-payments-nucleus/components/rail-gateway-mtn-momo/#observability-security","title":"Observability &amp; Security","text":"<ul> <li>Metrics, DLQ; webhook signature verify, redaction.</li> </ul> <p>See also: Rail Gateway \u2014 Template and Reason Code mappings in ../specs/error-codes.md</p>"},{"location":"10-payments-nucleus/components/rail-gateway-oppwa/","title":"Rail Gateway \u2014 OPPWA (Card / Tokenized Payments)","text":"<p>The OPPWA Gateway adapts Stalela canonical transfers to OPPWA (Open Payment Platform) APIs used by acquirers/processors (e.g., for Zimswitch card-present/tokenized flows). It validates payloads, transforms to OPPWA request formats, handles webhooks, and emits domain events.</p>"},{"location":"10-payments-nucleus/components/rail-gateway-oppwa/#purpose","title":"\ud83c\udfaf Purpose","text":"<ul> <li>Translate canonical transfers into OPPWA REST calls (payments, preauth/capture, refunds).</li> <li>Enforce strict validation of amounts, currencies, tokens/PAN surrogates, and 3DS/SDK data.</li> <li>Handle sync responses and async webhooks to finalize state.</li> <li>Emit accepted/settled/returned/failed events with mapped reason codes.</li> <li>Persist raw requests/responses (redacted) for audit and reconciliation.</li> </ul>"},{"location":"10-payments-nucleus/components/rail-gateway-oppwa/#responsibilities","title":"\ud83d\udee0 Responsibilities","text":"<ul> <li>Subscribe to <code>transfers.submitted.oppwa</code>.</li> <li>Map intents:</li> <li><code>AUTH</code> \u2192 OPPWA <code>preauthorization</code></li> <li><code>CAPTURE</code> \u2192 OPPWA <code>capture</code></li> <li><code>PUSH/PULL</code> (rare for cards) \u2192 treated as <code>debit</code>/<code>credit</code> where supported</li> <li>Build requests using merchant credentials / entity routing.</li> <li>Receive webhooks (<code>/webhooks/oppwa</code>) and correlate to transfers.</li> <li>Emit events and store artifacts; support retries and idempotency keys.</li> </ul>"},{"location":"10-payments-nucleus/components/rail-gateway-oppwa/#interfaces","title":"\ud83d\udd0c Interfaces","text":""},{"location":"10-payments-nucleus/components/rail-gateway-oppwa/#events-consume","title":"Events (consume)","text":"<ul> <li><code>transfers.submitted.oppwa</code></li> <li><code>{ transferId, tenantId, amount, currency, payer, payee, intent, metadata{ token, threeDS, merchantRef } }</code></li> </ul>"},{"location":"10-payments-nucleus/components/rail-gateway-oppwa/#events-emit-envelope-v1","title":"Events (emit; envelope <code>v=1</code>)","text":"<ul> <li><code>transfers.accepted</code> \u2192 <code>{ transferId, rail:\"oppwa\", opRef, resultCode }</code></li> <li><code>transfers.settled</code> \u2192 <code>{ transferId, rail:\"oppwa\", opRef, captured:true, settlementDate? }</code></li> <li><code>transfers.returned</code> \u2192 <code>{ transferId, rail:\"oppwa\", opRef, reasonCode }</code></li> <li><code>transfers.failed</code> \u2192 <code>{ transferId, rail:\"oppwa\", reason, details }</code></li> </ul>"},{"location":"10-payments-nucleus/components/rail-gateway-oppwa/#http","title":"HTTP","text":"<ul> <li><code>POST /webhooks/oppwa</code> (verify signature, parse, correlate)</li> <li>Admin: <code>GET /live</code>, <code>GET /ready</code>, <code>GET /metrics</code>, <code>GET /version</code></li> </ul>"},{"location":"10-payments-nucleus/components/rail-gateway-oppwa/#data-model","title":"\ud83d\uddc4 Data Model","text":"<ul> <li>table: <code>oppwa_ops</code></li> <li><code>id</code> (pk), <code>transferId</code>, <code>tenantId</code></li> <li><code>merchantId</code>, <code>entityId</code> (per-tenant/route), <code>opRef</code></li> <li><code>intent</code> (AUTH|CAPTURE|REFUND), <code>amountMinor</code>, <code>currency</code></li> <li><code>status</code> (INIT|ACCEPTED|CAPTURED|RETURNED|FAILED)</li> <li><code>resultCode</code>, <code>reasonCode</code>, <code>riskScore</code> (nullable)</li> <li><code>createdAt</code>, <code>updatedAt</code></li> <li>table: <code>outbox_gateway</code> \u2013 for events</li> <li>blob: redacted request/response JSON snapshots (encrypted), webhook payloads</li> </ul>"},{"location":"10-payments-nucleus/components/rail-gateway-oppwa/#transform-validation","title":"\ud83d\udd01 Transform &amp; Validation","text":"<ul> <li>Currency/amount \u2192 use minor units; reject &gt; 2 dp amounts for fiat.</li> <li>Tokenization \u2192 require network token / OPPWA token; never store PAN.</li> <li>3DS \u2192 include 3DS server results when present; pass-through fields via metadata.</li> <li>Idempotency \u2192 set OPPWA idempotency keys using <code>{tenantId}:{transferId}</code>.</li> <li>Reason mapping \u2192 maintain mapping table from OPPWA result/return codes \u2192 Stalela <code>reason</code> enums.</li> <li>Auth/Capture split \u2192 only capture after explicit command or webhook indicating capture.</li> </ul>"},{"location":"10-payments-nucleus/components/rail-gateway-oppwa/#sequence-auth-capture","title":"\ud83d\udcd0 Sequence (Auth \u2192 Capture)","text":"<pre><code>sequenceDiagram\n  participant CTS as Canonical Transfer Service\n  participant GW as OPPWA Gateway\n  participant OPP as OPPWA API\n  participant WH as Webhook Receiver\n\n  CTS-&gt;&gt;GW: transfers.submitted.oppwa (intent=AUTH)\n  GW-&gt;&gt;OPP: POST /payments (preauthorization)\n  OPP--&gt;&gt;GW: 200 result { opRef, resultCode }\n  GW--&gt;&gt;CTS: transfers.accepted { opRef }\n  WH--&gt;&gt;GW: webhook { opRef, captured }\n  GW--&gt;&gt;CTS: transfers.settled { opRef }</code></pre>"},{"location":"10-payments-nucleus/components/rail-gateway-oppwa/#failure-modes","title":"\ud83d\udea8 Failure Modes","text":"<ul> <li>DoS/429 from OPPWA \u2192 backoff + retry; escalate if sustained</li> <li>Invalid token / expired \u2192 <code>transfers.failed{reason:\"TOKEN_INVALID\"}</code></li> <li>Chargeback/return \u2192 emit <code>transfers.returned</code> with reason mapping</li> <li>Signature mismatch on webhook \u2192 reject + alert</li> <li>Currency not supported for merchant entity \u2192 fail fast</li> </ul>"},{"location":"10-payments-nucleus/components/rail-gateway-oppwa/#observability","title":"\ud83d\udcca Observability","text":"<ul> <li>Metrics: request latency, success rate by intent, webhook processing lag</li> <li>Error buckets by <code>resultCode</code> / <code>reasonCode</code></li> <li>DLQ depth for failed webhooks / submissions</li> </ul>"},{"location":"10-payments-nucleus/components/rail-gateway-oppwa/#security","title":"\ud83d\udd10 Security","text":"<ul> <li>Verify webhook signatures; rotate secrets</li> <li>Redact PAN-like fields aggressively; tokenize everything</li> <li>Encrypt blobs at rest; least-privileged access to merchant credentials</li> <li>PCI scope: keep CTS and Ledger out of PAN scope; gateway isolates card data</li> </ul>"},{"location":"10-payments-nucleus/components/rail-gateway-oppwa/#config","title":"\u2699\ufe0f Config","text":"<ul> <li><code>OPPWA_BASE_URL</code>, per-tenant <code>ENTITY_ID</code>, <code>MERCHANT_ID</code>, <code>API_KEY</code></li> <li><code>WEBHOOK_SECRET</code>, <code>IDEMPOTENCY_PREFIX</code></li> <li><code>TIMEOUT_MS</code>, <code>RETRY_MAX</code>, <code>BACKOFF</code></li> <li><code>REASON_CODE_MAP</code> (versioned), <code>CURRENCY_ALLOWLIST</code></li> </ul>"},{"location":"10-payments-nucleus/components/rail-gateway-oppwa/#runbooks","title":"\ud83e\udded Runbooks","text":"<ul> <li>High 401/403 rates: check API key rotation, entity mapping</li> <li>Webhook gaps: verify public endpoint, firewall, signature; replay from OPPWA portal if available</li> <li>Frequent declines: inspect 3DS setup and tokenization source; check risk engine outcomes</li> </ul> <p>See also: Rail Gateway \u2014 Template and Reason Code mappings in ../specs/error-codes.md</p>"},{"location":"10-payments-nucleus/components/rail-gateway-payshap/","title":"Rail Gateway \u2014 PayShap (ZA Instant Proxy Payments)","text":"<p>Purpose Integrate proxy-based instant payments (PayShap), handling proxy resolution, submission, and returns.</p>"},{"location":"10-payments-nucleus/components/rail-gateway-payshap/#responsibilities","title":"Responsibilities","text":"<ul> <li>Consume <code>transfers.submitted.payshap</code>.</li> <li>Resolve proxy (cell/email/ID) \u2192 account; submit payment; handle timeouts/returns.</li> </ul>"},{"location":"10-payments-nucleus/components/rail-gateway-payshap/#interfaces","title":"Interfaces","text":""},{"location":"10-payments-nucleus/components/rail-gateway-payshap/#inputs","title":"Inputs","text":"<ul> <li>Events: <code>transfers.submitted.payshap</code></li> <li>HTTP: <code>POST /webhooks/payshap</code></li> </ul>"},{"location":"10-payments-nucleus/components/rail-gateway-payshap/#outputs","title":"Outputs","text":"<ul> <li>Events (envelope <code>v=1</code>): <code>transfers.accepted</code>, <code>transfers.settled</code>, <code>transfers.returned</code>, <code>transfers.failed</code></li> </ul>"},{"location":"10-payments-nucleus/components/rail-gateway-payshap/#data-model","title":"Data Model","text":"<ul> <li><code>payshap_ops</code> (proxyType, proxyValue, resolvedAccount, opRef, status, reasonCode)</li> </ul>"},{"location":"10-payments-nucleus/components/rail-gateway-payshap/#rules","title":"Rules","text":"<ul> <li>Proxy validation and supported types; cutoff/timeouts per scheme.</li> <li>Reason code mapping.</li> </ul>"},{"location":"10-payments-nucleus/components/rail-gateway-payshap/#failure-modes","title":"Failure Modes","text":"<ul> <li>Resolution failure; submission timeout; duplicate notifications.</li> </ul>"},{"location":"10-payments-nucleus/components/rail-gateway-payshap/#observability-security","title":"Observability &amp; Security","text":"<ul> <li>Metrics: resolution latency, success; webhook signature; PII redaction.</li> </ul> <p>See also: Rail Gateway \u2014 Template and Reason Code mappings in ../specs/error-codes.md</p>"},{"location":"10-payments-nucleus/components/rail-gateway-rtgs/","title":"Rail Gateway \u2014 RTGS (High-Value)","text":"<p>Purpose Handle high-value, real-time gross settlement submissions and acknowledgments.</p>"},{"location":"10-payments-nucleus/components/rail-gateway-rtgs/#responsibilities","title":"Responsibilities","text":"<ul> <li>Consume <code>transfers.submitted.rtgs</code>.</li> <li>Submit payment via partner/bank API; handle acknowledgments and settlement confirmations.</li> </ul>"},{"location":"10-payments-nucleus/components/rail-gateway-rtgs/#interfaces","title":"Interfaces","text":"<ul> <li>Events (envelope <code>v=1</code>): <code>transfers.*</code></li> <li>Files/API: as per partner specifications.</li> </ul>"},{"location":"10-payments-nucleus/components/rail-gateway-rtgs/#data-model","title":"Data Model","text":"<ul> <li><code>rtgs_ops</code> (transferId, amount, currency, opRef, status)</li> </ul>"},{"location":"10-payments-nucleus/components/rail-gateway-rtgs/#rules","title":"Rules","text":"<ul> <li>High-value thresholds; cutoff windows; stronger idempotency.</li> </ul>"},{"location":"10-payments-nucleus/components/rail-gateway-rtgs/#failure-modes","title":"Failure Modes","text":"<ul> <li>Queueing at partner; manual operator intervention paths.</li> </ul>"},{"location":"10-payments-nucleus/components/rail-gateway-rtgs/#observability-security","title":"Observability &amp; Security","text":"<ul> <li>Metrics: ack/settle latency; strong auth; PII minimization.</li> </ul> <p>See also: Rail Gateway \u2014 Template and Reason Code mappings in ../specs/error-codes.md</p>"},{"location":"10-payments-nucleus/components/rail-gateway-template/","title":"Rail Gateway \u2014 Template","text":"<p>Use this template when creating a new rail gateway component doc.</p>"},{"location":"10-payments-nucleus/components/rail-gateway-template/#purpose","title":"Purpose","text":"<p>Adapt canonical transfers to the rail; strict schema validation; webhooks/file ingest; emit events.</p>"},{"location":"10-payments-nucleus/components/rail-gateway-template/#responsibilities","title":"Responsibilities","text":"<ul> <li>Consume <code>transfers.submitted.&lt;rail&gt;</code>.</li> <li>Initiate/submit payment and handle callbacks/files.</li> <li>Map reason/return codes; emit <code>accepted/settled/returned/failed</code>.</li> <li>Persist artifacts (redacted) for audit/recon; use outbox for events.</li> </ul>"},{"location":"10-payments-nucleus/components/rail-gateway-template/#interfaces","title":"Interfaces","text":""},{"location":"10-payments-nucleus/components/rail-gateway-template/#inputs","title":"Inputs","text":"<ul> <li>Events: <code>transfers.submitted.&lt;rail&gt;</code></li> <li>HTTP/Webhooks or Files as per rail</li> </ul>"},{"location":"10-payments-nucleus/components/rail-gateway-template/#outputs","title":"Outputs","text":"<ul> <li>Events (envelope <code>v=1</code>): <code>transfers.accepted</code>, <code>transfers.settled</code>, <code>transfers.returned</code>, <code>transfers.failed</code></li> </ul>"},{"location":"10-payments-nucleus/components/rail-gateway-template/#data-model","title":"Data Model","text":"<ul> <li><code>&lt;rail&gt;_ops</code> (transferId, tenantId, opRef, amountMinor, currency, status, reasonCode?)</li> <li><code>outbox_gateway</code>, encrypted blobs for requests/responses</li> </ul>"},{"location":"10-payments-nucleus/components/rail-gateway-template/#transform-validation","title":"Transform &amp; Validation","text":"<ul> <li>Strict validation of identifiers, amounts, currencies.</li> <li>Idempotency: <code>{tenantId}:{transferId}</code> partner reference.</li> <li>Reason mapping \u2192 Stalela enums (see <code>docs/20-specs/error-codes.md</code>).</li> </ul>"},{"location":"10-payments-nucleus/components/rail-gateway-template/#diagrams-example","title":"Diagrams (example)","text":"<pre><code>sequenceDiagram\n  participant CTS\n  participant GW as &lt;Rail&gt; GW\n  participant RAIL as &lt;Rail&gt;\n  CTS-&gt;&gt;GW: transfers.submitted.&lt;rail&gt;\n  GW-&gt;&gt;RAIL: submit\n  RAIL--&gt;&gt;GW: accepted {opRef}\n  GW--&gt;&gt;CTS: transfers.accepted\n  RAIL--&gt;&gt;GW: settled/return {reason}\n  GW--&gt;&gt;CTS: transfers.settled / transfers.returned</code></pre>"},{"location":"10-payments-nucleus/components/rail-gateway-template/#failure-modes-retries","title":"Failure Modes &amp; Retries","text":"<ul> <li>Submission failure \u2192 backoff/retry; DLQ for poison payloads.</li> <li>Timeout \u2192 emit <code>failed</code> or <code>returned</code> per scheme rules.</li> </ul>"},{"location":"10-payments-nucleus/components/rail-gateway-template/#observability-security","title":"Observability &amp; Security","text":"<ul> <li>Metrics: submit/settle latency, returns rate; DLQ depth.</li> <li>Webhook signature verification / PII redaction.</li> </ul>"},{"location":"10-payments-nucleus/components/rail-gateway-usdc-algo/","title":"Rail Gateway \u2014 USDC on Algorand","text":"<p>The USDC/Algorand Gateway adapts Stalela\u2019s canonical transfers to on-chain USDC movements on the Algorand network. It validates requests, constructs transactions, submits to the network (via Algod/Indexer/provider), listens for confirmations, and emits domain events.</p>"},{"location":"10-payments-nucleus/components/rail-gateway-usdc-algo/#purpose","title":"\ud83c\udfaf Purpose","text":"<ul> <li>Translate canonical transfers into Algorand transactions (ASA transfers).</li> <li>Provide strict validation (asset, amounts, addresses, fees).</li> <li>Handle submission and confirmation with retries and reorg safety.</li> <li>Emit transfers.accepted / transfers.settled / transfers.failed as reality unfolds.</li> <li>Persist raw tx metadata for audit and reconciliation.</li> </ul>"},{"location":"10-payments-nucleus/components/rail-gateway-usdc-algo/#responsibilities","title":"\ud83d\udee0 Responsibilities","text":"<ul> <li>Subscribe to <code>transfers.submitted.usdc</code> events.</li> <li>Validate: payer/payee accounts, ASA ID (USDC), decimals, amount, memo fields, network params.</li> <li>Construct and sign transactions (online hot wallet or external signer/HSM).</li> <li>Submit to network; poll or subscribe for confirmations (N blocks).</li> <li>Emit outcome events and persist artifacts (txid, round, fees).</li> <li>Surface health (<code>/live</code>, <code>/ready</code>), metrics, version via Platform/Base.</li> </ul>"},{"location":"10-payments-nucleus/components/rail-gateway-usdc-algo/#interfaces","title":"\ud83d\udd0c Interfaces","text":""},{"location":"10-payments-nucleus/components/rail-gateway-usdc-algo/#events-consume","title":"Events (consume)","text":"<ul> <li><code>transfers.submitted.usdc</code></li> <li>payload: <code>{ transferId, tenantId, amount{value,currency}, payer, payee, intent: \"PUSH\"|\"PULL\"|\"CAPTURE\"|\"AUTH\", metadata{} }</code></li> </ul>"},{"location":"10-payments-nucleus/components/rail-gateway-usdc-algo/#events-emit-envelope-v1","title":"Events (emit; envelope <code>v=1</code>)","text":"<ul> <li><code>transfers.accepted</code> \u2192 <code>{ transferId, rail:\"usdc-algo\", txId, suggestedRound }</code></li> <li><code>transfers.settled</code> \u2192 <code>{ transferId, rail:\"usdc-algo\", txId, confirmedRound, feeMicroAlgos }</code></li> <li><code>transfers.failed</code> \u2192 <code>{ transferId, rail:\"usdc-algo\", reason, details }</code></li> </ul>"},{"location":"10-payments-nucleus/components/rail-gateway-usdc-algo/#http-admin","title":"HTTP (admin)","text":"<ul> <li><code>GET /live</code>, <code>GET /ready</code>, <code>GET /metrics</code>, <code>GET /version</code></li> </ul>"},{"location":"10-payments-nucleus/components/rail-gateway-usdc-algo/#data-model","title":"\ud83d\uddc4 Data Model","text":"<ul> <li>table: <code>usdc_algo_tx</code></li> <li><code>id</code> (pk), <code>transferId</code>, <code>tenantId</code></li> <li><code>txId</code>, <code>firstValid</code>, <code>lastValid</code>, <code>confirmedRound</code></li> <li><code>payerAddr</code>, <code>payeeAddr</code>, <code>amountBaseUnits</code> (int)</li> <li><code>feeMicroAlgos</code>, <code>note</code> (base64), <code>network</code> (mainnet/testnet)</li> <li><code>status</code> (PENDING|CONFIRMED|FAILED), <code>error</code> (nullable)</li> <li><code>createdAt</code>, <code>updatedAt</code></li> <li>table: <code>outbox_gateway</code> \u2013 standard outbox for event publishing</li> </ul> <p>Raw payloads (signed txn, provider receipts) should be stored encrypted in blob storage with references here.</p>"},{"location":"10-payments-nucleus/components/rail-gateway-usdc-algo/#transform-validation","title":"\ud83d\udd01 Transform &amp; Validation","text":"<ul> <li>Currency must be <code>USD</code> with USDC ASA mapped to <code>assetId</code> (config).</li> <li>Decimals: Convert from canonical decimal to base units (10^decimals).</li> <li>Addresses: Bech32/base32 Algorand addresses; ensure payer has opted-in to ASA.</li> <li>Fees: Enforce min fee; allow overpay for fast confirm (config).</li> <li>Auth/Capture: On-chain AUTH is simulated via escrow account or timelocked pattern (optional, roadmap). Default intent is PUSH.</li> <li>Memo/Note: Encode limited metadata in <code>note</code> (&lt;= 1 KB best practice). Do not put PII in chain notes.</li> </ul>"},{"location":"10-payments-nucleus/components/rail-gateway-usdc-algo/#sequence-happy-path","title":"\ud83d\udcd0 Sequence (Happy Path)","text":"<pre><code>sequenceDiagram\n  participant CTS as Canonical Transfer Service\n  participant GW as USDC/Algorand Gateway\n  participant ALG as Algorand Network\n\n  CTS-&gt;&gt;GW: transfers.submitted.usdc\n  GW-&gt;&gt;GW: validate + build txn\n  GW-&gt;&gt;ALG: submit signed txn\n  ALG--&gt;&gt;GW: tx accepted (txId)\n  GW--&gt;&gt;CTS: transfers.accepted {txId}\n  ALG--&gt;&gt;GW: confirmed at round N\n  GW--&gt;&gt;CTS: transfers.settled {txId, round}</code></pre>"},{"location":"10-payments-nucleus/components/rail-gateway-usdc-algo/#failure-modes","title":"\ud83d\udea8 Failure Modes","text":"<ul> <li>Invalid account / not opted-in \u2192 <code>transfers.failed{reason:\"NOT_OPTED_IN\"}</code></li> <li>Insufficient balance / fee \u2192 <code>...{\"INSUFFICIENT_FUNDS\"}</code></li> <li>RPC/provider timeout \u2192 retry with backoff; surface <code>accepted</code> only after tx is seen</li> <li>Chain reorg / orphan (rare on Algorand) \u2192 re-check finality window, re-emit <code>failed</code> if dropped</li> <li>Signer/HSM unavailable \u2192 circuit break, keep events in DLQ</li> </ul>"},{"location":"10-payments-nucleus/components/rail-gateway-usdc-algo/#observability","title":"\ud83d\udcca Observability","text":"<ul> <li>Metrics: submit latency, confirmation latency, success rate, DLQ size, provider error codes</li> <li>Logs: txId, transferId, address short-hash, round; no PII</li> <li>Traces: propagate <code>x-request-id</code> / <code>trace-id</code> from CTS</li> </ul>"},{"location":"10-payments-nucleus/components/rail-gateway-usdc-algo/#security","title":"\ud83d\udd10 Security","text":"<ul> <li>Keys in HSM or isolated signer; never log material</li> <li>Principle of least privilege on provider API keys</li> <li>Encrypt raw signed txn artifacts at rest</li> <li>Feature flag to disable on-chain <code>note</code></li> </ul>"},{"location":"10-payments-nucleus/components/rail-gateway-usdc-algo/#config","title":"\u2699\ufe0f Config","text":"<ul> <li><code>ALGOD_URL</code>, <code>ALGOD_TOKEN</code>, <code>INDEXER_URL</code></li> <li><code>USDC_ASSET_ID</code>, <code>DECIMALS</code></li> <li><code>CONFIRMATIONS</code> (blocks), <code>SUBMIT_RETRY_MAX</code></li> <li><code>SIGNER_ENDPOINT</code> (optional), <code>NETWORK</code></li> </ul>"},{"location":"10-payments-nucleus/components/rail-gateway-usdc-algo/#runbooks","title":"\ud83e\udded Runbooks","text":"<ul> <li>Stuck in PENDING: check provider status; if mempool full, rebroadcast; verify fee</li> <li>Frequent INSUFFICIENT_FUNDS: inspect payer funding policy; enable preflight balance check</li> <li>High confirmation latency: increase fee or confirmation window temporarily</li> <li>Signer down: fail closed; drain DLQ after recovery</li> </ul> <p>See also: Rail Gateway \u2014 Template and Reason Code mappings in ../specs/error-codes.md</p>"},{"location":"10-payments-nucleus/components/rail-gateway-zimswitch/","title":"Rail Gateway \u2014 Zimswitch (Card / ISO 8583 via OPPWA)","text":"<p>The Zimswitch Gateway adapts Stalela canonical transfers to Zimswitch-connected acquiring via OPPWA/ISO 8583 semantics. It validates messages, transforms to processor requests, handles callbacks/settlement files, and emits domain events.</p> <p>Note: Some Zimswitch integrations front with OPPWA JSON APIs while the underlying network uses ISO 8583. We model both: primary REST submission with strict ISO field discipline in validation and mapping.</p>"},{"location":"10-payments-nucleus/components/rail-gateway-zimswitch/#purpose","title":"\ud83c\udfaf Purpose","text":"<ul> <li>Translate canonical transfers to Zimswitch/OPPWA requests with ISO-grade validation.</li> <li>Support card-present (tap-on-phone, online) and card-not-present (tokenized) flows where permitted.</li> <li>Handle accept/settle/return lifecycle + reconciliation with daily settlement files.</li> <li>Emit domain events with mapped reason codes and retain artifacts for audit.</li> </ul>"},{"location":"10-payments-nucleus/components/rail-gateway-zimswitch/#responsibilities","title":"\ud83d\udee0 Responsibilities","text":"<ul> <li>Subscribe to <code>transfers.submitted.zimswitch</code>.</li> <li>Validate BIN/member routing via Directory &amp; Routing.</li> <li>Construct request: amount, currency (ZWL/ZAR/USD), merchant data, token/PAN surrogate, terminal capabilities.</li> <li>Submit to processor; handle synchronous result and async callbacks.</li> <li>Ingest settlement files (daily) for reconciliation and late returns.</li> <li>Emit <code>accepted/settled/returned/failed</code> and store payloads (redacted).</li> </ul>"},{"location":"10-payments-nucleus/components/rail-gateway-zimswitch/#interfaces","title":"\ud83d\udd0c Interfaces","text":""},{"location":"10-payments-nucleus/components/rail-gateway-zimswitch/#events-consume","title":"Events (consume)","text":"<ul> <li><code>transfers.submitted.zimswitch</code></li> <li><code>{ transferId, tenantId, amount, currency, payer, payee, intent, metadata{ token|panRef, emv, terminal, merchantRef } }</code></li> </ul>"},{"location":"10-payments-nucleus/components/rail-gateway-zimswitch/#events-emit-envelope-v1","title":"Events (emit; envelope <code>v=1</code>)","text":"<ul> <li><code>transfers.accepted</code> \u2192 <code>{ transferId, rail:\"zimswitch\", acqRef, authCode }</code></li> <li><code>transfers.settled</code> \u2192 <code>{ transferId, rail:\"zimswitch\", settlementDate, batchId? }</code></li> <li><code>transfers.returned</code> \u2192 <code>{ transferId, rail:\"zimswitch\", reasonCode }</code></li> <li><code>transfers.failed</code> \u2192 <code>{ transferId, rail:\"zimswitch\", reason, details }</code></li> </ul>"},{"location":"10-payments-nucleus/components/rail-gateway-zimswitch/#http","title":"HTTP","text":"<ul> <li><code>POST /webhooks/zimswitch</code> (if using REST front-end)</li> <li>Admin: <code>GET /live</code>, <code>GET /ready</code>, <code>GET /metrics</code>, <code>GET /version</code></li> </ul>"},{"location":"10-payments-nucleus/components/rail-gateway-zimswitch/#files-reconciliation","title":"Files / Reconciliation","text":"<ul> <li>Consume settlement/return files delivered by processor; normalize to <code>StatementLine</code> and emit <code>recon.statement.ingested</code></li> </ul>"},{"location":"10-payments-nucleus/components/rail-gateway-zimswitch/#data-model","title":"\ud83d\uddc4 Data Model","text":"<ul> <li>table: <code>zimswitch_ops</code></li> <li><code>id</code> (pk), <code>transferId</code>, <code>tenantId</code>, <code>acquirerId</code>, <code>merchantId</code>, <code>terminalId</code></li> <li><code>acqRef</code>, <code>authCode</code>, <code>panBin</code>, <code>amountMinor</code>, <code>currency</code></li> <li><code>status</code> (INIT|ACCEPTED|CAPTURED|SETTLED|RETURNED|FAILED)</li> <li><code>isoFields</code> (json redacted), <code>resultCode</code>, <code>reasonCode</code></li> <li><code>createdAt</code>, <code>updatedAt</code></li> <li>table: <code>outbox_gateway</code></li> <li>blob: request/response artifacts, settlement files (encrypted)</li> </ul>"},{"location":"10-payments-nucleus/components/rail-gateway-zimswitch/#transform-validation","title":"\ud83d\udd01 Transform &amp; Validation","text":"<ul> <li>BIN routing via Directory: ensure card BIN is allowed and mapped to correct acquirer.</li> <li>Currency rules per merchant/acquirer (ZWL/ZAR/USD); enforce decimal places.</li> <li>ISO fields discipline:</li> <li>F2 PAN \u2192 token/surrogate only (never store PAN)</li> <li>F3 Processing Code \u2192 map from intent (00 purchase, 20 refund, etc.)</li> <li>F4 Amount \u2192 minor units</li> <li>F22 POS Entry Mode (tap-on-phone vs ecom), F25 POS Condition Code</li> <li>F55 EMV data when present</li> <li>3DS/CVM: pass-through checks; reject inconsistent combinations.</li> <li>Idempotency: include <code>{tenantId}:{transferId}</code> in merchant reference; de-dupe repeats.</li> </ul>"},{"location":"10-payments-nucleus/components/rail-gateway-zimswitch/#sequence-tap-on-phone-purchase","title":"\ud83d\udcd0 Sequence (Tap-on-Phone Purchase)","text":"<pre><code>sequenceDiagram\n  participant CTS as Canonical Transfer Service\n  participant GW as Zimswitch Gateway\n  participant PROC as Processor/OPPWA\n  participant RECON as Reconciliation\n\n  CTS-&gt;&gt;GW: transfers.submitted.zimswitch\n  GW-&gt;&gt;GW: validate + build request (ISO fields)\n  GW-&gt;&gt;PROC: submit payment\n  PROC--&gt;&gt;GW: auth approved { acqRef, authCode }\n  GW--&gt;&gt;CTS: transfers.accepted\n  RECON--&gt;&gt;GW: daily settlement file\n  GW--&gt;&gt;CTS: transfers.settled { settlementDate, batchId }</code></pre>"},{"location":"10-payments-nucleus/components/rail-gateway-zimswitch/#failure-modes","title":"\ud83d\udea8 Failure Modes","text":"<ul> <li>BIN not allowed / unknown member \u2192 fail fast (routing)</li> <li>Decline \u2192 emit <code>transfers.failed</code> with mapped reason</li> <li>Chargeback/return (T+N) \u2192 from settlement files/webhooks \u2192 emit <code>transfers.returned</code></li> <li>Webhook signature mismatch \u2192 reject and alert</li> <li>File ingest failure \u2192 pause recon pipeline; reprocess from last checkpoint</li> </ul>"},{"location":"10-payments-nucleus/components/rail-gateway-zimswitch/#observability","title":"\ud83d\udcca Observability","text":"<ul> <li>Metrics: approval rate, latency, returns rate, recon match %</li> <li>Error buckets by ISO result/return codes</li> <li>DLQ sizes for webhooks and file ingests</li> </ul>"},{"location":"10-payments-nucleus/components/rail-gateway-zimswitch/#security","title":"\ud83d\udd10 Security","text":"<ul> <li>PCI containment in gateway; no PAN or full track data persisted</li> <li>Tokenization only; redact EMV tags except whitelisted fields</li> <li>Encrypt artifacts and settlement files at rest</li> <li>Rotate webhook/file-transfer credentials regularly</li> </ul>"},{"location":"10-payments-nucleus/components/rail-gateway-zimswitch/#config","title":"\u2699\ufe0f Config","text":"<ul> <li>Processor endpoints, per-merchant credentials</li> <li><code>WEBHOOK_SECRET</code>, <code>FILE_PULL_SCHEDULE</code></li> <li><code>CURRENCY_ALLOWLIST</code>, <code>BIN_ALLOWLIST</code></li> <li><code>REASON_CODE_MAP</code>, <code>ISO_FIELD_WHITELIST</code></li> </ul>"},{"location":"10-payments-nucleus/components/rail-gateway-zimswitch/#runbooks","title":"\ud83e\udded Runbooks","text":"<ul> <li>Approval rate drop: check acquirer status, BIN routing config, risk engine flags</li> <li>Recon mismatches: inspect mapping keys (acqRef, authCode, amount/date window)</li> <li>Return spike: analyze reason codes; notify CTS to throttle high-risk merchants</li> </ul> <p>See also: Rail Gateway \u2014 Template and Reason Code mappings in ../specs/error-codes.md</p>"},{"location":"10-payments-nucleus/components/reconciliation-returns/","title":"Reconciliation &amp; Returns Service","text":"<p>The Reconciliation &amp; Returns Service ensures Stalela\u2019s books stay aligned with rail statements and handles disputes/returns as first-class flows.</p>"},{"location":"10-payments-nucleus/components/reconciliation-returns/#purpose","title":"\ud83c\udfaf Purpose","text":"<ul> <li>Ingest statements/settlement files from rails.  </li> <li>Match against canonical transfers.  </li> <li>Emit settlement or return events.  </li> <li>Queue unmatched items for operator review.  </li> <li>Model returns/disputes as state transitions.</li> </ul>"},{"location":"10-payments-nucleus/components/reconciliation-returns/#responsibilities","title":"\ud83d\udee0 Responsibilities","text":"<ul> <li>Scheduled pull/ingest of rail statements (files, APIs, on-chain events).  </li> <li>Normalize to internal <code>StatementLine</code> model.  </li> <li>Match to existing transfers (composite keys).  </li> <li>Emit <code>transfers.settled</code> (late confirm) or <code>transfers.returned</code>.  </li> <li>Push unmatched \u2192 exception queue for Operator Console.  </li> <li>Support manual raise of returns.</li> </ul>"},{"location":"10-payments-nucleus/components/reconciliation-returns/#interfaces","title":"\ud83d\udd0c Interfaces","text":""},{"location":"10-payments-nucleus/components/reconciliation-returns/#events-consume","title":"Events (consume)","text":"<ul> <li><code>recon.statement.ingested</code></li> </ul>"},{"location":"10-payments-nucleus/components/reconciliation-returns/#events-emit","title":"Events (emit)","text":"<ul> <li><code>transfers.settled</code> </li> <li><code>transfers.returned</code> </li> <li><code>recon.exception.opened</code> </li> </ul>"},{"location":"10-payments-nucleus/components/reconciliation-returns/#http","title":"HTTP","text":"<ul> <li><code>POST /returns</code> (manual raise)  </li> <li>Admin: <code>GET /live</code>, <code>GET /ready</code>, <code>GET /metrics</code>, <code>GET /version</code></li> </ul>"},{"location":"10-payments-nucleus/components/reconciliation-returns/#data-model","title":"\ud83d\uddc4 Data Model","text":"<ul> <li><code>statements</code> (rail, fileId, source, importedAt)  </li> <li><code>statement_lines</code> (id, statementId, externalRef, amount, currency, date, type, reason?)  </li> <li>Matching keys (per rail) typically include: <code>{ externalRef | (acqRef,authCode) | txId } + amount + date window</code>.  </li> <li><code>matches</code> (lineId, transferId, matchedAt)  </li> <li><code>exceptions</code> (id, lineId, status, resolvedAt, operatorId?)  </li> <li><code>outbox_recon</code> </li> </ul>"},{"location":"10-payments-nucleus/components/reconciliation-returns/#file-specifications-per-rail","title":"\ud83d\udcc4 File Specifications (per rail)","text":"<ul> <li>EFT (Bankserv): settlement and return record layouts, cutoffs, T+N windows.</li> <li>PayShap: real-time exceptions/returns mapping to <code>StatementLine</code>.</li> <li>ZIPIT/RTGS: daily statements and chargeback reason codes.</li> </ul>"},{"location":"10-payments-nucleus/components/reconciliation-returns/#sequence","title":"\ud83d\udcd0 Sequence","text":"<pre><code>sequenceDiagram\n  participant R as Reconciliation\n  participant Rail as Rail Source\n  participant CTS\n  participant L as Ledger\n\n  Rail--&gt;&gt;R: daily statement file\n  R-&gt;&gt;R: normalize lines\n  R--&gt;&gt;CTS: transfers.settled (if not yet settled)\n  R--&gt;&gt;CTS: transfers.returned (if return/chargeback)\n  R--&gt;&gt;CTS: recon.exception.opened (if unmatched)\n  CTS-&gt;&gt;L: post reversals / settlements\n  Note over CTS,L: Ledger applies Posting Rules to reverse prior settled entries</code></pre>"},{"location":"10-payments-nucleus/components/reconciliation-returns/#failure-modes","title":"\ud83d\udea8 Failure Modes","text":"<ul> <li>File ingest failed \u2192 pause, retry, operator alert.  </li> <li>Hash mismatch \u2192 reject, re-request file.  </li> <li>High unmatched rate \u2192 escalate ops, inspect Directory/CTS config.  </li> </ul>"},{"location":"10-payments-nucleus/components/reconciliation-returns/#observability","title":"\ud83d\udcca Observability","text":"<ul> <li>Metrics: match rate, unmatched backlog, return rates.  </li> <li>Logs: structured with transferId, lineId, fileId.  </li> </ul>"},{"location":"10-payments-nucleus/components/reconciliation-returns/#security","title":"\ud83d\udd10 Security","text":"<ul> <li>Encrypt raw statement files.  </li> <li>Least privilege on file source credentials.  </li> </ul>"},{"location":"10-payments-nucleus/components/reconciliation-returns/#runbooks","title":"\ud83e\udded Runbooks","text":"<ul> <li>Unmatched backlog \u2192 operator assigns manually.  </li> <li>High return rate \u2192 throttle merchant, investigate risk.  </li> <li>File delivery gap \u2192 contact partner, reconcile manually.  </li> </ul>"},{"location":"10-payments-nucleus/components/regulatory-reporting/","title":"Regulatory Reporting Service","text":"<p>Purpose Prepare and submit statutory reports (BoP, goAML) for ZA/ZW; manage schedules, receipts, and retries.</p>"},{"location":"10-payments-nucleus/components/regulatory-reporting/#responsibilities","title":"Responsibilities","text":"<ul> <li>Aggregate required data from events/services.  </li> <li>Build BoP files/API payloads and goAML STR/CTR submissions.  </li> <li>Manage submission windows, retries, and DLQs.  </li> <li>Store immutable receipts and audit logs.</li> </ul>"},{"location":"10-payments-nucleus/components/regulatory-reporting/#interfaces","title":"Interfaces","text":""},{"location":"10-payments-nucleus/components/regulatory-reporting/#inputs","title":"Inputs","text":"<ul> <li>Events: <code>transfers.*</code> (as needed), ledger postings (read-only API).  </li> <li>Internal reads: CTS/Ledger/Compliance summaries.</li> </ul>"},{"location":"10-payments-nucleus/components/regulatory-reporting/#outputs","title":"Outputs","text":"<ul> <li>Files/APIs: BoP to SARB authorized dealer; goAML to FIC/FIU.  </li> <li>Events: <code>reg.submission.created</code>, <code>reg.submission.acknowledged</code>, <code>reg.submission.failed</code>.</li> </ul>"},{"location":"10-payments-nucleus/components/regulatory-reporting/#data-model","title":"Data Model","text":"<ul> <li><code>reg_submissions</code> (id, type, scope, payloadRef, status, submittedAt, receiptRef).  </li> <li><code>outbox_reg</code> for event emission.  </li> <li>Artifacts: encrypted payloads and receipts.</li> </ul>"},{"location":"10-payments-nucleus/components/regulatory-reporting/#runbooks","title":"Runbooks","text":"<ul> <li>Submission failure: retry with backoff; escalate per contact matrix.  </li> <li>Corrections: T+1 resubmission referencing prior filing.  </li> </ul>"},{"location":"10-payments-nucleus/components/regulatory-reporting/#security","title":"Security","text":"<ul> <li>Least privilege to source systems; encrypt at rest; PII minimization in artifacts.  </li> <li>Access controlled endpoints for manual replay.</li> </ul>"},{"location":"10-payments-nucleus/components/woocommerce/","title":"WooCommerce \u2194\ufe0f Stalela CTS Plugin (USDC Example)","text":"<p>This document describes a production\u2011ready WooCommerce plugin that connects a merchant\u2019s store to Stalela\u2019s Canonical Transfer Service (CTS) to accept USDC (AVAX) payments. It covers integration flows, mapping, idempotency, and operational concerns with Mermaid diagrams.</p>"},{"location":"10-payments-nucleus/components/woocommerce/#1-objectives","title":"1) Objectives","text":"<ul> <li>Let WooCommerce merchants accept USDC at checkout using Stalela CTS.</li> <li>Keep the storefront UX native (Woo buttons, order notes, refunds) while offloading payment orchestration to CTS.</li> <li>Ensure idempotency, observability, and clear failure handling.</li> </ul>"},{"location":"10-payments-nucleus/components/woocommerce/#2-highlevel-architecture","title":"2) High\u2011Level Architecture","text":"<pre><code>flowchart LR\n  subgraph Shopper\n    U[Customer Browser]\n  end\n\n  subgraph Woo[Merchant WooCommerce]\n    WC[WooCore + Orders]\n    P[Stalela Payment Gateway Plugin]\n    WH[Woo REST Webhooks]\n  end\n\n  subgraph Stalela\n    API[CTS API]\n    BUS[events.transfers.*]\n    GW[USDC Gateway]\n  end\n\n  U --&gt;|\"Checkout: Place Order\"| WC\n  WC --&gt; P\n  P --&gt;|\"POST /transfers (Idempotency-Key)\"| API\n  API --&gt;|\"events.transfers.submitted.usdc\"| BUS\n  BUS --&gt; GW\n  GW --&gt;|\"accepted/settled\"| BUS\n  BUS --&gt;|\"webhook callback\"| WH\n  WH --&gt;|\"update order meta/status\"| WC\n</code></pre>"},{"location":"10-payments-nucleus/components/woocommerce/#3-checkout-sequence-happy-path-nonblocking-settlement","title":"3) Checkout Sequence (Happy Path, non\u2011blocking settlement)","text":"<pre><code>sequenceDiagram\n  autonumber\n  participant U as Shopper\n  participant WC as WooCommerce\n  participant P as Stalela Plugin\n  participant API as CTS/API\n  participant BUS as EventBus\n  participant GW as Gateway(USDC)\n  participant WH as Woo Webhook Endpoint\n\n  U-&gt;&gt;WC: Place order (payment method = Stalela USDC)\n  WC-&gt;&gt;P: on_payment_process(order)\n  Note over P: Build canonical request + Idempotency-Key\n  P-&gt;&gt;API: POST /transfers {Idempotency-Key}\n  API--&gt;&gt;P: 201 {transferId, state: SUBMITTED}\n  P-&gt;&gt;WC: mark order as \"on-hold\" (awaiting crypto payment)\n  API-&gt;&gt;BUS: emit transfers.submitted.usdc (async)\n  BUS-&gt;&gt;GW: deliver submitted.usdc\n  GW-&gt;&gt;BUS: events.transfers.accepted\n  BUS-&gt;&gt;WH: POST /wc/storo/webhook {accepted}\n  WH-&gt;&gt;WC: add order note \"Payment accepted\"\n  GW-&gt;&gt;BUS: events.transfers.settled\n  BUS-&gt;&gt;WH: POST /wc/storo/webhook {settled}\n  WH-&gt;&gt;WC: set status \"processing\" (or \"completed\")\n  WH--&gt;&gt;U: Thank\u2011you page reflects paid</code></pre> <p>Key points</p> <ul> <li>The plugin returns the shopper immediately after CTS persists &amp; returns <code>SUBMITTED</code>.</li> <li>Order remains On\u2011Hold until <code>accepted</code>/<code>settled</code> webhook updates it.</li> </ul>"},{"location":"10-payments-nucleus/components/woocommerce/#4-data-mapping-woo-cts","title":"4) Data Mapping (Woo \u2194\ufe0f CTS)","text":"Woo Source CTS Target Notes <code>order_id</code> <code>externalRef</code> Stable reference from Woo to CTS <code>order_total</code> <code>amount.value</code> / <code>amount.currency</code> Currency can be <code>USD</code> for USDC 1:1; FX rules configurable <code>billing_email</code>/<code>user_id</code> <code>payer</code> PII encrypted server\u2011side; plugin sends IDs, not PII, when possible Merchant USDC dest (wallet/tenant) <code>payee</code> Provisioned during plugin onboarding <code>Idempotency-Key</code> Header + <code>bodyHash</code> e.g., <code>woocommerce:&lt;storeId&gt;:order:&lt;orderId&gt;</code> <code>payment_method_title</code> <code>metadata.gateway</code> e.g., <code>storo-usdc</code> <p>Canonical request (example)</p> <pre><code>{\n  \"tenantId\": \"tnt_demo\",\n  \"intent\": \"PUSH\",\n  \"amount\": { \"value\": \"49.99\", \"currency\": \"USD\" },\n  \"payer\": { \"type\": \"WALLET\", \"id\": \"shopper-123\" },\n  \"payee\": { \"type\": \"WALLET\", \"provider\": \"USDC_AVAX\", \"id\": \"0xMERCHANT...\" },\n  \"externalRef\": \"woo_100045\",\n  \"metadata\": { \"platform\": \"woocommerce\", \"plugin_version\": \"1.0.0\" }\n}\n</code></pre>"},{"location":"10-payments-nucleus/components/woocommerce/#5-plugin-components","title":"5) Plugin Components","text":"<pre><code>graph TD\n  subgraph Plugin\n    H[\"Settings UI (Admin)\"]\n    G[\"Gateway Class (WC_Payment_Gateway)\"]\n    C[\"Client (CTS SDK)\"]\n    W[\"Webhook Controller\"]\n    I[\"Idempotency Service\"]\n    L[\"Logger/Telemetry\"]\n  end\n  H --&gt; G\n  G --&gt; I\n  G --&gt; C\n  W --&gt; G\n  G --&gt; L\n  W --&gt; L\n</code></pre> <p>Responsibilities</p> <ul> <li>Settings UI: API keys, merchant wallet, network (AVAX), test mode, webhook secret.</li> <li>Gateway Class: Implements <code>process_payment</code>, order status transitions, thank\u2011you handling.</li> <li>CTS Client: Retries, timeouts, schema version header, <code>Idempotency-Key</code>.</li> <li>Webhook Controller: Verifies signature; updates order status on <code>accepted</code>/<code>settled</code>/<code>returned</code>/<code>failed</code>.</li> <li>Idempotency Service: Stable key generation + replay safety on Woo retries.</li> <li>Logger: Structured logs with <code>order_id</code>, <code>transferId</code>, <code>tenantId</code> (no PII fields).</li> </ul>"},{"location":"10-payments-nucleus/components/woocommerce/#6-order-state-machine-woo-cts","title":"6) Order State Machine (Woo + CTS)","text":"<pre><code>stateDiagram-v2\n  [*] --&gt; PENDING\n  PENDING --&gt; ON_HOLD: CTS POST 201 (SUBMITTED)\n  ON_HOLD --&gt; PROCESSING: webhook accepted/settled\n  PROCESSING --&gt; COMPLETED: fulfillment done\n  ON_HOLD --&gt; FAILED: webhook failed/returned\n  PENDING --&gt; FAILED: validation/compliance deny\n  COMPLETED --&gt; [*]\n  FAILED --&gt; [*]</code></pre> <p>Notes</p> <ul> <li>If <code>accepted</code> arrives first, move to Processing, then to Completed on <code>settled</code>.</li> <li>If <code>returned/failed</code>, move to Failed and expose reason in order notes.</li> </ul>"},{"location":"10-payments-nucleus/components/woocommerce/#7-webhook-contract-from-stalela-woo","title":"7) Webhook Contract (from Stalela \u2192 Woo)","text":"<p>Endpoint: <code>POST https://merchant.store/wc/storo/webhook</code></p> <p>Headers: <code>X-Stalela-Signature</code>, <code>X-Stalela-Timestamp</code>, <code>X-Request-Id</code></p> <p>Body (accepted)</p> <pre><code>{\n  \"type\": \"events.transfers.accepted\",\n  \"transferId\": \"tr_123\",\n  \"externalRef\": \"woo_100045\",\n  \"occurredAt\": \"2025-08-28T12:34:56Z\",\n  \"envelope\": {\"v\":1},\n  \"metadata\": {\"rail\":\"usdc\"}\n}\n</code></pre> <p>Body (settled) is identical with <code>type = events.transfers.settled</code>.</p> <p>Webhook handler behavior</p> <ol> <li>Verify signature \u2192 401 if invalid.</li> <li>Lookup <code>order_id</code> via <code>externalRef</code>.</li> <li>Idempotent update of order status; add note with timestamp + <code>transferId</code>.</li> </ol>"},{"location":"10-payments-nucleus/components/woocommerce/#8-usdc-flow-rails-specifics","title":"8) USDC Flow (rails specifics)","text":"<pre><code>flowchart LR\n  P[Plugin] --&gt; API[CTS]\n  API --&gt; OUTBOX[Outbox]\n  OUTBOX --&gt; BUS[events.transfers.submitted.usdc]\n  BUS --&gt; GW[USDC Gateway]\n  GW --&gt;|submit tx on AVAX| CHAIN[(AVAX C-Chain)]\n  CHAIN --&gt; GW\n  GW --&gt; BUS\n  BUS --&gt; WH[Woo Webhook]</code></pre> <ul> <li>Gateway uses a relayer to handle gas; merchant receives USDC on their AVAX address.</li> <li>CTS does not block Woo checkout waiting for settlement.</li> </ul>"},{"location":"10-payments-nucleus/components/woocommerce/#9-errors-retries","title":"9) Errors &amp; Retries","text":"Situation Source Plugin Behavior Compliance deny CTS sync response 422 Fail payment; order \u2192 Failed; show friendly error Routing unavailable CTS 502 Keep order Pending; show retry button; exponential backoff client\u2011side Webhook missed Network issue Admin action: \u201cRe\u2011deliver last 24h\u201d button; plugin can poll <code>GET /transfers/:id</code> as fallback Duplicate checkout Shopper retries Same Idempotency\u2011Key \u2192 plugin handles 200/201 idempotently"},{"location":"10-payments-nucleus/components/woocommerce/#10-configuration-onboarding","title":"10) Configuration &amp; Onboarding","text":"<ul> <li>API Keys: Tenant\u2011scoped key from Stalela Console.</li> <li>Merchant Wallet (USDC): Provided during onboarding; validated against network.</li> <li>Webhook Secret: Rotate via plugin UI; validate on each callback.</li> <li>Test Mode: Sandboxed CTS tenant &amp; USDC test network.</li> </ul>"},{"location":"10-payments-nucleus/components/woocommerce/#11-observability","title":"11) Observability","text":"<ul> <li>Order Notes include transfer lifecycle markers.</li> <li>Admin Dashboard Widget: last 50 events, settlement latency p95, failure counts.</li> <li>Logging: Structured (order_id, transferId, tenantId, type). No PII.</li> </ul>"},{"location":"10-payments-nucleus/components/woocommerce/#12-example-admin-runbook","title":"12) Example Admin Runbook","text":"<ol> <li>Order stuck On\u2011Hold &gt; 10 min \u2192 check webhook delivery logs.</li> <li>If missing, press Re\u2011deliver in Stalela Console or poll <code>GET /transfers/:id</code>.</li> <li>If <code>returned/failed</code>, contact customer; optionally retry new payment method.</li> </ol>"},{"location":"10-payments-nucleus/components/woocommerce/#13-security","title":"13) Security","text":"<ul> <li>HMAC\u2011signed webhooks; 5\u2011minute timestamp window.</li> <li>Least\u2011privilege API key; rotate every 90 days.</li> <li>PII never stored in plugin; only references &amp; IDs.</li> </ul>"},{"location":"10-payments-nucleus/components/woocommerce/#14-future-enhancements","title":"14) Future Enhancements","text":"<ul> <li>Refunds: Map Woo refunds \u2192 <code>transfers.pull</code> or reversal flow.</li> <li>Partial Payments: Split shipments \u2192 multiple transferIds.</li> <li>Multi\u2011rail fallback: If USDC unavailable, offer Zimswitch card or M\u2011Pesa.</li> </ul>"},{"location":"10-payments-nucleus/diagrams/component-nucleus/","title":"Component: Nucleus","text":"<pre><code>flowchart LR\n  subgraph Client/Partners\n    A[Client Apps / Merchants / WhatsApp Bot]\n  end\n\n  subgraph Core[\"Stalela Nucleus\"]\n    direction LR\n\n    subgraph API[\"Canonical Transfer Service (API)\"]\n      CTS[POST /transfers&lt;br/&gt;GET /transfers/:id&lt;br/&gt;Idempotency]\n    end\n\n    subgraph GW[\"Rail Gateways\"]\n      ZG[Zimswitch Gateway]\n      OG[OPPWA Gateway]\n      UG[USDC/Algorand Gateway]\n    end\n\n    subgraph L[\"Ledger Service\"]\n      LJ[Journal &amp; Postings]\n      LB[Balances &amp; Statements]\n    end\n\n    subgraph C[\"Compliance Screening\"]\n      CS[Local Watchlist Index&lt;br/&gt;/screen]\n    end\n\n    subgraph D[\"Directory &amp; Routing\"]\n      DR[Institutions/BINs&lt;br/&gt;Fees &amp; Windows]\n    end\n\n    subgraph R[\"Reconciliation &amp; Returns\"]\n      RC[Statement Ingest&lt;br/&gt;Unmatched Queue]\n    end\n\n    subgraph B[\"Event Bus + Outbox\"]\n      EB[(Topics: transfers.*, ledger.*, recon.*)]\n    end\n\n    subgraph O[\"Operator Console\"]\n      OC[Ops UI&lt;br/&gt;Returns/Recon/Flags]\n    end\n\n    subgraph PL[\"Platform/Base\"]\n      AD[/ /live /ready /metrics /version /]\n      TM[Banking Time &amp; Holidays]\n      IDG[ID/Tracing &amp; Errors]\n    end\n  end\n\n  A --&gt;|create intent| CTS\n  CTS --&gt;|pre-screen| CS\n  CS --&gt;|allow/deny| CTS\n  CTS --&gt;|route| D\n  D --&gt; CTS\n  CTS --&gt;|submit| ZG\n  CTS --&gt;|submit| OG\n  CTS --&gt;|submit| UG\n\n  ZG --&gt; EB\n  OG --&gt; EB\n  UG --&gt; EB\n\n  EB --&gt; CTS\n  EB --&gt; L\n  EB --&gt; R\n  EB --&gt; O\n\n  L &lt;--&gt; R\n  R --&gt;|nightly ingest| EB\n\n  OC --- O\n  PL --- CTS\n  PL --- GW\n  PL --- L\n  PL --- C\n  PL --- D\n  PL --- R</code></pre>"},{"location":"10-payments-nucleus/diagrams/lifecycle-state/","title":"Transfer Lifecycle","text":"<pre><code>stateDiagram-v2\n  [*] --&gt; INITIATED\n  INITIATED --&gt; SUBMITTED: CTS submits.&lt;rail&gt;\n  SUBMITTED --&gt; ACCEPTED: rail reference received\n  ACCEPTED --&gt; SETTLED: funds final\n  ACCEPTED --&gt; RETURNED: return/chargeback code\n  SUBMITTED --&gt; FAILED: technical failure\n  SETTLED --&gt; [*]\n  RETURNED --&gt; [*]\n  FAILED --&gt; [*]</code></pre>"},{"location":"10-payments-nucleus/diagrams/recon-matching/","title":"Reconciliation Matching","text":"<pre><code>flowchart TD\n  ST[(Rail Statement Files / On-chain Events)]\n  NORM[Normalize to StatementLine]\n  MATCH{Match to\nTransfers?}\n  EMIT1[Emit transfers.settled]\n  EMIT2[Emit transfers.returned]\n  EXC[Open recon.exception]\n  OP[Operator Console]\n\n  ST --&gt; NORM --&gt; MATCH\n  MATCH --&gt;|Settlement| EMIT1\n  MATCH --&gt;|Return| EMIT2\n  MATCH --&gt;|No| EXC --&gt; OP</code></pre>"},{"location":"10-payments-nucleus/diagrams/sequence-bop-reporting/","title":"Sequence: BoP Reporting Pipeline","text":"<pre><code>sequenceDiagram\n  participant CTS\n  participant LED as Ledger\n  participant REG as Regulatory Reporting\n  participant AD as Authorized Dealer/SARB\n\n  CTS--&gt;&gt;REG: transfers.settled (subset)\n  LED--&gt;&gt;REG: postings/read (summary)\n  REG-&gt;&gt;REG: build BoP payload\n  REG-&gt;&gt;AD: submit BoP\n  AD--&gt;&gt;REG: receipt/ack\n  REG--&gt;&gt;CTS: reg.submission.acknowledged</code></pre>"},{"location":"10-payments-nucleus/diagrams/sequence-eft-batch/","title":"Sequence: EFT Batch","text":"<pre><code>sequenceDiagram\n  participant CTS\n  participant EFT as EFT Gateway\n  participant PARTNER as Bankserv Partner\n  participant R as Reconciliation\n\n  CTS-&gt;&gt;EFT: enqueue transfers\n  EFT-&gt;&gt;PARTNER: submit batch file\n  PARTNER--&gt;&gt;EFT: ack/reject\n  EFT--&gt;&gt;CTS: transfers.accepted (per line)\n  PARTNER--&gt;&gt;EFT: settlement/returns files\n  EFT--&gt;&gt;R: recon.statement.ingested\n  R--&gt;&gt;CTS: transfers.settled / transfers.returned</code></pre>"},{"location":"10-payments-nucleus/diagrams/sequence-return-oppwa/","title":"Sequence: Return (OPPWA)","text":"<pre><code>sequenceDiagram\n  participant CTS as Canonical Transfer Service\n  participant GW as OPPWA Gateway\n  participant OPP as OPPWA API\n  participant WH as Webhook Receiver\n  participant L as Ledger\n  participant OC as Operator Console\n\n  CTS-&gt;&gt;GW: transfers.submitted.oppwa (intent=AUTH)\n  GW-&gt;&gt;OPP: POST /payments (preauth)\n  OPP--&gt;&gt;GW: result {opRef, resultCode}\n  GW--&gt;&gt;CTS: transfers.accepted {opRef}\n\n  %% Later, dispute/return arrives\n  WH--&gt;&gt;GW: webhook {opRef, reasonCode, chargeback:true}\n  GW--&gt;&gt;CTS: transfers.returned {reasonCode}\n  CTS--&gt;&gt;L: transfers.returned\n  L--&gt;&gt;OC: ledger.posting.created (reversal)</code></pre>"},{"location":"10-payments-nucleus/diagrams/sequence-stk-ecocash/","title":"Sequence: EcoCash STK Prompt","text":"<pre><code>sequenceDiagram\n  participant CTS\n  participant GW as EcoCash GW\n  participant MNO as EcoCash\n  participant L as Ledger\n\n  CTS-&gt;&gt;GW: transfers.submitted.ecocash\n  GW-&gt;&gt;MNO: STK prompt\n  MNO--&gt;&gt;GW: accepted {opRef}\n  GW--&gt;&gt;CTS: transfers.accepted\n  MNO--&gt;&gt;GW: settled/return\n  GW--&gt;&gt;CTS: transfers.settled / transfers.returned\n  CTS--&gt;&gt;L: transfers.settled / transfers.returned</code></pre>"},{"location":"10-payments-nucleus/diagrams/sequence-submit-payshap/","title":"Sequence: Submit PayShap","text":"<pre><code>sequenceDiagram\n  participant Client\n  participant CTS as Canonical Transfer Service\n  participant DR as Directory\n  participant GW as PayShap Gateway\n  participant L as Ledger\n\n  Client-&gt;&gt;CTS: POST /transfers (proxy)\n  CTS-&gt;&gt;DR: resolve proxy\n  DR--&gt;&gt;CTS: account route\n  CTS-&gt;&gt;GW: transfers.submitted.payshap\n  GW--&gt;&gt;CTS: transfers.accepted\n  GW--&gt;&gt;CTS: transfers.settled\n  CTS--&gt;&gt;L: transfers.settled\n  L--&gt;&gt;CTS: ledger.posting.created</code></pre>"},{"location":"10-payments-nucleus/diagrams/sequence-submit-usdc/","title":"Sequence: Submit USDC","text":"<pre><code>sequenceDiagram\n  participant Client\n  participant CTS as Canonical Transfer Service\n  participant CS as Compliance\n  participant DR as Directory\n  participant GW as USDC/Algorand Gateway\n  participant L as Ledger\n\n  Client-&gt;&gt;CTS: POST /transfers (idempotency-key)\n  CTS-&gt;&gt;CTS: dedupe &amp; normalize\n  CTS-&gt;&gt;CS: POST /screen (payer, payee)\n  CS--&gt;&gt;CTS: allow\n  CTS-&gt;&gt;DR: GET /routes?rail=usdc-algo\n  DR--&gt;&gt;CTS: { endpoint, fees, window }\n  CTS-&gt;&gt;GW: transfers.submitted.usdc\n  GW--&gt;&gt;CTS: transfers.accepted {txId}\n  GW--&gt;&gt;CTS: transfers.settled {txId, round}\n  CTS--&gt;&gt;L: transfers.settled\n  L--&gt;&gt;CTS: ledger.posting.created</code></pre>"},{"location":"10-payments-nucleus/infra/aws-infra/","title":"AWS Infrastructure Blueprint (Stalela Nucleus)","text":""},{"location":"10-payments-nucleus/infra/aws-infra/#general","title":"General","text":"<ul> <li>VPC (3 AZs); public subnets (ALB/NLB), private subnets (ECS/RDS), VPC endpoints (S3, SQS, SNS, Secrets Manager, ECR, CloudWatch).</li> <li>Compute: ECS Fargate (services + workers); cron via EventBridge Scheduler \u2192 Fargate tasks.</li> <li>Images/Artifacts: ECR; S3 for payloads/statement files (KMS-CMK).</li> <li>Config/Secrets: SSM Parameter Store + Secrets Manager (rotation); per-task IAM roles.</li> <li>CI/CD: GitHub Actions OIDC \u2192 AWS; ECR push; Terraform (<code>storo-infra</code>) apply.</li> <li>Observability: CloudWatch logs/metrics/alarms; OpenTelemetry to AMP/Managed Grafana; X-Ray optional.</li> <li>Security: ALB + WAF (public), internal ALBs; TLS (ACM); KMS on RDS/S3/SNS/SQS; least\u2011privilege SGs &amp; IAM.</li> </ul>"},{"location":"10-payments-nucleus/infra/aws-infra/#event-bus-outbox-crosscutting","title":"Event Bus &amp; Outbox (cross\u2011cutting)","text":"<ul> <li>Topics: SNS per domain (<code>transfers</code>, <code>ledger</code>, <code>recon</code>, <code>compliance</code>) with SQS subscriptions per consumer.</li> <li>Queues: SQS standard with DLQs; visibility timeout &gt; max handler time; redrive policy.</li> <li>Ordering (rare): SNS/SQS FIFO for specific flows.</li> <li>Scaling: ECS autoscale on SQS depth; alarms on outbox backlog and consumer lag.</li> <li>Replay: Outbox in RDS; DLQ replay runbooks.</li> </ul>"},{"location":"10-payments-nucleus/infra/aws-infra/#data-stores","title":"Data Stores","text":"<ul> <li>RDS Postgres (Multi\u2011AZ) per service (CTS, Ledger, Directory, Recon, Compliance); PITR; Performance Insights.</li> <li>S3 buckets per domain: <code>rail-artifacts</code>, <code>statements</code>, <code>raw-webhooks</code> (encryption, lifecycle, bucket policies).</li> <li>Optional: Elasticache Redis for hot lookups (Directory); OpenSearch only if needed for operator search.</li> </ul>"},{"location":"10-payments-nucleus/infra/aws-infra/#canonical-transfer-service-cts","title":"Canonical Transfer Service (CTS)","text":"<ul> <li>ECS Fargate behind public ALB (HTTPS, ACM). Private internal ALB for service\u2011to\u2011service where applicable.</li> <li>RDS <code>storo_cts</code> (transfers, transfer_events, outbox).</li> <li>NAT egress for partners as needed; prefer VPC endpoints for AWS services.</li> </ul>"},{"location":"10-payments-nucleus/infra/aws-infra/#rail-gateways-ecocash-mtnairtel-oppwa-zimswitch-payshap-usdcalgo","title":"Rail Gateways (EcoCash, MTN/Airtel, OPPWA, Zimswitch, PayShap, USDC/Algo)","text":"<ul> <li>ECS Fargate per gateway in private subnets; internal ALB.</li> <li>Public webhooks via dedicated public ALB + WAF, path <code>/webhooks/&lt;rail&gt;</code>.</li> <li>S3: raw payload snapshots; SQS DLQ for poison messages.</li> <li>Signing (USDC): CloudHSM or external signer; keys never leave enclave; task role scoped to signer.</li> <li>Partner connectivity: NAT egress; PrivateLink where supported.</li> </ul>"},{"location":"10-payments-nucleus/infra/aws-infra/#ledger-service","title":"Ledger Service","text":"<ul> <li>ECS Fargate + RDS <code>storo_ledger</code> (journals, postings, balances, outbox).</li> <li>SQS consumers for <code>transfers.accepted/settled/returned</code>; emit <code>ledger.*</code> to SNS.</li> <li>Internal ALB for read API; optional RDS Proxy; consider partitioning/archival strategy.</li> </ul>"},{"location":"10-payments-nucleus/infra/aws-infra/#compliance-screening","title":"Compliance Screening","text":"<ul> <li>ECS Fargate + RDS <code>storo_compliance</code>; S3 for list sources; EventBridge for scheduled refresh.</li> <li>Private ingress from CTS; alarms on index age; DLQ for ingest failures.</li> </ul>"},{"location":"10-payments-nucleus/infra/aws-infra/#directory-routing","title":"Directory &amp; Routing","text":"<ul> <li>ECS Fargate + RDS <code>storo_directory</code>; emits <code>directory.version.updated</code>.</li> <li>Optional Redis cache; internal <code>/routes</code> and <code>/calendars</code> APIs.</li> </ul>"},{"location":"10-payments-nucleus/infra/aws-infra/#reconciliation-returns","title":"Reconciliation &amp; Returns","text":"<ul> <li>S3 landing buckets per rail; S3 Put \u2192 SQS \u2192 ECS normalize workers.</li> <li>Recon service (ECS + RDS <code>storo_recon</code>) matches lines \u2192 emits <code>transfers.settled/returned</code>.</li> <li>EventBridge Scheduler for partner pulls; AWS Transfer Family for SFTP if required.</li> </ul>"},{"location":"10-payments-nucleus/infra/aws-infra/#operator-console","title":"Operator Console","text":"<ul> <li>Internal Next.js on ECS behind internal ALB; access via AWS VPN/Client VPN or Identity Center.</li> <li>Optionally CloudFront + WAF + Cognito/Identity Center for controlled external access.</li> </ul>"},{"location":"10-payments-nucleus/infra/aws-infra/#environments-regions","title":"Environments &amp; Regions","text":"<ul> <li>Separate AWS accounts: dev, staging, prod (Organizations, SCPs, guardrails).</li> <li>Region: af\u2011south\u20111 for ZA residency; assess ZW residency needs.</li> <li>Per\u2011env VPC stacks; ECR image promotion by tag; snapshot retention (35d), cross\u2011account copy for DR.</li> </ul>"},{"location":"10-payments-nucleus/infra/aws-infra/#ha-dr-backups","title":"HA, DR, Backups","text":"<ul> <li>RDS Multi\u2011AZ, PITR, snapshots; S3 versioning + lifecycle; SNS/SQS DLQs.</li> <li>ECS desired count \u2265 2 for critical services across 3 AZs; ALB health checks.</li> <li>Runbooks: DLQ drains, outbox replays, RDS failovers.</li> </ul>"},{"location":"10-payments-nucleus/infra/aws-infra/#cost-scaling","title":"Cost &amp; Scaling","text":"<ul> <li>Reduce NAT egress via VPC endpoints (S3 Gateway, SQS/SNS/SM/ECR/Logs interfaces).</li> <li>Autoscale: CPU/Memory + custom (SQS depth, publish lag).</li> <li>Fargate Spot for non\u2011critical batch workers (recon), if acceptable.</li> </ul>"},{"location":"10-payments-nucleus/infra/aws-infra/#networking-security","title":"Networking &amp; Security","text":"<ul> <li>SGs per service; no 0.0.0.0/0 on private tasks; WAF on public ALBs.</li> <li>IAM: per\u2011task roles; scoped access to S3 prefixes/SNS topics/SQS queues/KMS keys.</li> <li>Audit: CloudTrail, Config, GuardDuty, Security Hub; log retention per policy.</li> </ul>"},{"location":"10-payments-nucleus/infra/aws-infra/#pipeline-per-service","title":"Pipeline (per service)","text":"<ul> <li>Build: GitHub Actions \u2192 ECR.</li> <li>Deploy: Terraform plans/applies; ECS service update; one\u2011off migration task before rollout.</li> <li>Contract checks in CI using Fixtures; optional canary tasks; rollback via task set or previous image tag.</li> </ul>"},{"location":"10-payments-nucleus/infra/aws-infra/#serverless-pilot-option-a-lambda-api-gateway-aurora-serverless-v2","title":"Serverless Pilot (Option A) \u2014 Lambda + API Gateway + Aurora Serverless v2","text":"<ul> <li>Pilot decision: use API Gateway + Lambda, Aurora Serverless v2 (PostgreSQL) via RDS Proxy, SNS FIFO + SQS FIFO for events.</li> <li>Keep ECS guidance above for future non\u2011serverless services; pilot focuses on serverless for CTS and lightweight consumers.</li> </ul>"},{"location":"10-payments-nucleus/infra/aws-infra/#stacks-infra-repo-cdk","title":"Stacks (infra repo, CDK)","text":"<ul> <li>SharedVpcStack: VPC (2\u20133 AZs), private subnets for Lambdas + DB, NAT, interface endpoints (SQS/SNS/SM/Logs/ECR), SGs.</li> <li>DatabaseStack: Aurora Serverless v2 (min ACU 0.5\u20131, max 4), Multi\u2011AZ, RDS Proxy (IAM auth), parameter groups, Secrets Manager.</li> <li>EventingStack: SNS FIFO topic <code>events.transfers</code> with KMS; SQS FIFO DLQs and publish policy.</li> <li>ApiGatewayStack: API Gateway HTTP API (or REST if usage plans needed), WAF, stages, custom domain.</li> <li>ObservabilityStack: CloudWatch log groups, dashboards, alarms (p95, 5xx, SLO burn), X\u2011Ray.</li> <li>Outputs to SSM Parameter Store (per env):</li> <li><code>/storo/${env}/api/id</code>, <code>/storo/${env}/sns/events-transfers/arn</code>,</li> <li><code>/storo/${env}/rds/proxy/endpoint</code>, <code>/storo/${env}/rds/secret/arn</code>.</li> </ul>"},{"location":"10-payments-nucleus/infra/aws-infra/#service-stacks-service-repos-cdk","title":"Service stacks (service repos, CDK)","text":"<ul> <li>Import SSM parameters, then define:</li> <li>Lambdas: <code>cts-api</code>, <code>cts-outbox-worker</code>, optional <code>cts-inbound-consumer</code>.</li> <li>API routes on shared API (integration + route) using imported API ID.</li> <li>SQS FIFO queues subscribed to <code>events.transfers</code> (per consumer) with DLQs and alarms.</li> <li>IAM roles: scoped to publish to SNS, read SQS, connect via RDS Proxy, read secrets.</li> <li>Alarms/dashboards: p95, 5xx, queue lag, outbox failure rate, Lambda errors/throttles.</li> </ul>"},{"location":"10-payments-nucleus/infra/aws-infra/#eventing-ordering-dedupe","title":"Eventing (ordering &amp; dedupe)","text":"<ul> <li>SNS FIFO <code>events.transfers</code> with SQS FIFO subscribers per consumer.</li> <li>MessageGroupId = <code>transferId</code> (per\u2011key ordering), MessageDeduplicationId = <code>eventId</code>.</li> <li>DLQs: SQS standard per subscriber; 14d retention; runbooks for re\u2011drive.</li> </ul>"},{"location":"10-payments-nucleus/infra/aws-infra/#cdk-snippets-typescript","title":"CDK snippets (TypeScript)","text":"<p>Register a Lambda on the shared API: <pre><code>const apiId = ssm.StringParameter.valueForStringParameter(this, `/storo/${env}/api/id`);\nconst httpApi = apigwv2.HttpApi.fromHttpApiAttributes(this, 'SharedApi', { httpApiId: apiId });\nconst fn = new lambda.NodejsFunction(this, 'CtsApiFn', { vpc, vpcSubnets: { subnetType: ec2.SubnetType.PRIVATE_WITH_EGRESS },\n  environment: { RDS_PROXY_ENDPOINT: proxy.endpoint }, tracing: lambda.Tracing.ACTIVE });\nnew apigwv2i.HttpLambdaIntegration('CtsApiInt', fn);\nhttpApi.addRoutes({ path: '/transfers', methods: [apigwv2.HttpMethod.POST], integration: new apigwv2i.HttpLambdaIntegration('Int', fn) });\n</code></pre></p> <p>Subscribe SQS FIFO to SNS FIFO: <pre><code>const topicArn = ssm.StringParameter.valueForStringParameter(this, `/storo/${env}/sns/events-transfers/arn`);\nconst topic = sns.Topic.fromTopicArn(this, 'EventsTransfers', topicArn);\nconst q = new sqs.Queue(this, 'GatewayQueue', { fifo: true, contentBasedDeduplication: false });\nnew sns.Subscription(this, 'Sub', { topic, endpoint: q.queueArn, protocol: sns.SubscriptionProtocol.SQS,\n  rawMessageDelivery: true, deadLetterQueue: new sqs.Queue(this, 'DLQ') });\n</code></pre></p> <p>Outbox worker schedule: <pre><code>new events.Rule(this, 'OutboxSchedule', { schedule: events.Schedule.rate(cdk.Duration.minutes(1)),\n  targets: [new targets.LambdaFunction(outboxFn, { retryAttempts: 2 })] });\n</code></pre></p>"},{"location":"10-payments-nucleus/infra/aws-infra/#cicd-github-actions-with-oidc","title":"CI/CD (GitHub Actions with OIDC)","text":"<ul> <li>Jobs: lint/test \u2192 cdk synth \u2192 cdk diff \u2192 deploy dev \u2192 integration tests \u2192 promote stage/prod with approval.</li> <li>Migrations (Flyway/Liquibase) step runs against RDS Proxy before Lambda canary. <pre><code>permissions: { id-token: write, contents: read }\njobs:\n  deploy:\n    runs-on: ubuntu-latest\n    steps:\n      - uses: actions/checkout@v4\n      - uses: aws-actions/configure-aws-credentials@v4\n        with: { role-to-assume: arn:aws:iam::${{ secrets.AWS_ACCT }}:role/gh-oidc-cdk, aws-region: af-south-1 }\n      - run: npm ci &amp;&amp; npm run build &amp;&amp; npx cdk synth\n      - run: ./scripts/migrate.sh # runs flyway with RDS Proxy\n      - run: npx cdk deploy CtsServiceStack --require-approval never\n</code></pre></li> </ul>"},{"location":"10-payments-nucleus/infra/aws-infra/#deployment-order","title":"Deployment order","text":"<p>1) Infra repo: VPC \u2192 DB + Proxy \u2192 Eventing \u2192 API \u2192 Observability \u2192 write SSM params. 2) Service repos: migrations \u2192 Lambdas \u2192 API routes \u2192 SNS/SQS subs \u2192 alarms. 3) Canary release via CodeDeploy Lambda alias (10%/10m) \u2192 100%.</p>"},{"location":"10-payments-nucleus/infra/aws-infra/#security-cost-notes","title":"Security &amp; cost notes","text":"<ul> <li>IAM least\u2011privilege per Lambda; SGs restrict DB access to RDS Proxy.</li> <li>Secrets Manager rotation (90d); IAM auth to RDS Proxy where feasible.</li> <li>Aurora min/max ACU per env; reserved concurrency caps; long polling SQS; schedule down non\u2011prod at night.</li> </ul>"},{"location":"10-payments-nucleus/ops/closing-the-books/","title":"Closing the Books (Ops Runbook)","text":"<p>The process of finalizing accounting for a period (day, month, quarter, year). Based on accrual accounting and double-entry principles.</p>"},{"location":"10-payments-nucleus/ops/closing-the-books/#daily-tasks","title":"Daily Tasks","text":"<ol> <li>Reconciliation </li> <li>Ingest statements from rails (Zimswitch, OPPWA, Algorand).  </li> <li>Match to transfers in Stalela.  </li> <li> <p>Investigate unmatched items in Operator Console.  </p> </li> <li> <p>Ledger Validation </p> </li> <li>Run posting check: every debit has equal credit.  </li> <li> <p>Generate trial balance.  </p> </li> <li> <p>Compliance Delta Check </p> </li> <li>Re-run re-screening for entities against updated lists.  </li> </ol>"},{"location":"10-payments-nucleus/ops/closing-the-books/#monthly-period-end-tasks","title":"Monthly / Period-End Tasks","text":"<ol> <li>Income Statement </li> <li> <p>Summarize revenues (fees, FX) and expenses (processing, chargebacks).  </p> </li> <li> <p>Close Temporary Accounts </p> </li> <li>Zero out revenue and expense accounts.  </li> <li> <p>Roll net income into Current Period Net Income account.  </p> </li> <li> <p>Balance Sheet </p> </li> <li>Validate: Assets = Liabilities + Equity.  </li> <li> <p>Snapshot balances for audit/export.  </p> </li> <li> <p>Cash Flow Statement </p> </li> <li>Derive from balance changes (Liquidity movements).  </li> </ol>"},{"location":"10-payments-nucleus/ops/closing-the-books/#technical-steps","title":"Technical Steps","text":"<ol> <li>Freeze event ingestion at cutoff.  </li> <li>Run reconciliation batch job.  </li> <li>Generate trial balance \u2192 verify zero-sum.  </li> <li>Post closing entries:  </li> <li>Debit/Credit Revenue \u2192 Net Income.  </li> <li>Debit/Credit Expenses \u2192 Net Income.  </li> <li>Close Net Income \u2192 Retained Earnings.  </li> <li>Unlock event ingestion.  </li> </ol>"},{"location":"10-payments-nucleus/ops/closing-the-books/#operator-notes","title":"Operator Notes","text":"<ul> <li>If unmatched transactions remain, escalate before closing.  </li> <li>If balances don\u2019t tie (A=L+E), halt closing and investigate ledger.  </li> <li>All reports (Balance Sheet, Income Statement) are versioned and immutable.  </li> </ul>"},{"location":"10-payments-nucleus/ops/observability/","title":"Observability","text":"<p>Metrics, logs, and tracing conventions for Stalela.</p>"},{"location":"10-payments-nucleus/ops/observability/#golden-signals","title":"Golden Signals","text":"<ul> <li>Latency: API p95/p99 (CTS), event publish lag (outbox \u2192 bus), ledger posting latency.  </li> <li>Traffic: transfers/sec by rail, events/sec by topic.  </li> <li>Errors: rate by type; DLQ sizes.  </li> <li>Saturation: outbox backlog, consumer lag, DB write IOPS.  </li> </ul> <p>Telco variability: expect higher latency/timeouts during peak/maintenance windows on USSD/STK rails; adjust SLOs accordingly.</p>"},{"location":"10-payments-nucleus/ops/observability/#metrics-prometheus-names","title":"Metrics (Prometheus names)","text":"<ul> <li><code>cts_requests_total{route,code}</code> </li> <li><code>cts_request_duration_seconds_bucket{route}</code> </li> <li><code>gateway_submit_duration_seconds_bucket{rail}</code> </li> <li><code>event_outbox_backlog{service}</code> </li> <li><code>event_publish_lag_seconds{service}</code> </li> <li><code>event_consumer_lag_seconds{service,topic}</code> </li> <li><code>ledger_posting_latency_seconds_bucket</code> </li> <li><code>recon_match_rate</code> , <code>recon_unmatched_backlog</code> </li> <li><code>compliance_screen_latency_seconds_bucket</code> , <code>compliance_index_age_hours</code></li> </ul> <p>Load-shedding alerts: page on <code>event_publish_lag_seconds{service}</code> and <code>gateway_submit_duration_seconds_bucket{rail=~\"(ecocash|mtnmomo|airtelmomo)\"}</code> when exceeding thresholds during known windows.</p>"},{"location":"10-payments-nucleus/ops/observability/#logs","title":"Logs","text":"<ul> <li>JSON only.  </li> <li>Required fields: <code>ts</code>, <code>level</code>, <code>service</code>, <code>tenantId</code>, <code>transferId?</code>, <code>eventId?</code>, <code>traceId?</code>.  </li> <li>PII redaction applied before emit.</li> </ul>"},{"location":"10-payments-nucleus/ops/observability/#tracing","title":"Tracing","text":"<ul> <li>Propagate <code>traceparent</code> across services.  </li> <li>Spans: <code>cts.create</code>, <code>gateway.submit</code>, <code>ledger.post</code>, <code>recon.ingest</code>.  </li> <li>Sample rate: 10% baseline; 100% on error paths.</li> </ul>"},{"location":"10-payments-nucleus/ops/observability/#dashboards","title":"Dashboards","text":"<ul> <li>Exec: transfers by rail, approval/return rates, SLAs.  </li> <li>SRE: outbox backlogs, publish lag, consumer lag, broker health.  </li> <li>Finance/Ops: settlement totals, fees, FX P&amp;L, recon match rate.</li> </ul>"},{"location":"10-payments-nucleus/ops/regulatory/","title":"Regulatory Ops (STR/CTR, BoP)","text":"<p>Operational procedures for regulatory submissions in ZA/ZW.</p>"},{"location":"10-payments-nucleus/ops/regulatory/#pipelines","title":"Pipelines","text":"<ul> <li>BoP: aggregate cross-border events \u2192 build payload \u2192 submit \u2192 store receipt.</li> <li>goAML: detect triggers \u2192 generate STR/CTR \u2192 submit \u2192 track status.</li> </ul>"},{"location":"10-payments-nucleus/ops/regulatory/#runbooks","title":"Runbooks","text":"<ul> <li>Submission failures: retry policy, contact points, escalation matrix.</li> <li>Corrections: T+1 resubmission with reference to prior filing.</li> <li>DSAR/POPIA: ensure redactions and legal holds before export.</li> </ul>"},{"location":"10-payments-nucleus/ops/regulatory/#observability","title":"Observability","text":"<ul> <li>Metrics: submissions/day, failure rate, mean time to receipt.</li> <li>Dashboards: pipeline health, backlog, DLQ.</li> </ul> <p>Last updated: 2025-08-27</p>"},{"location":"10-payments-nucleus/ops/runbooks/","title":"Runbooks","text":"<p>Operational procedures for Stalela nucleus components. Keep these pragmatic and up to date.</p>"},{"location":"10-payments-nucleus/ops/runbooks/#transfers-stuck-in-submitted","title":"Transfers stuck in SUBMITTED","text":"<p>Symptoms - Many transfers in <code>SUBMITTED</code> for &gt; X minutes. - Gateways show growing outbox backlog.</p> <p>Checks 1. Gateway <code>/ready</code> and <code>/metrics</code> for the affected rail. 2. Event bus health; consumer lag. 3. Directory lookup SLOs (routing latency spikes?).  </p> <p>Actions - Restart gateway dispatcher if wedged. - Drain DLQ after verifying poison messages are quarantined. - Temporarily throttle creation rate from CTS for the tenant with spikes. - Archive any DLQ extracts to object storage (7-year retention) before purging queue entries (14-day in-queue policy).</p> <p>Postmortem notes - Attach event IDs and sample transferIds. - Record root cause and prevention (ADR if architectural).</p>"},{"location":"10-payments-nucleus/ops/runbooks/#reconciliation-unmatched-backlog","title":"Reconciliation unmatched backlog","text":"<p>Symptoms - <code>recon.exception.opened</code> spiking, queue &gt; SLA.  </p> <p>Checks 1. Statement ingest success rate and file checksums. 2. Directory fee tables / windows version drift. 3. Key mapping (acqRef/authCode/externalRef) consistency.  </p> <p>Actions - Assign operators to bulk-assign obvious matches. - Re-run ingest from last checkpoint if normalization bug found. - File partner ticket if delivery gaps observed.  </p>"},{"location":"10-payments-nucleus/ops/runbooks/#compliance-stale-index","title":"Compliance stale index","text":"<p>Symptoms - Alert: compliance list age &gt; 24h.  </p> <p>Checks 1. Downloader logs (network, checksum mismatch). 2. Disk space / blob store quota.  </p> <p>Actions - Trigger manual list refresh. - Roll back to last good index if corruption detected. - If still failing, force CTS to deny by policy until lists are healthy.  </p>"},{"location":"10-payments-nucleus/ops/runbooks/#ledger-posting-failures","title":"Ledger posting failures","text":"<p>Symptoms - <code>currency mismatch</code> or <code>negative balance blocked</code>.  </p> <p>Checks 1. Posting rules version and inputs from event. 2. Account config (currency, status).  </p> <p>Actions - Open exception, block further postings for the tenant if systemic. - Patch rules (PR) and replay events.  </p>"},{"location":"10-payments-nucleus/ops/runbooks/#event-bus-backlog","title":"Event bus backlog","text":"<p>Symptoms - High outbox backlog, consumer lag.  </p> <p>Checks 1. Bus broker health, partition leaders. 2. Dispatcher logs for auth / throttling errors.  </p> <p>Actions - Scale consumers horizontally. - Increase partitions if saturated. - Enable backpressure on producers (CTS) temporarily. - If manual re-drive required, obtain dual approval and attach signed reason to the ticket before replaying messages.</p>"},{"location":"10-payments-nucleus/ops/runbooks/#load-shedding-resilience-za","title":"Load-shedding resilience (ZA)","text":"<p>Symptoms - Increased timeouts/latency during scheduled power cuts; spikes in retries/DLQ.  </p> <p>Checks 1. Gateway submit/confirm latency; retry counters. 2. Outbox backlog and consumer lag around shedding windows. 3. Infrastructure node availability in affected regions.  </p> <p>Actions - Increase backoff and retry windows temporarily; enable circuit breakers. - Prefer idempotent replays after power restoration. - Throttle CTS create rate for impacted tenants. - Schedule maintenance/ingests away from shedding windows.  </p> <p>Alerts - Alert on publish lag, retry spikes, and failure-rate thresholds during known windows.  </p>"},{"location":"10-payments-nucleus/ops/runbooks/#popia-dsar-data-subject-accesserasure","title":"POPIA DSAR (Data Subject Access/Erasure)","text":"<p>Scope - Handle access/correction/erasure requests while honoring legal holds and retention.</p> <p>Steps 1. Verify requestor identity and authority. 2. Locate records across services (CTS, Ledger, Compliance, Recon, blobs). 3. Produce access report with redactions; log disclosure. 4. For erasure: apply anonymization where permitted; record legal holds where applicable. 5. Update DSAR register with timestamps and outcome.  </p> <p>Controls - Do not delete immutable audit/journal data; apply irreversible hashing where allowed. - Approval workflow for erasure.</p>"},{"location":"10-payments-nucleus/ops/security/","title":"Security","text":"<p>Standards for secrets, access, PCI scope, and PII handling in Stalela.</p>"},{"location":"10-payments-nucleus/ops/security/#secrets-management","title":"Secrets Management","text":"<ul> <li>Stored in a centralized vault (e.g., HashiCorp Vault).  </li> <li>Rotated at least every 90 days; immediate rotation on incident.  </li> <li>No secrets in environment variables for long-lived services without vault agent.  </li> </ul>"},{"location":"10-payments-nucleus/ops/security/#access-control","title":"Access Control","text":"<ul> <li>Service-to-service auth via mTLS or mesh-issued JWT.  </li> <li>RBAC for Operator Console (OPS, COMPLIANCE, ADMIN).  </li> <li>Principle of least privilege to DBs and blob stores.</li> </ul>"},{"location":"10-payments-nucleus/ops/security/#pci-pan-scope","title":"PCI &amp; PAN Scope","text":"<ul> <li>Card data handled exclusively in OPPWA/Zimswitch gateway.  </li> <li>PAN/token never flows into CTS or Ledger.  </li> <li>Webhook/file artifacts are redacted and encrypted.</li> </ul>"},{"location":"10-payments-nucleus/ops/security/#pci-saq-tokenization-in-region","title":"PCI SAQ &amp; Tokenization (in-region)","text":"<ul> <li>Prefer network tokenization or vetted token vaults; avoid PAN handling outside gateways.  </li> <li>Scope reduction: isolate gateways; segment networks; harden endpoints.  </li> <li>Complete appropriate SAQ (likely SAQ D for service providers) with compensating controls documented.  </li> </ul>"},{"location":"10-payments-nucleus/ops/security/#pii-handling","title":"PII Handling","text":"<ul> <li>Encrypt at rest; redact in logs and events.  </li> <li>Minimize in DBs; store raw artifacts in encrypted blob store.  </li> <li>Data retention per <code>20-specs/data-retention-pii.md</code>.</li> </ul>"},{"location":"10-payments-nucleus/ops/security/#popia-south-africa","title":"POPIA (South Africa)","text":"<ul> <li>Lawful basis: document processing purposes per flow (screening, settlement, reporting).  </li> <li>Cross-border transfers: assess adequate protection or implement contractual safeguards; record in audits.  </li> <li>Data subject rights: verify identity; fulfill access/correction/erasure subject to legal holds.  </li> <li>Privacy by design: DPIA for new rails; minimize PII in events; default encryption.</li> </ul>"},{"location":"10-payments-nucleus/ops/security/#licensing-scheme-participation-zazw","title":"Licensing &amp; Scheme Participation (ZA/ZW)","text":"<ul> <li>Role options: PSP, System Operator, or via sponsor bank; document per environment.  </li> <li>PASA participation: outline sponsor relationships, limits, and responsibilities.  </li> <li>Operational controls: incident management, segregation of duties, change management.</li> </ul>"},{"location":"10-payments-nucleus/ops/security/#secure-coding","title":"Secure Coding","text":"<ul> <li>Input validation at boundaries; strict schema checks.  </li> <li>Dependency scanning and SAST/DAST in CI.  </li> <li>Security headers on all admin endpoints.</li> </ul>"},{"location":"10-payments-nucleus/ops/security/#incident-response","title":"Incident Response","text":"<ul> <li>24/7 on-call rotation; breach protocol documented.  </li> <li>Forensics: immutable logs and event store.  </li> <li>Post-incident ADR if architectural changes required.</li> </ul>"},{"location":"10-payments-nucleus/overview/","title":"Stalela Documentation","text":"<p>Welcome to the Stalela Docs \u2014 the single source of truth for how the Stalela payments nucleus is designed, built, and operated.</p>"},{"location":"10-payments-nucleus/overview/#what-this-provides","title":"\ud83c\udf0d What this provides?","text":"<p>Stalela provides a payments nucleus for the Southern Africa \u2194 global corridor. It provides:</p> <ul> <li>Unified API for payments, payouts, and transfers.</li> <li>Ledger for strict double-entry accounting and balance tracking.</li> <li>Router that connects to multiple rails (USDC on Avax/Algorand, Zimswitch/OPPWA, mobile money, EFT).</li> <li>Compliance and reconciliation as first-class components, not afterthoughts.</li> </ul> <p>Think of it as the boring but unbreakable center of our payment universe.</p>"},{"location":"10-payments-nucleus/overview/#whats-in-this-documentation","title":"\ud83e\udde9 What\u2019s in this Documentation?","text":"<p>This docs repo is organized into clear layers:</p>"},{"location":"10-payments-nucleus/overview/#1-overview-you-are-here","title":"1. Overview (you are here)","text":"<ul> <li><code>index.md</code> \u2192 This page: big-picture introduction, how to use the docs.</li> <li><code>nucleus.md</code> \u2192 Detailed description of the Stalela nucleus (all components together).</li> <li><code>glossary.md</code> \u2192 Domain terms (rails, ledger, reconciliation, returns, etc.).</li> <li><code>architecture-decisions/</code> \u2192 ADRs (Architecture Decision Records) documenting why we made key choices.</li> </ul>"},{"location":"10-payments-nucleus/overview/#2-components","title":"2. Components","text":"<p>Each nucleus component has its own page: - Canonical Transfer Service (CTS) - Rail Gateways (Zimswitch, OPPWA, USDC/Algorand) - Ledger Service - Compliance Screening - Directory &amp; Routing - Reconciliation &amp; Returns - Event Bus + Outbox - Platform/Base - Operator Console</p> <p>Each page explains Purpose \u2192 Responsibilities \u2192 Interfaces \u2192 Data \u2192 Diagrams \u2192 Failure Modes \u2192 Ops.</p>"},{"location":"10-payments-nucleus/overview/#3-specs","title":"3. Specs","text":"<ul> <li>Event envelope &amp; catalog</li> <li>Canonical Transfer API schema (<code>POST /transfers</code>)</li> <li>Posting rules (event \u2192 debit/credit accounts)</li> <li>Data retention &amp; PII handling</li> </ul>"},{"location":"10-payments-nucleus/overview/#4-diagrams","title":"4. Diagrams","text":"<ul> <li>Component diagram of the nucleus</li> <li>Transfer lifecycle state machine</li> <li>Sequence diagrams for common flows (e.g. USDC payment, OPPWA return, reconciliation match)</li> </ul>"},{"location":"10-payments-nucleus/overview/#5-ops","title":"5. Ops","text":"<ul> <li>Runbooks (returns, reconciliation triage, compliance freeze/unfreeze)</li> <li>Observability (metrics, dashboards, logs, SLOs)</li> <li>Security (secrets, IAM, PII redaction)</li> </ul>"},{"location":"10-payments-nucleus/overview/#6-templates","title":"6. Templates","text":"<p>Reusable templates for: - New component docs - Sequence diagrams - State diagrams - ADRs</p>"},{"location":"10-payments-nucleus/overview/#how-to-read-this-repo","title":"\ud83d\udcd6 How to Read this Repo","text":"<ul> <li>If you\u2019re an engineer \u2192 dive into <code>10-components/</code> and <code>20-specs/</code>.  </li> <li>If you\u2019re an operator \u2192 check <code>40-ops/runbooks.md</code>.  </li> <li>If you\u2019re reviewing a design decision \u2192 see <code>00-overview/architecture-decisions/</code>.</li> </ul>"},{"location":"10-payments-nucleus/overview/#diagram-standards","title":"\ud83d\udcd0 Diagram Standards","text":"<p>We use Mermaid diagrams in Markdown. GitHub renders them directly; you can also export with <code>@mermaid-js/mermaid-cli</code>.</p> <ul> <li>Component diagrams \u2192 boxes + arrows (what services exist, how they talk).  </li> <li>State diagrams \u2192 transfer lifecycle (INITIATED \u2192 SETTLED \u2192 RETURNED).  </li> <li>Sequence diagrams \u2192 end-to-end message flows (client \u2192 CTS \u2192 rail gateway \u2192 ledger).  </li> </ul> <p>Example:</p> <p>```mermaid flowchart LR   Client --&gt; CTS[Canonical Transfer Service]   CTS --&gt; GW[Rail Gateway]   GW --&gt; EB[(Event Bus)]   EB --&gt; L[Ledger]</p>"},{"location":"10-payments-nucleus/overview/dev-workflow/","title":"Development Workflow","text":"<p>This document sets conventions for how we develop, review, and deploy Stalela nucleus code.</p>"},{"location":"10-payments-nucleus/overview/dev-workflow/#branching","title":"\ud83d\udd00 Branching","text":"<ul> <li>Main branch = always deployable.</li> <li>Feature branches \u2192 PR \u2192 merge to main (require review).</li> <li>Hotfix branches allowed only with approval.</li> </ul>"},{"location":"10-payments-nucleus/overview/dev-workflow/#code-reviews","title":"\ud83d\udcdd Code Reviews","text":"<ul> <li>Minimum 1 reviewer for all PRs.</li> <li>Use ADRs for architectural changes.</li> <li>Must include tests for all new code.</li> </ul>"},{"location":"10-payments-nucleus/overview/dev-workflow/#testing-levels","title":"\u2705 Testing Levels","text":"<ul> <li>Unit tests with golden fixtures (esp. rail adapters).</li> <li>Integration tests with mocks/stubs.</li> <li>End-to-end tests with sandbox rails (EcoCash, OPPWA, USDC).</li> </ul>"},{"location":"10-payments-nucleus/overview/dev-workflow/#cicd","title":"\ud83c\udfd7 CI/CD","text":"<ul> <li>GitHub Actions pipeline:</li> <li>Build \u2192 Lint \u2192 Test \u2192 Dockerize \u2192 Deploy (staging).</li> <li>Staging deploys automatically.</li> <li>Production deploys require approval.</li> </ul>"},{"location":"10-payments-nucleus/overview/dev-workflow/#docs-adrs","title":"\ud83d\udccc Docs &amp; ADRs","text":"<ul> <li>Every new service/component must include a <code>docs/10-components/&lt;name&gt;.md</code>.</li> <li>Significant design changes must log an ADR under <code>00-overview/architecture-decisions/</code>.</li> </ul>"},{"location":"10-payments-nucleus/overview/dev-workflow/#secrets-security","title":"\ud83d\udd10 Secrets &amp; Security","text":"<ul> <li>No secrets in repo.</li> <li>All secrets via Vault or AWS SSM.</li> </ul>"},{"location":"10-payments-nucleus/overview/glossary/","title":"Glossary","text":"<p>Shared domain language for Stalela. Sources include our design docs and Moov.io\u2019s terms-dictionary. This file should be the first stop for new contributors.</p>"},{"location":"10-payments-nucleus/overview/glossary/#a","title":"A","text":"<p>ACH Automated Clearing House. Batch-based payment network in the U.S. Not directly used in Stalela, but referenced via Moov patterns.</p> <p>Account A ledger entity that holds balances and records postings. Types include: User, Merchant, Liquidity, Fees, FX, Settlement.</p> <p>AI Routing AI-enhanced orchestration capability that ranks and selects rails in real time using policy weights, historical performance, cost, and risk context.</p> <p>ADR (Architecture Decision Record) Lightweight doc capturing a key architectural choice, its context, decision, and consequences.</p> <p>Authorization (AUTH) A request to place a hold on funds. In Stalela, represented in the canonical transfer intent.</p>"},{"location":"10-payments-nucleus/overview/glossary/#b","title":"B","text":"<p>BAI2 Bank Administration Institute format for statement files. Used by Moov and referenced as a model for Stalela\u2019s reconciliation exports.</p> <p>Balance The net amount for an account at a given time, derived from postings.</p> <p>BIN (Bank Identification Number) The first digits of a card number, identifying the issuer. Stored in the Directory service.</p> <p>Bus (Event Bus) Pub/sub system (SNS+SQS in dev) delivering domain events between services.</p>"},{"location":"10-payments-nucleus/overview/glossary/#c","title":"C","text":"<p>Canonical Transfer Service (CTS) Front-door API and orchestrator for transfers in Stalela. Ensures idempotency, normalization, compliance, and routing.</p> <p>Chargeback / Return Reversal of a prior settlement, with reason codes. Modeled as state transitions in CTS and reversal postings in the Ledger.</p> <p>Compliance Screening Process of checking payer/payee against watchlists (OFAC, UN, EU, SA FIC). Implemented as a local fast index.</p> <p>Cutoff Time of day after which payments are queued for next business day. Defined in Directory service.</p>"},{"location":"10-payments-nucleus/overview/glossary/#d","title":"D","text":"<p>Directory Service Component maintaining authoritative data on institutions, BINs, fees, and settlement windows.</p> <p>Double-entry Accounting principle: every debit has an equal credit. Enforced in Stalela Ledger.</p> <p>DLQ (Dead Letter Queue) Queue for events that failed processing and need operator intervention.</p>"},{"location":"10-payments-nucleus/overview/glossary/#e","title":"E","text":"<p>Event Immutable record emitted by a service (e.g., <code>transfers.settled</code>). Structured by the event envelope spec.</p> <p>Event Envelope Standard wrapper for all events: <code>{ eventId, type, occurredAt, transferId, tenantId, payload }</code>.</p> <p>External Reference Rail- or partner-provided identifier (e.g., auth code, transaction ref). Stored in transfers table.</p>"},{"location":"10-payments-nucleus/overview/glossary/#f","title":"F","text":"<p>FBO (For Benefit Of) Banking account structure where a custodian holds funds for multiple end-users. Modeled in Ledger accounts.</p> <p>Fixture (Golden Test) Sample payload used in tests to ensure round-trip parsing and validation stability.</p>"},{"location":"10-payments-nucleus/overview/glossary/#g","title":"G","text":"<p>Gateway Adapter for a payment rail (Zimswitch, OPPWA, USDC/Algorand). Translates canonical transfers into rail-specific requests.</p> <p>GL (General Ledger) The book of record. Stalela Ledger service maintains the general ledger.</p> <p>Glossary This file. Shared terms and definitions.</p>"},{"location":"10-payments-nucleus/overview/glossary/#i","title":"I","text":"<p>Idempotency Ensuring a request (e.g., <code>POST /transfers</code>) can be safely retried without duplication.</p> <p>ISO 8583 International standard for card payment messages. Zimswitch uses this; Stalela validates payloads via strict schemas.</p> <p>ISO 20022 XML/JSON standard for financial messaging. Referenced for future-proofing rails.</p>"},{"location":"10-payments-nucleus/overview/glossary/#l","title":"L","text":"<p>Ledger The authoritative record of postings, balances, and statements. Event-driven, double-entry, append-only.</p> <p>Lifecycle (Transfer) State machine: INITIATED \u2192 SUBMITTED \u2192 ACCEPTED \u2192 SETTLED \u2192 (RETURNED | FAILED).</p> <p>Liquidity Account Special ledger account representing pooled liquidity held for customer settlements.</p>"},{"location":"10-payments-nucleus/overview/glossary/#o","title":"O","text":"<p>Observability The ability to measure, trace, and debug system behavior via metrics, logs, and tracing.</p> <p>OFAC Office of Foreign Assets Control. U.S. sanctions list. Indexed locally alongside UN/EU/SA lists.</p> <p>Operator Console Internal UI for handling returns, recon exceptions, and compliance flags.</p>"},{"location":"10-payments-nucleus/overview/glossary/#p","title":"P","text":"<p>PII (Personally Identifiable Information) Sensitive data (names, IDs, PANs). Must be encrypted, redacted in logs, and retained per policy.</p> <p>Posting Atomic debit/credit entry in the ledger. Immutable, append-only.</p> <p>Posting Rules Mapping from transfer events to specific ledger postings (accounts, amounts, memos).</p>"},{"location":"10-payments-nucleus/overview/glossary/#r","title":"R","text":"<p>Rail A payment network (e.g., Zimswitch, OPPWA, Algorand/USDC).</p> <p>Risk Agents AI services embedded in CTS orchestration that evaluate fraud and identity signals to assign compliance tiers and trigger adaptive controls.</p> <p>Reconciliation Process of matching partner statements or on-chain events with internal transfers. Runs nightly.</p> <p>Return Negative state transition; undo of a prior settlement with reason codes.</p>"},{"location":"10-payments-nucleus/overview/glossary/#s","title":"S","text":"<p>Settlement Final movement of funds on a rail. In Stalela, confirmed by events and reconciled against statements.</p> <p>Specs Repo Dedicated repo holding event schemas, API definitions, and fixtures (<code>storo-specs</code>). Source of truth for contracts.</p> <p>State Diagram Visual representation of lifecycle states and transitions (Mermaid).</p>"},{"location":"10-payments-nucleus/overview/glossary/#t","title":"T","text":"<p>Tenant Isolated namespace for a customer/institution using Stalela. All transfers are scoped by tenantId.</p> <p>Trace ID Identifier used for distributed tracing across services.</p> <p>Transfer Core unit of money movement in Stalela, defined by canonical schema (payer, payee, amount, rail, intent, etc.).</p>"},{"location":"10-payments-nucleus/overview/glossary/#w","title":"W","text":"<p>Watchlist Sanctions/risk list (OFAC, UN, EU, SA FIC). Ingested and indexed locally for compliance screening.</p> <p>This glossary evolves with the system. Always update it alongside specs and ADRs.</p>"},{"location":"10-payments-nucleus/overview/nfrs/","title":"Non-Functional Requirements (NFRs)","text":"<p>This document captures the performance, availability, security, and compliance targets for the Stalela nucleus.</p>"},{"location":"10-payments-nucleus/overview/nfrs/#availability","title":"\ud83c\udfaf Availability","text":"<ul> <li>Target uptime: 99.9% minimum (3-nines) during MVP.</li> <li>Long-term target: 99.99% for core services (Canonical Transfer Service, Ledger, Event Bus).</li> </ul>"},{"location":"10-payments-nucleus/overview/nfrs/#performance","title":"\u26a1 Performance","text":"<ul> <li>API latency (P99):</li> <li>POST /transfers: \u2264 250 ms (excluding external rail).</li> <li>Balance queries: \u2264 100 ms.</li> <li>Event bus publish lag (P99): \u2264 1 s.</li> <li>Ledger posting confirmation: \u2264 1 s after settlement.</li> </ul>"},{"location":"10-payments-nucleus/overview/nfrs/#throughput","title":"\ud83d\udcca Throughput","text":"<ul> <li>MVP scale: 50 TPS sustained.</li> <li>Scale target (2 years): 500 TPS sustained.</li> </ul>"},{"location":"10-payments-nucleus/overview/nfrs/#security","title":"\ud83d\udd10 Security","text":"<ul> <li>Mutual TLS between services.</li> <li>Tenant API keys or JWT for client APIs.</li> <li>PII encrypted at rest, redacted in logs.</li> <li>Secrets rotation: 90 days.</li> </ul>"},{"location":"10-payments-nucleus/overview/nfrs/#compliance","title":"\ud83e\uddfe Compliance","text":"<ul> <li>Audit logs immutable and retained 7 years.</li> <li>Data residency: all primary storage in-region (SA/ZW).</li> <li>Screening latency: \u2264 500 ms pre-submit.</li> </ul>"},{"location":"10-payments-nucleus/overview/nfrs/#notes","title":"\ud83d\udccc Notes","text":"<p>This document will evolve with load tests, audits, and regulatory requirements.</p>"},{"location":"10-payments-nucleus/overview/nucleus/","title":"Stalela Nucleus","text":"<p>The Stalela nucleus is the boring, strict, event-driven core of the platform. It orchestrates all money movement across rails (USDC/Algorand, Zimswitch/OPPWA, EFT, mobile money) while enforcing compliance, ledger discipline, and reconciliation.</p>"},{"location":"10-payments-nucleus/overview/nucleus/#purpose","title":"\ud83c\udfaf Purpose","text":"<p>The nucleus exists to: - Provide a single canonical model for all transfers. - Keep rail-specific logic isolated in gateways. - Guarantee double-entry correctness via the ledger. - Ensure compliance and reconciliation are first-class, not bolted on. - Emit domain events so every change is observable and auditable.  </p>"},{"location":"10-payments-nucleus/overview/nucleus/#components-at-a-glance","title":"\ud83e\udde9 Components at a Glance","text":"<ul> <li>Canonical Transfer Service (CTS) \u2192 orchestrates transfer lifecycle, idempotency, emits events.  </li> <li>Rail Gateways \u2192 adapters for each rail, strict spec validation, submit &amp; emit rail outcomes.  </li> <li>Ledger Service \u2192 double-entry postings, balances, statements.  </li> <li>Compliance Screening \u2192 fast local allow/deny; pre-submit &amp; delta re-screens.  </li> <li>Directory &amp; Routing \u2192 institutions, BINs, fees, settlement windows.  </li> <li>Reconciliation &amp; Returns \u2192 ingest statements, match transfers, manage returns/exceptions.  </li> <li>Event Bus + Outbox \u2192 exactly-once event delivery; glue between services.  </li> <li>Platform/Base \u2192 shared utilities (admin, time, IDs, error handling, migrations).  </li> <li>Operator Console \u2192 human control surface for exceptions, flags, returns.  </li> </ul>"},{"location":"10-payments-nucleus/overview/nucleus/#component-diagram","title":"\ud83c\udfd7\ufe0f Component Diagram","text":"<pre><code>flowchart LR\n  subgraph Client/Partners\n    A[Client Apps / Merchants / WhatsApp Bot]\n  end\n\n  subgraph Core[\"Stalela Nucleus\"]\n    direction LR\n\n    subgraph API[\"Canonical Transfer Service (API)\"]\n      CTS[POST /transfers&lt;br/&gt;GET /transfers/:id&lt;br/&gt;Idempotency]\n    end\n\n    subgraph GW[\"Rail Gateways\"]\n      ZG[Zimswitch Gateway]\n      OG[OPPWA Gateway]\n      UG[USDC/Algorand Gateway]\n    end\n\n    subgraph L[\"Ledger Service\"]\n      LJ[Journal &amp; Postings]\n      LB[Balances &amp; Statements]\n    end\n\n    subgraph C[\"Compliance Screening\"]\n      CS[Local Watchlist Index&lt;br/&gt;/screen]\n    end\n\n    subgraph D[\"Directory &amp; Routing\"]\n      DR[Institutions/BINs&lt;br/&gt;Fees &amp; Windows]\n    end\n\n    subgraph R[\"Reconciliation &amp; Returns\"]\n      RC[Statement Ingest&lt;br/&gt;Unmatched Queue]\n    end\n\n    subgraph B[\"Event Bus + Outbox\"]\n      EB[(Topics: transfers.*, ledger.*, recon.*)]\n    end\n\n    subgraph O[\"Operator Console\"]\n      OC[Ops UI&lt;br/&gt;Returns/Recon/Flags]\n    end\n\n    subgraph PL[\"Platform/Base\"]\n      AD[/ /live /ready /metrics /version /]\n      TM[Banking Time &amp; Holidays]\n      IDG[ID/Tracing &amp; Errors]\n    end\n  end\n\n  A --&gt;|create intent| CTS\n  CTS --&gt;|pre-screen| CS\n  CS --&gt;|allow/deny| CTS\n  CTS --&gt;|route| D\n  D --&gt; CTS\n  CTS --&gt;|submit| ZG\n  CTS --&gt;|submit| OG\n  CTS --&gt;|submit| UG\n\n  ZG --&gt; EB\n  OG --&gt; EB\n  UG --&gt; EB\n\n  EB --&gt; CTS\n  EB --&gt; L\n  EB --&gt; R\n  EB --&gt; O\n\n  L &lt;--&gt; R\n  R --&gt;|nightly ingest| EB\n\n  OC --- O\n  PL --- CTS\n  PL --- GW\n  PL --- L\n  PL --- C\n  PL --- D\n  PL --- R</code></pre>"},{"location":"10-payments-nucleus/overview/nucleus/#ai-enhanced-orchestration-layer","title":"AI-Enhanced Orchestration Layer","text":"<p>The Nucleus architecture now includes a dynamic orchestration layer that leverages AI agents to optimize transaction flows in real time.</p> <p>This layer works alongside our existing Directory, Routing, and Compliance modules \u2014 not as replacements, but as intelligent decision advisors that enhance behavior based on transaction context, user risk, and infrastructure state.</p>"},{"location":"10-payments-nucleus/overview/nucleus/#capabilities-introduced","title":"Capabilities Introduced","text":"<ul> <li>Smart Rail Selector Agent \u2014 ranks and selects the optimal route across mobile money, bank, card, voucher, or crypto, based on historical performance, cost, latency, and user profile.</li> <li>Dynamic Risk Classifier \u2014 applies real-time fraud and identity risk scoring to determine appropriate compliance tiering.</li> <li>Rail Health Monitor Agent \u2014 observes system-wide metrics (e.g., failure rate, latency, uptime) and dynamically adjusts available routing paths.</li> <li>Orchestration Copilot \u2014 exposes orchestration decisions and performance to devs and operators via CLI or natural language assistant.</li> </ul>"},{"location":"10-payments-nucleus/overview/nucleus/#architectural-changes","title":"Architectural Changes","text":"<pre><code>flowchart LR\n    App[Client App] --&gt; CTS\n    CTS --&gt; AI_Route[Smart Rail Selector Agent]\n    AI_Route --&gt; Directory\n    Directory --&gt; Routing\n    Routing --&gt; Events\n    Events --&gt; Rail\n    Compliance --&gt; AI_Risk[Risk Classifier]\n    Events --&gt; AI_Health[Health Monitor]</code></pre> <p>Each AI agent is stateless, invoked via microservice or function call, and emits traceable events like:</p> <ul> <li><code>route.selected.via_ai</code></li> <li><code>risk.assessed.via_model</code></li> <li><code>rail.flagged.degraded</code></li> </ul>"},{"location":"10-payments-nucleus/overview/nucleus/#transfer-lifecycle-state-machine","title":"\ud83d\udd04 Transfer Lifecycle (State Machine)","text":"<pre><code>stateDiagram-v2\n  [*] --&gt; INITIATED\n  INITIATED --&gt; SUBMITTED: CTS submits.&lt;rail&gt;\n  SUBMITTED --&gt; ACCEPTED: rail reference received\n  ACCEPTED --&gt; SETTLED: funds final\n  ACCEPTED --&gt; RETURNED: return/chargeback code\n  SUBMITTED --&gt; FAILED: technical failure\n  SETTLED --&gt; [*]\n  RETURNED --&gt; [*]\n  FAILED --&gt; [*]</code></pre>"},{"location":"10-payments-nucleus/overview/nucleus/#event-model","title":"\ud83d\udce1 Event Model","text":"<p>The nucleus continues to emit canonical events for lifecycle transitions, ledger postings, and reconciliation outcomes. With the AI-enhanced orchestration layer, additional signals improve observability, feedback loops, and operator insight.</p>"},{"location":"10-payments-nucleus/overview/nucleus/#new-events","title":"New Events","text":"Event Name Payload Triggered By <code>route.selected.via_ai</code> {path, score, features used} Smart Rail Selector Agent <code>risk.tier.assigned</code> {user_id, risk_score, compliance_level} Dynamic Risk Classifier <code>rail.flagged.degraded</code> {rail_id, health_metrics, timestamp} Rail Health Monitor Agent <code>orchestration.fallback.used</code> {original_path, fallback_path, reason} CTS fallback handler <p>These events land on the existing bus and follow the same envelope structure and retention policies as the rest of the domain model. They provide downstream services and operators with the rationale behind AI-guided actions, enabling rapid tuning, auditing, and simulation.</p>"},{"location":"10-payments-nucleus/overview/nucleus/#contracts","title":"\ud83d\udcdc Contracts","text":""},{"location":"10-payments-nucleus/overview/nucleus/#event-envelope","title":"Event Envelope","text":"<pre><code>{\n  \"eventId\": \"uuid\",\n  \"type\": \"transfers.settled\",\n  \"occurredAt\": \"2025-08-26T10:15:01Z\",\n  \"transferId\": \"tr_12345\",\n  \"tenantId\": \"tn_67890\",\n  \"payload\": { \"amount\": { \"value\": 100, \"currency\": \"ZAR\" }, \"rail\": \"zimswitch\" }\n}\n</code></pre>"},{"location":"10-payments-nucleus/overview/nucleus/#canonical-transfer","title":"Canonical Transfer","text":"<pre><code>{\n  \"transferId\": \"tr_12345\",\n  \"tenantId\": \"tn_67890\",\n  \"payer\": { \"accountId\": \"acct_001\" },\n  \"payee\": { \"accountId\": \"acct_999\" },\n  \"amount\": { \"value\": 1000, \"currency\": \"USD\" },\n  \"rail\": \"usdc-algo\",\n  \"intent\": \"PUSH\",\n  \"externalRef\": \"ext_abc123\",\n  \"metadata\": { \"invoiceId\": \"inv_555\" },\n  \"state\": \"SUBMITTED\"\n}\n</code></pre>"},{"location":"10-payments-nucleus/overview/nucleus/#posting","title":"Posting","text":"<pre><code>{\n  \"postingId\": \"pst_001\",\n  \"transferId\": \"tr_12345\",\n  \"debitAccountId\": \"acct_001\",\n  \"creditAccountId\": \"acct_999\",\n  \"amount\": { \"value\": 1000, \"currency\": \"USD\" },\n  \"memo\": \"Payment settlement\",\n  \"occurredAt\": \"2025-08-26T10:15:01Z\"\n}\n</code></pre>"},{"location":"10-payments-nucleus/overview/nucleus/#non-negotiables","title":"\u2705 Non-Negotiables","text":"<ul> <li>Strict validation at rail gateways (no malformed messages pass).  </li> <li>Exactly-once events (via outbox + idempotent consumers).  </li> <li>Double-entry always balanced.  </li> <li>Compliance pre-screen mandatory before submission.  </li> <li>Reconciliation nightly, exceptions reviewed before books close.  </li> <li>Operator console required for human resolution.  </li> </ul>"},{"location":"10-payments-nucleus/overview/nucleus/#slos","title":"\ud83d\udcc8 SLOs","text":"<ul> <li>API latency (P99, <code>POST /transfers</code>): \u2264 250 ms (excluding rail response).  </li> <li>Event publish lag (P99): \u2264 1 s.  </li> <li>Ledger posting latency (P99): \u2264 1 s after <code>settled</code>.  </li> <li>Reconciliation match rate: \u2265 99.8% same day, 100% by T+1.  </li> <li>Idempotency collision rate: 0%.  </li> </ul> <p>Next step: See ../components/canonical-transfer-service.md for detailed pages on each service.</p>"},{"location":"10-payments-nucleus/overview/risks-open-questions/","title":"Risks &amp; Open Questions","text":"<p>This is a living list of risks and unknowns that need clarity.</p>"},{"location":"10-payments-nucleus/overview/risks-open-questions/#open-questions","title":"\u2753 Open Questions","text":"<ul> <li>Settlement liquidity ownership: who pre-funds? merchant vs Stalela vs bank?</li> <li>How to handle returns when rail semantics don\u2019t map 1:1?</li> <li>Which rails are priority for MVP (EcoCash, USDC, OPPWA)?</li> <li>Is PayShap integration required in Phase 1?</li> </ul>"},{"location":"10-payments-nucleus/overview/risks-open-questions/#risks","title":"\u26a0\ufe0f Risks","text":"<ul> <li>Regulatory approvals may delay go-live (cross-border, FIC).</li> <li>Rail instability: EcoCash APIs historically unreliable.</li> <li>Telco politics: MNOs may resist third-party integrations.</li> <li>Crypto volatility: reliance on USDC requires hedging &amp; liquidity planning.</li> <li>Fraud risk: high potential for SIM swaps and social engineering.</li> </ul>"},{"location":"10-payments-nucleus/overview/risks-open-questions/#mitigation-ideas","title":"\ud83d\udccc Mitigation Ideas","text":"<ul> <li>Start with rails we fully control (USDC).</li> <li>Build compliance and audit hooks early.</li> <li>Work with AfricaNenda/Mojaloop for regulatory credibility.</li> </ul>"},{"location":"10-payments-nucleus/overview/stalela-vs-mojaloop/","title":"Stalela Nucleus vs Mojaloop Hub - Visual Contrast","text":"<p>This note shows how Stalela is inspired by Mojaloop while keeping a modular, rail-agnostic nucleus. Two diagrams: 1) Component landscape comparison 2) Transaction flow (Request-to-Pay) mapped to each architecture</p>"},{"location":"10-payments-nucleus/overview/stalela-vs-mojaloop/#1-component-landscape","title":"1) Component Landscape","text":"<pre><code>flowchart LR\n  subgraph S[\"Stalela Nucleus (Modular, Rail-Agnostic)\"]\n    direction LR\n    S1[\"CTS (Canonical Transfer Service)\"]\n    S2[\"Rail Gateways (EcoCash/PayShap/OPPWA/USDC)\"]\n    S3[\"Ledger Service (Double-Entry)\"]\n    S4[\"Compliance (Screening/Lists)\"]\n    S5[\"Directory &amp; Routing (ALS/Fees/Windows)\"]\n    S6[\"Reconciliation &amp; Returns\"]\n    S7[\"Event Bus + Outbox\"]\n    S8[\"Operator Console\"]\n    S9[\"Platform/Base (Admin/Time/Errors/IDs)\"]\n  end\n\n  subgraph M[\"Mojaloop Hub (Switch + Scheme Services)\"]\n    direction LR\n    M1[\"Account Lookup Service (ALS / Discovery)\"]\n    M2[\"Quoting Service (FX / Fees Agreement)\"]\n    M3[\"Central Ledger (Clearing/Positions)\"]\n    M4[\"Settlement Module (RTGS/Net/Prefund)\"]\n    M5[\"Scheme Rules &amp; Auth (PKI, Signatures, Consent)\"]\n    M6[\"Fraud/Risk Hooks\"]\n    M7[\"FSPIOP API Gateway\"]\n    M8[\"ILP Coordinator (Conditions/Fulfillment)\"]\n  end\n\n  %% Stalela internals\n  S1 --&gt; S4\n  S1 --&gt; S5\n  S1 --&gt; S2\n  S2 --&gt; S7\n  S7 --&gt; S3\n  S7 --&gt; S6\n  S8 --- S7\n  S9 --- S1\n  S9 --- S2\n  S9 --- S3\n\n  %% Mojaloop internals\n  M7 --&gt; M1\n  M7 --&gt; M2\n  M7 --&gt; M8\n  M8 --&gt; M3\n  M3 --&gt; M4\n  M5 --- M7\n  M6 --- M7\n</code></pre> <p>Key differences - Stalela separates rail adapters (gateways) from the core; ledger is internal SoT. - Mojaloop is a shared switch: it offers discovery, quoting, clearing &amp; settlement to external DFSPs. - Both use directories (ALS), FX/fees agreement, security (PKI), and fraud hooks \u2014 but Stalela keeps them inside its nucleus; Mojaloop exposes them as scheme services.</p>"},{"location":"10-payments-nucleus/overview/stalela-vs-mojaloop/#2-request-to-pay-r2p-flow-side-by-side","title":"2) Request-to-Pay (R2P) Flow \u2014 Side-by-Side","text":"<pre><code>sequenceDiagram\n  autonumber\n  participant Client as Merchant App / POS\n  participant Stalela as Stalela CTS\n  participant Dir as Directory (ALS)\n  participant GW as Rail Gateway (e.g., EcoCash/PayShap/USDC)\n  participant Ledger as Ledger Service\n\n  Note over Client,Ledger: Stalela \u2014 Rail-agnostic nucleus\n\n  Client-&gt;&gt;Stalela: POST /transfers (payer alias, amount, rail)\n  Stalela-&gt;&gt;Dir: Resolve alias -&gt; provider/route\n  Dir--&gt;&gt;Stalela: Provider &amp; fees/windows\n  Stalela-&gt;&gt;GW: transfers.submitted.&lt;rail&gt;\n  GW--&gt;&gt;Stalela: transfers.accepted (prompt delivered / tx observed)\n  GW--&gt;&gt;Stalela: transfers.settled (funds final)\n  Stalela-&gt;&gt;Ledger: Postings (Dr/Cr + fees/FX)\n  Ledger--&gt;&gt;Stalela: Balances updated\n  Stalela--&gt;&gt;Client: 200 OK (state: SETTLED)</code></pre> <pre><code>sequenceDiagram\n  autonumber\n  participant PayerApp as Payer DFSP App\n  participant Hub as Mojaloop Hub (FSPIOP)\n  participant ALS as Account Lookup (Discovery)\n  participant Quote as Quoting (FX/Fees)\n  participant ILP as ILP/Transfer Orchestrator\n  participant PayeeApp as Payee DFSP App\n  participant Settle as Settlement/RTGS\n\n  Note over PayerApp,Settle: Mojaloop \u2014 Shared scheme with DFSPs\n\n  PayerApp-&gt;&gt;Hub: POST /parties (discover payee alias)\n  Hub-&gt;&gt;ALS: Lookup alias -&gt; DFSP\n  ALS--&gt;&gt;Hub: Payee DFSP\n  Hub-&gt;&gt;PayeeApp: GET /quotes?amount,currency\n  PayeeApp--&gt;&gt;Hub: Quote (amountIn/Out, fees, FX, ILP condition)\n  Hub--&gt;&gt;PayerApp: Quote (approve?)\n  PayerApp-&gt;&gt;Hub: POST /transfers (attach ILP condition)\n  Hub-&gt;&gt;ILP: Coordinate conditional transfer\n  ILP-&gt;&gt;PayeeApp: Fulfill if terms met\n  PayeeApp--&gt;&gt;Hub: Transfer success\n  Hub-&gt;&gt;Settle: (Net/Gross) settlement instruction\n  Hub--&gt;&gt;PayerApp: Transfer completed</code></pre> <p>Interpretation - Stalela treats R2P as an internal orchestration; gateways perform the last-mile prompt/observe/settle. - Mojaloop formalizes Discovery -&gt; Quote -&gt; Transfer across multiple DFSPs, with ILP ensuring atomicity and a separate settlement layer.</p>"},{"location":"10-payments-nucleus/overview/stalela-vs-mojaloop/#when-to-use-which-ideas","title":"When to use which ideas","text":"<ul> <li>Use Stalela\u2019s modular gateways when you must integrate diverse rails (EcoCash, PayShap, OPPWA, USDC) and keep a single internal ledger of record.  </li> <li>Use Mojaloop patterns (FSPIOP, ILP, ISO 20022 mapping, scheme rules) to standardize cross-institution flows and future-proof for regional interop.</li> </ul> <p>Draft v1 \u2014 for internal architecture review.</p>"},{"location":"10-payments-nucleus/repo-structure/ci-cd/","title":"CI/CD Standard (per service)","text":"<p>Canonical GitHub Actions workflow + required checks for all Stalela service repos.</p>"},{"location":"10-payments-nucleus/repo-structure/ci-cd/#required-checks","title":"Required Checks","text":"<ul> <li>lint: golangci\u2011lint / eslint</li> <li>test: unit tests + golden fixtures</li> <li>contract\u2011validate: ensure emitted/consumed events &amp; APIs conform to <code>storo-specs</code></li> <li>migrations\u2011dry\u2011run: for services with DB migrations</li> <li>build: Docker image</li> <li>publish: tag <code>svc:X.Y.Z</code> and <code>svc:X</code></li> </ul>"},{"location":"10-payments-nucleus/repo-structure/ci-cd/#example-workflow-githubworkflowsciyml","title":"Example Workflow (<code>.github/workflows/ci.yml</code>)","text":"<pre><code>name: CI\n\non:\n  push:\n    branches: [ main ]\n    tags: [ 'v*.*.*' ]\n  pull_request:\n\njobs:\n  lint:\n    runs-on: ubuntu-latest\n    steps:\n      - uses: actions/checkout@v4\n      - uses: actions/setup-go@v5\n        with: { go-version: '1.22' }\n      - run: go install github.com/golangci/golangci-lint/cmd/golangci-lint@latest\n      - run: golangci-lint run ./...\n\n  test:\n    runs-on: ubuntu-latest\n    services:\n      postgres:\n        image: postgres:16\n        env:\n          POSTGRES_PASSWORD: postgres\n        ports: [ '5432:5432' ]\n        options: &gt;-\n          --health-cmd=\"pg_isready -U postgres\"\n          --health-interval=10s\n          --health-timeout=5s\n          --health-retries=5\n      localstack:\n        image: localstack/localstack:3\n        env:\n          SERVICES: sns,sqs,s3\n        ports: [ '4566:4566' ]\n    steps:\n      - uses: actions/checkout@v4\n      - uses: actions/setup-go@v5\n        with: { go-version: '1.22' }\n      - run: make db   # apply embedded migrations\n      - run: make test # includes golden fixture tests\n\n  contract-validate:\n    runs-on: ubuntu-latest\n    steps:\n      - uses: actions/checkout@v4\n      - name: Install Node\n        uses: actions/setup-node@v4\n        with: { node-version: '20' }\n      - run: npm i -D @storo/specs ajv\n      - run: npm run validate:events  # project script validates fixtures/outbound events against envelope v=1\n      - run: npm run validate:openapi # if this repo exposes HTTP\n\n  build:\n    needs: [lint, test, contract-validate]\n    runs-on: ubuntu-latest\n    steps:\n      - uses: actions/checkout@v4\n      - name: Docker build\n        run: |\n          docker build -t ghcr.io/storo/${{ github.event.repository.name }}:${{ github.sha }} .\n      - name: Log in to GHCR\n        uses: docker/login-action@v3\n        with:\n          registry: ghcr.io\n          username: ${{ github.actor }}\n          password: ${{ secrets.GITHUB_TOKEN }}\n      - name: Push SHA image\n        run: docker push ghcr.io/storo/${{ github.event.repository.name }}:${{ github.sha }}\n\n  publish:\n    if: startsWith(github.ref, 'refs/tags/v')\n    needs: [build]\n    runs-on: ubuntu-latest\n    steps:\n      - uses: actions/checkout@v4\n      - name: Tag &amp; push semver images\n        run: |\n          IMAGE=ghcr.io/storo/${{ github.event.repository.name }}\n          TAG=${GITHUB_REF#refs/tags/}\n          MAJOR=$(echo $TAG | cut -d. -f1)\n          docker pull $IMAGE:${{ github.sha }}\n          docker tag  $IMAGE:${{ github.sha }} $IMAGE:$TAG\n          docker tag  $IMAGE:${{ github.sha }} $IMAGE:$MAJOR\n          docker push $IMAGE:$TAG\n          docker push $IMAGE:$MAJOR\n</code></pre>"},{"location":"10-payments-nucleus/repo-structure/ci-cd/#branching-protection","title":"Branching &amp; Protection","text":"<ul> <li>Trunk\u2011based: short\u2011lived PRs to <code>main</code>, protected branch.</li> <li>Required status checks: all jobs above.</li> <li>Conventional commits recommended; changelogs generated on tag.</li> </ul>"},{"location":"10-payments-nucleus/repo-structure/ci-cd/#deploy-via-storo-infra","title":"Deploy (via <code>storo-infra</code>)","text":"<ul> <li>Terraform pins image tags per env (dev/staging/prod).</li> <li>PR to bump tag = deploy. Rollback = revert tag.</li> <li>Deploy during SAST business hours; staging soak \u2265 24h for sensitive services.</li> </ul>"},{"location":"10-payments-nucleus/repo-structure/ci-cd/#secrets-tokens-in-ci","title":"Secrets &amp; Tokens in CI","text":""},{"location":"10-payments-nucleus/repo-structure/ci-cd/#contract-validation-fixtures","title":"Contract Validation &amp; Fixtures","text":"<ul> <li>Source of truth: see <code>Specs \u2192 Events</code> (envelope <code>v=1</code>) and <code>Specs \u2192 Fixtures</code> for golden examples.</li> <li>Minimum checks:</li> <li>Validate outbound events from providers (gateways, ledger, CTS) against envelope <code>v=1</code> and event schemas.</li> <li>Validate inbound consumer fixtures (e.g., ledger consuming <code>transfers.settled</code>) using AJV/<code>@storo/specs</code>.</li> <li>Recommended project scripts:</li> <li><code>validate:events</code> \u2192 runs schema checks on all event samples under <code>fixtures/events/*.json</code>.</li> <li> <p><code>validate:openapi</code> \u2192 validates OpenAPI if the repo exposes HTTP.</p> </li> <li> <p>Use GitHub Environments or OpenID Connect to assume AWS roles. No long\u2011lived keys.</p> </li> <li>Service\u2011specific permissions; least privilege to push images / read Secrets Manager where necessary.</li> </ul>"},{"location":"10-payments-nucleus/repo-structure/local-dev/","title":"Local Development (storo\u2011devstack)","text":"<p>How to run Stalela locally without a monorepo. You\u2019ll run the fleet via Docker and swap one service for your local build.</p>"},{"location":"10-payments-nucleus/repo-structure/local-dev/#prereqs","title":"Prereqs","text":"<ul> <li>Docker Desktop / Colima</li> <li>Make or Task</li> <li>Go 1.22 (for Go services), Node 20 (for console)</li> <li><code>storo-devstack</code> repo cloned</li> </ul> <p>Devstack provides: Postgres (multi\u2011DB), LocalStack (SNS/SQS), Prometheus, Grafana, and released service images.</p>"},{"location":"10-payments-nucleus/repo-structure/local-dev/#start-the-fleet","title":"Start the Fleet","text":"<pre><code>git clone git@github.com:storo/storo-devstack.git\ncd storo-devstack\ndocker compose up -d\n</code></pre> <p>Services come up with released images. Grafana is available at http://localhost:3000 (admin/admin by default).</p>"},{"location":"10-payments-nucleus/repo-structure/local-dev/#develop-one-service-locally","title":"Develop One Service Locally","text":"<p>Example: work on storo-gw-usdc while everything else runs in containers.</p> <p>1) Clone your service and start it locally: <pre><code>git clone git@github.com:storo/storo-gw-usdc.git\ncd storo-gw-usdc\nmake dev    # or task dev (hot reload)\n</code></pre></p> <p>2) In <code>storo-devstack/docker-compose.override.example.yml</code>, copy to <code>docker-compose.override.yml</code> and disable the service container, mapping your local port:</p> <pre><code># docker-compose.override.yml\nservices:\n  gw-usdc:\n    deploy:\n      replicas: 0  # disable container; we'll run it locally\n  # If the stack expects a port:\n  #   ports:\n  #     - \"8085:8085\"  # match your local gw-usdc listen port\n</code></pre> <p>3) Ensure env points to devstack infra: - Postgres: <code>postgres://localhost:5432/gw_usdc?sslmode=disable</code> - SQS/SNS (LocalStack): <code>http://localhost:4566</code> with dummy creds - S3 (for payloads): <code>http://localhost:4566</code></p> <p>4) Seed data (optional): <pre><code>make seed   # directory entries, holidays, test tenants\n</code></pre></p> <p>You can now post a transfer to CTS in devstack and watch events reach your local gateway.</p>"},{"location":"10-payments-nucleus/repo-structure/local-dev/#example-smoke-test-usdc-happy-path","title":"Example: Smoke Test (USDC Happy Path)","text":"<pre><code># Create a transfer\ncurl -XPOST http://localhost:8080/v1/transfers   -H 'Idempotency-Key: demo-1'   -d '{\n    \"tenantId\":\"tn_demo\",\n    \"payer\":{\"accountId\":\"acct_payer\"},\n    \"payee\":{\"accountId\":\"acct_merchant\"},\n    \"amount\":{\"value\":1000,\"currency\":\"USD\"},\n    \"rail\":\"usdc-algo\",\"intent\":\"PUSH\",\"externalRef\":\"ext_demo\"\n  }'\n</code></pre> <p>Verify in logs: - CTS emits <code>transfers.submitted.usdc</code> - Your local <code>gw-usdc</code> consumes and emits <code>accepted</code> then <code>settled</code> - Ledger in devstack posts entries</p>"},{"location":"10-payments-nucleus/repo-structure/local-dev/#tilt-optional-live-reload","title":"Tilt (optional, live reload)","text":"<p>If you prefer Tilt for hot\u2011reload: - <code>storo-devstack/Tiltfile</code> includes services. Comment out the one you run locally. - Point your local service to devstack infra as above.</p>"},{"location":"10-payments-nucleus/repo-structure/local-dev/#timezone-cutoffs","title":"Timezone &amp; Cutoffs","text":"<p>Business rules use Africa/Johannesburg. For predictable tests: - Export <code>TZ=Africa/Johannesburg</code> - Seed holidays via <code>platform-base</code> fixtures</p>"},{"location":"10-payments-nucleus/repo-structure/local-dev/#troubleshooting","title":"Troubleshooting","text":"<ul> <li>Events not flowing: check LocalStack is up (<code>awslocal sns list-topics</code>).</li> <li>DLQ growing: open Grafana \u2192 \u201cEvent Backlogs\u201d dashboard.</li> <li>DB migrations: run <code>make db</code> in the service repo to apply embedded migrations.</li> <li>CORS (console): set <code>CORS_ALLOWED_ORIGINS=http://localhost:3001</code> on services that expose HTTP APIs.</li> </ul>"},{"location":"10-payments-nucleus/repo-structure/local-dev/#clean-up","title":"Clean Up","text":"<pre><code>docker compose down -v  # stop and remove volumes\n</code></pre> <p>This resets your local DBs and queues.</p>"},{"location":"10-payments-nucleus/repo-structure/multi-repo-architecture/","title":"Multi\u2011Repo Architecture (Stalela)","text":"<p>How Stalela\u2019s nucleus is organized across independent repositories so multiple teams can ship fast without stepping on each other.</p> <p>This document defines which repos exist, who owns them, how they interoperate (contracts-first), and how you develop locally without a monorepo. It also sets versioning rules, release flows, and deprecation discipline.</p>"},{"location":"10-payments-nucleus/repo-structure/multi-repo-architecture/#goals-nongoals","title":"Goals &amp; Non\u2011Goals","text":"<p>Goals - Independent deployability and ownership per service. - Contract\u2011first interoperability (events &amp; APIs) with machine\u2011verifiable schemas. - Clear local dev story: run one service locally while the rest run as containers. - Locked\u2011down release &amp; rollback process per service.</p> <p>Non\u2011Goals - A single build system for everything (keep repos simple). - Tight coupling via shared DBs (no cross\u2011service DB calls).</p>"},{"location":"10-payments-nucleus/repo-structure/multi-repo-architecture/#repository-map-source-of-truth","title":"Repository Map (source of truth)","text":"Repo Purpose Tech Owners Notes storo-specs Event schemas (JSON Schema), APIs (OpenAPI), golden fixtures, codegen JSON/YAML, Node scripts Platform Publishes <code>@storo/specs</code> (npm) and <code>github.com/storo/specs-go</code> (Go) storo-cts Canonical Transfer Service (API + orchestration) Go, Postgres, SQS/SNS Payments Core Emits <code>transfers.submitted.&lt;rail&gt;</code> storo-gw-usdc USDC/Algorand rail gateway Go, Postgres, SQS/SNS Rails Team Strict transform + event emission storo-gw-oppwa OPPWA gateway Go Rails Team Webhooks verified &amp; signed storo-gw-zimswitch Zimswitch/ISO8583 gateway Go Rails Team ISO fixtures + golden tests storo-ledger Double\u2011entry, append\u2011only ledger Go, Postgres Finance Eng Consumes <code>transfers.*</code> \u2192 postings storo-compliance Local watchlist index + screening Go Risk/Compliance Ingests OFAC/UN/EU/SA lists storo-directory Institutions, BINs, fees, settlement windows Go Platform Versioned datasets storo-recon Statement ingest + matching + returns Go Finance Ops Emits <code>transfers.settled/returned</code> storo-operator-console Internal UI (timeline, exceptions, flags) Next.js/TS Ops Auth via SSO/RBAC storo-devstack Local docker compose / Tilt to run the fleet Compose/Tilt DX Lets each dev swap a single local service storo-infra Terraform + env config (dev/stage/prod) Terraform Infra Controls image tags, secrets, IAM storo-observability Dashboards, alert rules Grafana/Prom SRE Golden signals and SLOs <p>Ownership is explicit. Each repo has CODEOWNERS and a simple <code>Makefile</code>/<code>Taskfile</code> so onboarding is fast.</p>"},{"location":"10-payments-nucleus/repo-structure/multi-repo-architecture/#repo-classification-and-naming-conventions","title":"Repo classification and naming conventions","text":"<p>Convention - Libraries and shared packages MUST use the <code>-lib</code> suffix and contain no Lambdas. - Services and gateways (no <code>-lib</code> suffix) may include Lambdas where serverless is beneficial (webhooks, async processors, scheduled jobs). - Infra repos do not themselves contain Lambdas but define/deploy them.</p> Repo Type Lambdas Description storo-specs Contracts source (publishes libs) N/A Source of truth for event and API schemas; publishes <code>@storo/specs</code> (TS) and <code>storo-specs-go-lib</code> (Go). storo-specs-go-lib Library No Generated Go types/validators from <code>storo-specs</code>. storo-platform-lib Library No Shared domain types, business time/holiday calendars, RBAC helpers. storo-outbox-lib Library No Outbox helpers: transactional writes, idempotency keys, retry/backoff, metrics. storo-otel-lib Library No OpenTelemetry setup, logging, tracing, metrics helpers. storo-cts Service Yes Canonical Transfer Service API/orchestration; may run webhook or async processors as Lambdas. storo-gw-usdc Gateway Service Yes USDC/Algorand rail gateway; webhook handlers and async processors as Lambdas. storo-gw-oppwa Gateway Service Yes OPPWA gateway; signed webhooks and callbacks as Lambdas. storo-gw-zimswitch Gateway Service Possible ISO8583 processing; primarily containerized, Lambdas possible for specific async tasks. storo-ledger Service No Double-entry ledger; stateful DB workers; not expected to use Lambdas. storo-compliance Service Possible Screening; may use Lambdas for list ingestion/refresh, core service containerized. storo-directory Service Possible Reference datasets; may use Lambdas for scheduled imports; core reads are containerized. storo-recon Service Possible Statement ingest/matching; may use Lambdas for schedulers/extractors. storo-operator-console UI/Web No Internal Next.js app for ops; no Lambdas in repo (hosting may use edge/serverless runtime). storo-devstack Dev tooling No Local docker compose/Tilt; no Lambdas. storo-infra Infra N/A Terraform for environments, images, IAM, secrets; deploys container workloads. storo-cdk-infra Infra N/A CDK for serverless components (Lambda, API Gateway, SQS/SNS bindings) for serverless use-cases. storo-observability Observability N/A Dashboards and alert rules (Grafana/Prometheus). <p>Notes - Gateways and CTS are the primary candidates to include Lambdas (webhooks, async enrich/emit, scheduled maintenance). - Libraries never ship compute. If a repo might own runtime code, it should not carry the <code>-lib</code> suffix. - <code>storo-cdk-infra</code> is introduced to manage serverless stacks alongside <code>storo-infra</code> (Terraform) for containerized infrastructure.</p>"},{"location":"10-payments-nucleus/repo-structure/multi-repo-architecture/#contractsfirst-single-source-of-truth","title":"Contracts\u2011First (single source of truth)","text":""},{"location":"10-payments-nucleus/repo-structure/multi-repo-architecture/#storospecs","title":"storo\u2011specs","text":"<ul> <li>Events: JSON Schemas under <code>events/</code> with version fields (e.g., <code>\"v\": 1</code>).  </li> <li>APIs: OpenAPI under <code>api/</code> (CTS <code>/v1/transfers</code>, Ledger reads, etc.).  </li> <li>Fixtures: Golden JSON examples validated in CI.  </li> <li>Codegen: Publishes on tag:</li> <li>Go types/validators \u2192 <code>github.com/storo/specs-go</code> (semantic versioned)</li> <li>TS types/clients \u2192 <code>@storo/specs</code> (npm semver)</li> </ul> <p>Rule: Service repos pin a specific tag and validate in CI that all in/out payloads conform.</p>"},{"location":"10-payments-nucleus/repo-structure/multi-repo-architecture/#event-api-versioning","title":"Event &amp; API Versioning","text":"<ul> <li>Additive changes (new optional field): minor bump in <code>storo-specs</code>, no event version change required.</li> <li>Breaking changes: introduce new event version (e.g., <code>transfers.settled v2</code>) and dual\u2011publish during migration; consumers add support then deprecate v1.</li> <li>HTTP APIs: path versioning (<code>/v1/...</code>). Breaking change \u21d2 add <code>/v2</code> and run both until cutover.</li> <li>Deprecation policy: announce, dual\u2011run \u2265 2 releases, remove only after consumers are migrated.</li> </ul>"},{"location":"10-payments-nucleus/repo-structure/multi-repo-architecture/#local-development-no-monorepo-pain","title":"Local Development (no monorepo pain)","text":"<p>Use storo-devstack to run the fleet with released images + infrastructure (Postgres, LocalStack, Prometheus, Grafana). Then swap one service for a local build.</p>"},{"location":"10-payments-nucleus/repo-structure/multi-repo-architecture/#workflow","title":"Workflow","text":"<ol> <li><code>git clone storo-devstack &amp;&amp; docker compose up -d</code> </li> <li><code>git clone storo-gw-usdc &amp;&amp; make dev</code> (runs the gateway on your machine)</li> <li>In <code>storo-devstack/docker-compose.override.yml</code>, map the gateway\u2019s host port to the fleet and disable the container for that service.</li> <li>Iterate with hot reload (air/reflex). The rest of the system keeps using released images.</li> </ol> <p>Why this works: Contracts are pinned. Your local service talks to Live Postgres &amp; LocalStack queues created by devstack, so flows are realistic.</p>"},{"location":"10-payments-nucleus/repo-structure/multi-repo-architecture/#cicd-per-service","title":"CI/CD per Service","text":"<p>Pipeline (GitHub Actions) 1. <code>lint</code> (golangci\u2011lint / eslint) 2. <code>test</code> (unit + fixtures) 3. <code>contract-validate</code> (AJV vs <code>@storo/specs</code>; or <code>specs-go</code> validate) 4. <code>build</code> (Docker) 5. <code>publish</code> (<code>svc:X.Y.Z</code> + <code>svc:X</code>) 6. (optional) Chart publish (Helm)  </p> <p>storo-infra references image tags per env. Deploy is a tag flip (dev \u2192 stage \u2192 prod).</p>"},{"location":"10-payments-nucleus/repo-structure/multi-repo-architecture/#environments-secrets","title":"Environments &amp; Secrets","text":"<ul> <li>Envs: dev, staging, prod (separate AWS accounts).  </li> <li>Secrets in AWS Secrets Manager; IAM least privilege per service.  </li> <li>Business timezone is Africa/Johannesburg; holiday calendars bundled in <code>platform-base</code>.</li> </ul>"},{"location":"10-payments-nucleus/repo-structure/multi-repo-architecture/#observability-slos","title":"Observability &amp; SLOs","text":"<ul> <li>OpenTelemetry on all services. Prometheus metrics scraped by devstack &amp; prod.  </li> <li>Golden signals per ADR/observability doc: API latency, outbox backlog, consumer lag, ledger posting latency, recon match rate.  </li> <li>Alert rules live in <code>storo-observability</code> repo and are applied by Infra.</li> </ul>"},{"location":"10-payments-nucleus/repo-structure/multi-repo-architecture/#data-safety-rails","title":"Data &amp; Safety Rails","text":"<ul> <li>No cross\u2011service DB access. Only APIs/events.  </li> <li>Outbox required (ADR\u20110001). State change + event in the same txn.  </li> <li>Ledger is double\u2011entry, append\u2011only (ADR\u20110002).  </li> <li>Compliance must pass for submission; stale lists \u21d2 deny by policy.  </li> <li>Recon must close exceptions before end\u2011of\u2011day books close.</li> </ul>"},{"location":"10-payments-nucleus/repo-structure/multi-repo-architecture/#branching-releases","title":"Branching &amp; Releases","text":"<ul> <li>Trunk\u2011based with short\u2011lived PRs.  </li> <li>CI gates: unit, contract, migrations dry\u2011run.  </li> <li>Release by tagging (<code>vX.Y.Z</code>) \u2192 image publish.  </li> <li>Rollback: revert image tag in <code>storo-infra</code> (no code revert required).</li> </ul>"},{"location":"10-payments-nucleus/repo-structure/multi-repo-architecture/#repository-templates-consistency","title":"Repository Templates (consistency)","text":"<p>Each Go service repo includes: - <code>/cmd/service/main.go</code> with <code>/live</code>, <code>/ready</code>, <code>/metrics</code>, <code>/version</code> - <code>/internal/</code> (handlers, consumers, posting rules) - <code>/migrations/</code> (embedded) - Outbox &amp; optional Inbox (dedupe) tables - <code>Makefile</code> / <code>Taskfile.yml</code> - <code>.github/workflows/ci.yml</code> (pipeline above) - <code>docs/README.md</code> (local dev, env vars, example payloads)  </p>"},{"location":"10-payments-nucleus/repo-structure/multi-repo-architecture/#mermaid-map-repos-flows","title":"Mermaid Map (repos &amp; flows)","text":"<pre><code>flowchart LR\n  subgraph Specs\n    SP[storo-specs]\n  end\n\n  subgraph Rails\n    GU[storo-gw-usdc]\n    GO[storo-gw-oppwa]\n    GZ[storo-gw-zimswitch]\n  end\n\n  CTS[storo-cts]\n  LED[storo-ledger]\n  CMP[storo-compliance]\n  DIR[storo-directory]\n  REC[storo-recon]\n  UI[storo-operator-console]\n  DS[storo-devstack]\n  INF[storo-infra]\n\n  SP --&gt; CTS\n  SP --&gt; GU\n  SP --&gt; GO\n  SP --&gt; GZ\n  SP --&gt; LED\n  SP --&gt; CMP\n  SP --&gt; DIR\n  SP --&gt; REC\n  SP --&gt; UI\n\n  CTS --&gt;|transfers.submitted.*| GU\n  CTS --&gt;|transfers.submitted.*| GO\n  CTS --&gt;|transfers.submitted.*| GZ\n\n  GU --&gt;|transfers.accepted/settled/returned| CTS\n  GO --&gt;|\u2026| CTS\n  GZ --&gt;|\u2026| CTS\n\n  CTS --&gt; LED\n  REC --&gt; CTS\n  DIR --&gt; CTS\n  CMP --&gt; CTS\n  UI --&gt; CTS\n\n  DS --- CTS\n  DS --- GU\n  DS --- LED\n  INF --- CTS\n  INF --- Rails</code></pre>"},{"location":"10-payments-nucleus/repo-structure/multi-repo-architecture/#deprecation-migration-playbook","title":"Deprecation &amp; Migration Playbook","text":"<ol> <li>Propose change \u2192 write/update ADR in storo-specs PR.  </li> <li>Add schema change (new event version or additive field).  </li> <li>Publish new <code>specs-go</code> / <code>@storo/specs</code> tags.  </li> <li>Update providers first (emit both versions if breaking).  </li> <li>Update consumers to accept new version; ship.  </li> <li>Remove old version after \u22652 releases and a green prod window.</li> </ol>"},{"location":"10-payments-nucleus/repo-structure/multi-repo-architecture/#security-compliance-notes","title":"Security &amp; Compliance Notes","text":"<ul> <li>PAN/PCI scope stays inside gateways; no PAN in CTS/Ledger events.  </li> <li>PII minimized; raw rail payloads stored encrypted in blob store with TTL per policy.  </li> <li>Audit logs on the Operator Console; 4\u2011eyes for returns &amp; freezes.</li> </ul>"},{"location":"10-payments-nucleus/repo-structure/multi-repo-architecture/#actionable-next-steps-docsonly","title":"Actionable Next Steps (docs\u2011only)","text":"<ul> <li>Create repo stubs (empty READMEs) for all repos listed.  </li> <li>Add this doc under <code>docs/50-repo-structure/multi-repo-architecture.md</code>.  </li> <li>Draft <code>release-strategy.md</code> (semver details, dual\u2011publish patterns, deprecation checklist).  </li> <li>Draft <code>local-dev.md</code> (devstack usage + override examples).  </li> <li>Draft <code>ci-cd.md</code> (standard CI template + required checks).</li> </ul> <p>Once these docs exist, teams can start coding without waiting on a monorepo setup and with contracts locked by <code>storo-specs</code>.</p>"},{"location":"10-payments-nucleus/repo-structure/release-strategy/","title":"Release Strategy","text":"<p>Versioning, compatibility, and deprecation policy for Stalela\u2019s multi\u2011repo nucleus.</p>"},{"location":"10-payments-nucleus/repo-structure/release-strategy/#goals","title":"Goals","text":"<ul> <li>Ship services independently with predictable compatibility.</li> <li>Keep contracts-first (events + APIs) as the single source of truth.</li> <li>Enable safe rollbacks (just flip image tags).</li> <li>Avoid hard breaks: use dual\u2011publish and additive changes.</li> </ul>"},{"location":"10-payments-nucleus/repo-structure/release-strategy/#semantic-versioning-semver","title":"Semantic Versioning (SemVer)","text":"<ul> <li>All repos use X.Y.Z.</li> <li>X = breaking</li> <li>Y = backward\u2011compatible features</li> <li>Z = fixes/internal</li> </ul>"},{"location":"10-payments-nucleus/repo-structure/release-strategy/#images-packages","title":"Images &amp; Packages","text":"<ul> <li>Docker: <code>svc:X.Y.Z</code> and <code>svc:X</code> (major alias)</li> <li>Go module (<code>specs-go</code>): <code>vX.Y.Z</code> tags</li> <li>NPM (<code>@storo/specs</code>): semver tags</li> </ul>"},{"location":"10-payments-nucleus/repo-structure/release-strategy/#events-json-schema-versioning","title":"Events (JSON Schema) Versioning","text":"<ul> <li>Each event in <code>storo-specs</code> has an explicit envelope with a <code>\"v\"</code> field:   <pre><code>{ \"eventId\":\"...\", \"type\":\"transfers.settled\", \"v\":1, \"occurredAt\":\"...\", \"transferId\":\"...\", \"tenantId\":\"...\", \"payload\":{...} }\n</code></pre></li> <li>Additive changes (new optional fields in <code>payload</code>) \u21d2 minor bump of <code>storo-specs</code>; no change to <code>v</code>.</li> <li>Breaking changes \u21d2 introduce new event version (e.g., <code>v2</code>), keep <code>v1</code> schemas.  </li> <li>Providers (e.g., gateways) dual\u2011publish <code>v1</code> and <code>v2</code> for \u2265 2 releases.</li> <li>Consumers (e.g., ledger/recon) add support for <code>v2</code> before we retire <code>v1</code>.</li> </ul> <p>Consumer rule: always validate by <code>type + v</code> and reject unknown versions with a clear metric/log.</p>"},{"location":"10-payments-nucleus/repo-structure/release-strategy/#http-apis-versioning","title":"HTTP APIs Versioning","text":"<ul> <li>Path versioning: <code>/v1/...</code>, breaking change \u21d2 new path <code>/v2/...</code>.</li> <li>Run both versions until all clients migrate; publish sunset date.</li> </ul>"},{"location":"10-payments-nucleus/repo-structure/release-strategy/#deprecation-policy","title":"Deprecation Policy","text":"<ol> <li>Propose change + ADR in <code>storo-specs</code> PR.</li> <li>Announce (changelog + #dev\u2011announcements), add sunset date.</li> <li>Dual\u2011run (events/APIs) for \u2265 2 releases or agreed window.</li> <li>Measure: consumer readiness dashboards.</li> <li>Remove old version after sign\u2011off.</li> </ol>"},{"location":"10-payments-nucleus/repo-structure/release-strategy/#release-flow-per-service","title":"Release Flow (per service)","text":"<ol> <li>Merge to <code>main</code> (all checks green).</li> <li>Tag <code>vX.Y.Z</code> \u2192 CI builds/pushes images.</li> <li><code>storo-infra</code> PR bumps the env pin:</li> <li>dev \u2192 staging \u2192 prod (separate PRs), with Africa/Johannesburg cutoffs in mind.</li> <li>Rollback = revert tag pin in <code>storo-infra</code>.</li> </ol>"},{"location":"10-payments-nucleus/repo-structure/release-strategy/#rollout-patterns","title":"Rollout Patterns","text":"<ul> <li>Canary: ship to \u226410% traffic via separate task set/service.</li> <li>Shadow (events): consume <code>v2</code> in a shadow consumer and compare outcomes before switching.</li> <li>Feature Flags: CTS per\u2011tenant throttles, gateway partner toggles.</li> </ul>"},{"location":"10-payments-nucleus/repo-structure/release-strategy/#compatibility-matrix-example","title":"Compatibility Matrix (example)","text":"Producer Event Current Next Policy gw-usdc transfers.settled v1 v2 dual\u2011publish 2 releases ledger consumes <code>settled</code> v1 v1+v2 must accept both recon consumes <code>settled</code> v1 v1+v2 must accept both"},{"location":"10-payments-nucleus/repo-structure/release-strategy/#changelogs","title":"Changelogs","text":"<ul> <li>Each repo maintains <code>CHANGELOG.md</code> (Keep a Changelog format).</li> <li><code>storo-specs</code> also publishes a schema diff in release notes.</li> </ul>"},{"location":"10-payments-nucleus/repo-structure/release-strategy/#slas-for-releases","title":"SLAs for Releases","text":"<ul> <li>Prod changes during business hours SAST only (unless hotfix).</li> <li>Staging soak time: \u2265 24h for gateways and ledger changes.</li> <li>Emergency rollback target: &lt; 10 minutes (tag flip + health checks).</li> </ul>"},{"location":"10-payments-nucleus/specs/api-canonical-transfer/","title":"Canonical Transfer API","text":"<p>The Canonical Transfer Service (CTS) exposes the primary API for creating and retrieving transfers.</p>"},{"location":"10-payments-nucleus/specs/api-canonical-transfer/#purpose","title":"\ud83c\udfaf Purpose","text":"<ul> <li>Provide a unified API for initiating transfers.  </li> <li>Normalize requests into canonical model.  </li> <li>Return transfer state and timeline</li> </ul>"},{"location":"10-payments-nucleus/specs/api-canonical-transfer/#endpoints","title":"\ud83d\udd0c Endpoints","text":""},{"location":"10-payments-nucleus/specs/api-canonical-transfer/#post-transfers","title":"<code>POST /transfers</code>","text":"<p>Creates a new transfer.</p> <p>Headers - <code>Idempotency-Key</code>: unique key per client request (unique on <code>(tenantId, idempotencyKey, bodyHash)</code> for 36h). - <code>X-Canonical-Version</code>: currently fixed to <code>1</code>; bump when schema revs. - <code>Authorization</code>: OAuth2 client-credentials bearer token by default; HMAC signature supported for partners that cannot use OAuth.</p> <p>Request Body <pre><code>{\n  \"tenantId\": \"tn_456\",\n  \"intent\": \"PUSH\",\n  \"amount\": { \"value\": \"1000.00\", \"currency\": \"USD\" },\n  \"sourceCurrency\": \"USD\",\n  \"targetCurrency\": \"USD\",\n  \"fxStrategy\": \"NOT_APPLICABLE\",\n  \"payer\": { \"type\": \"WALLET\", \"id\": \"acct_001\" },\n  \"payee\": { \"type\": \"BANK\", \"id\": \"acct_999\" },\n  \"railHints\": [\"usdc-algo\"],\n  \"feeModel\": \"STORO_STANDARD\",\n  \"endUserRef\": \"end_abc123\",\n  \"externalRef\": \"ext_abc123\",\n  \"metadata\": { \"invoiceId\": \"inv_555\" },\n  \"traceparent\": \"00-4bf92f3577b34da6a3ce929d0e0e4736-00f067aa0ba902b7-00\"\n}\n</code></pre></p> <p>Response <pre><code>{\n  \"transferId\": \"tr_12345\",\n  \"state\": \"SUBMITTED\",\n  \"nextAction\": \"await_settlement\"\n}\n</code></pre></p> <p>Errors - <code>409 IdempotencyConflict</code> \u2013 same key, different <code>bodyHash</code>. - <code>422 EntityDenied</code> \u2013 compliance block. - <code>502 RoutingUnavailable</code> \u2013 directory lookup failed; includes <code>retryAfter</code> when a route window is closed. - <code>503 DependencyUnavailable</code> \u2013 downstream dependency outage (e.g., Compliance, Directory). - <code>500 RailUnavailable</code> \u2013 rail gateway issue.</p>"},{"location":"10-payments-nucleus/specs/api-canonical-transfer/#get-transfers","title":"<code>GET /transfers</code>","text":"<p>Lists transfers for the authenticated tenant using cursor-based pagination backed by the projection/read-model.</p> <p>Query Parameters</p> Name Type Notes <code>pageSize</code> integer (1\u2013250, default 50) Number of rows to return per page. <code>pageToken</code> string Encodes <code>(tenantId, createdAt DESC, transferId)</code> for cursor pagination. <code>state</code> array Filter by lifecycle state(s); omit for all. <code>intent</code> array Optional filter for AUTH/CAPTURE/PUSH/PULL. <code>rail</code> array Optional filter for routed rail(s). <code>fxStrategy</code> array Optional filter for NOT_APPLICABLE / QUOTE_AT_SUBMIT / PASS_THROUGH. <code>createdAtFrom</code> / <code>createdAtTo</code> RFC3339 timestamp Time-window filter aligned to indexed <code>createdAt</code>. <code>updatedAtFrom</code> / <code>updatedAtTo</code> RFC3339 timestamp Optional trailing updates window (defaults to 90-day horizon). <code>externalRef</code> string Exact match against client-supplied reference. <code>endUserRef</code> string Exact match for downstream correlation. <p>Response</p> <pre><code>{\n  \"items\": [\n    {\n      \"transferId\": \"tr_12345\",\n      \"state\": \"SETTLED\",\n      \"intent\": \"PUSH\",\n      \"rail\": \"usdc\",\n      \"amount\": { \"value\": \"1000.00\", \"currency\": \"USD\" },\n      \"sourceCurrency\": \"USD\",\n      \"targetCurrency\": \"USD\",\n      \"fxStrategy\": \"NOT_APPLICABLE\",\n      \"externalRef\": \"ext_abc123\",\n      \"endUserRef\": \"end_abc123\",\n      \"payerRef\": \"acct_001\",\n      \"payeeRef\": \"acct_999\",\n      \"createdAt\": \"2025-03-02T12:10:00Z\",\n      \"updatedAt\": \"2025-03-02T12:20:00Z\",\n      \"version\": 4\n    }\n  ],\n  \"nextPageToken\": \"g2wAAAABaANkABRt...\"\n}\n</code></pre> <p>Listings are eventually consistent; immediately after POST the transfer may not appear until the projection catches up. Clients needing the freshest state should continue to rely on the POST response or <code>GET /transfers/{id}</code>.</p>"},{"location":"10-payments-nucleus/specs/api-canonical-transfer/#get-transfersid","title":"<code>GET /transfers/:id</code>","text":"<p>Returns transfer details and event timeline.</p> <p>Response <pre><code>{\n  \"transferId\": \"tr_12345\",\n  \"tenantId\": \"tn_456\",\n  \"state\": \"SETTLED\",\n  \"events\": [\n    { \"type\": \"transfers.initiated\", \"occurredAt\": \"...\" },\n    { \"type\": \"transfers.submitted.usdc\", \"occurredAt\": \"...\" },\n    { \"type\": \"transfers.settled\", \"occurredAt\": \"...\" }\n  ]\n}\n</code></pre></p>"},{"location":"10-payments-nucleus/specs/api-canonical-transfer/#observability","title":"\ud83d\udcca Observability","text":"<ul> <li>Metrics: see Observability defaults for required counters/histograms.</li> <li>Logs: transferId, tenantId, eventId (never emit PII <code>payer</code>/<code>payee</code>).</li> <li>Traces: propagate <code>traceparent</code> from ingress to outbox publish.</li> </ul>"},{"location":"10-payments-nucleus/specs/api-canonical-transfer/#canonical-schema-v1","title":"\ud83e\uddec Canonical Schema (v1)","text":"<pre><code>{\n  \"$id\": \"schemas/canonical-transfer/v1.json\",\n  \"$schema\": \"https://json-schema.org/draft/2020-12/schema\",\n  \"title\": \"CanonicalTransferRequest.v1\",\n  \"type\": \"object\",\n  \"required\": [\"tenantId\", \"intent\", \"amount\", \"payer\", \"payee\"],\n  \"properties\": {\n    \"tenantId\": { \"type\": \"string\", \"minLength\": 3, \"maxLength\": 64 },\n    \"intent\": { \"type\": \"string\", \"enum\": [\"AUTH\", \"CAPTURE\", \"PUSH\", \"PULL\"] },\n    \"amount\": {\n      \"type\": \"object\",\n      \"required\": [\"value\", \"currency\"],\n      \"properties\": {\n        \"value\": { \"type\": \"string\", \"pattern\": \"^-?\\\\d{1,20}(\\\\.\\\\d{1,8})?$\" },\n        \"currency\": { \"type\": \"string\", \"pattern\": \"^[A-Z]{3}$\" }\n      },\n      \"additionalProperties\": false\n    },\n    \"sourceCurrency\": { \"type\": \"string\", \"pattern\": \"^[A-Z]{3}$\" },\n    \"targetCurrency\": { \"type\": \"string\", \"pattern\": \"^[A-Z]{3}$\" },\n    \"fxStrategy\": { \"type\": \"string\", \"enum\": [\"NOT_APPLICABLE\", \"QUOTE_AT_SUBMIT\", \"PASS_THROUGH\"] },\n    \"payer\": {\n      \"type\": \"object\",\n      \"required\": [\"type\", \"id\"],\n      \"properties\": {\n        \"type\": { \"type\": \"string\", \"enum\": [\"WALLET\", \"BANK\", \"CARD\", \"MOBILE_MONEY\", \"EXTERNAL\"] },\n        \"id\": { \"type\": \"string\", \"minLength\": 1 }\n      },\n      \"additionalProperties\": true\n    },\n    \"payee\": {\n      \"type\": \"object\",\n      \"required\": [\"type\", \"id\"],\n      \"properties\": {\n        \"type\": { \"type\": \"string\", \"enum\": [\"WALLET\", \"BANK\", \"CARD\", \"MOBILE_MONEY\", \"EXTERNAL\"] },\n        \"id\": { \"type\": \"string\", \"minLength\": 1 }\n      },\n      \"additionalProperties\": true\n    },\n    \"endUserRef\": { \"type\": \"string\", \"maxLength\": 128 },\n    \"railHints\": { \"type\": \"array\", \"items\": { \"type\": \"string\" }, \"maxItems\": 3 },\n    \"feeModel\": { \"type\": \"string\", \"maxLength\": 64 },\n    \"externalRef\": { \"type\": \"string\", \"maxLength\": 128 },\n    \"metadata\": { \"type\": \"object\", \"additionalProperties\": { \"type\": [\"string\", \"number\", \"boolean\"] } },\n    \"traceparent\": { \"type\": \"string\" }\n  },\n  \"additionalProperties\": false\n}\n</code></pre>"},{"location":"10-payments-nucleus/specs/api-canonical-transfer/#canonicalization-rules","title":"Canonicalization Rules","text":"<ul> <li>Trim string inputs and uppercase currency codes.</li> <li>Amounts are normalized using authoritative currency scale \u2192 emit fixed-scale decimal strings.</li> <li>Sort object keys lexicographically; keep array order stable.</li> <li>Drop empty-string values before hashing.</li> <li>Compute <code>bodyHash = sha256(utf8(JSON.stringify_no_ws(canonical)))</code>.</li> </ul>"},{"location":"10-payments-nucleus/specs/api-canonical-transfer/#openapi-31-stub","title":"\ud83d\udcdc OpenAPI 3.1 Stub","text":"<pre><code>openapi: 3.1.0\ninfo:\n  title: Stalela CTS API\n  version: 1.0.0\nservers:\n  - url: https://api.storo.io\npaths:\n  /transfers:\n    post:\n      summary: Create transfer\n      parameters:\n        - name: Idempotency-Key\n          in: header\n          required: true\n          schema: { type: string, maxLength: 128 }\n        - name: X-Canonical-Version\n          in: header\n          required: true\n          schema: { type: integer, enum: [1] }\n      requestBody:\n        required: true\n        content:\n          application/json:\n            schema:\n              $ref: ./schemas/canonical-transfer/v1.json\n      responses:\n        \"201\": { description: Created }\n        \"200\": { description: Idempotent replay }\n        \"409\": { description: IdempotencyConflict }\n        \"422\": { description: EntityDenied }\n        \"502\": { description: RoutingUnavailable }\n        \"503\": { description: DependencyUnavailable }\n  /transfers/{id}:\n    get:\n      summary: Get transfer\n      parameters:\n        - name: id\n          in: path\n          required: true\n          schema: { type: string }\n      responses:\n        \"200\": { description: OK }\n</code></pre>"},{"location":"10-payments-nucleus/specs/api-canonical-transfer/#observability-defaults","title":"\ud83d\udcca Observability Defaults","text":"Metric Type Labels Notes <code>cts_requests_total</code> counter <code>route</code>, <code>code</code>, <code>tenantId</code> Ingest volume + error mix <code>cts_request_duration_seconds_bucket</code> histogram <code>route</code> Track POST latency (SLO p95 &lt; 1.5s) <code>cts_idempotency_conflicts_total</code> counter <code>tenantId</code> Alert if rising above 0.1% <code>cts_compliance_latency_seconds_bucket</code> histogram Compliance round-trip <code>cts_directory_latency_seconds_bucket</code> histogram Directory round-trip <code>cts_outbox_attempts_total</code> counter <code>eventType</code> Publish attempts <code>cts_outbox_failures_total</code> counter <code>eventType</code> For burn-rate SLO <code>cts_transfers_state</code> gauge <code>state</code> Derived from projections <code>cts_consumer_lag</code> gauge <code>topic</code> Exported from SQS/Kafka exporter <p>PromQL Examples</p> <pre><code>histogram_quantile(0.95, sum(rate(http_server_duration_seconds_bucket{route=\"/transfers\",method=\"POST\"}[5m])) by (le)) &gt; 1.5\n\nrate(cts_outbox_failures_total[5m]) / rate(cts_outbox_attempts_total[5m]) &gt; 0.001\n</code></pre>"},{"location":"10-payments-nucleus/specs/api-canonical-transfer/#postgres-ddl-aurora-serverless-v2","title":"\ud83d\uddc4\ufe0f Postgres DDL (Aurora Serverless v2)","text":"<pre><code>create extension if not exists pgcrypto;\n\ncreate table transfers (\n  transferId uuid primary key default gen_random_uuid(),\n  tenantId text not null,\n  payer jsonb not null,\n  payee jsonb not null,\n  amount_value numeric(20,8) not null,\n  amount_currency char(3) not null,\n  source_currency char(3) null,\n  target_currency char(3) null,\n  fx_strategy text null,\n  rail text not null,\n  intent text not null check (intent in ('AUTH','CAPTURE','PUSH','PULL')),\n  externalRef text null,\n  feeModel text null,\n  endUserRef text null,\n  state text not null,\n  version bigint not null default 0,\n  createdAt timestamptz not null default now(),\n  updatedAt timestamptz not null default now()\n);\n\ncreate index ix_transfers_tenant_created on transfers(tenantId, createdAt desc);\ncreate unique index ux_transfers_externalref on transfers(tenantId, externalRef) where externalRef is not null;\n\ncreate table transfer_events (\n  eventId uuid primary key default gen_random_uuid(),\n  transferId uuid not null references transfers(transferId),\n  type text not null,\n  payload jsonb not null,\n  occurredAt timestamptz not null default now()\n);\n\ncreate index ix_events_transfer_time on transfer_events(transferId, occurredAt);\ncreate unique index ux_events_lifecycle on transfer_events(transferId, type);\n\ncreate table outbox_transfers (\n  id uuid primary key default gen_random_uuid(),\n  eventType text not null,\n  payload jsonb not null,\n  state text not null check (state in ('PENDING','SENT','FAILED')),\n  attempts int not null default 0,\n  lastError text null,\n  createdAt timestamptz not null default now(),\n  updatedAt timestamptz not null default now()\n);\ncreate index ix_outbox_state_created on outbox_transfers(state, createdAt);\ncreate index ix_outbox_eventType on outbox_transfers(eventType);\n\ncreate table idempotency (\n  tenantId text not null,\n  idempotencyKey text not null,\n  bodyHash char(64) not null,\n  transferId uuid not null,\n  createdAt timestamptz not null default now(),\n  primary key (tenantId, idempotencyKey, bodyHash)\n);\n\ncreate index ux_idem_window on idempotency(tenantId, idempotencyKey, bodyHash)\n  where createdAt &gt; now() - interval '36 hours';\n</code></pre>"},{"location":"10-payments-nucleus/specs/api-canonical-transfer/#idempotent-write-example","title":"Idempotent write example","text":"<pre><code>begin;\ninsert into transfers (...) values (...) returning transferId;\ninsert into outbox_transfers (eventType, payload, state) values ('transfers.submitted.usdc', :payload, 'PENDING');\ninsert into idempotency(tenantId, idempotencyKey, bodyHash, transferId) values (:t,:k,:h,:tr);\ncommit;\n</code></pre>"},{"location":"10-payments-nucleus/specs/chart-of-accounts/","title":"Chart of Accounts (Stalela)","text":"<p>The Chart of Accounts (CoA) is the backbone of Stalela\u2019s ledger. It defines all account types, their normal balances, and how they roll into financial statements. Based on lessons from Accounting for Developers and adapted to payments systems.</p>"},{"location":"10-payments-nucleus/specs/chart-of-accounts/#principles","title":"Principles","text":"<ul> <li>Double-entry: Every posting must debit one account and credit another.  </li> <li>Normal balance: Each account has a default side (debit or credit) where increases are recorded.  </li> <li>Hierarchy: Top-level categories are fixed, sub-accounts can be extended per tenant/product.  </li> <li>Accrual basis: Income and expenses recognized when earned, not just when cash moves.  </li> </ul>"},{"location":"10-payments-nucleus/specs/chart-of-accounts/#top-level-categories","title":"Top-Level Categories","text":""},{"location":"10-payments-nucleus/specs/chart-of-accounts/#1-assets-normal-balance-debit","title":"1. Assets (Normal Balance: Debit)","text":"<ul> <li>Liquidity (Cash/USDC Pool) </li> <li>Settlement In Transit (funds in process of clearing)  </li> <li>Accounts Receivable (e.g., unsettled merchant payments)  </li> <li>Inventory / Collateral (if applicable for product extensions)  </li> </ul>"},{"location":"10-payments-nucleus/specs/chart-of-accounts/#2-liabilities-normal-balance-credit","title":"2. Liabilities (Normal Balance: Credit)","text":"<ul> <li>User Balances (owed to end-users)  </li> <li>Merchant Payables (owed to merchants)  </li> <li>Deferred Revenue (collected in advance, not yet earned)  </li> <li>Chargebacks/Returns Payable </li> </ul>"},{"location":"10-payments-nucleus/specs/chart-of-accounts/#3-equity-normal-balance-credit","title":"3. Equity (Normal Balance: Credit)","text":"<ul> <li>Contributed Capital </li> <li>Retained Earnings (prior net income carried forward)  </li> <li>Current Period Net Income (closed at end of period into Retained Earnings)  </li> </ul>"},{"location":"10-payments-nucleus/specs/chart-of-accounts/#4-revenue-normal-balance-credit","title":"4. Revenue (Normal Balance: Credit)","text":"<ul> <li>Transaction Fees Earned </li> <li>FX Spread Income </li> <li>Other Service Fees </li> </ul>"},{"location":"10-payments-nucleus/specs/chart-of-accounts/#5-expenses-normal-balance-debit","title":"5. Expenses (Normal Balance: Debit)","text":"<ul> <li>Processing Costs (rail fees, partner charges)  </li> <li>Chargeback Losses </li> <li>Operational Expenses (infra, compliance overhead)  </li> </ul>"},{"location":"10-payments-nucleus/specs/chart-of-accounts/#examples","title":"Examples","text":"<p>User Deposit (USDC \u2192 Wallet) - Debit Liquidity (Asset) - Credit User Balances (Liability)  </p> <p>Merchant Payout (USDC \u2192 Merchant) - Debit Merchant Payables (Liability) - Credit Liquidity (Asset)  </p> <p>Fee Collection - Debit User Balance (Liability) - Credit Transaction Fees Earned (Revenue)  </p> <p>Chargeback - Debit Chargebacks Payable (Liability) - Credit Merchant Payables (Liability)  </p>"},{"location":"10-payments-nucleus/specs/chart-of-accounts/#notes","title":"Notes","text":"<ul> <li>Accounts can be extended per-tenant under the same category.  </li> <li>All postings must reconcile to ensure Assets = Liabilities + Equity.  </li> </ul>"},{"location":"10-payments-nucleus/specs/data-retention-pii/","title":"Data Retention &amp; PII Handling","text":"<p>The data retention policy governs how long Stalela stores sensitive data and how it is redacted.</p>"},{"location":"10-payments-nucleus/specs/data-retention-pii/#principles","title":"\ud83c\udfaf Principles","text":"<ul> <li>Minimize PII stored in core DBs.  </li> <li>Encrypt at rest all raw rail payloads.  </li> <li>Retain only what\u2019s needed for audit, compliance, dispute resolution.  </li> <li>Expire or redact data after retention window.</li> </ul>"},{"location":"10-payments-nucleus/specs/data-retention-pii/#storage-classes","title":"\ud83d\udce6 Storage Classes","text":"<ul> <li>Canonical DBs (CTS, Ledger, Compliance, Directory, Recon) </li> <li>Store IDs, references, metadata only.  </li> <li> <p>No raw PII beyond accountId/tenantId.  </p> </li> <li> <p>Blob Store (encrypted) </p> </li> <li>Stores raw rail payloads, statements.  </li> <li>Access tightly controlled, time-limited.  </li> </ul>"},{"location":"10-payments-nucleus/specs/data-retention-pii/#retention-windows","title":"\u23f3 Retention Windows","text":"<ul> <li>Transfer &amp; ledger events: 7 years (audit requirement).  </li> <li>Raw rail payloads: 18 months.  </li> <li>Compliance screening results: 5 years.  </li> <li>Operator actions (audit log): 7 years.  </li> </ul>"},{"location":"10-payments-nucleus/specs/data-retention-pii/#redaction","title":"\ud83e\uddf9 Redaction","text":"<ul> <li>After expiry, execute stored proc <code>select cts_pii_tombstone(:tenantId, :transferId)</code> which:</li> <li>Nulls column-level PII on canonical tables (<code>payer</code>, <code>payee</code>, contact fields).</li> <li>Writes an immutable audit row documenting who requested the erasure and why.</li> <li>Leaves immutable event payloads untouched (they only contain stable references).</li> <li>Keep metadata (transferId, amounts, dates).</li> </ul>"},{"location":"10-payments-nucleus/specs/data-retention-pii/#security","title":"\ud83d\udd10 Security","text":"<ul> <li>All PII encrypted at rest + in transit.  </li> <li>Logs redact sensitive fields (names, IDs, PANs).  </li> <li>Access scoped to tenant &amp; role.  </li> </ul>"},{"location":"10-payments-nucleus/specs/data-retention-pii/#popia-cross-border-transfers-za","title":"\ud83c\udf0d POPIA Cross-Border Transfers (ZA)","text":"<ul> <li>Assess adequacy for destination; if inadequate, add contractual safeguards and consent where required.  </li> <li>Maintain a register of cross-border transfers with purpose, destinations, and safeguards.  </li> <li>Ensure processors/sub-processors contractually meet POPIA obligations.  </li> <li>Do not include PII in event payloads unless strictly necessary; prefer references.</li> </ul>"},{"location":"10-payments-nucleus/specs/data-retention-pii/#runbooks","title":"\ud83e\udded Runbooks","text":"<ul> <li>Retention job failure \u2192 retry, escalate if backlog &gt; 24h.  </li> <li>Legal hold \u2192 suspend deletion for specific entities.  </li> <li>PII exposure incident \u2192 trigger breach protocol immediately.  </li> </ul>"},{"location":"10-payments-nucleus/specs/error-codes/","title":"Error Taxonomy &amp; Codes","text":"<p>Consistent error codes across APIs.</p>"},{"location":"10-payments-nucleus/specs/error-codes/#principles","title":"\ud83d\udd11 Principles","text":"<ul> <li>Stable, documented codes.</li> <li>Human-readable messages.</li> <li>Machine-actionable (clients can retry/failover).</li> </ul>"},{"location":"10-payments-nucleus/specs/error-codes/#categories","title":"\ud83d\uddc2 Categories","text":"<ul> <li>4xx \u2014 Client Errors</li> <li><code>40001</code> Invalid request schema</li> <li><code>40002</code> Idempotency key missing/invalid</li> <li><code>40901</code> Version conflict (optimistic concurrency on internal tools)</li> <li><code>40902</code> Idempotency conflict (same key, different body hash)</li> <li><code>42201</code> Compliance screening: denied</li> <li> <p><code>42202</code> Directory route not found</p> </li> <li> <p>5xx \u2014 Server Errors</p> </li> <li><code>50001</code> Rail adapter unavailable</li> <li><code>50002</code> Outbox publish failure</li> <li><code>50003</code> Ledger posting failed</li> <li><code>50301</code> Dependency unavailable (Compliance, Directory, FX)</li> </ul>"},{"location":"10-payments-nucleus/specs/error-codes/#rail-reason-code-mappings-informative","title":"Rail Reason Code Mappings (informative)","text":"<ul> <li>Mobile Money (EcoCash/MTN/Airtel)</li> <li>Partner decline \u2192 <code>MM_DECLINED</code></li> <li>Insufficient funds \u2192 <code>MM_INSUFFICIENT_FUNDS</code></li> <li> <p>Timeout/no response \u2192 <code>MM_TIMEOUT</code></p> </li> <li> <p>PayShap</p> </li> <li>Proxy invalid \u2192 <code>PS_PROXY_INVALID</code></li> <li>Beneficiary not available \u2192 <code>PS_BENEFICIARY_UNAVAILABLE</code></li> <li>Timeout \u2192 <code>PS_TIMEOUT</code></li> </ul> <p>Exact partner code \u2192 Stalela reason maps to be versioned per gateway.</p>"},{"location":"10-payments-nucleus/specs/error-codes/#notes","title":"\ud83d\udccc Notes","text":"<p>Expand per component (CTS, Ledger, Gateways). All error responses MUST include: <pre><code>{\n  \"code\": \"42201\",\n  \"message\": \"Entity denied by compliance\",\n  \"transferId\": \"tr_12345\",\n  \"timestamp\": \"2025-08-27T12:00:00Z\"\n}\n</code></pre></p>"},{"location":"10-payments-nucleus/specs/events/","title":"Event Specifications","text":"<p>The Event model defines the envelope and catalog of all domain events emitted across Stalela services.</p>"},{"location":"10-payments-nucleus/specs/events/#purpose","title":"\ud83c\udfaf Purpose","text":"<ul> <li>Provide a single canonical envelope for all events.  </li> <li>Define the catalog of event types (<code>transfers.*</code>, <code>ledger.*</code>, etc.).  </li> <li>Ensure idempotency and consistency across services.  </li> </ul>"},{"location":"10-payments-nucleus/specs/events/#event-envelope-v1","title":"\ud83d\udce6 Event Envelope (v1)","text":"<pre><code>{\n  \"envelope\": {\n    \"v\": 1,\n    \"eventId\": \"uuid\",\n    \"type\": \"events.transfers.submitted.usdc\",\n    \"occurredAt\": \"2025-08-26T10:15:01Z\",\n    \"tenantId\": \"tn_456\",\n    \"transferId\": \"tr_123\",\n    \"traceparent\": \"00-4bf92f3577b34da6a3ce929d0e0e4736-00f067aa0ba902b7-00\",\n    \"payloadSchema\": \"canonical.transfer.v1\"\n  },\n  \"payload\": {\n    \"amount\": { \"value\": \"1000.00\", \"currency\": \"USD\" },\n    \"payerRef\": \"payer-1\",\n    \"payeeRef\": \"payee-9\",\n    \"endUserRef\": \"end-7\"\n  }\n}\n</code></pre> <p>Fields - <code>envelope.v</code> \u2013 envelope schema version (integer, starting at 1). - <code>envelope.eventId</code> \u2013 unique ID (UUIDv7 recommended). - <code>envelope.type</code> \u2013 dot-delimited string category (see catalog). - <code>envelope.occurredAt</code> \u2013 ISO8601 UTC timestamp. - <code>envelope.tenantId</code> \u2013 tenant scoping. - <code>envelope.transferId</code> \u2013 optional link to transfer (if relevant). - <code>envelope.traceparent</code> \u2013 W3C trace context for correlation end-to-end. - <code>envelope.payloadSchema</code> \u2013 canonical schema identifier (<code>canonical.transfer.v1</code>). - <code>payload</code> \u2013 type-specific content (PII-free; only stable references).</p> <p>Optional enrichment (additive) - <code>kycTier</code> \u2013 KYC tier for context (T0|T1|T2). - <code>riskScore</code> \u2013 screening risk score (0-100). - <code>exchangeControlRef</code> \u2013 reference for exchange control/BoP. - <code>taxCode</code> \u2013 tax/VAT code for fee lines. - <code>proxyType</code> \u2013 proxy type for PayShap (cell|email|id).  </p> <p>Additive fields do not break consumers; treat unknown fields as optional.</p>"},{"location":"10-payments-nucleus/specs/events/#event-catalog","title":"\ud83d\udcda Event Catalog","text":""},{"location":"10-payments-nucleus/specs/events/#transfers","title":"Transfers","text":"<ul> <li><code>transfers.initiated</code> </li> <li><code>transfers.submitted.&lt;rail&gt;</code> </li> <li><code>transfers.accepted</code> </li> <li><code>transfers.settled</code> </li> <li><code>transfers.returned</code> </li> <li><code>transfers.failed</code> </li> </ul>"},{"location":"10-payments-nucleus/specs/events/#ledger","title":"Ledger","text":"<ul> <li><code>ledger.posting.created</code> </li> <li><code>ledger.balance.updated</code> </li> </ul>"},{"location":"10-payments-nucleus/specs/events/#compliance","title":"Compliance","text":"<ul> <li><code>compliance.entity.flagged</code> </li> </ul>"},{"location":"10-payments-nucleus/specs/events/#reconciliation","title":"Reconciliation","text":"<ul> <li><code>recon.statement.ingested</code> </li> <li><code>recon.exception.opened</code> </li> </ul>"},{"location":"10-payments-nucleus/specs/events/#directory","title":"Directory","text":"<ul> <li><code>directory.version.updated</code> </li> </ul>"},{"location":"10-payments-nucleus/specs/events/#idempotency-rules","title":"\ud83d\udd01 Idempotency Rules","text":"<ul> <li>Event consumers must dedupe using <code>envelope.eventId</code>.</li> <li>For transfer lifecycle, <code>(envelope.transferId, envelope.type)</code> must be unique.</li> <li>Outbox pattern ensures atomic persistence + publish; events are immutable after emission.</li> </ul>"},{"location":"10-payments-nucleus/specs/events/#partitioning-delivery-defaults","title":"\ud83d\udea6 Partitioning &amp; Delivery Defaults","text":"<ul> <li>SNS FIFO topic: <code>events.transfers.fifo</code> with <code>MessageGroupId = transferId</code> to guarantee order.</li> <li>Outbox worker retry/backoff: <code>1s, 5s, 30s, 2m, 10m, 1h, 2h, 4h, 8h, 16h</code>; send to DLQ after the 10th attempt.</li> <li>DLQ retention: 14 days within queue, plus archived copy retained for 7 years.</li> </ul>"},{"location":"10-payments-nucleus/specs/events/#versioning","title":"\ud83e\udded Versioning","text":"<ul> <li>Envelope: <code>v</code> is the envelope schema version (current: 1).  </li> <li>Additive changes (new optional fields) require no version bump.  </li> <li>Breaking payload changes introduce a new <code>type</code> version (e.g., <code>transfers.settled.v2</code>) with dual-publish during migration.</li> </ul>"},{"location":"10-payments-nucleus/specs/events/#observability","title":"\ud83d\udcca Observability","text":"<ul> <li>Metrics: events/sec by type, lag from occurredAt \u2192 consumed.  </li> <li>Audit: immutable event store recommended for replay/debug.</li> </ul>"},{"location":"10-payments-nucleus/specs/external-integrations/","title":"External Integrations \u2014 Edge Map","text":"<p>This file maps out external systems Stalela must eventually connect to.  </p>"},{"location":"10-payments-nucleus/specs/external-integrations/#rails","title":"\ud83c\udf0d Rails","text":"<ul> <li>EcoCash / Mobile Money (ZW) \u2192 push-only flows, STK prompts.</li> <li>Zimswitch / OPPWA \u2192 ISO 8583 + JSON APIs, card-present &amp; online.</li> <li>PayShap (SA) \u2192 proxy-based instant payments.</li> <li>USDC/Algorand \u2192 blockchain adapter.</li> <li>EFT/RTGS (SA) \u2192 batch payments, settlement via SARB.</li> </ul>"},{"location":"10-payments-nucleus/specs/external-integrations/#banks-rtgs","title":"\ud83c\udfe6 Banks &amp; RTGS","text":"<ul> <li>South Africa: NPS, EFT clearing, RTGS.</li> <li>Zimbabwe: Zimswitch settlement partners.</li> </ul>"},{"location":"10-payments-nucleus/specs/external-integrations/#regulatory","title":"\u2696\ufe0f Regulatory","text":"<ul> <li>South Africa: FIC reporting APIs.</li> <li>Zimbabwe: FIU suspicious activity reporting.</li> <li>Cross-border: FATF Travel Rule (TBD).</li> </ul>"},{"location":"10-payments-nucleus/specs/external-integrations/#identity-kyc","title":"\ud83c\udd94 Identity &amp; KYC","text":"<ul> <li>Optional MOSIP integration for National ID checks.</li> <li>Local credit bureau lookups (future).</li> <li>SIM-swap signals (mobile operators / third-party providers) for risk.</li> <li>AVS (account verification) and bank account name-matching (ZA) for pull payouts.</li> </ul>"},{"location":"10-payments-nucleus/specs/external-integrations/#file-specifications-recon","title":"\ud83d\udcc4 File Specifications (Recon)","text":"<ul> <li>Bankserv EFT: settlement/returns file layouts and cutoffs (link: add under recon).</li> <li>PayShap: exception/return notifications mapping.</li> <li>ZIPIT/RTGS: daily statements and reason codes.</li> </ul>"},{"location":"10-payments-nucleus/specs/external-integrations/#notes","title":"\ud83d\udccc Notes","text":"<p>Each integration will have its own <code>rail-gateway-&lt;name&gt;.md</code> or <code>integration-&lt;name&gt;.md</code>.</p>"},{"location":"10-payments-nucleus/specs/fixtures/","title":"Golden Fixtures","text":"<p>Golden fixtures are canonical JSON examples used to validate contracts (events and APIs) across services and in CI pipelines.</p>"},{"location":"10-payments-nucleus/specs/fixtures/#scope","title":"Scope","text":"<ul> <li>Event envelope and payload examples (envelope <code>v=1</code>).</li> <li>Canonical Transfer API requests/responses.</li> <li>Per-rail gateway event samples for <code>accepted/settled/returned/failed</code>.</li> </ul>"},{"location":"10-payments-nucleus/specs/fixtures/#usage","title":"Usage","text":"<ul> <li>Validate outbound events from providers against fixture schemas.</li> <li>Validate inbound event consumers via golden test vectors.</li> <li>Reference fixtures in CI <code>contract-validate</code> job (see <code>docs/50-repo-structure/ci-cd.md</code>).</li> </ul>"},{"location":"10-payments-nucleus/specs/fixtures/#examples","title":"Examples","text":""},{"location":"10-payments-nucleus/specs/fixtures/#event-transferssettled-v1","title":"Event: transfers.settled (v1)","text":"<pre><code>{\n  \"eventId\": \"018f3d20-1111-7c89-b1e3-7a7f5d3b9b10\",\n  \"type\": \"transfers.settled\",\n  \"v\": 1,\n  \"occurredAt\": \"2025-08-26T10:15:01Z\",\n  \"transferId\": \"tr_12345\",\n  \"tenantId\": \"tn_67890\",\n  \"payload\": {\n    \"amount\": { \"value\": 1000, \"currency\": \"USD\" },\n    \"rail\": \"usdc-algo\"\n  }\n}\n</code></pre>"},{"location":"10-payments-nucleus/specs/fixtures/#api-post-transfers-request","title":"API: POST /transfers request","text":"<pre><code>{\n  \"tenantId\": \"tn_456\",\n  \"payer\": { \"accountId\": \"acct_001\" },\n  \"payee\": { \"accountId\": \"acct_999\" },\n  \"amount\": { \"value\": 1000, \"currency\": \"USD\" },\n  \"rail\": \"usdc-algo\",\n  \"intent\": \"PUSH\",\n  \"externalRef\": \"ext_abc123\",\n  \"metadata\": { \"invoiceId\": \"inv_555\" }\n}\n</code></pre>"},{"location":"10-payments-nucleus/specs/fixtures/#api-post-transfers-response","title":"API: POST /transfers response","text":"<pre><code>{\n  \"transferId\": \"tr_12345\",\n  \"state\": \"SUBMITTED\",\n  \"nextAction\": \"await_settlement\"\n}\n</code></pre>"},{"location":"10-payments-nucleus/specs/fx-policy/","title":"FX Policy (USD/ZAR/ZWL)","text":"<p>Defines quote sources, TTL, and audit requirements for FX conversions in supported corridors.</p>"},{"location":"10-payments-nucleus/specs/fx-policy/#quote-sources","title":"Quote Sources","text":"<ul> <li>RBZ auction (ZW) vs Market providers (ZA) \u2014 configurable per tenant/corridor.</li> <li>Provenance recorded with quotes; fallback hierarchy.</li> </ul>"},{"location":"10-payments-nucleus/specs/fx-policy/#ttl-usage","title":"TTL &amp; Usage","text":"<ul> <li>TTL per corridor; reject expired quotes.</li> <li>Store applied rate on event/journal for audit.</li> <li>Canonical requests declare <code>fxStrategy</code> (<code>NOT_APPLICABLE</code>, <code>QUOTE_AT_SUBMIT</code>, <code>PASS_THROUGH</code>); Directory enforces viability before routing.</li> </ul>"},{"location":"10-payments-nucleus/specs/fx-policy/#controls","title":"Controls","text":"<ul> <li>Max deviation vs reference index; alert on breach.</li> <li>Hedging hooks: external position management (future).</li> </ul>"},{"location":"10-payments-nucleus/specs/fx-policy/#observability","title":"Observability","text":"<ul> <li>Metrics: quote age, deviation, rejection rate.</li> </ul> <p>Last updated: 2025-08-27</p>"},{"location":"10-payments-nucleus/specs/posting-rules/","title":"Posting Rules (Expanded)","text":"<p>Defines how Stalela translates transfer lifecycle events into double\u2011entry ledger postings. This is the authoritative mapping for <code>ledger-service</code>.</p>"},{"location":"10-payments-nucleus/specs/posting-rules/#principles","title":"Principles","text":"<ul> <li>Every posting set must balance (sum debits = sum credits).  </li> <li>Postings are append\u2011only; reversals are explicit.  </li> <li>Ledger is accrual\u2011based: income/expenses recognized when earned, not when paid.  </li> <li>Use normal balances from chart\u2011of\u2011accounts.md.  </li> </ul>"},{"location":"10-payments-nucleus/specs/posting-rules/#event-posting-rules","title":"Event \u2192 Posting Rules","text":""},{"location":"10-payments-nucleus/specs/posting-rules/#1-transfersaccepted-auth-reservation","title":"1. <code>transfers.accepted</code> (AUTH / reservation)","text":"<ul> <li>If rail supports authorization (card\u2011like), create pending/memo postings:</li> </ul> Debit (Dr) Credit (Cr) Notes Rail Settlement Pending User / Payer Off\u2011balance memo (not cash movement yet)"},{"location":"10-payments-nucleus/specs/posting-rules/#2-transferssettled-funds-final","title":"2. <code>transfers.settled</code> (funds final)","text":""},{"location":"10-payments-nucleus/specs/posting-rules/#case-push-payment-payer-sends-to-payee","title":"Case: PUSH payment (payer sends to payee)","text":"Debit (Dr) Credit (Cr) Notes User / Payer Merchant / Payee Principal transfer Merchant / Payee Fees Revenue If fee charged (separate leg) FX Loss Merchant / Payee If FX conversion loss applied Merchant / Payee FX Gain If FX conversion gain applied"},{"location":"10-payments-nucleus/specs/posting-rules/#case-pull-payment-merchant-pulls-funds","title":"Case: PULL payment (merchant pulls funds)","text":"Debit (Dr) Credit (Cr) Notes User / Payer Merchant / Payee Principal Merchant / Payee Fees Revenue Optional fee leg"},{"location":"10-payments-nucleus/specs/posting-rules/#perrail-surcharges-and-partner-fees-netting","title":"Per\u2011rail surcharges and partner fees (netting)","text":"Debit (Dr) Credit (Cr) Notes Merchant / Payee Fees Partner Partner surcharge retained by Stalela on behalf of partner Fees Partner Partner Payable Net settlement to partner at recon/settlement time <p>Netting entries reduce operational payouts; settle partner payable on statement reconciliation.</p>"},{"location":"10-payments-nucleus/specs/posting-rules/#3-transfersreturned-rail-return-chargeback","title":"3. <code>transfers.returned</code> (rail return / chargeback)","text":"Debit (Dr) Credit (Cr) Notes Merchant / Payee User / Payer Reverse principal Fees Expense Merchant / Payee Return fees absorbed"},{"location":"10-payments-nucleus/specs/posting-rules/#4-transfersfailed-technical-failure","title":"4. <code>transfers.failed</code> (technical failure)","text":"<ul> <li>No postings (transfer never finalized).</li> </ul>"},{"location":"10-payments-nucleus/specs/posting-rules/#period-closing-entries-ops","title":"Period Closing Entries (Ops)","text":"<p>At end of reporting period (see closing-the-books.md):</p> <ul> <li>Close temporary Income and Expense accounts to Retained Earnings.  </li> <li>Reconciliation must confirm balances vs external statements before close.  </li> </ul>"},{"location":"10-payments-nucleus/specs/posting-rules/#example-walkthrough","title":"Example Walkthrough","text":"<p>User pays Merchant 100 ZAR via USDC rail. Fee = 2 ZAR.</p> <ol> <li>Event: <code>transfers.settled</code></li> <li>Ledger postings:</li> </ol> Debit (Dr) Credit (Cr) Amount User Account Merchant Account 100 Merchant Account Fees Revenue 2 <p>Merchant net = 98 ZAR. System recognized 2 ZAR as revenue.</p>"},{"location":"10-payments-nucleus/specs/posting-rules/#exceptions","title":"Exceptions","text":"<ul> <li>Negative balances: only Liquidity/FX/Reserve accounts allowed.  </li> <li>Multi\u2011currency: FX legs must always be paired (gain or loss).  </li> <li>Manual journal entries require dual approval and clear memo.  </li> </ul>"},{"location":"10-payments-nucleus/specs/posting-rules/#references","title":"References","text":"<ul> <li>chart-of-accounts.md (account categories, normal balances)  </li> <li>closing-the-books.md (period cycle)  </li> <li>tax-vat.md (VAT on fees)  </li> </ul>"},{"location":"10-payments-nucleus/specs/regulatory-reporting/","title":"Regulatory Reporting (ZA/ZW)","text":"<p>Outlines BoP (SARB exchange control) and goAML (FIC/FIU) reporting interfaces.</p>"},{"location":"10-payments-nucleus/specs/regulatory-reporting/#bop-reporting-sarb","title":"BoP Reporting (SARB)","text":"<ul> <li>Scope: cross-border payments and receipts.</li> <li>Data: payer/payee, purpose codes, currency, amount, FX rate, <code>exchangeControlRef</code>.</li> <li>Frequency: daily batch; T+1 corrections.</li> <li>Interface: file/API adapter (service TBD: <code>storo-reg-reporting</code>).</li> </ul>"},{"location":"10-payments-nucleus/specs/regulatory-reporting/#goaml-strctr","title":"goAML (STR/CTR)","text":"<ul> <li>Thresholds: cash/crypto limits per jurisdiction.</li> <li>Triggers: rules over events (riskScore, amounts, patterns).</li> <li>Payload: goAML XML/JSON forms; attachments redacted.</li> <li>Submission: secure API with retry/backoff and receipt tracking.</li> </ul>"},{"location":"10-payments-nucleus/specs/regulatory-reporting/#event-additions","title":"Event Additions","text":"<ul> <li>Optional fields:</li> <li><code>exchangeControlRef</code> (string)</li> <li><code>purposeCode</code> (string)</li> </ul>"},{"location":"10-payments-nucleus/specs/regulatory-reporting/#ops-audit","title":"Ops &amp; Audit","text":"<ul> <li>Immutable submission log with receipts and timestamps.</li> <li>DLQ for failed submissions; manual replay runbook.</li> </ul> <p>Last updated: 2025-08-27</p>"},{"location":"10-payments-nucleus/specs/risk-limits/","title":"Risk Limits &amp; KYC Tiers (ZA/ZW)","text":"<p>Defines tiered onboarding and runtime velocity controls aligned to FICA (ZA) and analogous ZW regimes.</p>"},{"location":"10-payments-nucleus/specs/risk-limits/#kyc-tiers","title":"KYC Tiers","text":"<ul> <li>Tier 0 (Minimal)</li> <li>Allowed: low-value transactions; no cross-border.</li> <li>Requirements: basic identity (name, mobile), phone verification.</li> <li> <p>Limits: daily/monthly caps; no PULL.</p> </li> <li> <p>Tier 1 (Standard)</p> </li> <li>Allowed: domestic transfers; moderate limits.</li> <li>Requirements: ID/passport, selfie/biometric, address proof.</li> <li> <p>Limits: higher daily/monthly; PULL optional.</p> </li> <li> <p>Tier 2 (Enhanced)</p> </li> <li>Allowed: cross-border, higher limits.</li> <li>Requirements: full KYC, income/proof of funds; enhanced due diligence.</li> <li>Limits: bespoke per-tenant.</li> </ul>"},{"location":"10-payments-nucleus/specs/risk-limits/#runtime-controls","title":"Runtime Controls","text":"<ul> <li>Velocity: txn count and value per window (1h/24h/30d) by <code>kycTier</code>.</li> <li>Corridor: per-rail and cross-border maxima, exchange-control flags.</li> <li>Risk score gates: deny or require review above thresholds.</li> </ul>"},{"location":"10-payments-nucleus/specs/risk-limits/#contract-additions","title":"Contract Additions","text":"<ul> <li>Event enrichment fields (optional):</li> <li><code>kycTier</code>: string (T0|T1|T2)</li> <li><code>riskScore</code>: number (0-100)</li> </ul>"},{"location":"10-payments-nucleus/specs/risk-limits/#enforcement-points","title":"Enforcement Points","text":"<ul> <li>CTS pre-submit policy check using cached tier and counters.</li> <li>Compliance <code>/screen</code> returns <code>score</code> consumed by CTS.</li> <li>Directory can convey per-rail caps.</li> </ul>"},{"location":"10-payments-nucleus/specs/risk-limits/#observability","title":"Observability","text":"<ul> <li>Metrics: policy blocks, window saturation, false-positive review rate.</li> <li>Alerts: anomaly in risk-score distribution.</li> </ul> <p>Last updated: 2025-08-27</p>"},{"location":"10-payments-nucleus/specs/tax-vat/","title":"Tax &amp; VAT (ZA/ZW)","text":"<p>Guidance on tax treatment for fees and surcharges in the Stalela ledger.</p>"},{"location":"10-payments-nucleus/specs/tax-vat/#vat-basics-za","title":"VAT Basics (ZA)","text":"<ul> <li>Standard rate: 15% (as of doc date).  </li> <li>Taxable supplies: Stalela service fees typically vatable; confirm per tenant.</li> <li>Invoicing: include VAT breakdown and tax codes per line.</li> </ul>"},{"location":"10-payments-nucleus/specs/tax-vat/#zimbabwe-considerations","title":"Zimbabwe Considerations","text":"<ul> <li>Local VAT/sales tax nuances to be configured per tenant/product; document rates.</li> </ul>"},{"location":"10-payments-nucleus/specs/tax-vat/#ledger-representation","title":"Ledger Representation","text":"<ul> <li>Fees split into net and VAT components at settlement time.</li> <li>Example (ZAR): amount 100.00; fee 2.00 excl VAT; VAT 0.30 (15%).</li> </ul> <pre><code>Dr USER 100.00\nCr MERCHANT 98.00\nCr FEES_NET 2.00\nCr FEES_VAT 0.30\n</code></pre> <p>Accounts may be configured under Revenue/Tax control accounts.</p>"},{"location":"10-payments-nucleus/specs/tax-vat/#eventmetadata","title":"Event/Metadata","text":"<ul> <li>Add <code>taxCode</code> (optional) in events referencing fee lines.</li> </ul>"},{"location":"10-payments-nucleus/specs/tax-vat/#observability","title":"Observability","text":"<ul> <li>Metrics: VAT accrued/day; reconciliation with invoices.</li> </ul> <p>Last updated: 2025-08-27</p>"},{"location":"20-fiscal-platform/","title":"Stalela Technical Design Documentation","text":"<p>Stalela is a multi-jurisdiction fiscal invoicing platform that creates, validates, signs, and synchronizes invoices across different countries' fiscal mandates. The platform supports configurable tax rules, authority integrations, and compliance requirements per jurisdiction \u2014 starting with the DRC's Facture Normalis\u00e9e and expanding across Sub-Saharan Africa. Invoices are sealed by a cloud signing service backed by an HSM, then synced to the jurisdiction's tax authority while clients queue requests offline and deliver sealed receipts.</p> <p>The platform combines an API-first invoicing surface (REST + SDKs), a web dashboard, a cloud signing service backed by an HSM, and a resilient sync agent that delivers sealed invoices to each jurisdiction's tax authority. AI capabilities \u2014 natural language invoice creation, tax auto-classification, and anomaly detection \u2014 are embedded across the platform, while a public verification portal lets anyone confirm an invoice's authenticity by scanning its QR code. Each section below shows how Stalela enforces fiscal compliance while keeping the developer experience modern and familiar.</p>"},{"location":"20-fiscal-platform/#supported-jurisdictions","title":"Supported Jurisdictions","text":"Code Country Authority Status CD DR Congo DGI Active \u2014 Country Profile \u2192 ZW Zimbabwe ZIMRA Planned \u2014 Stub \u2192 KE Kenya KRA Planned \u2014 Stub \u2192 RW Rwanda RRA Planned \u2014 Stub \u2192 TZ Tanzania TRA Planned \u2014 Stub \u2192 NG Nigeria FIRS Planned \u2014 Stub \u2192 ZA South Africa SARS Planned \u2014 Stub \u2192 <p>See the full Jurisdictions Framework for details on how country profiles are structured and how to add new jurisdictions.</p>"},{"location":"20-fiscal-platform/#key-sections","title":"Key sections","text":"<ul> <li>Architecture: System overview, trust boundary, component map, and data flows that explain how client applications interact with the Cloud Signing Service, fiscal ledger, and tax authority sync agent.</li> <li>Invoicing Platform: Product overview, API walkthrough, web dashboard experience, SDKs, multi-user controls, and AI-powered capabilities including natural language invoice creation, tax auto-classification, and anomaly detection.</li> <li>Fiscal Engine: Invoice lifecycle rules, jurisdiction-configured tax groups, canonical payload schema, mandatory security elements, reports (Z/X/A/audit), and public invoice verification via QR code or fiscal number.</li> <li>Cloud &amp; Sync: Cloud architecture, offline-first sync logic, resilience to connectivity loss, and tax authority integration requirements.</li> <li>Platform &amp; Integrations: Multi-user/multi-tenant access controls, integration playbooks, and partner-ready libraries.</li> <li>Jurisdictions: Country-specific profiles containing tax groups, client classifications, invoice types, currencies, and authority integration protocols. See Jurisdictions \u2192.</li> <li>ADRs: Authoritative decisions about architecture, signing, security, and platform strategy.</li> <li>Implementation: Roadmap, Kanban Board with epic-level status, phase summaries, and execution guidance for shipping the software invoicing platform.</li> <li>API Reference: Open endpoints for invoice creation, listing, voiding, and refunding, plus SDK guidance for integrating with Stalela.</li> </ul>"},{"location":"20-fiscal-platform/#phase-roadmap-summary","title":"Phase roadmap summary","text":"<ol> <li>Phase 1 \u2013 Software Invoicing: API-first invoicing platform with cloud fiscal signing, tax engine coverage, and dashboard controls.</li> <li>Phase 2 \u2013 POS &amp; Retail: Multi-terminal retail/restaurant extensions with optional local fiscal services that coordinate with the cloud.</li> <li>Phase 3 \u2013 USB Hardware: Optional USB Fiscal Memory device for DEF homologation, serving as a trust anchor for high-compliance merchants.</li> <li>Phase 4 \u2013 Enterprise: ERP integrations, analytics, and scaling across outlets, fleets, and geographies.</li> </ol>"},{"location":"20-fiscal-platform/#design-principles-inspired-by-field-research","title":"Design principles (inspired by field research)","text":"<ul> <li>Offline-first confidence: Clients can cache catalogs and queue requests, but fiscal finality is achieved via the cloud signing service once connectivity returns.</li> <li>PWA-friendly: Build the dashboard and POS clients as progressive web apps that load fast, work across devices, and feel native on tablets.</li> <li>Mobile-optimized: Prioritize the lowest-cost Android tablets, large touch targets, and minimal text entry so merchant staff can move quickly.</li> <li>Multi-currency: Each jurisdiction declares its supported currencies and rounding rules. DRC supports CDF/USD dual-currency; other jurisdictions declare their own.</li> <li>Mobile money native: Embed jurisdiction-specific mobile money providers (Airtel Money, M-Pesa, Orange Money, EcoCash, etc.) into the payment flow as first-class citizens.</li> <li>Jurisdiction-configurable: Tax groups, client classifications, invoice types, currency rounding, and authority sync protocols are all driven by the active jurisdiction profile.</li> </ul>"},{"location":"20-fiscal-platform/#how-to-use-this-documentation","title":"How to use this documentation","text":"<ol> <li>Start with the Architecture section to internalize the trust boundary between untrusted clients and the Cloud Signing Service.</li> <li>Explore the Invoicing Platform, Fiscal Engine, and Cloud &amp; Sync pages to understand the lifecycle of a sealed invoice.</li> <li>Check the Jurisdictions section for country-specific tax groups, client classifications, and authority integration details.</li> <li>Consult the ADR folder when you need compliance rationale or formal decisions.</li> <li>Drop into Implementation and API Reference when planning integrations, rollouts, or partner onboarding.</li> </ol>"},{"location":"20-fiscal-platform/adr/","title":"Architecture Decision Records","text":"<p>The ADR process</p> <p>Architectural Decision Records (ADRs) capture important design trade-offs so the team can revisit the reasoning long after a decision is made. 1. Draft the full record in <code>docs/adr/</code> with the canonical template (Context \u2192 Decision \u2192 Consequences \u2192 References). 2. Link the ADR to the relevant design area (architecture, cloud, fiscal, etc.) and include status badges (<code>Accepted</code>, <code>Proposed</code>, <code>Superseded</code>). 3. Raise a new ADR as soon as a decision affects the trust boundary, protocol, signing infrastructure, or regulatory compliance; reference the implementation plan task that triggered it.</p>"},{"location":"20-fiscal-platform/adr/#current-decisions","title":"Current decisions","text":"ADR Status Summary FIS-ADR-0001: Two-Phase Commit Accepted Enforces the 2PC PREPARE \u2192 COMMIT handshake for the USB Fiscal Memory device protocol. Relevant to Phase 3 (USB Hardware). FIS-ADR-0002: Signature Algorithm Selection Accepted Adopts ECDSA P-256 for all invoice signatures \u2014 used by both the Cloud Signing Service (HSM) and the USB Fiscal Memory device (Phase 3). FIS-ADR-0003: Platform Technology Stack Accepted Selects REST API + Web Dashboard + Client SDKs (JavaScript / Python) as the platform stack, replacing the original PWA + local fiscal daemon architecture. FIS-ADR-0004: Cloud Fiscal Signing (HSM) Accepted Adopts an HSM-backed Cloud Signing Service as the primary fiscal authority for Phase 1+, with the USB Fiscal Memory device as an optional alternative signer in Phase 3. FIS-ADR-0005: Strategic Pivot \u2014 API-First Accepted Documents the decision to pivot from POS-hardware-first to an API-first invoicing platform with phased hardware introduction. FIS-ADR-0006: Delegated Offline Token Architecture Accepted Introduces a Delegated Offline Token model (Verifiable Credentials + Browser Extension + Block Allocation) for Phase 1.5 to enable offline retail signing. <p>Add new ADRs by copying this page, updating the table, and linking to the supporting docs. Keep the \"Status\" column in sync with the implementation plan so readers can trace acceptance and deployment milestones.</p>"},{"location":"20-fiscal-platform/adr/FIS-ADR-0001/","title":"ADR 0001 - Two-Phase Commit","text":"<p>Coming soon</p> <p>This document will be populated as the technical design matures.</p>"},{"location":"20-fiscal-platform/adr/FIS-ADR-0002/","title":"ADR-0002: Signature Algorithm Selection","text":""},{"location":"20-fiscal-platform/adr/FIS-ADR-0002/#status","title":"Status","text":"<p>Accepted</p>"},{"location":"20-fiscal-platform/adr/FIS-ADR-0002/#context","title":"Context","text":"<ul> <li>The USB Fiscal Memory device and its Secure Element are the only components that ever see the private signing key (design/docs/hardware/secure-element.md). Nothing outside the SE can derive, export, or clone this key, so the algorithm must be supported inside the sealed chip.</li> <li>The Secure Element review already evaluated ECDSA P-256 versus Ed25519 and concluded that the family we selected (ATECC608B / SE050) already accelerates P-256 and matches the curve used on existing fiscal certificates. Ed25519 is treated as a future-proof option pending regulatory and vendor certification, while RSA is too heavy for the MCU (design context + DISCUSSION.md lines 7285-7400 explain why hardware is mandated).</li> <li>The DGI has not published a mandatory signature algorithm, but inspectors expect curves compatible with earlier fiscal memories and want minimal signature payloads on receipts.</li> </ul>"},{"location":"20-fiscal-platform/adr/FIS-ADR-0002/#options","title":"Options","text":"<ol> <li>ECDSA P-256 (current baseline) </li> <li>Pros: Hardware acceleration available in ATECC608B/SE050; produces 64-byte signatures that fit on receipts and QR codes; aligns with curves used in existing fiscal certificates; familiar to auditors.  </li> <li> <p>Cons: Requires careful nonce and counter governance inside the SE, but that logic already exists.</p> </li> <li> <p>Ed25519 (future option) </p> </li> <li>Pros: Smaller signature size (64 bytes) with faster signing on modern SEs; better resilience to some side-channel attacks; easier canonicalization.  </li> <li> <p>Cons: Not yet certified by the SE vendor for our hardware, and the DGI has not approved the curve; adopting it would force a platform change and additional regulatory work.</p> </li> <li> <p>RSA-2048 </p> </li> <li>Pros: Very mature and widely understood by regulators.  </li> <li>Cons: Signature payloads are large (&gt; 256 bytes), which burdens QR codes and receipts; signing performance is poor on constrained MCUs; the SEs we selected (ATECC608B/SE050) are optimized for ECC, not RSA.</li> </ol>"},{"location":"20-fiscal-platform/adr/FIS-ADR-0002/#rationale","title":"Rationale","text":"<p>ECDSA P-256 is the most practical choice today because it is natively accelerated by the Secure Element family we already selected, matches the public curve seen in the current fiscal authorities\u2019 certificates, and keeps signature sizes manageable for receipts and QR codes (design/docs/hardware/secure-element.md). The activation flow (<code>CFG|INIT</code>) and journal signing flow already assume this curve, so switching algorithms would require new protocol definitions and resets of the counter/nonce governance. Ed25519 remains a candidate for later phases once the vendor and DGI certify support, while RSA is ruled out because of its performance and payload penalties.</p>"},{"location":"20-fiscal-platform/adr/FIS-ADR-0002/#decision","title":"Decision","text":"<p>Adopt ECDSA P-256 as the signature algorithm for all invoices signed by the USB Fiscal Memory device. The SE will generate the key pair on-device, enforce the PREPARE \u2192 COMMIT lifecycle, and never expose the private key.</p>"},{"location":"20-fiscal-platform/adr/FIS-ADR-0002/#consequences","title":"Consequences","text":"<ul> <li>Downstream systems (receipts, cloud, auditors) can rely on 64-byte signatures produced by the SE and validated against the public certificate presented during <code>QRY|STATUS</code>.</li> <li>If future hardware or regulatory changes require another curve (e.g., Ed25519), we will document the migration in a new ADR and revise the USB protocol accordingly, including updates to nonce expiry and journal verification logic.</li> </ul>"},{"location":"20-fiscal-platform/adr/FIS-ADR-0003/","title":"ADR-0003: Platform Technology Stack","text":""},{"location":"20-fiscal-platform/adr/FIS-ADR-0003/#decision-2026-02-17-revised-2026-06-01","title":"Decision - 2026-02-17 (revised 2026-06-01)","text":"<p>Decision: Build Stalela as a cloud-first invoicing platform with a REST API, web dashboard, and client SDKs (JavaScript / Python) \u2014 replacing the original PWA + local fiscal daemon architecture that assumed USB hardware from day one.</p> <p>Context: - The strategic pivot (see ADR-0005) moves Stalela from a POS-hardware-first product to an API-first invoicing platform (think Stripe Invoices for DRC fiscal compliance). Phase 1 targets B2B service companies, wholesalers, and schools that need sealed fiscal invoices without deploying POS terminals or USB devices. - The Cloud Signing Service (HSM) is the trusted fiscal authority in Phase 1. Client applications are untrusted \u2014 they submit canonical payloads and receive sealed responses containing fiscal numbers, signatures, timestamps, and QR codes. - The platform must support two client surfaces from launch: a REST API for programmatic integrations and a web dashboard for manual invoice management. - Offline-first remains non-negotiable: client apps queue unsigned drafts locally (IndexedDB/Service Worker for web, SQLite for SDKs) and submit them when connectivity returns. Fiscalization only happens in the cloud. - Phase 2 adds POS terminals as API consumers. Phase 3 optionally introduces the USB Fiscal Memory device (DEF) as an alternative signer. The technology stack must accommodate these future layers without rearchitecture.</p> <p>Options: 1. REST API + Web Dashboard + Client SDKs (selected)    - Pros: Fastest path to market for B2B pilot. REST API is universally understood and integrates with any language or ERP. Web dashboard provides immediate value without installation. SDKs (JavaScript, Python) abstract API complexity and enable offline queuing. Cloud HSM centralizes the trust boundary \u2014 no local daemon needed for Phase 1.    - Cons: Requires cloud infrastructure from day one (HSM, database, sync agent). No offline fiscalization until Phase 3 introduces the DEF.</p> <ol> <li>PWA + Local Fiscal Daemon (original architecture)</li> <li>Pros: Enables offline fiscalization via the USB device. Single codebase runs on tablets, phones, and desktops.</li> <li> <p>Cons: Requires USB hardware from day one, which delays market entry. Local daemon adds deployment complexity. Not suitable for API-first B2B integrations (service companies, schools). Assumes POS UX that most Phase 1 customers don't need.</p> </li> <li> <p>GraphQL API instead of REST</p> </li> <li>Pros: Flexible querying for complex invoice structures. Single endpoint simplifies versioning.</li> <li> <p>Cons: Adds complexity for simple CRUD operations. Tooling ecosystem is smaller in the DRC developer community. Over-engineering for the current feature set.</p> </li> <li> <p>Mobile-first native apps (iOS/Android)</p> </li> <li>Pros: Best mobile UX. Direct access to device hardware (camera for QR scanning, NFC).</li> <li>Cons: Two codebases to maintain. App store distribution delays updates. Most Phase 1 customers (B2B) prefer web/API access over mobile apps.</li> </ol> <p>Rationale: The REST API + Web Dashboard + SDKs stack aligns with the API-first strategy. It delivers the fastest path to the B2B pilot (Phase 1) without requiring USB hardware or POS terminals. The cloud HSM centralizes the trust boundary, eliminating the need for a local fiscal daemon in Phase 1. JavaScript and Python SDKs cover the majority of integration scenarios in the DRC market. The web dashboard (built as a standard SPA) provides immediate value for merchants who prefer manual invoice management. This stack naturally extends to Phase 2 (POS terminals become API consumers) and Phase 3 (USB device proxy communicates with the same Cloud API).</p> <p>Impact: - Cloud infrastructure (HSM, PostgreSQL, Redis, message queue) must be provisioned and secured from Phase 1. - REST API design follows the canonical payload contract documented in <code>api/cloud.md</code>. - Web dashboard is a standard SPA (React or Vue) that consumes the same REST API as external integrators. - SDKs implement offline queuing (IndexedDB/SQLite), idempotency (payload hash + <code>Idempotency-Key</code> header), and automatic retry logic. - The local fiscal daemon from the original architecture is deferred to Phase 3 as the USB Device Proxy, scoped to outlets that opt into DEF signing.</p> <p>Review: Reevaluate if Phase 1 pilot feedback indicates that offline fiscalization (without cloud connectivity) is a hard requirement for the initial market segment, which would accelerate Phase 3 USB hardware delivery.</p>"},{"location":"20-fiscal-platform/adr/FIS-ADR-0004/","title":"ADR-0004: Cloud Fiscal Signing (HSM)","text":""},{"location":"20-fiscal-platform/adr/FIS-ADR-0004/#status","title":"Status","text":"<p>Accepted (Amended by ADR-0006 for offline retail signing)</p>"},{"location":"20-fiscal-platform/adr/FIS-ADR-0004/#context","title":"Context","text":"<ul> <li>The DRC's Facture Normalis\u00e9e regime requires every commercial invoice to carry five security elements: sequential fiscal number, fiscal authority ID, cryptographic authentication code, trusted timestamp, and QR code (see <code>fiscal/security-elements.md</code>).</li> <li>The original architecture assumed that a USB Fiscal Memory device (DEF) would generate these elements locally at each point of sale. This approach requires hardware procurement, firmware development, DGI homologation, and physical deployment to every merchant outlet before any invoices can be sealed \u2014 a 9\u201312 month critical path.</li> <li>Stalela's Phase 1 targets B2B service companies, wholesalers, and schools that generate invoices from web dashboards and API integrations. These users do not operate POS terminals and have no need for local USB hardware.</li> <li>An HSM-backed cloud signing service can deliver the same five security elements without requiring local hardware. The Cloud Signing Service becomes the trusted fiscal authority: it assigns fiscal numbers via a Monotonic Counter Manager, signs payloads with ECDSA P-256 keys stored in the HSM, generates trusted timestamps from NTP-synced infrastructure, and produces verification QR codes.</li> </ul>"},{"location":"20-fiscal-platform/adr/FIS-ADR-0004/#options","title":"Options","text":"<ol> <li>Cloud Signing Service (HSM) as primary fiscal authority (selected)</li> <li>Pros: Zero hardware dependency for Phase 1. Fastest path to market. Centralized key management eliminates key distribution complexity. Monotonic Counter Manager with serializable database isolation guarantees sequential fiscal numbering even under concurrent multi-terminal load. Cloud HSMs (AWS CloudHSM, Azure Dedicated HSM, or self-hosted) provide FIPS 140-2 Level 3 key protection. All fiscalization logic is centralized, simplifying audits.</li> <li> <p>Cons: Requires internet connectivity for fiscalization (mitigated by offline queuing \u2014 unsigned drafts are submitted when connectivity returns). Cloud infrastructure must be highly available and secure. No offline fiscalization until Phase 3 introduces the optional DEF.</p> </li> <li> <p>USB Fiscal Memory device (DEF) as day-one requirement (original architecture)</p> </li> <li>Pros: Enables offline fiscalization at the point of sale. Aligns with traditional DGI expectations for hardware-based fiscal memory. Keys never leave the device.</li> <li> <p>Cons: 9\u201312 month delay for firmware development, supply chain, and DGI homologation. Per-device cost ($10\u201315 BOM) creates a barrier for B2B pilot. Not needed by Phase 1's target segment (service companies, schools). Physical deployment and maintenance complexity in DRC conditions.</p> </li> <li> <p>Software-only signing (no HSM)</p> </li> <li>Pros: Simplest implementation \u2014 signing keys stored in application memory or encrypted at rest.</li> <li>Cons: Keys are exposed to the application runtime, violating the trust boundary principle. No hardware-backed key protection. Would not satisfy DGI expectations for tamper-resistant signing. Unacceptable security posture for fiscal infrastructure.</li> </ol>"},{"location":"20-fiscal-platform/adr/FIS-ADR-0004/#decision","title":"Decision","text":"<p>Adopt an HSM-backed Cloud Signing Service as the primary fiscal authority for Phase 1 (and beyond). The Cloud Signing Service:</p> <ul> <li>Stores ECDSA P-256 signing keys inside an HSM boundary; keys never leave the HSM.</li> <li>Assigns sequential fiscal numbers via the Monotonic Counter Manager using serializable database isolation (<code>SELECT ... FOR UPDATE</code> within a serializable transaction).</li> <li>Signs canonical payloads and returns sealed responses containing all five security elements.</li> <li>Generates verification QR codes encoding <code>fiscal_number</code>, <code>auth_code</code>, <code>timestamp</code>, and verification URL.</li> <li>Writes every sealed invoice to the append-only, hash-chained Fiscal Ledger.</li> </ul> <p>In Phase 3, the USB Fiscal Memory device (DEF) is introduced as an optional alternative signer for merchants requiring DGI hardware homologation. Both signers produce structurally identical sealed responses and write to the same Fiscal Ledger.</p>"},{"location":"20-fiscal-platform/adr/FIS-ADR-0004/#consequences","title":"Consequences","text":"<ul> <li>Client applications (web dashboard, REST API, SDKs) are untrusted. They submit canonical payloads and receive sealed responses. They may display security elements but never fabricate them.</li> <li>Internet connectivity is required for fiscalization. Clients queue unsigned drafts locally (IndexedDB, SQLite) and submit them when online. The Cloud Signing Service is the only entity that can produce valid fiscal numbers and signatures.</li> <li>Cloud HSM infrastructure must meet high availability targets (99.9%+ uptime). Key ceremony, backup, and rotation procedures must be documented.</li> <li>The Monotonic Counter Manager must handle concurrent requests from multiple outlets without producing gaps or duplicates in fiscal numbering sequences.</li> <li>Phase 3's USB Device Proxy communicates with the same Cloud API, routing payloads to the local DEF instead of the Cloud HSM based on outlet configuration.</li> <li>If the DGI mandates hardware-based signing for all merchants (not just those seeking DEF homologation), Phase 3 delivery must be accelerated.</li> </ul>"},{"location":"20-fiscal-platform/adr/FIS-ADR-0004/#review","title":"Review","text":"<p>Reevaluate if: (1) the DGI publishes regulations that explicitly require hardware-based signing for all merchants, (2) Phase 1 pilot merchants report that cloud-only connectivity is insufficient for their operations, or (3) HSM infrastructure costs exceed projections and a hybrid approach becomes more economical.</p>"},{"location":"20-fiscal-platform/adr/FIS-ADR-0005/","title":"ADR-0005: Strategic Pivot \u2014 API-First Invoicing Platform","text":""},{"location":"20-fiscal-platform/adr/FIS-ADR-0005/#status","title":"Status","text":"<p>Accepted</p>"},{"location":"20-fiscal-platform/adr/FIS-ADR-0005/#context","title":"Context","text":"<ul> <li>Stalela was originally designed as a POS-hardware-first product: a Progressive Web App paired with a USB Fiscal Memory device (DEF) at every point of sale. The USB device was the trusted fiscal authority, signing invoices locally via the PREPARE \u2192 COMMIT protocol. The cloud layer existed primarily to sync sealed invoices to the DGI.</li> <li>After initial design work (42-task implementation plan, UX wireframes, hardware specifications, protocol definitions), the team concluded that the hardware-first approach created an unacceptable time-to-market delay:<ul> <li>USB firmware development, secure element integration, and DGI homologation require 9\u201312 months before any merchant can issue a single fiscal invoice.</li> <li>Per-device BOM cost ($10\u201315) and physical deployment logistics create barriers for the initial pilot.</li> <li>The Phase 1 target segment (B2B service companies, wholesalers, schools) generates invoices from accounting software and web interfaces \u2014 they do not operate POS terminals and have no use for USB hardware.</li> </ul> </li> <li>Competitor analysis shows that similar fiscal compliance platforms in other markets (Rwanda's EBM, Kenya's TIMS) have succeeded with cloud-first approaches, adding hardware options later for specific retail segments.</li> </ul>"},{"location":"20-fiscal-platform/adr/FIS-ADR-0005/#options","title":"Options","text":"<ol> <li>Pivot to API-first invoicing platform with phased hardware introduction (selected)</li> <li>Phase 1: Cloud Signing Service (HSM) as the trusted fiscal authority. REST API + web dashboard + SDKs for B2B pilot.</li> <li>Phase 2: Add POS SDK and mobile money for retail segment. POS terminals are API consumers, not USB mediators.</li> <li>Phase 3: Introduce USB Fiscal Memory device (DEF) as an optional alternative signer for merchants requiring DGI hardware homologation.</li> <li>Phase 4: Enterprise features \u2014 ERP connectors, fleet management, analytics.</li> <li>Pros: Fastest path to market (3 months to Phase 1 pilot). Addresses the largest segment first (B2B). Cloud HSM delivers the same five security elements without hardware. USB hardware remains available for merchants that need it.</li> <li> <p>Cons: No offline fiscalization until Phase 3. Requires cloud infrastructure investment from day one.</p> </li> <li> <p>Continue with hardware-first approach (original plan)</p> </li> <li>Pros: Offline fiscalization from day one. Full DGI hardware compliance.</li> <li> <p>Cons: 9\u201312 month delay. Hardware supply chain risk. Misaligned with Phase 1 target segment. Higher upfront capital required.</p> </li> <li> <p>Hybrid: ship cloud and hardware in parallel</p> </li> <li>Pros: Both segments addressed simultaneously.</li> <li>Cons: Doubles the team's focus and development surface. Risk of shipping neither well. Same hardware timeline constraints apply.</li> </ol>"},{"location":"20-fiscal-platform/adr/FIS-ADR-0005/#decision","title":"Decision","text":"<p>Pivot Stalela from a POS-hardware-first product to an API-first fiscal invoicing platform (think Stripe Invoices for DRC). The phasing is:</p> Phase Name Duration Trust anchor 1 Software Invoicing 3 months Cloud Signing Service (HSM) 2 POS &amp; Retail 3 months Cloud Signing Service (HSM) 3 USB Hardware 6 months Cloud HSM + optional DEF 4 Enterprise &amp; Integrations 6 months Cloud HSM + optional DEF <p>The Cloud Signing Service (HSM) is the primary fiscal authority from Phase 1 onward. The USB Fiscal Memory device becomes an optional trust anchor in Phase 3, not a prerequisite. All hardware design documents are preserved in <code>docs-archive/hardware/</code> for Phase 3 reference.</p>"},{"location":"20-fiscal-platform/adr/FIS-ADR-0005/#consequences","title":"Consequences","text":"<ul> <li>Architecture: The cloud is the trusted half; client apps are untrusted. The Cloud Signing Service, Fiscal Ledger, and Monotonic Counter Manager are the core fiscal components. The USB device proxy is deferred to Phase 3.</li> <li>Documentation: All existing docs are rewritten for the cloud-first model. POS-specific docs (<code>pos/multi-terminal.md</code>, <code>pos/ui-ux.md</code>, <code>pos/integrations.md</code>, <code>api/pos-plugin.md</code>) are archived to <code>docs-archive/</code>. ADR-0003 is revised from \"POS Technology Stack\" to \"Platform Technology Stack.\"</li> <li>Product identity: Stalela is positioned as fiscal invoicing infrastructure (like Stripe Invoices), not a POS system. Marketing, sales, and documentation reflect this identity.</li> <li>Risk: If the DGI mandates hardware-based fiscal signing for all merchants before Phase 3, the USB development timeline must be accelerated. The cloud-first architecture is designed to accommodate the DEF as a drop-in alternative signer without rearchitecture.</li> <li>Team focus: Phase 1 development focuses entirely on cloud infrastructure, REST API, web dashboard, and SDKs. No hardware or firmware work until Phase 3.</li> </ul>"},{"location":"20-fiscal-platform/adr/FIS-ADR-0005/#review","title":"Review","text":"<p>Reevaluate if: (1) Phase 1 pilot feedback reveals that the target segment requires offline fiscalization (Note: This trigger was activated, leading to ADR-0006 for Delegated Offline Signing), (2) the DGI publishes regulations mandating hardware-only fiscal signing, or (3) a competitor captures the B2B segment before Stalela reaches market.</p>"},{"location":"20-fiscal-platform/adr/FIS-ADR-0006/","title":"ADR-0006: Delegated Offline Token Architecture","text":"<p>Date: 2026-02-21 Status: Accepted Phase: Phase 1.5 (Fast-Follow to Phase 1)</p>"},{"location":"20-fiscal-platform/adr/FIS-ADR-0006/#context","title":"Context","text":"<p>In Phase 1, Stalela relies entirely on the Cloud Signing Service (HSM) to generate fiscal numbers, signatures, and QR payloads. The original design assumed that if a client (e.g., a web dashboard) lost internet connectivity, it would queue \"unsigned drafts\" locally and submit them for fiscalization once connectivity returned.</p> <p>However, a deep review of the DRC regulatory framework (specifically Arr\u00eat\u00e9 033) revealed a critical compliance gap: physical receipts handed to customers in a retail environment must contain the fiscal signature and QR code at the moment of sale. A strategy of queuing unsigned drafts is legally incompatible with B2C physical retail.</p> <p>To solve this, we need a way for Point of Sale (POS) terminals to sign invoices offline. We evaluated several approaches: 1. Pure PWA (Web Crypto API): Storing private keys in the browser's <code>localStorage</code> or IndexedDB is vulnerable to XSS (Cross-Site Scripting) attacks, where malicious JavaScript could extract or misuse the key. 2. WebAuthn (Passkeys): Highly secure (uses the device's Secure Enclave), but requires a biometric prompt (FaceID/TouchID) for every single signature. This introduces unacceptable UX friction for fast-paced retail. 3. Native Desktop App (Local Fiscal Daemon): Secure (can use OS TPM) and silent, but introduces significant deployment friction (installing <code>.exe</code> files) and is vulnerable to merchants deleting the local SQLite database to erase offline cash sales. 4. Phase 3 USB Hardware: The ultimate solution, but hardware homologation in the DRC can take 18-24 months, blocking our entry into the retail market.</p>"},{"location":"20-fiscal-platform/adr/FIS-ADR-0006/#decision","title":"Decision","text":"<p>We will implement a Delegated Offline Token Architecture as a Phase 1.5 fast-follow, combining principles from Self-Sovereign Identity (Verifiable Credentials), Browser Extensions (the MetaMask pattern), and HOTP (Block Allocation).</p> <ol> <li>Delegated Credentials (Verifiable Credentials): Instead of the POS holding the master Cloud HSM key, the Cloud HSM issues a short-lived (e.g., 12-hour) \"Delegated Private Key\" to the POS terminal when it is online.</li> <li>The Fiscal Extension (MetaMask Pattern): To protect this delegated key from XSS attacks on the PWA, the key is stored inside a dedicated Stalela Chrome Extension. The extension runs in an isolated sandbox. The cashier unlocks the extension once per shift with a PIN. The PWA sends invoice payloads to the extension, which silently auto-signs them (only if the request originates from the trusted <code>pos.stalela.cd</code> domain).</li> <li>Block Allocation (HOTP Pattern): To prevent merchants from deleting local databases to hide sales, the Cloud HSM allocates a strict, sequential block of fiscal numbers (e.g., #1000 to #1500) along with the Delegated Credential. If the merchant deletes their local data and reconnects, the Cloud detects the missing block and flags the outlet for a tax audit.</li> <li>Reconciliation: When connectivity returns, the POS submits the locally-sealed invoices to the Cloud. The Cloud verifies the signatures against the Delegated Credential and appends them to the Hash-Chained Fiscal Ledger.</li> </ol>"},{"location":"20-fiscal-platform/adr/FIS-ADR-0006/#consequences","title":"Consequences","text":""},{"location":"20-fiscal-platform/adr/FIS-ADR-0006/#positive","title":"Positive","text":"<ul> <li>Regulatory Compliance: Allows Stalela to serve physical retail merchants in compliance with Arr\u00eat\u00e9 033 without waiting for Phase 3 hardware.</li> <li>UX: Zero per-transaction friction (silent auto-signing) after the initial shift unlock.</li> <li>Security: Drastically reduces the blast radius of a compromised key (limited to 12 hours and a specific block of invoices). XSS immunity via extension isolation.</li> <li>Tamper Detection: Block allocation prevents the \"Local Daemon Deletion\" vulnerability.</li> </ul>"},{"location":"20-fiscal-platform/adr/FIS-ADR-0006/#negative","title":"Negative","text":"<ul> <li>Deployment Friction: Merchants must install a Chrome Extension, which is slightly more complex than a pure PWA.</li> <li>Architectural Complexity: Introduces a new trust mode (\"semi-trusted delegated signer\"), a new Credential Issuer service, and a complex reconciliation pipeline for offline-signed invoices.</li> <li>Ledger Forking: Requires careful handling of hash-chain forks if offline signing conflicts occur.</li> </ul>"},{"location":"20-fiscal-platform/adr/FIS-ADR-0006/#review-trigger","title":"Review Trigger","text":"<p>This decision should be reviewed if: * The DGI explicitly rejects software-based delegated signing and mandates hardware (accelerating Phase 3). * The DGI publishes the MCF/e-MCF API specification, and it fundamentally conflicts with our reconciliation model.</p>"},{"location":"20-fiscal-platform/api/cloud/","title":"Cloud API Reference","text":"<p>The Stalela Cloud API is the primary interface for creating fiscalized invoices, querying their status, generating reports, and managing outlets. All client applications (web dashboard, REST API consumers, SDKs) interact with the platform through this API.</p> <p>Security by design</p> <p>All endpoints require TLS 1.3+, <code>Authorization: Bearer &lt;api_key&gt;</code>, and the <code>X-Bono-Outlet-ID</code> header to scope requests to a specific outlet. Never accept payloads with missing canonical fields or unauthorized API keys.</p>"},{"location":"20-fiscal-platform/api/cloud/#key-endpoints","title":"Key Endpoints","text":"Endpoint Method Purpose Response highlights <code>/api/v1/invoices</code> POST Submit a canonical payload for fiscalization <code>fiscal_number</code>, <code>auth_code</code>, <code>timestamp</code>, <code>qr_payload</code> <code>/api/v1/invoices/reconcile</code> POST Reconcile locally-sealed invoices (Phase 1.5) Array of reconciliation results <code>/api/v1/credentials/provision</code> POST Request Delegated Credential &amp; block (Phase 1.5) <code>vc_jwt</code>, <code>block_start</code>, <code>block_end</code>, <code>ttl</code> <code>/api/v1/invoices/{fiscal_number}</code> GET Retrieve a sealed invoice Full sealed payload + <code>dgi_status</code> <code>/api/v1/invoices/batch</code> POST Submit multiple payloads in one request Array of sealed responses <code>/api/v1/invoices/{fiscal_number}/status</code> GET Check DGI sync status <code>dgi_status</code>, <code>acknowledged_at</code> <code>/api/v1/outlets</code> POST Register a new outlet <code>outlet_id</code>, <code>fiscal_authority_id</code> <code>/api/v1/outlets/{outlet_id}/status</code> GET Check outlet health and counter <code>next_fiscal_number</code>, <code>pending_sync</code>, <code>status</code> <code>/api/v1/reports</code> POST Generate Z/X/A reports <code>report_id</code>, <code>download_url</code> <code>/api/v1/audit/export</code> GET Download hash-chained journal exports <code>ledger_hash</code>, <code>entries</code>, signed downloads <code>/api/v1/webhooks</code> POST Register a webhook endpoint <code>webhook_id</code>, <code>events</code>, <code>active</code> <code>/api/v1/api-keys</code> POST Create a scoped API key <code>api_key_id</code>, <code>key</code>, <code>scopes</code> <code>/api/v1/verify/{fiscal_number}</code> GET Public \u2014 verify a sealed invoice by fiscal number + auth code <code>status</code>, <code>signature_valid</code>, <code>dgi_status</code> <code>/api/v1/verify/qr</code> POST Public \u2014 verify by QR payload data Same as above <code>/api/v1/verify/batch</code> POST Bulk-verify multiple invoices (authenticated) Array of verification results <p>Specification reference</p> <p>The endpoint request/response schema definitions are based on <code>spec/design-cloud-api-1.md</code> (project root).</p>"},{"location":"20-fiscal-platform/api/cloud/#example-create-invoice","title":"Example: Create Invoice","text":"<pre><code>POST /api/v1/invoices\nContent-Type: application/json\nAuthorization: Bearer bono_key_abc123\nX-Bono-Outlet-ID: OUTLET-001\nIdempotency-Key: hash_of_canonical_payload\n\n{\n  \"invoice_type\": \"sale\",\n  \"merchant_nif\": \"123456789\",\n  \"client\": {\n    \"name\": \"Acme Ltd\",\n    \"nif\": \"987654321\",\n    \"classification\": \"company\"\n  },\n  \"items\": [\n    {\n      \"sku\": \"SKU-001\",\n      \"description\": \"Consulting service\",\n      \"quantity\": 1,\n      \"unit_price\": 100000,\n      \"tax_group\": \"TG03\"\n    }\n  ],\n  \"tax_groups\": [\n    { \"code\": \"TG03\", \"base_amount\": 100000, \"rate\": 0.16, \"tax_amount\": 16000 }\n  ],\n  \"totals\": {\n    \"subtotal\": 100000,\n    \"tax\": 16000,\n    \"total\": 116000,\n    \"currency\": \"CDF\"\n  },\n  \"payments\": [\n    { \"method\": \"bank_transfer\", \"amount\": 116000, \"reference\": \"TXN-789\" }\n  ]\n}\n</code></pre> <p>Response (201 Created):</p> <pre><code>{\n  \"fiscal_number\": \"BONO-OUTLET001-000123\",\n  \"fiscal_authority_id\": \"HSM-CLUSTER-01\",\n  \"auth_code\": \"MEUCIQD8j2w8s...\",\n  \"timestamp\": \"2026-02-17T03:00:00Z\",\n  \"qr_payload\": \"https://verify.stalela.cd/i?hash=...\",\n  \"dgi_status\": \"pending_sync\",\n  \"submitted_by\": {\n    \"type\": \"api_key\",\n    \"id\": \"KEY-abc123\"\n  }\n}\n</code></pre>"},{"location":"20-fiscal-platform/api/cloud/#example-generate-report","title":"Example: Generate Report","text":"<pre><code>POST /api/v1/reports\nContent-Type: application/json\nAuthorization: Bearer bono_key_abc123\nX-Bono-Outlet-ID: OUTLET-001\n\n{\n  \"type\": \"Z\",\n  \"period\": { \"date\": \"2026-02-17\" },\n  \"include_ledger_hash\": true\n}\n</code></pre> <p>Response (200 OK):</p> <pre><code>{\n  \"report_id\": \"RPT-Z-OUTLET001-2026-02-17\",\n  \"type\": \"Z\",\n  \"download_url\": \"/api/v1/reports/RPT-Z-OUTLET001-2026-02-17/download\",\n  \"generated_at\": \"2026-02-17T23:58:30Z\",\n  \"ledger_hash\": \"3F9B-7A12-...\"\n}\n</code></pre>"},{"location":"20-fiscal-platform/api/cloud/#example-outlet-registration","title":"Example: Outlet Registration","text":"<pre><code>POST /api/v1/outlets\nContent-Type: application/json\nAuthorization: Bearer bono_owner_key\n\n{\n  \"merchant_nif\": \"123456789\",\n  \"name\": \"Acme Kinshasa Branch\",\n  \"address\": \"123 Boulevard du 30 Juin, Kinshasa\"\n}\n</code></pre> <p>Response (201 Created):</p> <pre><code>{\n  \"outlet_id\": \"OUTLET-001\",\n  \"fiscal_authority_id\": \"HSM-CLUSTER-01\",\n  \"next_fiscal_number\": 1,\n  \"status\": \"active\"\n}\n</code></pre>"},{"location":"20-fiscal-platform/api/cloud/#monitoring-endpoints","title":"Monitoring endpoints","text":"Endpoint Purpose <code>GET /api/v1/outlets/{outlet_id}/status</code> Returns sync health, pending invoice count, next fiscal number, and platform status. <code>GET /api/v1/sync/status</code> Exposes aggregate sync pipeline health: backlog, state, next retry timestamp. <code>GET /api/v1/audit/export</code> Returns the hash-chained Fiscal Ledger with signed <code>ledger_hash</code> plus downloadable artifacts for auditors."},{"location":"20-fiscal-platform/api/cloud/#error-handling","title":"Error handling","text":"Scenario HTTP status Error code Notes Invalid canonical payload 400 <code>INVALID_PAYLOAD</code> Missing required fields or tax group validation failure. Invalid signature / auth 401 <code>UNAUTHORIZED</code> API key invalid, expired, or revoked. Insufficient permissions 403 <code>INSUFFICIENT_PERMISSIONS</code> API key lacks the required scope for this operation. Outlet not found 404 <code>OUTLET_NOT_FOUND</code> The <code>X-Bono-Outlet-ID</code> does not match a registered outlet. Duplicate request 409 <code>DUPLICATE_PAYLOAD</code> <code>Idempotency-Key</code> matches an already-sealed invoice; returns the existing sealed response. Rate limit exceeded 429 <code>RATE_LIMIT_EXCEEDED</code> Retry after the duration specified in <code>Retry-After</code> header."},{"location":"20-fiscal-platform/api/cloud/#rate-limiting","title":"Rate limiting","text":"<ul> <li>Default: 100 requests/second per API key.</li> <li>Burst: up to 200 requests in a 1-second window.</li> <li>Rate limit headers: <code>X-RateLimit-Limit</code>, <code>X-RateLimit-Remaining</code>, <code>X-RateLimit-Reset</code>.</li> </ul>"},{"location":"20-fiscal-platform/api/cloud/#notes","title":"Notes","text":"<ul> <li>Every invoice is traceable through <code>fiscal_number</code>, <code>outlet_id</code>, and <code>submitted_by</code> (user_id or api_key_id).</li> <li>Audit exports default to a 30-day window. Use <code>start_date</code> and <code>end_date</code> query parameters to customize.</li> <li>All endpoints emit structured logs (<code>bono.api.request</code>, <code>bono.api.response</code>) that include <code>outlet_id</code>, <code>fiscal_number</code>, and <code>dgi_status</code>.</li> </ul>"},{"location":"20-fiscal-platform/api/invoicing-sdk/","title":"Invoicing SDK Reference","text":"<p>The Stalela SDK provides client libraries for JavaScript and Python that wrap the Cloud API with type-safe models, built-in offline queuing, automatic retries, and receipt rendering helpers. Use the SDK when you want to integrate fiscal invoicing into your application without managing raw HTTP calls.</p>"},{"location":"20-fiscal-platform/api/invoicing-sdk/#installation","title":"Installation","text":"JavaScript (npm)Python (pip) <pre><code>npm install @stalela/sdk\n</code></pre> <pre><code>pip install stalela-sdk\n</code></pre>"},{"location":"20-fiscal-platform/api/invoicing-sdk/#quick-start","title":"Quick start","text":"JavaScriptPython <pre><code>import { Stalela } from '@stalela/sdk';\n\nconst client = new Stalela({\n  apiKey: process.env.BONO_API_KEY,\n  outletId: 'OUTLET-001',\n  // Note: Pure offline queuing of unsigned drafts is not legally valid for printed receipts.\n  // For offline signing, use the Fiscal Extension (Phase 1.5) or a hardware DEF (Phase 3).\n  offline: { enabled: true, gracePeriodMs: 24 * 60 * 60 * 1000 }\n});\n\n// Create a fiscalized invoice\nconst invoice = await client.invoices.create({\n  invoiceType: 'sale',\n  merchantNif: '123456789',\n  client: { name: 'Acme Ltd', nif: '987654321', classification: 'company' },\n  items: [\n    { sku: 'SKU-001', description: 'Consulting', quantity: 1, unitPrice: 100000, taxGroup: 'TG03' }\n  ],\n  payments: [\n    { method: 'bank_transfer', amount: 116000, reference: 'TXN-789' }\n  ]\n});\n\nconsole.log(invoice.fiscalNumber);  // \"BONO-OUTLET001-000123\"\nconsole.log(invoice.authCode);      // \"MEUCIQD8j2w8s...\"\nconsole.log(invoice.qrPayload);     // \"https://verify.stalela.cd/i?hash=...\"\n</code></pre> <pre><code>from stalela import Stalela\n\nclient = Stalela(\n    api_key=os.environ[\"BONO_API_KEY\"],\n    outlet_id=\"OUTLET-001\",\n    # Note: Pure offline queuing of unsigned drafts is not legally valid for printed receipts.\n    # For offline signing, use the Fiscal Extension (Phase 1.5) or a hardware DEF (Phase 3).\n    offline={\"enabled\": True, \"grace_period_seconds\": 86400}\n)\n\n# Create a fiscalized invoice\ninvoice = client.invoices.create(\n    invoice_type=\"sale\",\n    merchant_nif=\"123456789\",\n    client={\"name\": \"Acme Ltd\", \"nif\": \"987654321\", \"classification\": \"company\"},\n    items=[\n        {\"sku\": \"SKU-001\", \"description\": \"Consulting\", \"quantity\": 1, \"unit_price\": 100000, \"tax_group\": \"TG03\"}\n    ],\n    payments=[\n        {\"method\": \"bank_transfer\", \"amount\": 116000, \"reference\": \"TXN-789\"}\n    ]\n)\n\nprint(invoice.fiscal_number)  # \"BONO-OUTLET001-000123\"\nprint(invoice.auth_code)      # \"MEUCIQD8j2w8s...\"\n</code></pre>"},{"location":"20-fiscal-platform/api/invoicing-sdk/#core-modules","title":"Core modules","text":""},{"location":"20-fiscal-platform/api/invoicing-sdk/#clientinvoices","title":"<code>client.invoices</code>","text":"Method Description <code>create(payload)</code> Submit a canonical payload for fiscalization. Returns a sealed invoice with security elements. <code>get(fiscalNumber)</code> Retrieve a sealed invoice by fiscal number. <code>getStatus(fiscalNumber)</code> Check DGI sync status for a specific invoice. <code>list(filters?)</code> List invoices with optional filters (date range, status, client). <code>createBatch(payloads[])</code> Submit multiple payloads in one call. Returns array of sealed responses."},{"location":"20-fiscal-platform/api/invoicing-sdk/#clientreports","title":"<code>client.reports</code>","text":"Method Description <code>generate(type, period)</code> Generate a Z, X, or A report for the specified period. <code>download(reportId)</code> Download a generated report as PDF or JSON. <code>list(filters?)</code> List previously generated reports."},{"location":"20-fiscal-platform/api/invoicing-sdk/#clientaudit","title":"<code>client.audit</code>","text":"Method Description <code>export(options?)</code> Download the hash-chained Fiscal Ledger export."},{"location":"20-fiscal-platform/api/invoicing-sdk/#clientoutlets","title":"<code>client.outlets</code>","text":"Method Description <code>getStatus()</code> Check outlet health, next fiscal number, and sync status."},{"location":"20-fiscal-platform/api/invoicing-sdk/#clientwebhooks","title":"<code>client.webhooks</code>","text":"Method Description <code>register(config)</code> Register a webhook endpoint. <code>list()</code> List registered webhooks. <code>delete(webhookId)</code> Remove a webhook registration. <code>verifySignature(payload, signature, secret)</code> Verify webhook payload signature (HMAC-SHA256)."},{"location":"20-fiscal-platform/api/invoicing-sdk/#clientverify","title":"<code>client.verify</code>","text":"Method Description <code>verify(fiscalNumber, authCode)</code> Verify a sealed invoice via the public Verification API \u2014 no API key required. Returns <code>status</code>, <code>signature_valid</code>, <code>dgi_status</code>. <code>verifyQR(qrData)</code> Parse a QR code URL and verify the referenced invoice. <code>verifyBatch(invoices)</code> Bulk-verify an array of <code>{ fiscal_number, auth_code }</code> pairs (requires API key). <code>verifySignatureOffline(payload, signature, publicKey)</code> Verify the ECDSA signature locally without an API call \u2014 useful for auditors and air-gapped environments. <p>See Invoice Verification for the full verification flow, portal, and anti-abuse protections.</p>"},{"location":"20-fiscal-platform/api/invoicing-sdk/#offline-queue","title":"Offline queue","text":"<p>The SDK includes a built-in offline queue that automatically handles connectivity issues:</p> <pre><code>flowchart LR\n    App[\"Your Application\"] --&gt; SDK[\"Stalela SDK\"]\n    SDK --&gt;|Online| API[\"Cloud API\"]\n    SDK --&gt;|Offline| Queue[\"Local Queue\\n(IndexedDB / SQLite)\"]\n    Queue --&gt;|Connectivity restored| API\n    API --&gt; HSM[\"Cloud Signing Service\"]\n    HSM --&gt; Response[\"Sealed Invoice\"]</code></pre>"},{"location":"20-fiscal-platform/api/invoicing-sdk/#queue-behavior","title":"Queue behavior","text":"<ol> <li>When <code>offline.enabled</code> is <code>true</code>, the SDK intercepts failed API calls and stores payloads in the local queue.</li> <li>A background sync worker checks connectivity periodically (default: every 30 seconds).</li> <li>When online, queued payloads are submitted in creation order with idempotency keys.</li> <li>The <code>onSync</code> callback fires for each successfully sealed invoice.</li> <li>Payloads older than <code>gracePeriodMs</code> trigger an <code>onGracePeriodExceeded</code> warning.</li> </ol>"},{"location":"20-fiscal-platform/api/invoicing-sdk/#queue-events","title":"Queue events","text":"JavaScriptPython <pre><code>client.on('queue:synced', (invoice) =&gt; {\n  console.log(`Invoice ${invoice.fiscalNumber} sealed after offline queue`);\n});\n\nclient.on('queue:failed', (error, payload) =&gt; {\n  console.error(`Failed to submit queued invoice: ${error.message}`);\n});\n\nclient.on('queue:grace-exceeded', (payload) =&gt; {\n  console.warn(`Draft has been queued for over ${payload.age}ms`);\n});\n</code></pre> <pre><code>@client.on(\"queue:synced\")\ndef on_synced(invoice):\n    print(f\"Invoice {invoice.fiscal_number} sealed after offline queue\")\n\n@client.on(\"queue:failed\")\ndef on_failed(error, payload):\n    print(f\"Failed to submit queued invoice: {error}\")\n</code></pre>"},{"location":"20-fiscal-platform/api/invoicing-sdk/#tax-engine-helpers","title":"Tax engine helpers","text":"<p>The SDK includes helpers for building valid tax summaries:</p> JavaScript <pre><code>import { TaxEngine } from '@stalela/sdk';\n\nconst taxSummary = TaxEngine.calculate({\n  items: [\n    { unitPrice: 100000, quantity: 1, taxGroup: 'TG03' }\n  ],\n  clientClassification: 'company'\n});\n// Returns: { taxGroups: [{ code: 'TG03', baseAmount: 100000, rate: 0.16, taxAmount: 16000 }], totals: { ... } }\n</code></pre>"},{"location":"20-fiscal-platform/api/invoicing-sdk/#error-handling","title":"Error handling","text":"<p>The SDK throws typed errors for common scenarios:</p> Error class HTTP status Description <code>ValidationError</code> 400 Invalid payload (missing fields, bad tax group) <code>AuthenticationError</code> 401 Invalid or expired API key <code>PermissionError</code> 403 API key lacks required scope <code>NotFoundError</code> 404 Invoice or outlet not found <code>DuplicateError</code> 409 Idempotency key collision (returns existing invoice) <code>RateLimitError</code> 429 Rate limit exceeded (includes <code>retryAfter</code>) <code>NetworkError</code> \u2014 No connectivity (queued if offline mode enabled)"},{"location":"20-fiscal-platform/api/invoicing-sdk/#configuration","title":"Configuration","text":"Option Default Description <code>apiKey</code> \u2014 Required. Your Stalela API key. <code>outletId</code> \u2014 Required. The outlet to scope requests to. <code>baseUrl</code> <code>https://api.stalela.cd</code> API base URL. <code>timeout</code> <code>30000</code> Request timeout in milliseconds. <code>offline.enabled</code> <code>false</code> Enable local offline queue. <code>offline.gracePeriodMs</code> <code>86400000</code> Grace period before warning (24h default). <code>offline.maxRetries</code> <code>10</code> Max retries per queued payload. <code>offline.storage</code> <code>auto</code> Storage backend: <code>indexeddb</code>, <code>sqlite</code>, or <code>auto</code>."},{"location":"20-fiscal-platform/architecture/10-architectural-challenges/","title":"10 Architectural Challenges for Stalela","text":"<p>This document outlines ten critical architectural, regulatory, and security challenges facing the Stalela system. These questions are designed to stress-test the current design assumptions, particularly regarding offline capabilities, regulatory compliance (Arr\u00eat\u00e9 033), and cryptographic integrity.</p>"},{"location":"20-fiscal-platform/architecture/10-architectural-challenges/#1-the-offline-pwa-signing-paradox","title":"1. The Offline PWA Signing Paradox","text":"<p>Challenge: How can a pure web application (PWA) securely sign invoices offline without destroying the Point of Sale (POS) user experience or compromising private keys? Context: If we attempt to sign invoices offline in a browser, we face a dilemma. The Web Crypto API allows key generation, but the keys are often exportable or vulnerable to XSS, failing strict fiscal security standards. WebAuthn uses the device's Secure Enclave (highly secure), but requires a biometric prompt (FaceID/TouchID) for every single signature. In a fast-paced retail environment, prompting the cashier for a fingerprint on every receipt is a UX disaster. Proposed Solution (The MetaMask/VC Pattern): We can solve this by combining Self-Sovereign Identity (SSI) Verifiable Credentials with a Browser Extension architecture (like MetaMask).  1. Delegated Credentials: The Cloud HSM issues a short-lived (e.g., 12-hour), limited-scope (e.g., 500 invoices) \"Delegated Private Key\" to the POS. This drastically reduces the blast radius if the key is compromised. 2. The Fiscal Extension: Instead of storing this key in the vulnerable PWA's <code>localStorage</code>, it is stored inside a dedicated Stalela Chrome Extension. The extension runs in an isolated sandbox, immune to XSS attacks on the main website. 3. Silent Auto-Signing: The cashier unlocks the extension once per shift with a PIN. The PWA sends invoice payloads to the extension, which silently auto-signs them (only if the request originates from the trusted <code>pos.stalela.cd</code> domain) and returns the signature. This provides hardware-level isolation with zero per-transaction UX friction.</p>"},{"location":"20-fiscal-platform/architecture/10-architectural-challenges/#2-the-local-fiscal-daemon-vulnerability","title":"2. The Local Fiscal Daemon Vulnerability","text":"<p>Challenge: If we deploy a Local Fiscal Daemon (a background service on Windows/Linux) to handle offline signing, what prevents a malicious merchant from deleting the local database to evade taxes? Context: To solve the PWA paradox, we might use a local daemon that holds the private key and a local SQLite database to queue offline sales. However, if a merchant unplugs their router, processes 100 cash sales, and then simply deletes the <code>stalela_offline.db</code> file before reconnecting to the internet, those sales vanish. Without tamper-proof hardware, local software is inherently vulnerable to data destruction. Proposed Solution (Block Allocation): Inspired by HOTP (HMAC-based One-Time Password) counters, the Cloud HSM allocates a strict, sequential block of fiscal numbers (e.g., #1000 to #1500) to the POS terminal when it is online. If the merchant deletes their local database and reconnects, the Cloud will detect the missing block of numbers and immediately flag the outlet for a tax audit.</p>"},{"location":"20-fiscal-platform/architecture/10-architectural-challenges/#3-the-arrete-033-real-time-requirement","title":"3. The Arr\u00eat\u00e9 033 Real-Time Requirement","text":"<p>Challenge: How does Phase 1's \"queue unsigned drafts offline\" strategy comply with DRC law in physical retail environments? Context: Arr\u00eat\u00e9 033 mandates that the physical receipt handed to the customer must contain the fiscal signature, fiscal number, and QR code. Phase 1 assumes that if the internet is down, the client queues an \"unsigned draft\" and syncs it later. This means the customer walks away with an illegal, non-fiscalized receipt. This strategy works for asynchronous B2B e-invoicing, but is legally incompatible with B2C physical retail.</p>"},{"location":"20-fiscal-platform/architecture/10-architectural-challenges/#4-dgi-api-mcfe-mcf-unknowns","title":"4. DGI API (MCF/e-MCF) Unknowns","text":"<p>Challenge: How can we guarantee our canonical JSON payload and ECDSA P-256 signatures will be accepted by the DGI when their API specs are unpublished? Context: The DGI's MCF/e-MCF endpoint URLs, authentication mechanisms, and exact payload schemas are currently unknown. If the DGI mandates a specific XML format (like UBL), a different signature algorithm (e.g., RSA-2048), or a synchronous SOAP API, our REST/JSON/ECDSA architecture will require significant, costly rework.</p>"},{"location":"20-fiscal-platform/architecture/10-architectural-challenges/#5-hash-chained-ledger-forking","title":"5. Hash-Chained Ledger Forking","text":"<p>Challenge: How do we resolve forks in the Hash-Chained Fiscal Ledger caused by offline signing conflicts or local database restorations? Context: Each invoice's <code>entry_hash</code> includes the <code>previous_hash</code> to ensure cryptographic immutability per <code>outlet_id</code>. If a Local Daemon signs invoices offline, but the merchant restores an older backup of their local database and signs new invoices, the hash chain forks. When both branches eventually sync to the Cloud Fiscal Ledger, how does the system determine the canonical chain without invalidating legitimate sales?</p>"},{"location":"20-fiscal-platform/architecture/10-architectural-challenges/#6-monotonic-counter-race-conditions","title":"6. Monotonic Counter Race Conditions","text":"<p>Challenge: How do we prevent race conditions in the Monotonic Counter Manager in high-concurrency environments without introducing massive latency? Context: The system must serialize fiscal numbering per <code>outlet_id</code>. In a large supermarket with 20 POS terminals firing requests simultaneously, the Cloud Signing Service must lock the counter, increment it, sign the payload, and release the lock. Standard database transactions might cause lock contention and timeouts. How is this scaled?</p>"},{"location":"20-fiscal-platform/architecture/10-architectural-challenges/#7-tax-engine-complexity-and-retroactive-updates","title":"7. Tax Engine Complexity and Retroactive Updates","text":"<p>Challenge: How does the system handle retroactive tax rate changes or new tax groups introduced by the DGI without invalidating historical invoices? Context: The DRC tax code includes 14 distinct tax groups. If the DGI changes the standard VAT rate from 16% to 18% effective immediately, how do offline clients receive this update? Furthermore, if an invoice was queued offline at 16% but syncs to the cloud after the rate changes to 18%, how does the Tax Engine reconcile the discrepancy without rejecting the payload?</p>"},{"location":"20-fiscal-platform/architecture/10-architectural-challenges/#8-hardware-homologation-delays-phase-3","title":"8. Hardware Homologation Delays (Phase 3)","text":"<p>Challenge: What is the contingency plan if the Phase 3 USB Fiscal Memory devices are delayed by years due to DRC homologation bureaucracy? Context: Phase 3 relies on physical hardware to solve the offline security vulnerabilities. However, hardware homologation in emerging markets can take 18-24 months. If the DGI rejects our software-only Phase 1 approach for retail, and Phase 3 hardware is stuck in regulatory limbo, the business is effectively blocked from the retail sector.</p>"},{"location":"20-fiscal-platform/architecture/10-architectural-challenges/#9-sync-agent-thundering-herd","title":"9. Sync Agent Thundering Herd","text":"<p>Challenge: How is the Sync Agent architected to handle a massive influx of queued invoices when a nationwide internet outage resolves? Context: If thousands of merchants in Kinshasa lose internet for 24 hours, they will queue millions of invoices locally. When connectivity is restored, all clients will attempt to sync simultaneously. This \"thundering herd\" could DDoS the Stalela Cloud API, the Cloud Signing Service, and the DGI's MCF endpoints.</p>"},{"location":"20-fiscal-platform/architecture/10-architectural-challenges/#10-audit-traceability-vs-data-privacy","title":"10. Audit Traceability vs. Data Privacy","text":"<p>Challenge: How do we balance the DGI's need for granular, item-level traceability with the merchants' rights to data privacy and protection against industrial espionage? Context: The system must provide comprehensive audit exports (Z, X, A reports) to the DGI. However, transmitting line-item details (e.g., exactly how many units of a specific product a merchant sold) gives the government (and potentially bad actors who compromise the DGI) unprecedented insight into a private company's margins and supply chain. Can we use zero-knowledge proofs or aggregated reporting to satisfy the DGI while protecting merchant data?</p>"},{"location":"20-fiscal-platform/architecture/components/","title":"Component Map","text":"<p>This page records the layered services, actors, and dependencies that deliver Stalela's software-first invoicing platform. It highlights how untrusted clients feed canonical payloads into the platform services, how the trusted fiscal core seals invoices, and how cloud infrastructure stores, syncs, and observes every fiscal event.</p> <p>Phase 1 trust boundary</p> <p>The Cloud Signing Service (HSM-backed) is the only trusted component in Phase 1. Clients (dashboard, API consumers, SDKs, and future POS integrations) remain untrusted, and every security element (fiscal number, auth code, timestamp, QR) originates inside the cloud. Phase 3 reserves the archived USB Fiscal Memory device as an optional trust anchor, but until DEF homologation is required the cloud signs and stores every invoice.</p>"},{"location":"20-fiscal-platform/architecture/components/#client-layer","title":"Client Layer","text":"<p>Stalela clients live in the untrusted zone (with the exception of the Fiscal Extension, which is semi-trusted). They prepare invoices with deterministic identifiers and tax data, queue drafts while offline, and hand canonical serializers the inputs that the platform services validate and fiscalize.</p> <ul> <li><code>Web Dashboard (PWA)</code> \u2014 Tablet-friendly interface with service workers, IndexedDB queues, simplified invoice entry, and status indicators (green/yellow/red) for fiscalization progress.</li> <li><code>Stalela Fiscal Extension</code> \u2014 A Chrome/Edge browser extension that runs in an isolated sandbox. It holds short-lived Delegated Credentials and silently auto-signs invoices for the PWA when operating in Delegated Offline Mode.</li> <li><code>API Consumers</code> \u2014 Backend integrations (ERPs, e-commerce, ERP connectors) that call the Invoicing API with canonical payloads, metadata (merchant_tin, outlet_id, pos_terminal_id, jurisdiction), and source headers.</li> <li><code>SDK &amp; Libraries</code> \u2014 JavaScript/Python/PHP clients that enforce canonical ordering, handle offline queues (IndexedDB/SQLite), and surface callbacks for fiscalized/queued/error states.</li> <li><code>Mobile App (future PWA)</code> \u2014 Mobile-first UI that reuses the dashboard experience with push notifications and offline-first behavior.</li> <li><code>POS Integrations (Phase 2 preview)</code> \u2014 Legacy POS systems that will plug into the SDKs and delegate signing requests to Stalela Cloud instead of local hardware.</li> </ul>"},{"location":"20-fiscal-platform/architecture/components/#platform-services-layer","title":"Platform Services Layer","text":"<p>Platform services normalize, secure, and route every request before the fiscal core signs it. They convert raw user input into deterministic payloads, enforce multi-user policies, apply the tax engine, and deliver receipts.</p> <ul> <li><code>Canonical Serializer</code> \u2014 Produces deterministic JSON (merchant/outlet identifiers, timestamp, client, items, tax_groups, totals, payments) so the Cloud Signing Service can reproduce hashes and ledger entries.</li> <li><code>Invoicing API (REST)</code> \u2014 The developer-facing surface that handles authentication (merchant/outlet-scoped API keys), rate limiting, request validation, and orchestration of tax calculation + signing.</li> <li><code>Tax Calculation Engine</code> \u2014 Loads the active jurisdiction's tax group manifest, computes per-group amounts, applies client classification rules and rounding adjustments, then attaches totals to the canonical payload. See Tax Engine and Jurisdictions.</li> <li><code>Multi-User Access Control (API keys, roles, outlet scoping)</code> \u2014 Enforces quotas, roles (admin, invoicer, viewer, auditor), and source metadata so only authorized users can fiscalize invoices.</li> <li><code>Receipt Delivery (email/WhatsApp/PDF/print)</code> \u2014 Renders sealed invoices with fiscal numbers, auth codes, timestamps, and QR payloads for immediate customer delivery.</li> </ul>"},{"location":"20-fiscal-platform/architecture/components/#fiscal-core-layer-trusted","title":"Fiscal Core Layer (trusted)","text":"<p>The fiscal core contains the Cloud Signing Service and its supporting services that live behind the trust boundary.</p> <ul> <li><code>Cloud Signing Service (HSM)</code> \u2014 Assigns sequential fiscal numbers, generates authentication codes, anchors trusted timestamps, and builds QR payloads; all operations execute within the HSM so keys never leave the boundary.</li> <li><code>Delegated Credential Issuer</code> \u2014 Provisions short-lived Verifiable Credentials (sub-keys) to authorized POS terminals, enabling them to sign invoices locally when offline.</li> <li><code>Monotonic Counter Manager</code> \u2014 Ensures strictly increasing fiscal numbers per outlet even with concurrent API/SDK/cashier activity via serializable database isolation. Also handles block allocation for Delegated Credentials.</li> <li><code>Hash-Chained Fiscal Ledger</code> \u2014 Appends every invoice, void, refund, and report entry with a prev-hash so auditors can verify immutability.</li> <li><code>Report Generator (Z/X/A + audit)</code> \u2014 Derives compliance reports from the ledger (fiscal number ranges, auth codes, tax group totals) and surfaces downloads through the dashboard or API.</li> </ul>"},{"location":"20-fiscal-platform/architecture/components/#cloud-infrastructure-layer","title":"Cloud Infrastructure Layer","text":"<p>Cloud infrastructure stores sealed invoices, uploads them to the jurisdiction's tax authority, and gives operators visibility while preserving backups.</p> <ul> <li><code>Sync Agent + Invoice Store</code> \u2014 Queues sealed invoices, retries uploads to the jurisdiction's tax authority endpoint when connectivity returns, and keeps a copy of every fiscal response for replays or audits.</li> <li><code>Tax Authority Sync Agent</code> \u2014 Dedicated connector that authenticates to the jurisdiction's tax authority, packages sealed payloads using the authority's protocol, and records acknowledgments (<code>queued</code>, <code>synced</code>, <code>failed</code>). See Authority Sync.</li> <li><code>Merchant &amp; Outlet Registry</code> \u2014 Tracks which merchants, outlets, API keys, and POS integrations are active, their quotas, firmware versions (for future hardware), and metadata required by the fiscal core.</li> <li><code>Dashboard &amp; Analytics</code> \u2014 Observability layer for device health, backlog depth, report generation, and sync failures. It consumes metrics from the Invoicing API, Sync Agent, and ledger.</li> <li><code>Backup &amp; Archival</code> \u2014 Off-site snapshots of the fiscal ledger, report payloads, and DAG metadata so compliance teams can restore or audit historical data.</li> </ul>"},{"location":"20-fiscal-platform/architecture/components/#component-dependency-map","title":"Component Dependency Map","text":"<p>The diagram below shows how the client layer feeds canonical data into the platform services, how the fiscal core seals invoices, and how cloud infrastructure persists and syncs every fiscal event. The labels show the services mentioned above and their calling directions.</p> <pre><code>flowchart LR\n    subgraph \"Client Layer\"\n        Dashboard[\"Web Dashboard (PWA)\"]\n        FiscalExt[\"Fiscal Extension\"]\n        APIConsumers[\"API Consumers\"]\n        SDKs[\"SDK &amp; Libraries\"]\n        MobileApp[\"Mobile App (future)\"]\n        POSIntegrations[\"POS Integrations (Phase 2)\"]\n    end\n    subgraph \"Platform Services\"\n        Canonical[\"Canonical Serializer\"]\n        InvoicingAPI[\"Invoicing API (REST)\"]\n        TaxEngine[\"Tax Calculation Engine\"]\n        MultiAccess[\"Multi-User Access Control (API keys, roles, outlets)\"]\n        Delivery[\"Receipt Delivery (email/WhatsApp/PDF/print)\"]\n    end\n    subgraph \"Fiscal Core (trusted)\"\n        CloudSigner[\"Cloud Signing Service (HSM)\"]\n        CredIssuer[\"Credential Issuer\"]\n        Counter[\"Monotonic Counter Manager\"]\n        Ledger[\"Hash-Chained Fiscal Ledger\"]\n        Reports[\"Report Generator (Z/X/A + audit)\"]\n    end\n    subgraph \"Cloud Infrastructure\"\n        SyncAgent[\"Sync Agent + Invoice Store\"]\n        AuthSync[\"Tax Authority Sync Agent\"]\n        Registry[\"Merchant &amp; Outlet Registry\"]\n        Analytics[\"Dashboard &amp; Analytics\"]\n        Backup[\"Backup &amp; Archival\"]\n        Payments[\"Notification &amp; Payment Partners\"]\n    end\n    Dashboard --&gt; Canonical\n    Dashboard --&gt; FiscalExt\n    FiscalExt --&gt; Canonical\n    APIConsumers --&gt; Canonical\n    SDKs --&gt; Canonical\n    MobileApp --&gt; Canonical\n    POSIntegrations --&gt; Canonical\n    Canonical --&gt; InvoicingAPI\n    MultiAccess --&gt; InvoicingAPI\n    InvoicingAPI --&gt; TaxEngine\n    TaxEngine --&gt; CloudSigner\n    InvoicingAPI --&gt; CloudSigner\n    InvoicingAPI --&gt; CredIssuer\n    CredIssuer --&gt; Counter\n    CloudSigner --&gt; Counter\n    CloudSigner --&gt; Ledger\n    Ledger --&gt; Reports\n    Reports --&gt; Delivery\n    Delivery --&gt; Payments\n    Ledger --&gt; SyncAgent\n    SyncAgent --&gt; AuthSync\n    Registry --&gt; SyncAgent\n    Registry --&gt; MultiAccess\n    Ledger --&gt; Analytics\n    Analytics --&gt; Backup\n    Reports --&gt; Analytics\n    Payments --&gt; Analytics</code></pre>"},{"location":"20-fiscal-platform/architecture/components/#cloud-deployment-diagram","title":"Cloud Deployment Diagram","text":"<p>This deployment diagram emphasizes the cloud services that fiscalize invoices, store them, and sync them to the jurisdiction's tax authority. Every client hits the Invoicing API, the Cloud Signing Service signs the payload, and the Sync Agent ships the ledger to the tax authority while analytics and payment partners observe the results.</p> <pre><code>flowchart TB\n    subgraph \"Client Edge\"\n        Dashboard[\"Web Dashboard (PWA)\"]\n        SDKs[\"SDK &amp; Libraries\"]\n        APIConsumers[\"API Consumers\"]\n    end\n    subgraph \"Cloud Services\"\n        InvoicingAPI[\"Invoicing API (REST)\"]\n        CloudSigner[\"Cloud Signing Service (HSM)\"]\n        Ledger[\"Hash-Chained Fiscal Ledger\"]\n        InvoiceStore[\"Invoice Store\"]\n        Reports[\"Report Generator (Z/X/A + audit)\"]\n        SyncAgent[\"Sync Agent (Tax Authority)\"]\n        Analytics[\"Dashboard &amp; Analytics\"]\n    end\n    TaxAuthority[\"Tax Authority (jurisdiction-specific)\"]\n    PaymentPartners[\"Payment &amp; Notification Partners\"]\n    Dashboard --&gt; InvoicingAPI\n    SDKs --&gt; InvoicingAPI\n    APIConsumers --&gt; InvoicingAPI\n    InvoicingAPI --&gt; CloudSigner\n    CloudSigner --&gt; Ledger\n    Ledger --&gt; InvoiceStore\n    Ledger --&gt; Reports\n    Reports --&gt; Analytics\n    InvoiceStore --&gt; Analytics\n    Ledger --&gt; SyncAgent\n    SyncAgent --&gt; TaxAuthority\n    Reports --&gt; PaymentPartners</code></pre>"},{"location":"20-fiscal-platform/architecture/data-flow/","title":"Data Flow Diagrams","text":"<p>Stalela paths prioritize a cloud-first fiscal authority. Every canonical payload (merchant_nif, outlet_id, pos_terminal_id, cashier_id, client, items, tax_groups, totals, payments, timestamp) flows through the Cloud Signing Service (HSM) before any fiscal number, signature, timestamp, or QR payload leaves the trusted zone. The diagrams below trace five operational flows described in the architecture specification and highlight how the fiscal ledger, tax engine, and sync agent collaborate with clients.</p> <p>Canonical payload &amp; trust boundary</p> <ul> <li>Clients (web dashboard users, API consumers, SDKs, future POS terminals) remain untrusted; they only present canonical JSON with deterministic field ordering.</li> <li>The Cloud Signing Service (HSM) is the sole authority that assigns fiscal numbers, generates authentication codes, timestamps, and QR payloads, and persists the hash-chained fiscal ledger.</li> <li>Sync Agent uploads sealed invoices to the DGI (MCF/e-MCF); clients may display the security elements but may never fabricate or mutate them.</li> </ul>"},{"location":"20-fiscal-platform/architecture/data-flow/#1-api-invoice-creation-happy-path","title":"1. API invoice creation (happy path)","text":"<p>Developers and automation systems call <code>POST /api/v1/invoices</code> to fiscalize a sale. The Stalela Invoicing API validates the payload, runs the 14-group tax engine, and forwards the result to the Cloud Signing Service. The signed response returns to the client immediately while the Sync Agent enqueues the ledger entry for the DGI.</p> <pre><code>sequenceDiagram\n    participant \"Merchant / Developer\" as Merchant\n    participant \"Stalela Invoicing API\" as InvoicingAPI\n    participant \"Tax Engine\" as TaxEngine\n    participant \"Cloud Signing Service (HSM)\" as CloudSigning\n    participant \"Fiscal Ledger\" as Ledger\n    participant \"Sync Agent\" as SyncAgent\n    participant \"DGI (MCF/e-MCF)\" as DGI\n    participant \"Client App\" as ClientApp\n\n    Merchant-&gt;&gt;InvoicingAPI: POST /api/v1/invoices with canonical payload (merchant_nif, outlet_id, pos_terminal_id, cashier_id, client, items, tax_groups, totals, payments, timestamp)\n    InvoicingAPI-&gt;&gt;TaxEngine: validate schema + compute all 14 DGI tax groups\n    TaxEngine-&gt;&gt;CloudSigning: forward validated payload for fiscal number + signature\n    CloudSigning-&gt;&gt;Ledger: persist sealed invoice (fiscal_number, auth_code, timestamp, qr_payload) in hash-chained ledger\n    CloudSigning--&gt;&gt;InvoicingAPI: return sealed response with fiscal data\n    InvoicingAPI--&gt;&gt;ClientApp: deliver fiscalized invoice + security elements\n    CloudSigning-&gt;&gt;SyncAgent: queue ledger entry for upload\n    SyncAgent-&gt;&gt;DGI: transmit sealed invoice batch</code></pre>"},{"location":"20-fiscal-platform/architecture/data-flow/#2-web-dashboard-invoice-creation-browser-flow","title":"2. Web dashboard invoice creation (browser flow)","text":"<p>Stalela's PWA dashboard mirrors the API flow while adding UX touches for touchscreen terminals. The dashboard still builds the canonical payload, invokes the Invoicing API, and surfaces sealed invoices and delivery options without ever touching fiscal numbers.</p> <pre><code>sequenceDiagram\n    participant \"Merchant (Web Dashboard)\" as WebMerchant\n    participant \"Web Dashboard (PWA)\" as Dashboard\n    participant \"Service Worker Queue (IndexedDB)\" as SWQueue\n    participant \"Stalela Invoicing API\" as InvoicingAPI\n    participant \"Cloud Signing Service (HSM)\" as CloudSigning\n    participant \"Fiscal Ledger\" as Ledger\n    participant \"Sync Agent\" as SyncAgent\n    participant \"DGI (MCF/e-MCF)\" as DGI\n\n    WebMerchant-&gt;&gt;Dashboard: finalize invoice draft (client selection, line items, payments)\n    Dashboard-&gt;&gt;SWQueue: enqueue canonical payload for online submission\n    SWQueue-&gt;&gt;InvoicingAPI: POST /api/v1/invoices when connectivity available\n    InvoicingAPI-&gt;&gt;CloudSigning: fiscalize payload\n    CloudSigning-&gt;&gt;Ledger: record sealed event\n    CloudSigning--&gt;&gt;InvoicingAPI: return fiscalized response\n    InvoicingAPI--&gt;&gt;Dashboard: update UI (receipt delivery, QR, fiscal number)\n    CloudSigning-&gt;&gt;SyncAgent: hand off entry for DGI sync\n    SyncAgent-&gt;&gt;DGI: upload sealed invoice</code></pre>"},{"location":"20-fiscal-platform/architecture/data-flow/#3-offline-client-flow-sdk-or-dashboard","title":"3. Offline client flow (SDK or dashboard)","text":"<p>Offline clients queue invoices locally (IndexedDB for dashboard, SQLite for SDKs) and retry automatic submission when they reconnect. Fiscalization happens only after the payload reaches the Cloud Signing Service, ensuring no sealed invoice is issued while the client remains offline.</p> <pre><code>sequenceDiagram\n    participant \"Merchant (SDK)\" as SDKMerchant\n    participant \"Local Queue (IndexedDB/SQLite)\" as LocalQueue\n    participant \"Stalela Invoicing API\" as InvoicingAPI\n    participant \"Cloud Signing Service (HSM)\" as CloudSigning\n    participant \"Fiscal Ledger\" as Ledger\n    participant \"Sync Agent\" as SyncAgent\n    participant \"DGI (MCF/e-MCF)\" as DGI\n\n    SDKMerchant-&gt;&gt;LocalQueue: save canonical payload (queued, status=Queued)\n    LocalQueue--&gt;&gt;LocalQueue: await connectivity (automatic retries)\n    LocalQueue-&gt;&gt;InvoicingAPI: submit stored payload when online\n    InvoicingAPI-&gt;&gt;CloudSigning: fiscalize queued payload\n    CloudSigning-&gt;&gt;Ledger: append sealed invoice\n    CloudSigning--&gt;&gt;InvoicingAPI: deliver sealed response\n    InvoicingAPI--&gt;&gt;SDKMerchant: notify fiscalized status (green)\n    CloudSigning-&gt;&gt;SyncAgent: schedule upload\n    SyncAgent-&gt;&gt;DGI: transmit invoice batch</code></pre>"},{"location":"20-fiscal-platform/architecture/data-flow/#4-void-credit-note-fiscal-events","title":"4. Void &amp; credit note fiscal events","text":"<p>Voids and refunds are always new fiscal events that reference the original fiscal number. The same tax engine and signing flow produce a fresh fiscal number, ledger entry, and sealed response so auditors can trace both the original and reversal.</p> <pre><code>sequenceDiagram\n    participant \"Merchant / Auditor\" as MerchantAuditor\n    participant \"Stalela Invoicing API\" as InvoicingAPI\n    participant \"Cloud Signing Service (HSM)\" as CloudSigning\n    participant \"Fiscal Ledger\" as Ledger\n    participant \"Sync Agent\" as SyncAgent\n    participant \"DGI (MCF/e-MCF)\" as DGI\n\n    MerchantAuditor-&gt;&gt;InvoicingAPI: POST /api/v1/invoices/{fiscal_number}/void with reference to original and new totals\n    InvoicingAPI-&gt;&gt;CloudSigning: rerun tax &amp; signing flow for void/credit note\n    CloudSigning-&gt;&gt;Ledger: append new sealed event (new fiscal_number, QR, auth_code, references original)\n    CloudSigning--&gt;&gt;InvoicingAPI: return sealed reversal response\n    InvoicingAPI--&gt;&gt;MerchantAuditor: provide void/credit note receipt\n    CloudSigning-&gt;&gt;SyncAgent: enqueue reversal for DGI\n    SyncAgent-&gt;&gt;DGI: upload reversal batch</code></pre>"},{"location":"20-fiscal-platform/architecture/data-flow/#5-report-generation-auditor-view","title":"5. Report generation (auditor view)","text":"<p>Report requests hit Stalela's reporting endpoints that query the Fiscal Ledger for the mandated Z, X, A, and audit export views. Each response includes fiscal_number ranges, auth codes, timestamps, and ledger hashes sourced from the cloud ledger so every report matches the same sealed invoices the Sync Agent uploads.</p> <pre><code>sequenceDiagram\n    participant \"Auditor / Merchant\" as Auditor\n    participant \"Stalela Reporting API\" as ReportingAPI\n    participant \"Report Generator\" as ReportGenerator\n    participant \"Fiscal Ledger\" as Ledger\n\n    Auditor-&gt;&gt;ReportingAPI: POST /api/v1/reports (type=Z/X/A/audit)\n    ReportingAPI-&gt;&gt;ReportGenerator: fetch ledger entries for requested range\n    ReportGenerator-&gt;&gt;Ledger: read hash-chained sealed invoices\n    Ledger--&gt;&gt;ReportGenerator: return fiscal numbers, auth codes, timestamps, tax totals\n    ReportGenerator--&gt;&gt;ReportingAPI: assemble report (JSON + PDF)\n    ReportingAPI--&gt;&gt;Auditor: deliver report with fiscal_authority_id and ledger hash</code></pre>"},{"location":"20-fiscal-platform/architecture/data-flow/#6-delegated-offline-signing-phase-15","title":"6. Delegated Offline Signing (Phase 1.5)","text":"<p>To comply with Arr\u00eat\u00e9 033 in physical retail environments, POS terminals equipped with the Stalela Fiscal Extension can request a Delegated Credential while online. When offline, the extension signs invoices locally within its allocated block. When connectivity returns, the locally-sealed invoices are submitted to the Cloud for reconciliation.</p> <pre><code>sequenceDiagram\n    participant \"POS (PWA)\" as POS\n    participant \"Fiscal Extension\" as Ext\n    participant \"Credential Issuer\" as Issuer\n    participant \"Cloud Signing Service\" as CloudSigning\n    participant \"Fiscal Ledger\" as Ledger\n    participant \"Sync Agent\" as SyncAgent\n\n    Note over POS,Issuer: 1. Online Provisioning\n    POS-&gt;&gt;Ext: Request Delegated Credential\n    Ext-&gt;&gt;Issuer: Send Public Key + Request Block\n    Issuer-&gt;&gt;Issuer: Allocate Block (#1000-#1500)\n    Issuer--&gt;&gt;Ext: Return VC + Block\n\n    Note over POS,Ext: 2. Offline Signing\n    POS-&gt;&gt;POS: Create Invoice JSON\n    POS-&gt;&gt;Ext: Request Signature\n    Ext-&gt;&gt;Ext: Validate Origin &amp; Sign Payload\n    Ext--&gt;&gt;POS: Return Signature + VC\n    POS-&gt;&gt;POS: Print Receipt (Locally Sealed)\n\n    Note over POS,SyncAgent: 3. Online Reconciliation\n    POS-&gt;&gt;CloudSigning: Submit Locally-Sealed Invoices\n    CloudSigning-&gt;&gt;CloudSigning: Verify Signatures against VC\n    CloudSigning-&gt;&gt;Ledger: Append to Hash-Chained Ledger\n    CloudSigning--&gt;&gt;POS: Reconciliation Complete\n    CloudSigning-&gt;&gt;SyncAgent: Queue for DGI Upload</code></pre>"},{"location":"20-fiscal-platform/architecture/delegated-offline-token/","title":"Delegated Offline Token Architecture","text":""},{"location":"20-fiscal-platform/architecture/delegated-offline-token/#problem-statement","title":"Problem Statement","text":"<p>In Phase 1, Stalela relies entirely on the Cloud Signing Service (HSM) to generate fiscal numbers, signatures, and QR payloads. The original design assumed that if a client (e.g., a web dashboard) lost internet connectivity, it would queue \"unsigned drafts\" locally and submit them for fiscalization once connectivity returned.</p> <p>However, a deep review of the DRC regulatory framework (specifically Arr\u00eat\u00e9 033) revealed a critical compliance gap: physical receipts handed to customers in a retail environment must contain the fiscal signature and QR code at the moment of sale. A strategy of queuing unsigned drafts is legally incompatible with B2C physical retail.</p> <p>To solve this, we need a way for Point of Sale (POS) terminals to sign invoices offline securely, without destroying the user experience (e.g., requiring a biometric prompt for every receipt) or exposing the master Cloud HSM private keys.</p>"},{"location":"20-fiscal-platform/architecture/delegated-offline-token/#the-model","title":"The Model","text":"<p>We introduce the Delegated Offline Token Architecture as a Phase 1.5 fast-follow. This model combines principles from Self-Sovereign Identity (Verifiable Credentials), Browser Extensions (the MetaMask pattern), and HOTP (Block Allocation).</p>"},{"location":"20-fiscal-platform/architecture/delegated-offline-token/#1-delegated-credential-issuance","title":"1. Delegated Credential Issuance","text":"<p>Instead of the POS holding the master Cloud HSM key, the Cloud HSM issues a short-lived (e.g., 12-hour) \"Delegated Private Key\" to the POS terminal when it is online. This key is packaged as a Verifiable Credential (VC) that says:</p> <p>\"I, Stalela Cloud (Trusted Authority), certify that Public Key [XYZ] belongs to POS Terminal #12, and is authorized to sign Invoices #1000 to #1500 until Midnight tonight.\"</p>"},{"location":"20-fiscal-platform/architecture/delegated-offline-token/#2-local-signing-the-fiscal-extension","title":"2. Local Signing (The Fiscal Extension)","text":"<p>To protect this delegated key from XSS attacks on the PWA, the key is stored inside a dedicated Stalela Chrome Extension. The extension runs in an isolated sandbox. * The cashier unlocks the extension once per shift with a PIN. * The PWA sends invoice payloads to the extension. * The extension silently auto-signs them (only if the request originates from the trusted <code>pos.stalela.cd</code> domain) and returns the signature.</p>"},{"location":"20-fiscal-platform/architecture/delegated-offline-token/#3-block-allocation-tamper-detection","title":"3. Block Allocation (Tamper Detection)","text":"<p>To prevent merchants from deleting local databases to hide sales, the Cloud HSM allocates a strict, sequential block of fiscal numbers (e.g., #1000 to #1500) along with the Delegated Credential. * If the merchant deletes their local data and reconnects, the Cloud detects the missing block and flags the outlet for a tax audit.</p>"},{"location":"20-fiscal-platform/architecture/delegated-offline-token/#4-reconciliation","title":"4. Reconciliation","text":"<p>When connectivity returns, the POS submits the locally-sealed invoices to the Cloud. The Cloud verifies the signatures against the Delegated Credential and appends them to the Hash-Chained Fiscal Ledger.</p>"},{"location":"20-fiscal-platform/architecture/delegated-offline-token/#trust-boundary-changes","title":"Trust Boundary Changes","text":"<p>Clients with valid delegated credentials are \"semi-trusted\" for a bounded scope. The Cloud HSM remains the root of trust. The trust boundary is relaxed to allow delegated signing via short-lived Verifiable Credentials.</p>"},{"location":"20-fiscal-platform/architecture/delegated-offline-token/#security-analysis","title":"Security Analysis","text":"<ul> <li>Signing Oracle Attack: The extension is programmed to silently auto-sign requests from <code>pos.stalela.cd</code>. If an attacker finds an XSS vulnerability on the PWA, they could inject malicious JavaScript to send fake invoices to the extension.</li> <li>Mitigation: Strict Content Security Policy (CSP) on the PWA. The extension must validate the payload totals before signing. The blast radius is limited by the short TTL (12 hours) and block cap (500 invoices).</li> <li>Supply Chain Attack: A compromised Google developer account could push a malicious extension update.</li> <li>Mitigation: Strict access control (MFA, hardware keys) for the Chrome Web Store account. Code signing and reproducible builds. The compromised extension would only access temporary 12-hour keys, not the master Cloud HSM keys.</li> <li>Local Malware: A keylogger could capture the PIN and read the encrypted key file.</li> <li>Mitigation: This is a fundamental limitation of software-based solutions. The only true defense is Phase 3 (Hardware USB Tokens).</li> <li>XSS Immunity: The private keys are isolated from the web page. XSS attacks cannot steal the keys.</li> </ul>"},{"location":"20-fiscal-platform/architecture/delegated-offline-token/#verification-flow","title":"Verification Flow","text":"<p>A two-step cryptographic check is required to verify a locally-sealed invoice offline: 1. Validate the Delegated Credential: Did Stalela Cloud sign the Delegated Credential? (Verified via Stalela's cached Public Key). 2. Validate the Invoice Signature: Did the POS local key sign the invoice? (Verified via the Public Key inside the Delegated Credential).</p>"},{"location":"20-fiscal-platform/architecture/delegated-offline-token/#sequence-diagrams","title":"Sequence Diagrams","text":""},{"location":"20-fiscal-platform/architecture/delegated-offline-token/#credential-provisioning","title":"Credential Provisioning","text":"<pre><code>sequenceDiagram\n    participant POS as POS (PWA)\n    participant Ext as Fiscal Extension\n    participant Cloud as Cloud HSM\n\n    POS-&gt;&gt;Ext: Request Delegated Credential\n    Ext-&gt;&gt;Ext: Generate Local Keypair\n    Ext-&gt;&gt;Cloud: Send Public Key + Request Block\n    Cloud-&gt;&gt;Cloud: Allocate Block (#1000-#1500)\n    Cloud-&gt;&gt;Cloud: Sign Delegated Credential (VC)\n    Cloud--&gt;&gt;Ext: Return VC + Block\n    Ext-&gt;&gt;Ext: Store VC + Private Key\n    Ext--&gt;&gt;POS: Credential Provisioned</code></pre>"},{"location":"20-fiscal-platform/architecture/delegated-offline-token/#offline-signing","title":"Offline Signing","text":"<pre><code>sequenceDiagram\n    participant POS as POS (PWA)\n    participant Ext as Fiscal Extension\n\n    POS-&gt;&gt;POS: Create Invoice JSON\n    POS-&gt;&gt;Ext: Request Signature (Payload)\n    Ext-&gt;&gt;Ext: Validate Origin (pos.stalela.cd)\n    Ext-&gt;&gt;Ext: Sign Payload with Local Private Key\n    Ext--&gt;&gt;POS: Return Signature + VC\n    POS-&gt;&gt;POS: Generate QR Code (Payload + Sig + VC)\n    POS-&gt;&gt;POS: Print Receipt</code></pre>"},{"location":"20-fiscal-platform/architecture/delegated-offline-token/#reconciliation-tamper-detection","title":"Reconciliation &amp; Tamper Detection","text":"<pre><code>sequenceDiagram\n    participant POS as POS (PWA)\n    participant Cloud as Cloud HSM\n    participant Ledger as Fiscal Ledger\n\n    POS-&gt;&gt;Cloud: Submit Locally-Sealed Invoices (#1000-#1200)\n    Cloud-&gt;&gt;Cloud: Verify Signatures against VC\n    Cloud-&gt;&gt;Cloud: Check Block Allocation (#1000-#1500)\n    alt Missing Invoices Detected\n        Cloud-&gt;&gt;Cloud: Flag Outlet for Audit\n    end\n    Cloud-&gt;&gt;Ledger: Append to Hash-Chained Ledger\n    Cloud--&gt;&gt;POS: Reconciliation Complete</code></pre>"},{"location":"20-fiscal-platform/architecture/delegated-offline-token/#open-questions","title":"Open Questions","text":"<ul> <li>DGI Acceptance: Will the DGI accept delegated signatures, or will they mandate hardware-backed security (accelerating Phase 3)?</li> <li>Acceptable TTL/Block Size: What is the optimal balance between security (short TTL, small blocks) and offline resilience (long TTL, large blocks)?</li> <li>Credential Revocation: How do we handle revocation of a Delegated Credential if a POS terminal is compromised before the TTL expires?</li> </ul>"},{"location":"20-fiscal-platform/architecture/overview/","title":"Architecture Overview","text":"<p>Stalela is fiscal invoicing infrastructure for the DRC. This page explains the cloud-first architecture that treats the Cloud Signing Service as the trusted authority, keeps clients in the untrusted zone, and preserves offline behavior inspired by the Odoo lessons (PWA, service workers, IndexedDB queues). We describe who interacts with Stalela, why the trust boundary matters, and how the layered components work together to produce sealed invoices, reports, and DGI-ready data.</p>"},{"location":"20-fiscal-platform/architecture/overview/#system-context-c4","title":"System Context (C4)","text":"<p>Merchants, developers, and auditors rely on Stalela to fiscalize commerce, document every fiscal event, and surface auditable reports, while the platform shares sealed invoices with the DGI and notifies payment partners about settlement status. The context diagram keeps these actors, the Stalela Platform services, and the external systems visible so newcomers can trace how requests flow from the client to the fiscal authority.</p> <pre><code>flowchart LR\n    Merchant[\"Merchant / Finance Team\"]\n    Developer[\"Developer / Integration\"]\n    Auditor[\"Auditor / Regulator\"]\n    Stalela[\"Stalela Platform\\n(Invoicing API + Dashboard + Cloud Signing + Sync)\"]\n    DGI[\"DGI (MCF / e-MCF)\"]\n    Payment[\"Payment Providers\"]\n    Merchant --&gt;|Creates invoices &amp; monitors dashboards| Stalela\n    Developer --&gt;|Builds API/SDK integrations| Stalela\n    Auditor --&gt;|Requests Z/X/A/audit exports| Stalela\n    Stalela --&gt;|Sealed invoice + security elements| DGI\n    Stalela --&gt;|Payment status, webhooks, receipts| Payment</code></pre>"},{"location":"20-fiscal-platform/architecture/overview/#trust-boundary","title":"Trust Boundary","text":"<p>The Cloud Signing Service (HSM-backed) is the root of trust. However, to support offline retail compliance (Arr\u00eat\u00e9 033), Stalela introduces a third trust mode: Delegated Offline Signing. </p> <p>Client applications (Web Dashboard, API consumers, SDKs) are generally untrusted. They prepare canonical payloads (mandated identifiers, deterministic field ordering, 14 DGI tax groups).  * Online Mode: Clients send payloads to Stalela Cloud. The Cloud Signing Service validates the payload, consults the Tax Engine, coordinates with the Monotonic Counter Manager, and produces the five security elements (fiscal number, fiscal authority ID, authentication code, trusted timestamp, QR payload). * Delegated Offline Mode: A POS terminal equipped with the Stalela Fiscal Extension can request a short-lived \"Delegated Credential\" and a block of fiscal numbers while online. When offline, the extension acts as a semi-trusted, bounded signer, generating the security elements locally. These locally-sealed invoices are later reconciled with the Cloud Ledger.</p> <p>Clients without a delegated credential must queue unsigned drafts locally and wait for connectivity. Clients may only display or deliver security elements and must never fabricate them outside of the strict delegated extension sandbox.</p> <pre><code>flowchart LR\n    subgraph \"Untrusted Zone\"\n        Dashboard[\"Web Dashboard (PWA)\"]\n        API[\"API Consumers\"]\n        SDK[\"SDK &amp; Libraries\"]\n    end\n    subgraph \"Semi-Trusted Zone (Bounded)\"\n        FiscalExt[\"Fiscal Extension (Delegated Signer)\"]\n    end\n    subgraph \"Trusted Zone (Root)\"\n        Signer[\"Cloud Signing Service (HSM)\"]\n        CredIssuer[\"Credential Issuer\"]\n        Tax[\"Tax Engine\"]\n        Counter[\"Monotonic Counter Manager\"]\n        Ledger[\"Fiscal Ledger\"]\n        Reports[\"Report Generator (Z/X/A + audit)\"]\n        Sync[\"Sync Agent\"]\n    end\n    Dashboard --&gt;|Canonical payload| Signer\n    Dashboard --&gt;|Payload for local signing| FiscalExt\n    FiscalExt --&gt;|Locally-sealed invoices| Signer\n    API --&gt;|Invoice requests| Signer\n    SDK --&gt;|Queued drafts &amp; retries| Signer\n    CredIssuer --&gt;|Issues VC + Block| FiscalExt\n    Counter --&gt; Signer\n    Counter --&gt; CredIssuer\n    Tax --&gt; Signer\n    Signer --&gt; Ledger\n    Ledger --&gt; Reports\n    Ledger --&gt; Sync\n    Reports --&gt; Sync\n    Sync --&gt;|Sealed payload uploads| DGI[\"DGI (MCF / e-MCF)\"]</code></pre> <p>Note</p> <p>The trust boundary is enforced by the Cloud Signing Service (HSM) and the Credential Issuer. See Delegated Offline Token Architecture for details on how the Fiscal Extension securely signs offline. Phase\u00a03 reserves a role for the archived USB Fiscal Memory device as an optional hardware trust anchor.</p>"},{"location":"20-fiscal-platform/architecture/overview/#component-map","title":"Component Map","text":"<p>The Stalela platform is composed of four layers: clients that originate invoices, platform services that normalize and secure requests, the fiscal core where signing happens, and external integrations that consume sealed data. The component diagram below highlights how sales data flows from dashboards or SDKs into canonical serializers, travels through multi-user policies, reaches the Cloud Signing Service, and finally feeds the fiscal ledger, reports, and sync agents.</p> <pre><code>graph LR\n    subgraph \"Client Layer\"\n        Dashboard[\"Web Dashboard (PWA)\"]\n        APICl[\"API Consumers\"]\n        SDKs[\"SDK &amp; Libraries\"]\n        Mobile[\"Mobile App (PWA)\"]\n        FuturePOS[\"Future POS / Terminals\"]\n    end\n    subgraph \"Platform Services\"\n        Canonical[\"Canonical Serializer\"]\n        Invoicing[\"Invoicing API\"]\n        TaxEngine[\"Tax Calculation Engine\"]\n        MultiAccess[\"Multi-User Access Control (API keys, roles, outlets)\"]\n        Delivery[\"Receipt Delivery (email/WhatsApp/PDF/print)\"]\n    end\n    subgraph \"Fiscal Core (Trusted)\"\n        Signer[\"Cloud Signing Service (HSM)\"]\n        Counter[\"Monotonic Counter Manager\"]\n        Ledger[\"Hash-Chained Fiscal Ledger\"]\n        Reports[\"Report Generator (Z/X/A + audit)\"]\n    end\n    subgraph \"External\"\n        SyncAgent[\"DGI Sync Agent\"]\n        Payment[\"Payment Gateway / Notification Service\"]\n    end\n\n    Dashboard --&gt; Canonical\n    APICl --&gt; Canonical\n    SDKs --&gt; Canonical\n    Mobile --&gt; Canonical\n    FuturePOS --&gt; Canonical\n    Canonical --&gt; Invoicing\n    MultiAccess --&gt; Invoicing\n    Invoicing --&gt; TaxEngine\n    TaxEngine --&gt; Signer\n    Canonical --&gt; Signer\n    Signer --&gt; Counter\n    Signer --&gt; Ledger\n    Ledger --&gt; Reports\n    Reports --&gt; Delivery\n    Delivery --&gt; Payment\n    Ledger --&gt; SyncAgent</code></pre>"},{"location":"20-fiscal-platform/architecture/overview/#operational-notes","title":"Operational Notes","text":"<ul> <li>Offline resilience: Clients use IndexedDB/SQLite queues, service workers, and other Odoo-inspired PWA patterns so tablets can keep capturing invoices even when disconnected. Queued payloads include canonical identifiers (<code>merchant_nif</code>, <code>outlet_id</code>, <code>pos_terminal_id</code>, <code>cashier_id</code>, <code>client</code>, <code>tax_groups</code>, <code>totals</code>, <code>payments</code>) plus metadata about the user or API key. When connectivity returns, invoices are retried against the Invoicing API and fiscalized by the Cloud Signing Service.</li> <li>Sequential numbering: The Monotonic Counter Manager enforces serializable isolation per outlet, so every tenant sees strictly increasing fiscal numbers even under concurrent crews, multi-user dashboards, or SDK threads.</li> <li>Security elements &amp; reporting: The Cloud Signing Service (HSM) never hands out fiscal numbers, signatures, timestamps, or QR payloads to clients; it stores the sealed events in the hash-chained ledger, feeds the Report Generator with Z/X/A/audit exports, and surfaces ledger hashes for compliance reviews.</li> <li>Sync &amp; notifications: The Sync Agent uploads sealed invoices to the DGI (MCF/e-MCF) and exposes statuses via webhook notifications plus the dashboard's green/yellow/red telemetry. Payment Providers receive delivery updates but never see confidential signing secrets.</li> <li>Phase 3 reminder: When DEF homologation is required, the archived USB Fiscal Memory device takes over signing for that outlet, but the cloud ledger continues to mirror its outputs for auditability. Until then, the Stalela Cloud remains the trusted fiscal authority that developers and finance teams rely on.</li> </ul>"},{"location":"20-fiscal-platform/architecture/trust-boundary/","title":"Trust Boundary","text":"<p>Stalela positions the Cloud Signing Service (HSM-backed) as the root trusted fiscal authority. However, to support offline retail compliance, the trust boundary includes a Semi-Trusted Zone for clients holding valid Delegated Credentials.</p> <p>Web dashboards, API consumers, and SDKs generally live in the untrusted zone; they author canonical payloads (<code>merchant_tin</code>, <code>outlet_id</code>, <code>pos_terminal_id</code>, <code>jurisdiction</code>, <code>client</code>, <code>tax_groups</code>, <code>totals</code>, <code>payments</code>, <code>timestamp</code>) and deliver them to Stalela Cloud for validation, tax calculation, signing, and ledger storage. </p> <p>When operating in Delegated Offline Mode, a POS terminal equipped with the Stalela Fiscal Extension acts as a bounded, semi-trusted signer. It uses a short-lived Verifiable Credential to generate security elements locally, which are later reconciled with the Cloud Ledger.</p>"},{"location":"20-fiscal-platform/architecture/trust-boundary/#what-crosses-the-boundary","title":"What crosses the boundary","text":"<ol> <li>Canonical invoice requests \u2014 Clients send deterministic JSON through <code>POST /api/v1/invoices</code> (or direct API/SDK calls) that include the jurisdiction-configured tax groups, client classification, outlet/scoping identifiers, and payments in the field order mandated by the spec.</li> <li>Delegated Credential Requests \u2014 POS terminals request short-lived signing keys and block allocations from the Credential Issuer.</li> <li>Locally-Sealed Invoices (Reconciliation) \u2014 When connectivity returns, POS terminals submit invoices signed by the Fiscal Extension to the Cloud for verification and ledger appending.</li> <li>Payment metadata &amp; tracing headers \u2014 Each request carries <code>X-Stalela-Merchant-ID</code>, <code>X-Stalela-Outlet-ID</code>, optionally <code>X-Stalela-User-ID</code>/<code>X-Stalela-Source</code>, and other telemetry.</li> </ol>"},{"location":"20-fiscal-platform/architecture/trust-boundary/#what-the-trusted-zone-produces","title":"What the trusted zone produces","text":"<ul> <li>Sealed responses \u2014 The Cloud Signing Service returns the five mandatory elements (fiscal number, fiscal authority ID, cryptographic auth code, trusted timestamp, QR payload) plus <code>ledger_hash</code>, <code>authority_sync_status</code>, and the signed payload.</li> <li>Delegated Credentials (VCs) \u2014 The Credential Issuer produces short-lived Verifiable Credentials and allocates blocks of fiscal numbers to authorized POS terminals.</li> <li>Ledger entries \u2014 The hash-chained Fiscal Ledger records each fiscal event immutably.</li> <li>Tax authority upload bundles \u2014 The Sync Agent packages sealed invoices for the jurisdiction's tax authority. See Authority Sync.</li> <li>Audit-ready reports \u2014 The Report Generator emits Z/X/A/audit exports.</li> </ul>"},{"location":"20-fiscal-platform/architecture/trust-boundary/#what-never-crosses-the-boundary","title":"What never crosses the boundary","text":"<ul> <li>Master Private Keys \u2014 HSM-held master keys stay inside the Cloud Signing Service. Clients never see them. (Note: Short-lived, delegated sub-keys do cross the boundary into the isolated Fiscal Extension sandbox).</li> <li>Raw monotonic counters or journal mutations \u2014 Counter increments and journal writes occur only inside the trusted zone. </li> <li>Fabricated security elements \u2014 Client applications outside the strict Fiscal Extension sandbox cannot invent fiscal numbers, timestamps, auth codes, or QR payloads.</li> </ul> <pre><code>flowchart LR\n    subgraph \"Untrusted Zone (Clients)\"\n        Dashboard[\"Web Dashboard (PWA)\"]\n        API[\"API Consumers\"]\n        SDK[\"SDKs &amp; Integrations\"]\n    end\n    subgraph \"Semi-Trusted Zone\"\n        FiscalExt[\"Fiscal Extension (Delegated Signer)\"]\n    end\n    subgraph \"Trusted Stalela Cloud\"\n        Signing[\"Cloud Signing Service (HSM)\"]\n        CredIssuer[\"Credential Issuer\"]\n        Counter[\"Monotonic Counter Manager\"]\n        Ledger[\"Hash-Chained Fiscal Ledger\"]\n        Reports[\"Report Generator (Z/X/A)\"]\n        Sync[\"Tax Authority Sync Agent\"]\n    end\n    TaxAuthority[\"Tax Authority (jurisdiction-specific)\"]\n\n    Dashboard --&gt;|canonical invoice| Signing\n    Dashboard --&gt;|payload for local signing| FiscalExt\n    FiscalExt --&gt;|locally-sealed invoices| Signing\n    API --&gt;|canonical invoice| Signing\n    SDK --&gt;|canonical invoice| Signing\n\n    CredIssuer --&gt;|Issues VC + Block| FiscalExt\n    Signing --&gt; Counter\n    Counter --&gt; CredIssuer\n    Counter --&gt; Ledger\n    Signing --&gt; Ledger\n    Ledger --&gt; Reports\n    Sync --&gt; TaxAuthority\n    Signing --&gt;|sealed invoice| Dashboard\n    Signing --&gt;|sealed invoice| API\n    Signing --&gt;|sealed invoice| SDK\n    Ledger --&gt;|sealed invoice upload| Sync</code></pre>"},{"location":"20-fiscal-platform/architecture/trust-boundary/#failure-modes-at-the-boundary","title":"Failure modes at the boundary","text":"<ol> <li>Cloud Signing Service unavailable \u2014 Clients without a delegated credential queue invoices locally (unsigned drafts) and retry when online. Clients with the Fiscal Extension sign locally within their allocated block.</li> <li>Delegated Credential Expiry \u2014 If a POS terminal remains offline past its credential's TTL (e.g., 12 hours) or exhausts its allocated block of fiscal numbers, it must revert to queuing unsigned drafts until it can reconnect and request a new credential.</li> <li>Key rotation inside HSM \u2014 The Cloud handles key rollovers without exposing private material. </li> <li>Counter corruption or serialization violation \u2014 The Monotonic Counter Manager enforces serializable isolation in PostgreSQL.</li> <li>Tax authority sync backpressure \u2014 The Sync Agent queues outbound bundles and retries with exponential backoff.</li> </ol>"},{"location":"20-fiscal-platform/architecture/trust-boundary/#trust-assumptions-table","title":"Trust assumptions table","text":"Assumption Enforcement The Cloud Signing Service (HSM) is the root authority for fiscal numbers, auth codes, timestamps, and QR payloads. The HSM + Monotonic Counter Manager run inside Stalela Cloud. Delegated Credential Holder (semi-trusted, bounded scope) The Fiscal Extension operates in an isolated browser sandbox, signing only within the strict TTL and block allocation defined by its Verifiable Credential. Canonical payloads hit the trusted zone before fiscalization (or reconciliation). API/SDK clients serialize payloads per spec. The Cloud rejects schema deviations before signing or reconciling. Clients may not fabricate security elements. Only the Cloud HSM or the isolated Fiscal Extension can produce valid cryptographic signatures. Multi-user, multi-terminal tenants share fiscal access safely. Each request includes <code>merchant_id</code>, <code>outlet_id</code>, and <code>api_key_id</code>/<code>user_id</code>. Audit reports originate from the hash-chained ledger. The Report Generator queries the ledger directly."},{"location":"20-fiscal-platform/architecture/trust-boundary/#phase-3-note","title":"Phase 3 note","text":"<p>Phase 3 introduces the optional USB Fiscal Memory device as a trust anchor for DEF-homologated merchants. When that hardware is deployed, it replaces the Cloud Signing Service for the local outlet while replicating every sealed invoice back to Stalela Cloud for ledger consistency and tax authority sync (<code>design/docs-archive/hardware/</code>). The documentation above keeps the cloud-first story intact but flags the archived USB specs for future reference.</p>"},{"location":"20-fiscal-platform/cloud/architecture/","title":"Cloud Architecture","text":"<p>The Stalela Cloud is the trusted fiscal authority in Phase 1 (Software Invoicing). Unlike a relay that merely forwards sealed data, the cloud is responsible for the entire fiscalization pipeline: it receives canonical payloads from untrusted client applications, validates them, signs them via the HSM-backed Cloud Signing Service, assigns sequential fiscal numbers, timestamps them, stores them in the append-only Fiscal Ledger, and delivers sealed responses back to the caller. Only after an invoice is sealed does the Sync Agent forward it to the DGI.</p>"},{"location":"20-fiscal-platform/cloud/architecture/#responsibilities","title":"Responsibilities","text":"Component Role Cloud Signing Service (HSM) Assigns fiscal numbers via the Monotonic Counter Manager, signs canonical payloads with ECDSA keys that never leave the HSM, generates QR payloads, and produces trusted timestamps. In Phase 1.5, it verifies locally-sealed invoices during reconciliation. Credential Issuer Issues short-lived Delegated Credentials (Verifiable Credentials) and allocates blocks of fiscal numbers to the Fiscal Extension for offline signing. Fiscal Ledger Append-only, hash-chained storage of every sealed invoice. Source of truth for Z/X/A reports and audit exports. Tax Engine Validates the 14 DGI tax groups, applies client classification rules, performs rounding, and rejects invalid payloads before signing. Report Generator Produces Z, X, A reports and full audit exports from the Fiscal Ledger on schedule or on demand. Sync Agent Uploads sealed invoices to the DGI MCF/e-MCF endpoint, handles retries with exponential backoff, and records acknowledgements. Merchant &amp; Outlet Registry Tracks merchants, outlets, API keys, users, and their association with HSM signing contexts. Manages provisioning, activation, and key rotation. Operations Dashboard Surfaces sync health, invoice pipeline status, report generation, and compliance KPIs for auditors and support staff. <p>Trust boundary reminder</p> <p>In Phase 1 the Cloud Signing Service is the root authority for fiscal numbers, signatures, timestamps, and QR metadata. Client applications (API consumers, web dashboard, SDK integrators) submit canonical payloads and receive sealed responses. In Phase 1.5, the Fiscal Extension acts as a semi-trusted signer using a Delegated Credential, but the Cloud HSM remains the ultimate verifier during reconciliation.</p> <p>Phase 3 \u2014 USB Hardware</p> <p>In Phase 3, the USB Fiscal Memory device (DEF) can replace or augment the Cloud Signing Service for merchants needing DEF homologation. The cloud then acts as a sync relay. Hardware docs are archived in <code>docs-archive/hardware/</code>.</p>"},{"location":"20-fiscal-platform/cloud/architecture/#deployment-model","title":"Deployment model","text":""},{"location":"20-fiscal-platform/cloud/architecture/#deployment-options","title":"Deployment options","text":"<ol> <li>Serverless ingestion \u2014 Stateless functions (FaaS) validate incoming payloads, route them to the signing pipeline, and return sealed responses. This keeps bursty loads from overloading stateful systems and scales naturally when many outlets submit concurrently.</li> <li>Containerized services \u2014 Longer-running components (Cloud Signing Service, Report Generator, Operations Dashboard, Sync Agent) run inside orchestrated containers with horizontal scaling per tenant cluster. Containers host the HSM integration, ledger writes, reporting, and heavy CSV/Excel exports.</li> <li>Hybrid pattern \u2014 Front-door API and validation workers stay serverless for elasticity; the Cloud Signing Service, Fiscal Ledger, and Report Generator run on containers inside a private VPC within the DRC region.</li> </ol> <p>Each deployment option feeds into a multi-tenant namespace (see below) so containers and functions can be scaled independently per customer while sharing operational tooling, logs, and secrets.</p>"},{"location":"20-fiscal-platform/cloud/architecture/#multi-tenant-per-outlet-isolation","title":"Multi-tenant &amp; per-outlet isolation","text":"<p>The cloud is multi-tenant by design: every merchant (and by extension, every outlet) receives its own namespace, audit partition, and quota enforcement while being hosted inside the shared DRC deployment. Tenant metadata flows from the API request (merchant NIF, outlet ID, API key / user ID) into the registry and signing pipeline so the cloud can enforce serial numbering per outlet.</p> <p>The Monotonic Counter Manager maintains one counter per outlet with serializable database isolation. Even if multiple API consumers or dashboard users submit invoices simultaneously, the counter serializes them before the Cloud Signing Service signs, guaranteeing gap-free sequential fiscal numbers. Shared tooling (monitoring, billing, backups) reuses the same clusters, but each tenant's data sits in logically separated partitions with IAM policies.</p>"},{"location":"20-fiscal-platform/cloud/architecture/#data-residency-compliance","title":"Data residency &amp; compliance","text":"<p>All cloud workloads run in a DRC-hosted region to comply with local data residency expectations. Invoices, logs, and audit exports are stored encrypted at rest; keys are managed within the same region; TLS 1.3+ enforces encryption in transit. Backups are kept on redundant DRC zones, and any cross-border reporting is delivered through sealed exports (not raw invoice data) so no sensitive tax information leaves the country without explicit ministerial approval.</p> <p>The cloud also tracks regulatory metadata (compliance deadlines, report cadence, audit trail hashes) so operators can prove they met the DGI requirements described in the SFE specifications.</p>"},{"location":"20-fiscal-platform/cloud/architecture/#deployment-diagram","title":"Deployment diagram","text":"<pre><code>graph LR\n    subgraph Clients[\"Client Apps (untrusted)\"]\n        Dashboard[\"Web Dashboard\"]\n        API_Consumer[\"REST API consumers\"]\n        SDK[\"SDK integrators\"]\n    end\n    subgraph SemiTrusted[\"Semi-Trusted Zone\"]\n        FiscalExt[\"Fiscal Extension (Phase 1.5)\"]\n    end\n    subgraph Cloud[\"Stalela Cloud (DRC deployment, trusted)\"]\n        Gateway[\"API Gateway\"]\n        TaxEng[\"Tax Engine\"]\n        Issuer[\"Credential Issuer\"]\n        HSM[\"Cloud Signing Service (HSM)\"]\n        Ledger[\"Fiscal Ledger\"]\n        Reports[\"Report Generator\"]\n        Sync[\"Sync Agent\"]\n        Registry[\"Merchant &amp; Outlet Registry\"]\n        Ops[\"Operations Dashboard\"]\n    end\n    DGI[\"DGI MCF / e-MCF\"]\n\n    Dashboard --&gt; Gateway\n    API_Consumer --&gt; Gateway\n    SDK --&gt; Gateway\n    Dashboard --&gt; FiscalExt\n    FiscalExt --&gt; Gateway\n    Gateway --&gt; TaxEng\n    TaxEng --&gt; HSM\n    TaxEng --&gt; Issuer\n    Issuer --&gt; HSM\n    HSM --&gt; Ledger\n    Ledger --&gt; Reports\n    Ledger --&gt; Sync\n    Sync --&gt; DGI\n    Registry --&gt; HSM\n    Reports --&gt; Ops\n    Sync --&gt; Ops\n    Gateway --&gt; Ops\n\n    subgraph Region[\"DRC Data Residency\"]\n        Ledger\n        Registry\n        Ops\n        Reports\n    end</code></pre>"},{"location":"20-fiscal-platform/cloud/authority-sync/","title":"Tax Authority Sync Agent","text":"<p>The Tax Authority Sync Agent is the generic component that uploads sealed invoices from the Fiscal Ledger to the jurisdiction's tax authority. Each jurisdiction defines its own sync protocol, endpoint, and authentication method in its country profile.</p>"},{"location":"20-fiscal-platform/cloud/authority-sync/#generic-sync-pattern","title":"Generic Sync Pattern","text":"<p>Regardless of the jurisdiction, the sync pipeline follows the same architecture:</p> <pre><code>flowchart LR\n  Client[\"Client Apps\\n(API / Dashboard / SDK)\"] --&gt;|canonical payload| Cloud[\"Stalela Cloud\\n(Cloud Signing Service)\"]\n  Cloud --&gt;|sealed invoice + security elements| Ledger[\"Fiscal Ledger\"]\n  Cloud --&gt;|sealed invoice + metadata| AUTH[\"Tax Authority\\n(jurisdiction-specific)\"]\n  AUTH --&gt;|acknowledgement| Cloud</code></pre> <p>The Cloud Signing Service generates the security elements (fiscal number, auth code, timestamp, QR) \u2014 it does not merely relay them. The Sync Agent handles the upstream delivery to the tax authority using the jurisdiction-specific protocol.</p>"},{"location":"20-fiscal-platform/cloud/authority-sync/#sync-pipeline-steps","title":"Sync Pipeline Steps","text":"<p>The Tax Authority Sync Agent runs as a background service within the Stalela Cloud:</p> <ol> <li>Poll the Fiscal Ledger for newly sealed invoices where <code>authority_sync_status</code> is <code>PENDING</code>.</li> <li>Load the jurisdiction's sync configuration \u2014 protocol, endpoint URL, authentication method, payload format.</li> <li>Format the submission with the required security elements and identifiers (<code>fiscal_authority_id</code>, <code>outlet_id</code>, <code>merchant_tin</code>, <code>cashier_id</code> / <code>api_key_id</code>).</li> <li>Upload to the authority's endpoint via the configured protocol (HTTPS, SOAP, etc.).</li> <li>Record the acknowledgement (or failure) in the Fiscal Ledger and update the invoice's <code>authority_sync_status</code>.</li> <li>Retry with exponential backoff on transient failures; escalate to <code>FAILED</code> after max retries.</li> <li>Surface dashboards and alerts for operators when uploads are pending or failing.</li> </ol>"},{"location":"20-fiscal-platform/cloud/authority-sync/#sync-status-lifecycle","title":"Sync Status Lifecycle","text":"<pre><code>stateDiagram-v2\n    [*] --&gt; PENDING: Invoice sealed\n    PENDING --&gt; SUBMITTED: Upload initiated\n    SUBMITTED --&gt; SYNCED: Authority acknowledged\n    SUBMITTED --&gt; RETRY: Transient failure\n    RETRY --&gt; SUBMITTED: Retry attempt\n    RETRY --&gt; FAILED: Max retries exceeded\n    FAILED --&gt; SUBMITTED: Manual re-trigger</code></pre> Status Meaning <code>PENDING</code> Invoice sealed in Fiscal Ledger, awaiting upload <code>SUBMITTED</code> Upload sent to tax authority, awaiting acknowledgement <code>SYNCED</code> Authority acknowledged receipt <code>RETRY</code> Transient failure, will retry with backoff <code>FAILED</code> Max retries exceeded \u2014 operator intervention required"},{"location":"20-fiscal-platform/cloud/authority-sync/#jurisdiction-specific-protocols","title":"Jurisdiction-Specific Protocols","text":"<p>Each jurisdiction implements its own sync protocol through the Tax Authority Sync Agent:</p> Jurisdiction Authority Protocol Status Profile DRC (CD) DGI MCF / e-MCF Partially documented \u2014 API unpublished DGI Integration \u2192 Kenya (KE) KRA eTIMS API (Type C \u2014 ESD) Publicly documented Planned \u2192 Rwanda (RW) RRA V-EBM / VSDC Documented Planned \u2192 Tanzania (TZ) TRA VFD API Documented Planned \u2192 Nigeria (NG) FIRS TaxPro Max Under development Planned \u2192 Zimbabwe (ZW) ZIMRA EFD Protocol Under research Planned \u2192 South Africa (ZA) SARS eFiling No mandate yet Planned \u2192"},{"location":"20-fiscal-platform/cloud/authority-sync/#offline-behavior","title":"Offline Behavior","text":"<p>The specification for most jurisdictions emphasizes that offline operation is normal. The Sync Agent handles this gracefully:</p> <ul> <li>Client applications queue unsigned draft payloads locally (IndexedDB / SQLite) when the cloud is unreachable.</li> <li>Once connectivity returns, drafts are submitted to the Cloud Signing Service for sealing.</li> <li>The Sync Agent then uploads sealed invoices to the tax authority.</li> <li>See Offline Sync for the full state machine.</li> </ul>"},{"location":"20-fiscal-platform/cloud/authority-sync/#configuration-model","title":"Configuration Model","text":"<p>Each jurisdiction's sync configuration is loaded at runtime:</p> <pre><code># Example: DRC jurisdiction sync config\njurisdiction: CD\nauthority:\n  name: DGI\n  protocol: https\n  endpoint: \"https://mcf.dgi.gouv.cd/api/v1/invoices\"  # placeholder\n  auth_method: certificate  # placeholder \u2014 unknown\n  retry_max: 5\n  retry_backoff_base_ms: 1000\n  batch_size: 50\n  grace_period_hours: 72\n</code></pre> <p>Phase 3 \u2014 Hardware Trust Anchor</p> <p>In Phase 3, jurisdictions with hardware fiscal device mandates (e.g., DRC DEF, Tanzania EFD) can use a local device as the trusted signer. The Sync Agent still uploads sealed invoices from the device through the cloud to the tax authority using the same pipeline.</p>"},{"location":"20-fiscal-platform/cloud/offline-sync/","title":"Offline-First Sync Design","text":"<p>Every invoice issued in the DRC must survive hostile networks. However, Arr\u00eat\u00e9 033 strictly prohibits issuing \"unsigned drafts\" to customers. Stalela solves this using the Delegated Offline Token Architecture (Phase 1.5). </p> <p>When online, the POS terminal's Fiscal Extension requests a short-lived Delegated Credential and a block of fiscal numbers from the Cloud. When offline, the extension signs invoices locally within its allocated block, allowing the merchant to print legally valid receipts. When connectivity returns, these locally-sealed invoices are synchronized back to the Cloud for reconciliation.</p>"},{"location":"20-fiscal-platform/cloud/offline-sync/#offline-model-overview","title":"Offline model overview","text":"<pre><code>stateDiagram-v2\n    [*] --&gt; PROVISIONED : Extension receives Delegated Credential &amp; Block\n    PROVISIONED --&gt; LOCALLY_SEALED : Extension signs invoice (offline)\n    LOCALLY_SEALED --&gt; QUEUED : Saved to local sync queue\n    QUEUED --&gt; RECONCILING : Connectivity restored\n    RECONCILING --&gt; RECONCILED : Cloud verifies signature &amp; appends to Ledger\n    RECONCILING --&gt; RETRY : Network error\n    RETRY --&gt; RECONCILING : Backoff timer expires\n    RETRY --&gt; FAILED : Max retries exceeded (Requires manual intervention)\n    RECONCILED --&gt; [*]</code></pre> <p>Unsigned drafts are illegal</p> <p>Previous designs allowed clients to queue unsigned drafts. This is a compliance violation. Under the Delegated Offline Token model, every printed receipt must be cryptographically sealed. If the Fiscal Extension exhausts its allocated block or its credential expires, the POS must halt sales until it can reconnect and provision a new block.</p>"},{"location":"20-fiscal-platform/cloud/offline-sync/#client-side-queue-architecture","title":"Client-side queue architecture","text":"<p>The POS application maintains a local queue of locally-sealed invoices. Each entry stores:</p> <ul> <li>canonical payload \u2014 the full invoice payload.</li> <li>local signature \u2014 the ECDSA signature generated by the Fiscal Extension.</li> <li>delegated credential \u2014 the Verifiable Credential proving the extension's authority to sign.</li> <li>queue position \u2014 the local slot referenced by the sync state machine.</li> </ul>"},{"location":"20-fiscal-platform/cloud/offline-sync/#storage-backends","title":"Storage backends","text":"Client type Storage Notes Web POS IndexedDB The POS PWA stores locally-sealed invoices in IndexedDB and replays them to the Cloud when online. Fiscal Extension Extension Storage The extension securely stores the Delegated Private Key and tracks the current counter within the allocated block."},{"location":"20-fiscal-platform/cloud/offline-sync/#reconciliation-flow","title":"Reconciliation flow","text":"<p>When connectivity returns, the POS sync worker submits queued payloads in sequential order to the Stalela Cloud API:</p> <ol> <li>Pick the oldest QUEUED entry and transition it to RECONCILING.</li> <li>POST the sealed payload to <code>/api/v1/invoices/reconcile</code>.</li> <li>On success (201): The Cloud verifies the signature against the Delegated Credential, verifies the fiscal number is within the allocated block, appends it to the Fiscal Ledger, and returns a success response. Transition to RECONCILED.</li> <li>On transient failure (5xx, timeout): Transition to RETRY with exponential backoff.</li> <li>On validation failure (4xx): This indicates a severe security event (e.g., signature mismatch, block exhaustion fraud). Log the error, transition to FAILED, and raise a critical security alert.</li> </ol> <p>Idempotency</p> <p>Each submission includes the <code>fiscal_number</code> and <code>signature</code>. If the cloud has already reconciled this exact invoice, it returns a 200 OK instead of creating a duplicate ledger entry.</p>"},{"location":"20-fiscal-platform/cloud/offline-sync/#grace-period-audit-logging","title":"Grace period &amp; audit logging","text":"<p>The DGI expects \"guaranteed eventual transmission.\" As soon as a client regains connectivity, the queue flushes payloads in order. The Delegated Credential has a strict Time-To-Live (TTL), typically 12 hours. If the POS does not reconnect within this grace period, the credential expires, and offline signing is disabled.</p>"},{"location":"20-fiscal-platform/cloud/offline-sync/#client-ui-offline-indicators","title":"Client UI offline indicators","text":"<p>The POS UI must clearly indicate the sync status of the current block:</p> <ol> <li>Online / Provisioned (Green) \u2014 Connected to Cloud, block is well-provisioned.</li> <li>Offline / Signing Locally (Amber) \u2014 Disconnected, but signing using the Delegated Credential. Shows remaining block capacity (e.g., \"45 invoices remaining\").</li> <li>Syncing (Blue) \u2014 Reconnecting and reconciling locally-sealed invoices with the Cloud.</li> <li>Blocked (Red) \u2014 Credential expired or block exhausted. Sales halted until connection is restored.</li> </ol>"},{"location":"20-fiscal-platform/cloud/offline-sync/#security-and-fraud-prevention","title":"Security and Fraud Prevention","text":"<p>By allocating strict blocks (e.g., #1000 to #1500), the Cloud knows exactly which invoices to expect during reconciliation. If a POS reconciles #1000, #1001, and #1003, the Cloud immediately detects that #1002 is missing (potential database deletion fraud) and flags the outlet for audit.</p>"},{"location":"20-fiscal-platform/fiscal/invoice-lifecycle/","title":"Invoice lifecycle","text":""},{"location":"20-fiscal-platform/fiscal/invoice-lifecycle/#non-negotiable-six-step-flow","title":"Non-negotiable six-step flow","text":"<p>Every fiscal invoice must follow the same locked-down path so the trust boundary stays intact, the canonical payload remains deterministic, and the Cloud Signing Service (HSM) retains sole authority over fiscal numbers, signatures, timestamps, and QR payloads.</p> <ol> <li>Client apps prepare canonical payloads. Dashboards, SDKs, and API consumers submit deterministic JSON that includes <code>merchant_nif</code>, <code>outlet_id</code>, <code>pos_terminal_id</code>, <code>cashier_id</code>, <code>client</code> (classification), <code>items</code>, <code>tax_groups</code>, <code>totals</code>, <code>payments</code>, and <code>timestamp</code>. In Phase 1.5, POS terminals equipped with the Fiscal Extension can sign these payloads locally when offline using a Delegated Credential.</li> <li>Invoicing API validates and taxes. The platform enforces schema, deterministic field ordering, the 14 DGI tax groups, and client classification before letting the Tax Engine compute the grouped totals and confirm the payload is well-formed.</li> <li>Cloud Signing Service (HSM) fiscalizes. The Monotonic Counter Manager guarantees sequential numbering per outlet, the HSM signs the payload (ECDSA), stamps a trusted UTC timestamp, and generates the QR code that bundles fiscal_number, auth_code, timestamp, and verification URL.</li> <li>Fiscal Ledger persists sealed events. The hash-chained, append-only ledger stores the sealed invoice, ledger hash, and security metadata so every report and audit entry can trace back to the same fiscal event.</li> <li>Clients deliver receipts. The platform surfaces the sealed response (fiscal_number, auth_code, timestamp, qr_payload, fiscal_authority_id) so merchants can deliver receipts via email, WhatsApp, PDF download, thermal print, or the API/web dashboard.</li> <li>Sync Agent uploads to DGI. The Sync Agent queues sealed invoices for MCF/e-MCF transmission, marks ledger entries <code>Synced_to_DGI</code>, and records acknowledgments as <code>Acknowledged</code>. If the DGI rejects a batch, the Sync Agent retries while preserving the hash chain and reportability.</li> </ol>"},{"location":"20-fiscal-platform/fiscal/invoice-lifecycle/#primary-fiscalization-sequence","title":"Primary fiscalization sequence","text":"<pre><code>sequenceDiagram\n    participant \"Client App (API / Dashboard / SDK)\"\n    participant \"Invoicing API\"\n    participant \"Tax Engine\"\n    participant \"Cloud Signing Service (HSM)\"\n    participant \"Fiscal Ledger\"\n    participant \"Sync Agent\"\n    participant \"DGI (MCF/e-MCF)\"\n\n    \"Client App (API / Dashboard / SDK)\"-&gt;&gt;\"Invoicing API\": 1. Submit canonical invoice payload\n    \"Invoicing API\"-&gt;&gt;\"Tax Engine\": 2. Validate schema &amp; compute 14 DGI tax groups\n    \"Tax Engine\"-&gt;&gt;\"Cloud Signing Service (HSM)\": 3. Assign fiscal number + sign + timestamp + QR\n    \"Cloud Signing Service (HSM)\"-&gt;&gt;\"Fiscal Ledger\": 4. Persist sealed invoice + ledger hash\n    \"Fiscal Ledger\"-&gt;&gt;\"Sync Agent\": 5. Enqueue sealed invoice for DGI\n    \"Sync Agent\"-&gt;&gt;\"DGI (MCF/e-MCF)\": 6. Upload sealed payload + security elements\n    \"Cloud Signing Service (HSM)\"--&gt;&gt;\"Client App (API / Dashboard / SDK)\": Return sealed response (fiscal_number, auth_code, timestamp, qr_payload, fiscal_authority_id)</code></pre>"},{"location":"20-fiscal-platform/fiscal/invoice-lifecycle/#invoice-state-machine","title":"Invoice state machine","text":"<pre><code>stateDiagram-v2\n    [*] --&gt; Draft\n    Draft --&gt; Submitted : API request accepted (Online)\n    Draft --&gt; Locally_Sealed : Fiscal Extension signs (Offline Phase 1.5)\n    Locally_Sealed --&gt; Reconciling : Connectivity restored\n    Reconciling --&gt; Fiscalized : Cloud verifies signature\n    Submitted --&gt; Validated : Tax engine + payload sanity\n    Validated --&gt; Fiscalized : Cloud Signing Service (HSM) approves\n    Fiscalized --&gt; Delivered : Receipts delivered / customer notified\n    Delivered --&gt; Synced_to_DGI : Sync Agent uploads to DGI (MCF/e-MCF)\n    Synced_to_DGI --&gt; Acknowledged : DGI acknowledges upload\n    Submitted --&gt; Validation_Failed : Schema/tax mismatch\n    Validation_Failed --&gt; Draft : Merchant fixes payload\n    Validated --&gt; Signing_Error : HSM rejects or counter issue\n    Signing_Error --&gt; Validated : Retry after cleanup\n    Synced_to_DGI --&gt; DGI_Rejected : DGI rejects batch\n    DGI_Rejected --&gt; Synced_to_DGI : Retry upload</code></pre> <p>The state diagram enforces the expectation that invoices never skip validation, signing, or synchronization; errors route back to safe states for retries. <code>Synced_to_DGI</code> captures the ledger entry once the Sync Agent pushes the sealed payload to the control modules, and <code>Acknowledged</code> only occurs after DGI confirms receipt.</p>"},{"location":"20-fiscal-platform/fiscal/invoice-lifecycle/#invoice-types","title":"Invoice types","text":"<p>Every invoice type the DGI mandates flows through the cloud-first lifecycle above. The Cloud Signing Service (HSM) masks service differences while the Fiscal Ledger keeps the immutable record.</p> Type Code Description Sale invoice <code>SALE</code> Standard retail/wholesale invoice that includes a full 14 tax-group breakdown and cloud-generated security elements. Advance invoice <code>ADVANCE</code> Prepayment invoice that locks in tax treatment, yet still uses the same canonical flow and receives a sealed response from the cloud. Credit note <code>CREDIT</code> Correction referencing the original fiscal number; signed as a new fiscal event so auditors can trace the adjustment. Export invoice <code>EXPORT</code> Duty/export-centric invoice that records customs/product details and shares the canonical payload + signing pipeline. Export credit note <code>EXPORT_CREDIT</code> Refund or correction for an export invoice; it binds to the export fiscal number and travels through the cloud signing sequence."},{"location":"20-fiscal-platform/fiscal/invoice-lifecycle/#special-flows","title":"Special flows","text":""},{"location":"20-fiscal-platform/fiscal/invoice-lifecycle/#void-flow","title":"Void flow","text":"<p>Voids are new fiscal events. A merchant references the original <code>fiscal_number</code>, builds a canonical payload with <code>invoice_type: \"CREDIT\"</code> or a dedicated void marker, and resubmits via <code>POST /api/v1/invoices</code>. The same six-step lifecycle applies: the Tax Engine recomputes totals, the Cloud Signing Service (HSM) issues a fresh fiscal number + signature, and the Fiscal Ledger appends a link back to the voided invoice. No records are deleted.</p>"},{"location":"20-fiscal-platform/fiscal/invoice-lifecycle/#refund-credit-note-flow","title":"Refund (credit note) flow","text":"<p>Refunds (credit notes) follow the canonical path because fiscalization happens inside the cloud. The Cloud Signing Service assigns a unique fiscal number, timestamps it, and emits a QR payload that the merchant can deliver alongside the refund receipt. The Fiscal Ledger tracks the lineage so auditors can reconcile the refund with the original invoice.</p>"},{"location":"20-fiscal-platform/fiscal/invoice-lifecycle/#draft-cancellation","title":"Draft cancellation","text":"<p>If a merchant cancels before submitting the canonical payload, the invoice stays local and never touches the trusted boundary. No fiscal number, ledger entry, or security elements are generated until the invoice re-enters the flow.</p> <p>Ancillary records remain read-only</p> <p>Every sealed invoice is append-only. Voids, refunds, and corrections create new fiscal events that reference the originals; nothing is rewound or deleted once the payload leaves the client application. This keeps the hash-chained ledger intact and satisfies the DGI mandate.</p>"},{"location":"20-fiscal-platform/fiscal/invoice-lifecycle/#report-generation-flow","title":"Report generation flow","text":"<pre><code>sequenceDiagram\n    participant \"Merchant / Auditor\"\n    participant \"Cloud API\"\n    participant \"Fiscal Ledger\"\n    participant \"Report Generator\"\n\n    \"Merchant / Auditor\"-&gt;&gt;\"Cloud API\": Request Z / X / A / audit export\n    \"Cloud API\"-&gt;&gt;\"Fiscal Ledger\": Query hash-chained sealed invoices\n    \"Fiscal Ledger\"-&gt;&gt;\"Report Generator\": Supply ordered entries\n    \"Report Generator\"--&gt;&gt;\"Cloud API\": Return signed report + ledger hash\n    \"Cloud API\"--&gt;&gt;\"Merchant / Auditor\": Deliver JSON/PDF download link</code></pre> <p>Reports read the same hash-chained ledger, include fiscal_authority_id + ledger hash, and can stream data to auditors even while the Sync Agent handles DGI uploads.</p>"},{"location":"20-fiscal-platform/fiscal/invoice-lifecycle/#phase-3-note","title":"Phase 3 note","text":"<p>When the archived USB Fiscal Memory device is deployed for DEF homologation, it replaces the Cloud Signing Service only for that outlet\u2019s signing step. The rest of the lifecycle (canonical payload, tax engine, ledger, Sync Agent, reports) remains unchanged. Refer to <code>design/docs-archive/hardware/</code> for the DEF protocol.</p>"},{"location":"20-fiscal-platform/fiscal/invoice-lifecycle/#references","title":"References","text":"<ul> <li><code>spec/architecture-kutapay-system-1.md</code> (trust boundary, canonical payload, tax engine, and lifecycle guardrails)</li> <li><code>.github/copilot-instructions.md</code> (Cloud Signing Service trust rules, offline behavior, and canonical payload requirements)</li> </ul>"},{"location":"20-fiscal-platform/fiscal/invoice-verification/","title":"Invoice Verification","text":"<p>Every sealed Stalela invoice carries a QR code that encodes the fiscal number, auth code, timestamp, and a verification URL. Invoice verification is the public-facing system that lets anyone \u2014 customers, auditors, DGI inspectors, or merchants themselves \u2014 confirm that an invoice was genuinely issued and sealed by the Cloud Signing Service (HSM) or a trusted Fiscal Extension (Phase 1.5). This page specifies the verification channels, API, cryptographic flow, and trust model.</p>"},{"location":"20-fiscal-platform/fiscal/invoice-verification/#why-verification-matters","title":"Why verification matters","text":"<p>Counterfeit invoices are a compliance and revenue risk in DRC markets. A trader hands a customer a receipt \u2014 how does the customer know it was really fiscalized? Verification closes that loop:</p> <ul> <li>Customers scan the QR on their receipt and instantly see whether the invoice is authentic.</li> <li>DGI inspectors verify invoices during field audits without needing VPN access to the merchant's systems.</li> <li>Auditors validate invoice chains in bulk through the API.</li> <li>Business partners confirm supplier invoices before recording them as deductible expenses.</li> </ul>"},{"location":"20-fiscal-platform/fiscal/invoice-verification/#verification-channels","title":"Verification channels","text":"<pre><code>flowchart LR\n    QR[\"QR Code on Receipt\"] --&gt; PORTAL[\"Public Verification Portal\\nverify.stalela.cd\"]\n    QR --&gt; API[\"Verification API\\n/api/v1/verify\"]\n    QR --&gt; WHATSAPP[\"WhatsApp Bot\\n'V\u00e9rifier facture'\"]\n    MANUAL[\"Manual Entry\\n(fiscal number + auth code)\"] --&gt; PORTAL\n    MANUAL --&gt; WHATSAPP\n    PORTAL --&gt; RESULT[\"\u2705 Verified / \u274c Not Found / \u26a0\ufe0f Tampered\"]\n    API --&gt; RESULT\n    WHATSAPP --&gt; RESULT</code></pre> Channel Description Authentication required Phase Public Verification Portal Web page at <code>verify.stalela.cd</code> \u2014 scan QR or type fiscal number + auth code No (public) Phase 1 Verification API REST endpoint for programmatic verification No (public, rate-limited) Phase 1 WhatsApp Bot Send QR photo or fiscal number to the bot No (public) Phase 2 Dashboard Inline verification in the merchant dashboard Yes (authenticated) Phase 1 SDK helpers <code>verifyInvoice()</code> method in JavaScript / Python SDKs No (delegates to API) Phase 1"},{"location":"20-fiscal-platform/fiscal/invoice-verification/#public-verification-portal","title":"Public Verification Portal","text":"<p>The portal at <code>verify.stalela.cd</code> is a lightweight, mobile-first web page that requires no login. It's the URL encoded in every QR code.</p>"},{"location":"20-fiscal-platform/fiscal/invoice-verification/#user-flow","title":"User flow","text":"<pre><code>sequenceDiagram\n    participant C as Customer / Inspector\n    participant P as verify.stalela.cd\n    participant V as Verification Service\n    participant L as Fiscal Ledger\n\n    C-&gt;&gt;P: Scan QR code or enter fiscal number + auth code\n    P-&gt;&gt;V: GET /api/v1/verify/{fiscal_number}?auth_code=...\n    V-&gt;&gt;L: Look up fiscal_number in ledger\n    L--&gt;&gt;V: Ledger entry (or not found)\n    V-&gt;&gt;V: Verify ECDSA signature against HSM public key\n    V-&gt;&gt;V: Compare auth_code, timestamp, fiscal_authority_id\n    V--&gt;&gt;P: Verification result\n    P--&gt;&gt;C: Display result with invoice summary</code></pre>"},{"location":"20-fiscal-platform/fiscal/invoice-verification/#portal-display","title":"Portal display","text":"<p>Verified invoice (\u2705):</p> <pre><code>\u2554\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2557\n\u2551  \u2705  FACTURE V\u00c9RIFI\u00c9E                       \u2551\n\u2551                                              \u2551\n\u2551  N\u00b0 Fiscal:    BONO-OUTLET001-000123         \u2551\n\u2551  Commer\u00e7ant:   Acme SARL                     \u2551\n\u2551  Date:         17 f\u00e9v 2026, 14:32 UTC        \u2551\n\u2551  Montant:      116 000 FC (TVA incl.)        \u2551\n\u2551  Autorit\u00e9:     HSM-CLUSTER-01                \u2551\n\u2551                                              \u2551\n\u2551  Signature cryptographique: \u2705 Valide        \u2551\n\u2551  Cha\u00eene du registre:        \u2705 Intacte       \u2551\n\u2551  Statut DGI:                \u2705 Synchronis\u00e9   \u2551\n\u255a\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u255d\n</code></pre> <p>Not found (\u274c):</p> <pre><code>\u2554\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2557\n\u2551  \u274c  FACTURE NON TROUV\u00c9E                    \u2551\n\u2551                                              \u2551\n\u2551  Le num\u00e9ro fiscal fourni ne correspond       \u2551\n\u2551  \u00e0 aucune facture enregistr\u00e9e dans le        \u2551\n\u2551  syst\u00e8me Stalela.                           \u2551\n\u2551                                              \u2551\n\u2551  Si vous pensez que c'est une erreur,        \u2551\n\u2551  contactez le commer\u00e7ant ou le support.      \u2551\n\u255a\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u255d\n</code></pre> <p>Tampered / invalid signature (\u26a0\ufe0f):</p> <pre><code>\u2554\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2557\n\u2551  \u26a0\ufe0f  ATTENTION \u2014 SIGNATURE INVALIDE        \u2551\n\u2551                                              \u2551\n\u2551  La facture existe dans le registre mais     \u2551\n\u2551  la signature cryptographique ne correspond  \u2551\n\u2551  pas. Ce document a peut-\u00eatre \u00e9t\u00e9 modifi\u00e9    \u2551\n\u2551  apr\u00e8s son \u00e9mission.                         \u2551\n\u2551                                              \u2551\n\u2551  Contactez le commer\u00e7ant et la DGI.          \u2551\n\u255a\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u255d\n</code></pre>"},{"location":"20-fiscal-platform/fiscal/invoice-verification/#privacy-constraints","title":"Privacy constraints","text":"<p>The public portal shows a limited summary \u2014 merchant name, date, total amount, and verification status. It does not expose:</p> <ul> <li>Individual line items or item descriptions</li> <li>Client (buyer) name or NIF</li> <li>Payment method details</li> <li>Raw canonical payload or ledger hashes</li> </ul> <p>Merchants can optionally enable full receipt display for verified invoices via a dashboard toggle. Default: summary only.</p>"},{"location":"20-fiscal-platform/fiscal/invoice-verification/#verification-api","title":"Verification API","text":""},{"location":"20-fiscal-platform/fiscal/invoice-verification/#verify-by-fiscal-number","title":"Verify by fiscal number","text":"<pre><code>GET /api/v1/verify/{fiscal_number}?auth_code={auth_code}\n</code></pre> <p>No authentication required. This is a public endpoint. Rate-limited to prevent abuse.</p> <p>Response (200 \u2014 verified):</p> <pre><code>{\n  \"status\": \"verified\",\n  \"fiscal_number\": \"BONO-OUTLET001-000123\",\n  \"fiscal_authority_id\": \"HSM-CLUSTER-01\",\n  \"merchant_name\": \"Acme SARL\",\n  \"outlet_name\": \"Kinshasa Branch\",\n  \"timestamp\": \"2026-02-17T14:32:00Z\",\n  \"total\": 116000,\n  \"currency\": \"CDF\",\n  \"invoice_type\": \"sale\",\n  \"signature_valid\": true,\n  \"ledger_chain_valid\": true,\n  \"dgi_status\": \"synced\",\n  \"dgi_acknowledged_at\": \"2026-02-17T14:35:12Z\"\n}\n</code></pre> <p>Response (404 \u2014 not found):</p> <pre><code>{\n  \"status\": \"not_found\",\n  \"fiscal_number\": \"BONO-OUTLET001-999999\",\n  \"message\": \"No invoice found with this fiscal number.\"\n}\n</code></pre> <p>Response (200 \u2014 tampered):</p> <pre><code>{\n  \"status\": \"tampered\",\n  \"fiscal_number\": \"BONO-OUTLET001-000123\",\n  \"message\": \"Invoice exists but the provided auth_code does not match the signature on record.\",\n  \"signature_valid\": false\n}\n</code></pre>"},{"location":"20-fiscal-platform/fiscal/invoice-verification/#verify-by-qr-payload","title":"Verify by QR payload","text":"<pre><code>POST /api/v1/verify/qr\nContent-Type: application/json\n\n{\n  \"qr_data\": \"https://verify.stalela.cd/i?fn=BONO-OUTLET001-000123&amp;ac=MEUCIQD8j2w8s...&amp;ts=2026-02-17T14:32:00Z&amp;fa=HSM-CLUSTER-01\"\n}\n</code></pre> <p>The API parses the QR data, extracts the fiscal number and auth code, and performs the same verification flow. This endpoint is useful for mobile apps that decode QR images.</p>"},{"location":"20-fiscal-platform/fiscal/invoice-verification/#bulk-verification","title":"Bulk verification","text":"<pre><code>POST /api/v1/verify/batch\nContent-Type: application/json\nAuthorization: Bearer bono_key_abc123\n\n{\n  \"invoices\": [\n    { \"fiscal_number\": \"BONO-OUTLET001-000123\", \"auth_code\": \"MEUCIQD8j2w8s...\" },\n    { \"fiscal_number\": \"BONO-OUTLET001-000124\", \"auth_code\": \"MEUCIQCx9k...\" },\n    { \"fiscal_number\": \"BONO-OUTLET001-000125\", \"auth_code\": \"MEUCIQDp2...\" }\n  ]\n}\n</code></pre> <p>Response (200):</p> <pre><code>{\n  \"results\": [\n    { \"fiscal_number\": \"BONO-OUTLET001-000123\", \"status\": \"verified\", \"signature_valid\": true },\n    { \"fiscal_number\": \"BONO-OUTLET001-000124\", \"status\": \"verified\", \"signature_valid\": true },\n    { \"fiscal_number\": \"BONO-OUTLET001-000125\", \"status\": \"not_found\" }\n  ],\n  \"verified_count\": 2,\n  \"not_found_count\": 1,\n  \"tampered_count\": 0\n}\n</code></pre> <p>Bulk verification requires authentication (Bearer token) and is rate-limited separately (10 req/s, max 100 invoices per batch).</p>"},{"location":"20-fiscal-platform/fiscal/invoice-verification/#cryptographic-verification-flow","title":"Cryptographic verification flow","text":"<p>The verification service performs these checks in order:</p> <pre><code>flowchart TD\n    INPUT[\"Fiscal number + auth code\"] --&gt; LOOKUP[\"1. Look up fiscal_number\\nin Fiscal Ledger\"]\n    LOOKUP --&gt;|Not found| NF[\"\u274c NOT FOUND\"]\n    LOOKUP --&gt;|Found| SIGCHECK[\"2. Verify ECDSA signature\\nusing HSM public key\"]\n    SIGCHECK --&gt;|Invalid| TAMPERED[\"\u26a0\ufe0f TAMPERED\"]\n    SIGCHECK --&gt;|Valid| AUTHCHECK[\"3. Compare auth_code\\nwith stored value\"]\n    AUTHCHECK --&gt;|Mismatch| TAMPERED\n    AUTHCHECK --&gt;|Match| TSCHECK[\"4. Verify timestamp\\nagainst ledger ordering\"]\n    TSCHECK --&gt;|Anomaly| TAMPERED\n    TSCHECK --&gt;|Valid| CHAINCHECK[\"5. Verify hash chain\\n(previous + current entry)\"]\n    CHAINCHECK --&gt;|Broken| TAMPERED\n    CHAINCHECK --&gt;|Valid| VERIFIED[\"\u2705 VERIFIED\"]</code></pre>"},{"location":"20-fiscal-platform/fiscal/invoice-verification/#step-details","title":"Step details","text":"Step What is checked Failure meaning 1. Ledger lookup Fiscal number exists in the append-only Fiscal Ledger Invoice was never sealed by Stalela \u2014 possible counterfeit 2. Signature verification ECDSA signature over canonical payload is valid against the HSM's registered public key Invoice data was modified after signing \u2014 tampered 3. Auth code comparison Provided <code>auth_code</code> matches the stored cryptographic authentication code The auth code on the receipt doesn't match the original \u2014 possible forgery 4. Timestamp validation Timestamp is consistent with the ledger's monotonic ordering for that outlet Timestamp was backdated or replayed 5. Hash chain integrity The ledger entry's hash links correctly to the previous entry Ledger was tampered with \u2014 entries inserted, deleted, or reordered"},{"location":"20-fiscal-platform/fiscal/invoice-verification/#public-key-distribution","title":"Public key distribution","text":"<ul> <li>The HSM's public key is published at <code>verify.stalela.cd/.well-known/fiscal-keys.json</code>.</li> <li>Keys are rotated according to the HSM key lifecycle (see ADR-0002). Old public keys remain available for verifying historical invoices.</li> <li>The DGI receives the public key during registration and can independently verify signatures without calling the Stalela API.</li> </ul> <pre><code>GET https://verify.stalela.cd/.well-known/fiscal-keys.json\n\n{\n  \"keys\": [\n    {\n      \"fiscal_authority_id\": \"HSM-CLUSTER-01\",\n      \"algorithm\": \"ECDSA-P256\",\n      \"public_key\": \"MFkwEwYHKoZIzj0CAQYIKoZIzj0DAQcDQgAE...\",\n      \"valid_from\": \"2026-03-01T00:00:00Z\",\n      \"valid_until\": null,\n      \"status\": \"active\"\n    }\n  ]\n}\n</code></pre>"},{"location":"20-fiscal-platform/fiscal/invoice-verification/#qr-code-payload-format","title":"QR code payload format","text":"<p>The QR code on every receipt encodes a URL that the verification portal can parse directly:</p> <pre><code>https://verify.stalela.cd/i?fn={fiscal_number}&amp;ac={auth_code}&amp;ts={timestamp}&amp;fa={fiscal_authority_id}\n</code></pre> Parameter Description Example <code>fn</code> Fiscal number <code>BONO-OUTLET001-000123</code> <code>ac</code> Cryptographic auth code (Base64URL-encoded ECDSA signature) <code>MEUCIQD8j2w8s...</code> <code>ts</code> Trusted timestamp (ISO 8601 UTC) <code>2026-02-17T14:32:00Z</code> <code>fa</code> Fiscal authority ID <code>HSM-CLUSTER-01</code> <p>The QR code is generated as a QR Code Model 2 with error correction level H (30% recovery) to ensure readability on thermal prints, wrinkled paper, and low-resolution phone cameras.</p>"},{"location":"20-fiscal-platform/fiscal/invoice-verification/#whatsapp-verification","title":"WhatsApp verification","text":"<p>The WhatsApp Invoice Bot (see AI &amp; Natural Language Capabilities) supports invoice verification as a public service \u2014 anyone with the bot's number can verify:</p> <p>By text:</p> <pre><code>User: V\u00e9rifier facture BONO-OUTLET001-000123\nBot:  \u2705 FACTURE V\u00c9RIFI\u00c9E\n      Commer\u00e7ant: Acme SARL\n      Date: 17 f\u00e9v 2026, 14:32\n      Montant: 116 000 FC\n      DGI: Synchronis\u00e9 \u2705\n</code></pre> <p>By QR photo:</p> <pre><code>User: [sends photo of receipt QR code]\nBot:  Scanning QR... \u2705 FACTURE V\u00c9RIFI\u00c9E\n      N\u00b0 Fiscal: BONO-OUTLET001-000123\n      Commer\u00e7ant: Acme SARL\n      Date: 17 f\u00e9v 2026, 14:32\n      Montant: 116 000 FC\n      DGI: Synchronis\u00e9 \u2705\n</code></pre> <p>Failed verification:</p> <pre><code>User: V\u00e9rifier facture FAKE-000001\nBot:  \u274c FACTURE NON TROUV\u00c9E\n      Ce num\u00e9ro fiscal n'existe pas dans le syst\u00e8me Stalela.\n      Si vous pensez que c'est une erreur, contactez le commer\u00e7ant.\n</code></pre>"},{"location":"20-fiscal-platform/fiscal/invoice-verification/#phase-phase-2-alongside-whatsapp-bot-launch","title":"Phase: Phase 2 (alongside WhatsApp bot launch)","text":""},{"location":"20-fiscal-platform/fiscal/invoice-verification/#sdk-verification-helpers","title":"SDK verification helpers","text":"<p>Both the JavaScript and Python SDKs include verification methods:</p>"},{"location":"20-fiscal-platform/fiscal/invoice-verification/#javascript-sdk","title":"JavaScript SDK","text":"<pre><code>import { Stalela } from '@stalela/sdk';\n\nconst client = new Stalela(); // No API key needed for verification\n\n// Verify single invoice\nconst result = await client.verify('BONO-OUTLET001-000123', {\n  authCode: 'MEUCIQD8j2w8s...'\n});\nconsole.log(result.status);          // \"verified\"\nconsole.log(result.signatureValid);  // true\nconsole.log(result.dgiStatus);       // \"synced\"\n\n// Verify from QR data\nconst result = await client.verifyQR(\n  'https://verify.stalela.cd/i?fn=BONO-OUTLET001-000123&amp;ac=MEUCIQD8j2w8s...'\n);\n\n// Offline signature verification (no API call)\nconst valid = client.verifySignatureOffline(payload, signature, publicKey);\n</code></pre>"},{"location":"20-fiscal-platform/fiscal/invoice-verification/#python-sdk","title":"Python SDK","text":"<pre><code>from stalela import Stalela\n\nclient = Stalela()  # No API key needed for verification\n\n# Verify single invoice\nresult = client.verify(\"BONO-OUTLET001-000123\", auth_code=\"MEUCIQD8j2w8s...\")\nprint(result.status)           # \"verified\"\nprint(result.signature_valid)  # True\n\n# Bulk verify\nresults = client.verify_batch([\n    {\"fiscal_number\": \"BONO-OUTLET001-000123\", \"auth_code\": \"MEUCIQD8j2w8s...\"},\n    {\"fiscal_number\": \"BONO-OUTLET001-000124\", \"auth_code\": \"MEUCIQCx9k...\"},\n])\n\n# Offline signature verification\nvalid = client.verify_signature_offline(payload, signature, public_key)\n</code></pre>"},{"location":"20-fiscal-platform/fiscal/invoice-verification/#offline-verification","title":"Offline verification","text":"<p>The SDKs also support offline signature verification \u2014 given the canonical payload, the ECDSA signature, and the HSM's public key (cached from <code>/.well-known/fiscal-keys.json</code>), the SDK can verify the signature without calling the API. This is useful for:</p> <ul> <li>Auditors verifying large batches of invoices without rate limit concerns.</li> <li>DGI systems that verify signatures in their own infrastructure.</li> <li>Air-gapped environments where internet access is restricted.</li> </ul> <p>Offline verification checks the cryptographic signature only. It does not confirm ledger chain integrity, DGI sync status, or whether the invoice was voided/refunded after sealing.</p>"},{"location":"20-fiscal-platform/fiscal/invoice-verification/#dashboard-verification","title":"Dashboard verification","text":"<p>The merchant dashboard includes inline verification:</p> <ul> <li>Verification badge \u2014 every invoice in the dashboard shows a verification status icon (\u2705 verified, \u26a0\ufe0f chain anomaly, \ud83d\udd04 pending sync).</li> <li>Public link \u2014 each invoice detail page has a \"Share verification link\" button that copies the <code>verify.stalela.cd</code> URL for that invoice.</li> <li>Bulk verify \u2014 merchants can select multiple invoices and run batch verification to confirm ledger integrity. This is useful after system migrations or to prepare for audits.</li> <li>Verification log \u2014 the dashboard shows how many times each invoice has been verified via the public portal, with timestamps and source channel (QR scan, manual entry, API, WhatsApp). No verifier identity is recorded.</li> </ul>"},{"location":"20-fiscal-platform/fiscal/invoice-verification/#anti-abuse-protections","title":"Anti-abuse protections","text":"<p>The public verification endpoints are unauthenticated by design \u2014 anyone should be able to verify an invoice. However, abuse prevention is critical:</p> Protection Detail Rate limiting Single-invoice verification: 30 req/min per IP. Bulk: 10 req/s per API key, max 100 per batch. CAPTCHA Portal shows CAPTCHA after 10 consecutive lookups from the same session. API endpoint is CAPTCHA-free. No enumeration 404 responses do not reveal whether the fiscal number format is valid \u2014 all non-matching inputs return the same \"not found\" response. Timing-safe comparison Auth code comparison uses constant-time comparison to prevent timing attacks. Logging Excessive verification attempts for the same fiscal number trigger an <code>invoice.verification_spike</code> alert (anomaly detection). Geo-restriction (optional) Merchants can restrict public verification to DRC IP ranges if they want to limit external probing."},{"location":"20-fiscal-platform/fiscal/invoice-verification/#phasing","title":"Phasing","text":"Capability Phase 1 Phase 2 Phase 4 Public Verification Portal \u2705 Web portal + QR scanning \u2014 \u2014 Verification API (single + QR) \u2705 Public, rate-limited \u2014 \u2014 SDK <code>verify()</code> + <code>verifyQR()</code> \u2705 In JS + Python SDKs \u2014 \u2014 Offline signature verification \u2705 SDK offline mode \u2014 \u2014 Public key distribution (JWKS) \u2705 <code>/.well-known/fiscal-keys.json</code> \u2014 \u2014 Dashboard verification badges \u2705 Inline badges + share link \u2014 \u2014 Bulk verification API \u2014 \u2705 Authenticated, batch endpoint \u2014 WhatsApp verification \u2014 \u2705 Text + QR photo \u2014 Verification analytics \u2014 \u2014 \u2705 Verification heatmaps, fraud detection"},{"location":"20-fiscal-platform/fiscal/reports/","title":"Reports (Z / X / A and Audit Export)","text":"<p>Stalela delivers the mandatory Z, X, and A reports plus an audit export directly from the Fiscal Ledger \u2014 the append-only, hash-chained journal maintained by the Cloud Signing Service. These reports are produced from the same canonical data that powers invoices, include the cloud-generated security elements (<code>fiscal_authority_id</code>, <code>fiscal_number</code>, <code>auth_code</code>, <code>trusted_timestamp</code>, <code>qr_payload</code>), and can be generated on demand or on a schedule for auditors and the DGI.</p>"},{"location":"20-fiscal-platform/fiscal/reports/#report-catalog","title":"Report catalog","text":"Report Purpose Frequency Primary audience Z report Daily closure with per-tax-group totals and invoice range End of day / merchant close Merchant, auditor, DGI X report Mid-period snapshot for shifts, sessions, and spot checks Hourly / shift / on-demand Merchant supervisors, auditors A report Line-item detail across invoices filtered by time period Ad-hoc (audits, inspections) Auditors, inspectors Audit export Full hash-chained journal dump (sales, voids, refunds) Scheduled or triggered by DGI DGI, compliance teams"},{"location":"20-fiscal-platform/fiscal/reports/#z-report-daily-closure","title":"Z report (Daily closure)","text":"<ul> <li>What it tells you: The exact invoice sequence consumed that day plus totals for every tax group, payment method, and grand totals. Use it to reconcile the fiscal counter and to prove that no invoice was skipped.</li> <li>How it's produced: The Report Generator samples the Fiscal Ledger after the last invoice of the day, collects the totals, and signs the report via the Cloud Signing Service. The report is stored in the cloud and available via the dashboard and API.</li> <li>Key fields: <code>outlet_id</code>, <code>fiscal_authority_id</code>, <code>date</code>, <code>sequence_start</code>, <code>sequence_end</code>, <code>invoice_count</code>, <code>tax_totals</code>, <code>grand_totals</code>, <code>ledger_hash</code>, <code>generated_at</code>.</li> </ul>"},{"location":"20-fiscal-platform/fiscal/reports/#x-report-session-snapshot","title":"X report (Session snapshot)","text":"<ul> <li>What it tells you: Where the outlet stands mid-shift: invoiced range, totals by payment instrument, platform health, and any warning flags (e.g., sync delays, offline clients).</li> <li>How it's produced: Triggered on demand, at the start/end of a shift, or automatically (e.g., hourly). It helps supervisors detect drift before the day closes.</li> <li>Key fields: <code>period_id</code>, <code>sequence_start</code>, <code>sequence_end</code>, <code>totals</code>, <code>platform_status</code>, <code>generated_at</code>.</li> </ul>"},{"location":"20-fiscal-platform/fiscal/reports/#a-report-article-level-detail","title":"A report (Article-level detail)","text":"<ul> <li>What it tells you: Every line item contributing to the invoices in a time range, including <code>tax_group</code>, <code>tax_rate</code>, <code>client_classification</code>, <code>line_total</code>, and a reference to the originating invoice.</li> <li>How it's produced: Filtered view over the Fiscal Ledger entries; the Report Generator assembles the subset using the merchant's product metadata and the canonical payloads stored alongside each sealed invoice.</li> <li>Key fields: <code>invoice_ref</code>, <code>article_id</code>, <code>description</code>, <code>quantity</code>, <code>unit_price</code>, <code>tax_group</code>, <code>tax_rate</code>, <code>tax_amount</code>, <code>client_classification</code>, <code>generated_at</code>.</li> </ul>"},{"location":"20-fiscal-platform/fiscal/reports/#audit-export-full-journal-dump","title":"Audit export (Full journal dump)","text":"<ul> <li>What it tells you: The complete, append-only Fiscal Ledger (sales, voids, refunds, credit notes) with hashes, signatures, and all canonical payload metadata. Ideal for DGI reconciliation or for auditors that need a forensic copy.</li> <li>How it's produced: Read each ledger entry sequentially, attach <code>prev_hash</code>, <code>signature</code>, and <code>canonical_payload_hash</code>, then stream entries in chunked batches (<code>chunk_index</code>, <code>chunk_count</code>). Each chunk is acknowledged before the next is delivered to avoid partial exports.</li> <li>Key fields per entry: <code>record_type</code>, <code>sequence</code>, <code>timestamp</code>, <code>merchant_nif</code>, <code>client</code>, <code>totals</code>, <code>tax_breakdown</code>, <code>prev_hash</code>, <code>signature</code>, <code>canonical_payload_hash</code>.</li> </ul>"},{"location":"20-fiscal-platform/fiscal/reports/#sample-report-outputs","title":"Sample report outputs","text":"<pre><code>{\n  \"type\": \"Z\",\n  \"date\": \"2026-02-16\",\n  \"outlet_id\": \"OUTLET-42\",\n  \"fiscal_authority_id\": \"HSM-CLUSTER-01\",\n  \"sequence_start\": 101,\n  \"sequence_end\": 125,\n  \"invoice_count\": 25,\n  \"tax_totals\": [\n    { \"tax_group\": \"TG02\", \"base_amount\": \"15000.00\", \"tax_amount\": \"2400.00\" },\n    { \"tax_group\": \"TG01\", \"base_amount\": \"500.00\", \"tax_amount\": \"0.00\" }\n  ],\n  \"grand_totals\": { \"subtotal\": \"15500.00\", \"total_vat\": \"2400.00\", \"total\": \"17900.00\", \"currency\": \"CDF\" },\n  \"ledger_hash\": \"3F9B-7A12-...\",\n  \"generated_at\": \"2026-02-16T23:58:30Z\"\n}\n</code></pre> <pre><code>{\n  \"type\": \"X\",\n  \"period_id\": \"Shift-A-2026-02-16-08\",\n  \"sequence_start\": 101,\n  \"sequence_end\": 110,\n  \"invoice_count\": 10,\n  \"totals\": {\n    \"cash\": { \"subtotal\": \"4800.00\", \"tax\": \"768.00\", \"total\": \"5568.00\" },\n    \"mobile_money\": { \"subtotal\": \"2200.00\", \"tax\": \"352.00\", \"total\": \"2552.00\" }\n  },\n  \"platform_status\": {\n    \"cloud_signing_service\": \"healthy\",\n    \"pending_sync\": 0,\n    \"next_invoice_seq\": 111\n  },\n  \"generated_at\": \"2026-02-16T13:00:00Z\"\n}\n</code></pre> <pre><code>{\n  \"type\": \"A\",\n  \"reporting_period\": \"2026-02-16\",\n  \"entries\": [\n    {\n      \"invoice_ref\": \"BONO-OUTLET42-110\",\n      \"description\": \"Wholesale service plan\",\n      \"quantity\": 1,\n      \"unit_price\": \"10000.00\",\n      \"line_total\": \"10000.00\",\n      \"tax_group\": \"TG03\",\n      \"tax_rate\": \"0.16\",\n      \"tax_amount\": \"1600.00\",\n      \"client_classification\": \"Company\",\n      \"generated_at\": \"2026-02-16T13:05:32Z\"\n    }\n  ]\n}\n</code></pre> <pre><code>{\n  \"type\": \"AUDIT_EXPORT\",\n  \"chunk_index\": 2,\n  \"chunk_count\": 5,\n  \"fiscal_authority_id\": \"HSM-CLUSTER-01\",\n  \"entries\": [\n    {\n      \"sequence\": 109,\n      \"record_type\": \"sale\",\n      \"timestamp\": \"2026-02-16T12:54:17Z\",\n      \"total\": \"116.00\",\n      \"tax_breakdown\": [{ \"tax_group\": \"TG02\", \"tax_amount\": \"16.00\" }],\n      \"prev_hash\": \"A4B2\",\n      \"signature\": \"ABCD1234EFGH\",\n      \"canonical_payload_hash\": \"8F3C\"\n    }\n  ],\n  \"generated_at\": \"2026-02-16T23:59:50Z\"\n}\n</code></pre>"},{"location":"20-fiscal-platform/fiscal/reports/#report-generation-flow","title":"Report generation flow","text":"<pre><code>sequenceDiagram\n    participant Client as Client App\n    participant Cloud as Stalela Cloud\n    participant HSM as Cloud Signing Service\n    participant Ledger as Fiscal Ledger\n    participant DGI as DGI\n\n    Client-&gt;&gt;Cloud: POST /invoices (canonical payload)\n    Cloud-&gt;&gt;HSM: Sign and assign fiscal number\n    HSM--&gt;&gt;Cloud: sealed response (fiscal_number, auth_code, timestamp, qr)\n    Cloud-&gt;&gt;Ledger: Append hash-chained entry\n    Cloud--&gt;&gt;Client: sealed invoice response\n    Note over Cloud,Ledger: Report Generator queries Fiscal Ledger\n    Cloud-&gt;&gt;DGI: Sync sealed invoices + reports (Z/X/A as needed)</code></pre> <p>Every sealed invoice creates a ledger entry that can be sampled by the Report Generator. Z reports are emitted at end-of-day closing, X reports are generated on shift/period boundaries, and A reports can be filtered per auditor request. Audit exports walk the ledger in order, so auditors always receive the hash chain and signature sequence to prove immutability.</p>"},{"location":"20-fiscal-platform/fiscal/reports/#using-the-reports","title":"Using the reports","text":"<ol> <li>During operations \u2014 Supervisors pull X reports via the dashboard or API to ensure totals match expected revenue and to monitor platform health (sync status, pending invoices, warning flags for connectivity issues).</li> <li>At close-of-day \u2014 Merchants run the Z report, download or print it, and archive the output alongside the receipts; the report's <code>ledger_hash</code> acts as a tamper-evident fingerprint of that day.</li> <li>Audits \u2014 Inspectors request A reports for specific clients, products, or dates. The exported lines include references to the canonical payload so they can verify the tax group and client classification.</li> <li>DGI exports \u2014 The audit export stream replicates the full Fiscal Ledger to the tax authority (chunked if necessary). Each chunk is acknowledged before the next is delivered to protect against network interruptions.</li> </ol> <p>No data is deleted: voids and refunds appear as separate entries in every report, and the audit export documents the corrective events with their own <code>sequence</code> numbers. When a client application is temporarily offline, unsigned payloads are queued locally and submitted once connectivity returns \u2014 reports reflect only invoices that have been sealed by the Cloud Signing Service.</p>"},{"location":"20-fiscal-platform/fiscal/security-elements/","title":"Security Elements on Invoices","text":"<p>The DGI SFE specification and the Stalela architecture mandate that every fiscal event carries five immutable security elements. In Phase 1 (Software Invoicing), the Cloud Signing Service (HSM) owns the counters, identifiers, timestamps, and signatures that prove an invoice was issued by an authorized system. Client applications (web dashboard, API consumers, SDK integrators) must treat these values as sealed outputs \u2014 they may display them but never fabricate or modify them.</p> <p>Cloud-generated security elements</p> <p>Client applications MAY NOT fabricate any of these values. They are generated inside the Cloud Signing Service (HSM), travel only in sealed responses, and are recorded in the append-only Fiscal Ledger. Missing or modified elements invalidate the invoice.</p> <p>Phase 3 \u2014 USB Hardware</p> <p>In Phase 3, the USB Fiscal Memory device (DEF) can replace or augment the Cloud Signing Service as the trusted signer for merchants who need full DEF homologation. The five elements remain identical; only the generation source changes. Hardware details are archived in <code>docs-archive/hardware/</code>.</p>"},{"location":"20-fiscal-platform/fiscal/security-elements/#sequential-fiscal-invoice-number","title":"Sequential fiscal invoice number","text":"<ul> <li>What it is: A monotonic, non-resettable counter that assigns every invoice a unique fiscal number and anchors the hash-chained Fiscal Ledger used for reports.</li> <li>Generated by: The Cloud Signing Service via the Monotonic Counter Manager (Online), or the Fiscal Extension (Offline Phase 1.5) strictly within its pre-allocated block of numbers.</li> <li>Receipt placement: Prominently printed near the merchant header so auditors see the outlet-level fiscal sequence.</li> <li>Verification: The dashboard, API consumers, and DGI compare the printed number with the Fiscal Ledger entry, the Z/X reports, and the expected counter for that outlet.</li> <li>Missing / invalid: The invoice is immediately rejected by the DGI and cannot be synchronized; the client must re-submit the canonical payload so the Cloud Signing Service can issue a new fiscal number.</li> </ul>"},{"location":"20-fiscal-platform/fiscal/security-elements/#fiscal-authority-id","title":"Fiscal authority ID","text":"<ul> <li>What it is: A unique identifier for the Cloud Signing Service instance (or HSM cluster) that produced the fiscal response. In Phase 3, this maps to the DEF NID for USB-signed invoices.</li> <li>Generated by: Assigned during HSM provisioning; the Cloud Signing Service includes it in every sealed response alongside the fiscal number and signature.</li> <li>Receipt placement: Printed beside the fiscal number in the security block so inspectors can trace the signing authority.</li> <li>Verification: Auditors and the DGI cross-check the fiscal authority ID against the registered HSM public key in the Stalela Cloud registry.</li> <li>Missing / invalid: Without a fiscal authority ID, the invoice cannot be tied to a certified signing service, and the DGI must mark it non-compliant.</li> </ul>"},{"location":"20-fiscal-platform/fiscal/security-elements/#cryptographic-authentication-code-signature","title":"Cryptographic authentication code (signature)","text":"<ul> <li>What it is: An ECDSA signature over the canonical payload, fiscal number, timestamp, and ledger metadata that proves the Cloud Signing Service approved the invoice.</li> <li>Generated by: The HSM inside the Cloud Signing Service (Online), or the Fiscal Extension using a short-lived Delegated Credential (Offline Phase 1.5).</li> <li>Receipt placement: Included in the security block or encoded inside the QR code so scanning software can verify it.</li> <li>Verification: The DGI, auditors, and Stalela dashboard validate the signature using the HSM's public key from the registry; signatures that fail verification trigger rejection.</li> <li>Missing / invalid: If the signature is absent or fails verification, the invoice is treated as unauthenticated and cannot be lodged with the DGI; the client must re-submit the payload for re-signing.</li> </ul>"},{"location":"20-fiscal-platform/fiscal/security-elements/#trusted-timestamp","title":"Trusted timestamp","text":"<ul> <li>What it is: A UTC timestamp anchored to NTP-synced cloud infrastructure that records when the Cloud Signing Service sealed the invoice.</li> <li>Generated by: The Cloud Signing Service at the moment of signing (Online), or the Fiscal Extension's local clock (Offline Phase 1.5). During reconciliation, the Cloud verifies that the offline timestamp falls within the validity window of the Delegated Credential.</li> <li>Receipt placement: Shown near the fiscal number / authority ID block and embedded in the QR payload to prove when the invoice was sealed.</li> <li>Verification: The Fiscal Ledger enforces monotonic ordering per outlet; the DGI and auditors compare timestamps against ledger order to detect drift or replay.</li> <li>Missing / invalid: Invoices without a trusted timestamp are non-compliant, cannot be reconciled with Z/X reports, and raise alerts for potential tampering.</li> </ul>"},{"location":"20-fiscal-platform/fiscal/security-elements/#qr-code-encoding-verification-data","title":"QR code encoding verification data","text":"<ul> <li>What it is: A machine-readable encoding of the fiscal number, fiscal authority ID, timestamp, signature, and a verification URL so inspectors and the DGI can validate the invoice.</li> <li>Generated by: The Cloud Signing Service (Online) or the Fiscal Extension (Offline Phase 1.5) after signing; the QR payload contains the sealed data that client applications render on receipts and the Sync Agent uploads to the DGI.</li> <li>Receipt placement: Typically printed at the bottom of the receipt, adjacent to the totals and security block.</li> <li>Verification: Inspectors and software scan the QR code to replay the data, validate the signature, and confirm the fiscal authority match. The QR encodes a URL to the public verification portal at <code>verify.stalela.cd</code> \u2014 see Invoice Verification for the full verification flow, API, and cryptographic chain checks.</li> <li>Missing / invalid: Without the QR code the invoice fails the compliance checklist, and the DGI upload pipeline flags it as incomplete.</li> </ul>"},{"location":"20-fiscal-platform/fiscal/security-elements/#mock-receipt-layout","title":"Mock receipt layout","text":"<pre><code>flowchart TB\n  subgraph receipt[\"Mock receipt \u2014 Stalela fiscalized\"]\n    merchant[\"Merchant + outlet info\"]\n    fiscal[\"Fiscal number\\nFiscal authority ID\"]\n    timestamp[\"Trusted timestamp\"]\n    signature[\"Cryptographic authentication code\"]\n    qr[\"QR code \u2014 verification payload\"]\n  end\n  merchant --&gt; fiscal --&gt; timestamp --&gt; signature --&gt; qr</code></pre> <p>The diagram above shows how the five security elements are grouped near the receipt header and security block so every printout carries the data inspectors need. The QR code encapsulates the entire sealed payload, making verification a single scan away.</p>"},{"location":"20-fiscal-platform/fiscal/security-elements/#hash-chain-integrity","title":"Hash-chain integrity","text":"<p>Every entry in the Fiscal Ledger is hash-chained to its predecessor, creating a tamper-evident, append-only sequence that auditors and the DGI can verify independently.</p>"},{"location":"20-fiscal-platform/fiscal/security-elements/#how-it-works","title":"How it works","text":"<ol> <li>Genesis entry: The first invoice sealed for an outlet produces a ledger entry whose <code>previous_hash</code> is a well-known zero value (<code>0x00\u202600</code>). The Cloud Signing Service computes <code>entry_hash = SHA-256(fiscal_number \u2016 canonical_payload_hash \u2016 signature \u2016 timestamp \u2016 previous_hash)</code> and stores it alongside the sealed invoice.</li> <li>Subsequent entries: Each new ledger entry includes the <code>entry_hash</code> of the immediately preceding entry as its <code>previous_hash</code>. The resulting chain means altering any past entry changes every hash that follows it.</li> <li>Scope: Hash chains are maintained per outlet so each outlet has an independent, verifiable sequence aligned with its monotonic fiscal number counter.</li> </ol>"},{"location":"20-fiscal-platform/fiscal/security-elements/#ledger-entry-structure","title":"Ledger entry structure","text":"Field Description <code>fiscal_number</code> Sequential invoice number for the outlet <code>canonical_payload_hash</code> SHA-256 of the deterministic canonical payload <code>signature</code> ECDSA signature produced by the Cloud Signing Service (HSM) <code>timestamp</code> Trusted UTC timestamp at the moment of signing <code>previous_hash</code> <code>entry_hash</code> of the preceding ledger entry (<code>0x00\u202600</code> for the first) <code>entry_hash</code> SHA-256 of the concatenation of all fields above"},{"location":"20-fiscal-platform/fiscal/security-elements/#chain-verification","title":"Chain verification","text":"<pre><code>flowchart LR\n  A[\"Entry N-1\\nentry_hash: abc123\"] --&gt;|previous_hash| B[\"Entry N\\nentry_hash: def456\"]\n  B --&gt;|previous_hash| C[\"Entry N+1\\nentry_hash: ghi789\"]</code></pre> <ul> <li>Online verification: The Invoice Verification API checks that the entry's <code>previous_hash</code> matches the preceding entry's <code>entry_hash</code> and recomputes the hash to confirm integrity.</li> <li>Audit verification: Z/X/A reports include the opening and closing <code>entry_hash</code> for the period. Auditors walk the chain between those anchors to confirm no entries were inserted, removed, or modified.</li> <li>Tamper detection: If any entry is altered, every subsequent <code>entry_hash</code> becomes invalid. The anomaly detection system flags hash-chain breaks as critical alerts.</li> </ul>"},{"location":"20-fiscal-platform/fiscal/security-elements/#immutability-guarantees","title":"Immutability guarantees","text":"<ul> <li>Append-only: The Fiscal Ledger never updates or deletes entries. Voids, refunds, and credit notes are new fiscal events with their own fiscal numbers and chain links.</li> <li>Gap detection: The Monotonic Counter Manager and hash chain together ensure that a missing fiscal number also breaks the chain, making gaps immediately detectable.</li> <li>Cross-verification: The DGI receives both the sealed invoice and the <code>entry_hash</code> via the Sync Agent, enabling independent chain reconstruction and verification on the regulatory side.</li> </ul>"},{"location":"20-fiscal-platform/fiscal/security-elements/#maintaining-compliance","title":"Maintaining compliance","text":"<p>Client applications always send the canonical payload to the Cloud Signing Service, which returns the five sealed security elements. Even when a client is temporarily offline, it queues the unsigned payload locally (IndexedDB / SQLite) and submits it once connectivity returns \u2014 fiscalization only happens when the Cloud Signing Service processes the request. Missing elements, altered values, or attempts to generate them outside the Cloud Signing Service immediately invalidate the invoice and keep it out of the audit trail. If a submission fails (network timeout, validation error), the client retries the request so the Cloud Signing Service can issue all five elements together.</p>"},{"location":"20-fiscal-platform/fiscal/tax-engine/","title":"Tax Engine","text":""},{"location":"20-fiscal-platform/fiscal/tax-engine/#overview","title":"Overview","text":"<p>The Tax Engine is the jurisdiction-configurable component that computes per-line-item tax amounts, validates client classifications, and applies rounding rules before an invoice reaches the Cloud Signing Service (HSM). It loads its rules from the active jurisdiction profile \u2014 tax group codes, rates, client classifications, and rounding rules are all defined per country.</p> <pre><code>flowchart LR\n    JP[\"Jurisdiction Profile\\n(e.g., CD, KE, RW)\"] --&gt;|tax groups, rates,\\nclassifications| TE[\"Tax Engine\"]\n    INV[\"Canonical Invoice\\n(items, client, jurisdiction)\"] --&gt; TE\n    TE --&gt;|validated tax_summary| CSS[\"Cloud Signing Service (HSM)\"]</code></pre> <p>Regulatory constraint</p> <p>The tax engine must enforce the complete tax group manifest for the invoice's jurisdiction. If a tax group code is not present in the jurisdiction's manifest, the invoice must fail validation before it reaches the Cloud Signing Service.</p>"},{"location":"20-fiscal-platform/fiscal/tax-engine/#how-it-works","title":"How It Works","text":"<ol> <li>Read <code>jurisdiction</code> from the canonical invoice payload.</li> <li>Load the tax group manifest for that jurisdiction (codes, rates, decision tree) at the version specified by <code>tax_group_manifest_version</code>.</li> <li>Classify each line item using the jurisdiction's decision tree (catalog metadata + client classification \u2192 tax group code).</li> <li>Calculate <code>tax_amount</code> as <code>tax_base \u00d7 tax_rate</code> for each line.</li> <li>Round per the jurisdiction's currency rules (e.g., nearest 0.01 CDF for DRC, nearest 1 RWF for Rwanda).</li> <li>Populate <code>tax_summary</code> with one row per tax group code, including zero-amount entries for audit conformity.</li> <li>Attach the validated <code>tax_groups</code> and <code>tax_summary</code> to the canonical payload and forward to the Cloud Signing Service.</li> </ol>"},{"location":"20-fiscal-platform/fiscal/tax-engine/#jurisdiction-configured-elements","title":"Jurisdiction-Configured Elements","text":"Element Description Where Defined Tax Group Manifest Codes, names, default rates, decision tree <code>40-jurisdictions/{code}/tax-groups.md</code> Client Classifications Buyer categories and their tax behavior <code>40-jurisdictions/{code}/client-classifications.md</code> Invoice Types Permitted document types that may restrict tax groups <code>40-jurisdictions/{code}/invoice-types.md</code> Rounding Rules Minimum currency unit, rounding method, adjustment field <code>40-jurisdictions/{code}/currencies.md</code>"},{"location":"20-fiscal-platform/fiscal/tax-engine/#manifest-versioning","title":"Manifest Versioning","text":"<p>The <code>tax_group_manifest_version</code> field travels with every invoice so that audits can map totals to the rate set that was active at issuance. When a jurisdiction's tax authority publishes new rates or adds groups, the manifest version increments and the Tax Engine loads the updated rules.</p> <pre><code>{\n  \"jurisdiction\": \"CD\",\n  \"tax_group_manifest_version\": \"CD-2026-01\",\n  \"tax_groups\": [\n    { \"code\": \"TG02\", \"base\": \"100000.00\", \"rate\": \"0.16\", \"amount\": \"16000.00\" }\n  ]\n}\n</code></pre>"},{"location":"20-fiscal-platform/fiscal/tax-engine/#calculation-rounding-generic","title":"Calculation &amp; Rounding (Generic)","text":"<ol> <li>Calculate <code>tax_amount</code> as <code>tax_base \u00d7 tax_rate</code>.</li> <li>Round each line-level tax to the jurisdiction's minimum currency unit using the jurisdiction's rounding method; store any delta in <code>tax_rounding_adjustment</code>.</li> <li>Populate <code>tax_summary</code> with one row per tax group code, including zero-amount entries so auditors can verify conformity with the manifest.</li> <li>Apply export zero-rate groups only when the customer is outside the jurisdiction and the <code>invoice_type</code> indicates an export.</li> <li>Exempt classifications (e.g., embassy in DRC, diplomatic in Kenya) force the exempt tax group unless the authority provides an override logged in <code>tax_override_reason</code>.</li> </ol>"},{"location":"20-fiscal-platform/fiscal/tax-engine/#country-profiles","title":"Country Profiles","text":"<p>For jurisdiction-specific tax groups, decision trees, client classifications, and worked examples:</p> Jurisdiction Tax Groups Client Classifications Currencies DRC (CD) 14 groups (TG01\u2013TG14) 5 categories CDF/USD Zimbabwe (ZW) Planned Planned Planned Kenya (KE) Planned Planned Planned Rwanda (RW) Planned Planned Planned Tanzania (TZ) Planned Planned Planned Nigeria (NG) Planned Planned Planned South Africa (ZA) Planned Planned Planned <p>See Jurisdictions for the full framework and how to add a new country.</p>"},{"location":"20-fiscal-platform/fiscal/tax-engine/#implementation-guidance","title":"Implementation Guidance","text":"<ol> <li>Reference <code>spec/schema-tax-engine-1.md</code> for the canonical schema fields. Tax group codes are jurisdiction-namespaced (e.g., <code>TG01</code> for DRC, <code>A</code> for Kenya).</li> <li>Drive the taxonomy (export vs. local, special regime, excise) through catalog metadata and client classification \u2014 both are jurisdiction-configured.</li> <li>When the Cloud Signing Service returns the sealed fiscal response, persist <code>tax_summary</code> so you can regenerate Z/X/A reports that align with the manifest version.</li> <li>Update the jurisdiction's <code>tax_group_manifest_version</code> whenever the tax authority publishes new rates or groups.</li> </ol>"},{"location":"20-fiscal-platform/implementation/kanban/","title":"Kanban Board \u2014 Fiscal Epics","text":"<p>Unified Board</p> <p>Fiscal Platform epics are now tracked on the unified Stalela epic board alongside Payments Nucleus epics. See the Unified Epic Board for the complete view.</p> <p>Fiscal epics use the <code>FIS-*</code> prefix (FIS-01 through FIS-12).</p> <p>This page is preserved for reference. The canonical tracking location is the Unified Epic Board.</p>"},{"location":"20-fiscal-platform/implementation/kanban/#fiscal-epic-quick-reference","title":"Fiscal Epic Quick Reference","text":"Epic Name Sprint Status FIS-01 Cloud Signing Service (Alibaba KMS) 001 In Progress FIS-02 Invoicing API + Tax Engine 001 In Progress FIS-03 Fiscal Ledger (Hash-Chained) 001 In Progress FIS-04 Web Dashboard MVP 002 Selected for Dev FIS-05 JavaScript &amp; Python SDK 002 Selected for Dev FIS-06 Fiscal Reports 002 Selected for Dev FIS-07 Tax Authority Sync 003 Backlog FIS-08 Verification Portal 003 Backlog FIS-09 Compliance Tooling &amp; Onboarding 003 Backlog FIS-10 WhatsApp Invoice Bot + NL API 004 Backlog FIS-11 Fiscal Extension (Offline Signing) 004 Backlog FIS-12 Mobile Money Integration 004 Backlog"},{"location":"20-fiscal-platform/implementation/phase-1/","title":"Phase 1 \u2014 Software Invoicing","text":"<p>Phase 1 proves that the Stalela Cloud can deliver sealed, fiscally compliant invoices through an API-first platform, using the Cloud Signing Service (HSM) as the trusted fiscal authority, with a web dashboard, REST API, and SDKs.</p>"},{"location":"20-fiscal-platform/implementation/phase-1/#scope","title":"Scope","text":"<p>Cloud Signing Service + REST API + Web Dashboard + JavaScript/Python SDK + Z/X/A reports + manual DGI compliance tooling + public invoice verification portal.</p>"},{"location":"20-fiscal-platform/implementation/phase-1/#epics","title":"Epics","text":""},{"location":"20-fiscal-platform/implementation/phase-1/#1-cloud-signing-service-mvp","title":"1. Cloud Signing Service MVP","text":"<p>Description: Build the HSM-backed Cloud Signing Service that assigns sequential fiscal numbers, signs canonical payloads with ECDSA, generates QR codes, and stores everything in the append-only Fiscal Ledger.</p> <p>Acceptance criteria:</p> <ul> <li>Monotonic Counter Manager guarantees gap-free sequential numbering per outlet under serializable database isolation.</li> <li>HSM signs every canonical payload and returns <code>fiscal_number</code>, <code>auth_code</code>, <code>timestamp</code>, <code>qr_payload</code>, and <code>fiscal_authority_id</code>.</li> <li>Fiscal Ledger stores hash-chained entries; each entry references the previous hash for tamper detection.</li> <li>Invoice mutations (void, refund, credit note) create new fiscal events \u2014 nothing is deleted.</li> </ul> <p>Dependencies: <code>spec/architecture-kutapay-system-1.md</code>, <code>design/docs/architecture/trust-boundary.md</code>.</p>"},{"location":"20-fiscal-platform/implementation/phase-1/#2-rest-api-tax-engine","title":"2. REST API + Tax Engine","text":"<p>Description: Build the REST API that accepts canonical payloads, validates them through the tax engine (14 DGI groups + client classification), routes them to the Cloud Signing Service, and returns sealed responses.</p> <p>Acceptance criteria:</p> <ul> <li>API accepts canonical payloads with deterministic field ordering and validates all required fields.</li> <li>Tax Engine enforces TG01\u2013TG14, applies client classification rules (individual, company, commercial_individual, professional, embassy), and calculates rounding per <code>spec/schema-tax-engine-1.md</code>.</li> <li>API returns sealed responses with all five security elements.</li> <li>Error responses include actionable validation messages.</li> <li>Rate limiting (100 req/s per API key) and idempotency keys prevent abuse and duplicates.</li> </ul> <p>Dependencies: <code>spec/schema-tax-engine-1.md</code>, <code>design/docs/fiscal/tax-engine.md</code>.</p>"},{"location":"20-fiscal-platform/implementation/phase-1/#3-web-dashboard-mvp","title":"3. Web Dashboard MVP","text":"<p>Description: Deliver the web dashboard for invoice management, outlet administration, user/API key management, and report generation.</p> <p>Acceptance criteria:</p> <ul> <li>Dashboard supports invoice creation, viewing, filtering, and status tracking.</li> <li>Outlet registration and configuration via the dashboard.</li> <li>User and API key management with role-based access control (Cashier, Supervisor, Manager, Owner).</li> <li>Z/X/A report generation and download.</li> <li>Offline indicators for queued drafts.</li> </ul> <p>Dependencies: <code>design/docs/platform/dashboard.md</code>, <code>design/docs/platform/multi-user.md</code>.</p>"},{"location":"20-fiscal-platform/implementation/phase-1/#4-javascript-python-sdk","title":"4. JavaScript &amp; Python SDK","text":"<p>Description: Ship official client libraries with type-safe models, offline queue support, and receipt rendering helpers.</p> <p>Acceptance criteria:</p> <ul> <li>SDKs wrap the REST API with typed request/response models.</li> <li>Built-in offline queue (IndexedDB for browser, SQLite for native) with configurable grace period and retry logic.</li> <li>Tax engine helpers for building valid <code>tax_groups</code> and <code>tax_summary</code> arrays.</li> <li>Event callbacks for queue state transitions (synced, failed, grace exceeded).</li> </ul> <p>Dependencies: <code>design/docs/api/cloud.md</code>, <code>design/docs/api/invoicing-sdk.md</code>.</p>"},{"location":"20-fiscal-platform/implementation/phase-1/#5-manual-compliance-tooling-onboarding","title":"5. Manual compliance tooling &amp; onboarding","text":"<p>Description: Provide compliance tools to submit fiscal data to the DGI before automated MCF/e-MCF uploads are available.</p> <p>Acceptance criteria:</p> <ul> <li>Generate DGI-ready CSV/Excel exports containing sealed invoice metadata, fiscal numbers, tax summaries, and security elements.</li> <li>Produce Z/X/A reports and audit exports from the Fiscal Ledger.</li> <li>Public verification portal at <code>verify.stalela.cd</code> live with QR scanning, manual fiscal number lookup, and ECDSA signature validation. See Invoice Verification.</li> <li>Verification API (<code>/api/v1/verify/{fiscal_number}</code>) available as a public, rate-limited endpoint for programmatic verification.</li> <li>SDK verification helpers (<code>verify()</code>, <code>verifyQR()</code>, <code>verifySignatureOffline()</code>) shipped in JavaScript and Python SDKs.</li> <li>Public key distribution via <code>/.well-known/fiscal-keys.json</code> so the DGI and auditors can verify signatures independently.</li> <li>Onboard initial clients with documentation, API keys, and training.</li> <li>Collect feedback and validate offline queue behavior under real-world conditions.</li> </ul> <p>Dependencies: <code>design/docs/fiscal/reports.md</code>, <code>design/docs/cloud/dgi-integration.md</code>.</p>"},{"location":"20-fiscal-platform/implementation/phase-1/#risks","title":"Risks","text":"<p>Phase 1 Risks</p> <ul> <li>The DGI MCF/e-MCF API remains undefined, so manual compliance tooling is required initially. Automated uploads come in Phase 2 or when the DGI publishes the spec.</li> <li>HSM provider selection and key provisioning may introduce lead time. Evaluate cloud HSM offerings (AWS CloudHSM, Azure Managed HSM) early.</li> <li>Field testing in DRC conditions may expose unexpected latency and connectivity patterns. The offline queue must handle extended outages gracefully.</li> </ul>"},{"location":"20-fiscal-platform/implementation/phase-2/","title":"Phase 2 \u2014 POS &amp; Retail","text":"<p>Phase 1 proved that the Cloud Signing Service, REST API, and web dashboard can deliver fiscally compliant invoices for B2B clients. Phase 2 extends the platform to physical retail and restaurant environments with POS SDK integration, multi-terminal support, mobile money payments, and the webhook event system.</p>"},{"location":"20-fiscal-platform/implementation/phase-2/#objectives","title":"Objectives","text":"<ul> <li>Onboard retail and restaurant outlets (multi-lane counters, mobile waitstaff, fast-service kiosks) using the same cloud fiscal authority from Phase 1.</li> <li>New capabilities: POS SDK, multi-terminal concurrency, mobile money integration, webhook API, enhanced dashboard views, and fleet observability.</li> </ul>"},{"location":"20-fiscal-platform/implementation/phase-2/#epics","title":"Epics","text":""},{"location":"20-fiscal-platform/implementation/phase-2/#1-pos-sdk-multi-terminal-support","title":"1. POS SDK &amp; multi-terminal support","text":"<p>Description: Build a POS SDK that wraps the Cloud API with receipt rendering, offline queue, and multi-terminal awareness. The Monotonic Counter Manager already serializes fiscal numbers per outlet, so POS terminals are simply additional API consumers.</p> <p>Acceptance criteria:</p> <ul> <li>POS SDK (JavaScript) handles invoice creation, offline queue, receipt template rendering, and device-specific status indicators.</li> <li>Multiple POS terminals per outlet submit invoices concurrently; the cloud serializes fiscal numbering without gaps.</li> <li>Each invoice carries <code>pos_terminal_id</code> and <code>cashier_id</code> for traceability.</li> <li>Receipt templates include all five security elements (fiscal number, fiscal authority ID, auth code, timestamp, QR code).</li> </ul> <p>Dependencies: <code>design/docs/platform/multi-user.md</code>, <code>design/docs/api/invoicing-sdk.md</code>.</p>"},{"location":"20-fiscal-platform/implementation/phase-2/#2-mobile-money-integration","title":"2. Mobile money integration","text":"<p>Description: Support mobile money (M-Pesa, Airtel Money, Orange Money) as payment methods within invoices. Payment confirmation callbacks trigger invoice submission or update payment status on existing invoices.</p> <p>Acceptance criteria:</p> <ul> <li>Payment callbacks from mobile money providers are processed and recorded in the invoice's <code>payments</code> array.</li> <li>Invoices can be sealed before or after payment confirmation (payment status does not block fiscalization).</li> <li>Dashboard shows payment status alongside invoice status.</li> </ul> <p>Dependencies: <code>design/docs/platform/integrations.md</code>.</p>"},{"location":"20-fiscal-platform/implementation/phase-2/#3-webhook-event-system","title":"3. Webhook event system","text":"<p>Description: Build the webhook delivery system that pushes signed event notifications to external endpoints when invoices are sealed, reports are generated, or sync errors occur.</p> <p>Acceptance criteria:</p> <ul> <li>Webhook events: <code>invoice.sealed</code>, <code>invoice.sync.success</code>, <code>invoice.sync.failed</code>, <code>report.generated</code>, <code>outlet.offline_alert</code>.</li> <li>Payloads are signed with HMAC-SHA256 using the webhook secret.</li> <li>Retry with exponential backoff on delivery failure (max 5 retries).</li> <li>Dashboard UI for webhook management (create, test, view delivery logs).</li> </ul> <p>Dependencies: <code>design/docs/platform/integrations.md</code>.</p>"},{"location":"20-fiscal-platform/implementation/phase-2/#4-enhanced-dashboard-supervisor-views","title":"4. Enhanced dashboard &amp; supervisor views","text":"<p>Description: Add shift management, supervisor drill-downs, and fleet health views to the web dashboard for retail operations.</p> <p>Acceptance criteria:</p> <ul> <li>Shift open/close workflow with X report generation per shift.</li> <li>Supervisor view showing all terminals in an outlet with real-time invoice counts and sync status.</li> <li>Fleet overview page (for multi-outlet merchants) with aggregate health metrics.</li> <li>Offline client alerts with draft counts and ages.</li> </ul> <p>Dependencies: <code>design/docs/platform/dashboard.md</code>.</p>"},{"location":"20-fiscal-platform/implementation/phase-2/#5-observability-onboarding-fleet-operations","title":"5. Observability, onboarding &amp; fleet operations","text":"<p>Description: Instrument the platform with monitoring, alerting, and onboarding playbooks for retail staff.</p> <p>Acceptance criteria:</p> <ul> <li>Dashboards showing API latency, signing throughput, sync queue depth, and error rates.</li> <li>Alerts for: failed DGI uploads, offline grace period exceeded, rate limit breaches, HSM health.</li> <li>Onboarding documentation for retail merchants: outlet setup, API key creation, POS SDK installation, tax group configuration.</li> <li>Automated regression tests for offline queue, multi-terminal concurrency, and mobile money flows.</li> </ul> <p>Dependencies: <code>design/docs/cloud/architecture.md</code>, <code>design/docs/cloud/offline-sync.md</code>.</p>"},{"location":"20-fiscal-platform/implementation/phase-2/#6-whatsapp-invoice-bot","title":"6. WhatsApp Invoice Bot","text":"<p>Description: Deploy a WhatsApp Business API integration that allows merchants to create invoices, query status, download receipts, and request reports by sending natural language messages in French or Lingala.</p> <p>Acceptance criteria:</p> <ul> <li>Merchant sends a free-text message describing a sale; the NL Invoice Parser extracts items, quantities, prices, client, and payment methods.</li> <li>Bot presents a draft preview with confidence score; merchant confirms or edits before fiscalization.</li> <li>Bot supports status queries (\"statut facture 004821\"), receipt downloads (PDF attachment), and Z report requests.</li> <li>Phone number linked to merchant account via OTP on first use.</li> <li>All bot interactions logged in the audit trail with <code>source: \"whatsapp_bot\"</code>.</li> <li>Session timeout: 15 minutes of inactivity.</li> </ul> <p>Dependencies: <code>design/docs/platform/ai-capabilities.md</code>.</p>"},{"location":"20-fiscal-platform/implementation/phase-2/#7-natural-language-invoice-api","title":"7. Natural Language Invoice API","text":"<p>Description: Expose a REST endpoint (<code>/api/v1/invoices/natural</code>) that accepts free-text invoice descriptions in French, Lingala, Swahili, or English and returns a canonical payload for signing.</p> <p>Acceptance criteria:</p> <ul> <li>Endpoint accepts <code>{ \"text\": \"...\", \"language\": \"fr\" }</code> and returns a structured canonical payload.</li> <li>Confidence score \u2265 0.85 triggers auto-submission to the Cloud Signing Service; below 0.85 returns a draft for review.</li> <li>Entity extraction covers items, quantities, unit prices, client name, payment methods, and currency.</li> <li>Fuzzy matching against the merchant's product catalog resolves item names to SKUs and tax groups.</li> <li>Supports the same authentication and rate limiting as the core invoicing API.</li> </ul> <p>Dependencies: <code>design/docs/platform/ai-capabilities.md</code>, <code>design/docs/fiscal/tax-engine.md</code>.</p>"},{"location":"20-fiscal-platform/implementation/phase-2/#8-tax-auto-classification-api","title":"8. Tax Auto-Classification API","text":"<p>Description: Expose a classification endpoint (<code>/api/v1/tax/classify</code>) that suggests the correct DGI tax group (TG01\u2013TG14) for items based on description, HS code, or product category.</p> <p>Acceptance criteria:</p> <ul> <li>Classifier trained on DRC customs tariff schedule, DGI circulars, and pilot transaction data.</li> <li>Confidence \u2265 0.90 \u2192 auto-apply; 0.70\u20130.90 \u2192 suggest with explanation; &lt; 0.70 \u2192 require manual classification.</li> <li>Available as a standalone API and integrated into the invoice creation flow (API, dashboard, and NL pipeline).</li> <li>Model accuracy \u2265 85% on a held-out test set of 1,000 classified items.</li> </ul> <p>Dependencies: <code>design/docs/fiscal/tax-engine.md</code>, <code>design/docs/platform/ai-capabilities.md</code>.</p>"},{"location":"20-fiscal-platform/implementation/phase-2/#9-rule-based-anomaly-detection","title":"9. Rule-Based Anomaly Detection","text":"<p>Description: Implement real-time rule-based anomaly detection on the Fiscal Ledger to catch numbering gaps, velocity spikes, excessive void rates, and suspicious timing patterns.</p> <p>Acceptance criteria:</p> <ul> <li>Hard rules trigger immediately for critical anomalies (numbering gaps, duplicate fiscal numbers, counter rollback).</li> <li>Statistical baselines (30-day rolling window) detect velocity, amount, and tax group distribution anomalies per outlet.</li> <li>Alerts surface in the dashboard alert center, via email, and through <code>anomaly.detected</code> webhook events.</li> <li>Each alert includes severity, description, affected outlet/cashier, and recommended action.</li> </ul> <p>Dependencies: <code>design/docs/platform/ai-capabilities.md</code>, <code>design/docs/fiscal/reports.md</code>.</p>"},{"location":"20-fiscal-platform/implementation/phase-2/#risks","title":"Risks","text":"<p>Phase 2 Risks</p> <ul> <li>POS environments have unreliable connectivity; the offline queue must handle 48\u201372h outages without data loss or duplicate fiscal events.</li> <li>Mobile money provider APIs have variable reliability and documentation quality; build provider-agnostic abstractions.</li> <li>DGI readiness for automated uploads may still be pending \u2014 maintain manual compliance tooling as a fallback.</li> <li>Scaling to many outlets may expose performance bottlenecks in the signing pipeline or Fiscal Ledger writes.</li> </ul>"},{"location":"20-fiscal-platform/implementation/phase-3/","title":"Phase 3 \u2014 USB Hardware (DEF Homologation)","text":"<p>Phase 3 introduces the USB Fiscal Memory device (DEF) as an optional trust anchor for merchants who need full hardware homologation with the DGI. The Cloud Signing Service remains first-class \u2014 the DEF is an alternative signer that can replace or augment the cloud HSM for specific outlets. This phase delivers the firmware, dual-mode signing architecture, and DGI certification.</p>"},{"location":"20-fiscal-platform/implementation/phase-3/#objectives","title":"Objectives","text":"<ul> <li>Scope: USB Fiscal Memory firmware, dual-mode signing (Cloud HSM or DEF), device provisioning, and DGI hardware certification.</li> <li>Target: Merchants requiring DEF homologation; cloud-only merchants remain unaffected.</li> </ul>"},{"location":"20-fiscal-platform/implementation/phase-3/#dual-mode-signing-architecture","title":"Dual-mode signing architecture","text":"<pre><code>flowchart LR\n    Client[\"Client App\"] --&gt; API[\"Stalela Cloud API\"]\n    API --&gt; Router{\"Signing\\nmode?\"}\n    Router --&gt;|Cloud mode| HSM[\"Cloud Signing Service (HSM)\"]\n    Router --&gt;|DEF mode| Proxy[\"USB Device Proxy\"]\n    Proxy --&gt; DEF[\"USB Fiscal Memory\\n(DEF)\"]\n    HSM --&gt; Ledger[\"Fiscal Ledger\"]\n    DEF --&gt; Ledger\n    Ledger --&gt; Sync[\"Sync Agent\"]\n    Sync --&gt; DGI[\"DGI MCF / e-MCF\"]</code></pre> <p>Each outlet is configured with a signing mode (<code>cloud</code> or <code>def</code>). The API routes canonically identical payloads to the appropriate signer. Both signers produce the same five security elements and write to the same Fiscal Ledger, ensuring reports, audit exports, and DGI uploads are uniform regardless of signing mode.</p>"},{"location":"20-fiscal-platform/implementation/phase-3/#epics","title":"Epics","text":""},{"location":"20-fiscal-platform/implementation/phase-3/#1-usb-fiscal-memory-firmware","title":"1. USB Fiscal Memory firmware","text":"<p>Description: Develop the firmware for the USB Fiscal Memory device that implements the PREPARE/COMMIT protocol, monotonic counter, ECDSA signing via the secure element, hash-chained journal, and Z report generation.</p> <p>Acceptance criteria:</p> <ul> <li>PREPARE validates the canonical payload schema and returns a nonce without incrementing counters.</li> <li>COMMIT atomically increments the fiscal number, signs the payload, generates the timestamp and QR code, and appends to the hash-chained journal.</li> <li>Firmware generates Z reports from the local journal with sequence ranges, per-tax-group totals, and journal hashes.</li> <li>Power-loss recovery: interrupted COMMIT does not produce orphan fiscal numbers.</li> </ul> <p>Dependencies: Hardware docs in <code>docs-archive/hardware/</code>, <code>spec/protocol-usb-fiscal-device-1.md</code>.</p>"},{"location":"20-fiscal-platform/implementation/phase-3/#2-usb-device-proxy-service","title":"2. USB Device Proxy service","text":"<p>Description: Build a local daemon/service that bridges the Cloud API to the USB device via USB CDC. The proxy receives canonical payloads from the cloud, executes PREPARE/COMMIT on the DEF, and returns the sealed response.</p> <p>Acceptance criteria:</p> <ul> <li>Proxy exposes a local REST/IPC interface that the Cloud API calls when the outlet is in DEF mode.</li> <li>Handles USB CDC framing, nonce lifecycle, and retry logic.</li> <li>Reports device health (counter, firmware version, free memory) back to the cloud for dashboard display.</li> <li>Auto-starts at boot; reconnects on USB disconnect.</li> </ul> <p>Dependencies: <code>spec/protocol-usb-fiscal-device-1.md</code>.</p>"},{"location":"20-fiscal-platform/implementation/phase-3/#3-device-provisioning-certificate-management","title":"3. Device provisioning &amp; certificate management","text":"<p>Description: Build the provisioning workflow that registers a DEF with the Cloud, binds it to an outlet, provisions its signing certificate, and manages key rotation.</p> <p>Acceptance criteria:</p> <ul> <li>Cloud registry tracks DEF serial, activation token, certificate, and firmware version per outlet.</li> <li>Activation flow binds a DEF to exactly one outlet (one-to-one mapping).</li> <li>Certificate rotation and revocation flows are documented and automated.</li> <li>Dashboard shows device status, certificate expiry, and firmware version.</li> </ul> <p>Dependencies: <code>design/docs/cloud/architecture.md</code>.</p>"},{"location":"20-fiscal-platform/implementation/phase-3/#4-dual-mode-integration-testing","title":"4. Dual-mode integration &amp; testing","text":"<p>Description: Ensure that Cloud HSM and DEF signers produce interchangeable sealed responses and that reports, audit exports, and DGI uploads work identically regardless of signing mode.</p> <p>Acceptance criteria:</p> <ul> <li>Same canonical payload produces structurally identical sealed responses from both signers (differing only in <code>fiscal_authority_id</code> and signature bytes).</li> <li>Fiscal Ledger, reports, and audit exports are agnostic to signing source.</li> <li>Switching an outlet from cloud to DEF mode (or vice versa) is seamless \u2014 counter continuity is maintained.</li> </ul>"},{"location":"20-fiscal-platform/implementation/phase-3/#5-dgi-hardware-homologation","title":"5. DGI hardware homologation","text":"<p>Description: Prepare and submit the DEF for DGI homologation, including documentation, test evidence, and physical device submission.</p> <p>Acceptance criteria:</p> <ul> <li>Homologation dossier includes: firmware specifications, security element generation proof, audit trail samples, Z/X/A report samples, and power-loss recovery evidence.</li> <li>DEF passes DGI technical committee review.</li> <li>Contingency plan: merchants can operate in cloud mode while homologation is pending.</li> </ul> <p>Dependencies: <code>design/docs/regulatory/legal-framework.md</code>, <code>design/docs/regulatory/arretes.md</code>.</p>"},{"location":"20-fiscal-platform/implementation/phase-3/#risks","title":"Risks","text":"<p>Phase 3 Risks</p> <ul> <li>USB hardware BOM ($10\u201315 target) may be difficult to achieve with secure MCU, SE, flash, and RTC. Supply chain issues could delay production.</li> <li>DGI homologation timelines are unpredictable. Cloud mode serves as the fallback.</li> <li>Maintaining two signing paths increases testing surface area. Invest in automated dual-mode regression tests.</li> <li>Field deployment of hardware in DRC conditions (power instability, heat, humidity) requires ruggedized design and extensive field testing.</li> </ul>"},{"location":"20-fiscal-platform/implementation/phase-4/","title":"Phase 4 \u2014 Enterprise &amp; Integrations","text":"<p>Phase 4 extends Stalela into enterprise environments with ERP connectors, fleet management, advanced analytics, and multi-country expansion research. This phase builds on the mature API, SDKs, and dual-mode signing infrastructure delivered in Phases 1\u20133.</p>"},{"location":"20-fiscal-platform/implementation/phase-4/#objectives","title":"Objectives","text":"<ul> <li>Scope: ERP connectors, fleet management dashboard, webhook/event streaming enhancements, advanced analytics, and multi-country regulatory research.</li> <li>Target: Large enterprises, ERP integrators, and government agencies.</li> </ul>"},{"location":"20-fiscal-platform/implementation/phase-4/#epics","title":"Epics","text":""},{"location":"20-fiscal-platform/implementation/phase-4/#1-erp-connectors","title":"1. ERP connectors","text":"<p>Description: Build certified connectors for major ERP systems that enable automatic fiscalization of invoices generated by the ERP.</p> <p>Connectors:</p> ERP Integration method Priority SAP Business One SAP DI API / Service Layer add-on High Odoo 17+ Custom module (Python) publishing to Stalela REST API High Sage X3 Sage X3 Web Services endpoint Medium Custom / in-house REST API + SDK (JavaScript / Python) Ongoing <p>Acceptance criteria:</p> <ul> <li>Each connector maps the ERP's invoice data model to Stalela's canonical payload.</li> <li>Sealed responses (fiscal number, auth code, QR code) are written back to the ERP's invoice record.</li> <li>Connectors handle offline queuing: if Stalela Cloud is unreachable, invoices are queued locally and retried.</li> <li>Error mapping: ERP-side validation errors are translated into meaningful messages.</li> <li>Installation guide, configuration reference, and troubleshooting docs for each connector.</li> </ul> <p>Dependencies: <code>api/cloud.md</code>, <code>api/invoicing-sdk.md</code>.</p>"},{"location":"20-fiscal-platform/implementation/phase-4/#2-fleet-management-dashboard","title":"2. Fleet management dashboard","text":"<p>Description: A dedicated dashboard view for enterprises managing many outlets, terminals, and (optionally) DEF devices across multiple locations.</p> <p>Features:</p> <ul> <li>Map view: Geo-located outlets with real-time status (online, offline, syncing).</li> <li>Device health panel: DEF firmware version, certificate expiry, counter status, free memory (Phase 3 outlets only).</li> <li>Fiscal number audit: Cross-outlet check for numbering gaps, duplicates, or sequence anomalies.</li> <li>Bulk management: Batch-create outlets, assign users, push configuration changes.</li> <li>Alert center: Notifications for offline outlets, failed syncs, approaching certificate expiry, and DGI submission failures.</li> </ul> <p>Acceptance criteria:</p> <ul> <li>Dashboard supports 500+ outlets per merchant without degradation.</li> <li>Real-time status updates via WebSocket or SSE (\u2264 5 s latency).</li> <li>Role-based access: fleet manager role can view all outlets but cannot issue invoices.</li> </ul> <p>Dependencies: <code>platform/multi-user.md</code>, <code>cloud/architecture.md</code>.</p>"},{"location":"20-fiscal-platform/implementation/phase-4/#3-advanced-analytics","title":"3. Advanced analytics","text":"<p>Description: Analytics engine that transforms Fiscal Ledger data into actionable insights for merchants and compliance teams, powered by ML-based anomaly detection, predictive forecasting, and natural language search.</p> <p>Reports:</p> Report Description Revenue trends Daily/weekly/monthly revenue by outlet, product category, and tax group Tax liability forecast Projected tax obligations based on current invoicing velocity and seasonal patterns (Prophet / ARIMA) Client segmentation Invoice volume and revenue by client classification (individual, company, embassy, etc.) Compliance scorecard DGI submission success rate, average sync latency, numbering integrity, AI-driven risk score per outlet Cashier performance Invoices per hour, average transaction value, void/refund rate per cashier Seasonal demand Peak/trough period identification for inventory and staffing Cash flow prediction Forecast mobile money vs. cash collection timing <p>Acceptance criteria:</p> <ul> <li>Analytics queries run against a read replica or data warehouse \u2014 no impact on transactional performance.</li> <li>Pre-built dashboards for each report with export to CSV, PDF, and Excel.</li> <li>API endpoint for programmatic access to analytics data.</li> <li>Data retention: analytics data available for at least 10 years (regulatory requirement).</li> </ul> <p>Dependencies: <code>fiscal/reports.md</code>.</p>"},{"location":"20-fiscal-platform/implementation/phase-4/#4-webhook-event-streaming-enhancements","title":"4. Webhook &amp; event streaming enhancements","text":"<p>Description: Upgrade the webhook system to support event streaming for high-throughput integrations and real-time data pipelines.</p> <p>Features:</p> <ul> <li>Event streaming: Optional Kafka/NATS topic per merchant for real-time event consumption.</li> <li>Replay: Re-deliver events from a specific timestamp or sequence number.</li> <li>Filtering: Subscribe to specific event types, outlets, or conditions.</li> <li>Dead letter queue: Automatically quarantine events that fail delivery after max retries.</li> <li>Signature verification: HMAC-SHA256 signatures on webhook payloads for authenticity.</li> </ul> <p>Acceptance criteria:</p> <ul> <li>Streaming endpoint supports \u2265 1,000 events/second per merchant.</li> <li>Replay covers at least 30 days of event history.</li> <li>Dead letter queue is accessible via API and dashboard.</li> </ul> <p>Dependencies: <code>platform/integrations.md</code>.</p>"},{"location":"20-fiscal-platform/implementation/phase-4/#5-multi-country-regulatory-research","title":"5. Multi-country regulatory research","text":"<p>Description: Research and document the regulatory requirements for expanding Stalela beyond the DRC. Identify common patterns and country-specific adaptations.</p> <p>Target countries (research only):</p> Country Fiscal regime Priority Republic of Congo (Brazzaville) SFE-like regime (research needed) High Rwanda EBM (Electronic Billing Machine) Medium Kenya TIMS (Tax Invoice Management System) Medium Cameroon MECeF (Machine \u00c9lectronique Certifi\u00e9e de Facturation) Low <p>Deliverables:</p> <ul> <li>Regulatory summary per country (equivalent of <code>regulatory/</code> folder).</li> <li>Gap analysis: what Stalela already supports vs. what needs adaptation.</li> <li>Architecture impact assessment: multi-country tax engine, multi-currency, localization.</li> <li>Go/no-go recommendation for each country.</li> </ul>"},{"location":"20-fiscal-platform/implementation/phase-4/#6-ai-powered-capabilities-full-suite","title":"6. AI-Powered Capabilities (Full Suite)","text":"<p>Description: Deploy the full AI suite that builds on Phase 2's foundation (WhatsApp bot, NL invoicing, tax classifier, rule-based anomaly detection) with advanced ML models, OCR, compliance monitoring, and natural language search.</p> <p>Components:</p> Component Description ML Anomaly Detection Replace Phase 2 rule-based triggers with Isolation Forest / Autoencoder models trained on per-outlet baselines. Detect velocity, amount, timing, tax group, and void/refund anomalies with higher precision. Predictive Analytics Engine Time-series forecasting (Prophet / ARIMA) for tax liability, revenue projection, seasonal demand, and cash flow prediction. Dashboard forecast cards with confidence intervals. OCR &amp; Document Digitization Camera/PDF upload \u2192 preprocessing \u2192 Tesseract/Cloud Vision OCR \u2192 field extraction (NER + layout analysis) \u2192 human review \u2192 stored as digitized record. Historical paper invoices are informational records only \u2014 never fabricate fiscal numbers for scanned documents. NLP Compliance Monitoring Monitor DGI website, official gazette, and ministry circulars for regulatory changes. NLP document classifier detects changes to tax rates, exemptions, and reporting obligations. Alerts reviewed by compliance team before pushing to merchants. Smart Search (Text-to-SQL) Natural language queries over fiscal data via dashboard search bar and <code>/api/v1/search/query</code>. Fine-tuned CodeLlama/StarCoder translates French/English questions into sandboxed SQL queries against the Fiscal Ledger read replica. Role-based access control enforced. Voice Invoice Creation Speech-to-text (Whisper multilingual) \u2192 text \u2192 NL Invoice Parser pipeline. Supports French, Lingala, Swahili. <p>Acceptance criteria:</p> <ul> <li>ML anomaly detection achieves \u2265 80% precision with &lt; 5% false positive rate.</li> <li>Predictive forecasts within \u00b115% accuracy for 30-day projections.</li> <li>OCR field extraction accuracy \u2265 90%. Low-quality scans flagged for manual entry.</li> <li>Compliance monitor detects regulatory changes within 48 hours of publication.</li> <li>Smart Search handles \u2265 90% of common finance team queries with correct results.</li> <li>Voice input achieves \u2265 85% entity extraction accuracy for supported languages.</li> <li>All AI models run within the Stalela cloud boundary. No cross-tenant training.</li> </ul> <p>Dependencies: <code>platform/ai-capabilities.md</code>, <code>fiscal/reports.md</code>, <code>cloud/architecture.md</code>.</p> <p>See AI &amp; Natural Language Capabilities for full specifications, data flows, and privacy governance.</p>"},{"location":"20-fiscal-platform/implementation/phase-4/#risks","title":"Risks","text":"<p>Phase 4 Risks</p> <ul> <li>ERP connector maintenance burden: each connector requires ongoing updates as ERPs release new versions.</li> <li>Multi-country expansion may require separate legal entities and local partnerships.</li> <li>Analytics on large datasets requires careful data warehouse design to avoid performance issues.</li> <li>Event streaming infrastructure (Kafka/NATS) adds operational complexity.</li> <li>AI model accuracy depends on sufficient training data from Phases 1\u20133; limited pilot volume may require synthetic data augmentation.</li> <li>OCR accuracy degrades significantly on poor-quality scans (torn, faded, handwritten) common in DRC markets.</li> <li>Multilingual NLP (especially Lingala and Tshiluba) has limited pre-trained model coverage; fine-tuning requires labeled datasets.</li> </ul>"},{"location":"20-fiscal-platform/implementation/phase-4/#success-criteria","title":"Success criteria","text":"<ul> <li>ERP connectors certified and deployed with enterprise customers.</li> <li>Fleet dashboard supports enterprise merchants with multi-outlet operations.</li> <li>Analytics reports are used by merchants for tax planning.</li> <li>Multi-country research delivers go/no-go recommendations.</li> <li>WhatsApp bot and NL Invoice API handle production invoice volumes.</li> <li>Tax Auto-Classifier accuracy \u2265 85% on production items.</li> <li>Anomaly detection surfaces real issues with &lt; 5% false positive rate.</li> <li>Smart Search resolves \u2265 90% of natural language finance queries correctly.</li> </ul>"},{"location":"20-fiscal-platform/implementation/roadmap/","title":"Implementation Roadmap","text":""},{"location":"20-fiscal-platform/implementation/roadmap/#overview","title":"Overview","text":"<p>This document lays out the phased rollout for Stalela's fiscal invoicing platform, beginning with a software-first B2B pilot, scaling through POS and retail integrations, adding optional USB hardware for merchants that need DEF homologation, and culminating in enterprise-grade connectors and analytics. Each phase builds on the architecture, cloud signing, and fiscal engine work captured throughout these docs.</p>"},{"location":"20-fiscal-platform/implementation/roadmap/#timeline","title":"Timeline","text":"<pre><code>timeline\n    title Stalela Implementation Roadmap\n    Phase 1 \u2014 Software Invoicing\n        : Cloud Signing Service + Fiscal Ledger MVP\n        : REST API + Tax Engine (14 DGI groups)\n        : Web Dashboard MVP\n        : JavaScript and Python SDK\n    Phase 2 \u2014 POS and Retail\n        : POS SDK + multi-terminal support\n        : Mobile money integration\n        : Webhook event system\n        : WhatsApp Invoice Bot + NL API\n    Phase 3 \u2014 USB Hardware\n        : USB Fiscal Memory firmware\n        : Cloud + DEF dual-mode signing\n        : DGI hardware certification\n    Phase 4 \u2014 Enterprise\n        : ERP connectors \u2014 SAP and Odoo\n        : Fleet management dashboard\n        : Advanced analytics + AI suite\n        : Multi-country expansion research</code></pre> <p>See the Kanban Board for the fiscal epic quick reference, and the Unified Epic Board for the complete cross-pillar view.</p> <p>Infrastructure</p> <p>All fiscal platform components run on the Free Stack (Supabase + Vercel + Alibaba KMS + Resend + GitHub Actions). See the Sprint 001 kickoff for the combined Payments + Fiscal foundation sprint.</p>"},{"location":"20-fiscal-platform/implementation/roadmap/#phase-1-software-invoicing","title":"Phase 1 \u2014 Software Invoicing","text":"<p>The foundation phase. Delivers the API-first invoicing platform with cloud fiscal signing, the tax engine, web dashboard, and SDKs.</p> <p>Key deliverables:</p> <ul> <li>Cloud Signing Service (HSM) + Monotonic Counter Manager + Fiscal Ledger</li> <li>REST API with full invoice lifecycle (create, void, refund, credit note)</li> <li>Tax Engine enforcing all 14 DGI tax groups + client classification</li> <li>Web Dashboard for invoice management, reports, and outlet administration</li> <li>JavaScript and Python SDKs with offline queue support</li> <li>Z/X/A reports and audit export from the Fiscal Ledger</li> <li>Manual DGI compliance tooling (CSV/audit dump) until MCF/e-MCF API lands</li> </ul> <p>See Phase 1 detail for epics, acceptance criteria, and dependencies.</p>"},{"location":"20-fiscal-platform/implementation/roadmap/#phase-2-pos-retail","title":"Phase 2 \u2014 POS &amp; Retail","text":"<p>Extends the platform to physical retail by adding POS SDK integration, multi-terminal support, mobile money payments, the webhook event system, and the first AI-powered capabilities.</p> <p>Key deliverables:</p> <ul> <li>POS SDK that wraps the Cloud API with receipt rendering and offline queue</li> <li>Multi-terminal concurrency via the existing Monotonic Counter Manager</li> <li>Mobile money integration (M-Pesa, Airtel Money, Orange Money)</li> <li>Webhook API for real-time event streaming to external systems</li> <li>Enhanced dashboard with shift management and supervisor views</li> <li>Observability and alerting for fleet operations</li> <li>WhatsApp Invoice Bot \u2014 create, query, and receive sealed invoices via WhatsApp Business API (French, Lingala)</li> <li>Natural Language Invoice API \u2014 submit invoices as free-text via <code>/api/v1/invoices/natural</code></li> <li>Tax Auto-Classification API \u2014 ML-assisted tax group suggestions for items and HS codes</li> <li>Rule-based anomaly detection \u2014 real-time alerts for numbering gaps, velocity spikes, and void rate anomalies</li> </ul> <p>See Phase 2 detail for epics, acceptance criteria, and dependencies.</p>"},{"location":"20-fiscal-platform/implementation/roadmap/#phase-3-usb-hardware","title":"Phase 3 \u2014 USB Hardware","text":"<p>Introduces the USB Fiscal Memory device (DEF) as an optional trust anchor for merchants who need full DEF homologation. The cloud remains first-class; the DEF is an alternative signer.</p> <p>Key deliverables:</p> <ul> <li>USB Fiscal Memory firmware (PREPARE/COMMIT protocol, immutable journal)</li> <li>Dual-mode architecture: Cloud HSM or DEF can sign invoices per outlet</li> <li>Device provisioning, activation, and certificate management</li> <li>Cloud sync for DEF-signed invoices (same Sync Agent pipeline)</li> <li>DGI hardware homologation and certification</li> </ul> <p>See Phase 3 detail for epics, acceptance criteria, and dependencies.</p>"},{"location":"20-fiscal-platform/implementation/roadmap/#phase-4-enterprise-scale","title":"Phase 4 \u2014 Enterprise &amp; Scale","text":"<p>Enterprise-grade integrations, fleet management, advanced analytics, and the full AI suite for large-scale deployments.</p> <p>Key deliverables:</p> <ul> <li>ERP connectors (SAP S/4HANA, Odoo) with tax group mapping</li> <li>Fleet management dashboard for multi-branch monitoring</li> <li>Advanced analytics (tax-group heatmaps, anomaly detection, trend analysis)</li> <li>Automated compliance reporting and audit export scheduling</li> <li>Multi-country expansion research (regulatory analysis for neighboring markets)</li> <li>ML-based anomaly detection \u2014 Isolation Forest / Autoencoder models replacing Phase 2 rule-based triggers</li> <li>Predictive analytics \u2014 tax liability forecasts, revenue projections, seasonal demand, and compliance risk scoring</li> <li>OCR &amp; document digitization \u2014 scan paper invoices into structured records via camera or PDF upload</li> <li>NLP compliance monitoring \u2014 detect regulatory changes in DGI publications and alert merchants</li> <li>Smart Search \u2014 natural language queries over fiscal data (text-to-SQL) in the dashboard and API</li> <li>Voice invoice creation \u2014 speech-to-text pipeline feeding the NL Invoice Parser</li> </ul> <p>See Phase 4 detail for epics, acceptance criteria, and dependencies.</p>"},{"location":"20-fiscal-platform/implementation/roadmap/#monitoring-validation","title":"Monitoring &amp; Validation","text":"<p>Maintain a rolling review cadence after each phase completes:</p> <ul> <li>Monthly sync audits \u2014 Verify Fiscal Ledger integrity, DGI upload success rates, and counter continuity.</li> <li>Quarterly security reviews \u2014 Audit HSM key rotation, API key usage, and access control compliance.</li> <li>Phase gate reviews \u2014 Before advancing to the next phase, validate all acceptance criteria, run <code>mkdocs build --strict</code>, and confirm regulatory alignment.</li> <li>DGI checkpoint \u2014 As the MCF/e-MCF API details emerge, update the Sync Agent and DGI integration docs accordingly.</li> </ul>"},{"location":"20-fiscal-platform/platform/ai-capabilities/","title":"AI &amp; Natural Language Capabilities","text":"<p>Stalela embeds AI and natural language processing directly into its fiscal invoicing infrastructure so merchants, cashiers, and compliance teams interact with the platform in the language they already speak \u2014 French, Lingala, Swahili, or Tshiluba \u2014 rather than through forms and dropdowns. This page specifies every AI surface, its data flow, trust boundary rules, and phased rollout.</p>"},{"location":"20-fiscal-platform/platform/ai-capabilities/#design-principles","title":"Design principles","text":"<ul> <li>AI assists, the Cloud Signing Service decides. AI models suggest tax groups, parse natural language, and flag anomalies, but the Cloud Signing Service (HSM) remains the sole authority for fiscal numbers, signatures, timestamps, and QR codes. No AI output bypasses the trust boundary.</li> <li>Human-in-the-loop by default. AI suggestions (tax classification, anomaly flags, compliance alerts) are presented for review before becoming fiscal events. Confidence thresholds gate auto-approval.</li> <li>Multilingual-first. All NLP models support French (primary), Lingala, Swahili, and Tshiluba. English is supported for international clients and developers.</li> <li>Privacy-preserving. Invoice data fed to AI models stays within Stalela's cloud boundary. No customer data is sent to third-party model providers unless the merchant explicitly opts in and a data processing agreement is signed.</li> </ul>"},{"location":"20-fiscal-platform/platform/ai-capabilities/#capability-map","title":"Capability map","text":"<pre><code>flowchart TD\n    NL[\"Natural Language Input\\n(WhatsApp, Chat, Voice)\"]\n    OCR[\"OCR &amp; Document Scan\"]\n    NL --&gt; PARSE[\"NL Invoice Parser\"]\n    OCR --&gt; PARSE\n    PARSE --&gt; CANON[\"Canonical Payload Builder\"]\n    CANON --&gt; VALIDATE[\"Tax Engine\\n(14 DGI Groups)\"]\n    VALIDATE --&gt; SIGN[\"Cloud Signing Service\\n(HSM)\"]\n\n    LEDGER[\"Fiscal Ledger\"] --&gt; ANOMALY[\"Anomaly Detection\"]\n    LEDGER --&gt; PREDICT[\"Predictive Analytics\"]\n    LEDGER --&gt; SEARCH[\"Smart Search &amp; Insights\"]\n    ANOMALY --&gt; ALERTS[\"Alert Center\"]\n    PREDICT --&gt; DASH[\"Dashboard &amp; Reports\"]\n    SEARCH --&gt; DASH\n\n    CLASSIFY[\"Tax Auto-Classifier\"] --&gt; VALIDATE\n    COMPLY[\"Compliance Monitor\"] --&gt; ALERTS</code></pre>"},{"location":"20-fiscal-platform/platform/ai-capabilities/#1-natural-language-invoice-creation","title":"1. Natural Language Invoice Creation","text":""},{"location":"20-fiscal-platform/platform/ai-capabilities/#problem","title":"Problem","text":"<p>Merchants in DRC markets \u2014 small traders, school bursars, wholesale distributors \u2014 don't want to fill in 15 form fields. They want to say or type what happened (\"Vendez 3 sacs de ciment \u00e0 45 000 FC chacun \u00e0 \u00c9tablissement Kabila, pay\u00e9 moiti\u00e9 mobile money moiti\u00e9 cash\") and get a sealed invoice back.</p>"},{"location":"20-fiscal-platform/platform/ai-capabilities/#specification","title":"Specification","text":"Attribute Detail Input channels WhatsApp Business API, Web dashboard chat widget, REST API (<code>/api/v1/invoices/natural</code>), Voice (speech-to-text pipeline) Languages French, Lingala, Swahili, Tshiluba, English Output Canonical JSON payload ready for the Tax Engine and Cloud Signing Service Confidence threshold \u2265 0.85 \u2192 auto-submit for signing; &lt; 0.85 \u2192 present draft for review Fallback If confidence &lt; 0.60, prompt the user for clarification (\"Quel est le NIF du client?\")"},{"location":"20-fiscal-platform/platform/ai-capabilities/#data-flow","title":"Data flow","text":"<pre><code>sequenceDiagram\n    participant M as Merchant (WhatsApp / Chat)\n    participant NLP as NL Invoice Parser\n    participant CAT as Product Catalog\n    participant TAX as Tax Engine\n    participant CSS as Cloud Signing Service (HSM)\n\n    M-&gt;&gt;NLP: \"Vends 3 sacs ciment 45000 FC \u00e0 Ets Kabila, moiti\u00e9 MoMo moiti\u00e9 cash\"\n    NLP-&gt;&gt;CAT: Resolve \"sacs ciment\" \u2192 SKU, unit price, tax group\n    CAT--&gt;&gt;NLP: SKU-0042, TG01 (TVA 16%)\n    NLP-&gt;&gt;NLP: Extract: qty=3, unit_price=45000, client=\"Ets Kabila\", payments=[mobile_money: 67500, cash: 67500]\n    NLP--&gt;&gt;M: Draft preview (confidence 0.91) \u2014 \"Confirm or edit?\"\n    M-&gt;&gt;NLP: \u2705 Confirm\n    NLP-&gt;&gt;TAX: Canonical payload\n    TAX-&gt;&gt;CSS: Validated payload\n    CSS--&gt;&gt;M: Sealed invoice (fiscal_number, QR, auth_code)</code></pre>"},{"location":"20-fiscal-platform/platform/ai-capabilities/#entity-extraction-targets","title":"Entity extraction targets","text":"Entity Examples Required Items \"3 sacs ciment\", \"10 cahiers\" Yes Unit price \"45 000 FC\", \"$12.50\" Yes Client \"Ets Kabila\", \"M. Tshisekedi\" No (defaults to anonymous individual) Payment methods \"cash\", \"MoMo\", \"moiti\u00e9-moiti\u00e9\" No (defaults to cash) Currency \"FC\", \"USD\", \"dollars\" No (defaults to CDF) Tax group override \"exon\u00e9r\u00e9\", \"export\" No (auto-classified from catalog)"},{"location":"20-fiscal-platform/platform/ai-capabilities/#implementation-notes","title":"Implementation notes","text":"<ul> <li>Use a fine-tuned multilingual LLM (e.g., mT5 or Mistral-based) for entity extraction, with a retrieval-augmented generation (RAG) layer backed by the merchant's product catalog.</li> <li>Catalog matching uses fuzzy search (Levenshtein + embedding similarity) so \"ciment\" matches \"Ciment Portland CPA 42.5 50kg\".</li> <li>The parser outputs a confidence score per field plus an aggregate score. Fields below 0.70 confidence are highlighted in the draft preview.</li> <li>Voice input runs through Whisper (multilingual) \u2192 text \u2192 same NLP pipeline.</li> </ul>"},{"location":"20-fiscal-platform/platform/ai-capabilities/#phase-phase-2-initial-whatsapp-bot-phase-4-voice-advanced-nlu","title":"Phase: Phase 2 (initial WhatsApp bot) / Phase 4 (voice, advanced NLU)","text":""},{"location":"20-fiscal-platform/platform/ai-capabilities/#2-whatsapp-invoice-bot","title":"2. WhatsApp Invoice Bot","text":""},{"location":"20-fiscal-platform/platform/ai-capabilities/#problem_1","title":"Problem","text":"<p>WhatsApp is the dominant communication channel in DRC. Merchants already discuss transactions over WhatsApp \u2014 Stalela should meet them there.</p>"},{"location":"20-fiscal-platform/platform/ai-capabilities/#specification_1","title":"Specification","text":"Attribute Detail Platform WhatsApp Business API (Cloud API) Capabilities Create invoices, query invoice status, download receipts (PDF), request Z/X reports, check DGI sync status, verify invoices (text or QR photo) Authentication Phone number linked to merchant account + OTP verification on first use Languages French, Lingala (others via NL pipeline)"},{"location":"20-fiscal-platform/platform/ai-capabilities/#conversation-flows","title":"Conversation flows","text":"<p>Invoice creation:</p> <pre><code>Merchant: Facture pour Ets Mwamba, 5 cartons savon 12000 FC\nBot: \ud83d\udcdd Brouillon cr\u00e9\u00e9:\n     Client: Ets Mwamba\n     - 5\u00d7 Savon Multi-Usage (TG01 TVA 16%) \u2014 60 000 FC\n     - TVA: 9 600 FC\n     - Total: 69 600 FC\n     Paiement: Cash\n     \u2705 Confirmer | \u270f\ufe0f Modifier | \u274c Annuler\nMerchant: \u2705\nBot: \u2705 Facture scell\u00e9e \u2014 N\u00b0 Fiscal: 001-2026-004821\n     \ud83d\udcce [T\u00e9l\u00e9charger PDF] | \ud83d\udcf1 [Voir QR]\n</code></pre> <p>Status query:</p> <pre><code>Merchant: Statut facture 004821\nBot: \u2705 Facture 001-2026-004821\n     Scell\u00e9e: 2026-06-15 14:32 UTC\n     DGI: Synchronis\u00e9 \u2705\n     Client: Ets Mwamba \u2014 69 600 FC\n</code></pre> <p>Report request:</p> <pre><code>Merchant: Rapport Z aujourd'hui\nBot: \ud83d\udcca Rapport Z \u2014 15 juin 2026\n     Factures: 47 | Total HT: 3 240 000 FC | TVA: 518 400 FC\n     \ud83d\udcce [T\u00e9l\u00e9charger PDF] | \ud83d\udcca [Voir d\u00e9tails]\n</code></pre>"},{"location":"20-fiscal-platform/platform/ai-capabilities/#security-constraints","title":"Security constraints","text":"<ul> <li>The bot never displays or transmits signing keys, HSM credentials, or raw auth codes in conversation.</li> <li>Receipts sent as PDF attachments include the QR code and fiscal number but the bot does not render the raw cryptographic signature.</li> <li>Session timeout: 15 minutes of inactivity.</li> <li>All bot interactions are logged in the audit trail with <code>source: \"whatsapp_bot\"</code>.</li> </ul>"},{"location":"20-fiscal-platform/platform/ai-capabilities/#phase-phase-2","title":"Phase: Phase 2","text":""},{"location":"20-fiscal-platform/platform/ai-capabilities/#3-tax-auto-classification","title":"3. Tax Auto-Classification","text":""},{"location":"20-fiscal-platform/platform/ai-capabilities/#problem_2","title":"Problem","text":"<p>DRC's 14 DGI tax groups are nuanced. Merchants frequently mis-classify items, leading to tax errors, compliance risk, and rejected returns. AI can suggest the correct tax group from the item description or HS code.</p>"},{"location":"20-fiscal-platform/platform/ai-capabilities/#specification_2","title":"Specification","text":"Attribute Detail Input Item description (free text), HS code (optional), product category Output Suggested tax group (TG01\u2013TG14), confidence score, explanation Model Classification model trained on DRC customs tariff schedule, DGI circulars, and historical Stalela transaction data Threshold \u2265 0.90 \u2192 auto-apply; 0.70\u20130.90 \u2192 suggest with explanation; &lt; 0.70 \u2192 manual classification required"},{"location":"20-fiscal-platform/platform/ai-capabilities/#tax-group-mapping-examples","title":"Tax group mapping examples","text":"Item description Suggested TG Confidence Explanation \"Ciment Portland 50kg\" TG01 (TVA 16%) 0.97 Construction materials \u2014 standard rate \"Cahiers scolaires A4\" TG04 (TVA 0% \u2014 exon\u00e9r\u00e9) 0.94 School supplies \u2014 exempt per DGI circular 2024/03 \"Bi\u00e8re Primus 72cl\" TG07 (Accise + TVA) 0.96 Alcoholic beverages \u2014 excise + VAT \"Consulting juridique\" TG01 (TVA 16%) 0.88 Professional services \u2014 standard rate \"Mat\u00e9riel m\u00e9dical import\u00e9\" TG05 (TVA 0% \u2014 exon\u00e9r\u00e9) 0.72 Medical equipment \u2014 review needed, exemption depends on end-use certificate"},{"location":"20-fiscal-platform/platform/ai-capabilities/#training-data-sources","title":"Training data sources","text":"<ol> <li>DRC customs tariff schedule (tarif douanier) \u2014 thousands of HS code \u2192 duty/tax mappings.</li> <li>DGI circulars and arr\u00eat\u00e9s \u2014 exemptions, special rates, and reclassifications.</li> <li>Stalela transaction history \u2014 real-world item descriptions with confirmed tax groups (post-Phase 1 pilot).</li> <li>Merchant product catalogs \u2014 uploaded during onboarding.</li> </ol>"},{"location":"20-fiscal-platform/platform/ai-capabilities/#integration-point","title":"Integration point","text":"<p>The Tax Auto-Classifier sits between the canonical payload builder and the Tax Engine. It runs during invoice creation (API, dashboard, or NL pipeline) and is also available as a standalone endpoint:</p> <pre><code>POST /api/v1/tax/classify\n{\n  \"items\": [\n    { \"description\": \"Ciment Portland 50kg\", \"hs_code\": \"2523.29\" },\n    { \"description\": \"Service de nettoyage\" }\n  ]\n}\n\nResponse:\n{\n  \"classifications\": [\n    { \"description\": \"Ciment Portland 50kg\", \"tax_group\": \"TG01\", \"confidence\": 0.97, \"explanation\": \"Construction materials \u2014 standard VAT rate\" },\n    { \"description\": \"Service de nettoyage\", \"tax_group\": \"TG01\", \"confidence\": 0.91, \"explanation\": \"Cleaning services \u2014 standard VAT rate\" }\n  ]\n}\n</code></pre>"},{"location":"20-fiscal-platform/platform/ai-capabilities/#phase-phase-2-model-training-begins-with-phase-1-pilot-data","title":"Phase: Phase 2 (model training begins with Phase 1 pilot data)","text":""},{"location":"20-fiscal-platform/platform/ai-capabilities/#4-anomaly-detection","title":"4. Anomaly Detection","text":""},{"location":"20-fiscal-platform/platform/ai-capabilities/#problem_3","title":"Problem","text":"<p>Fiscal fraud, numbering irregularities, and operational errors are difficult to catch manually at scale. AI monitors the Fiscal Ledger for patterns that indicate problems.</p>"},{"location":"20-fiscal-platform/platform/ai-capabilities/#specification_3","title":"Specification","text":"Attribute Detail Data source Fiscal Ledger (append-only, hash-chained), invoice metadata, sync logs Detection types See table below Alert channels Dashboard alert center, email, webhook (<code>anomaly.detected</code> event), WhatsApp bot Response Alert \u2192 human review \u2192 flag/dismiss/investigate"},{"location":"20-fiscal-platform/platform/ai-capabilities/#detection-categories","title":"Detection categories","text":"Category Pattern Severity Example Numbering anomaly Gap in fiscal number sequence, duplicate fiscal numbers, counter rollback Critical Fiscal number jumps from 004821 to 004823 \u2014 missing 004822 Velocity anomaly Unusual spike or drop in invoice volume for an outlet High Outlet invoiced 500 items in 1 hour vs. daily average of 50 Amount anomaly Invoice total significantly exceeds historical norms High Single invoice for 50M FC when outlet's max is typically 500K FC Timing anomaly Invoices generated outside business hours or in suspicious patterns Medium 200 invoices sealed between 02:00\u201303:00 AM Tax group anomaly Sudden shift in tax group distribution suggesting mis-classification Medium Outlet switches 80% of items from TG01 to TG04 (exempt) in one week Void/refund anomaly Excessive void or refund rate relative to sales High 40% void rate in a single shift Sync delay anomaly Invoices stuck in offline queue beyond grace period Medium 500 drafts queued for 72+ hours without sync"},{"location":"20-fiscal-platform/platform/ai-capabilities/#model-approach","title":"Model approach","text":"<ul> <li>Statistical baselines: Establish per-outlet, per-cashier, and per-time-period baselines using rolling 30-day windows.</li> <li>Isolation Forest / Autoencoder: Unsupervised anomaly detection on multivariate features (invoice count, total, tax group distribution, void rate, sync latency).</li> <li>Rule-based triggers: Hard rules for critical anomalies (numbering gaps, duplicate fiscal numbers) that bypass ML and alert immediately.</li> </ul>"},{"location":"20-fiscal-platform/platform/ai-capabilities/#phase-phase-2-rule-based-phase-4-ml-based","title":"Phase: Phase 2 (rule-based) / Phase 4 (ML-based)","text":""},{"location":"20-fiscal-platform/platform/ai-capabilities/#5-predictive-analytics","title":"5. Predictive Analytics","text":""},{"location":"20-fiscal-platform/platform/ai-capabilities/#problem_4","title":"Problem","text":"<p>Finance teams need forward-looking insights \u2014 projected tax liability, revenue trends, seasonal patterns \u2014 not just backward-looking reports.</p>"},{"location":"20-fiscal-platform/platform/ai-capabilities/#specification_4","title":"Specification","text":"Report Description Model Tax liability forecast Projected monthly/quarterly tax obligations based on current invoicing velocity and seasonal patterns Time-series forecasting (Prophet / ARIMA) Revenue projection Revenue forecast by outlet, product category, and client segment Time-series + regression Seasonal demand Identify peak/trough periods for inventory and staffing Seasonal decomposition Cash flow prediction Predict when mobile money vs. cash payments will be collected Classification + time-series Compliance risk score Per-outlet risk score based on anomaly history, sync reliability, and tax classification accuracy Logistic regression / gradient boosting"},{"location":"20-fiscal-platform/platform/ai-capabilities/#dashboard-integration","title":"Dashboard integration","text":"<p>Predictive insights surface in the web dashboard as:</p> <ul> <li>Forecast cards \u2014 \"Estimated TVA liability for March: 2.4M FC (\u00b18%)\" on the dashboard home.</li> <li>Trend charts \u2014 Revenue and tax projections overlaid on historical data with confidence intervals.</li> <li>Risk indicators \u2014 Color-coded compliance risk scores per outlet in the fleet view.</li> <li>Alerts \u2014 \"Tax liability projected to exceed 10M FC this quarter \u2014 review TG distribution\" in the alert center.</li> </ul>"},{"location":"20-fiscal-platform/platform/ai-capabilities/#api-access","title":"API access","text":"<pre><code>GET /api/v1/analytics/forecast?outlet_id=OUT-001&amp;metric=tax_liability&amp;period=quarterly\n</code></pre>"},{"location":"20-fiscal-platform/platform/ai-capabilities/#phase-phase-4-requires-sufficient-historical-data-from-phases-13","title":"Phase: Phase 4 (requires sufficient historical data from Phases 1\u20133)","text":""},{"location":"20-fiscal-platform/platform/ai-capabilities/#6-ocr-document-digitization","title":"6. OCR &amp; Document Digitization","text":""},{"location":"20-fiscal-platform/platform/ai-capabilities/#problem_5","title":"Problem","text":"<p>Many DRC businesses have years of paper invoices that are not in any digital system. Stalela can ingest these as historical records (not fiscally sealed \u2014 they're already issued) or convert incoming paper invoices from suppliers into structured data.</p>"},{"location":"20-fiscal-platform/platform/ai-capabilities/#specification_5","title":"Specification","text":"Attribute Detail Input Camera photo, scanned PDF, uploaded image Output Structured invoice data (items, amounts, tax groups, client info) Languages French, English Accuracy target \u2265 95% character accuracy, \u2265 90% field extraction accuracy Use cases (1) Digitize historical paper invoices for record-keeping. (2) Extract data from supplier invoices for purchase ledger entry."},{"location":"20-fiscal-platform/platform/ai-capabilities/#processing-pipeline","title":"Processing pipeline","text":"<pre><code>flowchart LR\n    SCAN[\"Photo / PDF Upload\"] --&gt; PREPROCESS[\"Image Preprocessing\\n(deskew, denoise, contrast)\"]\n    PREPROCESS --&gt; OCR[\"OCR Engine\\n(Tesseract / Cloud Vision)\"]\n    OCR --&gt; EXTRACT[\"Field Extractor\\n(NER + layout analysis)\"]\n    EXTRACT --&gt; REVIEW[\"Human Review UI\"]\n    REVIEW --&gt; STORE[\"Store as\\ndigitized record\\nor draft invoice\"]</code></pre>"},{"location":"20-fiscal-platform/platform/ai-capabilities/#constraints","title":"Constraints","text":"<ul> <li>OCR-digitized invoices are stored as <code>source: \"ocr_scan\"</code> and are not fiscally sealed unless the merchant explicitly requests a new fiscal event.</li> <li>The system never fabricates fiscal numbers for scanned historical invoices \u2014 they are informational records only.</li> <li>Low-quality scans (blurry, torn, partial) are flagged for manual entry.</li> </ul>"},{"location":"20-fiscal-platform/platform/ai-capabilities/#phase-phase-4","title":"Phase: Phase 4","text":""},{"location":"20-fiscal-platform/platform/ai-capabilities/#7-compliance-monitoring","title":"7. Compliance Monitoring","text":""},{"location":"20-fiscal-platform/platform/ai-capabilities/#problem_6","title":"Problem","text":"<p>DRC tax regulations change \u2014 new arr\u00eat\u00e9s, updated tax rates, revised exemption lists. Merchants need to know when changes affect their invoicing.</p>"},{"location":"20-fiscal-platform/platform/ai-capabilities/#specification_6","title":"Specification","text":"Attribute Detail Sources DGI website, official gazette (Journal Officiel), ministry circulars, partner legal advisors Detection NLP-based document analysis that identifies changes to tax rates, exemptions, invoicing requirements, and reporting obligations Output Alert with summary, affected tax groups, recommended action, and link to source document Review Stalela compliance team reviews and confirms before pushing to merchants"},{"location":"20-fiscal-platform/platform/ai-capabilities/#alert-examples","title":"Alert examples","text":"Change detected Affected TG Recommended action New arr\u00eat\u00e9 exempts agricultural inputs from TVA TG01 \u2192 TG04 for qualifying items Review product catalog and reclassify agricultural inputs DGI increases TVA rate from 16% to 18% TG01 Update tax engine rate; effective date: 2027-01-01 New reporting requirement: monthly electronic submission mandatory All Update Sync Agent schedule from weekly to daily batch"},{"location":"20-fiscal-platform/platform/ai-capabilities/#phase-phase-4-monitoring-ongoing-manual-review-by-compliance-team-from-phase-1","title":"Phase: Phase 4 (monitoring) / Ongoing (manual review by compliance team from Phase 1)","text":""},{"location":"20-fiscal-platform/platform/ai-capabilities/#8-smart-search-insights","title":"8. Smart Search &amp; Insights","text":""},{"location":"20-fiscal-platform/platform/ai-capabilities/#problem_7","title":"Problem","text":"<p>Finance teams and auditors ask questions like \"How much TVA did we collect on cement sales in Q3?\" or \"Show me all invoices for Ets Mwamba over 500,000 FC.\" Today they export data and use spreadsheets. Natural language search lets them ask directly.</p>"},{"location":"20-fiscal-platform/platform/ai-capabilities/#specification_7","title":"Specification","text":"Attribute Detail Input Natural language query in the dashboard search bar or via API Languages French, English Data source Fiscal Ledger, invoice metadata, reports, analytics Output Structured answer (table, chart, or summary) with source citations"},{"location":"20-fiscal-platform/platform/ai-capabilities/#query-examples","title":"Query examples","text":"Natural language query Structured interpretation Result type \"Total TVA pour ciment en Q3 2026\" <code>SUM(tax_amount) WHERE item LIKE 'ciment%' AND tax_group='TG01' AND date BETWEEN '2026-07-01' AND '2026-09-30'</code> Number + breakdown table \"Factures Ets Mwamba &gt; 500 000 FC\" <code>SELECT * FROM invoices WHERE client='Ets Mwamba' AND total &gt; 500000</code> Invoice list \"Quel caissier a le plus de factures annul\u00e9es ce mois?\" <code>SELECT cashier_id, COUNT(*) FROM invoices WHERE type='void' AND month=current GROUP BY cashier_id ORDER BY count DESC LIMIT 1</code> Ranked list \"Compare revenue outlet Gombe vs Limete this quarter\" Multi-outlet revenue comparison Bar chart"},{"location":"20-fiscal-platform/platform/ai-capabilities/#architecture","title":"Architecture","text":"<ul> <li>Text-to-SQL / Text-to-Query layer translates natural language into structured queries against the Fiscal Ledger read replica.</li> <li>Guardrails prevent queries that could expose raw signing keys, HSM credentials, or other merchants' data.</li> <li>Queries are scoped to the authenticated merchant's data and respect role-based access control.</li> <li>Complex queries that would scan more than 1M rows are queued and run async with progress indication.</li> </ul>"},{"location":"20-fiscal-platform/platform/ai-capabilities/#phase-phase-4_1","title":"Phase: Phase 4","text":""},{"location":"20-fiscal-platform/platform/ai-capabilities/#api-surface-summary","title":"API surface summary","text":"Endpoint Method Description Phase <code>/api/v1/invoices/natural</code> POST Create invoice from natural language text Phase 2 <code>/api/v1/tax/classify</code> POST Classify items into tax groups Phase 2 <code>/api/v1/analytics/forecast</code> GET Retrieve predictive forecasts Phase 4 <code>/api/v1/analytics/anomalies</code> GET List detected anomalies Phase 2 <code>/api/v1/ocr/scan</code> POST Upload document for OCR extraction Phase 4 <code>/api/v1/search/query</code> POST Natural language search over fiscal data Phase 4 <p>All AI endpoints inherit the same authentication (Bearer token), rate limiting, and tenant isolation as the core invoicing API.</p>"},{"location":"20-fiscal-platform/platform/ai-capabilities/#model-hosting-infrastructure","title":"Model hosting &amp; infrastructure","text":"Component Technology Notes NL Invoice Parser Fine-tuned multilingual LLM (mT5 / Mistral) + RAG Hosted within Stalela cloud boundary Tax Auto-Classifier Gradient-boosted classifier + embedding similarity Trained on DRC tariff schedule + transaction history Anomaly Detection Isolation Forest + rule engine Statistical baselines per outlet Predictive Analytics Prophet / ARIMA time-series models Runs on Fiscal Ledger read replica OCR Tesseract + Cloud Vision API (opt-in) Image preprocessing pipeline Smart Search Text-to-SQL (fine-tuned CodeLlama / StarCoder) Sandboxed query execution Compliance Monitor NLP document classifier + change detector Semi-automated with human review <p>All models run on dedicated compute within the Stalela cloud boundary. Inference latency targets: &lt; 2 s for NL parsing, &lt; 500 ms for tax classification, &lt; 1 s for search queries.</p>"},{"location":"20-fiscal-platform/platform/ai-capabilities/#privacy-data-governance","title":"Privacy &amp; data governance","text":"<ul> <li>Data residency: All training data and model weights stay within the Stalela cloud boundary (same region as the Fiscal Ledger).</li> <li>No cross-tenant training: Models are fine-tuned per merchant or on anonymized aggregate data. One merchant's invoice data never trains another merchant's model.</li> <li>Audit trail: Every AI suggestion, confidence score, and human override is logged with <code>ai_suggestion_id</code>, <code>model_version</code>, and <code>accepted: true/false</code>.</li> <li>Opt-in for cloud AI: Merchants who prefer not to use AI features can disable them at the outlet level. Tax classification falls back to manual selection.</li> <li>Data retention for training: Transaction data used for model training follows the same 10-year regulatory retention requirement as the Fiscal Ledger.</li> </ul>"},{"location":"20-fiscal-platform/platform/ai-capabilities/#phasing-summary","title":"Phasing summary","text":"Capability Phase 1 Phase 2 Phase 4 Natural Language Invoice Creation \u2014 WhatsApp bot + chat widget Voice input, advanced NLU WhatsApp Invoice Bot \u2014 Core flows (create, status, reports) Extended (analytics, alerts) Tax Auto-Classification \u2014 Model training + API Auto-apply with high confidence Anomaly Detection \u2014 Rule-based alerts ML-based + compliance scoring Predictive Analytics \u2014 \u2014 Full forecasting suite OCR &amp; Document Digitization \u2014 \u2014 Camera + PDF pipeline Compliance Monitoring Manual review Manual review NLP-assisted monitoring Smart Search &amp; Insights \u2014 \u2014 Text-to-SQL search"},{"location":"20-fiscal-platform/platform/api/","title":"Invoicing API","text":"<p>Stalela is fiscal invoicing infrastructure for the DRC. The Invoicing API is the primary developer surface that receives canonical payloads, applies the 14 DGI tax groups, and routes the request through the Cloud Signing Service (HSM-backed). Every fiscal event is numbered by the Monotonic Counter Manager, signed inside the HSM, timestamped, and stored in the hash-chained fiscal ledger before Stalela returns the sealed response to the caller. This surface honors the SFE specifications (docs/sfe-specifications-v1-summary) by supporting the five mandatory invoice types, the 14 tax groups, immutable security elements, and offline queueing semantics required by the DGI.</p>"},{"location":"20-fiscal-platform/platform/api/#authentication","title":"Authentication","text":"<p>Requests require an outbound API key scoped to a merchant and an outlet. Send <code>Authorization: Bearer &lt;token&gt;</code> plus <code>X-Stalela-Merchant-ID</code> and <code>X-Stalela-Outlet-ID</code> headers so the Cloud can enforce multi-tenant quotas. Optional headers such as <code>X-Stalela-User-ID</code> or <code>X-Stalela-Source</code> help auditors trace which dashboard user, SDK, or future POS terminal produced a fiscal request. The platform enforces rate limits per outlet and per API key (e.g., 60 requests/min); honor <code>Retry-After</code> in <code>429</code> responses and back off accordingly.</p>"},{"location":"20-fiscal-platform/platform/api/#core-endpoints","title":"Core endpoints","text":""},{"location":"20-fiscal-platform/platform/api/#post-apiv1invoices","title":"POST /api/v1/invoices","text":"<p>Create and fiscalize an invoice in one call. Stalela validates the canonical payload, applies the tax engine (all 14 DGI tax groups plus client classification), and forwards the payload to the Cloud Signing Service (HSM). The cloud assigns the next sequential fiscal number for the outlet, signs the payload, timestamps it, generates the QR payload, stores the sealed invoice in the fiscal ledger, and returns the response that clients may display or deliver via email/WhatsApp/PDF/print.</p> <p>Stalela enforces deterministic field ordering so every signature is reproducible. Clients queue invoices locally (IndexedDB on the dashboard or SQLite in SDKs) when offline and flush them via this endpoint once connectivity returns.</p>"},{"location":"20-fiscal-platform/platform/api/#canonical-payload","title":"Canonical payload","text":"<ol> <li><code>merchant_nif</code> (string) \u2014 tax identifier for the merchant issuing the invoice.</li> <li><code>outlet_id</code> (string) \u2014 the outlet within the merchant namespace.</li> <li><code>pos_terminal_id</code> (string) \u2014 the terminal, SDK, or service creating the invoice.</li> <li><code>cashier_id</code> (string) \u2014 operator or session token.</li> <li><code>invoice_type</code> (sale, advance, credit_note, export, export_credit).</li> <li><code>timestamp</code> (ISO 8601 UTC) \u2014 when the invoice was authored.</li> <li><code>client</code> \u2014 object with <code>name</code>, <code>nif</code>, and <code>classification</code> (<code>Individual</code>, <code>Company</code>, <code>CommercialIndividual</code>, <code>Professional</code>, <code>Embassy</code>).</li> <li><code>items[]</code> \u2014 array of line items; each entry lists <code>code</code>, <code>description</code>, <code>quantity</code>, <code>unit_price</code>, <code>tax_group</code>, and <code>taxable_unit</code>.</li> <li><code>tax_groups[]</code> \u2014 array covering each of the 14 DGI tax groups present (<code>code</code>, <code>name</code>, <code>rate</code>, <code>base_amount</code>, <code>tax_amount</code>).</li> <li><code>totals</code> \u2014 object with <code>subtotal</code>, <code>total_vat</code>, <code>total</code>, and <code>currency</code>.</li> <li><code>payments[]</code> \u2014 array of payment instruments with <code>method</code>, <code>amount</code>, <code>instrument_id</code>, and <code>currency</code>.</li> </ol> <pre><code>{\n  \"merchant_nif\": \"308123456\",\n  \"outlet_id\": \"outlet-kin001\",\n  \"pos_terminal_id\": \"sdk-js-01\",\n  \"cashier_id\": \"cashier-13\",\n  \"invoice_type\": \"sale\",\n  \"timestamp\": \"2026-02-17T04:00:00Z\",\n  \"client\": {\n    \"name\": \"Acme Ltd\",\n    \"nif\": \"123456789\",\n    \"classification\": \"Company\"\n  },\n  \"items\": [\n    {\n      \"code\": \"CONS-001\",\n      \"description\": \"Consulting hours\",\n      \"quantity\": 2,\n      \"unit_price\": \"500.00\",\n      \"tax_group\": \"TG03\",\n      \"taxable_unit\": \"hour\"\n    }\n  ],\n  \"tax_groups\": [\n    {\n      \"code\": \"TG03\",\n      \"name\": \"Standard VAT \u2014 Services\",\n      \"rate\": \"0.16\",\n      \"base_amount\": \"1000.00\",\n      \"tax_amount\": \"160.00\"\n    }\n  ],\n  \"totals\": {\n    \"subtotal\": \"1000.00\",\n    \"total_vat\": \"160.00\",\n    \"total\": \"1160.00\",\n    \"currency\": \"CDF\"\n  },\n  \"payments\": [\n    {\n      \"method\": \"mobile_money\",\n      \"amount\": \"1160.00\",\n      \"instrument_id\": \"AIRTEL-001\",\n      \"currency\": \"CDF\"\n    }\n  ]\n}\n</code></pre>"},{"location":"20-fiscal-platform/platform/api/#get-apiv1invoicesfiscal_number","title":"GET /api/v1/invoices/{fiscal_number}","text":"<p>Retrieve a sealed invoice with every security element and ledger metadata. The response includes the canonical payload, fiscal number, fiscal authority ID, authentication code, timestamp, QR payload, <code>ledger_hash</code>, <code>dgi_status</code> (<code>queued</code>, <code>synced</code>, <code>failed</code>), and the originating <code>outlet_id</code>.</p>"},{"location":"20-fiscal-platform/platform/api/#get-apiv1invoices","title":"GET /api/v1/invoices","text":"<p>List invoices with filters (<code>merchant_nif</code>, <code>outlet_id</code>, <code>date_range</code>, <code>client.nif</code>, <code>status</code>, <code>fiscal_number</code>) plus pagination (<code>page</code>, <code>per_page</code>). Sort by <code>timestamp</code> or <code>fiscal_number</code>. Include query parameters to surface <code>dgi_status</code> so dashboards can display completion badges (real-time vs. queued).</p>"},{"location":"20-fiscal-platform/platform/api/#post-apiv1invoicesfiscal_numbervoid","title":"POST /api/v1/invoices/{fiscal_number}/void","text":"<p>Issue a credit note fiscal event. Provide the reason and item adjustments; Stalela treats the event as a new fiscal event, repeats the tax engine work, signs it via the Cloud Signing Service, and appends it to the ledger while referencing the original invoice.</p>"},{"location":"20-fiscal-platform/platform/api/#post-apiv1invoicesfiscal_numberrefund","title":"POST /api/v1/invoices/{fiscal_number}/refund","text":"<p>Create a refund fiscal event that preserves audit trails. Include the refund <code>amount</code>, <code>currency</code>, <code>payment_reference</code>, and optional <code>reason</code>. The Cloud Signing Service returns a new fiscal number/auth code pair for the refund.</p>"},{"location":"20-fiscal-platform/platform/api/#post-apiv1reports","title":"POST /api/v1/reports","text":"<p>Trigger Z/X/A and audit exports derived from the cloud fiscal ledger. Provide the report <code>type</code>, applicable <code>outlet_id</code>, and the <code>period</code> (date or shift). The response carries <code>report_id</code>, <code>download_url</code>, and the <code>ledger_hash</code> digest that links the report back to the sealed invoices.</p>"},{"location":"20-fiscal-platform/platform/api/#get-apiv1tax-groups","title":"GET /api/v1/tax-groups","text":"<p>Return the manifest of all 14 DGI tax groups with <code>code</code>, <code>name</code>, <code>rate</code>, and <code>effective_from</code> timestamps. Clients cache this payload so offline queues can compute totals before submission.</p>"},{"location":"20-fiscal-platform/platform/api/#response-structure","title":"Response structure","text":"<p>Stalela returns a sealed invoice envelope that mirrors the canonical payload plus the security elements minted inside the Cloud Signing Service (HSM).</p> <pre><code>{\n  \"status\": \"ok\",\n  \"code\": \"INVOICE_FISCALIZED\",\n  \"payload\": {\n    \"fiscal_number\": \"STALELA-2026-000458\",\n    \"auth_code\": \"H8F2-A9D3-9001\",\n    \"timestamp\": \"2026-02-17T04:00:02Z\",\n    \"qr_payload\": \"https://stalela.cd/verify?fiscal_number=STALELA-2026-000458\",\n    \"fiscal_authority_id\": \"cloud-signer-west-1\",\n    \"dgi_status\": \"queued\",\n    \"ledger_hash\": \"e3b0c44298fc1c149afbf4c8996fb924\",\n    \"security_elements\": {\n      \"fiscal_number\": \"STALELA-2026-000458\",\n      \"auth_code\": \"H8F2-A9D3-9001\",\n      \"timestamp\": \"2026-02-17T04:00:02Z\",\n      \"qr_payload\": \"https://stalela.cd/verify?fiscal_number=STALELA-2026-000458\",\n      \"fiscal_authority_id\": \"cloud-signer-west-1\"\n    }\n  }\n}\n</code></pre> <p>The <code>dgi_status</code> field tracks whether the Sync Agent has uploaded the sealed invoice to the DGI: <code>queued</code>, <code>synced</code>, or <code>failed</code>. Client apps can highlight the sync status (green Real-time, yellow Queued, red Retry) without ever fabricating <code>fiscal_number</code> or <code>auth_code</code>.</p>"},{"location":"20-fiscal-platform/platform/api/#error-handling","title":"Error handling","text":"<ul> <li><code>400 Invalid canonical payload</code> \u2014 missing fields, incorrect ordering, or mismatched tax totals.</li> <li><code>401 Unauthorized</code> \u2014 missing or invalid bearer token.</li> <li><code>403 Forbidden</code> \u2014 the API key lacks scope for the merchant/outlet requested.</li> <li><code>422 Fiscalization failed</code> \u2014 the Cloud Signing Service rejected the payload (totals, tax group mismatch, unsupported invoice type).</li> <li><code>429 Too many requests</code> \u2014 rate limit exceeded; honor the <code>Retry-After</code> header before resubmitting.</li> <li><code>500 Internal server error</code> \u2014 transient HSM, ledger, or Sync Agent failure; retry with exponential backoff.</li> </ul>"},{"location":"20-fiscal-platform/platform/api/#webhook-notifications","title":"Webhook notifications","text":"<p>Stalela can deliver webhook notifications when invoices change state. Each webhook is signed with <code>X-Stalela-Signature</code> (HMAC-SHA256) and includes <code>fiscal_number</code>, <code>dgi_status</code>, <code>ledger_hash</code>, and the canonical payload hash. Statuses include <code>fiscalized</code>, <code>synced</code>, <code>dgi_acknowledged</code>, and <code>fiscal_error</code>. Queue indicators (e.g., <code>Queued \u2192 Fiscalized</code>) let dashboards update colored badges in near real time.</p> <pre><code>{\n  \"event\": \"invoice.fiscalized\",\n  \"fiscal_number\": \"STALELA-2026-000458\",\n  \"dgi_status\": \"queued\",\n  \"ledger_hash\": \"e3b0c44298fc1c149afbf4c8996fb924\",\n  \"source\": \"dashboard\",\n  \"security_elements\": {\n    \"auth_code\": \"H8F2-A9D3-9001\",\n    \"timestamp\": \"2026-02-17T04:00:02Z\"\n  }\n}\n</code></pre>"},{"location":"20-fiscal-platform/platform/api/#code-examples","title":"Code examples","text":""},{"location":"20-fiscal-platform/platform/api/#curl","title":"CURL","text":"<pre><code>curl -X POST https://api.stalela.cd/api/v1/invoices \\\n  -H \"Authorization: Bearer $STALELA_API_TOKEN\" \\\n  -H \"X-Stalela-Merchant-ID: stalela-ks-1\" \\\n  -H \"X-Stalela-Outlet-ID: outlet-kin001\" \\\n  -H \"Content-Type: application/json\" \\\n  -d '@invoice.json'\n</code></pre>"},{"location":"20-fiscal-platform/platform/api/#python","title":"Python","text":"<pre><code>import requests\n\nresponse = requests.post(\n    \"https://api.stalela.cd/api/v1/invoices\",\n    headers={\n        \"Authorization\": f\"Bearer {os.environ['STALELA_API_TOKEN']}\",\n        \"X-Stalela-Merchant-ID\": \"stalela-ks-1\",\n        \"X-Stalela-Outlet-ID\": \"outlet-kin001\"\n    },\n    json=invoice_payload  # see canonical structure above\n)\n\nresponse.raise_for_status()\nprint(response.json()[\"payload\"][\"fiscal_number\"])\n</code></pre>"},{"location":"20-fiscal-platform/platform/api/#javascript","title":"JavaScript","text":"<pre><code>const createInvoice = async (payload) =&gt; {\n  const response = await fetch(\"https://api.stalela.cd/api/v1/invoices\", {\n    method: \"POST\",\n    headers: {\n      \"Authorization\": `Bearer ${STALELA_API_TOKEN}`,\n      \"X-Stalela-Merchant-ID\": \"stalela-ks-1\",\n      \"X-Stalela-Outlet-ID\": \"outlet-kin001\",\n      \"Content-Type\": \"application/json\"\n    },\n    body: JSON.stringify(payload)\n  });\n\n  if (!response.ok) {\n    const error = await response.json();\n    throw new Error(error.code);\n  }\n\n  return response.json().payload;\n};\n\nconst memoryPayload = {\n  /* canonical payload */\n};\n</code></pre>"},{"location":"20-fiscal-platform/platform/dashboard/","title":"Web Dashboard","text":"<p>The Stalela Web Dashboard is a Progressive Web App layer that sits in the untrusted client zone. It loads in any modern browser, caches product/customer catalogs, and builds canonical payloads that are sent to the Cloud Signing Service (HSM-backed) for sequential fiscal numbering, signature generation, and QR payload creation. Every fiscalized invoice is then mirrored back to the UI for receipts, reports, and DGI sync status, while the UI keeps a secondary queue of uploads that still need confirmation from the cloud.</p>"},{"location":"20-fiscal-platform/platform/dashboard/#architecture","title":"Architecture","text":"<ul> <li>PWA + Service Worker. The dashboard is a single-page Progressive Web App. This design means the UI assets (HTML, CSS, JS, fonts, icons) are cached by a Service Worker, so even the cheapest Android tablet boots instantly after the first visit.</li> <li>IndexedDB cache &amp; queue. Product catalogs, customer lists, tax group manifests, and queued uploads live in IndexedDB so the UI can search instantly even while offline. The queue stores canonical invoices (deterministic field order) and tracks whether they have been uploaded to the cloud or are waiting for acknowledgement.</li> <li>Fiscal Extension Integration (Phase 1.5). For offline retail environments, the dashboard communicates with the Stalela Fiscal Extension. The extension holds a Delegated Credential and signs invoices locally when the Cloud is unreachable, allowing the dashboard to print legally valid receipts immediately.</li> <li>Background sync for reconciliation. The UI drafts invoices locally. If online, it sends <code>POST /api/v1/invoices</code> to Stalela Cloud. If offline, it requests a signature from the Fiscal Extension, stores the locally-sealed invoice in IndexedDB, and later syncs it via <code>POST /api/v1/invoices/reconcile</code> when connectivity returns.</li> </ul> <p>Lessons from Odoo</p> <p>We reuse Odoo\u2019s single-screen checkout, IndexedDB caching, and offline resilience but overlay fiscal-status indicators, dual-currency displays, and mobile money-native chips. The dashboard feels familiar to merchants while respecting the trust boundary: the UI never fabricates fiscal numbers or tamper-resistant hashes.</p>"},{"location":"20-fiscal-platform/platform/dashboard/#key-screens","title":"Key Screens","text":""},{"location":"20-fiscal-platform/platform/dashboard/#invoice-creation","title":"Invoice creation","text":"<p>Single-screen checkout, inspired by Odoo, keeps the product grid, order summary, and numpad visible together. Large tap targets, instant search-as-you-type, barcode scanning, and favorites speed entry. Each line item shows its DGI tax group badge and updates dual-currency totals (CDF + USD) in real time. A mandatory client classification selector (individual, company, commercial individual, professional, embassy) enables the Submit button.</p>"},{"location":"20-fiscal-platform/platform/dashboard/#invoice-list-search","title":"Invoice list &amp; search","text":"<p>Filters for date range, client NIF, fiscal number, and status (fiscalized / queued / error) help cashiers retrieve past sales. Each row highlights the fiscal number, auth code snippet, QR preview, and a Delivery column that lists emailed, WhatsApp, PDF, or thermal print copies. Queued invoices display a yellow badge until the cloud confirms receipt.</p>"},{"location":"20-fiscal-platform/platform/dashboard/#client-classification-management","title":"Client &amp; classification management","text":"<p>This screen houses DRC client metadata (classification, tax ID, contact information) and lets finance teams update tax group defaults, multi-currency pricing, or mobile money preferences. Every client record is referenced when building canonical payloads that the Cloud Signing Service validates.</p>"},{"location":"20-fiscal-platform/platform/dashboard/#reports-reconciliation","title":"Reports &amp; reconciliation","text":"<p>Session dashboards show Z/X/A totals, tax-group breakdowns, offline queue depth, and DGI sync status. When a cashier closes a session, the UI calls <code>POST /api/v1/reports</code> (Z report) and displays the device signature, ledger hash, and audit export links. A \u201cReport ready\u201d badge stays on until DGI acknowledges the batch.</p>"},{"location":"20-fiscal-platform/platform/dashboard/#settings-access-controls","title":"Settings &amp; access controls","text":"<p>Outlets, API keys, and roles (admin, invoicer, viewer, auditor) are managed here. Each API key is scoped to an outlet, and the UI surfaces the <code>outlet_id</code>, <code>user_id</code>/<code>api_key_id</code>, and <code>source</code> (dashboard, API, SDK, POS) so the Monotonic Counter Manager in Stalela Cloud can serialize numbering without conflicts.</p>"},{"location":"20-fiscal-platform/platform/dashboard/#ux-principles","title":"UX Principles","text":"<ol> <li>Offline-first &amp; responsive. Service Worker + IndexedDB cache the catalog, assets, and queue so the UI renders instantly on a $50 tablet even when connectivity drops.</li> <li>Single-screen workflow. Product grid \u2192 order summary \u2192 numpad: no page refreshes required. Instant product search, barcode scans, and favorites keep interactions snappy.</li> <li>Minimal typing. Tap, drag, and numpad entry replace keyboards. Customer selection, classification, and notes remain the only required text inputs.</li> <li>Fiscal status ribbon. A persistent banner reports Device connected/disconnected/error with green/yellow/red states. It shows the latest fiscal number, the last auth code, and any blocking compliance warnings. Receipt printing is disabled until the Ribbon confirms fiscalization.</li> <li>Dual-currency totals. Subtotals, VAT, and grand totals display both CDF and USD so merchants can compare against their reference rate while the canonical payload records every currency field for the Cloud Signing Service.</li> <li>Mobile money-first payments. Payment chips for Airtel Money, M-Pesa, Orange Money, cash, and bank transfer show currency, available balance, and split-payment stacking. Payment icons stay legible even at smaller sizes.</li> <li>Localized &amp; accessible. Language toggles (French / Lingala), high-contrast badges, and text-scaling controls keep the dashboard WCAG-friendly, especially around fiscal status and offline warnings.</li> </ol>"},{"location":"20-fiscal-platform/platform/dashboard/#offline-first-operations","title":"Offline-first operations","text":"<p>Fiscalization always happens before a receipt is printed. When connectivity disappears, the dashboard requests a signature from the Fiscal Extension, which uses its Delegated Credential to sign the invoice locally. The invoice is now legally valid and can be printed. The offline queue widget sits in the footer and shows \u201cX invoices pending reconciliation.\u201d When connectivity returns, the Service Worker wakes up, flushes pending payloads to the Cloud for verification and ledger appending, and updates each row\u2019s sync badge.</p> <p>Offline queue vs. fiscal status</p> <p>Fiscal status uses green/amber/red badges. Green = Online/Provisioned. Amber = Offline but signing locally via Fiscal Extension (shows remaining block capacity). Red = Block exhausted or credential expired (sales halted). The offline queue widget tracks reconciliation uploads to the Cloud.</p>"},{"location":"20-fiscal-platform/platform/dashboard/#delivery-fiscal-confirmation","title":"Delivery &amp; fiscal confirmation","text":"<p>After the Cloud Signing Service replies, the UI shows a success toast with the fiscal number, auth code, timestamp, and QR preview. Receipt delivery options include email, WhatsApp share, PDF download, and browser print (thermal print via printer APIs). The dashboard also stores the ledger hash and DGI sync status for audit requests and exposes <code>POST /api/v1/reports</code> links (Z, X, A, audit export) so auditors can download sealed data without touching the USB device.</p>"},{"location":"20-fiscal-platform/platform/dashboard/#mermaid-wireframe-flow","title":"Mermaid wireframe flow","text":"<pre><code>flowchart LR\n    A[\"Dashboard\"] --&gt; B[\"Create Invoice\"]\n    B --&gt; C[\"Add Items + Tax\"]\n    C --&gt; D[\"Submit to Stalela Cloud\"]\n    D --&gt; E[\"Cloud Signing Service HSM\"]\n    E --&gt; F[\"Receipt Delivery\\nemail / WhatsApp / PDF / print\"]</code></pre>"},{"location":"20-fiscal-platform/platform/integrations/","title":"Integrations","text":"<p>Stalela is designed as an API-first invoicing platform \u2014 every feature available in the web dashboard is also available through the REST API and SDKs. This page describes the integration tiers, partner connectors, and webhook system that allow external systems to consume sealed fiscal invoices, reports, and compliance events.</p>"},{"location":"20-fiscal-platform/platform/integrations/#integration-tiers","title":"Integration tiers","text":"<pre><code>flowchart LR\n    subgraph Tier1[\"Tier 1 \u2014 REST API\"]\n        API[\"Stalela REST API\\n(invoices, reports, audit)\"]\n    end\n    subgraph Tier2[\"Tier 2 \u2014 SDKs\"]\n        JS[\"JavaScript SDK\"]\n        PY[\"Python SDK\"]\n    end\n    subgraph Tier3[\"Tier 3 \u2014 Webhooks\"]\n        WH[\"Webhook delivery\\n(signed payloads)\"]\n    end\n    subgraph Tier4[\"Tier 4 \u2014 ERP Connectors\"]\n        SAP[\"SAP S/4HANA\"]\n        Odoo[\"Odoo\"]\n        Custom[\"Custom ERP\"]\n    end\n    API --&gt; JS\n    API --&gt; PY\n    API --&gt; WH\n    WH --&gt; SAP\n    WH --&gt; Odoo\n    WH --&gt; Custom</code></pre> Tier Description Phase Tier 1 \u2014 REST API Direct HTTPS calls to the Stalela Cloud API. Full access to invoice creation, status queries, report generation, and audit exports. Phase 1 Tier 2 \u2014 SDKs Official client libraries (JavaScript, Python) that wrap the REST API with offline queuing, retry logic, and type-safe models. Phase 1 Tier 3 \u2014 Webhooks Event-driven notifications pushed to customer endpoints when invoices are sealed, reports are generated, or sync errors occur. Payloads are signed for verification. Phase 2 Tier 4 \u2014 ERP Connectors Pre-built connectors for SAP S/4HANA and Odoo that map Stalela's 14 tax groups to ERP tax codes, sync sealed invoices, and push acknowledgement receipts. Phase 4"},{"location":"20-fiscal-platform/platform/integrations/#rest-api-integration","title":"REST API integration","text":"<p>The REST API is the foundation for all integrations. Key capabilities:</p> Endpoint Method Description <code>/api/v1/invoices</code> POST Submit a canonical payload for fiscalization <code>/api/v1/invoices/{fiscal_number}</code> GET Retrieve a sealed invoice <code>/api/v1/invoices/batch</code> POST Submit multiple payloads in one request <code>/api/v1/reports</code> POST Generate Z/X/A reports <code>/api/v1/audit/export</code> GET Download hash-chained journal exports <code>/api/v1/outlets/{outlet_id}/status</code> GET Check outlet sync health and counter <code>/api/v1/verify/{fiscal_number}</code> GET Public \u2014 verify invoice authenticity (no auth required) <p>All endpoints require TLS 1.3+, <code>Authorization: Bearer &lt;api_key&gt;</code>, and return JSON responses. See the Cloud API Reference for full request/response schemas.</p>"},{"location":"20-fiscal-platform/platform/integrations/#webhook-events","title":"Webhook events","text":"<p>Webhooks notify external systems of fiscal events in near real-time. Each webhook delivery includes:</p> <ul> <li>Signed payload \u2014 HMAC-SHA256 signature in the <code>X-Bono-Signature</code> header, computed with the webhook secret.</li> <li>Event type \u2014 identifies what happened (see table below).</li> <li>Idempotency key \u2014 prevents duplicate processing on the receiver side.</li> </ul> Event Trigger Payload highlights <code>invoice.sealed</code> Cloud Signing Service seals an invoice <code>fiscal_number</code>, <code>auth_code</code>, <code>timestamp</code>, <code>outlet_id</code> <code>invoice.sync.success</code> DGI acknowledges the invoice <code>fiscal_number</code>, <code>dgi_status</code>, <code>acknowledged_at</code> <code>invoice.sync.failed</code> DGI upload fails after max retries <code>fiscal_number</code>, <code>error</code>, <code>retry_count</code> <code>report.generated</code> Z/X/A report is ready <code>report_id</code>, <code>type</code>, <code>download_url</code> <code>outlet.offline_alert</code> Client drafts exceed grace period <code>outlet_id</code>, <code>draft_count</code>, <code>oldest_draft_age</code>"},{"location":"20-fiscal-platform/platform/integrations/#webhook-configuration","title":"Webhook configuration","text":"<pre><code>POST /api/v1/webhooks\n{\n  \"url\": \"https://erp.example.com/bono-events\",\n  \"events\": [\"invoice.sealed\", \"report.generated\"],\n  \"secret\": \"whsec_...\",\n  \"active\": true\n}\n</code></pre>"},{"location":"20-fiscal-platform/platform/integrations/#erp-connectors-phase-4","title":"ERP connectors (Phase 4)","text":"<p>Pre-built connectors for enterprise systems:</p>"},{"location":"20-fiscal-platform/platform/integrations/#sap-s4hana","title":"SAP S/4HANA","text":"<ul> <li>Ingest sealed invoices via IDoc or OData.</li> <li>Map TG01\u2013TG14 to SAP tax codes automatically.</li> <li>Push journal entries to FI/CO modules.</li> <li>Reconcile fiscal reports with SAP cash management.</li> </ul>"},{"location":"20-fiscal-platform/platform/integrations/#odoo","title":"Odoo","text":"<ul> <li>Sync sealed invoices to Odoo's <code>account.move</code> model.</li> <li>Map tax groups to Odoo fiscal positions.</li> <li>Auto-generate Odoo payment entries from Stalela payment data.</li> <li>Dashboard widget showing DGI sync status.</li> </ul>"},{"location":"20-fiscal-platform/platform/integrations/#custom-erp","title":"Custom ERP","text":"<ul> <li>Use the webhook API (Tier 3) to receive events.</li> <li>Use the REST API (Tier 1) to pull invoices and reports on demand.</li> <li>Reference the canonical payload schema in <code>spec/schema-tax-engine-1.md</code> for field mapping.</li> </ul>"},{"location":"20-fiscal-platform/platform/integrations/#mobile-money-integration-phase-2","title":"Mobile money integration (Phase 2)","text":"<p>Stalela supports mobile money as a payment method within invoices:</p> Provider Integration method Notes M-Pesa API callback Payment confirmation triggers invoice submission Airtel Money API callback Same flow as M-Pesa Orange Money API callback Same flow as M-Pesa <p>Mobile money payments are recorded in the invoice's <code>payments</code> array with <code>method: \"mobile_money\"</code> and the provider reference. The payment status does not affect fiscalization \u2014 invoices can be sealed before or after payment confirmation.</p>"},{"location":"20-fiscal-platform/platform/integrations/#pos-integration-phase-2","title":"POS integration (Phase 2)","text":"<p>In Phase 2, point-of-sale systems connect to Stalela as API consumers:</p> <ul> <li>POS terminals submit canonical payloads via the REST API or SDK.</li> <li>The POS SDK handles offline queuing, retry logic, and receipt rendering.</li> <li>Multi-terminal outlets share a single fiscal counter via the Monotonic Counter Manager.</li> <li>See Multi-User Access Control for details on terminal/user identity.</li> </ul>"},{"location":"20-fiscal-platform/platform/integrations/#ai-powered-integration-surfaces","title":"AI-powered integration surfaces","text":"<p>Stalela embeds AI across its integration tiers so external systems and end-users benefit from natural language processing, automated classification, and intelligent alerting:</p> AI capability Integration point Phase Natural Language Invoice API (<code>/api/v1/invoices/natural</code>) Any REST client or SDK can submit invoices as free-text French/Lingala/Swahili instead of structured JSON Phase 2 Tax Auto-Classification (<code>/api/v1/tax/classify</code>) ERPs and POS systems call the classifier to suggest tax groups before building the canonical payload Phase 2 Anomaly Detection webhooks (<code>anomaly.detected</code> event) External systems receive real-time alerts when the Fiscal Ledger shows irregularities Phase 2 Smart Search API (<code>/api/v1/search/query</code>) Dashboards and BI tools query fiscal data using natural language Phase 4 WhatsApp Bot Merchants create, query, and receive invoices via WhatsApp Business API Phase 2 <p>See AI &amp; Natural Language Capabilities for full specifications.</p>"},{"location":"20-fiscal-platform/platform/integrations/#security-considerations","title":"Security considerations","text":"<ul> <li>All integrations authenticate via API keys scoped to specific outlets and permissions.</li> <li>Webhook payloads are signed with HMAC-SHA256; receivers must verify the signature before processing.</li> <li>ERP connectors use OAuth 2.0 or certificate-based authentication for the ERP side.</li> <li>API keys can be rotated and revoked without downtime.</li> <li>Rate limiting protects the API from abuse (default: 100 req/s per API key).</li> <li>AI endpoints inherit the same authentication, rate limiting, and tenant isolation as the core invoicing API. AI models run within the Stalela cloud boundary \u2014 no customer data is sent to third-party providers unless explicitly opted in.</li> </ul>"},{"location":"20-fiscal-platform/platform/multi-user/","title":"Multi-User Access Control","text":"<p>Stalela supports multiple users, API keys, and roles within a single merchant account. Each outlet can have many concurrent users (cashiers, managers, API integrators) submitting invoices through the API, web dashboard, or SDK \u2014 while the Monotonic Counter Manager in the Cloud Signing Service guarantees serialized fiscal numbering per outlet.</p>"},{"location":"20-fiscal-platform/platform/multi-user/#identity-model","title":"Identity model","text":"<pre><code>flowchart TD\n    Merchant[\"Merchant (NIF)\"] --&gt; Outlet1[\"Outlet A\"]\n    Merchant --&gt; Outlet2[\"Outlet B\"]\n    Outlet1 --&gt; User1[\"User: Cashier 1\\n(dashboard login)\"]\n    Outlet1 --&gt; User2[\"User: Cashier 2\\n(dashboard login)\"]\n    Outlet1 --&gt; Key1[\"API Key: ERP Integration\\n(server-to-server)\"]\n    Outlet2 --&gt; User3[\"User: Manager\\n(dashboard login)\"]\n    Outlet2 --&gt; Key2[\"API Key: Mobile App\\n(SDK)\"]</code></pre> Entity Description Identifier Merchant The legal entity registered with the DGI. Owns one or more outlets. <code>merchant_nif</code> Outlet A physical or logical business location. Each outlet has its own fiscal counter. <code>outlet_id</code> User A human who logs into the web dashboard. Assigned a role per outlet. <code>user_id</code> API Key A programmatic credential for server-to-server or SDK access. Scoped to an outlet. <code>api_key_id</code>"},{"location":"20-fiscal-platform/platform/multi-user/#roles-and-permissions","title":"Roles and permissions","text":"Role Create invoices View invoices Generate reports Manage users/keys Manage outlet settings Cashier \u2705 Own only \u274c \u274c \u274c Supervisor \u2705 All in outlet \u2705 \u274c \u274c Manager \u2705 All in outlet \u2705 \u2705 \u2705 Owner \u2705 All outlets \u2705 \u2705 \u2705 API Key \u2705 Scoped Scoped \u274c \u274c <p>Principle of least privilege</p> <p>Users and API keys default to the most restrictive permissions. Elevated roles must be explicitly granted by an Owner or Manager.</p>"},{"location":"20-fiscal-platform/platform/multi-user/#fiscal-numbering-under-concurrency","title":"Fiscal numbering under concurrency","text":"<p>When multiple users or API keys submit invoices to the same outlet simultaneously, the Monotonic Counter Manager serializes them:</p> <ol> <li>Each invoice request enters a per-outlet queue inside the Cloud Signing Service.</li> <li>The counter increments atomically under serializable database isolation \u2014 no gaps, no duplicates.</li> <li>The sealed response includes the assigned <code>fiscal_number</code> and the <code>user_id</code> or <code>api_key_id</code> that submitted the payload, providing full traceability.</li> </ol> <pre><code>sequenceDiagram\n    participant C1 as Cashier 1\n    participant C2 as Cashier 2\n    participant API as API Gateway\n    participant HSM as Cloud Signing Service\n    participant Counter as Monotonic Counter\n\n    C1-&gt;&gt;API: POST /invoices (payload A)\n    C2-&gt;&gt;API: POST /invoices (payload B)\n    API-&gt;&gt;HSM: Enqueue payload A\n    API-&gt;&gt;HSM: Enqueue payload B\n    HSM-&gt;&gt;Counter: Acquire next fiscal number (serialized)\n    Counter--&gt;&gt;HSM: fiscal_number = 101\n    HSM--&gt;&gt;API: Sealed response A (fiscal_number: 101)\n    HSM-&gt;&gt;Counter: Acquire next fiscal number\n    Counter--&gt;&gt;HSM: fiscal_number = 102\n    HSM--&gt;&gt;API: Sealed response B (fiscal_number: 102)\n    API--&gt;&gt;C1: Invoice sealed (101)\n    API--&gt;&gt;C2: Invoice sealed (102)</code></pre>"},{"location":"20-fiscal-platform/platform/multi-user/#invoice-tagging","title":"Invoice tagging","text":"<p>Every sealed invoice carries metadata identifying who submitted it:</p> <pre><code>{\n  \"fiscal_number\": \"BONO-OUTLET42-101\",\n  \"merchant_nif\": \"123456789\",\n  \"outlet_id\": \"OUTLET-42\",\n  \"submitted_by\": {\n    \"type\": \"user\",\n    \"id\": \"USR-007\",\n    \"role\": \"cashier\"\n  },\n  \"source\": \"dashboard\"\n}\n</code></pre> <p>For API key submissions, <code>submitted_by</code> contains <code>\"type\": \"api_key\"</code> and the key ID. The <code>source</code> field indicates the channel: <code>dashboard</code>, <code>api</code>, or <code>sdk</code>.</p>"},{"location":"20-fiscal-platform/platform/multi-user/#api-key-management","title":"API key management","text":"<ul> <li>Creation: Owners and Managers create API keys scoped to a specific outlet via the dashboard or API.</li> <li>Rotation: Keys can be rotated without downtime \u2014 the old key remains valid for a configurable grace period (default: 24 hours).</li> <li>Revocation: Immediate revocation is available. Revoked keys return <code>401 Unauthorized</code>.</li> <li>Scoping: Each API key specifies which operations it can perform (e.g., create invoices only, or create + view reports).</li> </ul>"},{"location":"20-fiscal-platform/platform/multi-user/#audit-trail","title":"Audit trail","text":"<p>All user and API key actions are logged with:</p> <ul> <li><code>user_id</code> or <code>api_key_id</code></li> <li>Action performed (create_invoice, view_report, manage_user, etc.)</li> <li>Timestamp</li> <li>Outlet context</li> <li>IP address / user agent</li> </ul> <p>Audit logs are available via the dashboard (Manager/Owner) and through the <code>/api/v1/audit/actions</code> endpoint.</p>"},{"location":"20-fiscal-platform/platform/multi-user/#session-management","title":"Session management","text":"<ul> <li>Dashboard sessions use secure cookies with <code>HttpOnly</code>, <code>Secure</code>, and <code>SameSite=Strict</code> attributes.</li> <li>Session tokens are rotated on login to prevent session fixation.</li> <li>Idle sessions expire after 30 minutes (configurable per merchant).</li> <li>API keys do not use sessions \u2014 they authenticate via <code>Authorization: Bearer &lt;api_key&gt;</code> on every request.</li> </ul>"},{"location":"20-fiscal-platform/platform/overview/","title":"Platform Overview","text":""},{"location":"20-fiscal-platform/platform/overview/#what-is-stalela","title":"What is Stalela?","text":"<p>Stalela is fiscal invoicing infrastructure for the DRC\u2014think Stripe Invoices for compliance teams that need canonical payloads, trusted fiscal numbers, and HSM-backed signing without shipping any hardware.</p>"},{"location":"20-fiscal-platform/platform/overview/#how-stalela-works","title":"How Stalela works","text":"<ol> <li>Client apps (web dashboard, REST API consumers, and SDKs) prepare canonical JSON invoices with deterministic field ordering (<code>merchant_id</code>, <code>outlet_id</code>, <code>pos_terminal_id</code>, <code>cashier_id</code>, <code>client</code>, <code>items</code>, <code>tax_groups</code>, <code>totals</code>, <code>payments</code>, <code>timestamp</code>) and queue drafts in IndexedDB/SQLite when offline.</li> <li>The Invoicing API validates schema, enforces the 14 DGI tax groups and client classifications (Individual, Company, CommercialIndividual, Professional, Embassy), applies rounding rules, and forwards the sanitized payload to the Cloud Signing Service.</li> <li>The Cloud Signing Service (HSM) requests the next sequential fiscal number from the Monotonic Counter Manager, signs the payload, timestamps the event, generates the QR payload, and anchors the sealed invoice inside the append-only Fiscal Ledger while the Report Generator refreshes Z/X/A/audit summaries.</li> <li>The sealed invoice (fiscal number, auth code, timestamp, QR, fiscal authority ID, ledger hash) flows back to the caller so receipts can be delivered via email, WhatsApp, PDF, or thermal print; ledger entries are also accessible to auditors and API consumers.</li> <li>The Sync Agent ships the sealed payload to the DGI\u2019s MCF/e-MCF control modules, tracks the <code>dgi_status</code> (<code>queued</code>, <code>synced</code>, <code>failed</code>), and surfaces acknowledgments through dashboards, webhooks, and SDK callbacks.</li> </ol>"},{"location":"20-fiscal-platform/platform/overview/#platform-flow","title":"Platform Flow","text":"<pre><code>flowchart LR\n  A[\"API / Dashboard\"] --&gt; C[\"Stalela Cloud\\nInvoicing API + Cloud Signing Service HSM\"]\n  B[\"SDKs &amp; Integrations\"] --&gt; C\n  C --&gt; D[\"Sealed Invoice\\nFiscal Ledger &amp; Report Generator\"]\n  D --&gt; E[\"Email / WhatsApp / PDF / Print\"]\n  D --&gt; F[\"Sync Agent \u2014 MCF/e-MCF\"]</code></pre>"},{"location":"20-fiscal-platform/platform/overview/#design-principles","title":"Design principles","text":"<ul> <li>Cloud-first trust boundary: The Cloud Signing Service (HSM) is the only authority for fiscal numbers, auth codes, timestamps, and QR payloads; client apps never fabricate or mutate security elements.</li> <li>Offline resilience: Inspired by the Odoo lessons, the PWA caches catalogs and customers in IndexedDB, keeps service workers alive, shows fiscal device status badges, and flushes IndexedDB/SQLite queues only after the canonical payload is sealed.</li> <li>Deterministic canonical payloads: Field ordering, tax group metadata, and payment records are never reshuffled so the Fiscal Ledger and QR payloads remain verifiable.</li> <li>Multi-user, multi-tenant scale: Each invoice tags <code>outlet_id</code>, <code>pos_terminal_id</code>, <code>cashier_id</code>, and API key scopes so the Monotonic Counter Manager serializes numbering per outlet while roles and quotas protect tenants.</li> <li>Mobile money + multi-currency support: Airtel Money, M-Pesa, Orange Money, and USD/CDF split payments are front and center so traders and schools can use cash and mobile instruments simultaneously.</li> <li>AI-assisted, human-confirmed: Natural language invoice creation, tax auto-classification, anomaly detection, and predictive analytics are embedded across the platform \u2014 but the Cloud Signing Service remains the sole fiscal authority. AI suggests; the HSM decides. See AI &amp; Natural Language Capabilities.</li> </ul>"},{"location":"20-fiscal-platform/platform/overview/#target-users","title":"Target users","text":"<ul> <li>Finance teams and comptrollers who need sealed invoices, Z/X/A/audit reports, and instant receipts (email, WhatsApp, PDF, print) without managing hardware.</li> <li>Merchants and cashiers who create invoices by typing a natural language message \u2014 in French, Lingala, or Swahili \u2014 via WhatsApp or the dashboard chat widget, and receive a sealed fiscal invoice in seconds. See Natural Language Invoice Creation.</li> <li>Developers building integrations, SDKs, ERP connectors, or webhook consumers who expect Stripe-like payloads, rate limits, and deterministic behavior.</li> <li>POS vendors and retailers preparing for Phase 2 multi-terminal deployment with local fiscal services that mediate access to the cloud signer.</li> <li>Auditors, regulators, and the DGI who demand append-only ledgers, canonical security elements, and verified QR codes for every invoice.</li> </ul>"},{"location":"20-fiscal-platform/platform/overview/#security-compliance","title":"Security &amp; compliance","text":"<p>Stalela satisfies the SFE specifications: all five invoice types plus the 14 DGI tax groups run through the tax engine, client classification is mandatory, and every sealed invoice includes the fiscal number, fiscal authority ID, cryptographic auth code, trusted timestamp, and QR payload produced by the Cloud Signing Service (HSM). The Fiscal Ledger remains append-only, the Report Generator emits Z/X/A/audit exports, and voids/refunds become new fiscal events instead of deletions.</p> <p>Anyone \u2014 customers, auditors, DGI inspectors \u2014 can verify that an invoice is genuine by scanning the QR code on the receipt or entering the fiscal number at the public verification portal (<code>verify.stalela.cd</code>). The verification service checks the ECDSA signature against the HSM's public key, confirms hash-chain integrity in the Fiscal Ledger, and reports DGI sync status \u2014 all without requiring login. See Invoice Verification.</p>"},{"location":"20-fiscal-platform/platform/overview/#delivery-reporting","title":"Delivery &amp; reporting","text":"<p>Receipt delivery is multi-channel (email, WhatsApp, PDF, thermal print) and always includes the fiscal number plus QR payload while the ledger and Report Generator power Z, X, A, and audit export data for inspectors and finance teams. The WhatsApp Invoice Bot also serves as a delivery and query channel \u2014 merchants can check invoice status, download receipts, and request Z reports directly in their WhatsApp conversation. Offline-first clients queue invoices locally, surface queue depth indicators, and retry until Stalela Cloud seals the payload. The Sync Agent handles DGI integration (MCF/e-MCF) so authorized invoices and ledger hashes reach the ministry even when connectivity is intermittent.</p> <p>Anomaly detection continuously monitors the Fiscal Ledger for numbering gaps, velocity spikes, and suspicious patterns, surfacing alerts through the dashboard, email, and webhooks. Predictive analytics project tax liability and revenue trends so finance teams plan ahead rather than react.</p>"},{"location":"20-fiscal-platform/platform/overview/#phasing-summary","title":"Phasing summary","text":"<ol> <li>Phase 1 \u2014 Software Invoicing (current): Cloud Signing Service (HSM) is the trusted authority, the Invoicing API/web dashboard/SDK ecosystem produce canonical payloads, and sealed invoices stream to delivery channels while the Sync Agent uploads to the DGI.</li> <li>Phase 2 \u2014 POS &amp; Retail: Multi-terminal POS apps reuse the same cloud fiscal signer, add local fiscal services for shared USB devices, and keep the offline/PWA lessons (service worker, IndexedDB, fiscal status badges) for tablets and phones.</li> <li>Phase 3 \u2014 USB Hardware (optional): The archived USB Fiscal Memory device can become an optional trust anchor for DEF-homologated outlets; its documentation lives in <code>design/docs-archive/hardware/</code> while the cloud still mirrors every sealed event for reporting and audits.</li> </ol>"},{"location":"20-fiscal-platform/platform/sdk/","title":"SDK &amp; Libraries","text":"<p>Stalela provides SDKs and client libraries that wrap the Invoicing API so developers can focus on invoices, receipts, and integrations instead of plumbing canonical payloads. This page replaces the legacy POS plugin reference and summarizes the same deterministic payload structure, offline queueing guarantees, and webhook handling that the archived POS plugin document captured.</p>"},{"location":"20-fiscal-platform/platform/sdk/#supported-sdks","title":"Supported SDKs","text":"<ul> <li>JavaScript / TypeScript (npm) \u2014 Browser, Electron, React Native, and POS integrations can share the same package.</li> <li>Python (pip) \u2014 Flask/FastAPI backends, ERP connectors, and accounting scripts.</li> <li>PHP (composer) \u2014 Legacy ERP systems or PHP-based ecommerce platforms.</li> <li>Future adopters \u2014 Java, .NET, and native mobile SDKs land in Phase 1+ as usage grows.</li> </ul> <p>Each SDK targets the canonical payload described in <code>spec/design-pos-plugin-api-1.md</code>, enforces authentication headers like <code>Authorization: Bearer</code>, and respects the <code>X-Stalela-Merchant-ID</code> / <code>X-Stalela-Outlet-ID</code> scoping that the Invoicing API (<code>design/docs/platform/api.md</code>) requires.</p>"},{"location":"20-fiscal-platform/platform/sdk/#core-sdk-features","title":"Core SDK features","text":"<ul> <li>Authentication helpers \u2014 Acquire, refresh, and attach scoped API keys.</li> <li>Canonical payload serialization \u2014 Always order <code>merchant_id</code>, <code>outlet_id</code>, <code>pos_terminal_id</code>, <code>cashier_id</code>, <code>client</code>, <code>items</code>, <code>tax_groups</code>, <code>totals</code>, and <code>payments</code> so signatures remain reproducible (see <code>spec/design-cloud-api-1.md</code> and <code>spec/design-pos-plugin-api-1.md</code>).</li> <li>Offline queue with auto-retry \u2014 IndexedDB (browser) or SQLite (native) keeps drafts, flushes FIFO when connectivity returns, and surfaces fiscal status callbacks (<code>onQueued</code>, <code>onFiscalized</code>, <code>onError</code>).</li> <li>Tax group helpers \u2014 Ship the 14 DGI tax group codes plus client classification validation (Individual, Company, Commercial Individual, Professional, Embassy) before hitting the API.</li> <li>Receipt rendering \u2014 HTML/print-ready templates plus PDF helpers so dashboards and POS screens can embed fiscal numbers, auth codes, and QR payloads.</li> <li>Webhook signature verification \u2014 Validate <code>X-Stalela-Signature</code> (HMAC-SHA256) before honoring <code>fiscalized</code>, <code>synced</code>, or <code>dgi_rejected</code> events.</li> <li>Webhook receivers + delivery utilities \u2014 Automatically verify payloads, emit typed events, and surface <code>ledger_hash</code> + <code>security_elements</code> for auditing.</li> </ul>"},{"location":"20-fiscal-platform/platform/sdk/#getting-started","title":"Getting started","text":""},{"location":"20-fiscal-platform/platform/sdk/#javascript-typescript","title":"JavaScript / TypeScript","text":"<pre><code>npm install @stalela/sdk\n</code></pre> <pre><code>import { Stalela } from '@stalela/sdk';\n\nconst client = new Stalela({ apiKey: process.env.STALELA_API_KEY });\nconst invoice = await client.invoices.create({\n  client: { name: 'Acme Ltd', nif: '987654321', classification: 'Company' },\n  items: [{ description: 'Consulting', quantity: 1, unit_price: 500, tax_group: 'TG03' }],\n  currency: 'CDF',\n  merchant_id: 'stalela-ks-1',\n  outlet_id: 'outlet-kin001',\n  pos_terminal_id: 'pos-sdk-js',\n  cashier_id: 'cashier-42',\n  invoice_type: 'sale',\n  timestamp: new Date().toISOString(),\n  tax_groups: [\n    {\n      code: 'TG03',\n      name: 'Standard VAT \u2014 Services',\n      rate: '0.16',\n      base_amount: '500.00',\n      tax_amount: '80.00'\n    }\n  ],\n  totals: { subtotal: '500.00', total_vat: '80.00', total: '580.00', currency: 'CDF' },\n  payments: [{ method: 'mobile_money', amount: '580.00', instrument_id: 'MOMO-123', currency: 'CDF' }]\n});\n\nconsole.log('Fiscal number', invoice.fiscal_number, 'QR', invoice.qr_payload);\n</code></pre>"},{"location":"20-fiscal-platform/platform/sdk/#python","title":"Python","text":"<pre><code>pip install stalela-sdk\n</code></pre> <pre><code>from stalela import Stalela\n\nclient = Stalela(api_key=os.environ[\"STALELA_API_TOKEN\"])\npayload = {\n    \"merchant_id\": \"stalela-ks-1\",\n    \"outlet_id\": \"outlet-kin001\",\n    \"pos_terminal_id\": \"python-sdk-01\",\n    \"cashier_id\": \"cashier-13\",\n    \"invoice_type\": \"sale\",\n    \"timestamp\": \"2026-02-17T04:00:00Z\",\n    \"client\": {\"name\": \"Acme Ltd\", \"nif\": \"123456789\", \"classification\": \"Company\"},\n    \"items\": [{\"code\": \"CONS-001\", \"description\": \"Consulting hours\", \"quantity\": 2, \"unit_price\": \"500.00\", \"tax_group\": \"TG03\", \"taxable_unit\": \"hour\"}],\n    \"tax_groups\": [{\"code\": \"TG03\", \"name\": \"Standard VAT \u2014 Services\", \"rate\": \"0.16\", \"base_amount\": \"1000.00\", \"tax_amount\": \"160.00\"}],\n    \"totals\": {\"subtotal\": \"1000.00\", \"total_vat\": \"160.00\", \"total\": \"1160.00\", \"currency\": \"CDF\"},\n    \"payments\": [{\"method\": \"mobile_money\", \"amount\": \"1160.00\", \"instrument_id\": \"MOMO-123\", \"currency\": \"CDF\"}]\n}\n\ninvoice = client.invoices.create(payload)\nprint(\"Fiscalized:\", invoice[\"payload\"][\"fiscal_number\"], \"with QR\", invoice[\"payload\"][\"qr_payload\"])\n</code></pre>"},{"location":"20-fiscal-platform/platform/sdk/#canonical-payload-tax-helpers","title":"Canonical payload &amp; tax helpers","text":"<p>Every SDK enforces the field ordering defined in <code>spec/design-pos-plugin-api-1.md</code> (merchant_id \u2192 payments) and mirrors the same validation rules described in the Invoicing API reference. Tax group helpers surface the 14 DGI codes plus client classifications before the request leaves the client, so the Cloud Signing Service can trust the payload order and tax totals when the payload arrives.</p>"},{"location":"20-fiscal-platform/platform/sdk/#offline-queue-reliability","title":"Offline queue &amp; reliability","text":"<p>Offline is non-negotiable. SDKs queue invoices in IndexedDB (browser) or SQLite (native) with statuses such as <code>draft</code>, <code>queued</code>, <code>fiscalized</code>, and <code>error</code>. When connectivity returns, the SDK flushes invoices FIFO to <code>POST /api/v1/invoices</code>, recomputes totals if the catalog changed, and retries with exponential backoff (100 ms \u2192 5 s \u2192 20 s, max 3 attempts). Each retry line logs the <code>nonce</code>/<code>hash</code> so merchants can audit why a submission was delayed. Fiscal status callbacks keep dashboards in sync: green for <code>fiscalized</code>, yellow for queued, red for errors.</p>"},{"location":"20-fiscal-platform/platform/sdk/#webhooks-verification","title":"Webhooks &amp; verification","text":"<p>The SDK verifies <code>X-Stalela-Signature</code> (HMAC-SHA256) before honoring webhook events that describe <code>dgi_status</code> changes (<code>queued</code>, <code>synced</code>, <code>dgi_acknowledged</code>, <code>fiscal_error</code>). Webhook payloads include <code>fiscal_number</code>, <code>ledger_hash</code>, and the canonical payload hash so applications can reconcile receipts without touching untrusted layers. The SDK also exposes helper functions to render receipts (HTML + PDF) summarizing the security elements and tax breakdown.</p>"},{"location":"20-fiscal-platform/platform/sdk/#pos-integration-guide-phase-2-preview","title":"POS integration guide (Phase 2 preview)","text":"<p>Phase 2 POS vendors embed the same SDK to talk to Stalela Cloud instead of running a local fiscal service. In practice, each POS terminal becomes another API consumer that connects through the SDK, scopes requests with <code>outlet_id</code> and <code>user_id</code>, and relies on the SDK\u2019s deterministic serialization, offline queue, and webhook callbacks. POS integrations can reuse the same receipt templates, tax group helpers, and webhook logic that existing dashboards use, which means the transition from Phase 1 dashboards to Phase 2 multi-terminal POS systems is seamless.</p>"},{"location":"20-fiscal-platform/platform/sdk/#see-also","title":"See also","text":"<ul> <li><code>design/docs/platform/api.md</code> \u2014 the REST endpoints that every SDK targets.</li> <li><code>spec/design-pos-plugin-api-1.md</code> \u2014 formal payload specification and canonical ordering.</li> <li><code>design/docs/api/pos-plugin.md</code> \u2014 legacy plugin reference (archived for Phase 3 compliance) that preserved the original payload examples.</li> </ul>"},{"location":"20-specs/api-canonical-transfer/","title":"Canonical Transfer API","text":"<p>The Canonical Transfer Service (CTS) exposes the primary API for creating and retrieving transfers.</p>"},{"location":"20-specs/api-canonical-transfer/#purpose","title":"\ud83c\udfaf Purpose","text":"<ul> <li>Provide a unified API for initiating transfers.  </li> <li>Normalize requests into canonical model.  </li> <li>Return transfer state and timeline</li> </ul>"},{"location":"20-specs/api-canonical-transfer/#endpoints","title":"\ud83d\udd0c Endpoints","text":""},{"location":"20-specs/api-canonical-transfer/#post-transfers","title":"<code>POST /transfers</code>","text":"<p>Creates a new transfer.</p> <p>Headers - <code>Idempotency-Key</code>: unique key per client request (unique on <code>(tenantId, idempotencyKey, bodyHash)</code> for 36h). - <code>X-Canonical-Version</code>: currently fixed to <code>1</code>; bump when schema revs. - <code>Authorization</code>: OAuth2 client-credentials bearer token by default; HMAC signature supported for partners that cannot use OAuth.</p> <p>Request Body <pre><code>{\n  \"tenantId\": \"tn_456\",\n  \"intent\": \"PUSH\",\n  \"amount\": { \"value\": \"1000.00\", \"currency\": \"USD\" },\n  \"sourceCurrency\": \"USD\",\n  \"targetCurrency\": \"USD\",\n  \"fxStrategy\": \"NOT_APPLICABLE\",\n  \"payer\": { \"type\": \"WALLET\", \"id\": \"acct_001\" },\n  \"payee\": { \"type\": \"BANK\", \"id\": \"acct_999\" },\n  \"railHints\": [\"usdc-algo\"],\n  \"feeModel\": \"STORO_STANDARD\",\n  \"endUserRef\": \"end_abc123\",\n  \"externalRef\": \"ext_abc123\",\n  \"metadata\": { \"invoiceId\": \"inv_555\" },\n  \"traceparent\": \"00-4bf92f3577b34da6a3ce929d0e0e4736-00f067aa0ba902b7-00\"\n}\n</code></pre></p> <p>Response <pre><code>{\n  \"transferId\": \"tr_12345\",\n  \"state\": \"SUBMITTED\",\n  \"nextAction\": \"await_settlement\"\n}\n</code></pre></p> <p>Errors - <code>409 IdempotencyConflict</code> \u2013 same key, different <code>bodyHash</code>. - <code>422 EntityDenied</code> \u2013 compliance block. - <code>502 RoutingUnavailable</code> \u2013 directory lookup failed; includes <code>retryAfter</code> when a route window is closed. - <code>503 DependencyUnavailable</code> \u2013 downstream dependency outage (e.g., Compliance, Directory). - <code>500 RailUnavailable</code> \u2013 rail gateway issue.</p>"},{"location":"20-specs/api-canonical-transfer/#get-transfers","title":"<code>GET /transfers</code>","text":"<p>Lists transfers for the authenticated tenant using cursor-based pagination backed by the projection/read-model.</p> <p>Query Parameters</p> Name Type Notes <code>pageSize</code> integer (1\u2013250, default 50) Number of rows to return per page. <code>pageToken</code> string Encodes <code>(tenantId, createdAt DESC, transferId)</code> for cursor pagination. <code>state</code> array Filter by lifecycle state(s); omit for all. <code>intent</code> array Optional filter for AUTH/CAPTURE/PUSH/PULL. <code>rail</code> array Optional filter for routed rail(s). <code>fxStrategy</code> array Optional filter for NOT_APPLICABLE / QUOTE_AT_SUBMIT / PASS_THROUGH. <code>createdAtFrom</code> / <code>createdAtTo</code> RFC3339 timestamp Time-window filter aligned to indexed <code>createdAt</code>. <code>updatedAtFrom</code> / <code>updatedAtTo</code> RFC3339 timestamp Optional trailing updates window (defaults to 90-day horizon). <code>externalRef</code> string Exact match against client-supplied reference. <code>endUserRef</code> string Exact match for downstream correlation. <p>Response</p> <pre><code>{\n  \"items\": [\n    {\n      \"transferId\": \"tr_12345\",\n      \"state\": \"SETTLED\",\n      \"intent\": \"PUSH\",\n      \"rail\": \"usdc\",\n      \"amount\": { \"value\": \"1000.00\", \"currency\": \"USD\" },\n      \"sourceCurrency\": \"USD\",\n      \"targetCurrency\": \"USD\",\n      \"fxStrategy\": \"NOT_APPLICABLE\",\n      \"externalRef\": \"ext_abc123\",\n      \"endUserRef\": \"end_abc123\",\n      \"payerRef\": \"acct_001\",\n      \"payeeRef\": \"acct_999\",\n      \"createdAt\": \"2025-03-02T12:10:00Z\",\n      \"updatedAt\": \"2025-03-02T12:20:00Z\",\n      \"version\": 4\n    }\n  ],\n  \"nextPageToken\": \"g2wAAAABaANkABRt...\"\n}\n</code></pre> <p>Listings are eventually consistent; immediately after POST the transfer may not appear until the projection catches up. Clients needing the freshest state should continue to rely on the POST response or <code>GET /transfers/{id}</code>.</p>"},{"location":"20-specs/api-canonical-transfer/#get-transfersid","title":"<code>GET /transfers/:id</code>","text":"<p>Returns transfer details and event timeline.</p> <p>Response <pre><code>{\n  \"transferId\": \"tr_12345\",\n  \"tenantId\": \"tn_456\",\n  \"state\": \"SETTLED\",\n  \"events\": [\n    { \"type\": \"transfers.initiated\", \"occurredAt\": \"...\" },\n    { \"type\": \"transfers.submitted.usdc\", \"occurredAt\": \"...\" },\n    { \"type\": \"transfers.settled\", \"occurredAt\": \"...\" }\n  ]\n}\n</code></pre></p>"},{"location":"20-specs/api-canonical-transfer/#observability","title":"\ud83d\udcca Observability","text":"<ul> <li>Metrics: see Observability defaults for required counters/histograms.</li> <li>Logs: transferId, tenantId, eventId (never emit PII <code>payer</code>/<code>payee</code>).</li> <li>Traces: propagate <code>traceparent</code> from ingress to outbox publish.</li> </ul>"},{"location":"20-specs/api-canonical-transfer/#canonical-schema-v1","title":"\ud83e\uddec Canonical Schema (v1)","text":"<pre><code>{\n  \"$id\": \"schemas/canonical-transfer/v1.json\",\n  \"$schema\": \"https://json-schema.org/draft/2020-12/schema\",\n  \"title\": \"CanonicalTransferRequest.v1\",\n  \"type\": \"object\",\n  \"required\": [\"tenantId\", \"intent\", \"amount\", \"payer\", \"payee\"],\n  \"properties\": {\n    \"tenantId\": { \"type\": \"string\", \"minLength\": 3, \"maxLength\": 64 },\n    \"intent\": { \"type\": \"string\", \"enum\": [\"AUTH\", \"CAPTURE\", \"PUSH\", \"PULL\"] },\n    \"amount\": {\n      \"type\": \"object\",\n      \"required\": [\"value\", \"currency\"],\n      \"properties\": {\n        \"value\": { \"type\": \"string\", \"pattern\": \"^-?\\\\d{1,20}(\\\\.\\\\d{1,8})?$\" },\n        \"currency\": { \"type\": \"string\", \"pattern\": \"^[A-Z]{3}$\" }\n      },\n      \"additionalProperties\": false\n    },\n    \"sourceCurrency\": { \"type\": \"string\", \"pattern\": \"^[A-Z]{3}$\" },\n    \"targetCurrency\": { \"type\": \"string\", \"pattern\": \"^[A-Z]{3}$\" },\n    \"fxStrategy\": { \"type\": \"string\", \"enum\": [\"NOT_APPLICABLE\", \"QUOTE_AT_SUBMIT\", \"PASS_THROUGH\"] },\n    \"payer\": {\n      \"type\": \"object\",\n      \"required\": [\"type\", \"id\"],\n      \"properties\": {\n        \"type\": { \"type\": \"string\", \"enum\": [\"WALLET\", \"BANK\", \"CARD\", \"MOBILE_MONEY\", \"EXTERNAL\"] },\n        \"id\": { \"type\": \"string\", \"minLength\": 1 }\n      },\n      \"additionalProperties\": true\n    },\n    \"payee\": {\n      \"type\": \"object\",\n      \"required\": [\"type\", \"id\"],\n      \"properties\": {\n        \"type\": { \"type\": \"string\", \"enum\": [\"WALLET\", \"BANK\", \"CARD\", \"MOBILE_MONEY\", \"EXTERNAL\"] },\n        \"id\": { \"type\": \"string\", \"minLength\": 1 }\n      },\n      \"additionalProperties\": true\n    },\n    \"endUserRef\": { \"type\": \"string\", \"maxLength\": 128 },\n    \"railHints\": { \"type\": \"array\", \"items\": { \"type\": \"string\" }, \"maxItems\": 3 },\n    \"feeModel\": { \"type\": \"string\", \"maxLength\": 64 },\n    \"externalRef\": { \"type\": \"string\", \"maxLength\": 128 },\n    \"metadata\": { \"type\": \"object\", \"additionalProperties\": { \"type\": [\"string\", \"number\", \"boolean\"] } },\n    \"traceparent\": { \"type\": \"string\" }\n  },\n  \"additionalProperties\": false\n}\n</code></pre>"},{"location":"20-specs/api-canonical-transfer/#canonicalization-rules","title":"Canonicalization Rules","text":"<ul> <li>Trim string inputs and uppercase currency codes.</li> <li>Amounts are normalized using authoritative currency scale \u2192 emit fixed-scale decimal strings.</li> <li>Sort object keys lexicographically; keep array order stable.</li> <li>Drop empty-string values before hashing.</li> <li>Compute <code>bodyHash = sha256(utf8(JSON.stringify_no_ws(canonical)))</code>.</li> </ul>"},{"location":"20-specs/api-canonical-transfer/#openapi-31-stub","title":"\ud83d\udcdc OpenAPI 3.1 Stub","text":"<pre><code>openapi: 3.1.0\ninfo:\n  title: Stalela CTS API\n  version: 1.0.0\nservers:\n  - url: https://api.storo.io\npaths:\n  /transfers:\n    post:\n      summary: Create transfer\n      parameters:\n        - name: Idempotency-Key\n          in: header\n          required: true\n          schema: { type: string, maxLength: 128 }\n        - name: X-Canonical-Version\n          in: header\n          required: true\n          schema: { type: integer, enum: [1] }\n      requestBody:\n        required: true\n        content:\n          application/json:\n            schema:\n              $ref: ./schemas/canonical-transfer/v1.json\n      responses:\n        \"201\": { description: Created }\n        \"200\": { description: Idempotent replay }\n        \"409\": { description: IdempotencyConflict }\n        \"422\": { description: EntityDenied }\n        \"502\": { description: RoutingUnavailable }\n        \"503\": { description: DependencyUnavailable }\n  /transfers/{id}:\n    get:\n      summary: Get transfer\n      parameters:\n        - name: id\n          in: path\n          required: true\n          schema: { type: string }\n      responses:\n        \"200\": { description: OK }\n</code></pre>"},{"location":"20-specs/api-canonical-transfer/#observability-defaults","title":"\ud83d\udcca Observability Defaults","text":"Metric Type Labels Notes <code>cts_requests_total</code> counter <code>route</code>, <code>code</code>, <code>tenantId</code> Ingest volume + error mix <code>cts_request_duration_seconds_bucket</code> histogram <code>route</code> Track POST latency (SLO p95 &lt; 1.5s) <code>cts_idempotency_conflicts_total</code> counter <code>tenantId</code> Alert if rising above 0.1% <code>cts_compliance_latency_seconds_bucket</code> histogram Compliance round-trip <code>cts_directory_latency_seconds_bucket</code> histogram Directory round-trip <code>cts_outbox_attempts_total</code> counter <code>eventType</code> Publish attempts <code>cts_outbox_failures_total</code> counter <code>eventType</code> For burn-rate SLO <code>cts_transfers_state</code> gauge <code>state</code> Derived from projections <code>cts_consumer_lag</code> gauge <code>topic</code> Exported from SQS/Kafka exporter <p>PromQL Examples</p> <pre><code>histogram_quantile(0.95, sum(rate(http_server_duration_seconds_bucket{route=\"/transfers\",method=\"POST\"}[5m])) by (le)) &gt; 1.5\n\nrate(cts_outbox_failures_total[5m]) / rate(cts_outbox_attempts_total[5m]) &gt; 0.001\n</code></pre>"},{"location":"20-specs/api-canonical-transfer/#postgres-ddl-aurora-serverless-v2","title":"\ud83d\uddc4\ufe0f Postgres DDL (Aurora Serverless v2)","text":"<pre><code>create extension if not exists pgcrypto;\n\ncreate table transfers (\n  transferId uuid primary key default gen_random_uuid(),\n  tenantId text not null,\n  payer jsonb not null,\n  payee jsonb not null,\n  amount_value numeric(20,8) not null,\n  amount_currency char(3) not null,\n  source_currency char(3) null,\n  target_currency char(3) null,\n  fx_strategy text null,\n  rail text not null,\n  intent text not null check (intent in ('AUTH','CAPTURE','PUSH','PULL')),\n  externalRef text null,\n  feeModel text null,\n  endUserRef text null,\n  state text not null,\n  version bigint not null default 0,\n  createdAt timestamptz not null default now(),\n  updatedAt timestamptz not null default now()\n);\n\ncreate index ix_transfers_tenant_created on transfers(tenantId, createdAt desc);\ncreate unique index ux_transfers_externalref on transfers(tenantId, externalRef) where externalRef is not null;\n\ncreate table transfer_events (\n  eventId uuid primary key default gen_random_uuid(),\n  transferId uuid not null references transfers(transferId),\n  type text not null,\n  payload jsonb not null,\n  occurredAt timestamptz not null default now()\n);\n\ncreate index ix_events_transfer_time on transfer_events(transferId, occurredAt);\ncreate unique index ux_events_lifecycle on transfer_events(transferId, type);\n\ncreate table outbox_transfers (\n  id uuid primary key default gen_random_uuid(),\n  eventType text not null,\n  payload jsonb not null,\n  state text not null check (state in ('PENDING','SENT','FAILED')),\n  attempts int not null default 0,\n  lastError text null,\n  createdAt timestamptz not null default now(),\n  updatedAt timestamptz not null default now()\n);\ncreate index ix_outbox_state_created on outbox_transfers(state, createdAt);\ncreate index ix_outbox_eventType on outbox_transfers(eventType);\n\ncreate table idempotency (\n  tenantId text not null,\n  idempotencyKey text not null,\n  bodyHash char(64) not null,\n  transferId uuid not null,\n  createdAt timestamptz not null default now(),\n  primary key (tenantId, idempotencyKey, bodyHash)\n);\n\ncreate index ux_idem_window on idempotency(tenantId, idempotencyKey, bodyHash)\n  where createdAt &gt; now() - interval '36 hours';\n</code></pre>"},{"location":"20-specs/api-canonical-transfer/#idempotent-write-example","title":"Idempotent write example","text":"<pre><code>begin;\ninsert into transfers (...) values (...) returning transferId;\ninsert into outbox_transfers (eventType, payload, state) values ('transfers.submitted.usdc', :payload, 'PENDING');\ninsert into idempotency(tenantId, idempotencyKey, bodyHash, transferId) values (:t,:k,:h,:tr);\ncommit;\n</code></pre>"},{"location":"20-specs/chart-of-accounts/","title":"Chart of Accounts (Stalela)","text":"<p>The Chart of Accounts (CoA) is the backbone of Stalela\u2019s ledger. It defines all account types, their normal balances, and how they roll into financial statements. Based on lessons from Accounting for Developers and adapted to payments systems.</p>"},{"location":"20-specs/chart-of-accounts/#principles","title":"Principles","text":"<ul> <li>Double-entry: Every posting must debit one account and credit another.  </li> <li>Normal balance: Each account has a default side (debit or credit) where increases are recorded.  </li> <li>Hierarchy: Top-level categories are fixed, sub-accounts can be extended per tenant/product.  </li> <li>Accrual basis: Income and expenses recognized when earned, not just when cash moves.  </li> </ul>"},{"location":"20-specs/chart-of-accounts/#top-level-categories","title":"Top-Level Categories","text":""},{"location":"20-specs/chart-of-accounts/#1-assets-normal-balance-debit","title":"1. Assets (Normal Balance: Debit)","text":"<ul> <li>Liquidity (Cash/USDC Pool) </li> <li>Settlement In Transit (funds in process of clearing)  </li> <li>Accounts Receivable (e.g., unsettled merchant payments)  </li> <li>Inventory / Collateral (if applicable for product extensions)  </li> </ul>"},{"location":"20-specs/chart-of-accounts/#2-liabilities-normal-balance-credit","title":"2. Liabilities (Normal Balance: Credit)","text":"<ul> <li>User Balances (owed to end-users)  </li> <li>Merchant Payables (owed to merchants)  </li> <li>Deferred Revenue (collected in advance, not yet earned)  </li> <li>Chargebacks/Returns Payable </li> </ul>"},{"location":"20-specs/chart-of-accounts/#3-equity-normal-balance-credit","title":"3. Equity (Normal Balance: Credit)","text":"<ul> <li>Contributed Capital </li> <li>Retained Earnings (prior net income carried forward)  </li> <li>Current Period Net Income (closed at end of period into Retained Earnings)  </li> </ul>"},{"location":"20-specs/chart-of-accounts/#4-revenue-normal-balance-credit","title":"4. Revenue (Normal Balance: Credit)","text":"<ul> <li>Transaction Fees Earned </li> <li>FX Spread Income </li> <li>Other Service Fees </li> </ul>"},{"location":"20-specs/chart-of-accounts/#5-expenses-normal-balance-debit","title":"5. Expenses (Normal Balance: Debit)","text":"<ul> <li>Processing Costs (rail fees, partner charges)  </li> <li>Chargeback Losses </li> <li>Operational Expenses (infra, compliance overhead)  </li> </ul>"},{"location":"20-specs/chart-of-accounts/#examples","title":"Examples","text":"<p>User Deposit (USDC \u2192 Wallet) - Debit Liquidity (Asset) - Credit User Balances (Liability)  </p> <p>Merchant Payout (USDC \u2192 Merchant) - Debit Merchant Payables (Liability) - Credit Liquidity (Asset)  </p> <p>Fee Collection - Debit User Balance (Liability) - Credit Transaction Fees Earned (Revenue)  </p> <p>Chargeback - Debit Chargebacks Payable (Liability) - Credit Merchant Payables (Liability)  </p>"},{"location":"20-specs/chart-of-accounts/#notes","title":"Notes","text":"<ul> <li>Accounts can be extended per-tenant under the same category.  </li> <li>All postings must reconcile to ensure Assets = Liabilities + Equity.  </li> </ul>"},{"location":"20-specs/data-retention-pii/","title":"Data Retention &amp; PII Handling","text":"<p>The data retention policy governs how long Stalela stores sensitive data and how it is redacted.</p>"},{"location":"20-specs/data-retention-pii/#principles","title":"\ud83c\udfaf Principles","text":"<ul> <li>Minimize PII stored in core DBs.  </li> <li>Encrypt at rest all raw rail payloads.  </li> <li>Retain only what\u2019s needed for audit, compliance, dispute resolution.  </li> <li>Expire or redact data after retention window.</li> </ul>"},{"location":"20-specs/data-retention-pii/#storage-classes","title":"\ud83d\udce6 Storage Classes","text":"<ul> <li>Canonical DBs (CTS, Ledger, Compliance, Directory, Recon) </li> <li>Store IDs, references, metadata only.  </li> <li> <p>No raw PII beyond accountId/tenantId.  </p> </li> <li> <p>Blob Store (encrypted) </p> </li> <li>Stores raw rail payloads, statements.  </li> <li>Access tightly controlled, time-limited.  </li> </ul>"},{"location":"20-specs/data-retention-pii/#retention-windows","title":"\u23f3 Retention Windows","text":"<ul> <li>Transfer &amp; ledger events: 7 years (audit requirement).  </li> <li>Raw rail payloads: 18 months.  </li> <li>Compliance screening results: 5 years.  </li> <li>Operator actions (audit log): 7 years.  </li> </ul>"},{"location":"20-specs/data-retention-pii/#redaction","title":"\ud83e\uddf9 Redaction","text":"<ul> <li>After expiry, execute stored proc <code>select cts_pii_tombstone(:tenantId, :transferId)</code> which:</li> <li>Nulls column-level PII on canonical tables (<code>payer</code>, <code>payee</code>, contact fields).</li> <li>Writes an immutable audit row documenting who requested the erasure and why.</li> <li>Leaves immutable event payloads untouched (they only contain stable references).</li> <li>Keep metadata (transferId, amounts, dates).</li> </ul>"},{"location":"20-specs/data-retention-pii/#security","title":"\ud83d\udd10 Security","text":"<ul> <li>All PII encrypted at rest + in transit.  </li> <li>Logs redact sensitive fields (names, IDs, PANs).  </li> <li>Access scoped to tenant &amp; role.  </li> </ul>"},{"location":"20-specs/data-retention-pii/#popia-cross-border-transfers-za","title":"\ud83c\udf0d POPIA Cross-Border Transfers (ZA)","text":"<ul> <li>Assess adequacy for destination; if inadequate, add contractual safeguards and consent where required.  </li> <li>Maintain a register of cross-border transfers with purpose, destinations, and safeguards.  </li> <li>Ensure processors/sub-processors contractually meet POPIA obligations.  </li> <li>Do not include PII in event payloads unless strictly necessary; prefer references.</li> </ul>"},{"location":"20-specs/data-retention-pii/#runbooks","title":"\ud83e\udded Runbooks","text":"<ul> <li>Retention job failure \u2192 retry, escalate if backlog &gt; 24h.  </li> <li>Legal hold \u2192 suspend deletion for specific entities.  </li> <li>PII exposure incident \u2192 trigger breach protocol immediately.  </li> </ul>"},{"location":"20-specs/error-codes/","title":"Error Taxonomy &amp; Codes","text":"<p>Consistent error codes across APIs.</p>"},{"location":"20-specs/error-codes/#principles","title":"\ud83d\udd11 Principles","text":"<ul> <li>Stable, documented codes.</li> <li>Human-readable messages.</li> <li>Machine-actionable (clients can retry/failover).</li> </ul>"},{"location":"20-specs/error-codes/#categories","title":"\ud83d\uddc2 Categories","text":"<ul> <li>4xx \u2014 Client Errors</li> <li><code>40001</code> Invalid request schema</li> <li><code>40002</code> Idempotency key missing/invalid</li> <li><code>40901</code> Version conflict (optimistic concurrency on internal tools)</li> <li><code>40902</code> Idempotency conflict (same key, different body hash)</li> <li><code>42201</code> Compliance screening: denied</li> <li> <p><code>42202</code> Directory route not found</p> </li> <li> <p>5xx \u2014 Server Errors</p> </li> <li><code>50001</code> Rail adapter unavailable</li> <li><code>50002</code> Outbox publish failure</li> <li><code>50003</code> Ledger posting failed</li> <li><code>50301</code> Dependency unavailable (Compliance, Directory, FX)</li> </ul>"},{"location":"20-specs/error-codes/#rail-reason-code-mappings-informative","title":"Rail Reason Code Mappings (informative)","text":"<ul> <li>Mobile Money (EcoCash/MTN/Airtel)</li> <li>Partner decline \u2192 <code>MM_DECLINED</code></li> <li>Insufficient funds \u2192 <code>MM_INSUFFICIENT_FUNDS</code></li> <li> <p>Timeout/no response \u2192 <code>MM_TIMEOUT</code></p> </li> <li> <p>PayShap</p> </li> <li>Proxy invalid \u2192 <code>PS_PROXY_INVALID</code></li> <li>Beneficiary not available \u2192 <code>PS_BENEFICIARY_UNAVAILABLE</code></li> <li>Timeout \u2192 <code>PS_TIMEOUT</code></li> </ul> <p>Exact partner code \u2192 Stalela reason maps to be versioned per gateway.</p>"},{"location":"20-specs/error-codes/#notes","title":"\ud83d\udccc Notes","text":"<p>Expand per component (CTS, Ledger, Gateways). All error responses MUST include: <pre><code>{\n  \"code\": \"42201\",\n  \"message\": \"Entity denied by compliance\",\n  \"transferId\": \"tr_12345\",\n  \"timestamp\": \"2025-08-27T12:00:00Z\"\n}\n</code></pre></p>"},{"location":"20-specs/events/","title":"Event Specifications","text":"<p>The Event model defines the envelope and catalog of all domain events emitted across Stalela services.</p>"},{"location":"20-specs/events/#purpose","title":"\ud83c\udfaf Purpose","text":"<ul> <li>Provide a single canonical envelope for all events.  </li> <li>Define the catalog of event types (<code>transfers.*</code>, <code>ledger.*</code>, etc.).  </li> <li>Ensure idempotency and consistency across services.  </li> </ul>"},{"location":"20-specs/events/#event-envelope-v1","title":"\ud83d\udce6 Event Envelope (v1)","text":"<pre><code>{\n  \"envelope\": {\n    \"v\": 1,\n    \"eventId\": \"uuid\",\n    \"type\": \"events.transfers.submitted.usdc\",\n    \"occurredAt\": \"2025-08-26T10:15:01Z\",\n    \"tenantId\": \"tn_456\",\n    \"transferId\": \"tr_123\",\n    \"traceparent\": \"00-4bf92f3577b34da6a3ce929d0e0e4736-00f067aa0ba902b7-00\",\n    \"payloadSchema\": \"canonical.transfer.v1\"\n  },\n  \"payload\": {\n    \"amount\": { \"value\": \"1000.00\", \"currency\": \"USD\" },\n    \"payerRef\": \"payer-1\",\n    \"payeeRef\": \"payee-9\",\n    \"endUserRef\": \"end-7\"\n  }\n}\n</code></pre> <p>Fields - <code>envelope.v</code> \u2013 envelope schema version (integer, starting at 1). - <code>envelope.eventId</code> \u2013 unique ID (UUIDv7 recommended). - <code>envelope.type</code> \u2013 dot-delimited string category (see catalog). - <code>envelope.occurredAt</code> \u2013 ISO8601 UTC timestamp. - <code>envelope.tenantId</code> \u2013 tenant scoping. - <code>envelope.transferId</code> \u2013 optional link to transfer (if relevant). - <code>envelope.traceparent</code> \u2013 W3C trace context for correlation end-to-end. - <code>envelope.payloadSchema</code> \u2013 canonical schema identifier (<code>canonical.transfer.v1</code>). - <code>payload</code> \u2013 type-specific content (PII-free; only stable references).</p> <p>Optional enrichment (additive) - <code>kycTier</code> \u2013 KYC tier for context (T0|T1|T2). - <code>riskScore</code> \u2013 screening risk score (0-100). - <code>exchangeControlRef</code> \u2013 reference for exchange control/BoP. - <code>taxCode</code> \u2013 tax/VAT code for fee lines. - <code>proxyType</code> \u2013 proxy type for PayShap (cell|email|id).  </p> <p>Additive fields do not break consumers; treat unknown fields as optional.</p>"},{"location":"20-specs/events/#event-catalog","title":"\ud83d\udcda Event Catalog","text":""},{"location":"20-specs/events/#transfers","title":"Transfers","text":"<ul> <li><code>transfers.initiated</code> </li> <li><code>transfers.submitted.&lt;rail&gt;</code> </li> <li><code>transfers.accepted</code> </li> <li><code>transfers.settled</code> </li> <li><code>transfers.returned</code> </li> <li><code>transfers.failed</code> </li> </ul>"},{"location":"20-specs/events/#ledger","title":"Ledger","text":"<ul> <li><code>ledger.posting.created</code> </li> <li><code>ledger.balance.updated</code> </li> </ul>"},{"location":"20-specs/events/#compliance","title":"Compliance","text":"<ul> <li><code>compliance.entity.flagged</code> </li> </ul>"},{"location":"20-specs/events/#reconciliation","title":"Reconciliation","text":"<ul> <li><code>recon.statement.ingested</code> </li> <li><code>recon.exception.opened</code> </li> </ul>"},{"location":"20-specs/events/#directory","title":"Directory","text":"<ul> <li><code>directory.version.updated</code> </li> </ul>"},{"location":"20-specs/events/#idempotency-rules","title":"\ud83d\udd01 Idempotency Rules","text":"<ul> <li>Event consumers must dedupe using <code>envelope.eventId</code>.</li> <li>For transfer lifecycle, <code>(envelope.transferId, envelope.type)</code> must be unique.</li> <li>Outbox pattern ensures atomic persistence + publish; events are immutable after emission.</li> </ul>"},{"location":"20-specs/events/#partitioning-delivery-defaults","title":"\ud83d\udea6 Partitioning &amp; Delivery Defaults","text":"<ul> <li>SNS FIFO topic: <code>events.transfers.fifo</code> with <code>MessageGroupId = transferId</code> to guarantee order.</li> <li>Outbox worker retry/backoff: <code>1s, 5s, 30s, 2m, 10m, 1h, 2h, 4h, 8h, 16h</code>; send to DLQ after the 10th attempt.</li> <li>DLQ retention: 14 days within queue, plus archived copy retained for 7 years.</li> </ul>"},{"location":"20-specs/events/#versioning","title":"\ud83e\udded Versioning","text":"<ul> <li>Envelope: <code>v</code> is the envelope schema version (current: 1).  </li> <li>Additive changes (new optional fields) require no version bump.  </li> <li>Breaking payload changes introduce a new <code>type</code> version (e.g., <code>transfers.settled.v2</code>) with dual-publish during migration.</li> </ul>"},{"location":"20-specs/events/#observability","title":"\ud83d\udcca Observability","text":"<ul> <li>Metrics: events/sec by type, lag from occurredAt \u2192 consumed.  </li> <li>Audit: immutable event store recommended for replay/debug.</li> </ul>"},{"location":"20-specs/external-integrations/","title":"External Integrations \u2014 Edge Map","text":"<p>This file maps out external systems Stalela must eventually connect to.  </p>"},{"location":"20-specs/external-integrations/#rails","title":"\ud83c\udf0d Rails","text":"<ul> <li>EcoCash / Mobile Money (ZW) \u2192 push-only flows, STK prompts.</li> <li>Zimswitch / OPPWA \u2192 ISO 8583 + JSON APIs, card-present &amp; online.</li> <li>PayShap (SA) \u2192 proxy-based instant payments.</li> <li>USDC/Algorand \u2192 blockchain adapter.</li> <li>EFT/RTGS (SA) \u2192 batch payments, settlement via SARB.</li> </ul>"},{"location":"20-specs/external-integrations/#banks-rtgs","title":"\ud83c\udfe6 Banks &amp; RTGS","text":"<ul> <li>South Africa: NPS, EFT clearing, RTGS.</li> <li>Zimbabwe: Zimswitch settlement partners.</li> </ul>"},{"location":"20-specs/external-integrations/#regulatory","title":"\u2696\ufe0f Regulatory","text":"<ul> <li>South Africa: FIC reporting APIs.</li> <li>Zimbabwe: FIU suspicious activity reporting.</li> <li>Cross-border: FATF Travel Rule (TBD).</li> </ul>"},{"location":"20-specs/external-integrations/#identity-kyc","title":"\ud83c\udd94 Identity &amp; KYC","text":"<ul> <li>Optional MOSIP integration for National ID checks.</li> <li>Local credit bureau lookups (future).</li> <li>SIM-swap signals (mobile operators / third-party providers) for risk.</li> <li>AVS (account verification) and bank account name-matching (ZA) for pull payouts.</li> </ul>"},{"location":"20-specs/external-integrations/#file-specifications-recon","title":"\ud83d\udcc4 File Specifications (Recon)","text":"<ul> <li>Bankserv EFT: settlement/returns file layouts and cutoffs (link: add under recon).</li> <li>PayShap: exception/return notifications mapping.</li> <li>ZIPIT/RTGS: daily statements and reason codes.</li> </ul>"},{"location":"20-specs/external-integrations/#notes","title":"\ud83d\udccc Notes","text":"<p>Each integration will have its own <code>rail-gateway-&lt;name&gt;.md</code> or <code>integration-&lt;name&gt;.md</code>.</p>"},{"location":"20-specs/fixtures/","title":"Golden Fixtures","text":"<p>Golden fixtures are canonical JSON examples used to validate contracts (events and APIs) across services and in CI pipelines.</p>"},{"location":"20-specs/fixtures/#scope","title":"Scope","text":"<ul> <li>Event envelope and payload examples (envelope <code>v=1</code>).</li> <li>Canonical Transfer API requests/responses.</li> <li>Per-rail gateway event samples for <code>accepted/settled/returned/failed</code>.</li> </ul>"},{"location":"20-specs/fixtures/#usage","title":"Usage","text":"<ul> <li>Validate outbound events from providers against fixture schemas.</li> <li>Validate inbound event consumers via golden test vectors.</li> <li>Reference fixtures in CI <code>contract-validate</code> job (see <code>docs/50-repo-structure/ci-cd.md</code>).</li> </ul>"},{"location":"20-specs/fixtures/#examples","title":"Examples","text":""},{"location":"20-specs/fixtures/#event-transferssettled-v1","title":"Event: transfers.settled (v1)","text":"<pre><code>{\n  \"eventId\": \"018f3d20-1111-7c89-b1e3-7a7f5d3b9b10\",\n  \"type\": \"transfers.settled\",\n  \"v\": 1,\n  \"occurredAt\": \"2025-08-26T10:15:01Z\",\n  \"transferId\": \"tr_12345\",\n  \"tenantId\": \"tn_67890\",\n  \"payload\": {\n    \"amount\": { \"value\": 1000, \"currency\": \"USD\" },\n    \"rail\": \"usdc-algo\"\n  }\n}\n</code></pre>"},{"location":"20-specs/fixtures/#api-post-transfers-request","title":"API: POST /transfers request","text":"<pre><code>{\n  \"tenantId\": \"tn_456\",\n  \"payer\": { \"accountId\": \"acct_001\" },\n  \"payee\": { \"accountId\": \"acct_999\" },\n  \"amount\": { \"value\": 1000, \"currency\": \"USD\" },\n  \"rail\": \"usdc-algo\",\n  \"intent\": \"PUSH\",\n  \"externalRef\": \"ext_abc123\",\n  \"metadata\": { \"invoiceId\": \"inv_555\" }\n}\n</code></pre>"},{"location":"20-specs/fixtures/#api-post-transfers-response","title":"API: POST /transfers response","text":"<pre><code>{\n  \"transferId\": \"tr_12345\",\n  \"state\": \"SUBMITTED\",\n  \"nextAction\": \"await_settlement\"\n}\n</code></pre>"},{"location":"20-specs/fx-policy/","title":"FX Policy (USD/ZAR/ZWL)","text":"<p>Defines quote sources, TTL, and audit requirements for FX conversions in supported corridors.</p>"},{"location":"20-specs/fx-policy/#quote-sources","title":"Quote Sources","text":"<ul> <li>RBZ auction (ZW) vs Market providers (ZA) \u2014 configurable per tenant/corridor.</li> <li>Provenance recorded with quotes; fallback hierarchy.</li> </ul>"},{"location":"20-specs/fx-policy/#ttl-usage","title":"TTL &amp; Usage","text":"<ul> <li>TTL per corridor; reject expired quotes.</li> <li>Store applied rate on event/journal for audit.</li> <li>Canonical requests declare <code>fxStrategy</code> (<code>NOT_APPLICABLE</code>, <code>QUOTE_AT_SUBMIT</code>, <code>PASS_THROUGH</code>); Directory enforces viability before routing.</li> </ul>"},{"location":"20-specs/fx-policy/#controls","title":"Controls","text":"<ul> <li>Max deviation vs reference index; alert on breach.</li> <li>Hedging hooks: external position management (future).</li> </ul>"},{"location":"20-specs/fx-policy/#observability","title":"Observability","text":"<ul> <li>Metrics: quote age, deviation, rejection rate.</li> </ul> <p>Last updated: 2025-08-27</p>"},{"location":"20-specs/posting-rules/","title":"Posting Rules (Expanded)","text":"<p>Defines how Stalela translates transfer lifecycle events into double\u2011entry ledger postings. This is the authoritative mapping for <code>ledger-service</code>.</p>"},{"location":"20-specs/posting-rules/#principles","title":"Principles","text":"<ul> <li>Every posting set must balance (sum debits = sum credits).  </li> <li>Postings are append\u2011only; reversals are explicit.  </li> <li>Ledger is accrual\u2011based: income/expenses recognized when earned, not when paid.  </li> <li>Use normal balances from chart\u2011of\u2011accounts.md.  </li> </ul>"},{"location":"20-specs/posting-rules/#event-posting-rules","title":"Event \u2192 Posting Rules","text":""},{"location":"20-specs/posting-rules/#1-transfersaccepted-auth-reservation","title":"1. <code>transfers.accepted</code> (AUTH / reservation)","text":"<ul> <li>If rail supports authorization (card\u2011like), create pending/memo postings:</li> </ul> Debit (Dr) Credit (Cr) Notes Rail Settlement Pending User / Payer Off\u2011balance memo (not cash movement yet)"},{"location":"20-specs/posting-rules/#2-transferssettled-funds-final","title":"2. <code>transfers.settled</code> (funds final)","text":""},{"location":"20-specs/posting-rules/#case-push-payment-payer-sends-to-payee","title":"Case: PUSH payment (payer sends to payee)","text":"Debit (Dr) Credit (Cr) Notes User / Payer Merchant / Payee Principal transfer Merchant / Payee Fees Revenue If fee charged (separate leg) FX Loss Merchant / Payee If FX conversion loss applied Merchant / Payee FX Gain If FX conversion gain applied"},{"location":"20-specs/posting-rules/#case-pull-payment-merchant-pulls-funds","title":"Case: PULL payment (merchant pulls funds)","text":"Debit (Dr) Credit (Cr) Notes User / Payer Merchant / Payee Principal Merchant / Payee Fees Revenue Optional fee leg"},{"location":"20-specs/posting-rules/#perrail-surcharges-and-partner-fees-netting","title":"Per\u2011rail surcharges and partner fees (netting)","text":"Debit (Dr) Credit (Cr) Notes Merchant / Payee Fees Partner Partner surcharge retained by Stalela on behalf of partner Fees Partner Partner Payable Net settlement to partner at recon/settlement time <p>Netting entries reduce operational payouts; settle partner payable on statement reconciliation.</p>"},{"location":"20-specs/posting-rules/#3-transfersreturned-rail-return-chargeback","title":"3. <code>transfers.returned</code> (rail return / chargeback)","text":"Debit (Dr) Credit (Cr) Notes Merchant / Payee User / Payer Reverse principal Fees Expense Merchant / Payee Return fees absorbed"},{"location":"20-specs/posting-rules/#4-transfersfailed-technical-failure","title":"4. <code>transfers.failed</code> (technical failure)","text":"<ul> <li>No postings (transfer never finalized).</li> </ul>"},{"location":"20-specs/posting-rules/#period-closing-entries-ops","title":"Period Closing Entries (Ops)","text":"<p>At end of reporting period (see closing-the-books.md):</p> <ul> <li>Close temporary Income and Expense accounts to Retained Earnings.  </li> <li>Reconciliation must confirm balances vs external statements before close.  </li> </ul>"},{"location":"20-specs/posting-rules/#example-walkthrough","title":"Example Walkthrough","text":"<p>User pays Merchant 100 ZAR via USDC rail. Fee = 2 ZAR.</p> <ol> <li>Event: <code>transfers.settled</code></li> <li>Ledger postings:</li> </ol> Debit (Dr) Credit (Cr) Amount User Account Merchant Account 100 Merchant Account Fees Revenue 2 <p>Merchant net = 98 ZAR. System recognized 2 ZAR as revenue.</p>"},{"location":"20-specs/posting-rules/#exceptions","title":"Exceptions","text":"<ul> <li>Negative balances: only Liquidity/FX/Reserve accounts allowed.  </li> <li>Multi\u2011currency: FX legs must always be paired (gain or loss).  </li> <li>Manual journal entries require dual approval and clear memo.  </li> </ul>"},{"location":"20-specs/posting-rules/#references","title":"References","text":"<ul> <li>chart-of-accounts.md (account categories, normal balances)  </li> <li>closing-the-books.md (period cycle)  </li> <li>tax-vat.md (VAT on fees)  </li> </ul>"},{"location":"20-specs/regulatory-reporting/","title":"Regulatory Reporting (ZA/ZW)","text":"<p>Outlines BoP (SARB exchange control) and goAML (FIC/FIU) reporting interfaces.</p>"},{"location":"20-specs/regulatory-reporting/#bop-reporting-sarb","title":"BoP Reporting (SARB)","text":"<ul> <li>Scope: cross-border payments and receipts.</li> <li>Data: payer/payee, purpose codes, currency, amount, FX rate, <code>exchangeControlRef</code>.</li> <li>Frequency: daily batch; T+1 corrections.</li> <li>Interface: file/API adapter (service TBD: <code>storo-reg-reporting</code>).</li> </ul>"},{"location":"20-specs/regulatory-reporting/#goaml-strctr","title":"goAML (STR/CTR)","text":"<ul> <li>Thresholds: cash/crypto limits per jurisdiction.</li> <li>Triggers: rules over events (riskScore, amounts, patterns).</li> <li>Payload: goAML XML/JSON forms; attachments redacted.</li> <li>Submission: secure API with retry/backoff and receipt tracking.</li> </ul>"},{"location":"20-specs/regulatory-reporting/#event-additions","title":"Event Additions","text":"<ul> <li>Optional fields:</li> <li><code>exchangeControlRef</code> (string)</li> <li><code>purposeCode</code> (string)</li> </ul>"},{"location":"20-specs/regulatory-reporting/#ops-audit","title":"Ops &amp; Audit","text":"<ul> <li>Immutable submission log with receipts and timestamps.</li> <li>DLQ for failed submissions; manual replay runbook.</li> </ul> <p>Last updated: 2025-08-27</p>"},{"location":"20-specs/risk-limits/","title":"Risk Limits &amp; KYC Tiers (ZA/ZW)","text":"<p>Defines tiered onboarding and runtime velocity controls aligned to FICA (ZA) and analogous ZW regimes.</p>"},{"location":"20-specs/risk-limits/#kyc-tiers","title":"KYC Tiers","text":"<ul> <li>Tier 0 (Minimal)</li> <li>Allowed: low-value transactions; no cross-border.</li> <li>Requirements: basic identity (name, mobile), phone verification.</li> <li> <p>Limits: daily/monthly caps; no PULL.</p> </li> <li> <p>Tier 1 (Standard)</p> </li> <li>Allowed: domestic transfers; moderate limits.</li> <li>Requirements: ID/passport, selfie/biometric, address proof.</li> <li> <p>Limits: higher daily/monthly; PULL optional.</p> </li> <li> <p>Tier 2 (Enhanced)</p> </li> <li>Allowed: cross-border, higher limits.</li> <li>Requirements: full KYC, income/proof of funds; enhanced due diligence.</li> <li>Limits: bespoke per-tenant.</li> </ul>"},{"location":"20-specs/risk-limits/#runtime-controls","title":"Runtime Controls","text":"<ul> <li>Velocity: txn count and value per window (1h/24h/30d) by <code>kycTier</code>.</li> <li>Corridor: per-rail and cross-border maxima, exchange-control flags.</li> <li>Risk score gates: deny or require review above thresholds.</li> </ul>"},{"location":"20-specs/risk-limits/#contract-additions","title":"Contract Additions","text":"<ul> <li>Event enrichment fields (optional):</li> <li><code>kycTier</code>: string (T0|T1|T2)</li> <li><code>riskScore</code>: number (0-100)</li> </ul>"},{"location":"20-specs/risk-limits/#enforcement-points","title":"Enforcement Points","text":"<ul> <li>CTS pre-submit policy check using cached tier and counters.</li> <li>Compliance <code>/screen</code> returns <code>score</code> consumed by CTS.</li> <li>Directory can convey per-rail caps.</li> </ul>"},{"location":"20-specs/risk-limits/#observability","title":"Observability","text":"<ul> <li>Metrics: policy blocks, window saturation, false-positive review rate.</li> <li>Alerts: anomaly in risk-score distribution.</li> </ul> <p>Last updated: 2025-08-27</p>"},{"location":"20-specs/tax-vat/","title":"Tax &amp; VAT (ZA/ZW)","text":"<p>Guidance on tax treatment for fees and surcharges in the Stalela ledger.</p>"},{"location":"20-specs/tax-vat/#vat-basics-za","title":"VAT Basics (ZA)","text":"<ul> <li>Standard rate: 15% (as of doc date).  </li> <li>Taxable supplies: Stalela service fees typically vatable; confirm per tenant.</li> <li>Invoicing: include VAT breakdown and tax codes per line.</li> </ul>"},{"location":"20-specs/tax-vat/#zimbabwe-considerations","title":"Zimbabwe Considerations","text":"<ul> <li>Local VAT/sales tax nuances to be configured per tenant/product; document rates.</li> </ul>"},{"location":"20-specs/tax-vat/#ledger-representation","title":"Ledger Representation","text":"<ul> <li>Fees split into net and VAT components at settlement time.</li> <li>Example (ZAR): amount 100.00; fee 2.00 excl VAT; VAT 0.30 (15%).</li> </ul> <pre><code>Dr USER 100.00\nCr MERCHANT 98.00\nCr FEES_NET 2.00\nCr FEES_VAT 0.30\n</code></pre> <p>Accounts may be configured under Revenue/Tax control accounts.</p>"},{"location":"20-specs/tax-vat/#eventmetadata","title":"Event/Metadata","text":"<ul> <li>Add <code>taxCode</code> (optional) in events referencing fee lines.</li> </ul>"},{"location":"20-specs/tax-vat/#observability","title":"Observability","text":"<ul> <li>Metrics: VAT accrued/day; reconciliation with invoices.</li> </ul> <p>Last updated: 2025-08-27</p>"},{"location":"30-diagrams/component-nucleus/","title":"Component: Nucleus","text":"<pre><code>flowchart LR\n  subgraph Client/Partners\n    A[Client Apps / Merchants / WhatsApp Bot]\n  end\n\n  subgraph Core[\"Stalela Nucleus\"]\n    direction LR\n\n    subgraph API[\"Canonical Transfer Service (API)\"]\n      CTS[POST /transfers&lt;br/&gt;GET /transfers/:id&lt;br/&gt;Idempotency]\n    end\n\n    subgraph GW[\"Rail Gateways\"]\n      ZG[Zimswitch Gateway]\n      OG[OPPWA Gateway]\n      UG[USDC/Algorand Gateway]\n    end\n\n    subgraph L[\"Ledger Service\"]\n      LJ[Journal &amp; Postings]\n      LB[Balances &amp; Statements]\n    end\n\n    subgraph C[\"Compliance Screening\"]\n      CS[Local Watchlist Index&lt;br/&gt;/screen]\n    end\n\n    subgraph D[\"Directory &amp; Routing\"]\n      DR[Institutions/BINs&lt;br/&gt;Fees &amp; Windows]\n    end\n\n    subgraph R[\"Reconciliation &amp; Returns\"]\n      RC[Statement Ingest&lt;br/&gt;Unmatched Queue]\n    end\n\n    subgraph B[\"Event Bus + Outbox\"]\n      EB[(Topics: transfers.*, ledger.*, recon.*)]\n    end\n\n    subgraph O[\"Operator Console\"]\n      OC[Ops UI&lt;br/&gt;Returns/Recon/Flags]\n    end\n\n    subgraph PL[\"Platform/Base\"]\n      AD[/ /live /ready /metrics /version /]\n      TM[Banking Time &amp; Holidays]\n      IDG[ID/Tracing &amp; Errors]\n    end\n  end\n\n  A --&gt;|create intent| CTS\n  CTS --&gt;|pre-screen| CS\n  CS --&gt;|allow/deny| CTS\n  CTS --&gt;|route| D\n  D --&gt; CTS\n  CTS --&gt;|submit| ZG\n  CTS --&gt;|submit| OG\n  CTS --&gt;|submit| UG\n\n  ZG --&gt; EB\n  OG --&gt; EB\n  UG --&gt; EB\n\n  EB --&gt; CTS\n  EB --&gt; L\n  EB --&gt; R\n  EB --&gt; O\n\n  L &lt;--&gt; R\n  R --&gt;|nightly ingest| EB\n\n  OC --- O\n  PL --- CTS\n  PL --- GW\n  PL --- L\n  PL --- C\n  PL --- D\n  PL --- R</code></pre>"},{"location":"30-diagrams/lifecycle-state/","title":"Transfer Lifecycle","text":"<pre><code>stateDiagram-v2\n  [*] --&gt; INITIATED\n  INITIATED --&gt; SUBMITTED: CTS submits.&lt;rail&gt;\n  SUBMITTED --&gt; ACCEPTED: rail reference received\n  ACCEPTED --&gt; SETTLED: funds final\n  ACCEPTED --&gt; RETURNED: return/chargeback code\n  SUBMITTED --&gt; FAILED: technical failure\n  SETTLED --&gt; [*]\n  RETURNED --&gt; [*]\n  FAILED --&gt; [*]</code></pre>"},{"location":"30-diagrams/recon-matching/","title":"Reconciliation Matching","text":"<pre><code>flowchart TD\n  ST[(Rail Statement Files / On-chain Events)]\n  NORM[Normalize to StatementLine]\n  MATCH{Match to\nTransfers?}\n  EMIT1[Emit transfers.settled]\n  EMIT2[Emit transfers.returned]\n  EXC[Open recon.exception]\n  OP[Operator Console]\n\n  ST --&gt; NORM --&gt; MATCH\n  MATCH --&gt;|Settlement| EMIT1\n  MATCH --&gt;|Return| EMIT2\n  MATCH --&gt;|No| EXC --&gt; OP</code></pre>"},{"location":"30-diagrams/sequence-bop-reporting/","title":"Sequence: BoP Reporting Pipeline","text":"<pre><code>sequenceDiagram\n  participant CTS\n  participant LED as Ledger\n  participant REG as Regulatory Reporting\n  participant AD as Authorized Dealer/SARB\n\n  CTS--&gt;&gt;REG: transfers.settled (subset)\n  LED--&gt;&gt;REG: postings/read (summary)\n  REG-&gt;&gt;REG: build BoP payload\n  REG-&gt;&gt;AD: submit BoP\n  AD--&gt;&gt;REG: receipt/ack\n  REG--&gt;&gt;CTS: reg.submission.acknowledged</code></pre>"},{"location":"30-diagrams/sequence-eft-batch/","title":"Sequence: EFT Batch","text":"<pre><code>sequenceDiagram\n  participant CTS\n  participant EFT as EFT Gateway\n  participant PARTNER as Bankserv Partner\n  participant R as Reconciliation\n\n  CTS-&gt;&gt;EFT: enqueue transfers\n  EFT-&gt;&gt;PARTNER: submit batch file\n  PARTNER--&gt;&gt;EFT: ack/reject\n  EFT--&gt;&gt;CTS: transfers.accepted (per line)\n  PARTNER--&gt;&gt;EFT: settlement/returns files\n  EFT--&gt;&gt;R: recon.statement.ingested\n  R--&gt;&gt;CTS: transfers.settled / transfers.returned</code></pre>"},{"location":"30-diagrams/sequence-return-oppwa/","title":"Sequence: Return (OPPWA)","text":"<pre><code>sequenceDiagram\n  participant CTS as Canonical Transfer Service\n  participant GW as OPPWA Gateway\n  participant OPP as OPPWA API\n  participant WH as Webhook Receiver\n  participant L as Ledger\n  participant OC as Operator Console\n\n  CTS-&gt;&gt;GW: transfers.submitted.oppwa (intent=AUTH)\n  GW-&gt;&gt;OPP: POST /payments (preauth)\n  OPP--&gt;&gt;GW: result {opRef, resultCode}\n  GW--&gt;&gt;CTS: transfers.accepted {opRef}\n\n  %% Later, dispute/return arrives\n  WH--&gt;&gt;GW: webhook {opRef, reasonCode, chargeback:true}\n  GW--&gt;&gt;CTS: transfers.returned {reasonCode}\n  CTS--&gt;&gt;L: transfers.returned\n  L--&gt;&gt;OC: ledger.posting.created (reversal)</code></pre>"},{"location":"30-diagrams/sequence-stk-ecocash/","title":"Sequence: EcoCash STK Prompt","text":"<pre><code>sequenceDiagram\n  participant CTS\n  participant GW as EcoCash GW\n  participant MNO as EcoCash\n  participant L as Ledger\n\n  CTS-&gt;&gt;GW: transfers.submitted.ecocash\n  GW-&gt;&gt;MNO: STK prompt\n  MNO--&gt;&gt;GW: accepted {opRef}\n  GW--&gt;&gt;CTS: transfers.accepted\n  MNO--&gt;&gt;GW: settled/return\n  GW--&gt;&gt;CTS: transfers.settled / transfers.returned\n  CTS--&gt;&gt;L: transfers.settled / transfers.returned</code></pre>"},{"location":"30-diagrams/sequence-submit-payshap/","title":"Sequence: Submit PayShap","text":"<pre><code>sequenceDiagram\n  participant Client\n  participant CTS as Canonical Transfer Service\n  participant DR as Directory\n  participant GW as PayShap Gateway\n  participant L as Ledger\n\n  Client-&gt;&gt;CTS: POST /transfers (proxy)\n  CTS-&gt;&gt;DR: resolve proxy\n  DR--&gt;&gt;CTS: account route\n  CTS-&gt;&gt;GW: transfers.submitted.payshap\n  GW--&gt;&gt;CTS: transfers.accepted\n  GW--&gt;&gt;CTS: transfers.settled\n  CTS--&gt;&gt;L: transfers.settled\n  L--&gt;&gt;CTS: ledger.posting.created</code></pre>"},{"location":"30-diagrams/sequence-submit-usdc/","title":"Sequence: Submit USDC","text":"<pre><code>sequenceDiagram\n  participant Client\n  participant CTS as Canonical Transfer Service\n  participant CS as Compliance\n  participant DR as Directory\n  participant GW as USDC/Algorand Gateway\n  participant L as Ledger\n\n  Client-&gt;&gt;CTS: POST /transfers (idempotency-key)\n  CTS-&gt;&gt;CTS: dedupe &amp; normalize\n  CTS-&gt;&gt;CS: POST /screen (payer, payee)\n  CS--&gt;&gt;CTS: allow\n  CTS-&gt;&gt;DR: GET /routes?rail=usdc-algo\n  DR--&gt;&gt;CTS: { endpoint, fees, window }\n  CTS-&gt;&gt;GW: transfers.submitted.usdc\n  GW--&gt;&gt;CTS: transfers.accepted {txId}\n  GW--&gt;&gt;CTS: transfers.settled {txId, round}\n  CTS--&gt;&gt;L: transfers.settled\n  L--&gt;&gt;CTS: ledger.posting.created</code></pre>"},{"location":"30-integration/merchant-identity/","title":"Merchant Identity Mapping","text":"<p>This page documents how merchant identity is established and mapped across the two pillars of the Stalela Platform.</p>"},{"location":"30-integration/merchant-identity/#identity-models","title":"Identity Models","text":"<p>Each pillar defines its own identity hierarchy optimized for its domain:</p>"},{"location":"30-integration/merchant-identity/#payments-nucleus","title":"Payments Nucleus","text":"<pre><code>tenantId (top-level account \u2014 maps to a business entity)\n</code></pre> <p>The Payments Nucleus is flat by design. All CTS operations, GL Ledger postings, and compliance screenings are scoped by <code>tenantId</code>. There is no concept of outlet, terminal, or cashier at the payment layer.</p>"},{"location":"30-integration/merchant-identity/#fiscal-platform","title":"Fiscal Platform","text":"<pre><code>merchant_tin (taxpayer identification number \u2014 maps to a business entity)\n  \u2514\u2500\u2500 outlet_id (physical location \u2014 fiscal numbering is per-outlet)\n        \u251c\u2500\u2500 pos_terminal_id (device identifier)\n        \u2514\u2500\u2500 cashier_id (operator identity)\n</code></pre> <p>The Fiscal Platform requires outlet-level granularity because fiscal regulations in most jurisdictions mandate sequential numbering per outlet and per-cashier audit trails.</p>"},{"location":"30-integration/merchant-identity/#binding-table","title":"Binding Table","text":"Payments Nucleus Fiscal Platform Created During Notes <code>tenantId</code> <code>merchant_tin</code> Merchant onboarding 1:1 binding. Stored in a shared identity registry. \u2014 <code>outlet_id</code> Outlet registration Payments doesn't need this but it can be passed as <code>metadata.outlet_id</code> on transfers. \u2014 <code>pos_terminal_id</code> Terminal provisioning Irrelevant to Payments. \u2014 <code>cashier_id</code> Staff management Irrelevant to Payments."},{"location":"30-integration/merchant-identity/#onboarding-flow","title":"Onboarding Flow","text":"<pre><code>sequenceDiagram\n    participant Admin as Platform Admin\n    participant REG as Identity Registry\n    participant PAY as Payments Nucleus\n    participant FIS as Fiscal Platform\n\n    Admin-&gt;&gt;REG: Register merchant (business_name, nif, ...)\n    REG-&gt;&gt;PAY: Create tenant (tenantId = \"tn_55\")\n    REG-&gt;&gt;FIS: Create merchant (merchant_tin = \"NIF-123456\")\n    REG-&gt;&gt;REG: Store binding (tn_55 \u2194 NIF-123456)\n    REG--&gt;&gt;Admin: Merchant created \u2014 tenantId + merchant_tin\n\n    Admin-&gt;&gt;FIS: Add outlet (outlet_id = \"OUT-KIN-01\")\n    Admin-&gt;&gt;FIS: Add terminal (pos_terminal_id = \"TERM-001\")\n    Admin-&gt;&gt;FIS: Add cashier (cashier_id = \"cashier-jean\")</code></pre>"},{"location":"30-integration/merchant-identity/#api-key-scoping","title":"API Key Scoping","text":"<p>A single API key (Bearer token) encodes both identities:</p> <pre><code>{\n  \"sub\": \"tn_55\",\n  \"merchant_tin\": \"NIF-123456\",\n  \"outlets\": [\"OUT-KIN-01\", \"OUT-KIN-02\"],\n  \"roles\": [\"merchant_admin\"],\n  \"iat\": 1750000000,\n  \"exp\": 1750003600\n}\n</code></pre> <ul> <li>Payments Nucleus reads <code>sub</code> (= <code>tenantId</code>) to scope all operations.</li> <li>Fiscal Platform reads <code>merchant_tin</code> and <code>outlets</code> to scope fiscal operations.</li> <li>A POS terminal's token may include an additional <code>terminal_id</code> claim to narrow the fiscal scope to a single terminal.</li> </ul>"},{"location":"30-integration/merchant-identity/#resolution-at-runtime","title":"Resolution at Runtime","text":"<p>When a POS client creates an invoice and then initiates a payment:</p> <ol> <li>The Fiscal Platform validates <code>merchant_tin</code> + <code>outlet_id</code> from the token.</li> <li>The POS client calls <code>POST /transfers</code> on CTS. The token's <code>sub</code> claim provides <code>tenantId</code>.</li> <li>The POS client sets <code>endUserRef</code> = <code>fiscal_number</code> and optionally <code>metadata.outlet_id</code> = <code>OUT-KIN-01</code>.</li> <li>Neither service queries the other's identity store. The shared identity registry is consulted only during onboarding and token issuance.</li> </ol>"},{"location":"30-integration/overview/","title":"Integration Layer","text":"<p>The Payments Nucleus and Fiscal Platform are decoupled by design. They share no databases, no synchronous RPC calls, and no transactional boundaries. This section documents the narrow, well-defined touchpoints where the two pillars interact.</p>"},{"location":"30-integration/overview/#decoupling-philosophy","title":"Decoupling Philosophy","text":"<pre><code>flowchart LR\n    subgraph \"Fiscal Platform\"\n        INV[\"Invoice API\"]\n        FL[\"Fiscal Ledger\"]\n    end\n\n    subgraph \"Payments Nucleus\"\n        CTS[\"Canonical Transfer Service\"]\n        GL[\"GL Ledger\"]\n    end\n\n    INV -.-&gt;|\"endUserRef = fiscal_number\\n(async, client-initiated)\"| CTS\n    CTS -.-&gt;|\"transfer.settled event\\n(Event Bus)\"| INV\n\n    style INV fill:#2d2d2d,stroke:#3FFF00\n    style CTS fill:#2d2d2d,stroke:#3FFF00</code></pre> <p>Key principles:</p> <ol> <li>No shared state. The Fiscal Ledger and GL Ledger are separate data stores with different semantics (hash-chained audit trail vs. double-entry accounting).</li> <li>Client-initiated linking. The POS or API client decides when to request payment after fiscal sealing. The Fiscal Platform never calls the CTS directly.</li> <li>Async event correlation. When a transfer settles, the CTS emits <code>transfer.settled</code> on the Event Bus. An optional listener on the Fiscal Platform side can update the invoice's payment status.</li> <li>Opaque references. The CTS treats <code>endUserRef</code> as opaque metadata \u2014 it never queries the Fiscal Ledger. The Fiscal Platform treats CTS <code>transferId</code> the same way.</li> </ol>"},{"location":"30-integration/overview/#integration-pages","title":"Integration Pages","text":"Page Description Payment on Invoice How the <code>payments</code> array on an invoice relates to actual money movement through CTS Merchant Identity How <code>tenantId</code> (Payments) maps to <code>merchant_tin</code> + <code>outlet_id</code> (Fiscal) End-to-End: Invoice \u2192 Pay Full Mermaid sequence diagram showing the POS cashier flow from sale to settlement"},{"location":"30-integration/overview/#when-to-use-which-api","title":"When to Use Which API","text":"I want to\u2026 Call\u2026 Pillar Create a sealed invoice <code>POST /api/v1/invoices</code> Fiscal Platform Collect payment for an invoice <code>POST /transfers</code> Payments Nucleus Check if an invoice has been paid <code>GET /api/v1/invoices/{id}</code> \u2192 <code>payment_status</code> Fiscal Platform (updated by event listener) Check transfer settlement status <code>GET /transfers/{id}</code> Payments Nucleus Reconcile payments against invoices Custom reconciliation logic using <code>endUserRef</code> Client / integration layer"},{"location":"30-integration/payment-on-invoice/","title":"Payment on Invoice","text":"<p>This page clarifies the relationship between the <code>payments</code> array inside a Canonical Invoice and actual money movement through the Canonical Transfer Service (CTS).</p>"},{"location":"30-integration/payment-on-invoice/#two-separate-concerns","title":"Two Separate Concerns","text":"Concern Owner Record What was sold and how the customer intends to pay Fiscal Platform <code>payments</code> array in the Canonical Invoice Actual money movement Payments Nucleus <code>CanonicalTransfer</code> with settlement lifecycle <p>The <code>payments</code> array on an invoice is a declaration of payment method, not proof of settlement. A sealed invoice might declare <code>\"method\": \"mobile_money\"</code> before the CTS has initiated the STK Push.</p>"},{"location":"30-integration/payment-on-invoice/#payment-status-lifecycle","title":"Payment Status Lifecycle","text":"<pre><code>stateDiagram-v2\n    [*] --&gt; declared: Invoice sealed with payment method\n    declared --&gt; pending: CTS transfer initiated\n    pending --&gt; paid: transfer.settled event received\n    pending --&gt; failed: transfer.failed event received\n    failed --&gt; pending: Retry / new transfer\n    declared --&gt; paid: Cash (no CTS involvement)</code></pre> Status Meaning <code>declared</code> Invoice records the intended payment method. No CTS transfer exists yet. <code>pending</code> A CTS transfer has been created with <code>endUserRef</code> = <code>fiscal_number</code>. Awaiting rail settlement. <code>paid</code> CTS emitted <code>transfer.settled</code>. Invoice payment status updated via Event Bus listener. <code>failed</code> CTS emitted <code>transfer.failed</code>. Cashier may retry or switch payment method."},{"location":"30-integration/payment-on-invoice/#cash-payments","title":"Cash Payments","text":"<p>For cash payments, there is no CTS involvement. The Fiscal Platform records <code>\"method\": \"cash\"</code> and the payment status is immediately <code>paid</code> \u2014 the cashier confirms they received physical currency.</p>"},{"location":"30-integration/payment-on-invoice/#split-payments","title":"Split Payments","text":"<p>Merchants routinely accept split payments (e.g., half cash, half mobile money). This DRC example shows CDF:</p> <pre><code>\"payments\": [\n  { \"method\": \"cash\", \"amount\": \"67500\", \"currency\": \"CDF\", \"status\": \"paid\" },\n  { \"method\": \"mobile_money\", \"provider\": \"airtel_money\", \"amount\": \"67500\", \"currency\": \"CDF\", \"status\": \"pending\" }\n]\n</code></pre> <p>Each non-cash payment entry may correspond to a separate CTS transfer. The POS client manages this orchestration \u2014 the Fiscal Platform does not initiate transfers.</p>"},{"location":"30-integration/payment-on-invoice/#linking-mechanism","title":"Linking Mechanism","text":"<p>The cross-reference between an invoice and a transfer uses two opaque fields:</p> Field Location Value <code>endUserRef</code> On the CTS <code>CanonicalTransfer</code> Set to the <code>fiscal_number</code> of the invoice <code>transfer_id</code> On the invoice's <code>payments[].transfer_id</code> Set to the CTS <code>transferId</code> after initiation <p>Neither system queries the other's database. The POS client holds both identifiers and writes them to the appropriate payload.</p>"},{"location":"30-integration/payment-on-invoice/#event-bus-listener-optional","title":"Event Bus Listener (Optional)","text":"<p>An optional microservice listens on the Event Bus for <code>transfer.settled</code> and <code>transfer.failed</code> events, matches by <code>endUserRef</code>, and updates the invoice's <code>payments[].status</code>:</p> <pre><code>sequenceDiagram\n    participant CTS as CTS\n    participant EB as Event Bus\n    participant LIS as Payment Status Listener\n    participant FP as Fiscal Platform API\n\n    CTS-&gt;&gt;EB: transfer.settled (endUserRef = \"001-2026-004821\")\n    EB-&gt;&gt;LIS: Deliver event\n    LIS-&gt;&gt;FP: PATCH /api/v1/invoices/001-2026-004821/payment-status\n    FP--&gt;&gt;LIS: 200 OK</code></pre> <p>This listener is a convenience \u2014 not a trust boundary component. If it is unavailable, the POS client can update payment status directly via the Fiscal Platform API.</p>"},{"location":"30-integration/sequence-invoice-then-pay/","title":"End-to-End: Invoice \u2192 Pay","text":"<p>This page shows the complete sequence from a POS cashier creating an invoice to the customer completing mobile money payment. It is the most common cross-pillar interaction.</p>"},{"location":"30-integration/sequence-invoice-then-pay/#scenario","title":"Scenario","text":"<p>DRC Example</p> <p>This worked example uses a DRC (<code>CD</code>) jurisdiction scenario. The same flow applies to any supported jurisdiction \u2014 only the tax groups, currency, and authority sync protocol change.</p> <p>A cashier at Outlet Kinshasa Gombe sells 3 bags of cement to Ets Kabila for 135,000 CDF. The customer pays half in cash and half via Airtel Money.</p>"},{"location":"30-integration/sequence-invoice-then-pay/#sequence-diagram","title":"Sequence Diagram","text":"<pre><code>sequenceDiagram\n    actor Cashier\n    participant POS as POS (PWA)\n    participant FIS as Fiscal Platform API\n    participant TAX as Tax Engine\n    participant CSS as Cloud Signing Service (HSM)\n    participant FL as Fiscal Ledger\n    participant CTS as Canonical Transfer Service\n    participant DIR as Directory / Rail Selector\n    participant GW as Rail Gateway (Airtel MoMo)\n    participant TELCO as Airtel Money API\n    participant EB as Event Bus\n    participant GL as GL Ledger\n\n    Note over Cashier,POS: 1. Build invoice\n\n    Cashier-&gt;&gt;POS: Add items: 3\u00d7 Ciment Portland @ 45,000 CDF\n    POS-&gt;&gt;POS: Auto-classify: TG01 (TVA 16%)\n    POS-&gt;&gt;POS: Calculate totals: HT=135,000 / TVA=21,600 / TTC=156,600\n    Cashier-&gt;&gt;POS: Select payments: Cash 78,300 + Airtel Money 78,300\n    Cashier-&gt;&gt;POS: Enter client: Ets Kabila (NIF-789012)\n\n    Note over POS,FL: 2. Seal invoice (Fiscal Platform)\n\n    POS-&gt;&gt;FIS: POST /api/v1/invoices (canonical payload)\n    FIS-&gt;&gt;TAX: Validate tax groups + totals\n    TAX--&gt;&gt;FIS: Valid\n    FIS-&gt;&gt;CSS: Sign payload\n    CSS--&gt;&gt;FIS: fiscal_number, signature, auth_code, QR, timestamp\n    FIS-&gt;&gt;FL: Append sealed invoice (hash-chained)\n    FIS--&gt;&gt;POS: 201 Created \u2014 fiscal_number: \"001-2026-004821\"\n\n    Note over POS,GL: 3. Initiate payment (Payments Nucleus)\n\n    POS-&gt;&gt;CTS: POST /transfers\n    Note right of POS: intent: PUSH, amount: 78300 CDF&lt;br/&gt;payer: Ets Kabila (Airtel)&lt;br/&gt;payee: Merchant settlement account&lt;br/&gt;endUserRef: \"001-2026-004821\"&lt;br/&gt;railHints: [\"airtel_momo\"]\n\n    CTS-&gt;&gt;DIR: Route transfer\n    DIR--&gt;&gt;CTS: Selected rail: airtel_momo (score: 0.92)\n    CTS-&gt;&gt;GW: Submit payment\n    GW-&gt;&gt;TELCO: STK Push to +243 812 345 678\n    TELCO--&gt;&gt;GW: Pending (STK sent)\n    GW--&gt;&gt;CTS: SUBMITTED\n\n    Note over Cashier,TELCO: 4. Customer approves\n\n    TELCO-&gt;&gt;TELCO: Customer enters PIN on phone\n    TELCO--&gt;&gt;GW: Payment confirmed\n    GW--&gt;&gt;CTS: SETTLED\n\n    Note over CTS,GL: 5. Post-settlement\n\n    CTS-&gt;&gt;GL: Debit payer / Credit merchant (double-entry)\n    CTS-&gt;&gt;EB: Publish transfer.settled (endUserRef: \"001-2026-004821\")\n\n    Note over EB,FIS: 6. Update invoice payment status (optional listener)\n\n    EB-&gt;&gt;FIS: transfer.settled (endUserRef: \"001-2026-004821\")\n    FIS-&gt;&gt;FIS: PATCH payments[1].status = \"paid\"\n\n    Note over Cashier,POS: 7. Complete\n\n    POS-&gt;&gt;Cashier: \u2705 Invoice sealed + payment confirmed\n    POS-&gt;&gt;Cashier: Print/share receipt (PDF with QR)</code></pre>"},{"location":"30-integration/sequence-invoice-then-pay/#timing","title":"Timing","text":"Step Typical latency Notes Build invoice (client-side) N/A Depends on cashier speed Seal invoice (Fiscal Platform) &lt; 1 s HSM signing + ledger append Route + submit to rail &lt; 500 ms Smart Rail Selector + gateway call STK Push delivery 2\u201310 s Depends on telco network Customer PIN entry 5\u201360 s Human interaction Settlement confirmation &lt; 2 s Rail callback Payment status update &lt; 1 s Event Bus listener Total (seal \u2192 paid) ~10\u201375 s Dominated by customer PIN entry"},{"location":"30-integration/sequence-invoice-then-pay/#failure-scenarios","title":"Failure Scenarios","text":"Failure Handling HSM signing fails POS shows error. Invoice is not sealed. No fiscal number assigned. Cashier retries. CTS route fails POS shows \"Payment service unavailable\". Invoice is already sealed \u2014 cashier can accept cash instead and update payment method. STK Push timeout CTS retries once. If still no response, marks transfer as <code>FAILED</code>. POS prompts cashier to retry or switch to cash. Customer declines TELCO returns decline \u2192 CTS marks <code>FAILED</code>. POS prompts for alternative payment. Event Bus listener down Invoice stays in <code>pending</code> payment status. POS client can poll CTS directly and update payment status via Fiscal Platform API."},{"location":"30-integration/sequence-invoice-then-pay/#key-invariants","title":"Key Invariants","text":"<ol> <li>The invoice is always sealed before payment is initiated. The fiscal number exists regardless of whether payment succeeds.</li> <li>Cash payments skip the CTS entirely. The <code>payments</code> array records <code>\"method\": \"cash\", \"status\": \"paid\"</code> immediately.</li> <li>The Fiscal Platform never calls the CTS. The POS client initiates both requests.</li> <li><code>endUserRef</code> is the only cross-reference. Neither system queries the other's data store.</li> </ol>"},{"location":"40-jurisdictions/","title":"Jurisdictions","text":"<p>The Stalela Fiscal Platform is country-configurable. Every piece of country-specific logic \u2014 tax groups, client classifications, invoice types, currencies, languages, regulatory frameworks, and tax authority sync protocols \u2014 is encapsulated in a jurisdiction profile identified by an ISO 3166-1 alpha-2 country code.</p>"},{"location":"40-jurisdictions/#what-a-jurisdiction-defines","title":"What a Jurisdiction Defines","text":"<p>Each jurisdiction profile specifies:</p> Layer What's Configured Example (DRC \u2014 <code>CD</code>) Tax Groups The set of tax group codes, names, default rates, and decision trees TG01\u2013TG14 (14 groups, rates from 0% to 30%) Client Classifications Buyer categories that drive tax behavior individual, company, commercial_individual, professional, embassy Invoice Types Permitted invoice document types sale, advance, credit_note, export, export_credit Currencies Default and accepted currencies, rounding rules CDF (primary), USD (secondary), half-up to 0.01 Tax Authority Name, sync protocol, endpoint, authentication method DGI \u2014 MCF/e-MCF protocol Regulatory Framework Legal mandates, compliance deadlines, certifications Arr\u00eat\u00e9s 032/033/034, Arr\u00eat\u00e9 016/2025, SFE Specifications v1.0 Languages Supported UI/NLP languages French, Lingala, Swahili, Tshiluba Fiscal ID Format The country's taxpayer identification number format NIF (Num\u00e9ro d'Identification Fiscale)"},{"location":"40-jurisdictions/#how-jurisdiction-flows-through-the-platform","title":"How Jurisdiction Flows Through the Platform","text":"<pre><code>flowchart TD\n    JP[\"Jurisdiction Profile (e.g., CD)\"] --&gt; TE[\"Tax Engine\\n(loads tax groups from profile)\"]\n    JP --&gt; CC[\"Client Classification\\n(loads categories from profile)\"]\n    JP --&gt; IT[\"Invoice Type Validator\\n(loads permitted types)\"]\n    JP --&gt; CURR[\"Currency Module\\n(default currency, rounding rules)\"]\n    JP --&gt; SA[\"Tax Authority Sync Agent\\n(protocol + endpoint from profile)\"]\n    JP --&gt; NLP[\"NL Invoice Parser\\n(language model selection)\"]\n    JP --&gt; DASH[\"Dashboard\\n(currency display, language, tax labels)\"]\n\n    TE --&gt; CSS[\"Cloud Signing Service (HSM)\"]\n    CC --&gt; CSS\n    IT --&gt; CSS\n    SA --&gt; AUTH[\"Tax Authority\\n(DGI, KRA, RRA, TRA, ...)\"]</code></pre> <p>The <code>jurisdiction</code> field travels with every canonical invoice. The Tax Engine, Client Classification validator, and Invoice Type validator all load their rules from the jurisdiction profile before processing an invoice.</p>"},{"location":"40-jurisdictions/#canonical-invoice-jurisdiction-field","title":"Canonical Invoice \u2014 Jurisdiction Field","text":"<p>Every canonical invoice includes a top-level <code>jurisdiction</code> field:</p> <pre><code>{\n  \"jurisdiction\": \"CD\",\n  \"merchant_tin\": \"NIF-123456\",\n  \"outlet_id\": \"outlet-001\",\n  ...\n}\n</code></pre> <p>The <code>jurisdiction</code> code determines which tax group manifest, client classifications, invoice types, and rounding rules apply. See Canonical Payloads for the full schema.</p>"},{"location":"40-jurisdictions/#supported-jurisdictions","title":"Supported Jurisdictions","text":"Code Country Tax Authority Status Profile <code>CD</code> DR Congo DGI (Direction G\u00e9n\u00e9rale des Imp\u00f4ts) Active \u2014 reference implementation DRC Profile \u2192 <code>ZW</code> Zimbabwe ZIMRA (Zimbabwe Revenue Authority) Planned Zimbabwe \u2192 <code>KE</code> Kenya KRA (Kenya Revenue Authority) Planned Kenya \u2192 <code>RW</code> Rwanda RRA (Rwanda Revenue Authority) Planned Rwanda \u2192 <code>TZ</code> Tanzania TRA (Tanzania Revenue Authority) Planned Tanzania \u2192 <code>NG</code> Nigeria FIRS (Federal Inland Revenue Service) Planned Nigeria \u2192 <code>ZA</code> South Africa SARS (South African Revenue Service) Planned South Africa \u2192"},{"location":"40-jurisdictions/#adding-a-new-jurisdiction","title":"Adding a New Jurisdiction","text":"<p>To add support for a new country:</p> <ol> <li>Create a folder at <code>40-jurisdictions/{country_code}/</code> using the Country Profile Template.</li> <li>Define the tax group manifest \u2014 codes, names, rates, and a decision tree.</li> <li>Define client classifications \u2014 buyer categories and their tax behavior.</li> <li>Define invoice types \u2014 permitted document types with labels in the local language.</li> <li>Document the currency model \u2014 default currency, secondary currencies, rounding rules.</li> <li>Document the tax authority integration \u2014 protocol, endpoints, authentication, sync pipeline.</li> <li>Document the regulatory framework \u2014 laws, mandates, compliance deadlines.</li> <li>Register the jurisdiction in the <code>mkdocs.yml</code> navigation and the table above.</li> <li>Map the fiscal ID format \u2014 what the country calls its taxpayer identification number and how it maps to <code>merchant_tin</code>.</li> </ol> <p>Each jurisdiction is self-contained. The core Fiscal Platform engine (tax engine, signing service, ledger, sync agent) remains unchanged \u2014 only the configuration varies.</p>"},{"location":"40-jurisdictions/country-profile-template/","title":"Country Profile Template","text":"<p>Use this template when adding a new jurisdiction to the Stalela Fiscal Platform. Copy this folder structure to <code>40-jurisdictions/{country_code}/</code> and fill in each section.</p>"},{"location":"40-jurisdictions/country-profile-template/#folder-structure","title":"Folder Structure","text":"<pre><code>40-jurisdictions/{country_code}/\n\u251c\u2500\u2500 index.md                  # Country overview\n\u251c\u2500\u2500 tax-groups.md             # Tax group manifest (codes, rates, decision tree)\n\u251c\u2500\u2500 client-classifications.md # Buyer categories and tax behavior\n\u251c\u2500\u2500 invoice-types.md          # Permitted invoice types\n\u251c\u2500\u2500 currencies.md             # Currency model and rounding rules\n\u251c\u2500\u2500 authority-integration.md  # Tax authority sync protocol\n\u2514\u2500\u2500 regulatory/               # Country-specific legal framework\n    \u251c\u2500\u2500 legal-framework.md    # Regulatory overview\n    \u2514\u2500\u2500 ...                   # Additional regulatory documents\n</code></pre>"},{"location":"40-jurisdictions/country-profile-template/#indexmd-template","title":"index.md Template","text":"<pre><code># {Country Name} ({ISO Code})\n\n| Field | Value |\n|---|---|\n| **ISO 3166-1 alpha-2** | `{XX}` |\n| **Tax Authority** | {Authority Name} ({Abbreviation}) |\n| **Primary Currency** | {CUR} ({Currency Name}) |\n| **Secondary Currency** | {CUR2} (if applicable) |\n| **Fiscal ID Name** | {Local term} \u2192 maps to `merchant_tin` |\n| **Languages** | {List of supported languages} |\n| **Fiscal Mandate** | {Name of the invoicing mandate or law} |\n| **Status** | Planned / In Progress / Active |\n\n## Overview\n\n{Brief description of the country's fiscal compliance requirements and how Stalela addresses them.}\n\n## Key Sections\n\n| Page | Contents |\n|---|---|\n| [Tax Groups](tax-groups.md) | {N} tax group codes, rates, and decision tree |\n| [Client Classifications](client-classifications.md) | Buyer categories and tax behavior |\n| [Invoice Types](invoice-types.md) | Permitted fiscal document types |\n| [Currencies](currencies.md) | Currency model and rounding rules |\n| [Authority Integration](authority-integration.md) | {Authority} sync protocol |\n| [Regulatory](regulatory/legal-framework.md) | Legal framework and compliance deadlines |\n</code></pre>"},{"location":"40-jurisdictions/country-profile-template/#checklist","title":"Checklist","text":"<ul> <li>[ ] Country overview (<code>index.md</code>) with all metadata fields</li> <li>[ ] Tax group manifest with codes, names, rates, and decision tree</li> <li>[ ] Client classifications with tax behavior effects</li> <li>[ ] Invoice types with local-language labels</li> <li>[ ] Currency model with rounding rules</li> <li>[ ] Tax authority integration (protocol, endpoints, authentication)</li> <li>[ ] Regulatory framework (laws, deadlines, certification requirements)</li> <li>[ ] Navigation entry added to <code>mkdocs.yml</code></li> <li>[ ] Supported Jurisdictions table updated in <code>40-jurisdictions/index.md</code></li> </ul>"},{"location":"40-jurisdictions/cd/","title":"DR Congo (CD)","text":"Field Value ISO 3166-1 alpha-2 <code>CD</code> Tax Authority DGI (Direction G\u00e9n\u00e9rale des Imp\u00f4ts) Primary Currency CDF (Congolese Franc) Secondary Currency USD (United States Dollar) Fiscal ID Name NIF (Num\u00e9ro d'Identification Fiscale) \u2192 maps to <code>merchant_tin</code> Languages French (primary), Lingala, Swahili, Tshiluba Fiscal Mandate Facture Normalis\u00e9e (Standardized Invoice) Status Active \u2014 reference implementation"},{"location":"40-jurisdictions/cd/#overview","title":"Overview","text":"<p>The Democratic Republic of Congo mandates that every VAT-registered merchant issue standardized invoices (Facture Normalis\u00e9e) through an approved billing system. The DGI (Direction G\u00e9n\u00e9rale des Imp\u00f4ts) enforces a layered compliance chain: SFE \u2192 DEF \u2192 MCF/e-MCF \u2192 DGI, with 14 tax groups, five invoice types, and mandatory security elements on every fiscal document.</p> <p>Stalela's Fiscal Platform implements DRC compliance as its first jurisdiction profile. In Phase 1, the Cloud Signing Service (HSM) acts as the trusted fiscal authority. In Phase 3, an optional USB Fiscal Memory device (DEF) can serve as the local trust anchor for merchants requiring hardware homologation.</p>"},{"location":"40-jurisdictions/cd/#key-sections","title":"Key Sections","text":"Page Contents Tax Groups 14 DGI tax groups (TG01\u2013TG14) with rates and decision tree Client Classifications 5 DRC-mandated buyer categories Invoice Types 5 DRC invoice document types Currencies CDF/USD dual currency model and rounding rules Authority Integration DGI MCF/e-MCF sync protocol Regulatory DRC legal framework, arr\u00eat\u00e9s, and SFE specifications"},{"location":"40-jurisdictions/cd/#drc-specific-terminology-mapping","title":"DRC-Specific Terminology Mapping","text":"DRC Term Stalela Generic Term Notes NIF (Num\u00e9ro d'Identification Fiscale) <code>merchant_tin</code> Unique taxpayer ID assigned by DGI DGI (Direction G\u00e9n\u00e9rale des Imp\u00f4ts) Tax Authority Central tax enforcement agency Facture Normalis\u00e9e Sealed Invoice Legally compliant fiscal document DEF (Dispositif \u00c9lectronique Fiscal) Fiscal Memory Device USB hardware trust anchor (Phase 3) SFE (Syst\u00e8me de Facturation d'Entreprise) Enterprise Billing System DGI certification standard MCF / e-MCF Tax Authority Sync Protocol Data upload protocol to DGI Comit\u00e9 de Suivi Governance Committee Oversight body for the reform"},{"location":"40-jurisdictions/cd/#compliance-phases","title":"Compliance Phases","text":"Phase Scope DRC Compliance Approach Phase 1 Software Invoicing Cloud HSM generates all security elements. Meets SFE requirements via software. Phase 2 POS &amp; Retail POS terminals connect as API consumers. Cloud remains fiscal authority. Phase 3 USB Hardware (DEF) Optional USB device signs invoices locally. Full hardware homologation path. Phase 4 Enterprise ERP integrations built on the established fiscal platform."},{"location":"40-jurisdictions/cd/authority-integration/","title":"DRC Tax Authority Integration \u2014 DGI (MCF / e-MCF)","text":"<p>Jurisdiction: DR Congo (<code>CD</code>) Tax Authority: DGI (Direction G\u00e9n\u00e9rale des Imp\u00f4ts) Sync Protocol: MCF / e-MCF control modules Spike Reference: <code>spec/infrastructure-dgi-integration-1.md</code></p>"},{"location":"40-jurisdictions/cd/authority-integration/#overview","title":"Overview","text":"<p>The DGI enforces a layered chain for fiscal compliance in the DRC. In Stalela's Phase 1 (Software Invoicing), the Cloud Signing Service (HSM) acts as the trusted fiscal authority \u2014 it assigns sequential fiscal numbers, signs invoices, generates timestamps and QR codes, and stores everything in the Fiscal Ledger. The Tax Authority Sync Agent then uploads sealed invoices to the DGI MCF/e-MCF control modules for central verification and tax surveillance.</p> <pre><code>flowchart LR\n  Client[\"Client Apps\\n(API / Dashboard / SDK)\"] --&gt;|canonical payload| Cloud[\"Stalela Cloud\\n(Cloud Signing Service)\"]\n  Cloud --&gt;|sealed invoice + security elements| Ledger[\"Fiscal Ledger\"]\n  Cloud --&gt;|sealed invoice + metadata| MCF[\"DGI MCF / e-MCF\\ncontrol modules\"]\n  MCF --&gt;|acknowledgement| Cloud\n  MCF --&gt;|delivery stream| DGI[\"DGI Backend\\n(central tax authority)\"]</code></pre> <p>This diagram emphasizes that the Cloud Signing Service generates the security elements (fiscal number, auth code, timestamp, QR) \u2014 it does not merely relay them. The Sync Agent handles the upstream delivery to the DGI.</p> <p>Phase 3 \u2014 USB Hardware</p> <p>In Phase 3, the USB Fiscal Memory device (DEF) can serve as the trusted signer for merchants needing DEF homologation. The Sync Agent still uploads sealed invoices from the DEF through the cloud to the DGI using the same pipeline.</p>"},{"location":"40-jurisdictions/cd/authority-integration/#known-constraints-and-responsibilities","title":"Known Constraints and Responsibilities","text":"<ul> <li>In Phase 1, the Cloud Signing Service (HSM) produces the sequential fiscal number, authentication code, trusted timestamp, and QR payload that make an invoice legally valid. In Phase 3, the DEF can assume this role.</li> <li>Every submission to the DGI control modules must include the sealed canonical payload plus identifiers (<code>fiscal_authority_id</code>, <code>outlet_id</code>, <code>merchant_tin</code>, <code>cashier_id</code> / <code>api_key_id</code>) so that the DGI can link the invoice to its originating outlet.</li> <li>Offline client issuance is permitted via the Fiscal Extension (Phase 1.5), which seals invoices locally using a Delegated Credential. The Cloud then verifies and reconciles these locally-sealed invoices before uploading them to the DGI. Purely unsigned drafts are not legally valid receipts.</li> <li>The DGI control modules enforce immutability, continuous compliance, and real-time VAT surveillance (per Arr\u00eat\u00e9 033), meaning the Cloud must log every sync attempt, failure, and acknowledgement.</li> <li>Stalela Cloud is also responsible for merchant/outlet registry tasks: storing activation codes, monitoring outlet health, and surfacing failure alerts to operators.</li> </ul>"},{"location":"40-jurisdictions/cd/authority-integration/#dgi-sync-pipeline","title":"DGI Sync Pipeline","text":"<p>The Tax Authority Sync Agent runs as a background service within the Stalela Cloud:</p> <ol> <li>Poll the Fiscal Ledger for newly sealed invoices not yet acknowledged by DGI.</li> <li>Format the DGI submission with the required security elements and identifiers.</li> <li>Upload to the MCF/e-MCF endpoint via authenticated HTTPS.</li> <li>Record the acknowledgement (or failure) in the Fiscal Ledger and update the invoice's <code>authority_sync_status</code>.</li> <li>Retry with exponential backoff on transient failures; escalate to <code>FAILED</code> after max retries.</li> <li>Surface dashboards and alerts for operators when uploads are pending or failing.</li> </ol>"},{"location":"40-jurisdictions/cd/authority-integration/#unknowns-tracked-as-blockers","title":"Unknowns (Tracked as Blockers)","text":"MCF/e-MCF API surface still unpublished <p>The research spike confirmed that the DGI has not released the endpoint URLs, transport protocol, or schema definitions for the control modules. Until those are published we cannot code the HTTP client or test payload validation.</p> Authentication method for the control modules is undefined <p>We do not know whether the control modules require a DGI-issued certificate, bearer token, signed JWT, or another credential, nor how key rotation or revocation is handled.</p> Offline behavior and retry rules are unspecified <p>The legislation insists every invoice must be reported, but the precise grace period, retry intervals, or thresholds that trigger manual intervention are unknown, so the sync engine must remain configurable until the DGI clarifies.</p>"},{"location":"40-jurisdictions/cd/authority-integration/#references","title":"References","text":"<ul> <li><code>spec/infrastructure-dgi-integration-1.md</code> \u2014 Full spike with known facts and open questions</li> <li>DRC Legal Framework \u2014 Arr\u00eat\u00e9 summaries and compliance timeline</li> <li>DRC SFE Specifications \u2014 Technical billing requirements</li> <li>Tax Authority Sync Agent \u2014 Generic sync agent pattern</li> </ul>"},{"location":"40-jurisdictions/cd/client-classifications/","title":"DRC Client Classifications","text":"<p>Jurisdiction: DR Congo (<code>CD</code>) Authority: DGI (Direction G\u00e9n\u00e9rale des Imp\u00f4ts) Source: SFE Specifications v1.0</p>"},{"location":"40-jurisdictions/cd/client-classifications/#classification-table","title":"Classification Table","text":"<p>The DRC mandates five buyer categories on every fiscal invoice. The classification drives the first branches of the tax group decision tree and populates <code>client.classification</code> in the canonical invoice payload.</p> Classification Code Description Tax Behavior Individual <code>individual</code> Private person (natural person) Default to TG02/TG03 or TG04 if the catalog marks the line as an essential good. Company <code>company</code> Registered corporation (legal entity with RCCM) Use any tax group; TG02/TG03 are defaults. Commercial Individual <code>commercial_individual</code> Sole trader (patente holder) Same as company but carries proprietor ID. Professional <code>professional</code> Licensed professionals (lawyers, doctors, accountants) Services default to TG03; specify TG04 when the Ministry authorizes the reduced regime. Embassy <code>embassy</code> Diplomatic mission or international organization Always TG01 (Exempt) unless DGI issues a <code>tax_override_reason</code>."},{"location":"40-jurisdictions/cd/client-classifications/#validation-rules","title":"Validation Rules","text":"<ol> <li>Classification is required \u2014 every DRC invoice must include <code>client.classification</code>. The Cloud Signing Service rejects invoices without it.</li> <li>Embassy \u2192 TG01 \u2014 if classification is <code>embassy</code>, the tax engine must force TG01 on all line items unless an explicit <code>tax_override_reason</code> is provided by DGI.</li> <li>NIF requirement \u2014 <code>company</code> and <code>commercial_individual</code> clients must provide their NIF in <code>client.tin</code>. Individual clients may omit it for transactions below the DGI threshold.</li> <li>RCCM for companies \u2014 the <code>client.registration_number</code> field should carry the RCCM number for registered corporations.</li> </ol>"},{"location":"40-jurisdictions/cd/client-classifications/#mapping-to-generic-platform","title":"Mapping to Generic Platform","text":"DRC Field Generic Stalela Field Notes <code>client.classification</code> <code>client.classification</code> Enum values are jurisdiction-specific <code>client.nif</code> <code>client.tin</code> Taxpayer ID of the buyer <code>client.rccm</code> <code>client.registration_number</code> Business registration"},{"location":"40-jurisdictions/cd/currencies/","title":"DRC Currency Model","text":"<p>Jurisdiction: DR Congo (<code>CD</code>) Primary Currency: CDF (Congolese Franc) Secondary Currency: USD (United States Dollar)</p>"},{"location":"40-jurisdictions/cd/currencies/#dual-currency","title":"Dual Currency","text":"<p>DRC businesses routinely price and transact in both CDF and USD. The Stalela Fiscal Platform supports this out of the box for the <code>CD</code> jurisdiction:</p> Aspect CDF USD ISO 4217 code <code>CDF</code> <code>USD</code> Default for invoices Yes \u2014 used when no currency is specified Supported \u2014 must be explicitly set Tax calculation currency Always CDF \u2014 tax amounts are computed and reported in CDF Line items priced in USD are converted to CDF for tax calculation Exchange rate \u2014 DGI-published daily rate or merchant-declared rate with <code>fx_rate</code> field"},{"location":"40-jurisdictions/cd/currencies/#rounding-rules","title":"Rounding Rules","text":"Rule Value Minimum unit 0.01 CDF (centime) Rounding method Half-up (round 0.005 \u2192 0.01) Where applied Per line-item tax amount, before summing into <code>tax_summary</code> Rounding adjustment field <code>tax_rounding_adjustment</code> \u2014 captures any delta between sum-of-lines and recalculated total"},{"location":"40-jurisdictions/cd/currencies/#invoice-examples","title":"Invoice Examples","text":"<pre><code>// CDF-denominated invoice\n{\n  \"jurisdiction\": \"CD\",\n  \"totals\": {\n    \"subtotal\": \"50000.00\",\n    \"tax\": \"8000.00\",\n    \"total\": \"58000.00\"\n  },\n  \"payments\": [\n    { \"method\": \"mobile_money\", \"provider\": \"airtel_money\", \"amount\": \"58000.00\", \"currency\": \"CDF\" }\n  ]\n}\n\n// USD-denominated invoice (tax calculated in CDF equivalent)\n{\n  \"jurisdiction\": \"CD\",\n  \"totals\": {\n    \"subtotal\": \"20.00\",\n    \"tax\": \"3.20\",\n    \"total\": \"23.20\",\n    \"currency\": \"USD\",\n    \"tax_currency\": \"CDF\",\n    \"tax_in_reporting_currency\": \"9043.20\",\n    \"fx_rate\": \"2826.00\"\n  },\n  \"payments\": [\n    { \"method\": \"cash\", \"amount\": \"23.20\", \"currency\": \"USD\" }\n  ]\n}\n</code></pre>"},{"location":"40-jurisdictions/cd/currencies/#mobile-money-providers-drc","title":"Mobile Money Providers (DRC)","text":"Provider Rail Gateway Invoice Instrument Code Currency Airtel Money <code>rail-gateway-airtel-momo</code> <code>airtel_money</code> CDF MTN MoMo <code>rail-gateway-mtn-momo</code> <code>mtn_momo</code> CDF M-Pesa (Vodacom) <code>rail-gateway-mpesa</code> (planned) <code>mpesa</code> CDF Orange Money <code>rail-gateway-orange</code> (planned) <code>orange_money</code> CDF"},{"location":"40-jurisdictions/cd/invoice-types/","title":"DRC Invoice Types","text":"<p>Jurisdiction: DR Congo (<code>CD</code>) Authority: DGI (Direction G\u00e9n\u00e9rale des Imp\u00f4ts) Source: SFE Specifications v1.0</p>"},{"location":"40-jurisdictions/cd/invoice-types/#permitted-invoice-types","title":"Permitted Invoice Types","text":"<p>The DRC SFE specification mandates five invoice types. Each type flows through the same canonical lifecycle (PREPARE \u2192 COMMIT \u2192 SEAL) documented in the Invoice Lifecycle page.</p> Invoice Type Code French Label Purpose Sale Invoice <code>sale</code> Facture de vente Everyday retail/wholesale sales \u2014 the default workflow. Advance Invoice <code>advance</code> Facture d'avance Payments received before goods/services are fulfilled. Credit Note <code>credit_note</code> Note de cr\u00e9dit Correction for returned goods or billing adjustments; treated as a new fiscal event referencing the original invoice. Export Invoice <code>export</code> Facture d'exportation Sales destined outside the DRC; routes the invoice to TG07 (Export Zero Rate). Export Credit Note <code>export_credit</code> Note de cr\u00e9dit d'exportation Refund tied to an export transaction, sequenced independently like all refunds."},{"location":"40-jurisdictions/cd/invoice-types/#validation-rules","title":"Validation Rules","text":"<ol> <li>Type is required \u2014 every DRC invoice must include <code>invoice_type</code>. The Tax Engine uses it to validate tax group selection (e.g., <code>export</code> \u2192 TG07).</li> <li>Credit notes reference originals \u2014 <code>credit_note</code> and <code>export_credit</code> invoices must include <code>original_fiscal_number</code> linking to the invoice being corrected.</li> <li>Export proof \u2014 <code>export</code> and <code>export_credit</code> invoices should carry <code>export_certificate_ref</code> metadata for DGI verification.</li> <li>No deletion \u2014 corrections are always new fiscal events. The original invoice remains immutable in the Fiscal Ledger.</li> </ol>"},{"location":"40-jurisdictions/cd/tax-groups/","title":"DRC Tax Groups (TG01\u2013TG14)","text":"<p>Jurisdiction: DR Congo (<code>CD</code>) Authority: DGI (Direction G\u00e9n\u00e9rale des Imp\u00f4ts) Manifest source: DGI SFE Specifications v1.0 Canonical spec: <code>spec/schema-tax-engine-1.md</code></p>"},{"location":"40-jurisdictions/cd/tax-groups/#tax-group-matrix","title":"Tax Group Matrix","text":"Code Name Default Rate Typical Usage TG01 Exempt 0% Embassies, diplomatic transfers, NGOs TG02 Standard VAT \u2014 Goods 16% Domestic merchandise TG03 Standard VAT \u2014 Services 16% Professional and intangible services TG04 Reduced VAT 9% Essential food, medicine, medical devices TG05 Public Financing VAT 16% State-sponsored programs or subsidies TG06 Customs VAT 16% Import deliveries billed in CDF TG07 Export Zero Rate 0% Export invoices, cross-border services TG08 Special Regime \u2014 Agriculture 5% Agriculture supply chain participants TG09 Special Regime \u2014 Mining 10% Mining operators with an active license TG10 Specific Tax \u2014 Fuel 25% Gasoline, diesel, aviation fuel TG11 Specific Tax \u2014 Tobacco 30% Cigarettes, cigars, tobacco sheets TG12 Specific Tax \u2014 Alcohol 20% Distilled spirits, beer, wine TG13 Specific Tax \u2014 Telecommunications 15% Mobile voice, data, SMS bundles TG14 Specific Tax \u2014 Digital Services 12% SaaS, streaming, digital ads consumed in DRC <p>The manifest version must travel with every invoice via <code>tax_group_manifest_version</code> so that audits can map totals to the rate set that was active at issuance.</p>"},{"location":"40-jurisdictions/cd/tax-groups/#decision-tree-which-tax-group-applies","title":"Decision Tree \u2014 Which Tax Group Applies?","text":"<pre><code>flowchart TD\n    Start[\"Start: classify the transaction\"] --&gt; Embassy{\"Is the client an embassy\\nor diplomatic mission?\"}\n    Embassy -- Yes --&gt; TG1[\"TG01: Exempt\"]\n    Embassy -- No --&gt; Export{\"Is the item exported\\nor consumed outside DRC?\"}\n    Export -- Yes --&gt; TG7[\"TG07: Export Zero Rate\"]\n    Export -- No --&gt; Special{\"Does the catalog mark the item\\nas special regime or excise?\"}\n    Special --&gt; |Fuel| TG10[\"TG10: Specific Tax \u2014 Fuel\"]\n    Special --&gt; |Tobacco| TG11[\"TG11: Specific Tax \u2014 Tobacco\"]\n    Special --&gt; |Alcohol| TG12[\"TG12: Specific Tax \u2014 Alcohol\"]\n    Special --&gt; |Telecom| TG13[\"TG13: Specific Tax \u2014 Telecommunications\"]\n    Special --&gt; |Digital| TG14[\"TG14: Specific Tax \u2014 Digital Services\"]\n    Special --&gt; |Agriculture| TG8[\"TG08: Special Regime \u2014 Agriculture\"]\n    Special --&gt; |Mining| TG9[\"TG09: Special Regime \u2014 Mining\"]\n    Special --&gt; |Public| TG5[\"TG05: Public Financing VAT\"]\n    Special --&gt; |Customs| TG6[\"TG06: Customs VAT\"]\n    Special --&gt; |None| Kind{\"Is the good tangible\\nor a service?\"}\n    Kind --&gt; |Goods| TG2[\"TG02: Standard VAT \u2014 Goods\"]\n    Kind --&gt; |Service| TG3[\"TG03: Standard VAT \u2014 Services\"]\n    Kind --&gt; |Reduced| TG4[\"TG04: Reduced VAT\"]</code></pre> <p>This flowchart should be embedded into the product catalog taxonomy. At each branch, the catalog metadata must flag the appropriate tax group so that the invoicing platform never guesses a code. The <code>special</code> branch also checks for catalogue flags such as <code>is_excise</code>, <code>use_customs_rate</code>, or <code>special_regime_code</code>.</p>"},{"location":"40-jurisdictions/cd/tax-groups/#worked-examples","title":"Worked Examples","text":"Example Item Client Classification Tax Group Base (CDF) Rate Tax (CDF) Notes 1 Solar panels sold to a retailer company TG02 100,000 16% 16,000 Standard domestic goods. 2 Galenic medicine sold to a clinic company TG04 150,000 9% 13,500 Reduced regime (<code>is_essential</code> flag). 3 Digital consultancy to customer in Brussels company TG07 200,000 0% 0 Export zero-rate."},{"location":"40-jurisdictions/cd/tax-groups/#implementation-guidance","title":"Implementation Guidance","text":"<ol> <li>Reference <code>spec/schema-tax-engine-1.md</code> for the authoritative TG## definitions and canonical schema fields before adding a new tax group code.</li> <li>Drive the taxonomy (export vs. local, special regime, excise) through catalog metadata and client classification.</li> <li>When the Cloud Signing Service returns the sealed fiscal response, persist <code>tax_summary</code> so you can regenerate Z/X/A reports that align with the manifest version.</li> <li>Update <code>tax_group_manifest_version</code> whenever DGI publishes a new rate or adds a group; the spec file mirrors the latest manifest and should be the source of truth.</li> </ol>"},{"location":"40-jurisdictions/cd/regulatory/arretes/","title":"DRC fiscal arr\u00eat\u00e9s that govern Stalela","text":"<p>Stalela lives inside the tightly regulated world of the Facture Normalis\u00e9e mandate. Four ministerial orders work together: - Arr\u00eat\u00e9 032/2023 defines the governance and committee that approves architecture, vendors, and timelines. - Arr\u00eat\u00e9 033/2023 lays down the operational requirements for every invoice and device, enforcing the trust boundary that the governance committee supervises. - Arr\u00eat\u00e9 034/2023 regulates who may commercialize devices and software, so the governance committee can evaluate those suppliers. - Arr\u00eat\u00e9 016/2025 patches the commercialization regime defined in 034 while keeping the operational and governance foundations intact.</p> <p>Each tab below distills one arr\u00eat\u00e9 with the latest implications for Stalela. Cross-links point to related orders so reviewers see how governance, operational rules, commercialization, and amendments intersect.</p> <p>Phased compliance</p> <p>Stalela addresses these regulations in phases: Phase 1 (Software Invoicing) uses the Cloud Signing Service (HSM) as the trusted fiscal authority. Phase 3 introduces the USB Fiscal Memory device (DEF) for merchants requiring hardware homologation. The regulatory obligations remain constant across phases \u2014 only the trusted signer changes.</p> Arr\u00eat\u00e9 032 \u2014 Governance"},{"location":"40-jurisdictions/cd/regulatory/arretes/#arrete-032","title":"Arr\u00eat\u00e9 n\u00b0032/2023 \u2014 Governance of the reform","text":"<p>Arr\u00eat\u00e9 032 does not touch invoices directly; it creates the Comit\u00e9 de Suivi with a Steering Committee, Technical Committee, and Technical Secretariat that oversee every design, budget, and deployment decision. It authorizes external technical providers, controls procurement, and appoints the bodies that approve the operational framework in Arr\u00eat\u00e9 033 and the commercialization rules in Arr\u00eat\u00e9 034.</p> <p>Key responsibilities - Validate the project charter, architecture, and vendor selections. - House the Technical Committee that drafts specifications, including the Stalela architecture. - Command the Technical Secretariat to document all decisions and preserve institutional memory. - Manage political relationships with the DGI, DGDA, and other ministries so that operational changes (e.g., new invoices, reports, or compliance hooks) can roll out in harmony with the enforcement path defined in Arr\u00eat\u00e9 033.</p> <p>Stalela implications - Every new architecture document (specs, ADRs, APIs) must be up for review by this committee, so keep changelogs and summaries ready. - Vendor certification requests and pricing disclosures ultimately flow to the same governance body that owns the rules in Arr\u00eat\u00e9 034. - The Technical Committee can change specs without new legislation; the documentation process must stay flexible to respond to rapid directives.</p> Arr\u00eat\u00e9 033 \u2014 Operational rules"},{"location":"40-jurisdictions/cd/regulatory/arretes/#arrete-033","title":"Arr\u00eat\u00e9 n\u00b0033/2023 \u2014 Operationalizing the standardized invoice","text":"<p>This is the core operational law. It forces every VAT-registered merchant to issue a standardized invoice through an approved system, insists on physical DEFs or e-UF/e-MCF fallback pathways, and moves compliance from periodic reporting to continuous, always-on discipline.</p> <p>Highlights - Every transaction must return a sealed invoice with DEF-generated security elements; no invoice equals non-compliance, even offline. - Two parallel enforcement paths: physical USB/DEF devices (UF + MCF) or controlled cloud/electronic systems, both required to keep fallback hardware handy. - Vendors must certify devices, provide maintenance, and keep audited change logs\u2014feeding back into the governance structure in Arr\u00eat\u00e9 032. - Device lifecycles are strictly controlled: activation, deactivation, and failure reporting happen under DGI supervision. - Financial incentives (50% hardware tax credit) accelerate adoption while tightening penalties for misuse.</p> <p>Cross-references - The governance in Arr\u00eat\u00e9 032 approves the technical architecture that this operational order enforces. - The supplier certification pipeline in Arr\u00eat\u00e9 034 makes sure only homologated technology appears in this mandate. - Arr\u00eat\u00e9 016/2025 (see below) softens supplier scarcity but leaves the obligation to fiscalize every sale unchanged.</p> <p>Stalela implications - In Phase 1, the Cloud Signing Service (HSM) fulfills the DEF role via software. In Phase 3, the USB device provides hardware-level compliance. - Offline-first behavior is a legal requirement \u2014 not a convenience \u2014 so client applications must queue unsigned drafts and submit them once the cloud is reachable. - Outlet registration, activation, and failure reporting need automation so DGI inspectors see the same data the law demands.</p> Arr\u00eat\u00e9 034 \u2014 Commercialization and market design"},{"location":"40-jurisdictions/cd/regulatory/arretes/#arrete-034","title":"Arr\u00eat\u00e9 n\u00b0034/2023 \u2014 Licensing fiscal sellers","text":"<p>Arr\u00eat\u00e9 034 regulates who can sell DEF hardware and SFE software. It institutes a four-role model (DEF, SFE, suppliers, distributors), a multi-stage approval pipeline (agr\u00e9ment \u2192 homologation \u2192 authorization), strict distributor obligations, and price visibility to keep the market traceable. The first version even limited suppliers to three, creating regional monopolies (later relaxed by Arr\u00eat\u00e9 016/2025).</p> <p>Key rules - Suppliers must prove technical, financial, and logistical readiness, maintain 24-month manufacturer partnerships, and undergo homologation every time they change their product. - Distributors install, train, and support \u2014 users cannot self-install, ensuring traceability. - The tax authority monitors stock, spare parts, pricing, and reporting; any deviation can trigger withdrawal. - SFE providers must guarantee immutability, security, and archival retention, aligning with the reporting expectations from Arr\u00eat\u00e9 033.</p> <p>Stalela implications - Homologation planning is critical: almost any firmware or configuration change needs declaration or re-certification. - Distributor relationships matter; Stalela needs trusted partners to cover installation, training, and maintenance. - Pricing changes are visible to DGI, so every offer must include a pre-approved price list. - The governance body in Arr\u00eat\u00e9 032 uses these commercialization metrics to approve vendors, so keep documentation ready.</p> Arr\u00eat\u00e9 016/2025 \u2014 Amendment to Arr\u00eat\u00e9 034"},{"location":"40-jurisdictions/cd/regulatory/arretes/#arrete-016-2025","title":"Arr\u00eat\u00e9 n\u00b0016/2025 \u2014 Scaling amendment","text":"<p>This amendment keeps the commercialization controls of Arr\u00eat\u00e9 034 but fixes key bottlenecks: it removes the three-supplier ceiling, limits approvals to two-year renewable terms, clarifies minor update handling, and tightens distributor accountability while leaving mandatory fiscalization intact.</p> <p>What changed - Unlimited suppliers (while retaining technical, financial, and coverage thresholds) so the market can scale without artificial scarcity. - Supplier approvals now expire after two years, introducing planned renewal activities for Stalela. - Minor software changes can be declared instead of undergoing full re-homologation, reducing friction for SFE iterations noted in Arr\u00eat\u00e9 033. - Distributor obligations now explicitly cover user onboarding, training, and fair territorial coverage with price discipline still enforced. - Enterprises may seek conditional exemptions, acknowledging complex ERP/SFE deployments while keeping governance oversight from Arr\u00eat\u00e9 032.</p> <p>Stalela implications - The path to certification is more realistic, but the two-year cadence demands an approval lifecycle plan. - Minor updates no longer require major re-certification, so the documentation strategy should categorize changes as \"minor\" vs. \"material\" and declare them appropriately. - Pricing discipline and distributor accountability remain high-priority constraints, so contractual language must reference this order alongside Arr\u00eat\u00e9 034. - The amendment is an explicit acknowledgement that the same operational rules in Arr\u00eat\u00e9 033 still apply even as the commercialization regime adapts.</p>"},{"location":"40-jurisdictions/cd/regulatory/legal-framework/","title":"DRC Fiscal Compliance Legal Framework","text":"<p>The Democratic Republic of Congo layers multiple ministerial orders and technical specifications to move every transaction through a trusted fiscal control stack. Stalela must navigate that stack: the governance machine that approves strategy, the operational rules that ban deleted invoices, the commercialization controls that limit who may sell hardware, the amendments easing scaling, and the SFE technical specification that defines what every compliant billing system must emit.</p>"},{"location":"40-jurisdictions/cd/regulatory/legal-framework/#regulatory-hierarchy","title":"Regulatory hierarchy","text":"<pre><code>flowchart TB\n    A[\"Arr\u00eat\u00e9 032/2023&lt;br/&gt;Governance Committee\"]\n    B[\"Arr\u00eat\u00e9 033/2023&lt;br/&gt;Standardized Invoice &amp; DEF Rules\"]\n    C[\"Arr\u00eat\u00e9 034/2023&lt;br/&gt;Commercialization &amp; Licensing\"]\n    D[\"Arr\u00eat\u00e9 016/2025&lt;br/&gt;Scaling Discipline &amp; Updates\"]\n    E[\"SFE Specifications v1.0&lt;br/&gt;Technical Billing Requirements\"]\n    A --&gt; B\n    A --&gt; C\n    B --&gt; E\n    C --&gt; E\n    D --&gt; C\n    D --&gt; E\n    C -.-&gt; D</code></pre>"},{"location":"40-jurisdictions/cd/regulatory/legal-framework/#document-summaries","title":"Document summaries","text":"Document Scope Stalela impact Arr\u00eat\u00e9 032/2023 Creates the Comit\u00e9 de Suivi with Steering Committee, Technical Committee, and Secretariat that own governance, procurement, and documentation for the standardized invoicing reform. Stay aligned with the committees, treat governance decisions as authoritative, keep documentation up to date, and position Stalela as a staffed technical partner rather than a pure vendor. Arr\u00eat\u00e9 033/2023 Defines the mandatory issuance of standardized invoices, the dual (physical DEF + e-DEF) enforcement paths, device/fallback requirements, and the operational discipline every VAT-registered merchant must maintain. Design Stalela so every sale is a fiscal event, support offline-first issuance with trusted security elements, include fallback hardware (USB device per outlet), and make error reporting realtime; expect inspectors everywhere. Arr\u00eat\u00e9 034/2023 Regulates who may commercialize DEF and SFE products through pre-qualification, homologation, and distribution pipelines, with certified suppliers, distributors, and price transparency obligations. Plan for a regulated sales channel: seek homologation, partner with distributors for installation/support, disclose pricing, and maintain spare parts / stock for at least three years. Arr\u00eat\u00e9 016/2025 Adjusts commercialization rules by removing supply caps, adding two-year approval windows, clarifying which updates require re-homologation, and reinforcing distributor accountability. Treat regulatory approvals as renewable (every two years), declare minor IMS updates instead of full re-cert, honor consistent pricing, and ensure distributors can cover training/support/territory responsibilities. SFE Specifications v1.0 DGI technical requirements for certified enterprise billing systems: layered SFE \u2192 DEF \u2192 MCF \u2192 DGI architecture plus 14 tax groups, five invoice types, mandatory security elements, reports, offline behavior, and immutable storage. Embed all five invoice types, implement every tax group/client classification, enforce security element generation in the hardware layer, produce Z/X/A/audit outputs, and respect immutability/offline expectations before any cloud sync."},{"location":"40-jurisdictions/cd/regulatory/legal-framework/#adoption-timeline","title":"Adoption timeline","text":"Date Regulation Milestone 2023-10-23 Arr\u00eat\u00e9 032/033/034 Governance body formed, standardized invoice rules enforced, and commercialization controls put in place; merchants had a three-month compliance window (extendable two months) and must keep approved hardware active. 2025-02-27 Arr\u00eat\u00e9 016/2025 Supplier cap removed, approval validity capped at two years, minor software updates declarable, pricing discipline strengthened, and distributor obligations clarified to improve throughput. 2023 (DGI) SFE Specifications v1.0 Living technical reference for every billing system to integrate with DEF/MCF, enforce 14 tax groups, 5 invoice types, security elements, and mandated reports; treat as evergreen until superseded."},{"location":"40-jurisdictions/cd/regulatory/legal-framework/#key-compliance-deadlines-expectations","title":"Key compliance deadlines &amp; expectations","text":"<ul> <li>Rapid compliance window (Arr\u00eat\u00e9 033): VAT-registered merchants had three months (plus two-month extension) to transition to approved invoicing systems. Stalela\u2019s rollout must be fast because regulators expect no gaps.</li> <li>Approval cadence (Arr\u00eat\u00e9 034 &amp; 016/2025): Pre-qualification and homologation reviews each take up to 30 working days; major modifications trigger re-homologation, while minor updates require declarations. Plan firmware/system changes with these gating periods in mind.</li> <li>Renewal rhythm (Arr\u00eat\u00e9 016/2025): Every homologated DEF/SFE approval lasts two years, so renewal processes must be resourced and scheduled before expiry.</li> <li>Distribution commitments (Arr\u00eat\u00e9 034 &amp; 016/2025): Maintain 60-day replenishment pledges, three-year spare-part guarantees, consistent pricing disclosures, and accountable distributors covering onboarding and after-sales.</li> <li>Technical observability (SFE spec): Archives must retain invoices for at least one year, report outputs (Z/X/A/audit) must be generated locally, and every invoice must carry sequential fiscal number, device ID, signature, timestamp, and QR code before syncing; offline issuance remains normal operation.</li> <li>Fallback &amp; resilience (Arr\u00eat\u00e9 033): Hardware failure is not an excuse\u2014fallback systems must stay powered; replacement devices and offline queues must be ready immediately whenever connectivity or device issues occur.</li> </ul>"},{"location":"40-jurisdictions/cd/regulatory/legal-framework/#phased-compliance-strategy","title":"Phased compliance strategy","text":"Phase Scope Compliance approach Phase 1 \u2014 Software Invoicing API-first invoicing platform with Cloud Signing Service (HSM) Cloud HSM generates all security elements. Meets SFE requirements via software. Manual DGI submissions until MCF/e-MCF API is published. Phase 2 \u2014 POS &amp; Retail POS SDK, multi-terminal, mobile money POS terminals connect as API consumers. Cloud remains fiscal authority. Phase 3 \u2014 USB Hardware USB Fiscal Memory device (DEF) for DEF homologation Optional USB device signs invoices locally. Cloud syncs sealed data to DGI. Full hardware homologation path. Phase 4 \u2014 Enterprise ERP connectors, fleet management, analytics Enterprise integrations built on the established fiscal platform."},{"location":"40-jurisdictions/cd/regulatory/legal-framework/#implications-for-stalela","title":"Implications for Stalela","text":"<ol> <li>Governance alignment: Treat the Steering and Technical Committees as the ultimate arbiters \u2014 submit architecture and compliance reports, engage politically, and log every decision for the Secretariat.</li> <li>Operational discipline: The invoicing platform and Cloud Signing Service must enforce the layered mandate (SFE \u2192 trusted signer \u2192 MCF \u2192 DGI) with the append-only Fiscal Ledger, security elements, and per-outlet serialized numbering.</li> <li>Commercial readiness: Homologation, distributor partnerships, pricing disclosures, spare parts, and two-year renewal plans are as critical as software delivery.</li> <li>Technical completeness: Support all 14 tax groups, five invoice types, offline-first behavior, and mandated reports before reaching DGI; treat the SFE spec as a living contract even as regulatory details (e.g., QR payloads) evolve.</li> </ol>"},{"location":"40-jurisdictions/cd/regulatory/sfe-specs/","title":"SFE Specifications (v1)","text":"<p>This page distills the DGI Syst\u00e8me de Facturation d'Entreprise (SFE) requirements so the Stalela design team can trace every regulatory demand to our architecture, fiscal flows, and hardware guarantees.</p> <p>The official summary calls out the layered deployment (SFE \u2192 DEF \u2192 MCF/e-MCF \u2192 DGI), mandates five invoice types, demands all 14 tax groups, requires Z/X/A/audit reporting, and insists security elements come from the trusted fiscal layer\u2014not the POS. These constraints steer the content on the fiscal engine, hardware, and reports pages.</p> <p>Trust boundary reminder</p> <p>In Phase 1, the Cloud Signing Service (HSM) is the trusted component that generates fiscal numbers, authentication codes, trusted timestamps, and QR codes. In Phase 3, the USB Fiscal Memory device (DEF) can assume this role for merchants needing hardware homologation. In both phases, client applications (API consumers, dashboard, SDK) must treat security elements as sealed outputs. See Architecture Trust Boundary for details.</p>"},{"location":"40-jurisdictions/cd/regulatory/sfe-specs/#mandatory-invoice-types","title":"Mandatory Invoice Types","text":"Invoice Type French Label Purpose Sale invoice Facture de vente Everyday retail/wholesale sales; the default workflow in <code>design/docs/fiscal/invoice-lifecycle.md</code>. Advance invoice Facture d'avance Payments received before goods/services are fulfilled; still requires PREPARE \u2192 COMMIT. Credit note Note de cr\u00e9dit Correction for returned goods or billing adjustments; treated as a new fiscal event. Export invoice Facture d'exportation Sales destined outside the DRC; destines the invoice to TG07 (Export Zero Rate). Export credit note Note de cr\u00e9dit d'exportation Refund tied to an export transaction, sequenced independently like all refunds. <p>Each type is implemented by the same canonical flow documented in the Invoice Lifecycle page: client submits the canonical payload to the Cloud Signing Service, receives the sealed response with security elements, and delivers the receipt.</p>"},{"location":"40-jurisdictions/cd/regulatory/sfe-specs/#14-dgi-tax-groups","title":"14 DGI Tax Groups","text":"Code Name Rate Notes TG01 Exempt 0% Diplomats, embassies, NGOs, government transfers. TG02 Standard VAT \u2014 Goods 16% Default for tangible goods. TG03 Standard VAT \u2014 Services 16% Professional and intangible services. TG04 Reduced VAT 9% Essential foodstuffs and medicines flagged in catalog metadata. TG05 Public Financing VAT 16% Publicly funded programs; requires funding source metadata. TG06 Customs VAT 16% Imported goods (CIF basis) in addition to duties. TG07 Export Zero Rate 0% Goods/services consumed outside the DRC; requires export certificate. TG08 Special Regime \u2014 Agriculture 5% Agribusiness items registered under the agricultural regime. TG09 Special Regime \u2014 Mining 10% Mining sector goods/services with operator license metadata. TG10 Specific Tax \u2014 Fuel 25% Excise on gasoline, diesel, aviation fuel. TG11 Specific Tax \u2014 Tobacco 30% Applies to cigarettes, cigars, and tobacco preparations. TG12 Specific Tax \u2014 Alcohol 20% Spirits, beer, wine sold for domestic consumption. TG13 Specific Tax \u2014 Telecommunications 15% Mobile/data/SMS packages; include telecom operator ID. TG14 Specific Tax \u2014 Digital Services 12% Streaming, SaaS, online advertising delivered to DRC clients. <p>These codes feed the canonical <code>tax_groups</code> manifest described in <code>spec/schema-tax-engine-1.md</code> (project root) and are enforced by the Tax Engine. Each invoice must carry a <code>tax_summary</code> entry per group, and the Fiscal Ledger uses these to drive the Z/X/A reports.</p>"},{"location":"40-jurisdictions/cd/regulatory/sfe-specs/#required-reports","title":"Required Reports","text":"Report Purpose Trigger Z Report Daily closure with totals per tax group, fiscal number range, and ledger hash. End-of-day or manual closure; cloud-initiated. X Report Periodic/session snapshot with counts, totals by payment method, and platform health. Configurable (hourly/shift) for operators or auditors. A Report Article-level detail, enumerating every line item with tax group, client classification, and invoice reference. On-demand for audits or DGI requests. Audit Export Full append-only journal (sales, voids, refunds, resets) sent in chunks for deep reconciliation. Scheduled (monthly/annual) or upon DGI request. <p>Report design lives in <code>design/docs/fiscal/reports.md</code>. The Z/X/A outputs are produced by the Report Generator from the Fiscal Ledger's hash-chained entries and counters.</p>"},{"location":"40-jurisdictions/cd/regulatory/sfe-specs/#security-elements","title":"Security Elements","text":"Element Phase 1: Generated by Phase 3: Generated by Where referenced Sequential fiscal number Cloud Signing Service (Monotonic Counter Manager) USB Fiscal Memory device Printed on every receipt; enforced by the per-outlet counter. Fiscal authority ID Cloud Signing Service (HSM cluster ID) USB Fiscal Memory device (DEF NID) Identifies the trusted signer in every response and sync payload. Authentication code Cloud HSM (ECDSA signature) DEF Secure Element (ECDSA) Cryptographic proof stored in the Fiscal Ledger. Trusted timestamp Cloud infrastructure (NTP-synced) DEF RTC Anchor for chronological integrity; the Sync Agent uses it for ordering. QR code Cloud Signing Service (encoded fiscal number + auth code + timestamp) DEF (same encoding) Exposed to inspectors and customers; verified by DGI and internal tools. <p>In Phase 1, every element comes from the Cloud Signing Service. In Phase 3, the DEF generates them locally. Client applications may only display these values \u2014 see Security Elements for per-element verification rules.</p>"},{"location":"40-jurisdictions/cd/regulatory/sfe-specs/#offline-behavior-dgi-integration","title":"Offline Behavior &amp; DGI Integration","text":"<p>The specification emphasizes that offline operation is normal. In Phase 1, client applications queue unsigned draft payloads locally (IndexedDB / SQLite) when the cloud is unreachable. Once connectivity returns, the drafts are submitted to the Cloud Signing Service for sealing. The Sync Agent then uploads sealed invoices to the MCF/e-MCF control modules. A dedicated sync state machine ensures retries, grace periods, and conflict resolution:</p> <ul> <li><code>design/docs/cloud/offline-sync.md</code> documents how drafts transition from <code>QUEUED</code> to <code>SEALED</code> (via the Cloud Signing Service) and how sealed invoices are uploaded to the tax authority.</li> <li>Authority integration captures the known vs unknown pieces of the MCF/e-MCF API and highlights the remaining blockers for homologation.</li> </ul> <p>This layered behavior mirrors the core architecture: canonical payloads flow from client applications to the Cloud Signing Service (or DEF in Phase 3), then sealed invoices flow through the Sync Agent to the DGI control modules.</p>"},{"location":"40-jurisdictions/cd/regulatory/sfe-specs/#data-integrity-immutability-and-mutations","title":"Data Integrity, Immutability, and Mutations","text":"<p>The SFE must never delete invoices. Corrections are credit notes, voids are new fiscal events, and all entries remain in the append-only Fiscal Ledger. These expectations appear in the Invoice Lifecycle narrative and the Architecture Context Map (<code>memory-bank/context-map.md</code> in the project root). Any mutation references the original invoice and is submitted as a new canonical payload to the Cloud Signing Service (or DEF in Phase 3), ensuring auditability.</p> <p>This page is part of the regulatory view of the MkDocs site. For additional context, consult the DRC Legal Framework overview and the Arr\u00eat\u00e9 Summaries tabs.</p>"},{"location":"40-jurisdictions/ke/","title":"Kenya (KE)","text":"Field Value ISO 3166-1 alpha-2 <code>KE</code> Tax Authority KRA (Kenya Revenue Authority) Primary Currency KES (Kenyan Shilling) Secondary Currency \u2014 Fiscal ID Name PIN (Personal Identification Number) \u2192 maps to <code>merchant_tin</code> Languages English (primary), Swahili Fiscal Mandate eTIMS (electronic Tax Invoice Management System) Status Planned \u2014 not yet implemented"},{"location":"40-jurisdictions/ke/#overview","title":"Overview","text":"<p>Kenya's KRA mandates electronic tax invoicing through eTIMS (electronic Tax Invoice Management System). Since January 2024, all VAT-registered taxpayers must generate tax invoices through eTIMS-compliant systems. The system uses Type A (online), Type B (ETR devices), and Type C (ESD solutions) integration modes.</p> <p>Kenya's mobile money ecosystem is dominated by M-Pesa (Safaricom), which is already a rail in the Stalela Payments Nucleus architecture. KRA's eTIMS API is publicly documented, making it a strong candidate for the second jurisdiction implementation.</p>"},{"location":"40-jurisdictions/ke/#research-required","title":"Research Required","text":"<ul> <li>[ ] Map KRA tax categories (VAT 16%, Exempt, Zero-rated) to Stalela tax group manifest format</li> <li>[ ] Document buyer classification requirements under KRA</li> <li>[ ] Define permitted invoice types (tax invoice, credit note, debit note)</li> <li>[ ] Document eTIMS API integration (Type C \u2014 ESD mode)</li> <li>[ ] Map PIN format and registration requirements</li> <li>[ ] Identify compliance deadlines and penalties</li> </ul>"},{"location":"40-jurisdictions/ke/#references","title":"References","text":"<ul> <li>KRA eTIMS Portal</li> <li>Jurisdictions Overview</li> <li>Country Profile Template</li> </ul>"},{"location":"40-jurisdictions/ng/","title":"Nigeria (NG)","text":"Field Value ISO 3166-1 alpha-2 <code>NG</code> Tax Authority FIRS (Federal Inland Revenue Service) Primary Currency NGN (Nigerian Naira) Secondary Currency USD (for international transactions) Fiscal ID Name TIN (Tax Identification Number) \u2192 maps to <code>merchant_tin</code> Languages English (primary) Fiscal Mandate TaxPro Max / e-Invoice Status Planned \u2014 not yet implemented"},{"location":"40-jurisdictions/ng/#overview","title":"Overview","text":"<p>Nigeria's FIRS operates the TaxPro Max platform for tax administration and is progressively mandating electronic invoicing for VAT-registered businesses. Nigeria's large economy and complex multi-state tax regime (federal VAT + state levies) present unique challenges.</p> <p>The mobile money landscape includes OPay, PalmPay, and traditional bank transfers. Nigeria's fintech ecosystem is one of Africa's most active, making it a high-value jurisdiction for Stalela.</p>"},{"location":"40-jurisdictions/ng/#research-required","title":"Research Required","text":"<ul> <li>[ ] Map FIRS tax categories (VAT 7.5%, Exempt, Zero-rated) to Stalela tax group manifest format</li> <li>[ ] Document buyer classification requirements under FIRS</li> <li>[ ] Define permitted invoice types</li> <li>[ ] Document TaxPro Max / e-Invoice API integration</li> <li>[ ] Map TIN format and registration requirements (federal vs state)</li> <li>[ ] Identify e-invoicing compliance timeline and penalties</li> </ul>"},{"location":"40-jurisdictions/ng/#references","title":"References","text":"<ul> <li>FIRS Official Site</li> <li>Jurisdictions Overview</li> <li>Country Profile Template</li> </ul>"},{"location":"40-jurisdictions/rw/","title":"Rwanda (RW)","text":"Field Value ISO 3166-1 alpha-2 <code>RW</code> Tax Authority RRA (Rwanda Revenue Authority) Primary Currency RWF (Rwandan Franc) Secondary Currency \u2014 Fiscal ID Name TIN (Tax Identification Number) \u2192 maps to <code>merchant_tin</code> Languages English, French, Kinyarwanda Fiscal Mandate EBM (Electronic Billing Machine) / V-EBM Status Planned \u2014 not yet implemented"},{"location":"40-jurisdictions/rw/#overview","title":"Overview","text":"<p>Rwanda's RRA mandates electronic billing through the EBM (Electronic Billing Machine) system. In recent years, RRA has introduced V-EBM (Virtual EBM), allowing software-based invoicing through certified cloud systems \u2014 closely aligned with Stalela's architecture.</p> <p>V-EBM systems must connect to RRA's VSDC (Virtual Sales Data Controller) to obtain invoice signatures. Rwanda's tax structure is simpler than the DRC (VAT 18%, Exempt, Zero-rated), making it a straightforward jurisdiction to implement.</p>"},{"location":"40-jurisdictions/rw/#research-required","title":"Research Required","text":"<ul> <li>[ ] Map RRA tax categories (VAT 18%, Exempt, Zero-rated) to Stalela tax group manifest format</li> <li>[ ] Document buyer classification requirements under RRA</li> <li>[ ] Define permitted invoice types</li> <li>[ ] Document V-EBM / VSDC integration protocol</li> <li>[ ] Map TIN format and registration requirements</li> <li>[ ] Identify V-EBM certification process and requirements</li> </ul>"},{"location":"40-jurisdictions/rw/#references","title":"References","text":"<ul> <li>RRA Official Site</li> <li>Jurisdictions Overview</li> <li>Country Profile Template</li> </ul>"},{"location":"40-jurisdictions/tz/","title":"Tanzania (TZ)","text":"Field Value ISO 3166-1 alpha-2 <code>TZ</code> Tax Authority TRA (Tanzania Revenue Authority) Primary Currency TZS (Tanzanian Shilling) Secondary Currency \u2014 Fiscal ID Name TIN (Tax Identification Number) \u2192 maps to <code>merchant_tin</code> Languages English, Swahili (primary) Fiscal Mandate EFD (Electronic Fiscal Device) / VFD (Virtual Fiscal Device) Status Planned \u2014 not yet implemented"},{"location":"40-jurisdictions/tz/#overview","title":"Overview","text":"<p>Tanzania's TRA mandates electronic fiscal devices for all VAT-registered businesses. The system includes physical EFDs and Virtual Fiscal Devices (VFDs) that connect to TRA's fiscal server for real-time receipt verification. VFDs allow software-based fiscal compliance, aligning well with Stalela's cloud signing model.</p> <p>TRA's VFD API requires real-time receipt registration with the fiscal server, which returns a verification code for each transaction. Tanzania's mobile money ecosystem includes M-Pesa (Vodacom), Airtel Money, and Tigo Pesa.</p>"},{"location":"40-jurisdictions/tz/#research-required","title":"Research Required","text":"<ul> <li>[ ] Map TRA tax categories (VAT 18%, Exempt, Zero-rated, Special Relief) to Stalela tax group manifest format</li> <li>[ ] Document buyer classification requirements under TRA</li> <li>[ ] Define permitted invoice types / receipt types</li> <li>[ ] Document VFD API integration protocol</li> <li>[ ] Map TIN format and registration requirements</li> <li>[ ] Identify VFD certification process</li> </ul>"},{"location":"40-jurisdictions/tz/#references","title":"References","text":"<ul> <li>TRA Official Site</li> <li>Jurisdictions Overview</li> <li>Country Profile Template</li> </ul>"},{"location":"40-jurisdictions/za/","title":"South Africa (ZA)","text":"Field Value ISO 3166-1 alpha-2 <code>ZA</code> Tax Authority SARS (South African Revenue Service) Primary Currency ZAR (South African Rand) Secondary Currency \u2014 Fiscal ID Name Tax Reference Number \u2192 maps to <code>merchant_tin</code> Languages English (primary), plus 10 other official languages Fiscal Mandate eFiling / Tax Compliance Status (TCS) Status Planned \u2014 not yet implemented"},{"location":"40-jurisdictions/za/#overview","title":"Overview","text":"<p>South Africa's SARS does not currently mandate electronic fiscal devices in the same way as East/Central African countries. However, VAT compliance requires detailed tax invoices meeting the VAT Act requirements, and SARS's eFiling platform supports electronic submission of returns.</p> <p>South Africa's payment ecosystem is well-developed with PayShap (instant payments, already a Stalela rail), EFT, and card rails. The country's formal banking infrastructure and regulatory maturity make it a different profile from the mobile-money-first markets.</p>"},{"location":"40-jurisdictions/za/#research-required","title":"Research Required","text":"<ul> <li>[ ] Map SARS tax categories (VAT 15%, Exempt, Zero-rated) to Stalela tax group manifest format</li> <li>[ ] Document VAT invoice requirements under the VAT Act</li> <li>[ ] Define permitted invoice types (full tax invoice, abridged tax invoice, debit/credit note)</li> <li>[ ] Document eFiling / Making Tax Digital integration (if applicable)</li> <li>[ ] Map Tax Reference Number format and registration</li> <li>[ ] Assess whether SARS will mandate e-invoicing in the near term</li> </ul>"},{"location":"40-jurisdictions/za/#references","title":"References","text":"<ul> <li>SARS Official Site</li> <li>Jurisdictions Overview</li> <li>Country Profile Template</li> </ul>"},{"location":"40-jurisdictions/zw/","title":"Zimbabwe (ZW)","text":"Field Value ISO 3166-1 alpha-2 <code>ZW</code> Tax Authority ZIMRA (Zimbabwe Revenue Authority) Primary Currency ZWG (Zimbabwe Gold) Secondary Currency USD (United States Dollar) Fiscal ID Name TIN (Tax Identification Number) \u2192 maps to <code>merchant_tin</code> Languages English (primary), Shona, Ndebele Fiscal Mandate Fiscalisation of Electronic Fiscal Devices Status Planned \u2014 not yet implemented"},{"location":"40-jurisdictions/zw/#overview","title":"Overview","text":"<p>Zimbabwe mandates electronic fiscal devices for VAT-registered businesses through ZIMRA. The country uses a dual-currency model (ZWG/USD) similar to the DRC. Key mobile money providers include EcoCash (already supported in the Payments Nucleus) and OneMoney.</p> <p>ZIMRA's fiscalisation system requires electronic fiscal devices that generate fiscal day numbers, verify receipts, and transmit data to the revenue authority. Stalela's cloud-first approach can serve as a compliant SaaS alternative once ZIMRA regulations are mapped to the jurisdiction framework.</p>"},{"location":"40-jurisdictions/zw/#research-required","title":"Research Required","text":"<ul> <li>[ ] Map ZIMRA tax categories to Stalela tax group manifest format</li> <li>[ ] Document client classification requirements (if any)</li> <li>[ ] Define permitted invoice types under ZIMRA regulations</li> <li>[ ] Document ZIMRA electronic fiscal device (EFD) sync protocol</li> <li>[ ] Identify regulatory framework and compliance deadlines</li> <li>[ ] Map TIN format and registration requirements</li> </ul>"},{"location":"40-jurisdictions/zw/#references","title":"References","text":"<ul> <li>ZIMRA Official Site</li> <li>Jurisdictions Overview</li> <li>Country Profile Template</li> </ul>"},{"location":"40-ops/closing-the-books/","title":"Closing the Books (Ops Runbook)","text":"<p>The process of finalizing accounting for a period (day, month, quarter, year). Based on accrual accounting and double-entry principles.</p>"},{"location":"40-ops/closing-the-books/#daily-tasks","title":"Daily Tasks","text":"<ol> <li>Reconciliation </li> <li>Ingest statements from rails (Zimswitch, OPPWA, Algorand).  </li> <li>Match to transfers in Stalela.  </li> <li> <p>Investigate unmatched items in Operator Console.  </p> </li> <li> <p>Ledger Validation </p> </li> <li>Run posting check: every debit has equal credit.  </li> <li> <p>Generate trial balance.  </p> </li> <li> <p>Compliance Delta Check </p> </li> <li>Re-run re-screening for entities against updated lists.  </li> </ol>"},{"location":"40-ops/closing-the-books/#monthly-period-end-tasks","title":"Monthly / Period-End Tasks","text":"<ol> <li>Income Statement </li> <li> <p>Summarize revenues (fees, FX) and expenses (processing, chargebacks).  </p> </li> <li> <p>Close Temporary Accounts </p> </li> <li>Zero out revenue and expense accounts.  </li> <li> <p>Roll net income into Current Period Net Income account.  </p> </li> <li> <p>Balance Sheet </p> </li> <li>Validate: Assets = Liabilities + Equity.  </li> <li> <p>Snapshot balances for audit/export.  </p> </li> <li> <p>Cash Flow Statement </p> </li> <li>Derive from balance changes (Liquidity movements).  </li> </ol>"},{"location":"40-ops/closing-the-books/#technical-steps","title":"Technical Steps","text":"<ol> <li>Freeze event ingestion at cutoff.  </li> <li>Run reconciliation batch job.  </li> <li>Generate trial balance \u2192 verify zero-sum.  </li> <li>Post closing entries:  </li> <li>Debit/Credit Revenue \u2192 Net Income.  </li> <li>Debit/Credit Expenses \u2192 Net Income.  </li> <li>Close Net Income \u2192 Retained Earnings.  </li> <li>Unlock event ingestion.  </li> </ol>"},{"location":"40-ops/closing-the-books/#operator-notes","title":"Operator Notes","text":"<ul> <li>If unmatched transactions remain, escalate before closing.  </li> <li>If balances don\u2019t tie (A=L+E), halt closing and investigate ledger.  </li> <li>All reports (Balance Sheet, Income Statement) are versioned and immutable.  </li> </ul>"},{"location":"40-ops/observability/","title":"Observability","text":"<p>Metrics, logs, and tracing conventions for Stalela.</p>"},{"location":"40-ops/observability/#golden-signals","title":"Golden Signals","text":"<ul> <li>Latency: API p95/p99 (CTS), event publish lag (outbox \u2192 bus), ledger posting latency.  </li> <li>Traffic: transfers/sec by rail, events/sec by topic.  </li> <li>Errors: rate by type; DLQ sizes.  </li> <li>Saturation: outbox backlog, consumer lag, DB write IOPS.  </li> </ul> <p>Telco variability: expect higher latency/timeouts during peak/maintenance windows on USSD/STK rails; adjust SLOs accordingly.</p>"},{"location":"40-ops/observability/#metrics-prometheus-names","title":"Metrics (Prometheus names)","text":"<ul> <li><code>cts_requests_total{route,code}</code> </li> <li><code>cts_request_duration_seconds_bucket{route}</code> </li> <li><code>gateway_submit_duration_seconds_bucket{rail}</code> </li> <li><code>event_outbox_backlog{service}</code> </li> <li><code>event_publish_lag_seconds{service}</code> </li> <li><code>event_consumer_lag_seconds{service,topic}</code> </li> <li><code>ledger_posting_latency_seconds_bucket</code> </li> <li><code>recon_match_rate</code> , <code>recon_unmatched_backlog</code> </li> <li><code>compliance_screen_latency_seconds_bucket</code> , <code>compliance_index_age_hours</code></li> </ul> <p>Load-shedding alerts: page on <code>event_publish_lag_seconds{service}</code> and <code>gateway_submit_duration_seconds_bucket{rail=~\"(ecocash|mtnmomo|airtelmomo)\"}</code> when exceeding thresholds during known windows.</p>"},{"location":"40-ops/observability/#logs","title":"Logs","text":"<ul> <li>JSON only.  </li> <li>Required fields: <code>ts</code>, <code>level</code>, <code>service</code>, <code>tenantId</code>, <code>transferId?</code>, <code>eventId?</code>, <code>traceId?</code>.  </li> <li>PII redaction applied before emit.</li> </ul>"},{"location":"40-ops/observability/#tracing","title":"Tracing","text":"<ul> <li>Propagate <code>traceparent</code> across services.  </li> <li>Spans: <code>cts.create</code>, <code>gateway.submit</code>, <code>ledger.post</code>, <code>recon.ingest</code>.  </li> <li>Sample rate: 10% baseline; 100% on error paths.</li> </ul>"},{"location":"40-ops/observability/#dashboards","title":"Dashboards","text":"<ul> <li>Exec: transfers by rail, approval/return rates, SLAs.  </li> <li>SRE: outbox backlogs, publish lag, consumer lag, broker health.  </li> <li>Finance/Ops: settlement totals, fees, FX P&amp;L, recon match rate.</li> </ul>"},{"location":"40-ops/regulatory/","title":"Regulatory Ops (STR/CTR, BoP)","text":"<p>Operational procedures for regulatory submissions in ZA/ZW.</p>"},{"location":"40-ops/regulatory/#pipelines","title":"Pipelines","text":"<ul> <li>BoP: aggregate cross-border events \u2192 build payload \u2192 submit \u2192 store receipt.</li> <li>goAML: detect triggers \u2192 generate STR/CTR \u2192 submit \u2192 track status.</li> </ul>"},{"location":"40-ops/regulatory/#runbooks","title":"Runbooks","text":"<ul> <li>Submission failures: retry policy, contact points, escalation matrix.</li> <li>Corrections: T+1 resubmission with reference to prior filing.</li> <li>DSAR/POPIA: ensure redactions and legal holds before export.</li> </ul>"},{"location":"40-ops/regulatory/#observability","title":"Observability","text":"<ul> <li>Metrics: submissions/day, failure rate, mean time to receipt.</li> <li>Dashboards: pipeline health, backlog, DLQ.</li> </ul> <p>Last updated: 2025-08-27</p>"},{"location":"40-ops/runbooks/","title":"Runbooks","text":"<p>Operational procedures for Stalela nucleus components. Keep these pragmatic and up to date.</p>"},{"location":"40-ops/runbooks/#transfers-stuck-in-submitted","title":"Transfers stuck in SUBMITTED","text":"<p>Symptoms - Many transfers in <code>SUBMITTED</code> for &gt; X minutes. - Gateways show growing outbox backlog.</p> <p>Checks 1. Gateway <code>/ready</code> and <code>/metrics</code> for the affected rail. 2. Event bus health; consumer lag. 3. Directory lookup SLOs (routing latency spikes?).  </p> <p>Actions - Restart gateway dispatcher if wedged. - Drain DLQ after verifying poison messages are quarantined. - Temporarily throttle creation rate from CTS for the tenant with spikes. - Archive any DLQ extracts to object storage (7-year retention) before purging queue entries (14-day in-queue policy).</p> <p>Postmortem notes - Attach event IDs and sample transferIds. - Record root cause and prevention (ADR if architectural).</p>"},{"location":"40-ops/runbooks/#reconciliation-unmatched-backlog","title":"Reconciliation unmatched backlog","text":"<p>Symptoms - <code>recon.exception.opened</code> spiking, queue &gt; SLA.  </p> <p>Checks 1. Statement ingest success rate and file checksums. 2. Directory fee tables / windows version drift. 3. Key mapping (acqRef/authCode/externalRef) consistency.  </p> <p>Actions - Assign operators to bulk-assign obvious matches. - Re-run ingest from last checkpoint if normalization bug found. - File partner ticket if delivery gaps observed.  </p>"},{"location":"40-ops/runbooks/#compliance-stale-index","title":"Compliance stale index","text":"<p>Symptoms - Alert: compliance list age &gt; 24h.  </p> <p>Checks 1. Downloader logs (network, checksum mismatch). 2. Disk space / blob store quota.  </p> <p>Actions - Trigger manual list refresh. - Roll back to last good index if corruption detected. - If still failing, force CTS to deny by policy until lists are healthy.  </p>"},{"location":"40-ops/runbooks/#ledger-posting-failures","title":"Ledger posting failures","text":"<p>Symptoms - <code>currency mismatch</code> or <code>negative balance blocked</code>.  </p> <p>Checks 1. Posting rules version and inputs from event. 2. Account config (currency, status).  </p> <p>Actions - Open exception, block further postings for the tenant if systemic. - Patch rules (PR) and replay events.  </p>"},{"location":"40-ops/runbooks/#event-bus-backlog","title":"Event bus backlog","text":"<p>Symptoms - High outbox backlog, consumer lag.  </p> <p>Checks 1. Bus broker health, partition leaders. 2. Dispatcher logs for auth / throttling errors.  </p> <p>Actions - Scale consumers horizontally. - Increase partitions if saturated. - Enable backpressure on producers (CTS) temporarily. - If manual re-drive required, obtain dual approval and attach signed reason to the ticket before replaying messages.</p>"},{"location":"40-ops/runbooks/#load-shedding-resilience-za","title":"Load-shedding resilience (ZA)","text":"<p>Symptoms - Increased timeouts/latency during scheduled power cuts; spikes in retries/DLQ.  </p> <p>Checks 1. Gateway submit/confirm latency; retry counters. 2. Outbox backlog and consumer lag around shedding windows. 3. Infrastructure node availability in affected regions.  </p> <p>Actions - Increase backoff and retry windows temporarily; enable circuit breakers. - Prefer idempotent replays after power restoration. - Throttle CTS create rate for impacted tenants. - Schedule maintenance/ingests away from shedding windows.  </p> <p>Alerts - Alert on publish lag, retry spikes, and failure-rate thresholds during known windows.  </p>"},{"location":"40-ops/runbooks/#popia-dsar-data-subject-accesserasure","title":"POPIA DSAR (Data Subject Access/Erasure)","text":"<p>Scope - Handle access/correction/erasure requests while honoring legal holds and retention.</p> <p>Steps 1. Verify requestor identity and authority. 2. Locate records across services (CTS, Ledger, Compliance, Recon, blobs). 3. Produce access report with redactions; log disclosure. 4. For erasure: apply anonymization where permitted; record legal holds where applicable. 5. Update DSAR register with timestamps and outcome.  </p> <p>Controls - Do not delete immutable audit/journal data; apply irreversible hashing where allowed. - Approval workflow for erasure.</p>"},{"location":"40-ops/security/","title":"Security","text":"<p>Standards for secrets, access, PCI scope, and PII handling in Stalela.</p>"},{"location":"40-ops/security/#secrets-management","title":"Secrets Management","text":"<ul> <li>Stored in a centralized vault (e.g., HashiCorp Vault).  </li> <li>Rotated at least every 90 days; immediate rotation on incident.  </li> <li>No secrets in environment variables for long-lived services without vault agent.  </li> </ul>"},{"location":"40-ops/security/#access-control","title":"Access Control","text":"<ul> <li>Service-to-service auth via mTLS or mesh-issued JWT.  </li> <li>RBAC for Operator Console (OPS, COMPLIANCE, ADMIN).  </li> <li>Principle of least privilege to DBs and blob stores.</li> </ul>"},{"location":"40-ops/security/#pci-pan-scope","title":"PCI &amp; PAN Scope","text":"<ul> <li>Card data handled exclusively in OPPWA/Zimswitch gateway.  </li> <li>PAN/token never flows into CTS or Ledger.  </li> <li>Webhook/file artifacts are redacted and encrypted.</li> </ul>"},{"location":"40-ops/security/#pci-saq-tokenization-in-region","title":"PCI SAQ &amp; Tokenization (in-region)","text":"<ul> <li>Prefer network tokenization or vetted token vaults; avoid PAN handling outside gateways.  </li> <li>Scope reduction: isolate gateways; segment networks; harden endpoints.  </li> <li>Complete appropriate SAQ (likely SAQ D for service providers) with compensating controls documented.  </li> </ul>"},{"location":"40-ops/security/#pii-handling","title":"PII Handling","text":"<ul> <li>Encrypt at rest; redact in logs and events.  </li> <li>Minimize in DBs; store raw artifacts in encrypted blob store.  </li> <li>Data retention per <code>20-specs/data-retention-pii.md</code>.</li> </ul>"},{"location":"40-ops/security/#popia-south-africa","title":"POPIA (South Africa)","text":"<ul> <li>Lawful basis: document processing purposes per flow (screening, settlement, reporting).  </li> <li>Cross-border transfers: assess adequate protection or implement contractual safeguards; record in audits.  </li> <li>Data subject rights: verify identity; fulfill access/correction/erasure subject to legal holds.  </li> <li>Privacy by design: DPIA for new rails; minimize PII in events; default encryption.</li> </ul>"},{"location":"40-ops/security/#licensing-scheme-participation-zazw","title":"Licensing &amp; Scheme Participation (ZA/ZW)","text":"<ul> <li>Role options: PSP, System Operator, or via sponsor bank; document per environment.  </li> <li>PASA participation: outline sponsor relationships, limits, and responsibilities.  </li> <li>Operational controls: incident management, segregation of duties, change management.</li> </ul>"},{"location":"40-ops/security/#secure-coding","title":"Secure Coding","text":"<ul> <li>Input validation at boundaries; strict schema checks.  </li> <li>Dependency scanning and SAST/DAST in CI.  </li> <li>Security headers on all admin endpoints.</li> </ul>"},{"location":"40-ops/security/#incident-response","title":"Incident Response","text":"<ul> <li>24/7 on-call rotation; breach protocol documented.  </li> <li>Forensics: immutable logs and event store.  </li> <li>Post-incident ADR if architectural changes required.</li> </ul>"},{"location":"50-repo-structure/ci-cd/","title":"CI/CD Standard (per service)","text":"<p>Canonical GitHub Actions workflow + required checks for all Stalela service repos.</p>"},{"location":"50-repo-structure/ci-cd/#required-checks","title":"Required Checks","text":"<ul> <li>lint: golangci\u2011lint / eslint</li> <li>test: unit tests + golden fixtures</li> <li>contract\u2011validate: ensure emitted/consumed events &amp; APIs conform to <code>storo-specs</code></li> <li>migrations\u2011dry\u2011run: for services with DB migrations</li> <li>build: Docker image</li> <li>publish: tag <code>svc:X.Y.Z</code> and <code>svc:X</code></li> </ul>"},{"location":"50-repo-structure/ci-cd/#example-workflow-githubworkflowsciyml","title":"Example Workflow (<code>.github/workflows/ci.yml</code>)","text":"<pre><code>name: CI\n\non:\n  push:\n    branches: [ main ]\n    tags: [ 'v*.*.*' ]\n  pull_request:\n\njobs:\n  lint:\n    runs-on: ubuntu-latest\n    steps:\n      - uses: actions/checkout@v4\n      - uses: actions/setup-go@v5\n        with: { go-version: '1.22' }\n      - run: go install github.com/golangci/golangci-lint/cmd/golangci-lint@latest\n      - run: golangci-lint run ./...\n\n  test:\n    runs-on: ubuntu-latest\n    services:\n      postgres:\n        image: postgres:16\n        env:\n          POSTGRES_PASSWORD: postgres\n        ports: [ '5432:5432' ]\n        options: &gt;-\n          --health-cmd=\"pg_isready -U postgres\"\n          --health-interval=10s\n          --health-timeout=5s\n          --health-retries=5\n      localstack:\n        image: localstack/localstack:3\n        env:\n          SERVICES: sns,sqs,s3\n        ports: [ '4566:4566' ]\n    steps:\n      - uses: actions/checkout@v4\n      - uses: actions/setup-go@v5\n        with: { go-version: '1.22' }\n      - run: make db   # apply embedded migrations\n      - run: make test # includes golden fixture tests\n\n  contract-validate:\n    runs-on: ubuntu-latest\n    steps:\n      - uses: actions/checkout@v4\n      - name: Install Node\n        uses: actions/setup-node@v4\n        with: { node-version: '20' }\n      - run: npm i -D @storo/specs ajv\n      - run: npm run validate:events  # project script validates fixtures/outbound events against envelope v=1\n      - run: npm run validate:openapi # if this repo exposes HTTP\n\n  build:\n    needs: [lint, test, contract-validate]\n    runs-on: ubuntu-latest\n    steps:\n      - uses: actions/checkout@v4\n      - name: Docker build\n        run: |\n          docker build -t ghcr.io/storo/${{ github.event.repository.name }}:${{ github.sha }} .\n      - name: Log in to GHCR\n        uses: docker/login-action@v3\n        with:\n          registry: ghcr.io\n          username: ${{ github.actor }}\n          password: ${{ secrets.GITHUB_TOKEN }}\n      - name: Push SHA image\n        run: docker push ghcr.io/storo/${{ github.event.repository.name }}:${{ github.sha }}\n\n  publish:\n    if: startsWith(github.ref, 'refs/tags/v')\n    needs: [build]\n    runs-on: ubuntu-latest\n    steps:\n      - uses: actions/checkout@v4\n      - name: Tag &amp; push semver images\n        run: |\n          IMAGE=ghcr.io/storo/${{ github.event.repository.name }}\n          TAG=${GITHUB_REF#refs/tags/}\n          MAJOR=$(echo $TAG | cut -d. -f1)\n          docker pull $IMAGE:${{ github.sha }}\n          docker tag  $IMAGE:${{ github.sha }} $IMAGE:$TAG\n          docker tag  $IMAGE:${{ github.sha }} $IMAGE:$MAJOR\n          docker push $IMAGE:$TAG\n          docker push $IMAGE:$MAJOR\n</code></pre>"},{"location":"50-repo-structure/ci-cd/#branching-protection","title":"Branching &amp; Protection","text":"<ul> <li>Trunk\u2011based: short\u2011lived PRs to <code>main</code>, protected branch.</li> <li>Required status checks: all jobs above.</li> <li>Conventional commits recommended; changelogs generated on tag.</li> </ul>"},{"location":"50-repo-structure/ci-cd/#deploy-via-storo-infra","title":"Deploy (via <code>storo-infra</code>)","text":"<ul> <li>Terraform pins image tags per env (dev/staging/prod).</li> <li>PR to bump tag = deploy. Rollback = revert tag.</li> <li>Deploy during SAST business hours; staging soak \u2265 24h for sensitive services.</li> </ul>"},{"location":"50-repo-structure/ci-cd/#secrets-tokens-in-ci","title":"Secrets &amp; Tokens in CI","text":""},{"location":"50-repo-structure/ci-cd/#contract-validation-fixtures","title":"Contract Validation &amp; Fixtures","text":"<ul> <li>Source of truth: see <code>Specs \u2192 Events</code> (envelope <code>v=1</code>) and <code>Specs \u2192 Fixtures</code> for golden examples.</li> <li>Minimum checks:</li> <li>Validate outbound events from providers (gateways, ledger, CTS) against envelope <code>v=1</code> and event schemas.</li> <li>Validate inbound consumer fixtures (e.g., ledger consuming <code>transfers.settled</code>) using AJV/<code>@storo/specs</code>.</li> <li>Recommended project scripts:</li> <li><code>validate:events</code> \u2192 runs schema checks on all event samples under <code>fixtures/events/*.json</code>.</li> <li> <p><code>validate:openapi</code> \u2192 validates OpenAPI if the repo exposes HTTP.</p> </li> <li> <p>Use GitHub Environments or OpenID Connect to assume AWS roles. No long\u2011lived keys.</p> </li> <li>Service\u2011specific permissions; least privilege to push images / read Secrets Manager where necessary.</li> </ul>"},{"location":"50-repo-structure/local-dev/","title":"Local Development (storo\u2011devstack)","text":"<p>How to run Stalela locally without a monorepo. You\u2019ll run the fleet via Docker and swap one service for your local build.</p>"},{"location":"50-repo-structure/local-dev/#prereqs","title":"Prereqs","text":"<ul> <li>Docker Desktop / Colima</li> <li>Make or Task</li> <li>Go 1.22 (for Go services), Node 20 (for console)</li> <li><code>storo-devstack</code> repo cloned</li> </ul> <p>Devstack provides: Postgres (multi\u2011DB), LocalStack (SNS/SQS), Prometheus, Grafana, and released service images.</p>"},{"location":"50-repo-structure/local-dev/#start-the-fleet","title":"Start the Fleet","text":"<pre><code>git clone git@github.com:storo/storo-devstack.git\ncd storo-devstack\ndocker compose up -d\n</code></pre> <p>Services come up with released images. Grafana is available at http://localhost:3000 (admin/admin by default).</p>"},{"location":"50-repo-structure/local-dev/#develop-one-service-locally","title":"Develop One Service Locally","text":"<p>Example: work on storo-gw-usdc while everything else runs in containers.</p> <p>1) Clone your service and start it locally: <pre><code>git clone git@github.com:storo/storo-gw-usdc.git\ncd storo-gw-usdc\nmake dev    # or task dev (hot reload)\n</code></pre></p> <p>2) In <code>storo-devstack/docker-compose.override.example.yml</code>, copy to <code>docker-compose.override.yml</code> and disable the service container, mapping your local port:</p> <pre><code># docker-compose.override.yml\nservices:\n  gw-usdc:\n    deploy:\n      replicas: 0  # disable container; we'll run it locally\n  # If the stack expects a port:\n  #   ports:\n  #     - \"8085:8085\"  # match your local gw-usdc listen port\n</code></pre> <p>3) Ensure env points to devstack infra: - Postgres: <code>postgres://localhost:5432/gw_usdc?sslmode=disable</code> - SQS/SNS (LocalStack): <code>http://localhost:4566</code> with dummy creds - S3 (for payloads): <code>http://localhost:4566</code></p> <p>4) Seed data (optional): <pre><code>make seed   # directory entries, holidays, test tenants\n</code></pre></p> <p>You can now post a transfer to CTS in devstack and watch events reach your local gateway.</p>"},{"location":"50-repo-structure/local-dev/#example-smoke-test-usdc-happy-path","title":"Example: Smoke Test (USDC Happy Path)","text":"<pre><code># Create a transfer\ncurl -XPOST http://localhost:8080/v1/transfers   -H 'Idempotency-Key: demo-1'   -d '{\n    \"tenantId\":\"tn_demo\",\n    \"payer\":{\"accountId\":\"acct_payer\"},\n    \"payee\":{\"accountId\":\"acct_merchant\"},\n    \"amount\":{\"value\":1000,\"currency\":\"USD\"},\n    \"rail\":\"usdc-algo\",\"intent\":\"PUSH\",\"externalRef\":\"ext_demo\"\n  }'\n</code></pre> <p>Verify in logs: - CTS emits <code>transfers.submitted.usdc</code> - Your local <code>gw-usdc</code> consumes and emits <code>accepted</code> then <code>settled</code> - Ledger in devstack posts entries</p>"},{"location":"50-repo-structure/local-dev/#tilt-optional-live-reload","title":"Tilt (optional, live reload)","text":"<p>If you prefer Tilt for hot\u2011reload: - <code>storo-devstack/Tiltfile</code> includes services. Comment out the one you run locally. - Point your local service to devstack infra as above.</p>"},{"location":"50-repo-structure/local-dev/#timezone-cutoffs","title":"Timezone &amp; Cutoffs","text":"<p>Business rules use Africa/Johannesburg. For predictable tests: - Export <code>TZ=Africa/Johannesburg</code> - Seed holidays via <code>platform-base</code> fixtures</p>"},{"location":"50-repo-structure/local-dev/#troubleshooting","title":"Troubleshooting","text":"<ul> <li>Events not flowing: check LocalStack is up (<code>awslocal sns list-topics</code>).</li> <li>DLQ growing: open Grafana \u2192 \u201cEvent Backlogs\u201d dashboard.</li> <li>DB migrations: run <code>make db</code> in the service repo to apply embedded migrations.</li> <li>CORS (console): set <code>CORS_ALLOWED_ORIGINS=http://localhost:3001</code> on services that expose HTTP APIs.</li> </ul>"},{"location":"50-repo-structure/local-dev/#clean-up","title":"Clean Up","text":"<pre><code>docker compose down -v  # stop and remove volumes\n</code></pre> <p>This resets your local DBs and queues.</p>"},{"location":"50-repo-structure/multi-repo-architecture/","title":"Multi\u2011Repo Architecture (Stalela)","text":"<p>How Stalela\u2019s nucleus is organized across independent repositories so multiple teams can ship fast without stepping on each other.</p> <p>This document defines which repos exist, who owns them, how they interoperate (contracts-first), and how you develop locally without a monorepo. It also sets versioning rules, release flows, and deprecation discipline.</p>"},{"location":"50-repo-structure/multi-repo-architecture/#goals-nongoals","title":"Goals &amp; Non\u2011Goals","text":"<p>Goals - Independent deployability and ownership per service. - Contract\u2011first interoperability (events &amp; APIs) with machine\u2011verifiable schemas. - Clear local dev story: run one service locally while the rest run as containers. - Locked\u2011down release &amp; rollback process per service.</p> <p>Non\u2011Goals - A single build system for everything (keep repos simple). - Tight coupling via shared DBs (no cross\u2011service DB calls).</p>"},{"location":"50-repo-structure/multi-repo-architecture/#repository-map-source-of-truth","title":"Repository Map (source of truth)","text":"Repo Purpose Tech Owners Notes storo-specs Event schemas (JSON Schema), APIs (OpenAPI), golden fixtures, codegen JSON/YAML, Node scripts Platform Publishes <code>@storo/specs</code> (npm) and <code>github.com/storo/specs-go</code> (Go) storo-cts Canonical Transfer Service (API + orchestration) Go, Postgres, SQS/SNS Payments Core Emits <code>transfers.submitted.&lt;rail&gt;</code> storo-gw-usdc USDC/Algorand rail gateway Go, Postgres, SQS/SNS Rails Team Strict transform + event emission storo-gw-oppwa OPPWA gateway Go Rails Team Webhooks verified &amp; signed storo-gw-zimswitch Zimswitch/ISO8583 gateway Go Rails Team ISO fixtures + golden tests storo-ledger Double\u2011entry, append\u2011only ledger Go, Postgres Finance Eng Consumes <code>transfers.*</code> \u2192 postings storo-compliance Local watchlist index + screening Go Risk/Compliance Ingests OFAC/UN/EU/SA lists storo-directory Institutions, BINs, fees, settlement windows Go Platform Versioned datasets storo-recon Statement ingest + matching + returns Go Finance Ops Emits <code>transfers.settled/returned</code> storo-operator-console Internal UI (timeline, exceptions, flags) Next.js/TS Ops Auth via SSO/RBAC storo-devstack Local docker compose / Tilt to run the fleet Compose/Tilt DX Lets each dev swap a single local service storo-infra Terraform + env config (dev/stage/prod) Terraform Infra Controls image tags, secrets, IAM storo-observability Dashboards, alert rules Grafana/Prom SRE Golden signals and SLOs <p>Ownership is explicit. Each repo has CODEOWNERS and a simple <code>Makefile</code>/<code>Taskfile</code> so onboarding is fast.</p>"},{"location":"50-repo-structure/multi-repo-architecture/#repo-classification-and-naming-conventions","title":"Repo classification and naming conventions","text":"<p>Convention - Libraries and shared packages MUST use the <code>-lib</code> suffix and contain no Lambdas. - Services and gateways (no <code>-lib</code> suffix) may include Lambdas where serverless is beneficial (webhooks, async processors, scheduled jobs). - Infra repos do not themselves contain Lambdas but define/deploy them.</p> Repo Type Lambdas Description storo-specs Contracts source (publishes libs) N/A Source of truth for event and API schemas; publishes <code>@storo/specs</code> (TS) and <code>storo-specs-go-lib</code> (Go). storo-specs-go-lib Library No Generated Go types/validators from <code>storo-specs</code>. storo-platform-lib Library No Shared domain types, business time/holiday calendars, RBAC helpers. storo-outbox-lib Library No Outbox helpers: transactional writes, idempotency keys, retry/backoff, metrics. storo-otel-lib Library No OpenTelemetry setup, logging, tracing, metrics helpers. storo-cts Service Yes Canonical Transfer Service API/orchestration; may run webhook or async processors as Lambdas. storo-gw-usdc Gateway Service Yes USDC/Algorand rail gateway; webhook handlers and async processors as Lambdas. storo-gw-oppwa Gateway Service Yes OPPWA gateway; signed webhooks and callbacks as Lambdas. storo-gw-zimswitch Gateway Service Possible ISO8583 processing; primarily containerized, Lambdas possible for specific async tasks. storo-ledger Service No Double-entry ledger; stateful DB workers; not expected to use Lambdas. storo-compliance Service Possible Screening; may use Lambdas for list ingestion/refresh, core service containerized. storo-directory Service Possible Reference datasets; may use Lambdas for scheduled imports; core reads are containerized. storo-recon Service Possible Statement ingest/matching; may use Lambdas for schedulers/extractors. storo-operator-console UI/Web No Internal Next.js app for ops; no Lambdas in repo (hosting may use edge/serverless runtime). storo-devstack Dev tooling No Local docker compose/Tilt; no Lambdas. storo-infra Infra N/A Terraform for environments, images, IAM, secrets; deploys container workloads. storo-cdk-infra Infra N/A CDK for serverless components (Lambda, API Gateway, SQS/SNS bindings) for serverless use-cases. storo-observability Observability N/A Dashboards and alert rules (Grafana/Prometheus). <p>Notes - Gateways and CTS are the primary candidates to include Lambdas (webhooks, async enrich/emit, scheduled maintenance). - Libraries never ship compute. If a repo might own runtime code, it should not carry the <code>-lib</code> suffix. - <code>storo-cdk-infra</code> is introduced to manage serverless stacks alongside <code>storo-infra</code> (Terraform) for containerized infrastructure.</p>"},{"location":"50-repo-structure/multi-repo-architecture/#contractsfirst-single-source-of-truth","title":"Contracts\u2011First (single source of truth)","text":""},{"location":"50-repo-structure/multi-repo-architecture/#storospecs","title":"storo\u2011specs","text":"<ul> <li>Events: JSON Schemas under <code>events/</code> with version fields (e.g., <code>\"v\": 1</code>).  </li> <li>APIs: OpenAPI under <code>api/</code> (CTS <code>/v1/transfers</code>, Ledger reads, etc.).  </li> <li>Fixtures: Golden JSON examples validated in CI.  </li> <li>Codegen: Publishes on tag:</li> <li>Go types/validators \u2192 <code>github.com/storo/specs-go</code> (semantic versioned)</li> <li>TS types/clients \u2192 <code>@storo/specs</code> (npm semver)</li> </ul> <p>Rule: Service repos pin a specific tag and validate in CI that all in/out payloads conform.</p>"},{"location":"50-repo-structure/multi-repo-architecture/#event-api-versioning","title":"Event &amp; API Versioning","text":"<ul> <li>Additive changes (new optional field): minor bump in <code>storo-specs</code>, no event version change required.</li> <li>Breaking changes: introduce new event version (e.g., <code>transfers.settled v2</code>) and dual\u2011publish during migration; consumers add support then deprecate v1.</li> <li>HTTP APIs: path versioning (<code>/v1/...</code>). Breaking change \u21d2 add <code>/v2</code> and run both until cutover.</li> <li>Deprecation policy: announce, dual\u2011run \u2265 2 releases, remove only after consumers are migrated.</li> </ul>"},{"location":"50-repo-structure/multi-repo-architecture/#local-development-no-monorepo-pain","title":"Local Development (no monorepo pain)","text":"<p>Use storo-devstack to run the fleet with released images + infrastructure (Postgres, LocalStack, Prometheus, Grafana). Then swap one service for a local build.</p>"},{"location":"50-repo-structure/multi-repo-architecture/#workflow","title":"Workflow","text":"<ol> <li><code>git clone storo-devstack &amp;&amp; docker compose up -d</code> </li> <li><code>git clone storo-gw-usdc &amp;&amp; make dev</code> (runs the gateway on your machine)</li> <li>In <code>storo-devstack/docker-compose.override.yml</code>, map the gateway\u2019s host port to the fleet and disable the container for that service.</li> <li>Iterate with hot reload (air/reflex). The rest of the system keeps using released images.</li> </ol> <p>Why this works: Contracts are pinned. Your local service talks to Live Postgres &amp; LocalStack queues created by devstack, so flows are realistic.</p>"},{"location":"50-repo-structure/multi-repo-architecture/#cicd-per-service","title":"CI/CD per Service","text":"<p>Pipeline (GitHub Actions) 1. <code>lint</code> (golangci\u2011lint / eslint) 2. <code>test</code> (unit + fixtures) 3. <code>contract-validate</code> (AJV vs <code>@storo/specs</code>; or <code>specs-go</code> validate) 4. <code>build</code> (Docker) 5. <code>publish</code> (<code>svc:X.Y.Z</code> + <code>svc:X</code>) 6. (optional) Chart publish (Helm)  </p> <p>storo-infra references image tags per env. Deploy is a tag flip (dev \u2192 stage \u2192 prod).</p>"},{"location":"50-repo-structure/multi-repo-architecture/#environments-secrets","title":"Environments &amp; Secrets","text":"<ul> <li>Envs: dev, staging, prod (separate AWS accounts).  </li> <li>Secrets in AWS Secrets Manager; IAM least privilege per service.  </li> <li>Business timezone is Africa/Johannesburg; holiday calendars bundled in <code>platform-base</code>.</li> </ul>"},{"location":"50-repo-structure/multi-repo-architecture/#observability-slos","title":"Observability &amp; SLOs","text":"<ul> <li>OpenTelemetry on all services. Prometheus metrics scraped by devstack &amp; prod.  </li> <li>Golden signals per ADR/observability doc: API latency, outbox backlog, consumer lag, ledger posting latency, recon match rate.  </li> <li>Alert rules live in <code>storo-observability</code> repo and are applied by Infra.</li> </ul>"},{"location":"50-repo-structure/multi-repo-architecture/#data-safety-rails","title":"Data &amp; Safety Rails","text":"<ul> <li>No cross\u2011service DB access. Only APIs/events.  </li> <li>Outbox required (ADR\u20110001). State change + event in the same txn.  </li> <li>Ledger is double\u2011entry, append\u2011only (ADR\u20110002).  </li> <li>Compliance must pass for submission; stale lists \u21d2 deny by policy.  </li> <li>Recon must close exceptions before end\u2011of\u2011day books close.</li> </ul>"},{"location":"50-repo-structure/multi-repo-architecture/#branching-releases","title":"Branching &amp; Releases","text":"<ul> <li>Trunk\u2011based with short\u2011lived PRs.  </li> <li>CI gates: unit, contract, migrations dry\u2011run.  </li> <li>Release by tagging (<code>vX.Y.Z</code>) \u2192 image publish.  </li> <li>Rollback: revert image tag in <code>storo-infra</code> (no code revert required).</li> </ul>"},{"location":"50-repo-structure/multi-repo-architecture/#repository-templates-consistency","title":"Repository Templates (consistency)","text":"<p>Each Go service repo includes: - <code>/cmd/service/main.go</code> with <code>/live</code>, <code>/ready</code>, <code>/metrics</code>, <code>/version</code> - <code>/internal/</code> (handlers, consumers, posting rules) - <code>/migrations/</code> (embedded) - Outbox &amp; optional Inbox (dedupe) tables - <code>Makefile</code> / <code>Taskfile.yml</code> - <code>.github/workflows/ci.yml</code> (pipeline above) - <code>docs/README.md</code> (local dev, env vars, example payloads)  </p>"},{"location":"50-repo-structure/multi-repo-architecture/#mermaid-map-repos-flows","title":"Mermaid Map (repos &amp; flows)","text":"<pre><code>flowchart LR\n  subgraph Specs\n    SP[storo-specs]\n  end\n\n  subgraph Rails\n    GU[storo-gw-usdc]\n    GO[storo-gw-oppwa]\n    GZ[storo-gw-zimswitch]\n  end\n\n  CTS[storo-cts]\n  LED[storo-ledger]\n  CMP[storo-compliance]\n  DIR[storo-directory]\n  REC[storo-recon]\n  UI[storo-operator-console]\n  DS[storo-devstack]\n  INF[storo-infra]\n\n  SP --&gt; CTS\n  SP --&gt; GU\n  SP --&gt; GO\n  SP --&gt; GZ\n  SP --&gt; LED\n  SP --&gt; CMP\n  SP --&gt; DIR\n  SP --&gt; REC\n  SP --&gt; UI\n\n  CTS --&gt;|transfers.submitted.*| GU\n  CTS --&gt;|transfers.submitted.*| GO\n  CTS --&gt;|transfers.submitted.*| GZ\n\n  GU --&gt;|transfers.accepted/settled/returned| CTS\n  GO --&gt;|\u2026| CTS\n  GZ --&gt;|\u2026| CTS\n\n  CTS --&gt; LED\n  REC --&gt; CTS\n  DIR --&gt; CTS\n  CMP --&gt; CTS\n  UI --&gt; CTS\n\n  DS --- CTS\n  DS --- GU\n  DS --- LED\n  INF --- CTS\n  INF --- Rails</code></pre>"},{"location":"50-repo-structure/multi-repo-architecture/#deprecation-migration-playbook","title":"Deprecation &amp; Migration Playbook","text":"<ol> <li>Propose change \u2192 write/update ADR in storo-specs PR.  </li> <li>Add schema change (new event version or additive field).  </li> <li>Publish new <code>specs-go</code> / <code>@storo/specs</code> tags.  </li> <li>Update providers first (emit both versions if breaking).  </li> <li>Update consumers to accept new version; ship.  </li> <li>Remove old version after \u22652 releases and a green prod window.</li> </ol>"},{"location":"50-repo-structure/multi-repo-architecture/#security-compliance-notes","title":"Security &amp; Compliance Notes","text":"<ul> <li>PAN/PCI scope stays inside gateways; no PAN in CTS/Ledger events.  </li> <li>PII minimized; raw rail payloads stored encrypted in blob store with TTL per policy.  </li> <li>Audit logs on the Operator Console; 4\u2011eyes for returns &amp; freezes.</li> </ul>"},{"location":"50-repo-structure/multi-repo-architecture/#actionable-next-steps-docsonly","title":"Actionable Next Steps (docs\u2011only)","text":"<ul> <li>Create repo stubs (empty READMEs) for all repos listed.  </li> <li>Add this doc under <code>docs/50-repo-structure/multi-repo-architecture.md</code>.  </li> <li>Draft <code>release-strategy.md</code> (semver details, dual\u2011publish patterns, deprecation checklist).  </li> <li>Draft <code>local-dev.md</code> (devstack usage + override examples).  </li> <li>Draft <code>ci-cd.md</code> (standard CI template + required checks).</li> </ul> <p>Once these docs exist, teams can start coding without waiting on a monorepo setup and with contracts locked by <code>storo-specs</code>.</p>"},{"location":"50-repo-structure/release-strategy/","title":"Release Strategy","text":"<p>Versioning, compatibility, and deprecation policy for Stalela\u2019s multi\u2011repo nucleus.</p>"},{"location":"50-repo-structure/release-strategy/#goals","title":"Goals","text":"<ul> <li>Ship services independently with predictable compatibility.</li> <li>Keep contracts-first (events + APIs) as the single source of truth.</li> <li>Enable safe rollbacks (just flip image tags).</li> <li>Avoid hard breaks: use dual\u2011publish and additive changes.</li> </ul>"},{"location":"50-repo-structure/release-strategy/#semantic-versioning-semver","title":"Semantic Versioning (SemVer)","text":"<ul> <li>All repos use X.Y.Z.</li> <li>X = breaking</li> <li>Y = backward\u2011compatible features</li> <li>Z = fixes/internal</li> </ul>"},{"location":"50-repo-structure/release-strategy/#images-packages","title":"Images &amp; Packages","text":"<ul> <li>Docker: <code>svc:X.Y.Z</code> and <code>svc:X</code> (major alias)</li> <li>Go module (<code>specs-go</code>): <code>vX.Y.Z</code> tags</li> <li>NPM (<code>@storo/specs</code>): semver tags</li> </ul>"},{"location":"50-repo-structure/release-strategy/#events-json-schema-versioning","title":"Events (JSON Schema) Versioning","text":"<ul> <li>Each event in <code>storo-specs</code> has an explicit envelope with a <code>\"v\"</code> field:   <pre><code>{ \"eventId\":\"...\", \"type\":\"transfers.settled\", \"v\":1, \"occurredAt\":\"...\", \"transferId\":\"...\", \"tenantId\":\"...\", \"payload\":{...} }\n</code></pre></li> <li>Additive changes (new optional fields in <code>payload</code>) \u21d2 minor bump of <code>storo-specs</code>; no change to <code>v</code>.</li> <li>Breaking changes \u21d2 introduce new event version (e.g., <code>v2</code>), keep <code>v1</code> schemas.  </li> <li>Providers (e.g., gateways) dual\u2011publish <code>v1</code> and <code>v2</code> for \u2265 2 releases.</li> <li>Consumers (e.g., ledger/recon) add support for <code>v2</code> before we retire <code>v1</code>.</li> </ul> <p>Consumer rule: always validate by <code>type + v</code> and reject unknown versions with a clear metric/log.</p>"},{"location":"50-repo-structure/release-strategy/#http-apis-versioning","title":"HTTP APIs Versioning","text":"<ul> <li>Path versioning: <code>/v1/...</code>, breaking change \u21d2 new path <code>/v2/...</code>.</li> <li>Run both versions until all clients migrate; publish sunset date.</li> </ul>"},{"location":"50-repo-structure/release-strategy/#deprecation-policy","title":"Deprecation Policy","text":"<ol> <li>Propose change + ADR in <code>storo-specs</code> PR.</li> <li>Announce (changelog + #dev\u2011announcements), add sunset date.</li> <li>Dual\u2011run (events/APIs) for \u2265 2 releases or agreed window.</li> <li>Measure: consumer readiness dashboards.</li> <li>Remove old version after sign\u2011off.</li> </ol>"},{"location":"50-repo-structure/release-strategy/#release-flow-per-service","title":"Release Flow (per service)","text":"<ol> <li>Merge to <code>main</code> (all checks green).</li> <li>Tag <code>vX.Y.Z</code> \u2192 CI builds/pushes images.</li> <li><code>storo-infra</code> PR bumps the env pin:</li> <li>dev \u2192 staging \u2192 prod (separate PRs), with Africa/Johannesburg cutoffs in mind.</li> <li>Rollback = revert tag pin in <code>storo-infra</code>.</li> </ol>"},{"location":"50-repo-structure/release-strategy/#rollout-patterns","title":"Rollout Patterns","text":"<ul> <li>Canary: ship to \u226410% traffic via separate task set/service.</li> <li>Shadow (events): consume <code>v2</code> in a shadow consumer and compare outcomes before switching.</li> <li>Feature Flags: CTS per\u2011tenant throttles, gateway partner toggles.</li> </ul>"},{"location":"50-repo-structure/release-strategy/#compatibility-matrix-example","title":"Compatibility Matrix (example)","text":"Producer Event Current Next Policy gw-usdc transfers.settled v1 v2 dual\u2011publish 2 releases ledger consumes <code>settled</code> v1 v1+v2 must accept both recon consumes <code>settled</code> v1 v1+v2 must accept both"},{"location":"50-repo-structure/release-strategy/#changelogs","title":"Changelogs","text":"<ul> <li>Each repo maintains <code>CHANGELOG.md</code> (Keep a Changelog format).</li> <li><code>storo-specs</code> also publishes a schema diff in release notes.</li> </ul>"},{"location":"50-repo-structure/release-strategy/#slas-for-releases","title":"SLAs for Releases","text":"<ul> <li>Prod changes during business hours SAST only (unless hotfix).</li> <li>Staging soak time: \u2265 24h for gateways and ledger changes.</li> <li>Emergency rollback target: &lt; 10 minutes (tag flip + health checks).</li> </ul>"},{"location":"60-infra/","title":"Infrastructure","text":"<p>This section documents deployment architectures for the Stalela Platform.</p> Option Services Monthly Cost Best For Free Stack Supabase \u00b7 Vercel \u00b7 Alibaba Cloud \u00b7 Resend \u00b7 GitHub Actions $0 \u2013 $20 Pilot, MVP, early production AWS Blueprint ECS Fargate \u00b7 RDS \u00b7 SNS/SQS \u00b7 CloudHSM \u00b7 S3 $800 \u2013 $2 500+ Scale-up, regulated production <p>Start with Free Stack</p> <p>The Free Stack is the recommended starting point. It covers all platform components (Payments Nucleus + Fiscal Platform) and costs nothing until you exceed free-tier limits. Migrate individual services to AWS when traffic or compliance requires it.</p>"},{"location":"60-infra/aws-infra/","title":"AWS Infrastructure Blueprint (Stalela Nucleus)","text":""},{"location":"60-infra/aws-infra/#general","title":"General","text":"<ul> <li>VPC (3 AZs); public subnets (ALB/NLB), private subnets (ECS/RDS), VPC endpoints (S3, SQS, SNS, Secrets Manager, ECR, CloudWatch).</li> <li>Compute: ECS Fargate (services + workers); cron via EventBridge Scheduler \u2192 Fargate tasks.</li> <li>Images/Artifacts: ECR; S3 for payloads/statement files (KMS-CMK).</li> <li>Config/Secrets: SSM Parameter Store + Secrets Manager (rotation); per-task IAM roles.</li> <li>CI/CD: GitHub Actions OIDC \u2192 AWS; ECR push; Terraform (<code>storo-infra</code>) apply.</li> <li>Observability: CloudWatch logs/metrics/alarms; OpenTelemetry to AMP/Managed Grafana; X-Ray optional.</li> <li>Security: ALB + WAF (public), internal ALBs; TLS (ACM); KMS on RDS/S3/SNS/SQS; least\u2011privilege SGs &amp; IAM.</li> </ul>"},{"location":"60-infra/aws-infra/#event-bus-outbox-crosscutting","title":"Event Bus &amp; Outbox (cross\u2011cutting)","text":"<ul> <li>Topics: SNS per domain (<code>transfers</code>, <code>ledger</code>, <code>recon</code>, <code>compliance</code>) with SQS subscriptions per consumer.</li> <li>Queues: SQS standard with DLQs; visibility timeout &gt; max handler time; redrive policy.</li> <li>Ordering (rare): SNS/SQS FIFO for specific flows.</li> <li>Scaling: ECS autoscale on SQS depth; alarms on outbox backlog and consumer lag.</li> <li>Replay: Outbox in RDS; DLQ replay runbooks.</li> </ul>"},{"location":"60-infra/aws-infra/#data-stores","title":"Data Stores","text":"<ul> <li>RDS Postgres (Multi\u2011AZ) per service (CTS, Ledger, Directory, Recon, Compliance); PITR; Performance Insights.</li> <li>S3 buckets per domain: <code>rail-artifacts</code>, <code>statements</code>, <code>raw-webhooks</code> (encryption, lifecycle, bucket policies).</li> <li>Optional: Elasticache Redis for hot lookups (Directory); OpenSearch only if needed for operator search.</li> </ul>"},{"location":"60-infra/aws-infra/#canonical-transfer-service-cts","title":"Canonical Transfer Service (CTS)","text":"<ul> <li>ECS Fargate behind public ALB (HTTPS, ACM). Private internal ALB for service\u2011to\u2011service where applicable.</li> <li>RDS <code>storo_cts</code> (transfers, transfer_events, outbox).</li> <li>NAT egress for partners as needed; prefer VPC endpoints for AWS services.</li> </ul>"},{"location":"60-infra/aws-infra/#rail-gateways-ecocash-mtnairtel-oppwa-zimswitch-payshap-usdcalgo","title":"Rail Gateways (EcoCash, MTN/Airtel, OPPWA, Zimswitch, PayShap, USDC/Algo)","text":"<ul> <li>ECS Fargate per gateway in private subnets; internal ALB.</li> <li>Public webhooks via dedicated public ALB + WAF, path <code>/webhooks/&lt;rail&gt;</code>.</li> <li>S3: raw payload snapshots; SQS DLQ for poison messages.</li> <li>Signing (USDC): CloudHSM or external signer; keys never leave enclave; task role scoped to signer.</li> <li>Partner connectivity: NAT egress; PrivateLink where supported.</li> </ul>"},{"location":"60-infra/aws-infra/#ledger-service","title":"Ledger Service","text":"<ul> <li>ECS Fargate + RDS <code>storo_ledger</code> (journals, postings, balances, outbox).</li> <li>SQS consumers for <code>transfers.accepted/settled/returned</code>; emit <code>ledger.*</code> to SNS.</li> <li>Internal ALB for read API; optional RDS Proxy; consider partitioning/archival strategy.</li> </ul>"},{"location":"60-infra/aws-infra/#compliance-screening","title":"Compliance Screening","text":"<ul> <li>ECS Fargate + RDS <code>storo_compliance</code>; S3 for list sources; EventBridge for scheduled refresh.</li> <li>Private ingress from CTS; alarms on index age; DLQ for ingest failures.</li> </ul>"},{"location":"60-infra/aws-infra/#directory-routing","title":"Directory &amp; Routing","text":"<ul> <li>ECS Fargate + RDS <code>storo_directory</code>; emits <code>directory.version.updated</code>.</li> <li>Optional Redis cache; internal <code>/routes</code> and <code>/calendars</code> APIs.</li> </ul>"},{"location":"60-infra/aws-infra/#reconciliation-returns","title":"Reconciliation &amp; Returns","text":"<ul> <li>S3 landing buckets per rail; S3 Put \u2192 SQS \u2192 ECS normalize workers.</li> <li>Recon service (ECS + RDS <code>storo_recon</code>) matches lines \u2192 emits <code>transfers.settled/returned</code>.</li> <li>EventBridge Scheduler for partner pulls; AWS Transfer Family for SFTP if required.</li> </ul>"},{"location":"60-infra/aws-infra/#operator-console","title":"Operator Console","text":"<ul> <li>Internal Next.js on ECS behind internal ALB; access via AWS VPN/Client VPN or Identity Center.</li> <li>Optionally CloudFront + WAF + Cognito/Identity Center for controlled external access.</li> </ul>"},{"location":"60-infra/aws-infra/#environments-regions","title":"Environments &amp; Regions","text":"<ul> <li>Separate AWS accounts: dev, staging, prod (Organizations, SCPs, guardrails).</li> <li>Region: af\u2011south\u20111 for ZA residency; assess ZW residency needs.</li> <li>Per\u2011env VPC stacks; ECR image promotion by tag; snapshot retention (35d), cross\u2011account copy for DR.</li> </ul>"},{"location":"60-infra/aws-infra/#ha-dr-backups","title":"HA, DR, Backups","text":"<ul> <li>RDS Multi\u2011AZ, PITR, snapshots; S3 versioning + lifecycle; SNS/SQS DLQs.</li> <li>ECS desired count \u2265 2 for critical services across 3 AZs; ALB health checks.</li> <li>Runbooks: DLQ drains, outbox replays, RDS failovers.</li> </ul>"},{"location":"60-infra/aws-infra/#cost-scaling","title":"Cost &amp; Scaling","text":"<ul> <li>Reduce NAT egress via VPC endpoints (S3 Gateway, SQS/SNS/SM/ECR/Logs interfaces).</li> <li>Autoscale: CPU/Memory + custom (SQS depth, publish lag).</li> <li>Fargate Spot for non\u2011critical batch workers (recon), if acceptable.</li> </ul>"},{"location":"60-infra/aws-infra/#networking-security","title":"Networking &amp; Security","text":"<ul> <li>SGs per service; no 0.0.0.0/0 on private tasks; WAF on public ALBs.</li> <li>IAM: per\u2011task roles; scoped access to S3 prefixes/SNS topics/SQS queues/KMS keys.</li> <li>Audit: CloudTrail, Config, GuardDuty, Security Hub; log retention per policy.</li> </ul>"},{"location":"60-infra/aws-infra/#pipeline-per-service","title":"Pipeline (per service)","text":"<ul> <li>Build: GitHub Actions \u2192 ECR.</li> <li>Deploy: Terraform plans/applies; ECS service update; one\u2011off migration task before rollout.</li> <li>Contract checks in CI using Fixtures; optional canary tasks; rollback via task set or previous image tag.</li> </ul>"},{"location":"60-infra/aws-infra/#serverless-pilot-option-a-lambda-api-gateway-aurora-serverless-v2","title":"Serverless Pilot (Option A) \u2014 Lambda + API Gateway + Aurora Serverless v2","text":"<ul> <li>Pilot decision: use API Gateway + Lambda, Aurora Serverless v2 (PostgreSQL) via RDS Proxy, SNS FIFO + SQS FIFO for events.</li> <li>Keep ECS guidance above for future non\u2011serverless services; pilot focuses on serverless for CTS and lightweight consumers.</li> </ul>"},{"location":"60-infra/aws-infra/#stacks-infra-repo-cdk","title":"Stacks (infra repo, CDK)","text":"<ul> <li>SharedVpcStack: VPC (2\u20133 AZs), private subnets for Lambdas + DB, NAT, interface endpoints (SQS/SNS/SM/Logs/ECR), SGs.</li> <li>DatabaseStack: Aurora Serverless v2 (min ACU 0.5\u20131, max 4), Multi\u2011AZ, RDS Proxy (IAM auth), parameter groups, Secrets Manager.</li> <li>EventingStack: SNS FIFO topic <code>events.transfers</code> with KMS; SQS FIFO DLQs and publish policy.</li> <li>ApiGatewayStack: API Gateway HTTP API (or REST if usage plans needed), WAF, stages, custom domain.</li> <li>ObservabilityStack: CloudWatch log groups, dashboards, alarms (p95, 5xx, SLO burn), X\u2011Ray.</li> <li>Outputs to SSM Parameter Store (per env):</li> <li><code>/storo/${env}/api/id</code>, <code>/storo/${env}/sns/events-transfers/arn</code>,</li> <li><code>/storo/${env}/rds/proxy/endpoint</code>, <code>/storo/${env}/rds/secret/arn</code>.</li> </ul>"},{"location":"60-infra/aws-infra/#service-stacks-service-repos-cdk","title":"Service stacks (service repos, CDK)","text":"<ul> <li>Import SSM parameters, then define:</li> <li>Lambdas: <code>cts-api</code>, <code>cts-outbox-worker</code>, optional <code>cts-inbound-consumer</code>.</li> <li>API routes on shared API (integration + route) using imported API ID.</li> <li>SQS FIFO queues subscribed to <code>events.transfers</code> (per consumer) with DLQs and alarms.</li> <li>IAM roles: scoped to publish to SNS, read SQS, connect via RDS Proxy, read secrets.</li> <li>Alarms/dashboards: p95, 5xx, queue lag, outbox failure rate, Lambda errors/throttles.</li> </ul>"},{"location":"60-infra/aws-infra/#eventing-ordering-dedupe","title":"Eventing (ordering &amp; dedupe)","text":"<ul> <li>SNS FIFO <code>events.transfers</code> with SQS FIFO subscribers per consumer.</li> <li>MessageGroupId = <code>transferId</code> (per\u2011key ordering), MessageDeduplicationId = <code>eventId</code>.</li> <li>DLQs: SQS standard per subscriber; 14d retention; runbooks for re\u2011drive.</li> </ul>"},{"location":"60-infra/aws-infra/#cdk-snippets-typescript","title":"CDK snippets (TypeScript)","text":"<p>Register a Lambda on the shared API: <pre><code>const apiId = ssm.StringParameter.valueForStringParameter(this, `/storo/${env}/api/id`);\nconst httpApi = apigwv2.HttpApi.fromHttpApiAttributes(this, 'SharedApi', { httpApiId: apiId });\nconst fn = new lambda.NodejsFunction(this, 'CtsApiFn', { vpc, vpcSubnets: { subnetType: ec2.SubnetType.PRIVATE_WITH_EGRESS },\n  environment: { RDS_PROXY_ENDPOINT: proxy.endpoint }, tracing: lambda.Tracing.ACTIVE });\nnew apigwv2i.HttpLambdaIntegration('CtsApiInt', fn);\nhttpApi.addRoutes({ path: '/transfers', methods: [apigwv2.HttpMethod.POST], integration: new apigwv2i.HttpLambdaIntegration('Int', fn) });\n</code></pre></p> <p>Subscribe SQS FIFO to SNS FIFO: <pre><code>const topicArn = ssm.StringParameter.valueForStringParameter(this, `/storo/${env}/sns/events-transfers/arn`);\nconst topic = sns.Topic.fromTopicArn(this, 'EventsTransfers', topicArn);\nconst q = new sqs.Queue(this, 'GatewayQueue', { fifo: true, contentBasedDeduplication: false });\nnew sns.Subscription(this, 'Sub', { topic, endpoint: q.queueArn, protocol: sns.SubscriptionProtocol.SQS,\n  rawMessageDelivery: true, deadLetterQueue: new sqs.Queue(this, 'DLQ') });\n</code></pre></p> <p>Outbox worker schedule: <pre><code>new events.Rule(this, 'OutboxSchedule', { schedule: events.Schedule.rate(cdk.Duration.minutes(1)),\n  targets: [new targets.LambdaFunction(outboxFn, { retryAttempts: 2 })] });\n</code></pre></p>"},{"location":"60-infra/aws-infra/#cicd-github-actions-with-oidc","title":"CI/CD (GitHub Actions with OIDC)","text":"<ul> <li>Jobs: lint/test \u2192 cdk synth \u2192 cdk diff \u2192 deploy dev \u2192 integration tests \u2192 promote stage/prod with approval.</li> <li>Migrations (Flyway/Liquibase) step runs against RDS Proxy before Lambda canary. <pre><code>permissions: { id-token: write, contents: read }\njobs:\n  deploy:\n    runs-on: ubuntu-latest\n    steps:\n      - uses: actions/checkout@v4\n      - uses: aws-actions/configure-aws-credentials@v4\n        with: { role-to-assume: arn:aws:iam::${{ secrets.AWS_ACCT }}:role/gh-oidc-cdk, aws-region: af-south-1 }\n      - run: npm ci &amp;&amp; npm run build &amp;&amp; npx cdk synth\n      - run: ./scripts/migrate.sh # runs flyway with RDS Proxy\n      - run: npx cdk deploy CtsServiceStack --require-approval never\n</code></pre></li> </ul>"},{"location":"60-infra/aws-infra/#deployment-order","title":"Deployment order","text":"<p>1) Infra repo: VPC \u2192 DB + Proxy \u2192 Eventing \u2192 API \u2192 Observability \u2192 write SSM params. 2) Service repos: migrations \u2192 Lambdas \u2192 API routes \u2192 SNS/SQS subs \u2192 alarms. 3) Canary release via CodeDeploy Lambda alias (10%/10m) \u2192 100%.</p>"},{"location":"60-infra/aws-infra/#security-cost-notes","title":"Security &amp; cost notes","text":"<ul> <li>IAM least\u2011privilege per Lambda; SGs restrict DB access to RDS Proxy.</li> <li>Secrets Manager rotation (90d); IAM auth to RDS Proxy where feasible.</li> <li>Aurora min/max ACU per env; reserved concurrency caps; long polling SQS; schedule down non\u2011prod at night.</li> </ul>"},{"location":"60-infra/free-stack/","title":"Free-Stack Architecture","text":"<p>$0 \u2013 $20 / month \u2014 pilot to early production on permanent free tiers.</p>"},{"location":"60-infra/free-stack/#service-inventory","title":"Service Inventory","text":"Service Tier Key Limits Role in Stalela Supabase Free 500 MB Postgres, 50 K MAU, 1 GB storage, 2 GB bandwidth Database (all schemas), Auth, Webhooks, Cron Fly.io Free (Hobby) 3 shared-cpu-1x VMs, 256 MB RAM each, 3 GB persistent volumes Go service containers (CTS, Ledger, Fiscal) Alibaba Cloud Free trial \u2192 pay-as-you-go KMS 20 K API calls/mo free, OSS 5 GB HSM-backed fiscal signing, archival/backup Resend Free 100 emails/day, 3 000/month Receipts, DLQ/SLO alerts GitHub Enterprise Already licensed Unlimited Actions minutes (self-hosted), Packages, Dependabot CI/CD, container registry, security scanning"},{"location":"60-infra/free-stack/#deployment-topology","title":"Deployment Topology","text":"<pre><code>graph TB\n    subgraph \"Fly.io (Go Containers)\"\n        CTS[\"CTS Service&lt;br/&gt;:8080 go-chi\"]\n        LEDGER[\"Ledger Service&lt;br/&gt;:8081 go-chi\"]\n        FISCAL[\"Fiscal Service&lt;br/&gt;:8082 go-chi\"]\n    end\n\n    subgraph \"Supabase\"\n        DB[(\"PostgreSQL 15&lt;br/&gt;All schemas\")]\n        AUTH[\"Auth (GoTrue)&lt;br/&gt;JWT\"]\n        CRON[\"pg_cron&lt;br/&gt;2 scheduled jobs\"]\n        PGNET[\"pg_net&lt;br/&gt;HTTP from SQL\"]\n    end\n\n    subgraph \"Alibaba Cloud\"\n        KMS[\"KMS&lt;br/&gt;HSM-backed signing\"]\n        OSS[\"OSS&lt;br/&gt;Fiscal archive\"]\n    end\n\n    subgraph \"Resend\"\n        EMAIL[\"Transactional Email&lt;br/&gt;Receipts \u00b7 Alerts\"]\n    end\n\n    subgraph \"GitHub\"\n        GHA[\"Actions CI/CD\"]\n        GHCR[\"Container Registry\"]\n    end\n\n    CTS --&gt; DB\n    LEDGER --&gt; DB\n    FISCAL --&gt; DB\n    FISCAL --&gt; KMS\n    CTS --&gt; LEDGER\n    CRON --&gt; PGNET\n    PGNET --&gt; CTS &amp; FISCAL &amp; OSS &amp; EMAIL\n    GHA --&gt; GHCR\n    GHCR --&gt; CTS &amp; LEDGER &amp; FISCAL</code></pre>"},{"location":"60-infra/free-stack/#component-mapping-payments-nucleus","title":"Component Mapping \u2014 Payments Nucleus","text":"<p>Every Nucleus component is a Go service deployed as a Docker container on Fly.io, backed by Supabase Postgres.</p> Component Runtime Storage Events Notes Canonical Transfer Service Go container on Fly.io <code>:8080</code> <code>payments.transfers</code>, <code>payments.transfer_events</code>, <code>payments.outbox</code> Outbox \u2192 SNS (LocalStack dev) / pg_net (prod) go-chi router, JWT auth, rate-limit middleware Outbox Publisher Goroutine in CTS process <code>payments.outbox</code> table Exponential backoff 1 s \u2192 16 h; DLQ at 10 attempts Replaces external message broker Rail Gateways Go modules in <code>gateways/</code> <code>payments.transfers</code> Called by CTS via internal routing ZimSwitch, OPPWA, M-Pesa, EcoCash, Algorand Ledger Service Go container on Fly.io <code>:8081</code> <code>ledger.journal_entries</code>, <code>ledger.balances</code> SQS consumer (dev) / pg_net webhook (prod) Double-entry, balance validation Compliance Screening Go service <code>services/compliance/</code> <code>compliance.screening_results</code> Circuit-breaker adapter (gobreaker) Sanctions list cached in-memory Directory &amp; Routing Go module in CTS <code>directory.directory_entries</code> \u2014 Route cache TTL 5 m, negative-cache TTL 45 s Reconciliation pg_cron trigger \u2192 Go endpoint <code>payments.recon_sessions</code> Scheduled (daily) Match internal vs bank statement Platform Base JWT middleware in Go <code>public.tenants</code>, <code>public.users</code> \u2014 Multi-tenant via <code>tenant_id</code> in JWT claims"},{"location":"60-infra/free-stack/#component-mapping-fiscal-platform","title":"Component Mapping \u2014 Fiscal Platform","text":"Component Runtime Storage Events Notes Invoicing API Go container on Fly.io <code>:8082</code> <code>fiscal.invoices</code>, <code>fiscal.invoice_items</code> Internal event after signing Canonical payload validation Serializer In Fiscal Service (same process) \u2014 \u2014 JSON \u2192 canonical byte string (deterministic key order) Tax Engine Go module <code>internal/tax/</code> <code>tax.jurisdiction_profiles</code>, <code>tax.tax_groups</code> \u2014 14 tax groups (DRC TG01\u2013TG14), 5 client classifications Cloud Signing Service Go module <code>internal/signing/</code> \u2192 Alibaba KMS <code>signing.signing_log</code> Called after serialization Local RSA for dev, Alibaba KMS for prod Monotonic Counter Go module <code>internal/counter/</code> <code>fiscal.fiscal_counters</code> \u2014 <code>pg_advisory_xact_lock</code> per outlet Hash-Chained Ledger Go module <code>internal/ledger/</code> <code>fiscal.fiscal_ledger</code> \u2014 <code>prev_hash</code> column; append-only, tamper-evident Report Generator pg_cron \u2192 Go endpoint <code>fiscal.reports</code> Scheduled (daily) Z-reports, periodic summaries Tax Authority Sync Go service <code>services/sync/</code> <code>sync.authority_sync_queue</code> Scheduled (every 5 min) DGI protocol (DRC); jurisdiction-specific Receipt Delivery Go via <code>libs/email/</code> \u2192 Resend API <code>fiscal.receipt_log</code> After signing completes Email receipt link Verification Portal Future: static site or Go handler <code>fiscal.invoices</code> (public read) \u2014 QR code \u2192 verify endpoint Merchant Registry Go CRUD in Fiscal Service <code>fiscal.merchants</code>, <code>fiscal.outlets</code> \u2014 Managed via API Archival / Backup pg_cron \u2192 pg_net \u2192 Alibaba OSS OSS bucket Nightly 10-year retention for fiscal data"},{"location":"60-infra/free-stack/#supabase-schema-layout","title":"Supabase Schema Layout","text":"<p>All services share a single Postgres database organized by schema:</p> <pre><code>stalela_db (Supabase project)\n\u251c\u2500\u2500 public                    # Shared: tenants, users, auth helpers\n\u251c\u2500\u2500 payments                  # CTS: transfers, transfer_events, outbox\n\u251c\u2500\u2500 ledger                    # Journal entries, balances, chart of accounts\n\u251c\u2500\u2500 compliance                # Screening results, sanctions lists\n\u251c\u2500\u2500 directory                 # Alias \u2192 rail routing\n\u251c\u2500\u2500 recon                     # Recon sessions, matched/unmatched lines\n\u251c\u2500\u2500 rails                     # Rail configs, callback logs\n\u251c\u2500\u2500 fiscal                    # Invoices, items, fiscal_ledger, counters\n\u251c\u2500\u2500 tax                       # Jurisdiction profiles, tax groups\n\u251c\u2500\u2500 signing                   # Signing log, key metadata\n\u251c\u2500\u2500 reports                   # Z-reports, periodic summaries\n\u251c\u2500\u2500 sync                      # Authority sync queue, ack log\n\u251c\u2500\u2500 storage                   # Supabase Storage metadata (managed)\n\u2514\u2500\u2500 auth                      # Supabase Auth tables (managed)\n</code></pre> <p>~25 application tables across all schemas. Key tables:</p> Schema Table Purpose <code>payments</code> <code>transfers</code> Transfer lifecycle (state machine) <code>payments</code> <code>transfer_events</code> Append-only event log per transfer <code>payments</code> <code>outbox</code> Transactional outbox for at-least-once delivery <code>ledger</code> <code>journal_entries</code> Double-entry postings <code>ledger</code> <code>balances</code> Materialized account balances <code>compliance</code> <code>screening_results</code> Per-transfer compliance checks <code>directory</code> <code>directory_entries</code> Alias \u2192 route resolution <code>recon</code> <code>recon_sessions</code> Daily reconciliation runs <code>fiscal</code> <code>invoices</code> Fiscal invoices (all jurisdictions) <code>fiscal</code> <code>fiscal_ledger</code> Hash-chained, append-only ledger <code>fiscal</code> <code>fiscal_counters</code> Monotonic counter per outlet <code>tax</code> <code>jurisdiction_profiles</code> Country-specific tax configuration <code>signing</code> <code>signing_log</code> Audit trail for every KMS sign call <code>sync</code> <code>authority_sync_queue</code> Pending items for tax authority push"},{"location":"60-infra/free-stack/#row-level-security-rls","title":"Row-Level Security (RLS)","text":"<p>Every table has RLS enabled. Policies enforce:</p> <ul> <li>Tenant isolation: <code>WHERE tenant_id = auth.jwt() -&gt;&gt; 'tenant_id'</code></li> <li>Role-based access: <code>USING (role_check(auth.uid(), required_role))</code></li> <li>Outlet scoping: Fiscal tables additionally filter by <code>outlet_id</code></li> </ul>"},{"location":"60-infra/free-stack/#event-flow-outbox-pattern","title":"Event Flow \u2014 Outbox Pattern","text":"<p>Go services use the transactional outbox pattern. In the free stack, pg_net replaces SNS/SQS for inter-service communication:</p> <pre><code>sequenceDiagram\n    participant Client\n    participant CTS as CTS (Fly.io :8080)\n    participant DB as Supabase Postgres\n    participant PGNET as pg_net (pg_cron)\n    participant Ledger as Ledger (Fly.io :8081)\n\n    Client-&gt;&gt;CTS: POST /v1/transfers\n    CTS-&gt;&gt;DB: INSERT transfer + outbox row (single tx)\n    Note over DB: pg_cron fires every 60 s\n    DB-&gt;&gt;PGNET: SELECT unsent outbox rows\n    PGNET-&gt;&gt;Ledger: POST /v1/events (HTTP)\n    Ledger-&gt;&gt;DB: INSERT journal_entries + balances (single tx)\n    Ledger--&gt;&gt;PGNET: 200 OK\n    PGNET-&gt;&gt;DB: UPDATE outbox SET delivered</code></pre>"},{"location":"60-infra/free-stack/#delivery-guarantees","title":"Delivery Guarantees","text":"Concern Solution At-least-once Outbox pattern: pg_cron retries unsent rows every 60 s Idempotency <code>idempotency_key</code> on transfers; <code>event_id</code> on events Ordering Single DB, sequential <code>event_id</code> per transfer Dead letters <code>outbox.retry_count</code>; after 5 failures \u2192 <code>status = 'dead'</code>, alert via Resend Webhook failure pg_net retries; pg_cron re-processes unsent rows"},{"location":"60-infra/free-stack/#pg_cron-job-schedule","title":"pg_cron Job Schedule","text":"<p>Supabase free tier allows 2 cron jobs. We multiplex:</p> Slot Schedule Job Details 1 <code>* * * * *</code> (every minute) Outbox retry + GC Retry unsent outbox rows; GC delivered rows older than 7 d 2 <code>*/5 * * * *</code> (every 5 min) Tax authority sync + Archive trigger Push pending fiscal events to authority; nightly: archive to Alibaba OSS <p>The second job checks a <code>cron_tasks</code> table to decide which sub-task to run, enabling more than 2 logical jobs within the 2-slot limit.</p>"},{"location":"60-infra/free-stack/#signing-service-alibaba-kms","title":"Signing Service \u2014 Alibaba KMS","text":"<pre><code>sequenceDiagram\n    participant API as Fiscal Service (Fly.io :8082)\n    participant SER as internal/signing\n    participant KMS as Alibaba KMS\n    participant DB as Supabase Postgres\n\n    API-&gt;&gt;SER: Canonical payload \u2192 byte string\n    SER-&gt;&gt;KMS: kms:Sign(keyId, digest, algorithm)\n    KMS--&gt;&gt;SER: Signature (base64)\n    SER-&gt;&gt;DB: INSERT fiscal_ledger (prev_hash chain)\n    SER-&gt;&gt;DB: INSERT signing_log (audit)\n    SER--&gt;&gt;API: Signed invoice response</code></pre> <ul> <li>Key type: RSA_2048 or EC_P256 (jurisdiction-dependent)</li> <li>Key rotation: Annually; old key versions kept for verification</li> <li>Cost: 20 000 free API calls/month; ~$0.03 per 10 000 calls after that</li> <li>Fallback: If KMS is unreachable, queue invoice for retry (max 15 min before alert)</li> </ul>"},{"location":"60-infra/free-stack/#monorepo-structure","title":"Monorepo Structure","text":"<pre><code>stalela/\n\u251c\u2500\u2500 services/\n\u2502   \u251c\u2500\u2500 transfer/               # CTS \u2014 go-chi :8080\n\u2502   \u2502   \u251c\u2500\u2500 cmd/server/         # main.go entrypoint\n\u2502   \u2502   \u251c\u2500\u2500 internal/           # api, state, outbox, normalizer, etc.\n\u2502   \u2502   \u251c\u2500\u2500 migrations/         # golang-migrate SQL files\n\u2502   \u2502   \u251c\u2500\u2500 Dockerfile          # Multi-stage build\n\u2502   \u2502   \u2514\u2500\u2500 fly.toml            # Fly.io deployment config\n\u2502   \u251c\u2500\u2500 ledger/                 # Ledger Service \u2014 go-chi :8081\n\u2502   \u2502   \u251c\u2500\u2500 cmd/server/\n\u2502   \u2502   \u251c\u2500\u2500 internal/           # consumer, posting, journal, balance, etc.\n\u2502   \u2502   \u251c\u2500\u2500 migrations/\n\u2502   \u2502   \u251c\u2500\u2500 Dockerfile\n\u2502   \u2502   \u2514\u2500\u2500 fly.toml\n\u2502   \u251c\u2500\u2500 fiscal/                 # Fiscal Service \u2014 go-chi :8082\n\u2502   \u2502   \u251c\u2500\u2500 cmd/server/\n\u2502   \u2502   \u251c\u2500\u2500 internal/           # signing, counter, ledger, tax, etc.\n\u2502   \u2502   \u251c\u2500\u2500 migrations/\n\u2502   \u2502   \u251c\u2500\u2500 Dockerfile\n\u2502   \u2502   \u2514\u2500\u2500 fly.toml\n\u2502   \u251c\u2500\u2500 compliance/             # Compliance screening (stub)\n\u2502   \u2514\u2500\u2500 sync/                   # Tax Authority Sync Agent (stub)\n\u251c\u2500\u2500 gateways/\n\u2502   \u251c\u2500\u2500 zimswitch/              # ZimSwitch rail adapter\n\u2502   \u251c\u2500\u2500 oppwa/                  # OPPWA (card) adapter\n\u2502   \u251c\u2500\u2500 mpesa/                  # M-Pesa adapter\n\u2502   \u251c\u2500\u2500 ecocash/                # EcoCash adapter\n\u2502   \u2514\u2500\u2500 algorand/               # Algorand adapter\n\u251c\u2500\u2500 libs/\n\u2502   \u251c\u2500\u2500 crypto/                 # PII encryption, HMAC\n\u2502   \u251c\u2500\u2500 logging/                # Structured logging (slog)\n\u2502   \u2514\u2500\u2500 email/                  # Resend client wrapper\n\u251c\u2500\u2500 apps/\n\u2502   \u2514\u2500\u2500 gateway/                # API gateway (future)\n\u251c\u2500\u2500 tests/                      # Cross-service integration tests\n\u251c\u2500\u2500 tools/devstack/             # docker-compose (Postgres, LocalStack)\n\u251c\u2500\u2500 .github/workflows/          # CI: ci.yml, transfer-ci.yml, etc.\n\u251c\u2500\u2500 go.work                     # Go workspace (15 modules)\n\u2514\u2500\u2500 Makefile                    # build-all, test-all, lint-all, migrate-all\n</code></pre> <p>Tech stack: Go 1.24 \u00b7 go-chi/chi \u00b7 pgx/v5 \u00b7 golang-migrate \u00b7 OpenTelemetry \u00b7 Prometheus \u00b7 testcontainers-go</p>"},{"location":"60-infra/free-stack/#cicd-pipeline-github-actions","title":"CI/CD Pipeline \u2014 GitHub Actions","text":"<pre><code>graph LR\n    PR[\"Pull Request\"] --&gt; LINT[\"golangci-lint\"]\n    LINT --&gt; TEST[\"Unit Tests (race)\"]\n    TEST --&gt; INTEG[\"Integration Tests&lt;br/&gt;(testcontainers)\"]\n    INTEG --&gt; MIG[\"Migration Check&lt;br/&gt;(up/down pairs)\"]\n    MIG --&gt; GATE[\"CI Status Gate\"]\n    GATE --&gt; MERGE[\"Merge to main\"]\n    MERGE --&gt; BUILD[\"Docker Build&lt;br/&gt;(GHCR)\"]\n    BUILD --&gt; DEPLOY[\"fly deploy&lt;br/&gt;(per service)\"]\n    DEPLOY --&gt; SMOKE[\"Health Check\"]</code></pre> <p>Key pipeline steps:</p> <ol> <li>PR opened \u2192 golangci-lint, unit tests with <code>-race</code>, integration tests via testcontainers</li> <li>Migration check \u2192 validate all <code>.up.sql</code> have matching <code>.down.sql</code></li> <li>CI Status Gate \u2192 all jobs must pass before merge</li> <li>Merge to main \u2192 Docker multi-stage build \u2192 push to GitHub Container Registry</li> <li>Deploy \u2192 <code>fly deploy</code> per service (CTS, Ledger, Fiscal)</li> <li>Smoke tests \u2192 <code>/healthz</code> and <code>/readyz</code> endpoint checks</li> </ol>"},{"location":"60-infra/free-stack/#flyio-deployment","title":"Fly.io Deployment","text":"<p>Each service has a <code>fly.toml</code> that defines:</p> <ul> <li>VM size: <code>shared-cpu-1x</code> (free tier)</li> <li>Memory: 256 MB</li> <li>Internal port: service-specific (8080, 8081, 8082)</li> <li>Health check: <code>/healthz</code> HTTP endpoint</li> <li>Env vars: <code>CTS_DATABASE_URL</code>, <code>LEDGER_DATABASE_URL</code>, etc. (set via <code>fly secrets</code>)</li> <li>Region: <code>iad</code> (US East) to match Supabase region</li> </ul>"},{"location":"60-infra/free-stack/#cost-breakdown","title":"Cost Breakdown","text":"Service Free Tier When You Pay Estimated at Scale Supabase 500 MB DB, 50 K MAU, 2 GB bandwidth &gt; 500 MB DB or &gt; 50 K MAU Pro $25/mo Fly.io 3 shared VMs, 256 MB each &gt; 3 VMs or need dedicated CPU ~$5 \u2013 $15/mo per extra VM Alibaba KMS 20 K sign calls/month &gt; 20 K calls ~$0.03 / 10 K calls Alibaba OSS 5 GB storage &gt; 5 GB ~$0.02 / GB / month Resend 3 000 emails/month &gt; 3 000 emails $20/mo (50 K emails) GitHub Enterprise Unlimited (licensed) \u2014 Already paid Total $0 Pilot traffic $25 \u2013 $70 /mo <p>Pilot Capacity</p> <p>At free-tier limits, you can handle approximately:</p> <ul> <li>1 000 transfers/day (CTS + ledger + outbox)</li> <li>500 fiscal invoices/day (signing + hash chain + authority sync)</li> <li>100 email receipts/day (Resend)</li> <li>3 concurrent Go services on Fly.io free tier</li> </ul>"},{"location":"60-infra/free-stack/#scale-up-path","title":"Scale-Up Path","text":"<p>When free-tier limits are exceeded, services can be upgraded independently:</p> Trigger Action Cost Impact DB &gt; 500 MB Upgrade Supabase to Pro +$25/mo Need dedicated CPU Upgrade Fly.io VMs +$5 \u2013 $30/mo Signing &gt; 20 K/mo Alibaba KMS pay-as-you-go +$3 \u2013 $10/mo Emails &gt; 3 K/mo Resend Growth plan +$20/mo Need message broker Add Upstash Kafka or QStash +$10 \u2013 $30/mo Need dedicated DB Migrate to Supabase Pro or Neon +$25 \u2013 $69/mo Regulatory/compliance Migrate to AWS (see AWS Blueprint) $800+ /mo <p>The architecture is designed so that each component can migrate independently \u2014 start with Supabase + Fly.io, move individual services to AWS ECS Fargate as needed.</p>"},{"location":"60-infra/free-stack/#comparison-aws-vs-free-stack","title":"Comparison: AWS vs Free Stack","text":"Dimension Free Stack AWS Blueprint Monthly cost $0 \u2013 $70 $800 \u2013 $2 500+ Setup time Hours Weeks Operational burden Minimal (managed services) High (VPC, IAM, monitoring) Runtime Fly.io Docker containers ECS Fargate Database Supabase Postgres (shared) RDS Multi-AZ per service Events Outbox + pg_cron/pg_net SNS/SQS FIFO Signing Alibaba KMS AWS CloudHSM Auth JWT middleware in Go Cognito / custom CDN/Edge Fly.io Anycast CloudFront + WAF CI/CD GitHub Actions \u2192 Fly.io GitHub Actions + CDK Multi-AZ HA Fly.io multi-region (paid) Self-configured Data residency Supabase region + Fly.io region af-south-1 (Cape Town) Best for Pilot, MVP, &lt; 10 K txn/day Regulated production, &gt; 10 K txn/day <p>Production Readiness</p> <p>The free stack is suitable for pilot and early production. Before processing high-volume regulated traffic, evaluate:</p> <ul> <li>Data residency requirements per jurisdiction</li> <li>SLA guarantees (Supabase free tier has no SLA)</li> <li>Backup/DR testing</li> <li>Penetration testing on the full stack</li> </ul>"},{"location":"70-sprints/epics-and-stories/","title":"Stalela Platform \u2014 Unified Epic Board","text":"<p>Two pillars, one free stack. Kanban board tracking all epics across Payments Nucleus + Fiscal Platform. Stack: Supabase \u00b7 Vercel \u00b7 Alibaba KMS \u00b7 Resend \u00b7 GitHub Actions</p> <p>Columns: Backlog \u2192 Selected for Dev \u2192 In Progress \u2192 Testing \u2192 Done</p>"},{"location":"70-sprints/epics-and-stories/#in-progress","title":"In Progress","text":"<p>Epics actively being implemented in Sprint 001.</p>"},{"location":"70-sprints/epics-and-stories/#plat-01-monorepo-supabase-setup","title":"PLAT-01 \u00b7 Monorepo &amp; Supabase Setup","text":"Field Value Pillar Platform (shared) Sprint 001 Owner Sprint Master Dependencies None (foundation) Links Free Stack, Sprint 001 <p>Tasks</p> <ul> <li>[ ] Scaffold Turborepo monorepo (<code>apps/api</code>, <code>apps/console</code>, <code>packages/*</code>)</li> <li>[ ] Create Supabase project; enable <code>pg_cron</code>, <code>pg_net</code>, <code>pgcrypto</code> extensions</li> <li>[ ] Create schemas: <code>payments</code>, <code>ledger</code>, <code>fiscal</code>, <code>tax</code>, <code>signing</code>, <code>sync</code>, <code>compliance</code>, <code>directory</code>, <code>recon</code>, <code>rails</code></li> <li>[ ] Configure Supabase Auth (email + API key strategy)</li> <li>[ ] Set up RLS policies for <code>tenant_id</code> isolation on all tables</li> <li>[ ] Wire Vercel project to monorepo; configure <code>apps/api</code> for Serverless Functions</li> <li>[ ] Configure Resend + create <code>packages/email</code> wrapper</li> </ul>"},{"location":"70-sprints/epics-and-stories/#plat-02-cicd-pipeline","title":"PLAT-02 \u00b7 CI/CD Pipeline","text":"Field Value Pillar Platform (shared) Sprint 001 Owner Sprint Master Dependencies PLAT-01 Links Free Stack \u2014 CI/CD <p>Tasks</p> <ul> <li>[ ] GitHub Actions: lint \u2192 type-check \u2192 unit tests \u2192 Vercel preview deploy</li> <li>[ ] Supabase migration workflow: <code>supabase db push</code> on merge to <code>main</code></li> <li>[ ] Contract validation step (golden fixtures for transfer + invoice payloads)</li> <li>[ ] PR preview deployments via Vercel</li> </ul>"},{"location":"70-sprints/epics-and-stories/#plat-03-specs-contracts","title":"PLAT-03 \u00b7 Specs &amp; Contracts","text":"Field Value Pillar Platform (shared) Sprint 001 Owner Sprint Master + Developer Dependencies None Links Events spec, API spec <p>Tasks</p> <ul> <li>[ ] Finalize event envelope v1 (<code>events.md</code>) with <code>\"v\": 1</code> field</li> <li>[ ] Canonical Transfer API contract (<code>POST /api/transfers</code>, <code>GET /api/transfers/:id</code>)</li> <li>[ ] Canonical Invoice API contract (<code>POST /api/invoices</code>, <code>GET /api/invoices/:id</code>)</li> <li>[ ] Posting rules linked into ledger service</li> <li>[ ] ADR: Outbox pattern on Supabase DB Webhooks (PAY-ADR-0001 update)</li> <li>[ ] ADR: Alibaba KMS as signing provider (FIS-ADR-0007)</li> </ul>"},{"location":"70-sprints/epics-and-stories/#pay-01-canonical-transfer-service-cts","title":"PAY-01 \u00b7 Canonical Transfer Service (CTS)","text":"Field Value Pillar Payments Nucleus Sprint 001 Owner Developer Dependencies PLAT-01 (Supabase), PLAT-03 (contracts) Links CTS component, API spec <p>Tasks</p> <ul> <li>[ ] <code>POST /api/transfers</code>: validate, normalize, INSERT into <code>payments.transfers</code> + <code>payments.outbox</code> (single tx)</li> <li>[ ] <code>GET /api/transfers/:id</code>: return transfer state + event timeline</li> <li>[ ] Idempotency middleware (<code>Idempotency-Key</code> header + body hash)</li> <li>[ ] Structured logging (transferId, tenantId, correlationId)</li> <li>[ ] Health endpoints: <code>/api/health/live</code>, <code>/api/health/ready</code></li> </ul>"},{"location":"70-sprints/epics-and-stories/#pay-02-outbox-event-bus-db-webhooks","title":"PAY-02 \u00b7 Outbox &amp; Event Bus (DB Webhooks)","text":"Field Value Pillar Payments Nucleus Sprint 001 Owner Sprint Master Dependencies PAY-01, PLAT-01 Links Event Bus, Free Stack \u2014 Event Flow <p>Tasks</p> <ul> <li>[ ] Supabase Database Webhook: on <code>payments.outbox</code> INSERT \u2192 fire HTTP to rail gateway endpoint</li> <li>[ ] pg_cron job (slot 1): retry unsent outbox rows every 60 s; GC delivered rows &gt; 7 d</li> <li>[ ] <code>outbox.retry_count</code> + dead-letter logic (after 5 failures \u2192 <code>status = 'dead'</code>, Resend alert)</li> <li>[ ] Webhook on <code>payments.transfer_events</code> INSERT \u2192 advance transfer state machine</li> </ul>"},{"location":"70-sprints/epics-and-stories/#pay-03-ledger-service-sql-triggers","title":"PAY-03 \u00b7 Ledger Service (SQL Triggers)","text":"Field Value Pillar Payments Nucleus Sprint 001 Owner Sprint Master Dependencies PAY-01 Links Ledger Service, Posting Rules <p>Tasks</p> <ul> <li>[ ] Create <code>ledger.journal_entries</code> + <code>ledger.balances</code> tables with double-entry constraints</li> <li>[ ] SQL trigger: on <code>transfer_events</code> state change \u2192 INSERT journal entries (debit/credit)</li> <li>[ ] <code>GET /api/balances</code>: return materialized balances per account</li> <li>[ ] Idempotent posting by (transferId, eventType)</li> </ul>"},{"location":"70-sprints/epics-and-stories/#fis-01-cloud-signing-service-alibaba-kms","title":"FIS-01 \u00b7 Cloud Signing Service (Alibaba KMS)","text":"Field Value Pillar Fiscal Platform Sprint 001 Owner Developer Dependencies PLAT-01 (Supabase), Alibaba Cloud account Links Trust Boundary, Components, Free Stack \u2014 Signing <p>Tasks</p> <ul> <li>[ ] Provision Alibaba KMS key (RSA-2048 or EC_P256 per jurisdiction config)</li> <li>[ ] Create <code>packages/signing</code> wrapper: <code>sign(digest)</code> \u2192 base64 signature, <code>verify(digest, sig)</code></li> <li>[ ] Monotonic Counter: <code>fiscal.fiscal_counters</code> with <code>pg_advisory_xact_lock</code> + <code>nextval()</code> per outlet</li> <li>[ ] Signing pipeline: serialize canonical payload \u2192 SHA-256 digest \u2192 <code>kms:Sign</code> \u2192 return signature</li> <li>[ ] INSERT into <code>signing.signing_log</code> (audit trail for every KMS call)</li> <li>[ ] Integration test: sign + verify round-trip</li> </ul>"},{"location":"70-sprints/epics-and-stories/#fis-02-invoicing-api-tax-engine","title":"FIS-02 \u00b7 Invoicing API + Tax Engine","text":"Field Value Pillar Fiscal Platform Sprint 001 Owner Developer Dependencies FIS-01 (Signing), PLAT-01 (Supabase) Links Tax Engine, Cloud API, DRC Tax Groups <p>Tasks</p> <ul> <li>[ ] <code>POST /api/invoices</code>: validate canonical payload (deterministic field ordering, required keys)</li> <li>[ ] Tax Engine: enforce jurisdiction-configured tax groups (DRC: TG01-TG14), client classifications, rounding rules</li> <li>[ ] Route validated payload to signing pipeline; return sealed response with 5 security elements</li> <li>[ ] Rate limiting (100 req/s per API key) + idempotency keys</li> <li>[ ] Actionable error responses for validation failures</li> <li>[ ] <code>GET /api/invoices/:id</code>: return sealed invoice</li> </ul>"},{"location":"70-sprints/epics-and-stories/#fis-03-fiscal-ledger-hash-chained","title":"FIS-03 \u00b7 Fiscal Ledger (Hash-Chained)","text":"Field Value Pillar Fiscal Platform Sprint 001 Owner Sprint Master Dependencies FIS-01 (Signing) Links Data Flow, Reports <p>Tasks</p> <ul> <li>[ ] <code>fiscal.fiscal_ledger</code> table: append-only, <code>prev_hash</code> column for chain integrity</li> <li>[ ] SQL trigger: on INSERT, compute <code>hash = SHA256(prev_hash || payload)</code> and set <code>prev_hash</code></li> <li>[ ] Void / refund / credit note create new fiscal events (never delete)</li> <li>[ ] Chain integrity verification function: walk ledger, verify all hashes</li> </ul>"},{"location":"70-sprints/epics-and-stories/#selected-for-development","title":"Selected for Development","text":"<p>Epics approved for Sprint 002.</p>"},{"location":"70-sprints/epics-and-stories/#pay-04-rail-gateway-ecocash","title":"PAY-04 \u00b7 Rail Gateway \u2014 EcoCash","text":"Field Value Pillar Payments Nucleus Sprint 002 Owner Developer Dependencies PAY-01 (CTS), PAY-02 (Webhooks) Links EcoCash Gateway <p>Tasks</p> <ul> <li>[ ] <code>POST /api/rails/ecocash/submit</code>: initiate STK push via EcoCash API</li> <li>[ ] <code>POST /api/rails/ecocash/callback</code>: receive payment confirmation webhook</li> <li>[ ] Emit <code>transfer_events</code> (accepted/settled/failed) on callback</li> <li>[ ] Timeout handling: if no callback within 5 min \u2192 mark <code>timed_out</code></li> <li>[ ] Mock mode for dev/staging environments</li> </ul>"},{"location":"70-sprints/epics-and-stories/#pay-05-compliance-screening","title":"PAY-05 \u00b7 Compliance Screening","text":"Field Value Pillar Payments Nucleus Sprint 002 Owner Sprint Master Dependencies PAY-01 Links Compliance <p>Tasks</p> <ul> <li>[ ] <code>compliance.screening_lists</code> table (cached sanctions data)</li> <li>[ ] Pre-transfer middleware: screen sender/receiver against lists</li> <li>[ ] <code>compliance.screening_results</code> table for audit trail</li> <li>[ ] Block or flag transfers based on match confidence</li> </ul>"},{"location":"70-sprints/epics-and-stories/#pay-06-directory-routing","title":"PAY-06 \u00b7 Directory &amp; Routing","text":"Field Value Pillar Payments Nucleus Sprint 002 Owner Developer Dependencies PAY-01 Links Directory <p>Tasks</p> <ul> <li>[ ] <code>directory.directory_entries</code> table (alias \u2192 rail + account mapping)</li> <li>[ ] <code>GET /api/directory?alias=...</code>: lookup with 400 ms timeout</li> <li>[ ] Cache layer (in-memory or Supabase materialized view)</li> <li>[ ] Integrate into CTS transfer submission flow</li> </ul>"},{"location":"70-sprints/epics-and-stories/#fis-04-web-dashboard-mvp","title":"FIS-04 \u00b7 Web Dashboard MVP","text":"Field Value Pillar Fiscal Platform Sprint 002 Owner Developer Dependencies FIS-02 (API), PLAT-01 (Auth) Links Dashboard, Multi-User <p>Tasks</p> <ul> <li>[ ] Scaffold Next.js PWA (<code>apps/console</code>) with Supabase Auth + Realtime</li> <li>[ ] Invoice CRUD: create, view, filter, void with status tracking</li> <li>[ ] Outlet registration + configuration UI</li> <li>[ ] User management + API key management with RBAC (Cashier, Supervisor, Manager, Owner)</li> <li>[ ] Z/X/A report generation and download</li> <li>[ ] Offline indicators for queued drafts</li> <li>[ ] Bilingual support (French / English)</li> </ul>"},{"location":"70-sprints/epics-and-stories/#fis-05-javascript-python-sdk","title":"FIS-05 \u00b7 JavaScript &amp; Python SDK","text":"Field Value Pillar Fiscal Platform Sprint 002 Owner Developer Dependencies FIS-02 (API) Links Invoicing SDK, Cloud API <p>Tasks</p> <ul> <li>[ ] Scaffold JS and Python SDK packages with typed request/response models</li> <li>[ ] Implement offline queue (IndexedDB for browser, SQLite for native)</li> <li>[ ] Tax engine helpers for building valid <code>tax_groups</code> and <code>tax_summary</code> arrays</li> <li>[ ] Event callbacks for queue state transitions (synced, failed, grace exceeded)</li> <li>[ ] Publish packages and quickstart docs</li> </ul>"},{"location":"70-sprints/epics-and-stories/#fis-06-fiscal-reports","title":"FIS-06 \u00b7 Fiscal Reports","text":"Field Value Pillar Fiscal Platform Sprint 002 Owner Sprint Master Dependencies FIS-03 (Ledger) Links Reports <p>Tasks</p> <ul> <li>[ ] Report Generator: Z reports (daily close), X reports (shift close), A reports (periodic audit)</li> <li>[ ] Vercel Cron trigger for daily Z-report generation</li> <li>[ ] Audit export endpoint (JSON + CSV) with fiscal number ranges and tax group totals</li> <li>[ ] Verify hash-chain integrity on report generation</li> </ul>"},{"location":"70-sprints/epics-and-stories/#pay-07-operator-console","title":"PAY-07 \u00b7 Operator Console","text":"Field Value Pillar Payments Nucleus Sprint 002 Owner Sprint Master Dependencies PAY-01, PAY-03, PLAT-01 Links Operator Console <p>Tasks</p> <ul> <li>[ ] Extend <code>apps/console</code> with payments views (shared Next.js app)</li> <li>[ ] Transfer timeline: status, events, rail, amounts</li> <li>[ ] Exception queue: stuck/failed transfers with retry actions</li> <li>[ ] Balance dashboard: account balances, daily totals</li> <li>[ ] Supabase Realtime subscriptions for live updates</li> </ul>"},{"location":"70-sprints/epics-and-stories/#backlog","title":"Backlog","text":""},{"location":"70-sprints/epics-and-stories/#pay-08-reconciliation","title":"PAY-08 \u00b7 Reconciliation","text":"Field Value Pillar Payments Nucleus Sprint 003 Dependencies PAY-04 (Rail GW), PAY-03 (Ledger) Links Reconciliation <p>Tasks</p> <ul> <li>[ ] <code>recon.recon_sessions</code> + <code>recon.recon_lines</code> tables</li> <li>[ ] Vercel Cron: daily reconciliation trigger</li> <li>[ ] Match internal transfer events vs bank/rail settlement files</li> <li>[ ] Surface unmatched items in Operator Console</li> <li>[ ] Emit <code>transfers.settled</code> / <code>transfers.returned</code> events on match</li> </ul>"},{"location":"70-sprints/epics-and-stories/#pay-09-multi-rail-expansion-m-pesa-mtn-oppwa","title":"PAY-09 \u00b7 Multi-Rail Expansion (M-Pesa, MTN, OPPWA)","text":"Field Value Pillar Payments Nucleus Sprint 004 Dependencies PAY-04 (EcoCash pattern) Links M-Pesa GW, OPPWA GW <p>Tasks</p> <ul> <li>[ ] M-Pesa gateway (STK push + callback pattern)</li> <li>[ ] MTN MoMo gateway (Collection API)</li> <li>[ ] OPPWA gateway (card payments + 3DS)</li> <li>[ ] Each rail follows the same Vercel Function + DB Webhook pattern</li> </ul>"},{"location":"70-sprints/epics-and-stories/#pay-10-ai-agents","title":"PAY-10 \u00b7 AI Agents","text":"Field Value Pillar Payments Nucleus Sprint 004 Dependencies PAY-01, PAY-08 Links AI Agents <p>Tasks</p> <ul> <li>[ ] LLM-powered exception triage for stuck transfers</li> <li>[ ] Natural language query interface for Operator Console</li> <li>[ ] Anomaly detection on transfer patterns</li> <li>[ ] <code>agent_logs</code> table for audit trail</li> </ul>"},{"location":"70-sprints/epics-and-stories/#fis-07-tax-authority-sync","title":"FIS-07 \u00b7 Tax Authority Sync","text":"Field Value Pillar Fiscal Platform Sprint 003 Dependencies FIS-03 (Ledger), PLAT-01 Links Authority Sync, DRC Integration <p>Tasks</p> <ul> <li>[ ] <code>sync.authority_sync_queue</code> table (pending fiscal events for push)</li> <li>[ ] pg_cron job (slot 2): every 5 min, push pending items via pg_net HTTP POST</li> <li>[ ] Handle DGI MCF/e-MCF protocol (when spec is available)</li> <li>[ ] Acknowledgment tracking + retry logic</li> <li>[ ] Manual fallback: CSV/Excel export for submission</li> </ul>"},{"location":"70-sprints/epics-and-stories/#fis-08-verification-portal","title":"FIS-08 \u00b7 Verification Portal","text":"Field Value Pillar Fiscal Platform Sprint 003 Dependencies FIS-01 (Signing) Links Invoice Verification <p>Tasks</p> <ul> <li>[ ] Static + API route on Vercel (<code>apps/portal</code>)</li> <li>[ ] QR code scanning \u2192 verify signature against public key</li> <li>[ ] Manual fiscal number lookup</li> <li>[ ] Public key distribution via <code>/.well-known/fiscal-keys.json</code></li> <li>[ ] <code>/api/verify/{fiscal_number}</code> \u2014 rate-limited public endpoint</li> </ul>"},{"location":"70-sprints/epics-and-stories/#fis-09-compliance-tooling-onboarding","title":"FIS-09 \u00b7 Compliance Tooling &amp; Onboarding","text":"Field Value Pillar Fiscal Platform Sprint 003 Dependencies FIS-03, FIS-06 Links Phase 1 detail <p>Tasks</p> <ul> <li>[ ] DGI-ready CSV/Excel exports (fiscal numbers, tax summaries, security elements)</li> <li>[ ] Z/X/A report exports from Fiscal Ledger</li> <li>[ ] Onboarding docs, training materials, API key provisioning flow</li> </ul>"},{"location":"70-sprints/epics-and-stories/#fis-10-whatsapp-invoice-bot-nl-api","title":"FIS-10 \u00b7 WhatsApp Invoice Bot + NL API","text":"Field Value Pillar Fiscal Platform Sprint 004 Dependencies FIS-02, FIS-05 Links AI Capabilities <p>Tasks</p> <ul> <li>[ ] WhatsApp Business API integration (Cloud API) for inbound/outbound</li> <li>[ ] <code>/api/invoices/natural</code> endpoint for free-text invoice creation</li> <li>[ ] Entity extraction: items, quantities, prices, client, payment methods, currency</li> <li>[ ] Fuzzy matching against merchant product catalog</li> <li>[ ] Auto-submit when confidence \u2265 0.85; return draft otherwise</li> <li>[ ] <code>source: \"whatsapp_bot\"</code> audit logging</li> </ul>"},{"location":"70-sprints/epics-and-stories/#fis-11-fiscal-extension-offline-signing","title":"FIS-11 \u00b7 Fiscal Extension (Offline Signing)","text":"Field Value Pillar Fiscal Platform Sprint 004 Dependencies FIS-01 (Cloud Signing) Links Delegated Offline Token, ADR-0006 <p>Tasks</p> <ul> <li>[ ] Chrome/Edge extension scaffold with isolated key storage</li> <li>[ ] Delegated Credential provisioning (generate keypair \u2192 request VC + block from Cloud)</li> <li>[ ] Local signing: validate origin, sign payload, return signature + VC</li> <li>[ ] PIN-based shift unlock + auto-lock on inactivity</li> <li>[ ] Online reconciliation: submit locally-sealed invoices \u2192 Cloud verify \u2192 ledger append</li> <li>[ ] Tamper detection: Cloud flags missing blocks in allocated range</li> </ul>"},{"location":"70-sprints/epics-and-stories/#fis-12-mobile-money-integration-fiscal","title":"FIS-12 \u00b7 Mobile Money Integration (Fiscal)","text":"Field Value Pillar Fiscal Platform Sprint 004 Dependencies FIS-02, PAY-04 Links Integrations <p>Tasks</p> <ul> <li>[ ] Payment state tracking in invoice <code>payments</code> array (pending/paid/failed/reversed)</li> <li>[ ] Webhook verification + idempotent event processing</li> <li>[ ] Surface payment status in dashboard and shared receipts</li> <li>[ ] Ensure fiscalization is independent of payment state</li> </ul>"},{"location":"70-sprints/epics-and-stories/#testing","title":"Testing","text":"<p>No epics in Testing at this time.</p>"},{"location":"70-sprints/epics-and-stories/#done","title":"Done","text":"<p>No epics completed yet.</p>"},{"location":"70-sprints/epics-and-stories/#board-summary","title":"Board Summary","text":"<pre><code>graph TB\n    subgraph \"In Progress (Sprint 001)\"\n        PLAT01[\"PLAT-01&lt;br/&gt;Monorepo + Supabase\"]\n        PLAT02[\"PLAT-02&lt;br/&gt;CI/CD Pipeline\"]\n        PLAT03[\"PLAT-03&lt;br/&gt;Specs &amp; Contracts\"]\n        PAY01[\"PAY-01&lt;br/&gt;CTS API\"]\n        PAY02[\"PAY-02&lt;br/&gt;Outbox + Webhooks\"]\n        PAY03[\"PAY-03&lt;br/&gt;Ledger (Triggers)\"]\n        FIS01[\"FIS-01&lt;br/&gt;Cloud Signing (KMS)\"]\n        FIS02[\"FIS-02&lt;br/&gt;Invoice API + Tax\"]\n        FIS03[\"FIS-03&lt;br/&gt;Fiscal Ledger\"]\n    end\n\n    subgraph \"Selected for Dev (Sprint 002)\"\n        PAY04[\"PAY-04&lt;br/&gt;EcoCash Gateway\"]\n        PAY05[\"PAY-05&lt;br/&gt;Compliance\"]\n        PAY06[\"PAY-06&lt;br/&gt;Directory\"]\n        PAY07[\"PAY-07&lt;br/&gt;Operator Console\"]\n        FIS04[\"FIS-04&lt;br/&gt;Dashboard\"]\n        FIS05[\"FIS-05&lt;br/&gt;JS + Python SDK\"]\n        FIS06[\"FIS-06&lt;br/&gt;Reports\"]\n    end\n\n    subgraph \"Backlog (Sprint 003)\"\n        PAY08[\"PAY-08&lt;br/&gt;Reconciliation\"]\n        FIS07[\"FIS-07&lt;br/&gt;Authority Sync\"]\n        FIS08[\"FIS-08&lt;br/&gt;Verification Portal\"]\n        FIS09[\"FIS-09&lt;br/&gt;Compliance Tooling\"]\n    end\n\n    subgraph \"Backlog (Sprint 004)\"\n        PAY09[\"PAY-09&lt;br/&gt;Multi-Rail\"]\n        PAY10[\"PAY-10&lt;br/&gt;AI Agents\"]\n        FIS10[\"FIS-10&lt;br/&gt;WhatsApp + NL API\"]\n        FIS11[\"FIS-11&lt;br/&gt;Fiscal Extension\"]\n        FIS12[\"FIS-12&lt;br/&gt;Mobile Money\"]\n    end\n\n    %% Dependencies\n    PLAT01 -.-&gt; PAY01 &amp; PAY02 &amp; PAY03 &amp; FIS01 &amp; FIS02 &amp; FIS03\n    PLAT02 -.-&gt; PLAT01\n    PAY01 -.-&gt; PAY02 &amp; PAY03\n    FIS01 -.-&gt; FIS02 &amp; FIS03\n    PAY01 -.-&gt; PAY04 &amp; PAY05 &amp; PAY06\n    PAY02 -.-&gt; PAY04\n    FIS02 -.-&gt; FIS04 &amp; FIS05 &amp; FIS10\n    FIS03 -.-&gt; FIS06 &amp; FIS07\n    PAY04 -.-&gt; PAY08 &amp; PAY09\n    FIS01 -.-&gt; FIS08 &amp; FIS11\n\n    %% Styles\n    style PLAT01 fill:#4dabf7,stroke:#1971c2,color:#fff\n    style PLAT02 fill:#4dabf7,stroke:#1971c2,color:#fff\n    style PLAT03 fill:#4dabf7,stroke:#1971c2,color:#fff\n    style PAY01 fill:#4dabf7,stroke:#1971c2,color:#fff\n    style PAY02 fill:#4dabf7,stroke:#1971c2,color:#fff\n    style PAY03 fill:#4dabf7,stroke:#1971c2,color:#fff\n    style FIS01 fill:#4dabf7,stroke:#1971c2,color:#fff\n    style FIS02 fill:#4dabf7,stroke:#1971c2,color:#fff\n    style FIS03 fill:#4dabf7,stroke:#1971c2,color:#fff\n    style PAY04 fill:#ffe066,stroke:#f59f00,color:#333\n    style PAY05 fill:#ffe066,stroke:#f59f00,color:#333\n    style PAY06 fill:#ffe066,stroke:#f59f00,color:#333\n    style PAY07 fill:#ffe066,stroke:#f59f00,color:#333\n    style FIS04 fill:#ffe066,stroke:#f59f00,color:#333\n    style FIS05 fill:#ffe066,stroke:#f59f00,color:#333\n    style FIS06 fill:#ffe066,stroke:#f59f00,color:#333\n    style PAY08 fill:#dee2e6,stroke:#868e96,color:#333\n    style PAY09 fill:#dee2e6,stroke:#868e96,color:#333\n    style PAY10 fill:#dee2e6,stroke:#868e96,color:#333\n    style FIS07 fill:#dee2e6,stroke:#868e96,color:#333\n    style FIS08 fill:#dee2e6,stroke:#868e96,color:#333\n    style FIS09 fill:#dee2e6,stroke:#868e96,color:#333\n    style FIS10 fill:#dee2e6,stroke:#868e96,color:#333\n    style FIS11 fill:#dee2e6,stroke:#868e96,color:#333\n    style FIS12 fill:#dee2e6,stroke:#868e96,color:#333</code></pre>"},{"location":"70-sprints/epics-and-stories/#epic-count-by-pillar","title":"Epic Count by Pillar","text":"Pillar Sprint 001 Sprint 002 Sprint 003 Sprint 004 Total Platform (shared) 3 \u2014 \u2014 \u2014 3 Payments Nucleus 3 4 1 2 10 Fiscal Platform 3 3 3 3 12 Total 9 7 4 5 25"},{"location":"90-templates/TEMPLATE-adr/","title":"ADR-XXXX: &lt;a class=\"headerlink\" href=\"#adr-xxxx\" title=\"Permanent link\"&gt;\u00b6&lt;/a&gt;&lt;/h1&gt; &lt;ul&gt; &lt;li&gt;&lt;strong&gt;Status&lt;/strong&gt;: Proposed / Accepted / Superseded&lt;/li&gt; &lt;li&gt;&lt;strong&gt;Date&lt;/strong&gt;: YYYY-MM-DD&lt;/li&gt; &lt;li&gt;&lt;strong&gt;Owners&lt;/strong&gt;: team-or-person&lt;/li&gt; &lt;li&gt;&lt;strong&gt;Context&lt;/strong&gt;: What problem are we solving?&lt;/li&gt; &lt;li&gt;&lt;strong&gt;Decision&lt;/strong&gt;: What did we choose and why?&lt;/li&gt; &lt;li&gt;&lt;strong&gt;Consequences&lt;/strong&gt;: Tradeoffs, risks, follow-ups.&lt;/li&gt; &lt;li&gt;&lt;strong&gt;References&lt;/strong&gt;: Links, issues, PRs.&lt;/li&gt; &lt;/ul&gt;","text":""},{"location":"90-templates/TEMPLATE-component/","title":"<p>Purpose One sentence on why this exists.</p>","text":""},{"location":"90-templates/TEMPLATE-component/#responsibilities","title":"Responsibilities","text":"<ul> <li>...</li> </ul>"},{"location":"90-templates/TEMPLATE-component/#interfaces","title":"Interfaces","text":""},{"location":"90-templates/TEMPLATE-component/#inputs","title":"Inputs","text":"<ul> <li>Events: ...</li> <li>HTTP: ...</li> </ul>"},{"location":"90-templates/TEMPLATE-component/#outputs","title":"Outputs","text":"<ul> <li>Events: ...</li> <li>HTTP: ...</li> </ul>"},{"location":"90-templates/TEMPLATE-component/#data-model","title":"Data Model","text":"<ul> <li>Tables / storage / retention / PII</li> </ul>"},{"location":"90-templates/TEMPLATE-component/#algorithms-rules","title":"Algorithms / Rules","text":"<ul> <li>Key flows and validation logic</li> </ul>"},{"location":"90-templates/TEMPLATE-component/#diagrams","title":"Diagrams","text":"<pre><code>sequenceDiagram\n  participant Client\n  participant S as &lt;Component&gt;\n  Client-&gt;&gt;S: Request\n  S--&gt;&gt;Client: Response</code></pre>"},{"location":"90-templates/TEMPLATE-component/#failure-modes-retries","title":"Failure Modes &amp; Retries","text":"<ul> <li>...</li> </ul>"},{"location":"90-templates/TEMPLATE-component/#observability","title":"Observability","text":"<ul> <li>Metrics / logs / traces</li> </ul>"},{"location":"90-templates/TEMPLATE-component/#security","title":"Security","text":"<ul> <li>Secrets / authn/z / PII / PCI</li> </ul>"},{"location":"90-templates/TEMPLATE-component/#runbooks","title":"Runbooks","text":"<ul> <li>...</li> </ul>"}]}