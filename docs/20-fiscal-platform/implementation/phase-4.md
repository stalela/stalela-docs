# Phase 4 — Enterprise & Integrations

Phase 4 extends Stalela into enterprise environments with ERP connectors, fleet management, advanced analytics, and multi-country expansion research. This phase builds on the mature API, SDKs, and dual-mode signing infrastructure delivered in Phases 1–3.

## Objectives

- **Scope:** ERP connectors, fleet management dashboard, webhook/event streaming enhancements, advanced analytics, and multi-country regulatory research.
- **Target:** Large enterprises, ERP integrators, and government agencies.

## Epics

### 1. ERP connectors

**Description:** Build certified connectors for major ERP systems that enable automatic fiscalization of invoices generated by the ERP.

**Connectors:**

| ERP | Integration method | Priority |
|-----|--------------------|----------|
| **SAP Business One** | SAP DI API / Service Layer add-on | High |
| **Odoo 17+** | Custom module (Python) publishing to Stalela REST API | High |
| **Sage X3** | Sage X3 Web Services endpoint | Medium |
| **Custom / in-house** | REST API + SDK (JavaScript / Python) | Ongoing |

**Acceptance criteria:**

- Each connector maps the ERP's invoice data model to Stalela's canonical payload.
- Sealed responses (fiscal number, auth code, QR code) are written back to the ERP's invoice record.
- Connectors handle offline queuing: if Stalela Cloud is unreachable, invoices are queued locally and retried.
- Error mapping: ERP-side validation errors are translated into meaningful messages.
- Installation guide, configuration reference, and troubleshooting docs for each connector.

**Dependencies:** `api/cloud.md`, `api/invoicing-sdk.md`.

### 2. Fleet management dashboard

**Description:** A dedicated dashboard view for enterprises managing many outlets, terminals, and (optionally) DEF devices across multiple locations.

**Features:**

- **Map view:** Geo-located outlets with real-time status (online, offline, syncing).
- **Device health panel:** DEF firmware version, certificate expiry, counter status, free memory (Phase 3 outlets only).
- **Fiscal number audit:** Cross-outlet check for numbering gaps, duplicates, or sequence anomalies.
- **Bulk management:** Batch-create outlets, assign users, push configuration changes.
- **Alert center:** Notifications for offline outlets, failed syncs, approaching certificate expiry, and DGI submission failures.

**Acceptance criteria:**

- Dashboard supports 500+ outlets per merchant without degradation.
- Real-time status updates via WebSocket or SSE (≤ 5 s latency).
- Role-based access: fleet manager role can view all outlets but cannot issue invoices.

**Dependencies:** `platform/multi-user.md`, `cloud/architecture.md`.

### 3. Advanced analytics

**Description:** Analytics engine that transforms Fiscal Ledger data into actionable insights for merchants and compliance teams, powered by ML-based anomaly detection, predictive forecasting, and natural language search.

**Reports:**

| Report | Description |
|--------|-------------|
| **Revenue trends** | Daily/weekly/monthly revenue by outlet, product category, and tax group |
| **Tax liability forecast** | Projected tax obligations based on current invoicing velocity and seasonal patterns (Prophet / ARIMA) |
| **Client segmentation** | Invoice volume and revenue by client classification (individual, company, embassy, etc.) |
| **Compliance scorecard** | DGI submission success rate, average sync latency, numbering integrity, AI-driven risk score per outlet |
| **Cashier performance** | Invoices per hour, average transaction value, void/refund rate per cashier |
| **Seasonal demand** | Peak/trough period identification for inventory and staffing |
| **Cash flow prediction** | Forecast mobile money vs. cash collection timing |

**Acceptance criteria:**

- Analytics queries run against a read replica or data warehouse — no impact on transactional performance.
- Pre-built dashboards for each report with export to CSV, PDF, and Excel.
- API endpoint for programmatic access to analytics data.
- Data retention: analytics data available for at least 10 years (regulatory requirement).

**Dependencies:** `fiscal/reports.md`.

### 4. Webhook & event streaming enhancements

**Description:** Upgrade the webhook system to support event streaming for high-throughput integrations and real-time data pipelines.

**Features:**

- **Event streaming:** Optional Kafka/NATS topic per merchant for real-time event consumption.
- **Replay:** Re-deliver events from a specific timestamp or sequence number.
- **Filtering:** Subscribe to specific event types, outlets, or conditions.
- **Dead letter queue:** Automatically quarantine events that fail delivery after max retries.
- **Signature verification:** HMAC-SHA256 signatures on webhook payloads for authenticity.

**Acceptance criteria:**

- Streaming endpoint supports ≥ 1,000 events/second per merchant.
- Replay covers at least 30 days of event history.
- Dead letter queue is accessible via API and dashboard.

**Dependencies:** `platform/integrations.md`.

### 5. Multi-country regulatory research

**Description:** Research and document the regulatory requirements for expanding Stalela beyond the DRC. Identify common patterns and country-specific adaptations.

**Target countries (research only):**

| Country | Fiscal regime | Priority |
|---------|---------------|----------|
| Republic of Congo (Brazzaville) | SFE-like regime (research needed) | High |
| Rwanda | EBM (Electronic Billing Machine) | Medium |
| Kenya | TIMS (Tax Invoice Management System) | Medium |
| Cameroon | MECeF (Machine Électronique Certifiée de Facturation) | Low |

**Deliverables:**

- Regulatory summary per country (equivalent of `regulatory/` folder).
- Gap analysis: what Stalela already supports vs. what needs adaptation.
- Architecture impact assessment: multi-country tax engine, multi-currency, localization.
- Go/no-go recommendation for each country.

### 6. AI-Powered Capabilities (Full Suite)

**Description:** Deploy the full AI suite that builds on Phase 2's foundation (WhatsApp bot, NL invoicing, tax classifier, rule-based anomaly detection) with advanced ML models, OCR, compliance monitoring, and natural language search.

**Components:**

| Component | Description |
|-----------|-------------|
| **ML Anomaly Detection** | Replace Phase 2 rule-based triggers with Isolation Forest / Autoencoder models trained on per-outlet baselines. Detect velocity, amount, timing, tax group, and void/refund anomalies with higher precision. |
| **Predictive Analytics Engine** | Time-series forecasting (Prophet / ARIMA) for tax liability, revenue projection, seasonal demand, and cash flow prediction. Dashboard forecast cards with confidence intervals. |
| **OCR & Document Digitization** | Camera/PDF upload → preprocessing → Tesseract/Cloud Vision OCR → field extraction (NER + layout analysis) → human review → stored as digitized record. Historical paper invoices are informational records only — never fabricate fiscal numbers for scanned documents. |
| **NLP Compliance Monitoring** | Monitor DGI website, official gazette, and ministry circulars for regulatory changes. NLP document classifier detects changes to tax rates, exemptions, and reporting obligations. Alerts reviewed by compliance team before pushing to merchants. |
| **Smart Search (Text-to-SQL)** | Natural language queries over fiscal data via dashboard search bar and `/api/v1/search/query`. Fine-tuned CodeLlama/StarCoder translates French/English questions into sandboxed SQL queries against the Fiscal Ledger read replica. Role-based access control enforced. |
| **Voice Invoice Creation** | Speech-to-text (Whisper multilingual) → text → NL Invoice Parser pipeline. Supports French, Lingala, Swahili. |

**Acceptance criteria:**

- ML anomaly detection achieves ≥ 80% precision with < 5% false positive rate.
- Predictive forecasts within ±15% accuracy for 30-day projections.
- OCR field extraction accuracy ≥ 90%. Low-quality scans flagged for manual entry.
- Compliance monitor detects regulatory changes within 48 hours of publication.
- Smart Search handles ≥ 90% of common finance team queries with correct results.
- Voice input achieves ≥ 85% entity extraction accuracy for supported languages.
- All AI models run within the Stalela cloud boundary. No cross-tenant training.

**Dependencies:** `platform/ai-capabilities.md`, `fiscal/reports.md`, `cloud/architecture.md`.

See [AI & Natural Language Capabilities](../platform/ai-capabilities.md) for full specifications, data flows, and privacy governance.

## Risks

!!! warning "Phase 4 Risks"
    - ERP connector maintenance burden: each connector requires ongoing updates as ERPs release new versions.
    - Multi-country expansion may require separate legal entities and local partnerships.
    - Analytics on large datasets requires careful data warehouse design to avoid performance issues.
    - Event streaming infrastructure (Kafka/NATS) adds operational complexity.
    - AI model accuracy depends on sufficient training data from Phases 1–3; limited pilot volume may require synthetic data augmentation.
    - OCR accuracy degrades significantly on poor-quality scans (torn, faded, handwritten) common in DRC markets.
    - Multilingual NLP (especially Lingala and Tshiluba) has limited pre-trained model coverage; fine-tuning requires labeled datasets.

## Success criteria

- ERP connectors certified and deployed with enterprise customers.
- Fleet dashboard supports enterprise merchants with multi-outlet operations.
- Analytics reports are used by merchants for tax planning.
- Multi-country research delivers go/no-go recommendations.
- WhatsApp bot and NL Invoice API handle production invoice volumes.
- Tax Auto-Classifier accuracy ≥ 85% on production items.
- Anomaly detection surfaces real issues with < 5% false positive rate.
- Smart Search resolves ≥ 90% of natural language finance queries correctly.
